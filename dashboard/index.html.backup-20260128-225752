<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PACIFIK'AI | Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #09090b;
            --bg-subtle: #18181b;
            --bg-muted: #27272a;
            --border: #27272a;
            --border-subtle: #3f3f46;
            --text: #fafafa;
            --text-muted: #a1a1aa;
            --text-dim: #71717a;
            --accent: #3b82f6;
            --accent-muted: #1d4ed8;
            --green: #22c55e;
            --yellow: #eab308;
            --orange: #f97316;
            --red: #ef4444;
            --purple: #a855f7;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            min-height: 100vh;
        }

        /* Layout */
        .layout {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 220px;
            background: var(--bg);
            border-right: 1px solid var(--border);
            padding: 1.25rem 0.75rem;
            position: fixed;
            height: 100vh;
            display: flex;
            flex-direction: column;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            padding: 0 0.75rem;
            margin-bottom: 1.5rem;
        }

        .logo-mark {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--purple) 100%);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-mark svg { width: 16px; height: 16px; stroke: white; }
        .logo-text { font-weight: 700; font-size: 0.9375rem; letter-spacing: -0.02em; }

        .nav { flex: 1; }
        .nav-group { margin-bottom: 1.25rem; }
        .nav-label {
            font-size: 0.6875rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-dim);
            padding: 0 0.75rem;
            margin-bottom: 0.375rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.8125rem;
            font-weight: 500;
            transition: all 0.15s;
            cursor: pointer;
        }

        .nav-item:hover { background: var(--bg-subtle); color: var(--text); }
        .nav-item.active { background: var(--bg-muted); color: var(--text); }
        .nav-item svg { width: 16px; height: 16px; opacity: 0.7; }
        .nav-item.active svg { opacity: 1; }

        .nav-badge {
            margin-left: auto;
            font-size: 0.6875rem;
            font-weight: 600;
            background: var(--accent);
            color: white;
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
        }

        .sidebar-footer {
            padding: 0.75rem;
            border-top: 1px solid var(--border);
        }

        .user {
            display: flex;
            align-items: center;
            gap: 0.625rem;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--purple) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .user-info { flex: 1; min-width: 0; }
        .user-name { font-size: 0.8125rem; font-weight: 500; }
        .user-role { font-size: 0.6875rem; color: var(--text-dim); }

        /* Main */
        .main {
            flex: 1;
            margin-left: 220px;
            min-height: 100vh;
        }

        /* Header */
        .header {
            padding: 1.25rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            background: var(--bg);
            z-index: 50;
        }

        .header-left h1 {
            font-size: 1.125rem;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .header-left p {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        .header-actions { display: flex; gap: 0.5rem; }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.5rem 0.875rem;
            font-size: 0.8125rem;
            font-weight: 500;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.15s;
            font-family: inherit;
            text-decoration: none;
        }

        .btn svg { width: 14px; height: 14px; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: var(--accent-muted); }
        .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
        .btn-ghost:hover { background: var(--bg-subtle); color: var(--text); border-color: var(--border-subtle); }

        /* Filter Select */
        .filter-select {
            padding: 0.5rem 0.875rem;
            font-size: 0.8125rem;
            font-weight: 500;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-subtle);
            color: var(--text);
            cursor: pointer;
            font-family: inherit;
        }

        .filter-select:hover {
            border-color: var(--border-subtle);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Content */
        .content { padding: 1.5rem 2rem 3rem; }

        /* Stats Row */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat {
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1rem 1.25rem;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .stat-label svg { width: 12px; height: 12px; }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .stat-value.green { color: var(--green); }
        .stat-value.blue { color: var(--accent); }

        /* Grid */
        .grid {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 1.5rem;
        }

        .grid-full { grid-column: 1 / -1; }

        /* Card */
        .card {
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
        }

        .card-header {
            padding: 0.875rem 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title {
            font-size: 0.875rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-title svg { width: 16px; height: 16px; color: var(--text-muted); }

        .card-actions { display: flex; gap: 0.25rem; }

        .card-btn {
            padding: 0.375rem 0.625rem;
            font-size: 0.75rem;
            font-weight: 500;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 5px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.15s;
            font-family: inherit;
        }

        .card-btn:hover { background: var(--bg-muted); color: var(--text); }
        .card-btn.active { background: var(--accent); border-color: var(--accent); color: white; }

        .card-body { padding: 1rem 1.25rem; }
        .card-body.flush { padding: 0; }

        /* Pipeline Kanban */
        .pipeline {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.75rem;
            padding: 1rem 1.25rem;
        }

        .pipeline-col {
            background: var(--bg);
            border-radius: 8px;
            padding: 0.75rem;
            min-height: 200px;
            transition: background 0.2s ease;
        }

        .pipeline-col.drag-over {
            background: rgba(59, 130, 246, 0.1);
            border: 1px dashed var(--accent);
        }

        .pipeline-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .pipeline-title {
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }

        .pipeline-count {
            font-size: 0.625rem;
            font-weight: 600;
            background: var(--bg-muted);
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            color: var(--text-dim);
        }

        .pipeline-card {
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: grab;
            transition: all 0.15s;
            user-select: none;
        }

        .pipeline-card:hover {
            border-color: var(--accent);
            transform: translateY(-1px);
        }

        .pipeline-card.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
            cursor: grabbing;
        }

        .pipeline-card-name {
            font-size: 0.8125rem;
            font-weight: 500;
            margin-bottom: 0.125rem;
        }

        .pipeline-card-company {
            font-size: 0.6875rem;
            color: var(--text-dim);
            margin-bottom: 0.5rem;
        }

        .pipeline-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pipeline-card-value {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--green);
        }

        .pipeline-card-date {
            font-size: 0.625rem;
            color: var(--text-dim);
        }

        /* Kanban Temperature */
        .kanban-temp {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            padding: 1rem 1.25rem;
        }

        .kanban-col {
            background: var(--bg);
            border-radius: 8px;
            padding: 0.75rem;
            min-height: 300px;
            transition: background 0.2s ease;
        }

        .kanban-col.drag-over {
            background: rgba(59, 130, 246, 0.1);
            border: 1px dashed var(--accent);
        }

        .kanban-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border);
        }

        .kanban-header.hot { border-bottom-color: var(--red); }
        .kanban-header.chaud { border-bottom-color: var(--orange); }
        .kanban-header.tiede { border-bottom-color: var(--yellow); }
        .kanban-header.froid { border-bottom-color: var(--accent); }

        .kanban-title {
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .kanban-title.hot { color: var(--red); }
        .kanban-title.chaud { color: var(--orange); }
        .kanban-title.tiede { color: var(--yellow); }
        .kanban-title.froid { color: var(--accent); }

        .kanban-stats {
            display: flex;
            gap: 0.5rem;
            font-size: 0.625rem;
            color: var(--text-dim);
        }

        .kanban-card {
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: grab;
            transition: all 0.15s;
            user-select: none;
        }

        .kanban-card:hover {
            border-color: var(--accent);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .kanban-card.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
            cursor: grabbing;
        }

        .kanban-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.375rem;
        }

        .kanban-card-company {
            font-size: 0.8125rem;
            font-weight: 600;
            flex: 1;
        }

        .kanban-card-status {
            font-size: 0.5625rem;
            font-weight: 600;
            padding: 0.125rem 0.375rem;
            border-radius: 3px;
            text-transform: uppercase;
        }

        .kanban-card-contact {
            font-size: 0.6875rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }

        .kanban-card-sector {
            font-size: 0.625rem;
            color: var(--text-dim);
            margin-bottom: 0.5rem;
        }

        .kanban-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .kanban-card-value {
            font-size: 0.8125rem;
            font-weight: 700;
            color: var(--green);
        }

        /* Table */
        .table-wrap { overflow-x: auto; }

        table { width: 100%; border-collapse: collapse; }

        th {
            text-align: left;
            padding: 0.625rem 1rem;
            font-size: 0.6875rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-dim);
            background: var(--bg);
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 0.75rem 1rem;
            font-size: 0.8125rem;
            border-bottom: 1px solid var(--border);
        }

        tr:hover td { background: var(--bg-muted); }
        tr:last-child td { border-bottom: none; }

        .cell-name {
            display: flex;
            align-items: center;
            gap: 0.625rem;
        }

        .avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6875rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .avatar.blue { background: rgba(59, 130, 246, 0.2); color: var(--accent); }
        .avatar.green { background: rgba(34, 197, 94, 0.2); color: var(--green); }
        .avatar.purple { background: rgba(168, 85, 247, 0.2); color: var(--purple); }
        .avatar.orange { background: rgba(249, 115, 22, 0.2); color: var(--orange); }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.6875rem;
            font-weight: 500;
            border-radius: 4px;
        }

        .badge-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: currentColor;
        }

        .badge.lead { background: rgba(59, 130, 246, 0.15); color: var(--accent); }
        .badge.contacted { background: rgba(234, 179, 8, 0.15); color: var(--yellow); }
        .badge.meeting { background: rgba(168, 85, 247, 0.15); color: var(--purple); }
        .badge.proposal { background: rgba(249, 115, 22, 0.15); color: var(--orange); }
        .badge.won { background: rgba(34, 197, 94, 0.15); color: var(--green); }
        .badge.lost { background: rgba(239, 68, 68, 0.15); color: var(--red); }
        .badge.hot { background: rgba(239, 68, 68, 0.15); color: var(--red); }
        .badge.chaud { background: rgba(249, 115, 22, 0.15); color: var(--orange); }
        .badge.tiede { background: rgba(234, 179, 8, 0.15); color: var(--yellow); }
        .badge.froid { background: rgba(59, 130, 246, 0.15); color: var(--accent); }

        .pipeline-card-priority {
            font-size: 0.625rem;
            font-weight: 600;
            padding: 0.125rem 0.375rem;
            border-radius: 3px;
            text-transform: uppercase;
        }
        .pipeline-card-priority.hot { background: rgba(239, 68, 68, 0.2); color: var(--red); }
        .pipeline-card-priority.chaud { background: rgba(249, 115, 22, 0.2); color: var(--orange); }
        .pipeline-card-priority.tiede { background: rgba(234, 179, 8, 0.2); color: var(--yellow); }
        .pipeline-card-priority.froid { background: rgba(59, 130, 246, 0.2); color: var(--accent); }

        /* Asset indicators */
        .asset-icons {
            display: inline-flex;
            gap: 0.25rem;
            margin-left: 0.5rem;
        }
        .asset-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 4px;
            font-size: 0.625rem;
            cursor: help;
            position: relative;
            transition: transform 0.15s ease;
        }
        .asset-icon:hover {
            transform: scale(1.15);
        }
        .asset-icon.site { background: rgba(168, 85, 247, 0.2); color: var(--purple); }
        .asset-icon.dashboard { background: rgba(34, 197, 94, 0.2); color: var(--green); }
        .asset-icon.workflow { background: rgba(249, 115, 22, 0.2); color: var(--orange); }
        .asset-icon.doc { background: rgba(59, 130, 246, 0.2); color: var(--accent); }

        /* Tooltip for asset icons */
        .asset-icon::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: calc(100% + 6px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 0.6875rem;
            font-weight: 500;
            padding: 0.375rem 0.5rem;
            border-radius: 6px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.15s ease, visibility 0.15s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            z-index: 100;
        }
        .asset-icon::before {
            content: '';
            position: absolute;
            bottom: calc(100% + 2px);
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-top-color: var(--border);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.15s ease, visibility 0.15s ease;
            z-index: 100;
        }
        .asset-icon:hover::after,
        .asset-icon:hover::before {
            opacity: 1;
            visibility: visible;
        }

        .pipeline-card-assets {
            display: flex;
            gap: 0.25rem;
            margin-top: 0.375rem;
        }
        .pipeline-card-assets .asset-icon {
            width: 16px;
            height: 16px;
            font-size: 0.5rem;
        }

        /* Checklist */
        .checklist { list-style: none; }

        .checklist-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }

        .checklist-item:last-child { border-bottom: none; }

        .checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border-subtle);
            border-radius: 4px;
            flex-shrink: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            margin-top: 1px;
        }

        .checkbox:hover { border-color: var(--accent); }
        .checkbox.checked { background: var(--green); border-color: var(--green); }
        .checkbox svg { width: 12px; height: 12px; stroke: white; opacity: 0; }
        .checkbox.checked svg { opacity: 1; }

        .checklist-content { flex: 1; min-width: 0; }

        .checklist-title {
            font-size: 0.8125rem;
            font-weight: 500;
            margin-bottom: 0.125rem;
        }

        .checklist-item.done .checklist-title {
            text-decoration: line-through;
            color: var(--text-dim);
        }

        .checklist-desc {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .checklist-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checklist-week {
            font-size: 0.625rem;
            font-weight: 600;
            padding: 0.125rem 0.375rem;
            border-radius: 3px;
            background: var(--bg-muted);
            color: var(--text-dim);
        }

        .checklist-week.current {
            background: var(--accent);
            color: white;
        }

        /* Progress */
        .progress-wrap { margin-bottom: 1rem; }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.375rem;
        }

        .progress-label { font-size: 0.75rem; color: var(--text-muted); }
        .progress-value { font-size: 0.75rem; font-weight: 600; color: var(--accent); }

        .progress-bar {
            height: 6px;
            background: var(--bg-muted);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent) 0%, var(--purple) 100%);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* Quick Links */
        .quick-links {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .quick-link {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            padding: 0.75rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.8125rem;
            font-weight: 500;
            transition: all 0.15s;
        }

        .quick-link:hover {
            background: var(--bg-muted);
            color: var(--text);
            border-color: var(--border-subtle);
        }

        .quick-link svg { width: 16px; height: 16px; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.25rem;
            padding: 0.5rem;
            background: var(--bg);
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .tab {
            padding: 0.5rem 0.875rem;
            font-size: 0.8125rem;
            font-weight: 500;
            background: transparent;
            border: none;
            border-radius: 4px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.15s;
            font-family: inherit;
        }

        .tab:hover { color: var(--text); }
        .tab.active { background: var(--bg-muted); color: var(--text); }

        /* Views */
        .view { display: none; }
        .view.active { display: block; }

        /* View Toggle */
        .view-toggle {
            display: inline-flex;
            background: var(--bg);
            border-radius: 6px;
            padding: 0.25rem;
            gap: 0.25rem;
        }

        .view-toggle-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
            background: transparent;
            border: none;
            border-radius: 4px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.15s;
            font-family: inherit;
        }

        .view-toggle-btn:hover {
            color: var(--text);
        }

        .view-toggle-btn.active {
            background: var(--bg-muted);
            color: var(--text);
        }

        .view-toggle-btn svg {
            width: 14px;
            height: 14px;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .toolbar-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Search */
        .search-box {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.375rem 0.75rem;
            min-width: 200px;
        }

        .search-box:focus-within {
            border-color: var(--accent);
        }

        .search-box svg {
            width: 14px;
            height: 14px;
            color: var(--text-dim);
            flex-shrink: 0;
        }

        .search-box input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 0.8125rem;
            font-family: inherit;
            outline: none;
        }

        .search-box input::placeholder {
            color: var(--text-dim);
        }

        /* Dropdown */
        .dropdown {
            position: relative;
        }

        .dropdown-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.15s;
            font-family: inherit;
        }

        .dropdown-btn:hover {
            background: var(--bg-muted);
            color: var(--text);
        }

        .dropdown-btn svg {
            width: 12px;
            height: 12px;
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 6px;
            min-width: 160px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            z-index: 100;
            display: none;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.15s;
        }

        .dropdown-item:hover {
            background: var(--bg-muted);
            color: var(--text);
        }

        .dropdown-item.active {
            color: var(--accent);
        }

        .dropdown-item svg {
            width: 12px;
            height: 12px;
        }

        .dropdown-divider {
            height: 1px;
            background: var(--border);
            margin: 0.25rem 0;
        }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .summary-card {
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .summary-card-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .summary-card-icon.hot { background: rgba(239, 68, 68, 0.15); }
        .summary-card-icon.chaud { background: rgba(249, 115, 22, 0.15); }
        .summary-card-icon.tiede { background: rgba(234, 179, 8, 0.15); }
        .summary-card-icon.froid { background: rgba(59, 130, 246, 0.15); }

        .summary-card-content { flex: 1; }

        .summary-card-value {
            font-size: 1.25rem;
            font-weight: 700;
            line-height: 1;
        }

        .summary-card-label {
            font-size: 0.6875rem;
            color: var(--text-dim);
            margin-top: 0.125rem;
        }

        .summary-card-pipeline {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--green);
        }

        /* Table sortable headers */
        th.sortable {
            cursor: pointer;
            user-select: none;
        }

        th.sortable:hover {
            color: var(--text);
        }

        th.sortable::after {
            content: '';
            display: inline-block;
            width: 0;
            height: 0;
            margin-left: 0.375rem;
            vertical-align: middle;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 4px solid var(--text-dim);
            opacity: 0.3;
        }

        th.sortable.asc::after {
            border-top: none;
            border-bottom: 4px solid var(--accent);
            opacity: 1;
        }

        th.sortable.desc::after {
            border-top: 4px solid var(--accent);
            opacity: 1;
        }

        /* View containers */
        .prospects-view-container { display: none; }
        .prospects-view-container.active { display: block; }

        /* Prospect cards with assets - highlighted */
        .kanban-card.has-assets,
        .pipeline-card.has-assets {
            border-left: 3px solid var(--purple);
            background: linear-gradient(135deg, var(--bg-subtle) 0%, rgba(168, 85, 247, 0.05) 100%);
        }

        tr.has-assets td:first-child {
            border-left: 3px solid var(--purple);
        }

        /* Modal Overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal-overlay.show {
            display: flex;
        }

        /* Modal */
        .modal {
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 12px;
            max-width: 900px;
            width: 100%;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: modalIn 0.2s ease;
        }

        @keyframes modalIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 1rem;
        }

        .modal-title-section {
            flex: 1;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            margin-bottom: 0.25rem;
        }

        .modal-subtitle {
            font-size: 0.8125rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .modal-close:hover {
            background: var(--bg-muted);
            color: var(--text);
        }

        .modal-close svg {
            width: 16px;
            height: 16px;
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        /* Prospect Info */
        .prospect-info {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .prospect-info-item {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.875rem;
        }

        .prospect-info-label {
            font-size: 0.6875rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }

        .prospect-info-value {
            font-size: 0.9375rem;
            font-weight: 600;
        }

        /* Prospect Edit Section */
        .prospect-edit-section {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        /* Fiche IA Section - Prioritaire */
        .fiche-ia-section {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%);
            border: 1px solid var(--purple);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }

        .fiche-ia-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .fiche-ia-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text);
        }

        .fiche-ia-badge {
            font-size: 0.6875rem;
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            background: var(--bg-muted);
            color: var(--text-dim);
        }

        .fiche-ia-badge.available {
            background: rgba(34, 197, 94, 0.2);
            color: var(--green);
        }

        .fiche-ia-content {
            margin-top: 0.5rem;
        }

        .fiche-ia-empty {
            text-align: center;
            padding: 1rem;
        }

        .fiche-ia-empty p {
            font-size: 0.8125rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .fiche-ia-hint {
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-bottom: 1rem;
        }

        .fiche-ia-generate {
            background: linear-gradient(135deg, var(--purple) 0%, var(--accent) 100%);
            border: none;
        }

        .fiche-ia-generate:hover {
            opacity: 0.9;
        }

        .fiche-ia-available {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .fiche-ia-preview {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .fiche-ia-preview-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--purple) 0%, var(--accent) 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fiche-ia-preview-icon svg {
            width: 22px;
            height: 22px;
            stroke: white;
        }

        .fiche-ia-preview-name {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text);
        }

        .fiche-ia-preview-meta {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .fiche-ia-actions {
            display: flex;
            gap: 0.5rem;
        }

        @media (max-width: 600px) {
            .fiche-ia-available {
                flex-direction: column;
                align-items: stretch;
            }
            .fiche-ia-actions {
                justify-content: stretch;
            }
            .fiche-ia-actions .btn {
                flex: 1;
            }
        }

        .edit-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .edit-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .edit-toggle-btn {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--accent);
            background: transparent;
            border: 1px solid var(--accent);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .edit-toggle-btn:hover {
            background: var(--accent);
            color: white;
        }

        .edit-toggle-btn svg {
            width: 14px;
            height: 14px;
        }

        .edit-toggle-btn.active {
            background: var(--accent);
            color: white;
        }

        .prospect-edit-form {
            margin-top: 0.75rem;
        }

        .edit-form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .edit-field {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .edit-field label {
            font-size: 0.6875rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .edit-field input {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            transition: border-color 0.2s;
        }

        .edit-field input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .edit-field input::placeholder {
            color: var(--text-dim);
        }

        .edit-form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }

        @media (max-width: 600px) {
            .edit-form-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Assets Section */
        .assets-section {
            margin-bottom: 1.5rem;
        }

        .assets-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .assets-section-title svg {
            width: 14px;
            height: 14px;
        }

        .assets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 0.75rem;
        }

        .asset-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .asset-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .asset-card-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .asset-card-icon.site { background: rgba(168, 85, 247, 0.15); }
        .asset-card-icon.dash { background: rgba(34, 197, 94, 0.15); }
        .asset-card-icon.wf { background: rgba(249, 115, 22, 0.15); }
        .asset-card-icon.doc { background: rgba(59, 130, 246, 0.15); }

        .asset-card-content { flex: 1; min-width: 0; }

        .asset-card-name {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.125rem;
        }

        .asset-card-desc {
            font-size: 0.75rem;
            color: var(--text-dim);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .asset-card-arrow {
            color: var(--text-dim);
            transition: transform 0.15s;
        }

        .asset-card:hover .asset-card-arrow {
            transform: translateX(4px);
            color: var(--accent);
        }

        .asset-card-arrow svg {
            width: 16px;
            height: 16px;
        }

        /* No Assets */
        .no-assets {
            text-align: center;
            padding: 2rem;
            color: var(--text-dim);
        }

        .no-assets svg {
            width: 48px;
            height: 48px;
            margin-bottom: 0.75rem;
            opacity: 0.3;
        }

        .no-assets p {
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .no-assets span {
            font-size: 0.75rem;
        }

        /* Featured Prospects Section */
        .featured-section {
            margin-bottom: 1.5rem;
        }

        .featured-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--purple);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .featured-title svg {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
        }

        .featured-prospects {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
        }

        .featured-card {
            background: linear-gradient(135deg, var(--bg-subtle) 0%, rgba(168, 85, 247, 0.08) 100%);
            border: 1px solid var(--purple);
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .featured-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(168, 85, 247, 0.2);
        }

        .featured-card-company {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .featured-card-sector {
            font-size: 0.6875rem;
            color: var(--text-dim);
            margin-bottom: 0.5rem;
        }

        .featured-card-assets {
            display: flex;
            gap: 0.25rem;
        }

        .featured-card-assets .asset-icon {
            width: 20px;
            height: 20px;
            font-size: 0.625rem;
        }

        /* ============================================
           FOLLOW-UPS & REMINDERS
           ============================================ */
        .followup-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.625rem;
            font-weight: 600;
            padding: 0.125rem 0.375rem;
            border-radius: 3px;
            background: rgba(239, 68, 68, 0.15);
            color: var(--red);
        }

        .followup-badge.today {
            background: rgba(249, 115, 22, 0.15);
            color: var(--orange);
            animation: pulse 2s infinite;
        }

        .followup-badge.overdue {
            background: rgba(239, 68, 68, 0.25);
            color: var(--red);
        }

        .followup-badge.upcoming {
            background: rgba(59, 130, 246, 0.15);
            color: var(--accent);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Today's Follow-ups Widget */
        .followups-widget {
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.1) 0%, rgba(239, 68, 68, 0.05) 100%);
            border: 1px solid rgba(249, 115, 22, 0.3);
            border-radius: 10px;
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
        }

        .followups-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .followups-title {
            font-size: 0.875rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--orange);
        }

        .followups-count {
            background: var(--orange);
            color: white;
            font-size: 0.6875rem;
            font-weight: 700;
            padding: 0.125rem 0.5rem;
            border-radius: 10px;
        }

        .followup-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.15s;
        }

        .followup-item:last-child { border-bottom: none; }
        .followup-item:hover { background: rgba(255,255,255,0.02); margin: 0 -0.5rem; padding: 0.5rem; border-radius: 6px; }

        .followup-item-info { flex: 1; }
        .followup-item-company { font-size: 0.8125rem; font-weight: 500; }
        .followup-item-note { font-size: 0.6875rem; color: var(--text-dim); }

        .followup-item-actions {
            display: flex;
            gap: 0.25rem;
        }

        .followup-action {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .followup-action:hover {
            background: var(--bg-muted);
            color: var(--text);
        }

        .followup-action.done:hover {
            background: rgba(34, 197, 94, 0.2);
            color: var(--green);
            border-color: var(--green);
        }

        .followup-action svg { width: 14px; height: 14px; }

        /* ============================================
           QUICK ACTIONS
           ============================================ */
        .quick-actions {
            display: flex;
            gap: 0.25rem;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border);
        }

        .quick-action-btn {
            flex: 1;
            padding: 0.375rem;
            border-radius: 4px;
            border: none;
            background: var(--bg);
            color: var(--text-dim);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            font-size: 0.75rem;
        }

        .quick-action-btn:hover {
            background: var(--bg-muted);
            color: var(--text);
        }

        .quick-action-btn.email:hover { color: var(--accent); }
        .quick-action-btn.phone:hover { color: var(--green); }
        .quick-action-btn.whatsapp:hover { color: #25D366; }
        .quick-action-btn.note:hover { color: var(--yellow); }
        .quick-action-btn.reminder:hover { color: var(--orange); }

        .quick-action-btn svg { width: 14px; height: 14px; }

        /* ============================================
           NOTES SYSTEM
           ============================================ */
        .notes-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        .notes-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .notes-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .notes-title svg { width: 14px; height: 14px; }

        .note-input-wrap {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .note-input {
            flex: 1;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            font-size: 0.8125rem;
            font-family: inherit;
            color: var(--text);
            resize: none;
        }

        .note-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .note-input::placeholder { color: var(--text-dim); }

        .notes-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .note-item {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .note-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }

        .note-item-date {
            font-size: 0.625rem;
            color: var(--text-dim);
        }

        .note-item-delete {
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            padding: 0.125rem;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .note-item:hover .note-item-delete { opacity: 1; }
        .note-item-delete:hover { color: var(--red); }
        .note-item-delete svg { width: 12px; height: 12px; }

        .note-item-text {
            font-size: 0.8125rem;
            color: var(--text-muted);
            line-height: 1.4;
        }

        /* ============================================
           ANALYTICS CHARTS
           ============================================ */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .chart-card {
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1rem 1.25rem;
        }

        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .chart-title {
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--text-muted);
        }

        .chart-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .chart-value.green { color: var(--green); }

        /* Simple Bar Chart */
        .bar-chart {
            display: flex;
            align-items: flex-end;
            gap: 0.5rem;
            height: 100px;
        }

        .bar-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
        }

        .bar {
            width: 100%;
            border-radius: 4px 4px 0 0;
            transition: height 0.5s ease;
        }

        .bar.hot { background: var(--red); }
        .bar.chaud { background: var(--orange); }
        .bar.tiede { background: var(--yellow); }
        .bar.froid { background: var(--accent); }
        .bar.lead { background: var(--accent); }
        .bar.contacted { background: var(--yellow); }
        .bar.meeting { background: var(--purple); }
        .bar.proposal { background: var(--orange); }
        .bar.won { background: var(--green); }

        .bar-label {
            font-size: 0.5625rem;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        /* Donut Chart */
        .donut-chart {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto;
        }

        .donut-chart svg {
            transform: rotate(-90deg);
        }

        .donut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .donut-value {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .donut-label {
            font-size: 0.625rem;
            color: var(--text-dim);
        }

        /* Conversion Funnel */
        .funnel {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .funnel-stage {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .funnel-bar-wrap {
            flex: 1;
            height: 24px;
            background: var(--bg);
            border-radius: 4px;
            overflow: hidden;
        }

        .funnel-bar {
            height: 100%;
            border-radius: 4px;
            display: flex;
            align-items: center;
            padding-left: 0.5rem;
            font-size: 0.625rem;
            font-weight: 600;
            color: white;
            transition: width 0.5s ease;
        }

        .funnel-label {
            font-size: 0.625rem;
            color: var(--text-dim);
            width: 60px;
            text-align: right;
        }

        .funnel-count {
            font-size: 0.6875rem;
            font-weight: 600;
            width: 30px;
        }

        /* Sync Status */
        .sync-status {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            font-size: 0.6875rem;
            color: var(--text-dim);
        }

        .sync-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--green);
        }

        .sync-dot.syncing {
            background: var(--yellow);
            animation: pulse 1s infinite;
        }

        .sync-dot.error {
            background: var(--red);
        }

        /* Add Reminder Modal */
        .reminder-modal {
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1.25rem;
            width: 320px;
        }

        .reminder-modal h3 {
            font-size: 0.9375rem;
            margin-bottom: 1rem;
        }

        .reminder-form {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .form-group label {
            display: block;
            font-size: 0.6875rem;
            font-weight: 500;
            color: var(--text-dim);
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            font-size: 0.8125rem;
            font-family: inherit;
            color: var(--text);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .form-actions .btn { flex: 1; justify-content: center; }

        /* ============================================
           CONTENT CALENDAR (FACEBOOK)
           ============================================ */
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .content-stats {
            display: flex;
            gap: 1rem;
        }

        .content-stat {
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            text-align: center;
        }

        .content-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
        }

        .content-stat-label {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 1.5rem;
        }

        .content-calendar {
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .calendar-nav {
            display: flex;
            gap: 0.5rem;
        }

        .calendar-nav button {
            background: var(--bg-muted);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.375rem 0.75rem;
            color: var(--text);
            cursor: pointer;
            font-size: 0.8125rem;
        }

        .calendar-nav button:hover { background: var(--border); }

        .calendar-week {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .calendar-day-label {
            text-align: center;
            font-size: 0.6875rem;
            font-weight: 600;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.375rem;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
        }

        .calendar-day:hover { border-color: var(--accent); }
        .calendar-day.today { border-color: var(--accent); background: rgba(59, 130, 246, 0.1); }
        .calendar-day.other-month { opacity: 0.4; }
        .calendar-day.has-post::after {
            content: '';
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background: var(--purple);
            border-radius: 50%;
        }
        .calendar-day.has-post.published::after { background: var(--green); }

        .calendar-day-number {
            font-size: 0.75rem;
            font-weight: 500;
        }

        .post-sidebar {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .post-create-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(168, 85, 247, 0.1));
            border: 1px solid var(--accent);
            border-radius: 12px;
            padding: 1.25rem;
        }

        .post-create-card h3 {
            font-size: 0.9375rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .post-create-card h3 svg { width: 18px; height: 18px; stroke: var(--accent); }

        .post-textarea {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            color: var(--text);
            font-size: 0.8125rem;
            resize: vertical;
            min-height: 100px;
            margin-bottom: 0.75rem;
        }

        .post-textarea:focus { outline: none; border-color: var(--accent); }
        .post-textarea::placeholder { color: var(--text-dim); }

        .post-options {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .post-option {
            flex: 1;
            background: var(--bg-muted);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.5rem;
            text-align: center;
            cursor: pointer;
            font-size: 0.75rem;
            color: var(--text-muted);
            transition: all 0.15s;
        }

        .post-option:hover, .post-option.active {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(59, 130, 246, 0.1);
        }

        .post-schedule {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .post-schedule input {
            flex: 1;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.5rem;
            color: var(--text);
            font-size: 0.8125rem;
        }

        .post-schedule input:focus { outline: none; border-color: var(--accent); }

        .post-actions {
            display: flex;
            gap: 0.5rem;
        }

        .post-actions .btn { flex: 1; justify-content: center; }

        .posts-list {
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            flex: 1;
            overflow-y: auto;
        }

        .posts-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .posts-list-header h3 {
            font-size: 0.875rem;
            font-weight: 600;
        }

        .posts-list-tabs {
            display: flex;
            gap: 0.25rem;
        }

        .posts-list-tab {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.6875rem;
            cursor: pointer;
            color: var(--text-dim);
        }

        .posts-list-tab.active { background: var(--accent); color: white; }

        .post-item {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .post-item:hover { border-color: var(--border-subtle); }

        .post-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .post-item-date {
            font-size: 0.6875rem;
            color: var(--text-dim);
        }

        .post-item-status {
            font-size: 0.625rem;
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-weight: 500;
        }

        .post-item-status.scheduled { background: rgba(168, 85, 247, 0.2); color: var(--purple); }
        .post-item-status.published { background: rgba(34, 197, 94, 0.2); color: var(--green); }
        .post-item-status.draft { background: rgba(161, 161, 170, 0.2); color: var(--text-muted); }

        .post-item-preview {
            font-size: 0.75rem;
            color: var(--text-muted);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .post-item-image {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            margin-top: 0.5rem;
        }

        .ai-generate-btn {
            background: linear-gradient(135deg, var(--accent) 0%, var(--purple) 100%);
            border: none;
            color: white;
            font-weight: 500;
        }

        .ai-generate-btn:hover { opacity: 0.9; }

        /* ============================================
           AI CHATBOT
           ============================================ */
        .chatbot-fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent) 0%, var(--purple) 100%);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
            transition: all 0.2s ease;
            z-index: 150;
        }

        .chatbot-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 28px rgba(59, 130, 246, 0.5);
        }

        .chatbot-fab svg {
            width: 24px;
            height: 24px;
            stroke: white;
        }

        .chatbot-fab .badge-notif {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 20px;
            height: 20px;
            background: var(--red);
            border-radius: 50%;
            font-size: 0.625rem;
            font-weight: 700;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chatbot-panel {
            position: fixed;
            bottom: 96px;
            right: 24px;
            width: 420px;
            height: 600px;
            max-height: calc(100vh - 120px);
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.5);
            display: none;
            flex-direction: column;
            overflow: hidden;
            z-index: 160;
            animation: chatbotIn 0.2s ease;
        }

        .chatbot-panel.open {
            display: flex;
        }

        @keyframes chatbotIn {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .chatbot-header {
            padding: 1rem 1.25rem;
            background: linear-gradient(135deg, var(--accent) 0%, var(--purple) 100%);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .chatbot-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chatbot-avatar svg {
            width: 22px;
            height: 22px;
            stroke: white;
        }

        .chatbot-info { flex: 1; }
        .chatbot-name { font-weight: 600; font-size: 0.9375rem; }
        .chatbot-status { font-size: 0.6875rem; opacity: 0.8; display: flex; align-items: center; gap: 0.375rem; }
        .chatbot-status-dot { width: 6px; height: 6px; background: #22c55e; border-radius: 50%; }

        .chatbot-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.15s;
        }

        .chatbot-close:hover { background: rgba(255, 255, 255, 0.2); }
        .chatbot-close svg { width: 18px; height: 18px; }

        .chatbot-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .chat-message {
            display: flex;
            gap: 0.5rem;
            max-width: 85%;
        }

        .chat-message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .chat-message.assistant {
            align-self: flex-start;
        }

        .chat-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 0.75rem;
        }

        .chat-message.user .chat-avatar {
            background: var(--accent);
            color: white;
        }

        .chat-message.assistant .chat-avatar {
            background: linear-gradient(135deg, var(--accent) 0%, var(--purple) 100%);
        }

        .chat-avatar svg { width: 14px; height: 14px; stroke: white; }

        .chat-bubble {
            padding: 0.75rem 1rem;
            border-radius: 12px;
            font-size: 0.8125rem;
            line-height: 1.5;
        }

        .chat-message.user .chat-bubble {
            background: var(--accent);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chat-message.assistant .chat-bubble {
            background: var(--bg-muted);
            color: var(--text);
            border-bottom-left-radius: 4px;
        }

        .chat-bubble p { margin-bottom: 0.5rem; }
        .chat-bubble p:last-child { margin-bottom: 0; }
        .chat-bubble strong { color: var(--text); font-weight: 600; }
        .chat-bubble code {
            background: rgba(0, 0, 0, 0.3);
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.75rem;
        }

        .chat-bubble ul, .chat-bubble ol {
            margin: 0.5rem 0;
            padding-left: 1.25rem;
        }

        .chat-bubble li { margin-bottom: 0.25rem; }

        /* Quick Actions in Chat */
        .chat-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.375rem;
            margin-top: 0.5rem;
        }

        .chat-action-btn {
            padding: 0.375rem 0.625rem;
            font-size: 0.6875rem;
            font-weight: 500;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.15s;
        }

        .chat-action-btn:hover {
            background: var(--bg-subtle);
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Typing indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.75rem 1rem;
            background: var(--bg-muted);
            border-radius: 12px;
            border-bottom-left-radius: 4px;
            width: fit-content;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: var(--text-dim);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out both;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingBounce {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* Chat Input */
        .chatbot-input-area {
            padding: 1rem;
            border-top: 1px solid var(--border);
            background: var(--bg);
        }

        .chatbot-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.375rem;
            margin-bottom: 0.75rem;
        }

        .suggestion-chip {
            padding: 0.375rem 0.625rem;
            font-size: 0.6875rem;
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.15s;
        }

        .suggestion-chip:hover {
            background: var(--bg-muted);
            border-color: var(--accent);
            color: var(--text);
        }

        .chatbot-input-wrap {
            display: flex;
            gap: 0.5rem;
        }

        .chatbot-input {
            flex: 1;
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            font-family: inherit;
            color: var(--text);
            resize: none;
            min-height: 44px;
            max-height: 120px;
        }

        .chatbot-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .chatbot-input::placeholder { color: var(--text-dim); }

        .chatbot-send {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--purple) 100%);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .chatbot-send:hover {
            transform: scale(1.05);
        }

        .chatbot-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .chatbot-send svg {
            width: 18px;
            height: 18px;
            stroke: white;
        }

        /* Data Cards in Chat */
        .chat-data-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            margin-top: 0.5rem;
        }

        .chat-data-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .chat-data-title {
            font-weight: 600;
            font-size: 0.8125rem;
        }

        .chat-data-badge {
            font-size: 0.625rem;
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
        }

        .chat-data-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            padding: 0.25rem 0;
            border-bottom: 1px solid var(--border);
        }

        .chat-data-row:last-child { border-bottom: none; }
        .chat-data-label { color: var(--text-dim); }
        .chat-data-value { font-weight: 500; }

        .chat-prospect-list {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
            margin-top: 0.5rem;
        }

        .chat-prospect-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0.75rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .chat-prospect-item:hover {
            border-color: var(--accent);
            background: var(--bg-muted);
        }

        .chat-prospect-name { font-size: 0.8125rem; font-weight: 500; }
        .chat-prospect-meta { font-size: 0.6875rem; color: var(--text-dim); }

        /* Section Title */
        .section-title {
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-dim);
            margin-bottom: 0.75rem;
            padding-left: 0.125rem;
        }

        /* Empty */
        .empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-dim);
        }

        .empty svg {
            width: 32px;
            height: 32px;
            margin-bottom: 0.75rem;
            opacity: 0.5;
        }

        .empty p { font-size: 0.8125rem; }

        /* Responsive */
        @media (max-width: 1200px) {
            .grid { grid-template-columns: 1fr; }
            .stats-row { grid-template-columns: repeat(3, 1fr); }
            .pipeline { grid-template-columns: repeat(3, 1fr); }
        }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main { margin-left: 0; }
            .stats-row { grid-template-columns: repeat(2, 1fr); }
            .pipeline { grid-template-columns: 1fr; }
            .content { padding: 1rem; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border-subtle); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

        /* ============================================
           NOTIFICATIONS SYSTEM
           ============================================ */
        .notification-bell {
            position: relative;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            transition: background 0.15s;
        }
        .notification-bell:hover { background: var(--bg-subtle); }
        .notification-bell svg { width: 18px; height: 18px; color: var(--text-muted); }
        .notification-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 16px;
            height: 16px;
            background: var(--red);
            border-radius: 50%;
            font-size: 0.625rem;
            font-weight: 700;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--bg);
        }
        .notification-badge.hidden { display: none; }

        .notification-panel {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            width: 360px;
            max-height: 480px;
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 10px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.4);
            z-index: 200;
            display: none;
            overflow: hidden;
        }
        .notification-panel.show { display: block; }
        .notification-header {
            padding: 0.875rem 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .notification-header h3 { font-size: 0.875rem; font-weight: 600; }
        .notification-clear {
            font-size: 0.75rem;
            color: var(--accent);
            cursor: pointer;
            background: none;
            border: none;
            font-family: inherit;
        }
        .notification-clear:hover { text-decoration: underline; }
        .notification-list {
            max-height: 380px;
            overflow-y: auto;
        }
        .notification-item {
            padding: 0.875rem 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 0.75rem;
            cursor: pointer;
            transition: background 0.15s;
        }
        .notification-item:hover { background: var(--bg-muted); }
        .notification-item.unread { background: rgba(59, 130, 246, 0.05); }
        .notification-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .notification-icon.status { background: rgba(59, 130, 246, 0.15); color: var(--accent); }
        .notification-icon.task { background: rgba(234, 179, 8, 0.15); color: var(--yellow); }
        .notification-icon.alert { background: rgba(239, 68, 68, 0.15); color: var(--red); }
        .notification-icon svg { width: 16px; height: 16px; }
        .notification-content { flex: 1; min-width: 0; }
        .notification-title { font-size: 0.8125rem; font-weight: 500; margin-bottom: 0.125rem; }
        .notification-desc { font-size: 0.75rem; color: var(--text-muted); }
        .notification-time { font-size: 0.6875rem; color: var(--text-dim); margin-top: 0.25rem; }
        .notification-empty {
            padding: 2rem;
            text-align: center;
            color: var(--text-dim);
            font-size: 0.8125rem;
        }

        /* Task badge in nav */
        .nav-badge.urgent { background: var(--red); animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* ============================================
           GLOBAL SEARCH (Cmd+K)
           ============================================ */
        .search-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 500;
            display: none;
            align-items: flex-start;
            justify-content: center;
            padding-top: 15vh;
        }
        .search-overlay.show { display: flex; }
        .search-modal {
            width: 100%;
            max-width: 580px;
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 24px 80px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }
        .search-input-wrapper {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
        }
        .search-input-wrapper svg { width: 20px; height: 20px; color: var(--text-dim); flex-shrink: 0; }
        .search-input {
            flex: 1;
            background: transparent;
            border: none;
            font-size: 1rem;
            color: var(--text);
            font-family: inherit;
            outline: none;
        }
        .search-input::placeholder { color: var(--text-dim); }
        .search-shortcut {
            font-size: 0.6875rem;
            color: var(--text-dim);
            background: var(--bg-muted);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            border: 1px solid var(--border);
        }
        .search-results {
            max-height: 400px;
            overflow-y: auto;
        }
        .search-section { padding: 0.5rem 0; }
        .search-section-title {
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-dim);
            padding: 0.5rem 1.25rem;
        }
        .search-result {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem 1.25rem;
            cursor: pointer;
            transition: background 0.1s;
        }
        .search-result:hover, .search-result.selected { background: var(--bg-muted); }
        .search-result-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .search-result-icon.prospect { background: rgba(59, 130, 246, 0.15); color: var(--accent); }
        .search-result-icon.task { background: rgba(234, 179, 8, 0.15); color: var(--yellow); }
        .search-result-icon.action { background: rgba(168, 85, 247, 0.15); color: var(--purple); }
        .search-result-icon svg { width: 16px; height: 16px; }
        .search-result-content { flex: 1; min-width: 0; }
        .search-result-title { font-size: 0.875rem; font-weight: 500; }
        .search-result-meta { font-size: 0.75rem; color: var(--text-muted); }
        .search-result-shortcut {
            font-size: 0.6875rem;
            color: var(--text-dim);
            background: var(--bg);
            padding: 0.125rem 0.375rem;
            border-radius: 3px;
        }
        .search-footer {
            padding: 0.75rem 1.25rem;
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.75rem;
            color: var(--text-dim);
        }
        .search-footer kbd {
            background: var(--bg);
            padding: 0.125rem 0.375rem;
            border-radius: 3px;
            border: 1px solid var(--border);
            font-size: 0.6875rem;
        }

        /* ============================================
           TIMELINE / ACTIVITY
           ============================================ */
        .timeline {
            position: relative;
            padding-left: 1.5rem;
        }
        .timeline::before {
            content: '';
            position: absolute;
            left: 5px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border);
        }
        .timeline-item {
            position: relative;
            padding-bottom: 1rem;
        }
        .timeline-item:last-child { padding-bottom: 0; }
        .timeline-dot {
            position: absolute;
            left: -1.5rem;
            top: 0.25rem;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--bg-muted);
            border: 2px solid var(--border-subtle);
        }
        .timeline-dot.status { background: var(--accent); border-color: var(--accent); }
        .timeline-dot.asset { background: var(--green); border-color: var(--green); }
        .timeline-dot.note { background: var(--yellow); border-color: var(--yellow); }
        .timeline-dot.task { background: var(--purple); border-color: var(--purple); }
        .timeline-content {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.625rem 0.875rem;
        }
        .timeline-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }
        .timeline-action { font-size: 0.8125rem; font-weight: 500; }
        .timeline-date { font-size: 0.6875rem; color: var(--text-dim); }
        .timeline-desc { font-size: 0.75rem; color: var(--text-muted); }

        /* ============================================
           CONTEXT MENU (Quick Actions)
           ============================================ */
        .context-menu {
            position: fixed;
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
            min-width: 180px;
            z-index: 300;
            display: none;
            padding: 0.375rem 0;
        }
        .context-menu.show { display: block; }
        .context-menu-item {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            padding: 0.5rem 0.875rem;
            font-size: 0.8125rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.1s;
        }
        .context-menu-item:hover { background: var(--bg-muted); color: var(--text); }
        .context-menu-item svg { width: 14px; height: 14px; }
        .context-menu-item.danger { color: var(--red); }
        .context-menu-item.danger:hover { background: rgba(239, 68, 68, 0.1); }
        .context-menu-divider { height: 1px; background: var(--border); margin: 0.375rem 0; }

        /* ============================================
           ANALYTICS KPI ROW
           ============================================ */
        .analytics-kpi-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .analytics-kpi {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
        }
        .analytics-kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.25rem;
        }
        .analytics-kpi-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        @media (max-width: 768px) {
            .analytics-kpi-row { grid-template-columns: repeat(2, 1fr); }
        }

        /* ============================================
           FUNNEL / ADVANCED STATS
           ============================================ */
        .funnel-container { padding: 1rem 0; }
        .funnel-stage {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.75rem;
        }
        .funnel-label {
            width: 100px;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: right;
        }
        .funnel-bar-wrapper {
            flex: 1;
            height: 28px;
            background: var(--bg);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        .funnel-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--purple));
            border-radius: 4px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 0.5rem;
        }
        .funnel-value {
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        .funnel-count {
            width: 60px;
            font-size: 0.8125rem;
            font-weight: 600;
            text-align: right;
        }
        .funnel-percent {
            font-size: 0.6875rem;
            color: var(--text-dim);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        .stat-card-mini {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
        }
        .stat-card-mini-label {
            font-size: 0.6875rem;
            color: var(--text-dim);
            margin-bottom: 0.375rem;
        }
        .stat-card-mini-value {
            font-size: 1.25rem;
            font-weight: 700;
        }
        .stat-card-mini-trend {
            font-size: 0.6875rem;
            margin-top: 0.25rem;
        }
        .stat-card-mini-trend.up { color: var(--green); }
        .stat-card-mini-trend.down { color: var(--red); }

        /* ============================================
           FOCUS MODE
           ============================================ */
        .focus-mode .sidebar { display: none; }
        .focus-mode .main { margin-left: 0; }
        .focus-mode .header { background: var(--bg-subtle); }

        .focus-panel {
            max-width: 800px;
            margin: 0 auto;
        }
        .focus-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .focus-date {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }
        .focus-greeting {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .focus-section {
            margin-bottom: 1.5rem;
        }
        .focus-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-dim);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .focus-section-title svg { width: 14px; height: 14px; }

        .focus-task {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1rem;
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.15s;
        }
        .focus-task:hover { border-color: var(--accent); }
        .focus-task-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-subtle);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s;
        }
        .focus-task-checkbox:hover { border-color: var(--accent); }
        .focus-task-checkbox.checked {
            background: var(--accent);
            border-color: var(--accent);
        }
        .focus-task-checkbox svg { width: 12px; height: 12px; color: white; opacity: 0; }
        .focus-task-checkbox.checked svg { opacity: 1; }
        .focus-task-content { flex: 1; }
        .focus-task-title { font-size: 0.875rem; font-weight: 500; }
        .focus-task-meta { font-size: 0.75rem; color: var(--text-muted); }
        .focus-task-priority {
            font-size: 0.6875rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }
        .focus-task-priority.urgent { background: rgba(239, 68, 68, 0.15); color: var(--red); }
        .focus-task-priority.normal { background: rgba(59, 130, 246, 0.15); color: var(--accent); }

        .focus-followup {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }
        .focus-followup-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--purple));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .focus-followup-content { flex: 1; }
        .focus-followup-company { font-size: 0.875rem; font-weight: 500; }
        .focus-followup-reason { font-size: 0.75rem; color: var(--text-muted); }
        .focus-followup-action {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 500;
        }
        .focus-followup-action:hover { background: var(--accent-muted); }

        /* View Toggle Button */
        .view-toggle {
            display: flex;
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
        }
        .view-toggle-btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-family: inherit;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }
        .view-toggle-btn:hover { color: var(--text); }
        .view-toggle-btn.active { background: var(--accent); color: white; }
        .view-toggle-btn svg { width: 14px; height: 14px; }
    </style>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <div class="logo-mark">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                    </svg>
                </div>
                <span class="logo-text">PACIFIK'AI</span>
            </div>

            <nav class="nav">
                <div class="nav-group">
                    <div class="nav-label">Menu</div>
                    <a class="nav-item active" data-view="dashboard">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
                        Dashboard
                    </a>
                    <a class="nav-item" data-view="prospects">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        Prospects
                        <span class="nav-badge" id="nav-prospect-count">0</span>
                    </a>
                    <a class="nav-item" data-view="plan">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                        Plan 30j
                    </a>
                    <a class="nav-item" data-view="tasks">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                        Taches
                    </a>
                    <a class="nav-item" data-view="analytics">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                        Analytics
                    </a>
                    <a class="nav-item" data-view="content">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/></svg>
                        Content
                        <span class="nav-badge" id="nav-content-count" style="background: var(--purple);">0</span>
                    </a>
                </div>

                <div class="nav-group">
                    <div class="nav-label">Liens</div>
                    <a class="nav-item" href="https://pacifikai.com" target="_blank" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(168, 85, 247, 0.15)); border: 1px solid var(--accent);">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                        Landing Page
                    </a>
                    <a class="nav-item" href="https://airtable.com/appF7pltUaQkOlKM5" target="_blank">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
                        Airtable
                    </a>
                    <a class="nav-item" href="https://n8n.srv1140766.hstgr.cloud" target="_blank">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                        n8n
                    </a>
                    <a class="nav-item" href="https://www.facebook.com/profile.php?id=61587101037690" target="_blank">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/></svg>
                        Facebook
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="user">
                    <div class="user-avatar">JB</div>
                    <div class="user-info">
                        <div class="user-name">Jordy Banks</div>
                        <div class="user-role">Fondateur</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main -->
        <main class="main">
            <!-- Dashboard View -->
            <div class="view active" id="view-dashboard">
                <header class="header">
                    <div class="header-left">
                        <h1>Dashboard</h1>
                        <p id="current-date"></p>
                    </div>
                    <div class="header-actions">
                        <!-- Search Shortcut -->
                        <button class="btn btn-ghost" onclick="openGlobalSearch()" title="Recherche (Cmd+K)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                            <span class="search-shortcut">K</span>
                        </button>
                        <!-- Focus Mode Toggle -->
                        <button class="btn btn-ghost" onclick="toggleFocusMode()" id="focus-toggle" title="Mode Focus">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg>
                            Focus
                        </button>
                        <!-- Notifications -->
                        <div class="notification-bell" onclick="toggleNotifications(event)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                            <span class="notification-badge" id="notification-badge">0</span>
                            <!-- Notification Panel -->
                            <div class="notification-panel" id="notification-panel">
                                <div class="notification-header">
                                    <h3>Notifications</h3>
                                    <button class="notification-clear" onclick="clearAllNotifications(event)">Tout effacer</button>
                                </div>
                                <div class="notification-list" id="notification-list">
                                    <div class="notification-empty">Aucune notification</div>
                                </div>
                            </div>
                        </div>
                        <div class="sync-status" id="sync-status">
                            <span class="sync-dot"></span>
                            <span id="sync-text">Jamais sync</span>
                        </div>
                        <button class="btn btn-ghost" onclick="syncFromAirtable()" id="sync-btn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                            Sync Airtable
                        </button>
                        <a class="btn btn-primary" href="https://airtable.com/appF7pltUaQkOlKM5/tbluw05otXoESeQkz" target="_blank">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            Nouveau prospect
                        </a>
                    </div>
                </header>

                <div class="content">
                    <!-- Today's Follow-ups Widget -->
                    <div class="followups-widget" id="followups-widget" style="display: none;">
                        <div class="followups-header">
                            <div class="followups-title">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                                Relances du jour
                            </div>
                            <span class="followups-count" id="followups-count">0</span>
                        </div>
                        <div id="followups-list"></div>
                    </div>

                    <!-- Stats -->
                    <div class="stats-row">
                        <div class="stat">
                            <div class="stat-label">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
                                Prospects
                            </div>
                            <div class="stat-value" id="stat-total">0</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                                Contactes
                            </div>
                            <div class="stat-value" id="stat-contacted">0</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                RDV/Audits
                            </div>
                            <div class="stat-value" id="stat-meetings">0</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                                Pipeline
                            </div>
                            <div class="stat-value blue" id="stat-pipeline">0</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                                Clients
                            </div>
                            <div class="stat-value green" id="stat-won">0</div>
                        </div>
                    </div>

                    <!-- Analytics Grid -->
                    <div class="analytics-grid">
                        <div class="chart-card">
                            <div class="chart-header">
                                <span class="chart-title">Pipeline par Temperature</span>
                            </div>
                            <div class="bar-chart" id="chart-temp"></div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-header">
                                <span class="chart-title">Funnel de Conversion</span>
                            </div>
                            <div class="funnel" id="chart-funnel"></div>
                        </div>
                    </div>

                    <!-- Featured Prospects (with Assets) -->
                    <div class="featured-section">
                        <div class="featured-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                            Prospects avec prototypes crees
                        </div>
                        <div class="featured-prospects" id="featured-prospects"></div>
                    </div>

                    <!-- Pipeline -->
                    <div class="card" style="margin-bottom: 1.5rem;">
                        <div class="card-header">
                            <h3 class="card-title">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
                                Pipeline
                            </h3>
                        </div>
                        <div class="pipeline" id="pipeline-board"></div>
                    </div>

                    <!-- Grid -->
                    <div class="grid">
                        <!-- Recent Prospects -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
                                    Prospects recents
                                </h3>
                                <button class="card-btn" onclick="showView('prospects')">Voir tout</button>
                            </div>
                            <div class="card-body flush">
                                <div class="table-wrap">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Nom</th>
                                                <th>Secteur</th>
                                                <th>Status</th>
                                                <th>Valeur</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recent-prospects"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div>
                            <!-- Plan Progress -->
                            <div class="card" style="margin-bottom: 1rem;">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                                        Plan 30 jours
                                    </h3>
                                    <button class="card-btn" onclick="showView('plan')">Voir tout</button>
                                </div>
                                <div class="card-body">
                                    <div class="progress-wrap">
                                        <div class="progress-header">
                                            <span class="progress-label">Progression</span>
                                            <span class="progress-value" id="plan-percent">0%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" id="plan-bar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <ul class="checklist" id="plan-preview"></ul>
                                </div>
                            </div>

                            <!-- Quick Links -->
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Actions rapides</h3>
                                </div>
                                <div class="card-body">
                                    <div class="quick-links">
                                        <a class="quick-link" href="https://airtable.com/appF7pltUaQkOlKM5" target="_blank">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
                                            Airtable
                                        </a>
                                        <a class="quick-link" href="mailto:jordy@pacifikai.com">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                                            Email
                                        </a>
                                        <a class="quick-link" href="https://calendly.com" target="_blank">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                            Calendly
                                        </a>
                                        <a class="quick-link" href="https://wa.me/68987123456" target="_blank">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
                                            WhatsApp
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Prospects View -->
            <div class="view" id="view-prospects">
                <header class="header">
                    <div class="header-left">
                        <h1>Prospects</h1>
                        <p>Gestion du CRM - <span id="prospects-count-header">0</span> prospects</p>
                    </div>
                    <div class="header-actions">
                        <div class="view-toggle">
                            <button class="view-toggle-btn active" data-pview="kanban" title="Kanban Temperature">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="5" height="18" rx="1"/><rect x="10" y="8" width="5" height="13" rx="1"/><rect x="17" y="5" width="5" height="16" rx="1"/></svg>
                                Kanban
                            </button>
                            <button class="view-toggle-btn" data-pview="list" title="Liste">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
                                Liste
                            </button>
                            <button class="view-toggle-btn" data-pview="pipeline" title="Pipeline Status">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                                Pipeline
                            </button>
                        </div>
                        <button class="btn btn-ghost" onclick="exportProspectsCSV()" title="Exporter en CSV">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            Export CSV
                        </button>
                        <a class="btn btn-primary" href="https://airtable.com/appF7pltUaQkOlKM5/tbluw05otXoESeQkz" target="_blank">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            Ajouter
                        </a>
                    </div>
                </header>
                <div class="content">
                    <!-- Summary Cards -->
                    <div class="summary-cards" id="summary-cards">
                        <div class="summary-card">
                            <div class="summary-card-icon hot"></div>
                            <div class="summary-card-content">
                                <div class="summary-card-value" id="sum-hot">0</div>
                                <div class="summary-card-label">Hot</div>
                            </div>
                            <div class="summary-card-pipeline" id="sum-hot-val">0</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-card-icon chaud"></div>
                            <div class="summary-card-content">
                                <div class="summary-card-value" id="sum-chaud">0</div>
                                <div class="summary-card-label">Chaud</div>
                            </div>
                            <div class="summary-card-pipeline" id="sum-chaud-val">0</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-card-icon tiede"></div>
                            <div class="summary-card-content">
                                <div class="summary-card-value" id="sum-tiede">0</div>
                                <div class="summary-card-label">Tiede</div>
                            </div>
                            <div class="summary-card-pipeline" id="sum-tiede-val">0</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-card-icon froid"></div>
                            <div class="summary-card-content">
                                <div class="summary-card-value" id="sum-froid">0</div>
                                <div class="summary-card-label">Froid</div>
                            </div>
                            <div class="summary-card-pipeline" id="sum-froid-val">0</div>
                        </div>
                    </div>

                    <!-- Toolbar -->
                    <div class="toolbar">
                        <div class="toolbar-left">
                            <div class="search-box">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                                <input type="text" id="search-prospects" placeholder="Rechercher..." oninput="filterProspects()">
                            </div>
                            <div class="dropdown">
                                <button class="dropdown-btn" onclick="toggleDropdown('sector-dropdown')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
                                    <span id="sector-filter-label">Tous secteurs</span>
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                                </button>
                                <div class="dropdown-menu" id="sector-dropdown"></div>
                            </div>
                            <div class="dropdown">
                                <button class="dropdown-btn" onclick="toggleDropdown('status-dropdown')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                    <span id="status-filter-label">Tous status</span>
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                                </button>
                                <div class="dropdown-menu" id="status-dropdown"></div>
                            </div>
                        </div>
                        <div class="toolbar-right">
                            <!-- Date Filter -->
                            <div class="dropdown">
                                <button class="dropdown-btn" onclick="toggleDropdown('date-dropdown')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                    <span id="date-filter-label">Toutes dates</span>
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                                </button>
                                <div class="dropdown-menu" id="date-dropdown">
                                    <div class="dropdown-item active" data-date="all" onclick="setDateFilter('all')">Toutes dates</div>
                                    <div class="dropdown-item" data-date="today" onclick="setDateFilter('today')">Aujourd'hui</div>
                                    <div class="dropdown-item" data-date="week" onclick="setDateFilter('week')">Cette semaine</div>
                                    <div class="dropdown-item" data-date="month" onclick="setDateFilter('month')">Ce mois</div>
                                    <div class="dropdown-item" data-date="quarter" onclick="setDateFilter('quarter')">Ce trimestre</div>
                                </div>
                            </div>
                            <!-- Sort -->
                            <div class="dropdown">
                                <button class="dropdown-btn" onclick="toggleDropdown('sort-dropdown')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="12" x2="14" y2="12"/><line x1="4" y1="18" x2="8" y2="18"/></svg>
                                    <span id="sort-label">Trier par</span>
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                                </button>
                                <div class="dropdown-menu" id="sort-dropdown">
                                    <div class="dropdown-item active" data-sort="priority" onclick="setSortBy('priority')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                                        Priorite (temp.)
                                    </div>
                                    <div class="dropdown-item" data-sort="value-desc" onclick="setSortBy('value-desc')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                                        Valeur (haut)
                                    </div>
                                    <div class="dropdown-item" data-sort="value-asc" onclick="setSortBy('value-asc')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                                        Valeur (bas)
                                    </div>
                                    <div class="dropdown-item" data-sort="company" onclick="setSortBy('company')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
                                        Entreprise (A-Z)
                                    </div>
                                    <div class="dropdown-item" data-sort="sector" onclick="setSortBy('sector')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
                                        Secteur (A-Z)
                                    </div>
                                    <div class="dropdown-divider"></div>
                                    <div class="dropdown-item" data-sort="assets" onclick="setSortBy('assets')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                                        Avec assets
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Kanban View (Temperature) -->
                    <div class="prospects-view-container active" id="pview-kanban">
                        <div class="kanban-temp" id="kanban-temp-board"></div>
                    </div>

                    <!-- List View -->
                    <div class="prospects-view-container" id="pview-list">
                        <div class="card">
                            <div class="card-body flush">
                                <div class="table-wrap">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th class="sortable" data-sort="company">Entreprise</th>
                                                <th>Contact</th>
                                                <th class="sortable" data-sort="sector">Secteur</th>
                                                <th class="sortable" data-sort="status">Status</th>
                                                <th class="sortable" data-sort="value">Valeur</th>
                                                <th class="sortable" data-sort="priority">Priorite</th>
                                            </tr>
                                        </thead>
                                        <tbody id="prospects-table"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pipeline View (Status) -->
                    <div class="prospects-view-container" id="pview-pipeline">
                        <div class="pipeline" id="pipeline-status-board"></div>
                    </div>
                </div>
            </div>

            <!-- Plan View -->
            <div class="view" id="view-plan">
                <header class="header">
                    <div class="header-left">
                        <h1>Plan 30 jours</h1>
                        <p>Objectif: 2-3 clients signes</p>
                    </div>
                </header>
                <div class="content">
                    <div class="stats-row" style="grid-template-columns: repeat(4, 1fr);">
                        <div class="stat">
                            <div class="stat-label">Semaine</div>
                            <div class="stat-value" id="plan-week">1</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Terminees</div>
                            <div class="stat-value green" id="plan-done">0</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Total</div>
                            <div class="stat-value" id="plan-total">20</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Progression</div>
                            <div class="stat-value blue" id="plan-progress">0%</div>
                        </div>
                    </div>

                    <div class="tabs" id="plan-tabs">
                        <button class="tab active" data-week="all">Tout</button>
                        <button class="tab" data-week="1">Semaine 1</button>
                        <button class="tab" data-week="2">Semaine 2</button>
                        <button class="tab" data-week="3">Semaine 3</button>
                        <button class="tab" data-week="4">Semaine 4</button>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <ul class="checklist" id="plan-full"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tasks View -->
            <div class="view" id="view-tasks">
                <header class="header">
                    <div class="header-left">
                        <h1>Taches</h1>
                        <p>Gestion des taches par projet</p>
                    </div>
                    <div class="header-actions">
                        <select class="filter-select" id="task-project-filter" onchange="filterTasks()">
                            <option value="all">Tous les projets</option>
                            <option value="ATN">Air Tahiti Nui</option>
                            <option value="PACIFIKAI">PACIFIK'AI</option>
                            <option value="other">Autres</option>
                        </select>
                        <select class="filter-select" id="task-priority-filter" onchange="filterTasks()">
                            <option value="all">Toutes priorites</option>
                            <option value="Urgent">Urgent</option>
                            <option value="Normal">Normal</option>
                            <option value="Faible">Faible</option>
                        </select>
                        <button class="btn btn-primary" onclick="addTask()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            Nouvelle tache
                        </button>
                    </div>
                </header>
                <div class="content">
                    <!-- Task Stats -->
                    <div class="stats-row" style="margin-bottom: 1.5rem;">
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--red);">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                            </div>
                            <div class="stat-info">
                                <span class="stat-value" id="task-urgent-count">0</span>
                                <span class="stat-label">Urgent</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--yellow);">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                            </div>
                            <div class="stat-info">
                                <span class="stat-value" id="task-pending-count">0</span>
                                <span class="stat-label">A faire</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--accent);">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                            </div>
                            <div class="stat-info">
                                <span class="stat-value" id="task-progress-count">0</span>
                                <span class="stat-label">En cours</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--green);">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                            </div>
                            <div class="stat-info">
                                <span class="stat-value" id="task-done-count">0</span>
                                <span class="stat-label">Termine</span>
                            </div>
                        </div>
                    </div>

                    <!-- Task Kanban -->
                    <div class="pipeline" id="task-kanban">
                        <div class="pipeline-column" data-status=" faire">
                            <div class="pipeline-header">
                                <span class="pipeline-title">A faire</span>
                                <span class="pipeline-count" id="kanban-todo-count">0</span>
                            </div>
                            <div class="pipeline-cards" id="kanban-todo"></div>
                        </div>
                        <div class="pipeline-column" data-status="En cours">
                            <div class="pipeline-header">
                                <span class="pipeline-title">En cours</span>
                                <span class="pipeline-count" id="kanban-progress-count">0</span>
                            </div>
                            <div class="pipeline-cards" id="kanban-progress"></div>
                        </div>
                        <div class="pipeline-column" data-status="Bloqu">
                            <div class="pipeline-header">
                                <span class="pipeline-title">Bloque</span>
                                <span class="pipeline-count" id="kanban-blocked-count">0</span>
                            </div>
                            <div class="pipeline-cards" id="kanban-blocked"></div>
                        </div>
                        <div class="pipeline-column" data-status="Termin">
                            <div class="pipeline-header">
                                <span class="pipeline-title">Termine</span>
                                <span class="pipeline-count" id="kanban-done-count">0</span>
                            </div>
                            <div class="pipeline-cards" id="kanban-done"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Calendar View -->
            <div class="view" id="view-content">
                <header class="header">
                    <div class="header-left">
                        <h1>Content Calendar</h1>
                        <p>Gestion des publications Facebook PACIFIK'AI</p>
                    </div>
                    <div class="header-actions">
                        <div class="content-stats">
                            <div class="content-stat">
                                <div class="content-stat-value" id="posts-scheduled-count">0</div>
                                <div class="content-stat-label">Planifies</div>
                            </div>
                            <div class="content-stat">
                                <div class="content-stat-value" id="posts-published-count">0</div>
                                <div class="content-stat-label">Publies</div>
                            </div>
                        </div>
                        <button class="btn" onclick="triggerFacebookWorkflow()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                            Lancer Workflow
                        </button>
                    </div>
                </header>

                <div class="content-grid">
                    <!-- Calendar -->
                    <div class="content-calendar">
                        <div class="calendar-header">
                            <h3 id="calendar-month-year">Janvier 2026</h3>
                            <div class="calendar-nav">
                                <button onclick="navigateCalendar(-1)">&lt; Precedent</button>
                                <button onclick="navigateCalendar(0)">Aujourd'hui</button>
                                <button onclick="navigateCalendar(1)">Suivant &gt;</button>
                            </div>
                        </div>
                        <div class="calendar-week">
                            <div class="calendar-day-label">Lun</div>
                            <div class="calendar-day-label">Mar</div>
                            <div class="calendar-day-label">Mer</div>
                            <div class="calendar-day-label">Jeu</div>
                            <div class="calendar-day-label">Ven</div>
                            <div class="calendar-day-label">Sam</div>
                            <div class="calendar-day-label">Dim</div>
                        </div>
                        <div class="calendar-days" id="calendar-days">
                            <!-- Generated by JS -->
                        </div>
                    </div>

                    <!-- Sidebar -->
                    <div class="post-sidebar">
                        <!-- Create Post -->
                        <div class="post-create-card">
                            <h3>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                                Nouveau Post
                            </h3>
                            <textarea class="post-textarea" id="post-content" placeholder="Ecris ton post ou laisse l'IA generer du contenu..."></textarea>

                            <div class="post-options">
                                <div class="post-option active" data-type="ai-news">Actu IA</div>
                                <div class="post-option" data-type="case-study">Cas Client</div>
                                <div class="post-option" data-type="tip">Conseil</div>
                            </div>

                            <div class="post-schedule">
                                <input type="date" id="post-date" />
                                <input type="time" id="post-time" value="08:00" />
                            </div>

                            <div class="post-actions">
                                <button class="btn ai-generate-btn" onclick="generatePostWithAI()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1"/></svg>
                                    Generer IA
                                </button>
                                <button class="btn btn-primary" onclick="schedulePost()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                                    Planifier
                                </button>
                            </div>
                        </div>

                        <!-- Posts List -->
                        <div class="posts-list">
                            <div class="posts-list-header">
                                <h3>Posts</h3>
                                <div class="posts-list-tabs">
                                    <div class="posts-list-tab active" data-filter="all">Tous</div>
                                    <div class="posts-list-tab" data-filter="scheduled">Planifies</div>
                                    <div class="posts-list-tab" data-filter="published">Publies</div>
                                </div>
                            </div>
                            <div id="posts-list-content">
                                <!-- Generated by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- AI Chatbot FAB -->
    <button class="chatbot-fab" onclick="toggleChatbot()" id="chatbot-fab">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        </svg>
    </button>

    <!-- AI Chatbot Panel -->
    <div class="chatbot-panel" id="chatbot-panel">
        <div class="chatbot-header">
            <div class="chatbot-avatar">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2M7.5 13A1.5 1.5 0 1 0 9 14.5 1.5 1.5 0 0 0 7.5 13m9 0a1.5 1.5 0 1 0 1.5 1.5 1.5 1.5 0 0 0-1.5-1.5M12 17c-1.5 0-2.5.5-2.5 1h5c0-.5-1-1-2.5-1"/>
                </svg>
            </div>
            <div class="chatbot-info">
                <div class="chatbot-name">PACIFIK'AI Assistant</div>
                <div class="chatbot-status">
                    <span class="chatbot-status-dot"></span>
                    En ligne - Claude Sonnet
                </div>
            </div>
            <button class="chatbot-close" onclick="toggleChatbot()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>

        <div class="chatbot-messages" id="chatbot-messages">
            <!-- Welcome message -->
            <div class="chat-message assistant">
                <div class="chat-avatar">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1"/>
                    </svg>
                </div>
                <div class="chat-bubble">
                    <p><strong>Salut Jordy!</strong></p>
                    <p>Je suis ton assistant IA. Je peux <strong>lire ET modifier</strong> tes donnees:</p>
                    <ul>
                        <li><strong>Lire:</strong> stats, recherche, rappels, secteurs</li>
                        <li><strong>Modifier:</strong> changer status, temperature, ajouter notes/rappels</li>
                    </ul>
                    <p>Exemples: "passe Air Tahiti en contacte" / "note pour Aranui: RDV confirme"</p>
                    <div class="chat-actions">
                        <button class="chat-action-btn" onclick="sendChatMessage('Montre moi les stats')">Stats</button>
                        <button class="chat-action-btn" onclick="sendChatMessage('aide')">Commandes</button>
                        <button class="chat-action-btn" onclick="sendChatMessage('Quels rappels aujourd\'hui?')">Rappels</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="chatbot-input-area">
            <div class="chatbot-suggestions" id="chatbot-suggestions">
                <span class="suggestion-chip" onclick="sendChatMessage('Combien de prospects?')">Combien de prospects?</span>
                <span class="suggestion-chip" onclick="sendChatMessage('Valeur totale du pipeline')">Pipeline total</span>
                <span class="suggestion-chip" onclick="sendChatMessage('Prospects a relancer')">A relancer</span>
            </div>
            <div class="chatbot-input-wrap">
                <textarea
                    class="chatbot-input"
                    id="chatbot-input"
                    placeholder="Demande quelque chose..."
                    rows="1"
                    onkeydown="handleChatKeydown(event)"
                ></textarea>
                <button class="chatbot-send" onclick="sendUserMessage()" id="chatbot-send">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Add Reminder Modal -->
    <div class="modal-overlay" id="reminder-modal" onclick="closeReminderModal(event)">
        <div class="reminder-modal" onclick="event.stopPropagation()">
            <h3>Ajouter un rappel</h3>
            <div class="reminder-form">
                <div class="form-group">
                    <label>Date de relance</label>
                    <input type="date" id="reminder-date">
                </div>
                <div class="form-group">
                    <label>Note (optionnel)</label>
                    <textarea id="reminder-note" rows="2" placeholder="Ex: Relancer par email pour devis..."></textarea>
                </div>
                <div class="form-actions">
                    <button class="btn btn-ghost" onclick="closeReminderModal()">Annuler</button>
                    <button class="btn btn-primary" onclick="saveReminder()">Ajouter</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Prospect Detail Modal -->
    <div class="modal-overlay" id="prospect-modal" onclick="closeProspectModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title-section">
                    <h2 class="modal-title" id="modal-company">-</h2>
                    <div class="modal-subtitle">
                        <span id="modal-sector">-</span>
                        <span></span>
                        <span class="badge" id="modal-status">-</span>
                        <span></span>
                        <span class="badge" id="modal-priority">-</span>
                    </div>
                </div>
                <button class="modal-close" onclick="closeProspectModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <div class="modal-body">
                <!-- Editable Contact Info Section -->
                <div class="prospect-edit-section">
                    <div class="edit-section-header">
                        <span class="edit-section-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                            Infos Contact
                        </span>
                        <button class="edit-toggle-btn" id="edit-toggle-btn" onclick="toggleEditMode()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                            Modifier
                        </button>
                    </div>
                    <div class="prospect-info" id="prospect-info-display">
                        <div class="prospect-info-item">
                            <div class="prospect-info-label">Contact</div>
                            <div class="prospect-info-value" id="modal-contact">-</div>
                        </div>
                        <div class="prospect-info-item">
                            <div class="prospect-info-label">Email</div>
                            <div class="prospect-info-value" id="modal-email">-</div>
                        </div>
                        <div class="prospect-info-item">
                            <div class="prospect-info-label">Telephone</div>
                            <div class="prospect-info-value" id="modal-phone">-</div>
                        </div>
                        <div class="prospect-info-item">
                            <div class="prospect-info-label">Poste</div>
                            <div class="prospect-info-value" id="modal-poste">-</div>
                        </div>
                    </div>
                    <!-- Edit Form (hidden by default) -->
                    <div class="prospect-edit-form" id="prospect-edit-form" style="display:none;">
                        <div class="edit-form-grid">
                            <div class="edit-field">
                                <label>Nom du contact</label>
                                <input type="text" id="edit-contact" placeholder="Ex: Jean Dupont">
                            </div>
                            <div class="edit-field">
                                <label>Email</label>
                                <input type="email" id="edit-email" placeholder="Ex: jean@company.com">
                            </div>
                            <div class="edit-field">
                                <label>Telephone</label>
                                <input type="tel" id="edit-phone" placeholder="Ex: 87 12 34 56">
                            </div>
                            <div class="edit-field">
                                <label>Poste / Fonction</label>
                                <input type="text" id="edit-poste" placeholder="Ex: Directeur Commercial">
                            </div>
                        </div>
                        <div class="edit-form-actions">
                            <button class="btn btn-ghost" onclick="cancelEditMode()">Annuler</button>
                            <button class="btn btn-primary" onclick="saveProspectEdits()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><polyline points="20 6 9 17 4 12"/></svg>
                                Enregistrer
                            </button>
                        </div>
                    </div>
                </div>

                <!-- FICHE IA Section (Prioritaire) -->
                <div class="fiche-ia-section" id="fiche-ia-section">
                    <div class="fiche-ia-header">
                        <div class="fiche-ia-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px;color:var(--purple);">
                                <path d="M12 2a10 10 0 1 0 10 10H12V2z"/>
                                <path d="M12 2a10 10 0 0 1 10 10"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                            Fiche Recherche IA
                        </div>
                        <span class="fiche-ia-badge" id="fiche-ia-badge">Non generee</span>
                    </div>
                    <div class="fiche-ia-content" id="fiche-ia-content">
                        <div class="fiche-ia-empty" id="fiche-ia-empty">
                            <p>Aucune fiche de recherche generee pour ce prospect.</p>
                            <p class="fiche-ia-hint">La fiche contient: contexte entreprise, 10 features automatisables, script d'appel, email de prospection, estimation potentiel.</p>
                            <button class="btn btn-primary fiche-ia-generate" onclick="generateFicheIA()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
                                    <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                                </svg>
                                Generer avec Claude Opus
                            </button>
                        </div>
                        <div class="fiche-ia-available" id="fiche-ia-available" style="display:none;">
                            <div class="fiche-ia-preview">
                                <div class="fiche-ia-preview-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                        <polyline points="14 2 14 8 20 8"/>
                                        <circle cx="12" cy="14" r="3"/>
                                    </svg>
                                </div>
                                <div class="fiche-ia-preview-info">
                                    <div class="fiche-ia-preview-name">FICHE_RECHERCHE.md</div>
                                    <div class="fiche-ia-preview-meta" id="fiche-ia-meta">Generee le --</div>
                                </div>
                            </div>
                            <div class="fiche-ia-actions">
                                <button class="btn btn-primary" onclick="openFicheIA()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                    Consulter
                                </button>
                                <button class="btn btn-ghost" onclick="regenerateFicheIA()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
                                        <path d="M23 4v6h-6"/>
                                        <path d="M1 20v-6h6"/>
                                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10"/>
                                        <path d="M20.49 15a9 9 0 0 1-14.85 3.36L1 14"/>
                                    </svg>
                                    Regenerer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats Row -->
                <div class="prospect-info" style="margin-top: 1rem;">
                    <div class="prospect-info-item">
                        <div class="prospect-info-label">Valeur Pipeline</div>
                        <div class="prospect-info-value" id="modal-value" style="color: var(--green);">-</div>
                    </div>
                    <div class="prospect-info-item">
                        <div class="prospect-info-label">Date Ajout</div>
                        <div class="prospect-info-value" id="modal-date">-</div>
                    </div>
                    <div class="prospect-info-item">
                        <div class="prospect-info-label">Assets Crees</div>
                        <div class="prospect-info-value" id="modal-assets-count">0</div>
                    </div>
                </div>

                <div class="assets-section" id="modal-assets-section">
                    <div class="assets-section-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                        Documents & Assets Crees
                    </div>
                    <div class="assets-grid" id="modal-assets-grid">
                        <!-- Dynamically populated -->
                    </div>
                </div>

                <div id="modal-no-assets" style="display: none;">
                    <div class="no-assets">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg>
                        <p>Aucun document cree pour ce prospect</p>
                        <span>Demarre un projet pour ce prospect pour creer des assets</span>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div style="margin-top: 1.5rem; display: flex; gap: 0.75rem; flex-wrap: wrap;">
                    <a class="btn btn-primary" id="modal-airtable-link" href="#" target="_blank">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
                        Airtable
                    </a>
                    <button class="btn btn-ghost" onclick="sendEmail()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                        Email
                    </button>
                    <button class="btn btn-ghost" onclick="openWhatsApp()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
                        WhatsApp
                    </button>
                    <button class="btn btn-ghost" onclick="showAddReminder()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                        Rappel
                    </button>
                    <button class="btn btn-ghost" id="modal-open-folder" onclick="openProspectFolder()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
                        Dossier
                    </button>
                </div>

                <!-- Notes Section -->
                <div class="notes-section">
                    <div class="notes-header">
                        <div class="notes-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                            Notes
                        </div>
                    </div>
                    <div class="note-input-wrap">
                        <textarea class="note-input" id="modal-note-input" placeholder="Ajouter une note..." rows="2"></textarea>
                        <button class="btn btn-primary" onclick="addNote()" style="align-self: flex-end;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        </button>
                    </div>
                    <div class="notes-list" id="modal-notes-list"></div>
                </div>

                <!-- Activity Timeline -->
                <div class="notes-section" style="margin-top: 1.5rem;">
                    <div class="notes-header">
                        <div class="notes-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                            Historique d'activite
                        </div>
                    </div>
                    <div id="modal-timeline"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data
        let prospects = [];
        let tasks = [];
        let notes = {}; // { prospectId: [{ id, text, date }] }
        let followups = []; // [{ id, prospectId, date, note, done }]
        let lastSync = null;
        let currentProspectsView = 'kanban';
        let currentSort = 'priority';
        let currentSectorFilter = 'all';
        let currentStatusFilter = 'all';
        let currentDateFilter = 'all';
        let searchQuery = '';

        // Airtable Config
        const AIRTABLE_CONFIG = {
            baseId: 'appF7pltUaQkOlKM5',
            tableId: 'tbluw05otXoESeQkz',
            apiKey: 'patLSz0TNoR3J4kCF.41eb537f86dc7caacaClub3d4c77f277eb8e7e6dab4b39dc1dbe8ef44adf1e'
        };

        // Tasks Table Config
        const TASKS_TABLE_ID = 'tblOqUUWT2ExGfjGw';
        let currentTaskProjectFilter = 'all';
        let currentTaskPriorityFilter = 'all';

        // Claude API Config - Cl charge depuis localStorage pour scurit
        function getClaudeApiKey() {
            const key = localStorage.getItem('CLAUDE_API_KEY');
            if (!key) {
                console.warn('[Claude API] Aucune cl configure. Utilise configureClaudeKey() pour en dfinir une.');
                return null;
            }
            return key;
        }

        // Fonction pour configurer la cl ( appeler une fois dans la console du navigateur)
        window.configureClaudeKey = function(key) {
            if (!key || !key.startsWith('sk-ant-')) {
                console.error('Cl invalide. Elle doit commencer par sk-ant-');
                return;
            }
            localStorage.setItem('CLAUDE_API_KEY', key);
            console.log('Cl API Claude configure avec succs!');
            showToast('Cl API Claude configure!');
        };

        // Fonction pour vrifier si la cl est configure
        window.checkClaudeKey = function() {
            const key = getClaudeApiKey();
            if (key) {
                console.log('Cl API prsente:', key.substring(0, 20) + '...');
                return true;
            }
            console.log('Aucune cl API configure. Utilise: configureClaudeKey("sk-ant-...")');
            return false;
        };

        const CLAUDE_CONFIG = {
            get apiKey() { return getClaudeApiKey(); },
            model: 'claude-sonnet-4-5-20250929',
            // System prompt with full PACIFIK'AI context
            systemPrompt: `Tu es l'assistant IA personnel de Jordy Banks pour gerer son CRM PACIFIK'AI.

## TON ROLE
Tu aides Jordy a gerer ses prospects et son pipeline commercial. Tu dois:
1. Comprendre le langage naturel meme approximatif
2. Repondre de facon concise et actionnable
3. TOUJOURS tutoyer Jordy
4. Proposer des actions concretes quand c'est pertinent

## ENTREPRISE
- PACIFIK'AI = Agence automatisation IA en Polynesie francaise
- Objectif: 100K XPF/mois de revenus recurrents
- Services: Chatbots IA, Automatisation n8n, Dashboards

## COMPRENDRE LES MESSAGES DE JORDY
Jordy peut ecrire de facon informelle. Exemples:
- "J'ai appele Air Tahiti" = il a contacte ce prospect -> MAJ status + note
- "ils sont chauds" = le prospect est interesse -> MAJ priorite
- "rdv mardi" = il a un rendez-vous -> MAJ status vers 'meeting'
- "mail envoye" = premier contact -> MAJ status vers 'contacted'
- "c'est ok" ou "ils signent" = prospect gagne -> MAJ status vers 'won'
- "c'est mort" ou "pas interesse" = prospect froid -> MAJ priorite

## FORMAT DE REPONSE
- Court et direct (2-3 phrases max)
- Si tu comprends une action a faire, dis ce que tu proposes
- Si tu ne comprends pas, demande de preciser
- Utilise le markdown pour la lisibilite

## CE QUE TU PEUX FAIRE
- Donner les stats du pipeline
- Lister les prospects par priorite/status
- Trouver des infos sur un prospect
- Suggerer des actions a effectuer
- Repondre aux questions sur l'IA et l'automatisation

## CE QUE TU NE PEUX PAS FAIRE DIRECTEMENT
Les modifications (status, notes, rappels) sont gerees par le code JavaScript.
Tu donnes des conseils et informations, le systeme execute les actions.

IMPORTANT: Ne fais jamais de reponse longue. Sois bref et efficace.`
        };

        // Chatbot state
        let chatHistory = [];
        let isChatbotOpen = false;
        let useClaudeAPI = true; // Toggle for Claude API vs local processing

        // Assets database - loaded dynamically from manifest
        // Generated by: ./scripts/generate-assets-manifest.sh
        let PROSPECT_ASSETS = {};

        // Load assets manifest on startup
        async function loadAssetsManifest() {
            try {
                const response = await fetch('assets-manifest.json?t=' + Date.now());
                if (response.ok) {
                    const manifest = await response.json();
                    PROSPECT_ASSETS = manifest.prospects || {};
                    console.log('[Assets] Manifest charge:', Object.keys(PROSPECT_ASSETS).length, 'prospects,',
                        Object.values(PROSPECT_ASSETS).reduce((acc, p) => acc + (p.files?.length || 0), 0), 'fichiers');
                    console.log('[Assets] Genere le:', manifest.generated);

                    // Re-render if already loaded
                    if (prospects.length > 0) {
                        renderProspectsViews();
                    }
                } else {
                    console.warn('[Assets] Manifest non trouve, utilisation du fallback');
                    loadAssetsFallback();
                }
            } catch (error) {
                console.error('[Assets] Erreur chargement manifest:', error);
                loadAssetsFallback();
            }
        }

        // Fallback assets si manifest non disponible
        function loadAssetsFallback() {
            PROSPECT_ASSETS = {
                'Air Tahiti Nui': {
                    folder: 'Air Tahiti Nui',
                    files: [
                        { type: 'dash', name: 'Dashboard', file: 'demo-site/dashboard.html', desc: 'Dashboard complet' },
                        { type: 'site', name: 'Landing Page', file: 'demo-site/index.html', desc: 'Page principale' },
                        { type: 'wf', name: 'Visualiseur n8n', file: 'demo-site/n8n-visualizer.html', desc: 'Workflows n8n' }
                    ]
                },
                'COWAN MOTOR': {
                    folder: 'COWAN MOTOR',
                    files: [
                        { type: 'doc', name: 'Proposition', file: 'proposition-commerciale.html', desc: 'Proposition commerciale' },
                        { type: 'doc', name: 'Script Appel', file: 'script-appel.md', desc: 'Script telephonique' }
                    ]
                }
            };
        }

        // Helper: Find assets for a prospect (handles name variations)
        function getProspectAssets(companyName) {
            // Direct match
            if (PROSPECT_ASSETS[companyName]) {
                return PROSPECT_ASSETS[companyName];
            }
            // Try without accents
            const normalized = companyName.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            for (const [key, value] of Object.entries(PROSPECT_ASSETS)) {
                const keyNormalized = key.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                if (keyNormalized.toLowerCase() === normalized.toLowerCase()) {
                    return value;
                }
            }
            // Try partial match
            for (const [key, value] of Object.entries(PROSPECT_ASSETS)) {
                if (key.toLowerCase().includes(companyName.toLowerCase()) ||
                    companyName.toLowerCase().includes(key.toLowerCase())) {
                    return value;
                }
            }
            return null;
        }

        // Refresh assets manifest (call after creating new files)
        function refreshAssetsManifest() {
            showToast('Actualisation des assets...');
            loadAssetsManifest().then(() => {
                showToast('Assets actualises');
            });
        }

        const PLAN = [
            { id: 1, week: 1, title: "Creer offre Audit IA Gratuit", desc: "Page + Calendly", done: false },
            { id: 2, week: 1, title: "Creer 3 cas d'etude", desc: "Restaurant, Hotel, Comptable", done: false },
            { id: 3, week: 1, title: "Mettre a jour LinkedIn", desc: "Headline + Resume", done: false },
            { id: 4, week: 1, title: "Optimiser page Facebook", desc: "Bio + Post epingle", done: false },
            { id: 5, week: 1, title: "Connecter 20 entrepreneurs", desc: "LinkedIn Polynesie", done: false },
            { id: 6, week: 2, title: "Contacter CCISM", desc: "Email + Appel partenariat", done: false },
            { id: 7, week: 2, title: "Lister 20 restaurants", desc: "Google Maps + TripAdvisor", done: false },
            { id: 8, week: 2, title: "Envoyer 20 messages", desc: "WhatsApp prospection", done: false },
            { id: 9, week: 2, title: "Identifier 5 comptables", desc: "Partenaires potentiels", done: false },
            { id: 10, week: 2, title: "Contacter 3 comptables", desc: "Proposition 15%", done: false },
            { id: 11, week: 3, title: "Reserver lieu petit-dej", desc: "Cafe Papeete 8-10 places", done: false },
            { id: 12, week: 3, title: "Inviter 15 personnes", desc: "Cafe IA & Automatisation", done: false },
            { id: 13, week: 3, title: "Preparer demo workflow", desc: "Reservation restaurant", done: false },
            { id: 14, week: 3, title: "Organiser l'evenement", desc: "Petit-dejeuner networking", done: false },
            { id: 15, week: 3, title: "Collecter contacts", desc: "Photos + WhatsApp", done: false },
            { id: 16, week: 4, title: "Follow-up participants", desc: "Message + lien audit", done: false },
            { id: 17, week: 4, title: "Relancer sans reponse", desc: "2eme message", done: false },
            { id: 18, week: 4, title: "Realiser 5-8 audits", desc: "30 min chacun", done: false },
            { id: 19, week: 4, title: "Envoyer propositions", desc: "Sous 24h", done: false },
            { id: 20, week: 4, title: "Closer 2-3 clients", desc: "Relances J+3/5/7", done: false },
        ];

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            loadAssetsManifest(); // Load assets from manifest (dynamic)
            setDate();
            render();
            setupNav();
            setupFilters();
            setupProspectsView();
            setupDropdowns();
            loadTasksFromAirtable(); // Load tasks from Airtable

            // Check Claude API key
            if (!getClaudeApiKey()) {
                console.log('%c[PACIFIK\'AI] Pour activer le chatbot IA, configure ta cl:', 'color: orange; font-weight: bold');
                console.log('%cconfigureClaudeKey("ta-cle-sk-ant-...")', 'color: cyan');
            }
        });

        function loadData() {
            const p = localStorage.getItem('pk_prospects_v5'); // v5 = avec notes/followups
            const t = localStorage.getItem('pk_tasks');
            const plan = localStorage.getItem('pk_plan');
            const n = localStorage.getItem('pk_notes');
            const f = localStorage.getItem('pk_followups');
            const sync = localStorage.getItem('pk_last_sync');

            if (p) prospects = JSON.parse(p);
            if (t) tasks = JSON.parse(t);
            if (n) notes = JSON.parse(n);
            if (f) followups = JSON.parse(f);
            if (sync) lastSync = new Date(sync);
            if (plan) {
                JSON.parse(plan).forEach(s => {
                    const item = PLAN.find(i => i.id === s.id);
                    if (item) item.done = s.done;
                });
            }

            // Real data from Airtable CRM + Notion sync (56 prospects)
            // assets: site=demo-site, dash=dashboard, wf=workflow, doc=proposition
            if (!prospects.length) {
                prospects = [
                    // HOT - Priority targets
                    { id: 1, name: "Torea Colas", company: "Air Tahiti Nui", sector: "Transport", status: "lead", value: 3000000, date: "2026-01-28", priority: "hot", assets: ["site", "dash", "wf"] },
                    { id: 2, name: "", company: "Air Tahiti", sector: "Transport", status: "contacted", value: 3000000, date: "2026-01-28", priority: "hot", assets: ["site", "dash", "wf"] },
                    { id: 3, name: "Romain Chanet", company: "Four Seasons Bora Bora", sector: "Hotellerie", status: "lead", value: 3000000, date: "2026-01-28", priority: "hot" },
                    { id: 4, name: "Roger Godin", company: "Conrad Bora Bora Nui", sector: "Hotellerie", status: "lead", value: 3000000, date: "2026-01-28", priority: "hot" },
                    { id: 5, name: "Emmanuel Richardet", company: "St Regis Bora Bora", sector: "Hotellerie", status: "lead", value: 3000000, date: "2026-01-28", priority: "hot" },
                    { id: 6, name: "Anne Roure", company: "Sofitel Bora Bora Private Island", sector: "Hotellerie", status: "lead", value: 3000000, date: "2026-01-28", priority: "hot" },
                    { id: 7, name: "Rose Richmond", company: "Hilton Moorea Lagoon Resort", sector: "Hotellerie", status: "lead", value: 3000000, date: "2026-01-28", priority: "hot" },
                    { id: 8, name: "Emmanuel Richardet", company: "InterContinental Bora Bora Thalasso", sector: "Hotellerie", status: "lead", value: 3000000, date: "2026-01-28", priority: "hot" },
                    { id: 9, name: "Kareen Lisan", company: "Vini (OPT)", sector: "Telecom", status: "lead", value: 5000000, date: "2026-01-28", priority: "hot" },
                    { id: 10, name: "Maire Sabre", company: "OCA - Centre d'Appels", sector: "Services", status: "lead", value: 5000000, date: "2026-01-28", priority: "hot" },
                    { id: 11, name: "", company: "IMF Tahiti", sector: "Services", status: "lead", value: 4500000, date: "2026-01-28", priority: "hot" },
                    { id: 12, name: "Christel Gelormini", company: "Banque de Tahiti", sector: "Finance", status: "lead", value: 4500000, date: "2026-01-28", priority: "hot" },
                    { id: 13, name: "Manuhiti Amiot", company: "Air Tahiti Nui (IT)", sector: "Transport", status: "lead", value: 4500000, date: "2026-01-28", priority: "hot", assets: ["site", "dash", "wf"] },
                    // CHAUD
                    { id: 14, name: "", company: "Aranui", sector: "Transport", status: "contacted", value: 2500000, date: "2026-01-28", priority: "chaud", assets: ["site", "dash", "wf"] },
                    { id: 15, name: "", company: "Tahiti Tourisme", sector: "Tourisme", status: "lead", value: 6000000, date: "2026-01-28", priority: "chaud", assets: ["site", "dash", "wf"] },
                    { id: 16, name: "", company: "InterContinental Tahiti", sector: "Hotellerie", status: "lead", value: 4000000, date: "2026-01-28", priority: "chaud", assets: ["site", "dash"] },
                    { id: 17, name: "", company: "Groupama Gan PF", sector: "Assurance", status: "lead", value: 4000000, date: "2026-01-28", priority: "chaud" },
                    { id: 18, name: "", company: "Le Meridien Tahiti", sector: "Hotellerie", status: "lead", value: 3000000, date: "2026-01-28", priority: "chaud" },
                    { id: 19, name: "Sabine G. L.", company: "Sofitel Kia Ora Moorea", sector: "Hotellerie", status: "lead", value: 3000000, date: "2026-01-28", priority: "chaud" },
                    { id: 20, name: "", company: "Manava Beach Resort Moorea", sector: "Hotellerie", status: "lead", value: 3000000, date: "2026-01-28", priority: "chaud" },
                    { id: 21, name: "", company: "COWAN MOTOR", sector: "Import", status: "lead", value: 850000, date: "2026-01-28", priority: "chaud", assets: ["doc"] },
                    { id: 22, name: "", company: "EDEC SARL", sector: "Comptabilite", status: "lead", value: 2500000, date: "2026-01-28", priority: "chaud" },
                    { id: 23, name: "Jose Chanlin", company: "FIDUPAC SARL", sector: "Comptabilite", status: "lead", value: 2200000, date: "2026-01-28", priority: "chaud" },
                    { id: 24, name: "Thomas Wagener", company: "HORWATH SARL", sector: "Comptabilite", status: "lead", value: 2200000, date: "2026-01-28", priority: "chaud" },
                    { id: 25, name: "", company: "FIDELIANCE SARL", sector: "Comptabilite", status: "lead", value: 2200000, date: "2026-01-28", priority: "chaud" },
                    { id: 26, name: "Julie Hoarau", company: "CABINET MOREL & OUDET", sector: "Comptabilite", status: "lead", value: 2000000, date: "2026-01-28", priority: "chaud" },
                    { id: 27, name: "Philippe Bercegol", company: "EXPERTISE COMPTABLE TAHITI", sector: "Comptabilite", status: "lead", value: 2000000, date: "2026-01-28", priority: "chaud" },
                    { id: 28, name: "M. Sola", company: "AUDIT PACIFIQUE SARL", sector: "Comptabilite", status: "lead", value: 2000000, date: "2026-01-28", priority: "chaud" },
                    { id: 29, name: "Kevin Robson", company: "Brasserie de Tahiti", sector: "Import", status: "lead", value: 2000000, date: "2026-01-28", priority: "chaud" },
                    { id: 30, name: "", company: "Pacific Petroleum", sector: "Import", status: "lead", value: 2500000, date: "2026-01-28", priority: "chaud" },
                    { id: 31, name: "Gilles Afriat", company: "CFAO Tahiti", sector: "Import", status: "lead", value: 2200000, date: "2026-01-28", priority: "chaud" },
                    { id: 32, name: "", company: "SDO Tahiti", sector: "Import", status: "lead", value: 2000000, date: "2026-01-28", priority: "chaud" },
                    // TIEDE
                    { id: 33, name: "", company: "Banque de Polynesie", sector: "Finance", status: "lead", value: 5000000, date: "2026-01-28", priority: "tiede", assets: ["site", "dash", "wf"] },
                    { id: 34, name: "", company: "OPT", sector: "Telecom", status: "lead", value: 4000000, date: "2026-01-28", priority: "tiede", assets: ["site", "dash", "wf"] },
                    { id: 35, name: "Alain Ciantar", company: "Tahiti Auto Services", sector: "Import", status: "lead", value: 1800000, date: "2026-01-28", priority: "tiede" },
                    { id: 36, name: "Christophe Guardia", company: "Le Tahiti by Pearl Resorts", sector: "Hotellerie", status: "lead", value: 1000000, date: "2026-01-28", priority: "tiede" },
                    { id: 37, name: "Laurent LE SEAC'H", company: "Le Taha'a by Pearl Resorts", sector: "Hotellerie", status: "lead", value: 1000000, date: "2026-01-28", priority: "tiede" },
                    { id: 38, name: "Laurent LE SEAC'H", company: "Le Bora Bora by Pearl Resorts", sector: "Hotellerie", status: "lead", value: 1000000, date: "2026-01-28", priority: "tiede" },
                    { id: 39, name: "", company: "Le Tikehau by Pearl Resorts", sector: "Hotellerie", status: "lead", value: 1000000, date: "2026-01-28", priority: "tiede" },
                    { id: 40, name: "Michael Delmas", company: "Maitai Polynesia Bora Bora", sector: "Hotellerie", status: "lead", value: 1000000, date: "2026-01-28", priority: "tiede" },
                    { id: 41, name: "Laurent Campi", company: "Maitai Lapita Village Huahine", sector: "Hotellerie", status: "lead", value: 1000000, date: "2026-01-28", priority: "tiede" },
                    { id: 42, name: "Arieta Manager", company: "Royal Huahine", sector: "Hotellerie", status: "lead", value: 1000000, date: "2026-01-28", priority: "tiede" },
                    { id: 43, name: "Olivier Davin", company: "Hotel Le Mahana Huahine", sector: "Hotellerie", status: "lead", value: 1000000, date: "2026-01-28", priority: "tiede" },
                    { id: 44, name: "Philippe Sizaret", company: "Cook's Bay Hotel Moorea", sector: "Hotellerie", status: "lead", value: 1000000, date: "2026-01-28", priority: "tiede" },
                    { id: 45, name: "Natalee Martin", company: "Te Moana Tahiti Resort", sector: "Hotellerie", status: "lead", value: 1000000, date: "2026-01-28", priority: "tiede" },
                    { id: 46, name: "Loic Hurtrel", company: "Raiatea Lodge Hotel", sector: "Hotellerie", status: "lead", value: 1000000, date: "2026-01-28", priority: "tiede" },
                    { id: 47, name: "", company: "Hotel Kia Ora Rangiroa", sector: "Hotellerie", status: "lead", value: 1000000, date: "2026-01-28", priority: "tiede" },
                    { id: 48, name: "Cesar Marquez", company: "The Westin Bora Bora", sector: "Hotellerie", status: "lead", value: 1000000, date: "2026-01-28", priority: "tiede" },
                    // FROID
                    { id: 49, name: "", company: "The Moorings", sector: "Nautique", status: "lead", value: 1500000, date: "2026-01-28", priority: "froid", assets: ["site", "dash", "wf"] },
                    { id: 50, name: "Manutea Sachet", company: "Te Mana Import", sector: "Import", status: "lead", value: 1500000, date: "2026-01-28", priority: "froid" },
                    { id: 51, name: "Gilbert Liao", company: "Essor Import SARL", sector: "Import", status: "lead", value: 1500000, date: "2026-01-28", priority: "froid" },
                    { id: 52, name: "", company: "PORINETIA IMPORT EXPORT", sector: "Import", status: "lead", value: 1500000, date: "2026-01-28", priority: "froid" },
                    { id: 53, name: "F. Delsol", company: "AUDIFI SARL", sector: "Comptabilite", status: "lead", value: 1500000, date: "2026-01-28", priority: "froid" },
                    { id: 54, name: "Grand Michel", company: "Easy Rider Tahiti", sector: "Import", status: "lead", value: 1200000, date: "2026-01-28", priority: "froid" },
                    { id: 55, name: "Youk Moux", company: "Distillerie Moux", sector: "Import", status: "lead", value: 1200000, date: "2026-01-28", priority: "froid" },
                    { id: 56, name: "Chung Tonino", company: "Chung Import", sector: "Import", status: "lead", value: 1500000, date: "2026-01-28", priority: "froid" },
                ];
                save();
            }
        }

        function save() {
            localStorage.setItem('pk_prospects_v5', JSON.stringify(prospects));
            localStorage.setItem('pk_tasks', JSON.stringify(tasks));
            localStorage.setItem('pk_plan', JSON.stringify(PLAN.map(i => ({ id: i.id, done: i.done }))));
            localStorage.setItem('pk_notes', JSON.stringify(notes));
            localStorage.setItem('pk_followups', JSON.stringify(followups));
            if (lastSync) localStorage.setItem('pk_last_sync', lastSync.toISOString());
        }

        function setDate() {
            const d = new Date();
            document.getElementById('current-date').textContent = d.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        }

        // Navigation
        function setupNav() {
            document.querySelectorAll('.nav-item[data-view]').forEach(el => {
                el.addEventListener('click', e => {
                    e.preventDefault();
                    showView(el.dataset.view);
                });
            });
        }

        function showView(name) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('view-' + name).classList.add('active');
            document.querySelector(`.nav-item[data-view="${name}"]`)?.classList.add('active');
        }

        // Filters
        function setupFilters() {
            document.querySelectorAll('.card-btn[data-filter]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.card-btn[data-filter]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    renderProspectsTable(btn.dataset.filter);
                });
            });

            document.querySelectorAll('#plan-tabs .tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('#plan-tabs .tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    renderPlanFull(tab.dataset.week);
                });
            });
        }

        // Render
        function render() {
            renderStats();
            renderFeaturedProspects();
            renderPipeline();
            renderRecentProspects();
            renderProspectsTable('all');
            renderPlanPreview();
            renderPlanFull('all');
            renderTasks();
            renderProspectsViews();
        }

        function renderFeaturedProspects() {
            const featured = prospects.filter(p => p.assets && p.assets.length > 0);
            const container = document.getElementById('featured-prospects');

            container.innerHTML = featured.map(p => `
                <div class="featured-card" onclick="openProspectDetail(${p.id})">
                    <div class="featured-card-company">${p.company}</div>
                    <div class="featured-card-sector">${p.sector}</div>
                    <div class="featured-card-assets">
                        ${renderAssetIcons(p.assets)}
                    </div>
                </div>
            `).join('');
        }

        function refreshAll() { render(); }

        function renderStats() {
            const total = prospects.length;
            const contacted = prospects.filter(p => ['contacted','meeting','proposal','won'].includes(p.status)).length;
            const meetings = prospects.filter(p => p.status === 'meeting').length;
            const won = prospects.filter(p => p.status === 'won').length;
            const pipeline = prospects.filter(p => p.status !== 'lost').reduce((s, p) => s + (p.value || 0), 0);

            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-contacted').textContent = contacted;
            document.getElementById('stat-meetings').textContent = meetings;
            document.getElementById('stat-won').textContent = won;
            document.getElementById('stat-pipeline').textContent = fmtXPF(pipeline);
            document.getElementById('nav-prospect-count').textContent = total;

            const done = PLAN.filter(i => i.done).length;
            const pct = Math.round((done / PLAN.length) * 100);
            document.getElementById('plan-percent').textContent = pct + '%';
            document.getElementById('plan-bar').style.width = pct + '%';
            document.getElementById('plan-done').textContent = done;
            document.getElementById('plan-total').textContent = PLAN.length;
            document.getElementById('plan-progress').textContent = pct + '%';
            document.getElementById('plan-week').textContent = Math.min(Math.ceil(new Date().getDate() / 7), 4);
        }

        function renderPipeline() {
            const stages = [
                { key: 'lead', label: 'Lead' },
                { key: 'contacted', label: 'Contacte' },
                { key: 'meeting', label: 'RDV/Audit' },
                { key: 'proposal', label: 'Proposition' },
                { key: 'won', label: 'Gagne' }
            ];

            const board = document.getElementById('pipeline-board');
            board.innerHTML = stages.map(s => {
                const items = prospects.filter(p => p.status === s.key);
                return `
                    <div class="pipeline-col" data-status="${s.key}"
                         ondragover="handleDragOver(event)"
                         ondragleave="handleDragLeave(event)"
                         ondrop="handleStatusDrop(event, '${s.key}')">
                        <div class="pipeline-header">
                            <span class="pipeline-title">${s.label}</span>
                            <span class="pipeline-count">${items.length}</span>
                        </div>
                        ${items.map(p => {
                            const hasAssets = p.assets && p.assets.length > 0;
                            return `
                            <div class="pipeline-card ${hasAssets ? 'has-assets' : ''}"
                                 draggable="true"
                                 data-id="${p.id}"
                                 ondragstart="handleDragStart(event, ${p.id})"
                                 ondragend="handleDragEnd(event)"
                                 onclick="openProspectDetail(${p.id})"
                                 style="cursor: pointer;">
                                <div class="pipeline-card-name">${p.company}${renderAssetIcons(p.assets, true)}</div>
                                <div class="pipeline-card-company">${p.sector}</div>
                                <div class="pipeline-card-footer">
                                    <span class="pipeline-card-value">${fmtXPF(p.value)}</span>
                                    ${p.priority ? `<span class="pipeline-card-priority ${p.priority}">${priorityLabel(p.priority)}</span>` : ''}
                                </div>
                            </div>
                        `;}).join('')}
                    </div>
                `;
            }).join('');
        }

        function renderRecentProspects() {
            const recent = [...prospects].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 6);
            const tbody = document.getElementById('recent-prospects');
            tbody.innerHTML = recent.map(p => `
                <tr>
                    <td>
                        <div class="cell-name">
                            <div class="avatar ${getAvatarColor(p.status)}">${initials(p.company)}</div>
                            <span>${p.company}</span>${renderAssetIcons(p.assets)}
                        </div>
                    </td>
                    <td>${p.sector}</td>
                    <td><span class="badge ${p.status}"><span class="badge-dot"></span>${statusLabel(p.status)}</span></td>
                    <td>${fmtXPF(p.value)}</td>
                </tr>
            `).join('');
        }

        function renderProspectsTable(filter) {
            const filtered = getFilteredProspects();
            const tbody = document.getElementById('prospects-table');
            tbody.innerHTML = filtered.map(p => `
                <tr class="${p.assets?.length ? 'has-assets' : ''}" onclick="openProspectDetail(${p.id})" style="cursor: pointer;">
                    <td>
                        <div class="cell-name">
                            <div class="avatar ${getAvatarColor(p.status)}">${initials(p.company)}</div>
                            <span>${p.company}</span>${renderAssetIcons(p.assets)}
                        </div>
                    </td>
                    <td>${p.name || '-'}</td>
                    <td>${p.sector}</td>
                    <td><span class="badge ${p.status}"><span class="badge-dot"></span>${statusLabel(p.status)}</span></td>
                    <td>${fmtXPF(p.value)}</td>
                    <td>${p.priority ? `<span class="badge ${p.priority}">${priorityLabel(p.priority)}</span>` : '-'}</td>
                </tr>
            `).join('');
        }

        function renderPlanPreview() {
            const pending = PLAN.filter(i => !i.done).slice(0, 4);
            const el = document.getElementById('plan-preview');
            el.innerHTML = pending.map(i => checklistItem(i, true)).join('');
        }

        function renderPlanFull(week) {
            const items = week === 'all' ? PLAN : PLAN.filter(i => i.week == week);
            const el = document.getElementById('plan-full');
            el.innerHTML = items.map(i => checklistItem(i, false)).join('');
        }

        function checklistItem(item, preview) {
            const currentWeek = Math.min(Math.ceil(new Date().getDate() / 7), 4);
            return `
                <li class="checklist-item ${item.done ? 'done' : ''}">
                    <div class="checkbox ${item.done ? 'checked' : ''}" onclick="togglePlan(${item.id})">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
                    </div>
                    <div class="checklist-content">
                        <div class="checklist-title">${item.title}</div>
                        <div class="checklist-desc">${item.desc}</div>
                    </div>
                    ${!preview ? `<div class="checklist-meta"><span class="checklist-week ${item.week === currentWeek ? 'current' : ''}">S${item.week}</span></div>` : ''}
                </li>
            `;
        }

        function togglePlan(id) {
            const item = PLAN.find(i => i.id === id);
            if (item) {
                item.done = !item.done;
                save();
                render();
            }
        }

        // Airtable Tasks Data
        let airtableTasks = [];

        async function loadTasksFromAirtable() {
            try {
                const url = `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${TASKS_TABLE_ID}`;
                const res = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}` }
                });
                const data = await res.json();
                airtableTasks = data.records.map(r => ({
                    id: r.id,
                    title: r.fields['Tche'] || '',
                    description: r.fields['Description'] || '',
                    status: r.fields['Status'] || ' faire',
                    priority: r.fields['Priorit'] || 'Normal',
                    dueDate: r.fields['Due Date'] || null,
                    hours: r.fields['Temps estim (h)'] || 0,
                    project: extractProject(r.fields['Tche'] || '')
                }));
                renderTasks();
            } catch (err) {
                console.error('Erreur chargement tasks Airtable:', err);
            }
        }

        function extractProject(title) {
            const match = title.match(/^\[([^\]]+)\]/);
            return match ? match[1] : 'other';
        }

        function filterTasks() {
            currentTaskProjectFilter = document.getElementById('task-project-filter').value;
            currentTaskPriorityFilter = document.getElementById('task-priority-filter').value;
            renderTasks();
        }

        function getFilteredTasks() {
            return airtableTasks.filter(t => {
                const projectMatch = currentTaskProjectFilter === 'all' ||
                    (currentTaskProjectFilter === 'other' && !['ATN', 'PACIFIKAI'].includes(t.project)) ||
                    t.project === currentTaskProjectFilter;
                const priorityMatch = currentTaskPriorityFilter === 'all' || t.priority === currentTaskPriorityFilter;
                return projectMatch && priorityMatch;
            });
        }

        function renderTasks() {
            const filtered = getFilteredTasks();

            // Stats
            const urgent = filtered.filter(t => t.priority === 'Urgent').length;
            const pending = filtered.filter(t => t.status === ' faire').length;
            const progress = filtered.filter(t => t.status === 'En cours').length;
            const done = filtered.filter(t => t.status === 'Termin').length;

            document.getElementById('task-urgent-count').textContent = urgent;
            document.getElementById('task-pending-count').textContent = pending;
            document.getElementById('task-progress-count').textContent = progress;
            document.getElementById('task-done-count').textContent = done;

            // Kanban columns
            const columns = {
                ' faire': { el: 'kanban-todo', count: 'kanban-todo-count' },
                'En cours': { el: 'kanban-progress', count: 'kanban-progress-count' },
                'Bloqu': { el: 'kanban-blocked', count: 'kanban-blocked-count' },
                'Termin': { el: 'kanban-done', count: 'kanban-done-count' }
            };

            Object.entries(columns).forEach(([status, cfg]) => {
                const items = filtered.filter(t => t.status === status);
                document.getElementById(cfg.count).textContent = items.length;
                document.getElementById(cfg.el).innerHTML = items.map(t => renderTaskCard(t)).join('');
            });
        }

        function renderTaskCard(t) {
            const priorityClass = { 'Urgent': 'hot', 'Normal': '', 'Faible': 'tiede' }[t.priority] || '';
            const dueStr = t.dueDate ? new Date(t.dueDate).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }) : '';
            const isOverdue = t.dueDate && new Date(t.dueDate) < new Date() && t.status !== 'Termin';

            return `
                <div class="pipeline-card task-card" data-task-id="${t.id}">
                    <div class="pipeline-card-name">${t.title.replace(/^\[[^\]]+\]\s*/, '')}</div>
                    ${t.description ? `<div class="pipeline-card-company" style="font-size: 0.7rem; opacity: 0.7; margin-top: 0.25rem;">${t.description.substring(0, 60)}${t.description.length > 60 ? '...' : ''}</div>` : ''}
                    <div class="pipeline-card-footer" style="margin-top: 0.5rem;">
                        ${t.project !== 'other' ? `<span class="badge" style="background: var(--purple); font-size: 0.65rem; padding: 0.15rem 0.35rem;">${t.project}</span>` : ''}
                        ${dueStr ? `<span style="font-size: 0.7rem; color: ${isOverdue ? 'var(--red)' : 'var(--text-muted)'};">${dueStr}</span>` : ''}
                        ${t.priority === 'Urgent' ? `<span class="pipeline-card-priority hot">Urgent</span>` : ''}
                    </div>
                </div>
            `;
        }

        function addTask() {
            const title = prompt('Nouvelle tache (prefixe [PROJET] pour associer):');
            if (title) {
                // Create in Airtable
                createTaskInAirtable(title);
            }
        }

        async function createTaskInAirtable(title) {
            try {
                const url = `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${TASKS_TABLE_ID}`;
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fields: {
                            'Tche': title,
                            'Status': ' faire',
                            'Priorit': 'Normal'
                        }
                    })
                });
                if (res.ok) {
                    await loadTasksFromAirtable();
                }
            } catch (err) {
                console.error('Erreur creation task:', err);
            }
        }

        async function updateTaskStatus(taskId, newStatus) {
            try {
                const url = `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${TASKS_TABLE_ID}/${taskId}`;
                await fetch(url, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fields: { 'Status': newStatus }
                    })
                });
                await loadTasksFromAirtable();
            } catch (err) {
                console.error('Erreur update task:', err);
            }
        }

        function toggleTask(id) {
            const t = tasks.find(i => i.id === id);
            if (t) { t.done = !t.done; save(); renderTasks(); }
        }

        function deleteTask(id) {
            tasks = tasks.filter(t => t.id !== id);
            save();
            renderTasks();
        }

        // Helpers
        function initials(name) { return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2); }

        function statusLabel(s) {
            return { lead: 'Lead', contacted: 'Contacte', meeting: 'RDV', proposal: 'Proposition', won: 'Gagne', lost: 'Perdu' }[s] || s;
        }

        function getAvatarColor(s) {
            return { lead: 'blue', contacted: 'orange', meeting: 'purple', proposal: 'orange', won: 'green' }[s] || 'blue';
        }

        function priorityLabel(p) {
            return { hot: ' Hot', chaud: 'Chaud', tiede: 'Tiede', froid: 'Froid' }[p] || p;
        }

        function renderAssetIcons(assets, small) {
            if (!assets || !assets.length) return '';
            const icons = {
                site: { icon: '', title: 'Demo Site', cls: 'site' },
                dash: { icon: '', title: 'Dashboard', cls: 'dashboard' },
                wf: { icon: '', title: 'Workflow n8n', cls: 'workflow' },
                doc: { icon: '', title: 'Proposition', cls: 'doc' }
            };
            const html = assets.map(a => {
                const i = icons[a];
                return i ? `<span class="asset-icon ${i.cls}" data-tooltip="${i.title}">${i.icon}</span>` : '';
            }).join('');
            return `<span class="asset-icons">${html}</span>`;
        }

        function fmtXPF(v) {
            if (!v) return '-';
            if (v >= 1000000) return (v / 1000000).toFixed(1) + 'M';
            if (v >= 1000) return (v / 1000).toFixed(0) + 'K';
            return v + '';
        }

        function fmtDate(d) {
            if (!d) return '-';
            return new Date(d).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
        }

        // ============================================
        // PROSPECTS VIEW SYSTEM
        // ============================================

        function setupProspectsView() {
            // View toggle buttons
            document.querySelectorAll('.view-toggle-btn[data-pview]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentProspectsView = btn.dataset.pview;
                    showProspectsView(currentProspectsView);
                });
            });

            // Build sector and status dropdowns
            buildFilterDropdowns();
        }

        function showProspectsView(viewName) {
            document.querySelectorAll('.prospects-view-container').forEach(v => v.classList.remove('active'));
            document.getElementById('pview-' + viewName)?.classList.add('active');
            renderProspectsViews();
        }

        function buildFilterDropdowns() {
            // Sectors
            const sectors = [...new Set(prospects.map(p => p.sector))].sort();
            const sectorDropdown = document.getElementById('sector-dropdown');
            sectorDropdown.innerHTML = `
                <div class="dropdown-item ${currentSectorFilter === 'all' ? 'active' : ''}" onclick="setSectorFilter('all')">Tous secteurs</div>
                <div class="dropdown-divider"></div>
                ${sectors.map(s => `<div class="dropdown-item ${currentSectorFilter === s ? 'active' : ''}" onclick="setSectorFilter('${s}')">${s}</div>`).join('')}
            `;

            // Statuses
            const statuses = [
                { key: 'all', label: 'Tous status' },
                { key: 'lead', label: 'Lead' },
                { key: 'contacted', label: 'Contacte' },
                { key: 'meeting', label: 'RDV/Audit' },
                { key: 'proposal', label: 'Proposition' },
                { key: 'won', label: 'Gagne' },
                { key: 'lost', label: 'Perdu' }
            ];
            const statusDropdown = document.getElementById('status-dropdown');
            statusDropdown.innerHTML = statuses.map(s => `
                <div class="dropdown-item ${currentStatusFilter === s.key ? 'active' : ''}" onclick="setStatusFilter('${s.key}')">${s.label}</div>
            `).join('');
        }

        function setupDropdowns() {
            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.dropdown')) {
                    document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show'));
                }
            });
        }

        function toggleDropdown(id) {
            const menu = document.getElementById(id);
            const isOpen = menu.classList.contains('show');
            document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show'));
            if (!isOpen) menu.classList.add('show');
        }

        function setSectorFilter(sector) {
            currentSectorFilter = sector;
            document.getElementById('sector-filter-label').textContent = sector === 'all' ? 'Tous secteurs' : sector;
            buildFilterDropdowns();
            renderProspectsViews();
            toggleDropdown('sector-dropdown');
        }

        function setStatusFilter(status) {
            currentStatusFilter = status;
            document.getElementById('status-filter-label').textContent = status === 'all' ? 'Tous status' : statusLabel(status);
            buildFilterDropdowns();
            renderProspectsViews();
            toggleDropdown('status-dropdown');
        }

        function setSortBy(sort) {
            currentSort = sort;
            document.querySelectorAll('#sort-dropdown .dropdown-item').forEach(item => {
                item.classList.toggle('active', item.dataset.sort === sort);
            });
            const labels = {
                'priority': 'Priorite',
                'value-desc': 'Valeur ',
                'value-asc': 'Valeur ',
                'company': 'Entreprise',
                'sector': 'Secteur',
                'assets': 'Avec assets'
            };
            document.getElementById('sort-label').textContent = labels[sort] || 'Trier par';
            renderProspectsViews();
            toggleDropdown('sort-dropdown');
        }

        function setDateFilter(dateFilter) {
            currentDateFilter = dateFilter;
            document.querySelectorAll('#date-dropdown .dropdown-item').forEach(item => {
                item.classList.toggle('active', item.dataset.date === dateFilter);
            });
            const labels = {
                'all': 'Toutes dates',
                'today': "Aujourd'hui",
                'week': 'Cette semaine',
                'month': 'Ce mois',
                'quarter': 'Ce trimestre'
            };
            document.getElementById('date-filter-label').textContent = labels[dateFilter] || 'Toutes dates';
            renderProspectsViews();
            toggleDropdown('date-dropdown');
        }

        function filterProspects() {
            searchQuery = document.getElementById('search-prospects').value.toLowerCase();
            renderProspectsViews();
        }

        // ============================================
        // EXPORT CSV
        // ============================================

        function exportProspectsCSV() {
            const filtered = getFilteredProspects();

            if (filtered.length === 0) {
                showToast('Aucun prospect a exporter');
                return;
            }

            // CSV Header
            const headers = ['Entreprise', 'Contact', 'Email', 'Telephone', 'Poste', 'Secteur', 'Status', 'Priorite', 'Valeur XPF', 'Date'];

            // CSV Rows
            const rows = filtered.map(p => [
                p.company || '',
                p.contact || p.name || '',
                p.email || '',
                p.phone || '',
                p.poste || '',
                p.sector || '',
                statusLabel(p.status) || '',
                priorityLabel(p.priority) || '',
                p.value || 0,
                p.date || ''
            ]);

            // Build CSV content
            const csvContent = [
                headers.join(';'),
                ...rows.map(row => row.map(cell => {
                    // Escape quotes and wrap in quotes if contains separator
                    const str = String(cell).replace(/"/g, '""');
                    return str.includes(';') || str.includes('"') || str.includes('\n') ? `"${str}"` : str;
                }).join(';'))
            ].join('\n');

            // Add BOM for Excel UTF-8 compatibility
            const BOM = '\uFEFF';

            // Create and download file
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;

            const date = new Date().toISOString().split('T')[0];
            link.download = `pacifikai-prospects-${date}.csv`;

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showToast(`${filtered.length} prospects exportes en CSV`);
        }

        function getFilteredProspects() {
            let filtered = [...prospects];

            // Search filter
            if (searchQuery) {
                filtered = filtered.filter(p =>
                    p.company.toLowerCase().includes(searchQuery) ||
                    (p.name && p.name.toLowerCase().includes(searchQuery)) ||
                    p.sector.toLowerCase().includes(searchQuery)
                );
            }

            // Sector filter
            if (currentSectorFilter !== 'all') {
                filtered = filtered.filter(p => p.sector === currentSectorFilter);
            }

            // Status filter
            if (currentStatusFilter !== 'all') {
                filtered = filtered.filter(p => p.status === currentStatusFilter);
            }

            // Date filter
            if (currentDateFilter !== 'all') {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

                filtered = filtered.filter(p => {
                    if (!p.date) return false;
                    const prospectDate = new Date(p.date);

                    switch (currentDateFilter) {
                        case 'today':
                            return prospectDate >= today;
                        case 'week':
                            const weekAgo = new Date(today);
                            weekAgo.setDate(weekAgo.getDate() - 7);
                            return prospectDate >= weekAgo;
                        case 'month':
                            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                            return prospectDate >= monthStart;
                        case 'quarter':
                            const quarterStart = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1);
                            return prospectDate >= quarterStart;
                        default:
                            return true;
                    }
                });
            }

            // Sort
            const priorityOrder = { hot: 0, chaud: 1, tiede: 2, froid: 3 };
            const statusOrder = { lead: 0, contacted: 1, meeting: 2, proposal: 3, won: 4, lost: 5 };

            switch (currentSort) {
                case 'priority':
                    filtered.sort((a, b) => (priorityOrder[a.priority] || 99) - (priorityOrder[b.priority] || 99));
                    break;
                case 'value-desc':
                    filtered.sort((a, b) => (b.value || 0) - (a.value || 0));
                    break;
                case 'value-asc':
                    filtered.sort((a, b) => (a.value || 0) - (b.value || 0));
                    break;
                case 'company':
                    filtered.sort((a, b) => a.company.localeCompare(b.company));
                    break;
                case 'sector':
                    filtered.sort((a, b) => a.sector.localeCompare(b.sector));
                    break;
                case 'assets':
                    filtered.sort((a, b) => ((b.assets?.length || 0) - (a.assets?.length || 0)));
                    break;
            }

            return filtered;
        }

        function renderProspectsViews() {
            renderSummaryCards();
            renderKanbanTemp();
            renderProspectsTable(currentStatusFilter === 'all' ? 'all' : currentStatusFilter);
            renderPipelineStatus();
            document.getElementById('prospects-count-header').textContent = getFilteredProspects().length;
        }

        function renderSummaryCards() {
            const temps = ['hot', 'chaud', 'tiede', 'froid'];
            temps.forEach(temp => {
                const items = prospects.filter(p => p.priority === temp);
                const total = items.reduce((s, p) => s + (p.value || 0), 0);
                document.getElementById('sum-' + temp).textContent = items.length;
                document.getElementById('sum-' + temp + '-val').textContent = fmtXPF(total);
            });
        }

        // ============================================
        // KANBAN TEMPERATURE (with Drag & Drop)
        // ============================================

        function renderKanbanTemp() {
            const temps = [
                { key: 'hot', label: ' Hot', emoji: '' },
                { key: 'chaud', label: ' Chaud', emoji: '' },
                { key: 'tiede', label: ' Tiede', emoji: '' },
                { key: 'froid', label: ' Froid', emoji: '' }
            ];

            const filtered = getFilteredProspects();
            const board = document.getElementById('kanban-temp-board');

            board.innerHTML = temps.map(t => {
                const items = filtered.filter(p => p.priority === t.key);
                const total = items.reduce((s, p) => s + (p.value || 0), 0);
                return `
                    <div class="kanban-col" data-priority="${t.key}"
                         ondragover="handleDragOver(event)"
                         ondragleave="handleDragLeave(event)"
                         ondrop="handleDrop(event, '${t.key}')">
                        <div class="kanban-header ${t.key}">
                            <span class="kanban-title ${t.key}">${t.label}</span>
                            <div class="kanban-stats">
                                <span>${items.length}</span>
                                <span></span>
                                <span>${fmtXPF(total)}</span>
                            </div>
                        </div>
                        <div class="kanban-cards">
                            ${items.map(p => renderKanbanCard(p)).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderKanbanCard(p) {
            const hasAssets = p.assets && p.assets.length > 0;
            return `
                <div class="kanban-card ${hasAssets ? 'has-assets' : ''}"
                     draggable="true"
                     data-id="${p.id}"
                     ondragstart="handleDragStart(event, ${p.id})"
                     ondragend="handleDragEnd(event)"
                     onclick="openProspectDetail(${p.id})"
                    <div class="kanban-card-header">
                        <span class="kanban-card-company">${p.company}${renderAssetIcons(p.assets)}</span>
                        <span class="kanban-card-status badge ${p.status}">${statusLabel(p.status)}</span>
                    </div>
                    ${p.name ? `<div class="kanban-card-contact">${p.name}</div>` : ''}
                    <div class="kanban-card-sector">${p.sector}</div>
                    <div class="kanban-card-footer">
                        <span class="kanban-card-value">${fmtXPF(p.value)}</span>
                    </div>
                </div>
            `;
        }

        // Drag & Drop handlers
        let draggedProspectId = null;

        function handleDragStart(event, id) {
            draggedProspectId = id;
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', id);
        }

        function handleDragEnd(event) {
            event.target.classList.remove('dragging');
            document.querySelectorAll('.kanban-col, .pipeline-col').forEach(col => {
                col.classList.remove('drag-over');
            });
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            event.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(event, newPriority) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');

            if (draggedProspectId !== null) {
                const prospect = prospects.find(p => p.id === draggedProspectId);
                if (prospect && prospect.priority !== newPriority) {
                    prospect.priority = newPriority;
                    save();
                    renderProspectsViews();
                    renderStats();
                    // Visual feedback
                    showToast(`${prospect.company} deplace vers ${priorityLabel(newPriority)}`);
                }
                draggedProspectId = null;
            }
        }

        function handleStatusDrop(event, newStatus) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');

            if (draggedProspectId !== null) {
                const prospect = prospects.find(p => p.id === draggedProspectId);
                if (prospect && prospect.status !== newStatus) {
                    prospect.status = newStatus;
                    save();
                    renderProspectsViews();
                    renderStats();
                    renderPipeline();
                    showToast(`${prospect.company} deplace vers ${statusLabel(newStatus)}`);
                }
                draggedProspectId = null;
            }
        }

        // Toast notification
        function showToast(message) {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: var(--bg-muted);
                color: var(--text);
                padding: 0.75rem 1rem;
                border-radius: 8px;
                font-size: 0.8125rem;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                border: 1px solid var(--border);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        // ============================================
        // PROSPECT DETAIL MODAL
        // ============================================

        let currentProspectId = null;

        function openProspectDetail(id) {
            const prospect = prospects.find(p => p.id === id);
            if (!prospect) return;

            currentProspectId = id;
            const assets = getProspectAssets(prospect.company);

            // Fill modal
            document.getElementById('modal-company').textContent = prospect.company;
            document.getElementById('modal-sector').textContent = prospect.sector;
            document.getElementById('modal-contact').textContent = prospect.contact || prospect.name || 'Non renseigne';
            document.getElementById('modal-email').textContent = prospect.email || 'Non renseigne';
            document.getElementById('modal-phone').textContent = prospect.phone || 'Non renseigne';
            document.getElementById('modal-poste').textContent = prospect.poste || 'Non renseigne';
            document.getElementById('modal-value').textContent = fmtXPF(prospect.value) + ' XPF';
            document.getElementById('modal-date').textContent = fmtDate(prospect.date);

            // Reset edit mode
            document.getElementById('prospect-info-display').style.display = '';
            document.getElementById('prospect-edit-form').style.display = 'none';
            document.getElementById('edit-toggle-btn').classList.remove('active');
            document.getElementById('edit-toggle-btn').innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> Modifier';

            // Update Fiche IA section
            updateFicheIASection(prospect);

            // Status badge
            const statusBadge = document.getElementById('modal-status');
            statusBadge.className = 'badge ' + prospect.status;
            statusBadge.innerHTML = `<span class="badge-dot"></span>${statusLabel(prospect.status)}`;

            // Priority badge
            const priorityBadge = document.getElementById('modal-priority');
            if (prospect.priority) {
                priorityBadge.className = 'badge ' + prospect.priority;
                priorityBadge.textContent = priorityLabel(prospect.priority);
                priorityBadge.style.display = '';
            } else {
                priorityBadge.style.display = 'none';
            }

            // Assets
            const assetsSection = document.getElementById('modal-assets-section');
            const noAssets = document.getElementById('modal-no-assets');
            const assetsGrid = document.getElementById('modal-assets-grid');

            if (assets && assets.files.length > 0) {
                assetsSection.style.display = '';
                noAssets.style.display = 'none';
                document.getElementById('modal-assets-count').textContent = assets.files.length;

                const typeIcons = {
                    site: '',
                    dash: '',
                    wf: '',
                    doc: ''
                };

                const typeLabels = {
                    site: 'Site/Page',
                    dash: 'Dashboard',
                    wf: 'Workflow',
                    doc: 'Document'
                };

                assetsGrid.innerHTML = assets.files.map(f => `
                    <div class="asset-card" onclick="openAsset('${assets.folder}', '${f.file}')">
                        <div class="asset-card-icon ${f.type}">${typeIcons[f.type]}</div>
                        <div class="asset-card-content">
                            <div class="asset-card-name">${f.name}</div>
                            <div class="asset-card-desc">${f.desc}</div>
                        </div>
                        <div class="asset-card-arrow">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                        </div>
                    </div>
                `).join('');
            } else {
                assetsSection.style.display = 'none';
                noAssets.style.display = '';
                document.getElementById('modal-assets-count').textContent = '0';
            }

            // Airtable link
            document.getElementById('modal-airtable-link').href = `https://airtable.com/appF7pltUaQkOlKM5/tbluw05otXoESeQkz`;

            // Activity Timeline
            document.getElementById('modal-timeline').innerHTML = renderProspectTimeline(id);

            // Show modal
            document.getElementById('prospect-modal').classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeProspectModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('prospect-modal').classList.remove('show');
            document.body.style.overflow = '';
            currentProspectId = null;
        }

        function openAsset(folder, file) {
            // Chemin absolu pour macOS
            const basePath = "/Users/jordybanks/Documents/PACIFIKAI/Argentic Workflows/PACIFIK'AI";
            const fullPath = `${basePath}/${folder}/${file}`;

            console.log('[openAsset] Folder:', folder);
            console.log('[openAsset] File:', file);
            console.log('[openAsset] Full path:', fullPath);

            // Methode 1: Essayer le chemin relatif (fonctionne si serveur local)
            const relativePath = `../${folder}/${file}`;

            // Methode 2: URL file:// avec encodage correct
            const fileUrl = 'file://' + encodeURI(fullPath).replace(/#/g, '%23');

            // Essayer d'abord le chemin relatif
            const newWindow = window.open(relativePath, '_blank');

            // Verifier si ca a marche (apres un delai)
            setTimeout(() => {
                // Si la fenetre n'existe pas ou est vide, proposer alternatives
                if (!newWindow) {
                    showAssetModal(folder, file, fullPath);
                }
            }, 500);
        }

        function showAssetModal(folder, file, fullPath) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'asset-modal';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

            const fileName = file.split('/').pop();

            modal.innerHTML = `
                <div class="modal" onclick="event.stopPropagation()" style="max-width: 500px;">
                    <div class="modal-header">
                        <div class="modal-title-section">
                            <h2 class="modal-title">${fileName}</h2>
                            <div class="modal-subtitle">${folder}</div>
                        </div>
                        <button class="modal-close" onclick="document.getElementById('asset-modal').remove()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 1rem;">
                            Le fichier ne s'est pas ouvert. Options:
                        </p>
                        <div style="background: var(--bg-subtle); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <p style="font-size: 0.75rem; color: var(--text-dim); margin-bottom: 0.5rem;">Chemin complet:</p>
                            <textarea id="asset-path-textarea" readonly style="display: block; width: 100%; font-size: 0.75rem; font-family: monospace; background: var(--bg); padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border); color: var(--text); resize: none; min-height: 50px;" onclick="this.select()">${fullPath}</textarea>
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="copyAssetPath('${fullPath.replace(/'/g, "\\'")}')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                                Copier le chemin
                            </button>
                            <button class="btn btn-ghost" onclick="openInFinder('${fullPath.replace(/'/g, "\\'")}')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
                                Ouvrir dans Finder
                            </button>
                        </div>
                        <p style="font-size: 0.75rem; color: var(--text-dim); margin-top: 1rem;">
                            Astuce: Lance un serveur local pour eviter ce probleme:<br>
                            <code style="background: var(--bg); padding: 0.25rem 0.5rem; border-radius: 4px;">cd PACIFIK'AI && python3 -m http.server 8080</code>
                        </p>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function copyAssetPath(path) {
            const textarea = document.getElementById('asset-path-textarea');
            if (textarea) {
                textarea.select();
                try {
                    document.execCommand('copy');
                    showToast('Chemin copie!');
                } catch (err) {
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(path).then(() => showToast('Chemin copie!'));
                    }
                }
            }
        }

        function openInFinder(path) {
            // Commande pour ouvrir dans Finder
            const folderPath = path.substring(0, path.lastIndexOf('/'));
            showToast('Ouvre le Finder a: ' + folderPath.split('/').pop());
            // On ne peut pas vraiment ouvrir Finder depuis le navigateur
            // Mais on peut copier la commande
            const cmd = `open "${folderPath}"`;
            if (navigator.clipboard) {
                navigator.clipboard.writeText(cmd).then(() => {
                    showToast('Commande copiee: ' + cmd);
                });
            }
        }

        function openProspectFolder() {
            const prospect = prospects.find(p => p.id === currentProspectId);
            if (!prospect) return;
            const assets = getProspectAssets(prospect.company);
            if (assets) {
                // Show toast with folder path
                showToast(`Dossier: PACIFIK'AI/${assets.folder}/`);
            }
        }

        // ============================================
        // FICHE IA (Recherche Claude Opus)
        // ============================================

        function checkFicheIA(prospect) {
            // Cherche si FICHE_RECHERCHE.md existe dans les assets
            const assets = getProspectAssets(prospect.company);
            if (!assets || !assets.files) return null;

            const ficheFile = assets.files.find(f =>
                f.name.toLowerCase().includes('fiche_recherche') ||
                f.name.toLowerCase().includes('fiche-recherche') ||
                f.name.toLowerCase() === 'fiche_recherche.md'
            );

            return ficheFile || null;
        }

        function updateFicheIASection(prospect) {
            const ficheExists = checkFicheIA(prospect);
            const emptyDiv = document.getElementById('fiche-ia-empty');
            const availableDiv = document.getElementById('fiche-ia-available');
            const badge = document.getElementById('fiche-ia-badge');
            const metaDiv = document.getElementById('fiche-ia-meta');

            if (ficheExists) {
                emptyDiv.style.display = 'none';
                availableDiv.style.display = 'flex';
                badge.textContent = 'Disponible';
                badge.classList.add('available');
                metaDiv.textContent = ficheExists.date ? `Generee le ${ficheExists.date}` : 'Fiche de recherche IA';
            } else {
                emptyDiv.style.display = 'block';
                availableDiv.style.display = 'none';
                badge.textContent = 'Non generee';
                badge.classList.remove('available');
            }
        }

        // Webhook pour gnration de fiche
        const N8N_FICHE_GENERATION_WEBHOOK = 'https://n8n.srv1140766.hstgr.cloud/webhook/deep-research';

        async function generateFicheIA() {
            const prospect = prospects.find(p => p.id === currentProspectId);
            if (!prospect) {
                showToast('Aucun prospect selectionne');
                return;
            }

            // Dsactiver le bouton et montrer le loading
            const btn = document.querySelector('.fiche-ia-generate');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = `
                    <div class="loading-spinner-small"></div>
                    Generation en cours...
                `;
            }

            // Notification discrte
            showToast(`Generation fiche pour ${prospect.company}...`);
            console.log('[Fiche IA] Lancement generation pour:', prospect.company);

            try {
                const response = await fetch(N8N_FICHE_GENERATION_WEBHOOK, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        company: prospect.company,
                        sector: prospect.sector || 'Business',
                        airtableId: prospect.airtableId || prospect.id
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                console.log('[Fiche IA] Reponse recue:', data);

                if (data.success && data.markdown) {
                    // Stocker la fiche gnre
                    lastGeneratedFiche = {
                        company: prospect.company,
                        markdown: data.markdown,
                        filename: data.filename || 'FICHE_RECHERCHE.md',
                        generatedAt: data.generatedAt
                    };

                    // Stocker dans localStorage pour persistence
                    const ficheKey = `fiche_${prospect.company.replace(/[^a-zA-Z0-9]/g, '_')}`;
                    localStorage.setItem(ficheKey, JSON.stringify(lastGeneratedFiche));

                    // Ajouter aux assets du prospect
                    addFicheToAssets(prospect.company, data);

                    // Mettre  jour la section Fiche IA
                    updateFicheIASection(prospect);

                    // Notification succs
                    showSuccessNotification(`Fiche generee pour ${prospect.company}`, 'Ajoutee dans les assets');
                } else {
                    throw new Error(data.error || 'Erreur inconnue');
                }

            } catch (error) {
                console.error('[Fiche IA] Erreur:', error);
                showToast('Erreur: ' + error.message);

                // Remettre le bouton
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
                            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                        </svg>
                        Generer la fiche
                    `;
                }
            }
        }

        // Notification succs en haut  droite
        function showSuccessNotification(title, subtitle) {
            const notif = document.createElement('div');
            notif.className = 'success-notification';
            notif.innerHTML = `
                <div class="success-notification-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                </div>
                <div class="success-notification-content">
                    <div class="success-notification-title">${title}</div>
                    <div class="success-notification-subtitle">${subtitle}</div>
                </div>
            `;
            document.body.appendChild(notif);

            // Animation entre
            setTimeout(() => notif.classList.add('show'), 10);

            // Disparition aprs 4s
            setTimeout(() => {
                notif.classList.remove('show');
                setTimeout(() => notif.remove(), 300);
            }, 4000);
        }

        function openFicheIA() {
            const prospect = prospects.find(p => p.id === currentProspectId);
            if (!prospect) return;

            const fiche = checkFicheIA(prospect);
            if (fiche) {
                const assets = getProspectAssets(prospect.company);
                openAsset(assets.folder, fiche.name);
            } else {
                showToast('Fiche non trouvee');
            }
        }

        function regenerateFicheIA() {
            if (confirm('Regenerer la fiche va ecraser la version actuelle. Continuer?')) {
                generateFicheIA();
            }
        }

        // ============================================
        // PROSPECT EDIT MODE
        // ============================================

        function toggleEditMode() {
            const prospect = prospects.find(p => p.id === currentProspectId);
            if (!prospect) return;

            const displayDiv = document.getElementById('prospect-info-display');
            const formDiv = document.getElementById('prospect-edit-form');
            const toggleBtn = document.getElementById('edit-toggle-btn');

            if (formDiv.style.display === 'none') {
                // Switch to edit mode
                displayDiv.style.display = 'none';
                formDiv.style.display = 'block';
                toggleBtn.classList.add('active');
                toggleBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg> Annuler';

                // Pre-fill form with existing data
                document.getElementById('edit-contact').value = prospect.contact || prospect.name || '';
                document.getElementById('edit-email').value = prospect.email || '';
                document.getElementById('edit-phone').value = prospect.phone || '';
                document.getElementById('edit-poste').value = prospect.poste || '';

                // Focus first field
                document.getElementById('edit-contact').focus();
            } else {
                cancelEditMode();
            }
        }

        function cancelEditMode() {
            document.getElementById('prospect-info-display').style.display = '';
            document.getElementById('prospect-edit-form').style.display = 'none';
            document.getElementById('edit-toggle-btn').classList.remove('active');
            document.getElementById('edit-toggle-btn').innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> Modifier';
        }

        async function saveProspectEdits() {
            const prospect = prospects.find(p => p.id === currentProspectId);
            if (!prospect) return;

            // Get values from form
            const contact = document.getElementById('edit-contact').value.trim();
            const email = document.getElementById('edit-email').value.trim();
            const phone = document.getElementById('edit-phone').value.trim();
            const poste = document.getElementById('edit-poste').value.trim();

            // Check if anything changed
            const changes = {};
            if (contact && contact !== (prospect.contact || prospect.name || '')) {
                prospect.contact = contact;
                changes['Contact'] = contact;
            }
            if (email && email !== (prospect.email || '')) {
                prospect.email = email;
                changes['Email'] = email;
            }
            if (phone && phone !== (prospect.phone || '')) {
                prospect.phone = phone;
                changes['Tlphone'] = phone;
            }
            if (poste && poste !== (prospect.poste || '')) {
                prospect.poste = poste;
                changes['Poste'] = poste;
            }

            if (Object.keys(changes).length === 0) {
                showToast('Aucune modification');
                cancelEditMode();
                return;
            }

            // Update display
            document.getElementById('modal-contact').textContent = prospect.contact || prospect.name || 'Non renseigne';
            document.getElementById('modal-email').textContent = prospect.email || 'Non renseigne';
            document.getElementById('modal-phone').textContent = prospect.phone || 'Non renseigne';
            document.getElementById('modal-poste').textContent = prospect.poste || 'Non renseigne';

            // Save locally
            save();

            // Sync to Airtable
            try {
                await updateProspectInAirtable(prospect, changes);
                showToast('Infos contact mises a jour');

                // Add to activity timeline
                addActivityToProspect(prospect.id, 'update', 'Infos contact modifiees: ' + Object.keys(changes).join(', '));
                document.getElementById('modal-timeline').innerHTML = renderProspectTimeline(prospect.id);
            } catch (error) {
                console.error('Erreur sync Airtable:', error);
                showToast('Sauvegarde locale OK, sync Airtable echouee');
            }

            cancelEditMode();
        }

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeProspectModal();
            }
        });

        // ============================================
        // PIPELINE STATUS VIEW (with Drag & Drop)
        // ============================================

        function renderPipelineStatus() {
            const stages = [
                { key: 'lead', label: 'Lead' },
                { key: 'contacted', label: 'Contacte' },
                { key: 'meeting', label: 'RDV/Audit' },
                { key: 'proposal', label: 'Proposition' },
                { key: 'won', label: 'Gagne' }
            ];

            const filtered = getFilteredProspects();
            const board = document.getElementById('pipeline-status-board');

            board.innerHTML = stages.map(s => {
                const items = filtered.filter(p => p.status === s.key);
                const total = items.reduce((sum, p) => sum + (p.value || 0), 0);
                return `
                    <div class="pipeline-col" data-status="${s.key}"
                         ondragover="handleDragOver(event)"
                         ondragleave="handleDragLeave(event)"
                         ondrop="handleStatusDrop(event, '${s.key}')">
                        <div class="pipeline-header">
                            <span class="pipeline-title">${s.label}</span>
                            <span class="pipeline-count">${items.length}  ${fmtXPF(total)}</span>
                        </div>
                        ${items.map(p => {
                    const hasAssets = p.assets && p.assets.length > 0;
                    return `
                            <div class="pipeline-card ${hasAssets ? 'has-assets' : ''}"
                                 draggable="true"
                                 data-id="${p.id}"
                                 ondragstart="handleDragStart(event, ${p.id})"
                                 ondragend="handleDragEnd(event)"
                                 onclick="openProspectDetail(${p.id})"
                                 style="cursor: pointer;">
                                <div class="pipeline-card-name">${p.company}${renderAssetIcons(p.assets, true)}</div>
                                <div class="pipeline-card-company">${p.sector}</div>
                                <div class="pipeline-card-footer">
                                    <span class="pipeline-card-value">${fmtXPF(p.value)}</span>
                                    ${p.priority ? `<span class="pipeline-card-priority ${p.priority}">${priorityLabel(p.priority)}</span>` : ''}
                                </div>
                            </div>
                        `;
                }).join('')}
                    </div>
                `;
            }).join('');
        }
        // ============================================
        // AIRTABLE SYNC
        // ============================================

        async function syncFromAirtable() {
            const btn = document.getElementById('sync-btn');
            const syncDot = document.querySelector('.sync-dot');
            const syncText = document.getElementById('sync-text');

            btn.disabled = true;
            btn.innerHTML = '<svg class="spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg> Sync...';
            syncDot.classList.add('syncing');
            syncText.textContent = 'Synchronisation...';

            try {
                const response = await fetch(
                    `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.tableId}?maxRecords=100`,
                    {
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                            'Content-Type': 'application/json'
                        }
                    }
                );

                if (!response.ok) throw new Error('Erreur Airtable');

                const data = await response.json();
                const statusMap = { 'Lead': 'lead', 'Contacte': 'contacted', 'RDV/Audit': 'meeting', 'Proposition': 'proposal', 'Gagne': 'won', 'Perdu': 'lost' };
                const priorityMap = { ' Hot': 'hot', 'Hot': 'hot', 'Chaud': 'chaud', 'Tide': 'tiede', 'Tiede': 'tiede', 'Froid': 'froid' };

                // Threshold: preserve local priority if updated within last 10 minutes
                const RECENT_UPDATE_THRESHOLD = 10 * 60 * 1000;
                const now = Date.now();

                // Merge with existing data (keep local assets, notes, and recent priority changes)
                const newProspects = data.records.map((r, idx) => {
                    const f = r.fields;
                    const existing = prospects.find(p => p.company === f['Entreprise']);

                    // Check if priority was recently updated locally
                    const priorityRecentlyUpdated = existing?.priorityUpdatedAt &&
                        (now - existing.priorityUpdatedAt) < RECENT_UPDATE_THRESHOLD;

                    // Use local priority if recently updated, otherwise use Airtable value
                    const finalPriority = priorityRecentlyUpdated
                        ? existing.priority
                        : (priorityMap[f['Priorit']] || priorityMap[f['Priorite']] || 'tiede');

                    return {
                        id: existing?.id || idx + 1,
                        airtableId: r.id,
                        name: f['Contact'] || '',
                        contact: f['Contact'] || existing?.contact || '',
                        company: f['Entreprise'] || 'Sans nom',
                        sector: f['Secteur'] || 'Autre',
                        status: statusMap[f['Status']] || 'lead',
                        value: f['Valeur'] || 0,
                        date: f['Date'] || new Date().toISOString().split('T')[0],
                        priority: finalPriority,
                        priorityUpdatedAt: existing?.priorityUpdatedAt || null,
                        assets: existing?.assets || [],
                        email: f['Email'] || existing?.email || '',
                        phone: f['Tlphone'] || f['Telephone'] || existing?.phone || '',
                        poste: f['Poste'] || existing?.poste || ''
                    };
                });

                prospects = newProspects;
                lastSync = new Date();
                save();
                render();

                syncDot.classList.remove('syncing');
                syncText.textContent = 'Sync ' + lastSync.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                showToast(`${prospects.length} prospects synchronises`);

            } catch (error) {
                console.error('Sync error:', error);
                syncDot.classList.remove('syncing');
                syncDot.classList.add('error');
                syncText.textContent = 'Erreur sync';
                showToast('Erreur de synchronisation');
                setTimeout(() => syncDot.classList.remove('error'), 3000);
            }

            btn.disabled = false;
            btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg> Sync Airtable';
        }

        async function updateProspectInAirtable(prospect, extraFields = {}) {
            if (!prospect.airtableId) return;

            const statusMap = {
                'lead': 'Prospect',
                'contacted': 'Contact',
                'meeting': 'RDV planifi',
                'proposal': 'Proposition envoye',
                'won': 'Gagn',
                'lost': 'Perdu'
            };
            const priorityMap = {
                'hot': ' Hot',
                'chaud': 'Chaud',
                'tiede': 'Tide',
                'froid': 'Froid'
            };

            // Build fields object
            const fields = {
                'Status': statusMap[prospect.status] || prospect.status,
                'Priorit': priorityMap[prospect.priority] || prospect.priority
            };

            // Add any extra fields (Email, Contact, Tlphone, Poste)
            Object.assign(fields, extraFields);

            try {
                const response = await fetch(
                    `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.tableId}/${prospect.airtableId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ fields })
                    }
                );
                if (!response.ok) {
                    console.error('Airtable update failed:', await response.text());
                }
            } catch (error) {
                console.error('Update error:', error);
            }
        }

        function updateSyncStatus() {
            const syncText = document.getElementById('sync-text');
            if (lastSync) {
                const ago = Math.floor((Date.now() - lastSync.getTime()) / 60000);
                if (ago < 1) syncText.textContent = 'Sync a l\'instant';
                else if (ago < 60) syncText.textContent = `Sync il y a ${ago}min`;
                else syncText.textContent = 'Sync ' + lastSync.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            }
        }

        // ============================================
        // FOLLOW-UPS / REMINDERS
        // ============================================

        function renderFollowups() {
            const today = new Date().toISOString().split('T')[0];
            const todayFollowups = followups.filter(f => !f.done && f.date <= today);

            const widget = document.getElementById('followups-widget');
            const list = document.getElementById('followups-list');
            const count = document.getElementById('followups-count');

            if (todayFollowups.length === 0) {
                widget.style.display = 'none';
                return;
            }

            widget.style.display = 'block';
            count.textContent = todayFollowups.length;

            list.innerHTML = todayFollowups.map(f => {
                const prospect = prospects.find(p => p.id === f.prospectId);
                if (!prospect) return '';
                const isOverdue = f.date < today;
                return `
                    <div class="followup-item" onclick="openProspectDetail(${f.prospectId})">
                        <div class="followup-item-info">
                            <div class="followup-item-company">${prospect.company}</div>
                            <div class="followup-item-note">${f.note || 'Relancer ce prospect'}</div>
                        </div>
                        <span class="followup-badge ${isOverdue ? 'overdue' : 'today'}">${isOverdue ? 'En retard' : 'Aujourd\'hui'}</span>
                        <div class="followup-item-actions">
                            <button class="followup-action done" onclick="event.stopPropagation(); markFollowupDone(${f.id})" title="Marquer comme fait">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                            </button>
                            <button class="followup-action" onclick="event.stopPropagation(); postponeFollowup(${f.id})" title="Reporter a demain">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showAddReminder() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('reminder-date').value = tomorrow.toISOString().split('T')[0];
            document.getElementById('reminder-note').value = '';
            document.getElementById('reminder-modal').classList.add('show');
        }

        function closeReminderModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('reminder-modal').classList.remove('show');
        }

        function saveReminder() {
            const date = document.getElementById('reminder-date').value;
            const note = document.getElementById('reminder-note').value;

            if (!date || !currentProspectId) return;

            followups.push({
                id: Date.now(),
                prospectId: currentProspectId,
                date: date,
                note: note,
                done: false
            });

            save();
            renderFollowups();
            closeReminderModal();

            const prospect = prospects.find(p => p.id === currentProspectId);
            showToast(`Rappel ajoute pour ${prospect?.company}`);
        }

        function markFollowupDone(id) {
            const f = followups.find(x => x.id === id);
            if (f) {
                f.done = true;
                save();
                renderFollowups();
                showToast('Rappel termine');
            }
        }

        function postponeFollowup(id) {
            const f = followups.find(x => x.id === id);
            if (f) {
                const newDate = new Date(f.date);
                newDate.setDate(newDate.getDate() + 1);
                f.date = newDate.toISOString().split('T')[0];
                save();
                renderFollowups();
                showToast('Reporte a demain');
            }
        }

        // ============================================
        // NOTES SYSTEM
        // ============================================

        function renderNotes(prospectId) {
            const prospectNotes = notes[prospectId] || [];
            const list = document.getElementById('modal-notes-list');

            if (prospectNotes.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: var(--text-dim); font-size: 0.75rem; padding: 1rem;">Aucune note</div>';
                return;
            }

            list.innerHTML = prospectNotes.sort((a, b) => new Date(b.date) - new Date(a.date)).map(n => `
                <div class="note-item">
                    <div class="note-item-header">
                        <span class="note-item-date">${new Date(n.date).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' })}</span>
                        <button class="note-item-delete" onclick="deleteNote(${currentProspectId}, ${n.id})">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                        </button>
                    </div>
                    <div class="note-item-text">${n.text}</div>
                </div>
            `).join('');
        }

        function addNote() {
            const input = document.getElementById('modal-note-input');
            const text = input.value.trim();

            if (!text || !currentProspectId) return;

            if (!notes[currentProspectId]) notes[currentProspectId] = [];

            notes[currentProspectId].push({
                id: Date.now(),
                text: text,
                date: new Date().toISOString()
            });

            // Add to activity timeline
            addActivityToProspect(currentProspectId, 'note', `Note ajoutee: "${text.substring(0, 50)}${text.length > 50 ? '...' : ''}"`);

            save();
            renderNotes(currentProspectId);
            document.getElementById('modal-timeline').innerHTML = renderProspectTimeline(currentProspectId);
            input.value = '';
            showToast('Note ajoutee');
        }

        function deleteNote(prospectId, noteId) {
            if (!notes[prospectId]) return;
            notes[prospectId] = notes[prospectId].filter(n => n.id !== noteId);
            save();
            renderNotes(prospectId);
        }

        // ============================================
        // QUICK ACTIONS
        // ============================================

        function sendEmail() {
            const prospect = prospects.find(p => p.id === currentProspectId);
            if (!prospect) return;
            const email = prospect.email || '';
            const subject = encodeURIComponent(`PACIFIK'AI - ${prospect.company}`);
            window.open(`mailto:${email}?subject=${subject}`, '_blank');
        }

        function openWhatsApp() {
            const prospect = prospects.find(p => p.id === currentProspectId);
            if (!prospect) return;
            const phone = prospect.phone?.replace(/\s/g, '') || '';
            const message = encodeURIComponent(`Bonjour, je vous contacte de la part de PACIFIK'AI concernant ${prospect.company}.`);
            if (phone) {
                window.open(`https://wa.me/${phone}?text=${message}`, '_blank');
            } else {
                showToast('Pas de numero de telephone');
            }
        }

        // ============================================
        // ANALYTICS CHARTS
        // ============================================

        function renderCharts() {
            renderTempChart();
            renderFunnelChart();
        }

        function renderTempChart() {
            const temps = ['hot', 'chaud', 'tiede', 'froid'];
            const data = temps.map(t => prospects.filter(p => p.priority === t).length);
            const max = Math.max(...data, 1);

            const chart = document.getElementById('chart-temp');
            chart.innerHTML = temps.map((t, i) => {
                const height = (data[i] / max) * 80;
                const labels = { hot: 'Hot', chaud: 'Chaud', tiede: 'Tiede', froid: 'Froid' };
                return `
                    <div class="bar-item">
                        <div class="bar ${t}" style="height: ${height}px;"></div>
                        <span class="bar-label">${labels[t]}</span>
                        <span style="font-size: 0.6875rem; font-weight: 600;">${data[i]}</span>
                    </div>
                `;
            }).join('');
        }

        function renderFunnelChart() {
            const stages = [
                { key: 'lead', label: 'Leads', color: 'var(--accent)' },
                { key: 'contacted', label: 'Contactes', color: 'var(--yellow)' },
                { key: 'meeting', label: 'RDV', color: 'var(--purple)' },
                { key: 'proposal', label: 'Proposition', color: 'var(--orange)' },
                { key: 'won', label: 'Gagnes', color: 'var(--green)' }
            ];

            const data = stages.map(s => prospects.filter(p => p.status === s.key).length);
            const total = prospects.length || 1;

            const funnel = document.getElementById('chart-funnel');
            funnel.innerHTML = stages.map((s, i) => {
                const pct = (data[i] / total) * 100;
                return `
                    <div class="funnel-stage">
                        <span class="funnel-label">${s.label}</span>
                        <div class="funnel-bar-wrap">
                            <div class="funnel-bar" style="width: ${pct}%; background: ${s.color};">${data[i]}</div>
                        </div>
                        <span class="funnel-count">${Math.round(pct)}%</span>
                    </div>
                `;
            }).join('');
        }

        // Update render function
        const originalRender = render;
        render = function() {
            originalRender();
            renderFollowups();
            renderCharts();
            updateSyncStatus();
        };

        // Update openProspectDetail to include notes
        const originalOpenProspectDetail = openProspectDetail;
        openProspectDetail = function(id) {
            originalOpenProspectDetail(id);
            renderNotes(id);
        };

        // ============================================
        // AI CHATBOT
        // ============================================

        function toggleChatbot() {
            isChatbotOpen = !isChatbotOpen;
            document.getElementById('chatbot-panel').classList.toggle('open', isChatbotOpen);
            if (isChatbotOpen) {
                document.getElementById('chatbot-input').focus();
            }
        }

        function handleChatKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendUserMessage();
            }
        }

        function sendChatMessage(text) {
            document.getElementById('chatbot-input').value = text;
            sendUserMessage();
        }

        async function sendUserMessage() {
            const input = document.getElementById('chatbot-input');
            const message = input.value.trim();
            if (!message) return;

            input.value = '';
            addChatMessage('user', message);
            chatHistory.push({ role: 'user', content: message });

            // Show typing indicator
            showTypingIndicator();

            // Process with local AI (no API needed for basic commands)
            const response = await processMessage(message);

            hideTypingIndicator();
            addChatMessage('assistant', response.text, response.data);
            chatHistory.push({ role: 'assistant', content: response.text });
        }

        function addChatMessage(role, text, data = null) {
            const container = document.getElementById('chatbot-messages');
            const msg = document.createElement('div');
            msg.className = `chat-message ${role}`;

            const avatar = role === 'user'
                ? '<div class="chat-avatar">JB</div>'
                : `<div class="chat-avatar"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1"/></svg></div>`;

            let dataHtml = '';
            if (data) {
                if (data.type === 'stats') {
                    dataHtml = renderStatsCard(data);
                } else if (data.type === 'prospects') {
                    dataHtml = renderProspectsList(data.prospects);
                } else if (data.type === 'prospect') {
                    dataHtml = renderProspectCard(data.prospect);
                } else if (data.type === 'followups') {
                    dataHtml = renderFollowupsList(data.followups);
                }
            }

            msg.innerHTML = `
                ${avatar}
                <div class="chat-bubble">
                    ${formatChatText(text)}
                    ${dataHtml}
                </div>
            `;

            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
        }

        function formatChatText(text) {
            return text
                .split('\n')
                .map(line => `<p>${line}</p>`)
                .join('')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/`(.*?)`/g, '<code>$1</code>');
        }

        function showTypingIndicator() {
            const container = document.getElementById('chatbot-messages');
            const typing = document.createElement('div');
            typing.id = 'typing-indicator';
            typing.className = 'chat-message assistant';
            typing.innerHTML = `
                <div class="chat-avatar"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1"/></svg></div>
                <div class="typing-indicator">
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                </div>
            `;
            container.appendChild(typing);
            container.scrollTop = container.scrollHeight;
        }

        function hideTypingIndicator() {
            const typing = document.getElementById('typing-indicator');
            if (typing) typing.remove();
        }

        // ============================================
        // NATURAL LANGUAGE UPDATE DETECTION
        // ============================================

        function detectAndApplyNaturalUpdate(message) {
            const msg = message.toLowerCase();

            // Step 1: Find if a company is mentioned
            let detectedCompany = null;
            for (const p of prospects) {
                const companyLower = p.company.toLowerCase();
                // Check full name
                if (msg.includes(companyLower)) {
                    detectedCompany = p;
                    break;
                }
                // Check significant words (3+ chars)
                const words = companyLower.split(/[\s\-]+/).filter(w => w.length >= 3);
                for (const word of words) {
                    if (msg.includes(word) && word !== 'the' && word !== 'les' && word !== 'des') {
                        detectedCompany = p;
                        break;
                    }
                }
                if (detectedCompany) break;
            }

            // No company mentioned = not an update
            if (!detectedCompany) return null;

            // Step 2: Detect interaction type (status change)
            const interactionPatterns = {
                'contacted': [
                    'appele', 'appel', 'appel', 'telephone', 'tlphone',
                    'contacte', 'contact', 'parle', 'parl', 'discute', 'discut',
                    'envoye mail', 'envoy mail', 'envoye email', 'envoy email',
                    'ecrit', 'crit', 'message', 'ai contacte', 'ai contact',
                    'ai appele', 'ai appel', 'ai parle', 'ai parl'
                ],
                'meeting': [
                    'rdv', 'rendez-vous', 'rendezvous', 'rencontre', 'rencontr',
                    'vu', 'meeting', 'reunion', 'runion', 'audit', 'visite',
                    'ai rencontre', 'ai rencontr', 'ai vu'
                ],
                'proposal': [
                    'proposition', 'devis', 'offre envoy', 'envoye proposition',
                    'envoy proposition', 'presente offre', 'prsent offre',
                    'ai envoye', 'ai envoy'
                ],
                'won': [
                    'signe', 'sign', 'accepte', 'accept', 'valide', 'valid',
                    'ok pour', 'dit oui', 'accord', 'd\'accord', 'client', 'gagne', 'gagn',
                    'a signe', 'a sign', 'ont signe', 'ont sign'
                ]
            };

            // Step 3: Detect interest level (priority change)
            const interestPatterns = {
                'hot': [
                    'tres interesse', 'trs intress', 'super interesse', 'super intress',
                    'vraiment interesse', 'vraiment intress', 'hyper interesse',
                    'chaud bouillant', 'pret a signer', 'prt  signer', 'urgent',
                    'veut commencer', 'veut demarrer', 'impatient', 'tres chaud', 'trs chaud',
                    'super chaud', 'hyper chaud'
                ],
                'chaud': [
                    'interesse', 'intress', 'positif', 'receptif', 'rceptif',
                    'bonne discussion', 'bien passe', 'bien pass', 'enthousiaste',
                    'veut en savoir plus', 'curieux', 'ouvert',
                    'sont chauds', 'est chaud', 'ils sont chaud', 'il est chaud', 'elle est chaud'
                ],
                'tiede': [
                    'peut-etre', 'peut-tre', 'hesitant', 'hsitant', 'reflechit', 'rflchit',
                    'pas sur', 'pas sr', 'mitige', 'mitig', 'a voir', ' voir',
                    'sont tiede', 'est tiede', 'sont tides', 'est tide'
                ],
                'froid': [
                    'pas interesse', 'pas intress', 'refuse', 'refus', 'non merci',
                    'pas le moment', 'plus tard', 'pas pour nous', 'budget',
                    'sont froids', 'est froid'
                ]
            };

            let newStatus = null;
            let newPriority = null;

            // Detect status
            for (const [status, patterns] of Object.entries(interactionPatterns)) {
                for (const pattern of patterns) {
                    if (msg.includes(pattern)) {
                        newStatus = status;
                        break;
                    }
                }
                if (newStatus) break;
            }

            // Detect priority
            for (const [priority, patterns] of Object.entries(interestPatterns)) {
                for (const pattern of patterns) {
                    if (msg.includes(pattern)) {
                        newPriority = priority;
                        break;
                    }
                }
                if (newPriority) break;
            }

            // Step 4: Extract structured data (email, contact name, phone)
            const extractedData = {};

            // Extract email
            const emailMatch = message.match(/[\w.-]+@[\w.-]+\.\w+/i);
            if (emailMatch) {
                extractedData.email = emailMatch[0].toLowerCase();
            }

            // Extract phone (various formats)
            const phoneMatch = message.match(/(?:\+689\s?)?(?:87|89|40)\s?\d{2}\s?\d{2}\s?\d{2}|\d{2}[\s.-]?\d{2}[\s.-]?\d{2}[\s.-]?\d{2}/);
            if (phoneMatch) {
                extractedData.phone = phoneMatch[0].replace(/[\s.-]/g, ' ').trim();
            }

            // Extract contact name patterns
            const contactPatterns = [
                /contact(?:e|)?(?:\s+(?:est|c'est|:))?\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+)?)/i,
                /(?:parle|parl|discute|discut)\s+(?:avec|a)\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+)?)/i,
                /(?:son|leur)\s+(?:nom|contact)\s+(?:est|c'est|:)\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+)?)/i,
                /(?:il|elle)\s+s'appelle\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+)?)/i,
                /([A-Z][a-z]+(?:\s+[A-Z][a-z]+)?)\s+(?:est le|est la)\s+(?:contact|responsable|directeur|manager)/i
            ];
            for (const pattern of contactPatterns) {
                const match = message.match(pattern);
                if (match && match[1]) {
                    extractedData.contact = match[1].trim();
                    break;
                }
            }

            // Extract job title/position
            const postePatterns = [
                /(?:son|leur)\s+poste\s+(?:est|c'est|:)\s+([^,.]+)/i,
                /(?:il|elle)\s+est\s+(directeur|manager|responsable|chef|CEO|DG|PDG|grant|commercial)[^,.]*(?:de|du|des)?[^,.]*/i,
                /(directeur|manager|responsable|chef|CEO|DG|PDG|grant|commercial)\s+(?:de|du|des)?\s*([^,.]+)/i
            ];
            for (const pattern of postePatterns) {
                const match = message.match(pattern);
                if (match) {
                    extractedData.poste = match[0].replace(/(?:son|leur)\s+poste\s+(?:est|c'est|:)\s+/i, '').trim();
                    break;
                }
            }

            // If nothing detected (no status, no priority, no data), not an update message
            if (!newStatus && !newPriority && Object.keys(extractedData).length === 0) return null;

            // Step 5: Apply changes
            const actions = [];
            const oldStatus = detectedCompany.status;
            const oldPriority = detectedCompany.priority;
            const airtableUpdates = {};

            if (newStatus && newStatus !== oldStatus) {
                detectedCompany.status = newStatus;
                actions.push(`Status: ${statusLabel(oldStatus)}  ${statusLabel(newStatus)}`);
            }

            if (newPriority && newPriority !== oldPriority) {
                detectedCompany.priority = newPriority;
                actions.push(`Temperature: ${priorityLabel(oldPriority)}  ${priorityLabel(newPriority)}`);
            }

            // Apply extracted data
            if (extractedData.email) {
                detectedCompany.email = extractedData.email;
                airtableUpdates['Email'] = extractedData.email;
                actions.push(`Email: ${extractedData.email}`);
            }
            if (extractedData.phone) {
                detectedCompany.phone = extractedData.phone;
                airtableUpdates['Tlphone'] = extractedData.phone;
                actions.push(`Tel: ${extractedData.phone}`);
            }
            if (extractedData.contact) {
                detectedCompany.contact = extractedData.contact;
                airtableUpdates['Contact'] = extractedData.contact;
                actions.push(`Contact: ${extractedData.contact}`);
            }
            if (extractedData.poste) {
                detectedCompany.poste = extractedData.poste;
                airtableUpdates['Poste'] = extractedData.poste;
                actions.push(`Poste: ${extractedData.poste}`);
            }

            // Step 6: Generate synthesized note (not raw message)
            if (actions.length > 0) {
                // Build a synthesized note
                const today = new Date().toLocaleDateString('fr-FR');
                const synthesizedNote = synthesizeNote(message, newStatus, newPriority, extractedData);

                if (synthesizedNote) {
                    if (!notes[detectedCompany.id]) notes[detectedCompany.id] = [];
                    notes[detectedCompany.id].unshift({
                        id: Date.now(),
                        text: synthesizedNote,
                        date: new Date().toISOString()
                    });
                    localStorage.setItem('pk_notes', JSON.stringify(notes));
                    actions.push('Note synthetisee');
                }

                // Add to activity timeline
                addActivityToProspect(detectedCompany.id, 'update', actions.filter(a => !a.includes('Note')).join(', '));

                // Save and sync
                save();
                renderProspectsViews();
                updateProspectInAirtable(detectedCompany, airtableUpdates);

                // Add notification
                addNotification({
                    type: 'status',
                    title: `${detectedCompany.company} mis a jour`,
                    desc: actions.filter(a => !a.includes('Note')).join(' | '),
                    prospectId: detectedCompany.id
                });
            }

            // Return response
            if (actions.length > 0) {
                return {
                    text: `Compris! J'ai mis a jour **${detectedCompany.company}**:\n\n${actions.map(a => ' ' + a).join('\n')}`,
                    data: { type: 'prospect', prospect: detectedCompany }
                };
            }

            return null;
        }

        // Synthesize a clean note from the raw message
        function synthesizeNote(message, newStatus, newPriority, extractedData) {
            const today = new Date().toLocaleDateString('fr-FR');
            let noteParts = [];

            // Determine the action type
            if (newStatus === 'contacted') {
                noteParts.push('Premier contact etabli');
            } else if (newStatus === 'meeting') {
                noteParts.push('RDV effectue');
            } else if (newStatus === 'proposal') {
                noteParts.push('Proposition envoyee');
            } else if (newStatus === 'won') {
                noteParts.push('Client gagne!');
            }

            // Add sentiment
            if (newPriority === 'hot') {
                noteParts.push('Tres interesse, a closer rapidement');
            } else if (newPriority === 'chaud') {
                noteParts.push('Bonne reception, interesse');
            } else if (newPriority === 'tiede') {
                noteParts.push('A relancer, hesitant');
            } else if (newPriority === 'froid') {
                noteParts.push('Pas interesse pour le moment');
            }

            // Extract any additional context (remove extracted data from message)
            let contextMsg = message;
            if (extractedData.email) contextMsg = contextMsg.replace(extractedData.email, '');
            if (extractedData.phone) contextMsg = contextMsg.replace(extractedData.phone, '');
            if (extractedData.contact) contextMsg = contextMsg.replace(new RegExp(extractedData.contact, 'gi'), '');

            // Look for specific context clues
            const contextPatterns = [
                { pattern: /rappel(?:er|le)?\s+(.+?)(?:\.|$)/i, prefix: 'A rappeler: ' },
                { pattern: /besoin\s+(?:de|d')?\s*(.+?)(?:\.|$)/i, prefix: 'Besoin: ' },
                { pattern: /interesse\s+par\s+(.+?)(?:\.|$)/i, prefix: 'Interesse par: ' },
                { pattern: /prochain(?:e)?\s+(?:etape|action|rdv)\s*[:\s]+(.+?)(?:\.|$)/i, prefix: 'Prochaine etape: ' }
            ];

            for (const { pattern, prefix } of contextPatterns) {
                const match = message.match(pattern);
                if (match && match[1]) {
                    noteParts.push(prefix + match[1].trim());
                }
            }

            // If no parts were generated, don't create a note
            if (noteParts.length === 0) return null;

            return `[${today}] ` + noteParts.join('. ') + '.';
        }

        // ============================================
        // AI MESSAGE PROCESSING (Local Intelligence)
        // ============================================

        async function processMessage(message) {
            const msg = message.toLowerCase();

            // ============================================
            // PRIORITY 1: NATURAL LANGUAGE UPDATE DETECTION
            // Check if user is reporting an interaction with a prospect
            // ============================================
            const naturalUpdateResult = detectAndApplyNaturalUpdate(message);
            if (naturalUpdateResult) {
                return naturalUpdateResult;
            }

            // ============================================
            // PRIORITY 2: EXPLICIT COMMANDS (pattern matching)
            // ============================================

            // STATS & ANALYTICS
            if (msg.includes('stat') || msg.includes('pipeline') || msg.includes('combien') || msg.includes('total')) {
                return getStats();
            }

            // PROSPECTS BY PRIORITY - Only if asking to LIST prospects
            if ((msg.includes('liste') || msg.includes('montre') || msg.includes('quels') || msg.includes('prospects')) &&
                (msg.includes('hot') || msg.includes('chaud') || msg.includes('tiede') || msg.includes('froid'))) {
                const priority = msg.includes('hot') ? 'hot' : msg.includes('chaud') ? 'chaud' : msg.includes('tiede') ? 'tiede' : 'froid';
                return getProspectsByPriority(priority);
            }

            // PROSPECTS BY STATUS - Only if asking to LIST prospects
            if ((msg.includes('liste') || msg.includes('montre') || msg.includes('quels') || msg.includes('prospects')) &&
                (msg.includes('lead') || msg.includes('contacte') || msg.includes('rdv') || msg.includes('proposition') || msg.includes('gagne'))) {
                const status = msg.includes('lead') ? 'lead' : msg.includes('contacte') ? 'contacted' : msg.includes('rdv') ? 'meeting' : msg.includes('proposition') ? 'proposal' : 'won';
                return getProspectsByStatus(status);
            }

            // SEARCH PROSPECT
            if (msg.includes('cherche') || msg.includes('trouve') || msg.includes('recherche') || msg.includes('montre')) {
                const companies = prospects.map(p => p.company.toLowerCase());
                const found = companies.find(c => msg.includes(c.toLowerCase().split(' ')[0]));
                if (found) {
                    const prospect = prospects.find(p => p.company.toLowerCase() === found);
                    return getProspectDetails(prospect);
                }
                // Extract search term
                const words = message.split(' ').filter(w => w.length > 3);
                for (const word of words) {
                    const match = prospects.find(p =>
                        p.company.toLowerCase().includes(word.toLowerCase()) ||
                        p.sector.toLowerCase().includes(word.toLowerCase())
                    );
                    if (match) return getProspectDetails(match);
                }
            }

            // FOLLOWUPS / REMINDERS
            if (msg.includes('rappel') || msg.includes('relance') || msg.includes('follow')) {
                return getFollowups();
            }

            // PROSPECTS WITH ASSETS
            if (msg.includes('asset') || msg.includes('prototype') || msg.includes('demo') || msg.includes('travail')) {
                return getProspectsWithAssets();
            }

            // SECTOR ANALYSIS
            if (msg.includes('secteur') || msg.includes('hotel') || msg.includes('transport') || msg.includes('comptab')) {
                const sector = msg.includes('hotel') ? 'Hotellerie' : msg.includes('transport') ? 'Transport' : msg.includes('comptab') ? 'Comptabilite' : null;
                if (sector) return getProspectsBySector(sector);
                return getSectorAnalysis();
            }

            // TOP PROSPECTS
            if (msg.includes('top') || msg.includes('meilleur') || msg.includes('priorit')) {
                return getTopProspects();
            }

            // ============================================
            // MODIFICATION COMMANDS
            // ============================================

            // CHANGE STATUS: "passe Air Tahiti en contacte" / "Air Tahiti -> rdv"
            const statusChangeMatch = message.match(/(?:passe|met|change|->)\s+(.+?)\s+(?:en|vers|->)\s+(lead|contacte|contacted|rdv|meeting|proposition|proposal|gagne|won)/i);
            if (statusChangeMatch) {
                const [, companySearch, newStatus] = statusChangeMatch;
                return changeProspectStatus(companySearch, newStatus);
            }

            // CHANGE PRIORITY: "Air Tahiti devient hot" / "met Air Tahiti en chaud"
            const priorityChangeMatch = message.match(/(?:met|passe|change)?\s*(.+?)\s+(?:devient|en|vers|->)\s*(hot|chaud|tiede|froid)/i);
            if (priorityChangeMatch && (msg.includes('devient') || msg.includes('temperature') || msg.includes('priorite'))) {
                const [, companySearch, newPriority] = priorityChangeMatch;
                return changeProspectPriority(companySearch, newPriority);
            }

            // ADD NOTE: "note pour Air Tahiti: texte" / "ajoute note Air Tahiti texte"
            const noteMatch = message.match(/(?:note|ajoute note)\s+(?:pour\s+)?(.+?)[\s:]+(.+)/i);
            if (noteMatch && (msg.includes('note pour') || msg.includes('ajoute note'))) {
                const [, companySearch, noteText] = noteMatch;
                return addNoteToProspect(companySearch, noteText);
            }

            // ADD REMINDER: "rappel Air Tahiti dans 3 jours" / "relance Air Tahiti demain"
            const reminderMatch = message.match(/(?:rappel|relance|rappelle)\s+(?:pour\s+)?(.+?)\s+(?:dans|pour|demain|apres-demain|lundi|mardi|mercredi|jeudi|vendredi)/i);
            if (reminderMatch) {
                return addReminderToProspect(message);
            }

            // MARK FOLLOWUP DONE: "rappel fait pour Air Tahiti" / "done rappel Air Tahiti"
            if ((msg.includes('fait') || msg.includes('done') || msg.includes('termine')) && msg.includes('rappel')) {
                const words = message.split(' ').filter(w => w.length > 3);
                for (const word of words) {
                    const match = prospects.find(p => p.company.toLowerCase().includes(word.toLowerCase()));
                    if (match) return markFollowupDoneChat(match.id);
                }
            }

            // DELETE PROSPECT: "supprime prospect Air Tahiti"
            if (msg.includes('supprime') && msg.includes('prospect')) {
                return { text: "Pour des raisons de securite, la suppression de prospects doit etre faite manuellement dans Airtable." };
            }

            // SYNC
            if (msg.includes('sync') || msg.includes('actualise') || msg.includes('rafraichi')) {
                syncFromAirtable();
                return { text: "Je lance la synchronisation avec Airtable..." };
            }

            // HELP
            if (msg.includes('aide') || msg.includes('help') || msg.includes('quoi')) {
                return getHelp();
            }

            // DEFAULT - Use Claude API for natural language understanding
            if (useClaudeAPI) {
                return await callClaudeAPI(message);
            }

            return {
                text: `Je ne suis pas sur de comprendre. Voici ce que je peux faire:\n\n **Stats** - Voir les statistiques du pipeline\n **Prospects hot/chaud/tiede/froid** - Lister par priorite\n **Cherche [nom]** - Trouver un prospect\n **Rappels** - Voir les relances du jour\n **Secteur [nom]** - Analyser un secteur\n **Top prospects** - Les meilleurs opportunites`
            };
        }

        // ============================================
        // CLAUDE API INTEGRATION
        // ============================================

        async function callClaudeAPI(message) {
            try {
                // Build context with current data
                const currentContext = buildContextForClaude();

                console.log('[Claude API] Calling with model:', CLAUDE_CONFIG.model);
                console.log('[Claude API] Message:', message);

                const requestBody = {
                    model: CLAUDE_CONFIG.model,
                    max_tokens: 512,
                    system: CLAUDE_CONFIG.systemPrompt + '\n\n## Donnees Actuelles\n' + currentContext,
                    messages: [
                        ...chatHistory.slice(-6), // Last 3 exchanges for context
                        { role: 'user', content: message }
                    ]
                };

                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': CLAUDE_CONFIG.apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const error = await response.json();
                    console.error('[Claude API] Error response:', response.status, error);
                    // Fall back to local processing instead of showing error
                    return processMessageLocal(message);
                }

                const data = await response.json();
                console.log('[Claude API] Success, tokens used:', data.usage);
                const assistantMessage = data.content[0].text;

                // Check if Claude suggests an action
                const actionResult = parseClaudeAction(assistantMessage, message);
                if (actionResult) {
                    return actionResult;
                }

                return { text: assistantMessage };
            } catch (error) {
                console.error('[Claude API] Call failed:', error);
                // Fall back to local processing
                return processMessageLocal(message);
            }
        }

        // Local fallback processing when Claude API fails
        function processMessageLocal(message) {
            const msg = message.toLowerCase();

            // Basic pattern matching for common requests
            if (msg.includes('stat') || msg.includes('pipeline') || msg.includes('combien')) {
                return getStats();
            }
            if (msg.includes('hot') || (msg.includes('prospect') && msg.includes('chaud'))) {
                return getProspectsByPriority('hot');
            }
            if (msg.includes('rappel') || msg.includes('relance')) {
                return getFollowups();
            }
            if (msg.includes('aide') || msg.includes('help')) {
                return getHelp();
            }

            return { text: "Je n'ai pas compris. Essaie: **stats**, **prospects hot**, **rappels**, ou **aide**" };
        }

        function buildContextForClaude() {
            const stats = {
                total: prospects.length,
                byPriority: {
                    hot: prospects.filter(p => p.priority === 'hot').length,
                    chaud: prospects.filter(p => p.priority === 'chaud').length,
                    tiede: prospects.filter(p => p.priority === 'tiede').length,
                    froid: prospects.filter(p => p.priority === 'froid').length
                },
                byStatus: {
                    lead: prospects.filter(p => p.status === 'lead').length,
                    contacted: prospects.filter(p => p.status === 'contacted').length,
                    meeting: prospects.filter(p => p.status === 'meeting').length,
                    proposal: prospects.filter(p => p.status === 'proposal').length,
                    won: prospects.filter(p => p.status === 'won').length
                },
                totalPipeline: prospects.reduce((s, p) => s + (p.value || 0), 0)
            };

            const hotProspects = prospects.filter(p => p.priority === 'hot').map(p => `- ${p.company} (${p.sector}): ${p.status}`).join('\n');

            const pendingFollowups = followups.filter(f => !f.done).slice(0, 5).map(f => {
                const p = prospects.find(pr => pr.id === f.prospectId);
                return `- ${p?.company || 'Inconnu'}: ${f.note} (${f.date})`;
            }).join('\n');

            return `### Stats Pipeline
- Total prospects: ${stats.total}
- Hot: ${stats.byPriority.hot}, Chaud: ${stats.byPriority.chaud}, Tiede: ${stats.byPriority.tiede}, Froid: ${stats.byPriority.froid}
- Leads: ${stats.byStatus.lead}, Contactes: ${stats.byStatus.contacted}, RDV: ${stats.byStatus.meeting}, Propositions: ${stats.byStatus.proposal}, Gagnes: ${stats.byStatus.won}
- Valeur pipeline: ${(stats.totalPipeline / 1000000).toFixed(1)}M XPF

### Prospects HOT
${hotProspects || 'Aucun'}

### Rappels en attente
${pendingFollowups || 'Aucun'}

### Date actuelle: ${new Date().toLocaleDateString('fr-FR')}`;
        }

        function parseClaudeAction(assistantMessage, originalMessage) {
            // Detect natural language intents and execute actions
            const msg = originalMessage.toLowerCase();
            const actions = [];

            // Find company mentions
            let detectedCompany = null;
            for (const p of prospects) {
                const companyLower = p.company.toLowerCase();
                const words = companyLower.split(' ').filter(w => w.length > 3);
                if (msg.includes(companyLower) || words.some(w => msg.includes(w))) {
                    detectedCompany = p;
                    break;
                }
            }

            if (!detectedCompany) return null;

            // Detect status change intents
            const statusIntents = {
                // Appel/contact
                'appel': 'contacted', 'appele': 'contacted', 'telephone': 'contacted',
                'contacte': 'contacted', 'parle': 'contacted', 'discute': 'contacted',
                'envoye mail': 'contacted', 'envoye email': 'contacted',
                // RDV
                'rdv': 'meeting', 'rendez-vous': 'meeting', 'rencontre': 'meeting',
                'audit': 'meeting', 'reunion': 'meeting', 'vu': 'meeting',
                // Proposition
                'proposition': 'proposal', 'devis': 'proposal', 'offre': 'proposal',
                'envoye proposition': 'proposal',
                // Won
                'signe': 'won', 'accepte': 'won', 'ok pour': 'won', 'valide': 'won',
                'client': 'won', 'gagne': 'won'
            };

            // Detect priority change intents
            const priorityIntents = {
                // Hot
                'tres interesse': 'hot', 'super interesse': 'hot', 'vraiment interesse': 'hot',
                'chaud bouillant': 'hot', 'pret a signer': 'hot', 'urgent': 'hot',
                // Chaud
                'interesse': 'chaud', 'interesse': 'chaud', 'positif': 'chaud',
                'bonne discussion': 'chaud', 'receptif': 'chaud',
                // Tiede
                'peut-etre': 'tiede', 'hesitant': 'tiede', 'reflechit': 'tiede',
                'pas sur': 'tiede', 'mitige': 'tiede',
                // Froid
                'pas interesse': 'froid', 'refuse': 'froid', 'non': 'froid',
                'pas le moment': 'froid', 'plus tard': 'froid'
            };

            let statusAction = null;
            let priorityAction = null;
            let noteText = null;

            // Check for status intents
            for (const [intent, status] of Object.entries(statusIntents)) {
                if (msg.includes(intent)) {
                    statusAction = status;
                    break;
                }
            }

            // Check for priority intents
            for (const [intent, priority] of Object.entries(priorityIntents)) {
                if (msg.includes(intent)) {
                    priorityAction = priority;
                    break;
                }
            }

            // Execute detected actions
            let actionResults = [];

            if (statusAction && detectedCompany.status !== statusAction) {
                const result = changeProspectStatus(detectedCompany.company, statusAction);
                if (!result.text.includes("n'ai pas trouve")) {
                    actionResults.push(result.text);
                }
            }

            if (priorityAction && detectedCompany.priority !== priorityAction) {
                const result = changeProspectPriority(detectedCompany.company, priorityAction);
                if (!result.text.includes("n'ai pas trouve")) {
                    actionResults.push(result.text);
                }
            }

            // Add automatic note with the original message
            if ((statusAction || priorityAction) && originalMessage.length > 15) {
                const noteResult = addNoteToProspect(detectedCompany.company, originalMessage);
                if (!noteResult.text.includes("n'ai pas trouve")) {
                    actionResults.push("Note automatique ajoutee");
                }
            }

            if (actionResults.length > 0) {
                return {
                    text: assistantMessage + '\n\n**Actions effectuees:**\n' + actionResults.map(a => ' ' + a).join('\n'),
                    data: { type: 'prospect', prospect: detectedCompany }
                };
            }

            return null; // No action detected, return Claude's response as-is
        }

        // ============================================
        // CHATBOT TOOLS / FUNCTIONS
        // ============================================

        function getStats() {
            const total = prospects.length;
            const byPriority = {
                hot: prospects.filter(p => p.priority === 'hot').length,
                chaud: prospects.filter(p => p.priority === 'chaud').length,
                tiede: prospects.filter(p => p.priority === 'tiede').length,
                froid: prospects.filter(p => p.priority === 'froid').length
            };
            const byStatus = {
                lead: prospects.filter(p => p.status === 'lead').length,
                contacted: prospects.filter(p => p.status === 'contacted').length,
                meeting: prospects.filter(p => p.status === 'meeting').length,
                proposal: prospects.filter(p => p.status === 'proposal').length,
                won: prospects.filter(p => p.status === 'won').length
            };
            const totalPipeline = prospects.reduce((s, p) => s + (p.value || 0), 0);
            const withAssets = prospects.filter(p => p.assets?.length > 0).length;
            const todayFollowups = followups.filter(f => !f.done && f.date <= new Date().toISOString().split('T')[0]).length;

            return {
                text: `Voici les stats de ton pipeline:`,
                data: {
                    type: 'stats',
                    total,
                    byPriority,
                    byStatus,
                    totalPipeline,
                    withAssets,
                    todayFollowups
                }
            };
        }

        function getProspectsByPriority(priority) {
            const list = prospects.filter(p => p.priority === priority);
            const labels = { hot: 'Hot ', chaud: 'Chaud ', tiede: 'Tiede ', froid: 'Froid ' };
            const total = list.reduce((s, p) => s + (p.value || 0), 0);

            return {
                text: `**${list.length} prospects ${labels[priority]}** (${fmtXPF(total)} XPF):`,
                data: { type: 'prospects', prospects: list.slice(0, 8) }
            };
        }

        function getProspectsByStatus(status) {
            const list = prospects.filter(p => p.status === status);
            const labels = { lead: 'Lead', contacted: 'Contacte', meeting: 'RDV/Audit', proposal: 'Proposition', won: 'Gagne' };

            return {
                text: `**${list.length} prospects en "${labels[status]}"**:`,
                data: { type: 'prospects', prospects: list.slice(0, 8) }
            };
        }

        function getProspectDetails(prospect) {
            const prospectNotes = notes[prospect.id] || [];
            const prospectFollowups = followups.filter(f => f.prospectId === prospect.id && !f.done);

            return {
                text: `Voici la fiche de **${prospect.company}**:`,
                data: {
                    type: 'prospect',
                    prospect: {
                        ...prospect,
                        notesCount: prospectNotes.length,
                        followupsCount: prospectFollowups.length
                    }
                }
            };
        }

        function getFollowups() {
            const today = new Date().toISOString().split('T')[0];
            const pending = followups.filter(f => !f.done);
            const todayList = pending.filter(f => f.date <= today);
            const upcoming = pending.filter(f => f.date > today).slice(0, 5);

            if (todayList.length === 0 && upcoming.length === 0) {
                return { text: "Aucun rappel en attente. Tu es a jour! " };
            }

            const items = [...todayList, ...upcoming].map(f => ({
                ...f,
                prospect: prospects.find(p => p.id === f.prospectId),
                isOverdue: f.date < today,
                isToday: f.date === today
            }));

            return {
                text: `**${todayList.length} rappel(s) aujourd'hui** + ${upcoming.length} a venir:`,
                data: { type: 'followups', followups: items }
            };
        }

        function getProspectsWithAssets() {
            const list = prospects.filter(p => p.assets?.length > 0);
            return {
                text: `**${list.length} prospects avec prototypes/assets crees**:`,
                data: { type: 'prospects', prospects: list }
            };
        }

        function getProspectsBySector(sector) {
            const list = prospects.filter(p => p.sector.toLowerCase().includes(sector.toLowerCase()));
            const total = list.reduce((s, p) => s + (p.value || 0), 0);

            return {
                text: `**${list.length} prospects en ${sector}** (${fmtXPF(total)} XPF):`,
                data: { type: 'prospects', prospects: list.slice(0, 8) }
            };
        }

        function getSectorAnalysis() {
            const sectors = {};
            prospects.forEach(p => {
                if (!sectors[p.sector]) sectors[p.sector] = { count: 0, value: 0 };
                sectors[p.sector].count++;
                sectors[p.sector].value += p.value || 0;
            });

            const sorted = Object.entries(sectors).sort((a, b) => b[1].value - a[1].value);
            const text = sorted.slice(0, 5).map(([s, d]) => ` **${s}**: ${d.count} prospects (${fmtXPF(d.value)})`).join('\n');

            return { text: `Top secteurs par valeur:\n\n${text}` };
        }

        function getTopProspects() {
            const sorted = [...prospects].sort((a, b) => {
                const priorityOrder = { hot: 0, chaud: 1, tiede: 2, froid: 3 };
                const pDiff = (priorityOrder[a.priority] || 99) - (priorityOrder[b.priority] || 99);
                if (pDiff !== 0) return pDiff;
                return (b.value || 0) - (a.value || 0);
            });

            return {
                text: `**Top 8 prospects** (priorite + valeur):`,
                data: { type: 'prospects', prospects: sorted.slice(0, 8) }
            };
        }

        function getHelp() {
            return {
                text: `**Commandes disponibles:**\n\n**LECTURE:**\n **stats** / **pipeline** - Statistiques generales\n **prospects hot/chaud/tiede/froid** - Par temperature\n **prospects lead/contacte/rdv** - Par status\n **cherche [nom]** - Trouver un prospect\n **rappels** - Relances du jour\n **top prospects** - Meilleures opportunites\n **secteur [nom]** - Analyse sectorielle\n\n**MODIFICATION:**\n **passe [nom] en [status]** - Changer le status (lead/contacte/rdv/proposition/gagne)\n **[nom] devient [temp]** - Changer la temperature (hot/chaud/tiede/froid)\n **note pour [nom]: [texte]** - Ajouter une note\n **rappel [nom] dans X jours** - Creer un rappel\n **rappel fait [nom]** - Marquer un rappel comme fait\n\n**AUTRES:**\n **sync** - Synchroniser Airtable`
            };
        }

        // ============================================
        // CHATBOT MODIFICATION FUNCTIONS
        // ============================================

        function findProspectByName(search) {
            const searchLower = search.toLowerCase().trim();
            // Exact match first
            let prospect = prospects.find(p => p.company.toLowerCase() === searchLower);
            if (prospect) return prospect;
            // Partial match
            prospect = prospects.find(p => p.company.toLowerCase().includes(searchLower));
            if (prospect) return prospect;
            // Word match
            const words = searchLower.split(' ').filter(w => w.length > 2);
            for (const word of words) {
                prospect = prospects.find(p => p.company.toLowerCase().includes(word));
                if (prospect) return prospect;
            }
            return null;
        }

        function changeProspectStatus(companySearch, newStatus) {
            const prospect = findProspectByName(companySearch);
            if (!prospect) {
                return { text: `Je n'ai pas trouve de prospect correspondant a "${companySearch}".` };
            }

            // Normalize status
            const statusMap = {
                'lead': 'lead',
                'contacte': 'contacted', 'contacted': 'contacted',
                'rdv': 'meeting', 'meeting': 'meeting', 'audit': 'meeting',
                'proposition': 'proposal', 'proposal': 'proposal', 'devis': 'proposal',
                'gagne': 'won', 'won': 'won', 'client': 'won'
            };
            const status = statusMap[newStatus.toLowerCase()];
            if (!status) {
                return { text: `Status "${newStatus}" non reconnu. Utilise: lead, contacte, rdv, proposition, gagne.` };
            }

            const oldStatus = prospect.status;
            prospect.status = status;
            save();
            renderProspectsViews();

            // Sync to Airtable
            updateProspectInAirtable(prospect);

            return {
                text: `**${prospect.company}** passe de "${statusLabel(oldStatus)}" a "${statusLabel(status)}"`,
                data: { type: 'prospect', prospect }
            };
        }

        function changeProspectPriority(companySearch, newPriority) {
            const prospect = findProspectByName(companySearch);
            if (!prospect) {
                return { text: `Je n'ai pas trouve de prospect correspondant a "${companySearch}".` };
            }

            const validPriorities = ['hot', 'chaud', 'tiede', 'froid'];
            const priority = newPriority.toLowerCase();
            if (!validPriorities.includes(priority)) {
                return { text: `Temperature "${newPriority}" non reconnue. Utilise: hot, chaud, tiede, froid.` };
            }

            const oldPriority = prospect.priority;
            prospect.priority = priority;
            prospect.priorityUpdatedAt = Date.now();
            save();
            renderProspectsViews();

            // Sync to Airtable
            updateProspectInAirtable(prospect);

            return {
                text: `**${prospect.company}** passe de "${priorityLabel(oldPriority)}" a "${priorityLabel(priority)}"`,
                data: { type: 'prospect', prospect }
            };
        }

        function addNoteToProspect(companySearch, noteText) {
            const prospect = findProspectByName(companySearch);
            if (!prospect) {
                return { text: `Je n'ai pas trouve de prospect correspondant a "${companySearch}".` };
            }

            if (!noteText || noteText.trim().length < 2) {
                return { text: `Le texte de la note est trop court ou vide.` };
            }

            // Add note
            if (!notes[prospect.id]) notes[prospect.id] = [];
            const note = {
                id: Date.now(),
                text: noteText.trim(),
                date: new Date().toISOString()
            };
            notes[prospect.id].unshift(note);
            localStorage.setItem('pk_notes', JSON.stringify(notes));

            return {
                text: `Note ajoutee pour **${prospect.company}**:\n"${noteText.trim()}"`,
                data: { type: 'prospect', prospect: { ...prospect, notesCount: notes[prospect.id].length } }
            };
        }

        function addReminderToProspect(message) {
            const msg = message.toLowerCase();

            // Find prospect name in message
            let prospect = null;
            for (const p of prospects) {
                const words = p.company.toLowerCase().split(' ');
                if (words.some(w => w.length > 3 && msg.includes(w))) {
                    prospect = p;
                    break;
                }
            }

            if (!prospect) {
                return { text: `Je n'ai pas trouve de prospect dans ta demande. Essaie: "rappel Air Tahiti dans 3 jours"` };
            }

            // Parse date
            let date = new Date();
            if (msg.includes('demain')) {
                date.setDate(date.getDate() + 1);
            } else if (msg.includes('apres-demain') || msg.includes('apres demain')) {
                date.setDate(date.getDate() + 2);
            } else if (msg.includes('semaine')) {
                date.setDate(date.getDate() + 7);
            } else {
                // "dans X jours"
                const daysMatch = msg.match(/dans\s+(\d+)\s*(?:jour|j)/);
                if (daysMatch) {
                    date.setDate(date.getDate() + parseInt(daysMatch[1]));
                } else {
                    date.setDate(date.getDate() + 3); // Default 3 days
                }
            }

            // Extract note if any (after "pour" or ":")
            let noteText = '';
            const noteMatch = message.match(/(?:pour|:)\s+(.+)$/i);
            if (noteMatch) noteText = noteMatch[1].trim();

            // Create followup
            const followup = {
                id: Date.now(),
                prospectId: prospect.id,
                date: date.toISOString().split('T')[0],
                note: noteText || `Relancer ${prospect.company}`,
                done: false
            };
            followups.push(followup);
            localStorage.setItem('pk_followups', JSON.stringify(followups));
            renderFollowups();

            const dateStr = date.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
            return {
                text: `Rappel cree pour **${prospect.company}** le **${dateStr}**${noteText ? `\nNote: "${noteText}"` : ''}`
            };
        }

        function markFollowupDoneChat(prospectId) {
            const pendingFollowups = followups.filter(f => f.prospectId === prospectId && !f.done);
            if (pendingFollowups.length === 0) {
                const prospect = prospects.find(p => p.id === prospectId);
                return { text: `Aucun rappel en attente pour ${prospect?.company || 'ce prospect'}.` };
            }

            // Mark the most recent/urgent one as done
            const today = new Date().toISOString().split('T')[0];
            const urgent = pendingFollowups.find(f => f.date <= today) || pendingFollowups[0];
            urgent.done = true;
            localStorage.setItem('pk_followups', JSON.stringify(followups));
            renderFollowups();

            const prospect = prospects.find(p => p.id === prospectId);
            return {
                text: `Rappel marque comme fait pour **${prospect?.company}**`
            };
        }

        // ============================================
        // CONTENT CALENDAR (FACEBOOK)
        // ============================================

        let facebookPosts = [];
        let currentCalendarMonth = new Date();
        let selectedPostType = 'ai-news';
        const N8N_WEBHOOK_URL = 'https://n8n.srv1140766.hstgr.cloud/webhook/';
        const FACEBOOK_WORKFLOW_ID = 'hZotr6emniXBXMO4';

        // Load posts from localStorage
        function loadFacebookPosts() {
            const stored = localStorage.getItem('pk_facebook_posts');
            if (stored) facebookPosts = JSON.parse(stored);
            renderCalendar();
            renderPostsList();
            updateContentStats();
        }

        function saveFacebookPosts() {
            localStorage.setItem('pk_facebook_posts', JSON.stringify(facebookPosts));
        }

        function updateContentStats() {
            const scheduled = facebookPosts.filter(p => p.status === 'scheduled').length;
            const published = facebookPosts.filter(p => p.status === 'published').length;
            document.getElementById('posts-scheduled-count').textContent = scheduled;
            document.getElementById('posts-published-count').textContent = published;
            document.getElementById('nav-content-count').textContent = scheduled;
        }

        function renderCalendar() {
            const container = document.getElementById('calendar-days');
            const monthYear = document.getElementById('calendar-month-year');

            const year = currentCalendarMonth.getFullYear();
            const month = currentCalendarMonth.getMonth();

            const monthNames = ['Janvier', 'Fevrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Aout', 'Septembre', 'Octobre', 'Novembre', 'Decembre'];
            monthYear.textContent = `${monthNames[month]} ${year}`;

            // First day of month (0 = Sunday, we need Monday = 0)
            const firstDay = new Date(year, month, 1);
            let startDay = firstDay.getDay() - 1;
            if (startDay < 0) startDay = 6;

            // Days in month
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Today
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];

            let html = '';

            // Previous month padding
            const prevMonth = new Date(year, month, 0);
            const prevDays = prevMonth.getDate();
            for (let i = startDay - 1; i >= 0; i--) {
                const day = prevDays - i;
                html += `<div class="calendar-day other-month"><span class="calendar-day-number">${day}</span></div>`;
            }

            // Current month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = dateStr === todayStr;
                const post = facebookPosts.find(p => p.date === dateStr);
                const hasPost = !!post;
                const isPublished = post?.status === 'published';

                let classes = 'calendar-day';
                if (isToday) classes += ' today';
                if (hasPost) classes += ' has-post';
                if (isPublished) classes += ' published';

                html += `<div class="${classes}" onclick="selectCalendarDay('${dateStr}')" title="${post?.preview || ''}">
                    <span class="calendar-day-number">${day}</span>
                </div>`;
            }

            // Next month padding
            const totalCells = startDay + daysInMonth;
            const remaining = 7 - (totalCells % 7);
            if (remaining < 7) {
                for (let i = 1; i <= remaining; i++) {
                    html += `<div class="calendar-day other-month"><span class="calendar-day-number">${i}</span></div>`;
                }
            }

            container.innerHTML = html;
        }

        function navigateCalendar(direction) {
            if (direction === 0) {
                currentCalendarMonth = new Date();
            } else {
                currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + direction);
            }
            renderCalendar();
        }

        function selectCalendarDay(dateStr) {
            document.getElementById('post-date').value = dateStr;
            const post = facebookPosts.find(p => p.date === dateStr);
            if (post) {
                document.getElementById('post-content').value = post.content;
            }
        }

        function renderPostsList(filter = 'all') {
            const container = document.getElementById('posts-list-content');
            let posts = [...facebookPosts].sort((a, b) => new Date(b.date) - new Date(a.date));

            if (filter !== 'all') {
                posts = posts.filter(p => p.status === filter);
            }

            if (posts.length === 0) {
                container.innerHTML = `<div style="text-align: center; color: var(--text-dim); padding: 2rem;">Aucun post</div>`;
                return;
            }

            container.innerHTML = posts.slice(0, 10).map(post => `
                <div class="post-item" onclick="editPost('${post.id}')">
                    <div class="post-item-header">
                        <span class="post-item-date">${formatPostDate(post.date)} ${post.time || '08:00'}</span>
                        <span class="post-item-status ${post.status}">${post.status === 'scheduled' ? 'Planifie' : post.status === 'published' ? 'Publie' : 'Brouillon'}</span>
                    </div>
                    <div class="post-item-preview">${post.preview || post.content.substring(0, 100)}...</div>
                    ${post.imageUrl ? `<img class="post-item-image" src="${post.imageUrl}" alt="Post image" />` : ''}
                </div>
            `).join('');
        }

        function formatPostDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' });
        }

        function editPost(postId) {
            const post = facebookPosts.find(p => p.id === postId);
            if (!post) return;
            document.getElementById('post-content').value = post.content;
            document.getElementById('post-date').value = post.date;
            document.getElementById('post-time').value = post.time || '08:00';
            document.getElementById('post-content').dataset.editId = postId;
        }

        async function generatePostWithAI() {
            const btn = document.querySelector('.ai-generate-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<svg class="spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg> Generation...';
            btn.disabled = true;

            const postType = selectedPostType;
            let prompt = '';

            switch (postType) {
                case 'ai-news':
                    prompt = `Tu es le community manager de PACIFIK'AI, une agence d'automatisation IA en Polynesie francaise.
Ecris un post Facebook engageant (max 280 caracteres) sur une actualite IA recente qui pourrait interesser les entrepreneurs polynesiens.
Le post doit:
- Etre en francais
- Avoir un angle local/pratique
- Inciter a l'engagement (question ou CTA)
- Inclure 2-3 hashtags pertinents

Reponds UNIQUEMENT avec le texte du post, sans guillemets ni explications.`;
                    break;
                case 'case-study':
                    prompt = `Tu es le community manager de PACIFIK'AI.
Ecris un post Facebook (max 300 caracteres) presentant un cas d'usage fictif mais realiste d'une entreprise polynesienne qui a automatise une tache avec l'IA.
Exemples de secteurs: restaurant, hotel, cabinet comptable, importateur, garage auto.
Le post doit montrer un resultat concret (temps gagne, erreurs evitees, client satisfait).
Termine par une question pour engager.

Reponds UNIQUEMENT avec le texte du post.`;
                    break;
                case 'tip':
                    prompt = `Tu es le community manager de PACIFIK'AI.
Ecris un post Facebook court (max 250 caracteres) donnant un conseil pratique aux entrepreneurs sur l'automatisation ou l'IA.
Le conseil doit etre actionnable et simple.
Inclus un emoji pertinent au debut.

Reponds UNIQUEMENT avec le texte du post.`;
                    break;
            }

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': CLAUDE_CONFIG.apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: CLAUDE_CONFIG.model,
                        max_tokens: 500,
                        messages: [{ role: 'user', content: prompt }]
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('post-content').value = data.content[0].text;
                } else {
                    throw new Error('API error');
                }
            } catch (error) {
                console.error('AI generation error:', error);
                document.getElementById('post-content').value = "Erreur de generation. Ecris ton post manuellement.";
            }

            btn.innerHTML = originalText;
            btn.disabled = false;
        }

        function schedulePost() {
            const content = document.getElementById('post-content').value.trim();
            const date = document.getElementById('post-date').value;
            const time = document.getElementById('post-time').value;
            const editId = document.getElementById('post-content').dataset.editId;

            if (!content) {
                alert('Ecris ou genere du contenu avant de planifier.');
                return;
            }

            if (!date) {
                alert('Selectionne une date de publication.');
                return;
            }

            if (editId) {
                // Update existing
                const post = facebookPosts.find(p => p.id === editId);
                if (post) {
                    post.content = content;
                    post.date = date;
                    post.time = time;
                    post.preview = content.substring(0, 80);
                }
                delete document.getElementById('post-content').dataset.editId;
            } else {
                // Create new
                const post = {
                    id: Date.now().toString(),
                    content,
                    date,
                    time,
                    status: 'scheduled',
                    preview: content.substring(0, 80),
                    type: selectedPostType,
                    createdAt: new Date().toISOString()
                };
                facebookPosts.push(post);
            }

            saveFacebookPosts();
            renderCalendar();
            renderPostsList();
            updateContentStats();

            // Clear form
            document.getElementById('post-content').value = '';
            showToast('Post planifie!');
        }

        async function triggerFacebookWorkflow() {
            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<svg class="spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg> Execution...';
            btn.disabled = true;

            try {
                // Activate workflow if not active
                const activateResponse = await fetch(`https://n8n.srv1140766.hstgr.cloud/api/v1/workflows/${FACEBOOK_WORKFLOW_ID}/activate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                // For manual trigger, we'd need a webhook endpoint
                // For now, show a message
                showToast('Workflow lance! Verifie n8n pour le statut.');

            } catch (error) {
                console.error('Workflow trigger error:', error);
                showToast('Erreur - Ouvre n8n manuellement');
            }

            btn.innerHTML = originalText;
            btn.disabled = false;
        }

        // Post type selection
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('post-option')) {
                document.querySelectorAll('.post-option').forEach(o => o.classList.remove('active'));
                e.target.classList.add('active');
                selectedPostType = e.target.dataset.type;
            }

            if (e.target.classList.contains('posts-list-tab')) {
                document.querySelectorAll('.posts-list-tab').forEach(t => t.classList.remove('active'));
                e.target.classList.add('active');
                renderPostsList(e.target.dataset.filter);
            }
        });

        // Initialize date input
        document.addEventListener('DOMContentLoaded', function() {
            const dateInput = document.getElementById('post-date');
            if (dateInput) {
                dateInput.value = new Date().toISOString().split('T')[0];
            }
            loadFacebookPosts();
        });

        // ============================================
        // CHATBOT RENDER HELPERS
        // ============================================

        function renderStatsCard(data) {
            return `
                <div class="chat-data-card">
                    <div class="chat-data-row">
                        <span class="chat-data-label">Total prospects</span>
                        <span class="chat-data-value">${data.total}</span>
                    </div>
                    <div class="chat-data-row">
                        <span class="chat-data-label">Pipeline total</span>
                        <span class="chat-data-value" style="color: var(--green);">${fmtXPF(data.totalPipeline)} XPF</span>
                    </div>
                    <div class="chat-data-row">
                        <span class="chat-data-label">Par temperature</span>
                        <span class="chat-data-value">${data.byPriority.hot} ${data.byPriority.chaud} ${data.byPriority.tiede} ${data.byPriority.froid}</span>
                    </div>
                    <div class="chat-data-row">
                        <span class="chat-data-label">Avec assets</span>
                        <span class="chat-data-value">${data.withAssets} prospects</span>
                    </div>
                    <div class="chat-data-row">
                        <span class="chat-data-label">Rappels aujourd'hui</span>
                        <span class="chat-data-value" style="color: ${data.todayFollowups > 0 ? 'var(--orange)' : 'var(--green)'};">${data.todayFollowups}</span>
                    </div>
                </div>
            `;
        }

        function renderProspectsList(list) {
            return `
                <div class="chat-prospect-list">
                    ${list.map(p => `
                        <div class="chat-prospect-item" onclick="openProspectDetail(${p.id}); toggleChatbot();">
                            <div>
                                <div class="chat-prospect-name">${p.company} ${p.assets?.length ? renderAssetIcons(p.assets) : ''}</div>
                                <div class="chat-prospect-meta">${p.sector}  ${fmtXPF(p.value)}</div>
                            </div>
                            <span class="badge ${p.priority}" style="font-size: 0.5625rem;">${priorityLabel(p.priority)}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderProspectCard(p) {
            return `
                <div class="chat-data-card">
                    <div class="chat-data-header">
                        <span class="chat-data-title">${p.company}</span>
                        <span class="badge ${p.priority}" style="font-size: 0.5625rem;">${priorityLabel(p.priority)}</span>
                    </div>
                    <div class="chat-data-row">
                        <span class="chat-data-label">Contact</span>
                        <span class="chat-data-value">${p.name || '-'}</span>
                    </div>
                    <div class="chat-data-row">
                        <span class="chat-data-label">Secteur</span>
                        <span class="chat-data-value">${p.sector}</span>
                    </div>
                    <div class="chat-data-row">
                        <span class="chat-data-label">Status</span>
                        <span class="chat-data-value">${statusLabel(p.status)}</span>
                    </div>
                    <div class="chat-data-row">
                        <span class="chat-data-label">Valeur</span>
                        <span class="chat-data-value" style="color: var(--green);">${fmtXPF(p.value)} XPF</span>
                    </div>
                    ${p.assets?.length ? `
                    <div class="chat-data-row">
                        <span class="chat-data-label">Assets</span>
                        <span class="chat-data-value">${renderAssetIcons(p.assets)}</span>
                    </div>
                    ` : ''}
                    <div class="chat-data-row">
                        <span class="chat-data-label">Notes</span>
                        <span class="chat-data-value">${p.notesCount || 0}</span>
                    </div>
                    <div class="chat-actions">
                        <button class="chat-action-btn" onclick="openProspectDetail(${p.id}); toggleChatbot();">Ouvrir fiche</button>
                    </div>
                </div>
            `;
        }

        function renderFollowupsList(list) {
            return `
                <div class="chat-prospect-list">
                    ${list.map(f => `
                        <div class="chat-prospect-item" onclick="openProspectDetail(${f.prospectId}); toggleChatbot();">
                            <div>
                                <div class="chat-prospect-name">${f.prospect?.company || 'Inconnu'}</div>
                                <div class="chat-prospect-meta">${f.note || 'Relancer'}</div>
                            </div>
                            <span class="followup-badge ${f.isOverdue ? 'overdue' : f.isToday ? 'today' : 'upcoming'}">
                                ${f.isOverdue ? 'En retard' : f.isToday ? "Aujourd'hui" : fmtDate(f.date)}
                            </span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Update drag handlers to sync with Airtable
        const originalHandleDrop = handleDrop;
        handleDrop = function(event, newPriority) {
            const prospectId = draggedProspectId;
            originalHandleDrop(event, newPriority);
            if (prospectId) {
                const prospect = prospects.find(p => p.id === prospectId);
                if (prospect) updateProspectInAirtable(prospect);
            }
        };

        const originalHandleStatusDrop = handleStatusDrop;
        handleStatusDrop = function(event, newStatus) {
            const prospectId = draggedProspectId;
            const oldStatus = prospects.find(p => p.id === prospectId)?.status;
            originalHandleStatusDrop(event, newStatus);
            if (prospectId) {
                const prospect = prospects.find(p => p.id === prospectId);
                if (prospect) {
                    updateProspectInAirtable(prospect);
                    // Add notification for status change
                    if (oldStatus !== newStatus) {
                        addNotification({
                            type: 'status',
                            title: `${prospect.company} a change de statut`,
                            desc: `${statusLabel(oldStatus)}  ${statusLabel(newStatus)}`,
                            prospectId: prospect.id
                        });
                        // Add to activity timeline
                        addActivityToProspect(prospect.id, 'status', `Statut change: ${statusLabel(oldStatus)}  ${statusLabel(newStatus)}`);
                    }
                }
            }
        };

        // ============================================
        // NOTIFICATIONS SYSTEM
        // ============================================
        let notifications = JSON.parse(localStorage.getItem('pacifikai_notifications') || '[]');

        function statusLabel(s) {
            const labels = { lead: 'Lead', contacted: 'Contacte', meeting: 'RDV/Audit', proposal: 'Proposition', won: 'Gagne' };
            return labels[s] || s;
        }

        function addNotification(notif) {
            const notification = {
                id: Date.now(),
                ...notif,
                time: new Date().toISOString(),
                read: false
            };
            notifications.unshift(notification);
            if (notifications.length > 50) notifications = notifications.slice(0, 50);
            localStorage.setItem('pacifikai_notifications', JSON.stringify(notifications));
            renderNotifications();
        }

        function renderNotifications() {
            const list = document.getElementById('notification-list');
            const badge = document.getElementById('notification-badge');
            const unreadCount = notifications.filter(n => !n.read).length;

            badge.textContent = unreadCount;
            badge.classList.toggle('hidden', unreadCount === 0);

            if (notifications.length === 0) {
                list.innerHTML = '<div class="notification-empty">Aucune notification</div>';
                return;
            }

            const icons = {
                status: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',
                task: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
                alert: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>'
            };

            list.innerHTML = notifications.slice(0, 20).map(n => `
                <div class="notification-item ${n.read ? '' : 'unread'}" onclick="handleNotificationClick(${n.id}, ${n.prospectId || 'null'})">
                    <div class="notification-icon ${n.type}">${icons[n.type] || icons.alert}</div>
                    <div class="notification-content">
                        <div class="notification-title">${n.title}</div>
                        <div class="notification-desc">${n.desc}</div>
                        <div class="notification-time">${formatTimeAgo(n.time)}</div>
                    </div>
                </div>
            `).join('');
        }

        function formatTimeAgo(isoTime) {
            const now = new Date();
            const time = new Date(isoTime);
            const diffMs = now - time;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'A l\'instant';
            if (diffMins < 60) return `Il y a ${diffMins} min`;
            if (diffHours < 24) return `Il y a ${diffHours}h`;
            if (diffDays < 7) return `Il y a ${diffDays}j`;
            return time.toLocaleDateString('fr-FR');
        }

        function toggleNotifications(event) {
            event.stopPropagation();
            const panel = document.getElementById('notification-panel');
            panel.classList.toggle('show');
        }

        function handleNotificationClick(notifId, prospectId) {
            const notif = notifications.find(n => n.id === notifId);
            if (notif) notif.read = true;
            localStorage.setItem('pacifikai_notifications', JSON.stringify(notifications));
            renderNotifications();

            document.getElementById('notification-panel').classList.remove('show');

            if (prospectId) {
                openProspectDetail(prospectId);
            }
        }

        function clearAllNotifications(event) {
            event.stopPropagation();
            notifications = [];
            localStorage.setItem('pacifikai_notifications', JSON.stringify(notifications));
            renderNotifications();
        }

        // Close notifications when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.notification-bell')) {
                document.getElementById('notification-panel').classList.remove('show');
            }
        });

        // Check for task deadlines periodically
        function checkTaskDeadlines() {
            const today = new Date().toISOString().split('T')[0];
            const urgentTasks = allTasks.filter(t => {
                if (!t.dueDate || t.status === 'Termine') return false;
                return t.dueDate <= today && t.status !== 'Termine';
            });

            // Update nav badge
            const navBadge = document.querySelector('.nav-item[onclick*="tasks"] .nav-badge');
            if (navBadge && urgentTasks.length > 0) {
                navBadge.textContent = urgentTasks.length;
                navBadge.classList.add('urgent');
            }
        }

        // ============================================
        // ACTIVITY TIMELINE PER PROSPECT
        // ============================================
        let prospectActivities = JSON.parse(localStorage.getItem('pacifikai_activities') || '{}');

        function addActivityToProspect(prospectId, type, description) {
            if (!prospectActivities[prospectId]) prospectActivities[prospectId] = [];
            prospectActivities[prospectId].unshift({
                id: Date.now(),
                type,
                description,
                time: new Date().toISOString()
            });
            if (prospectActivities[prospectId].length > 50) {
                prospectActivities[prospectId] = prospectActivities[prospectId].slice(0, 50);
            }
            localStorage.setItem('pacifikai_activities', JSON.stringify(prospectActivities));
        }

        function getProspectTimeline(prospectId) {
            return prospectActivities[prospectId] || [];
        }

        function renderProspectTimeline(prospectId) {
            const activities = getProspectTimeline(prospectId);
            if (activities.length === 0) {
                return '<div class="empty"><p>Aucune activite enregistree</p></div>';
            }

            return `<div class="timeline">${activities.slice(0, 10).map(a => `
                <div class="timeline-item">
                    <div class="timeline-dot ${a.type}"></div>
                    <div class="timeline-content">
                        <div class="timeline-header">
                            <span class="timeline-action">${a.description}</span>
                            <span class="timeline-date">${formatTimeAgo(a.time)}</span>
                        </div>
                    </div>
                </div>
            `).join('')}</div>`;
        }

        // ============================================
        // GLOBAL SEARCH (Cmd+K)
        // ============================================
        let searchSelectedIndex = 0;

        function openGlobalSearch() {
            const overlay = document.getElementById('search-overlay');
            overlay.classList.add('show');
            setTimeout(() => {
                document.getElementById('global-search-input').focus();
            }, 100);
            searchSelectedIndex = 0;
        }

        function closeGlobalSearch(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('search-overlay').classList.remove('show');
            document.getElementById('global-search-input').value = '';
            document.getElementById('search-prospects-section').style.display = 'none';
            document.getElementById('search-tasks-section').style.display = 'none';
        }

        function handleGlobalSearch(query) {
            const prospectsSection = document.getElementById('search-prospects-section');
            const prospectsResults = document.getElementById('search-prospects-results');
            const tasksSection = document.getElementById('search-tasks-section');
            const tasksResults = document.getElementById('search-tasks-results');

            if (!query || query.length < 2) {
                prospectsSection.style.display = 'none';
                tasksSection.style.display = 'none';
                return;
            }

            const q = query.toLowerCase();

            // Search prospects
            const matchedProspects = prospects.filter(p =>
                p.company.toLowerCase().includes(q) ||
                p.sector.toLowerCase().includes(q) ||
                (p.contact && p.contact.toLowerCase().includes(q))
            ).slice(0, 5);

            if (matchedProspects.length > 0) {
                prospectsSection.style.display = 'block';
                prospectsResults.innerHTML = matchedProspects.map(p => `
                    <div class="search-result" onclick="executeSearchAction('prospect', ${p.id})">
                        <div class="search-result-icon prospect">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        </div>
                        <div class="search-result-content">
                            <div class="search-result-title">${p.company}</div>
                            <div class="search-result-meta">${p.sector}  ${statusLabel(p.status)}</div>
                        </div>
                    </div>
                `).join('');
            } else {
                prospectsSection.style.display = 'none';
            }

            // Search tasks
            const matchedTasks = allTasks.filter(t =>
                t.title.toLowerCase().includes(q) ||
                (t.description && t.description.toLowerCase().includes(q))
            ).slice(0, 5);

            if (matchedTasks.length > 0) {
                tasksSection.style.display = 'block';
                tasksResults.innerHTML = matchedTasks.map(t => `
                    <div class="search-result" onclick="executeSearchAction('task', '${t.id}')">
                        <div class="search-result-icon task">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                        </div>
                        <div class="search-result-content">
                            <div class="search-result-title">${t.title}</div>
                            <div class="search-result-meta">${t.status}${t.dueDate ? '  ' + t.dueDate : ''}</div>
                        </div>
                    </div>
                `).join('');
            } else {
                tasksSection.style.display = 'none';
            }
        }

        function executeSearchAction(action, id) {
            closeGlobalSearch();
            switch(action) {
                case 'new-prospect':
                    window.open('https://airtable.com/appF7pltUaQkOlKM5/tbluw05otXoESeQkz', '_blank');
                    break;
                case 'focus':
                    toggleFocusMode();
                    break;
                case 'sync':
                    syncFromAirtable();
                    break;
                case 'prospect':
                    openProspectDetail(id);
                    break;
                case 'task':
                    switchView('tasks');
                    break;
            }
        }

        // Keyboard shortcut (Cmd+K / Ctrl+K)
        document.addEventListener('keydown', (e) => {
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                e.preventDefault();
                openGlobalSearch();
            }
            if (e.key === 'Escape') {
                closeGlobalSearch();
            }
        });

        // ============================================
        // CONTEXT MENU (Quick Actions)
        // ============================================
        let contextMenuProspectId = null;

        function showContextMenu(event, prospectId) {
            event.preventDefault();
            event.stopPropagation();

            contextMenuProspectId = prospectId;
            const menu = document.getElementById('context-menu');

            // Position menu
            let x = event.clientX;
            let y = event.clientY;

            // Adjust if near edge
            if (x + 200 > window.innerWidth) x = window.innerWidth - 210;
            if (y + 300 > window.innerHeight) y = window.innerHeight - 310;

            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.classList.add('show');
        }

        function hideContextMenu() {
            document.getElementById('context-menu').classList.remove('show');
            contextMenuProspectId = null;
        }

        document.addEventListener('click', hideContextMenu);
        document.addEventListener('contextmenu', (e) => {
            if (!e.target.closest('.pipeline-card')) {
                hideContextMenu();
            }
        });

        function contextMenuAction(action) {
            if (!contextMenuProspectId) return;
            const prospect = prospects.find(p => p.id === contextMenuProspectId);
            if (!prospect) return;

            hideContextMenu();

            switch(action) {
                case 'change-status':
                    showStatusPicker(prospect);
                    break;
                case 'change-priority':
                    showPriorityPicker(prospect);
                    break;
                case 'add-note':
                    openProspectDetail(prospect.id);
                    setTimeout(() => document.querySelector('.note-input')?.focus(), 300);
                    break;
                case 'create-task':
                    const taskTitle = prompt(`Nouvelle tache pour ${prospect.company}:`);
                    if (taskTitle) {
                        showToast(`Tache "${taskTitle}" a creer dans Airtable`);
                        addActivityToProspect(prospect.id, 'task', `Tache creee: ${taskTitle}`);
                    }
                    break;
                case 'send-email':
                    if (prospect.email) {
                        window.open(`mailto:${prospect.email}?subject=PACIFIK'AI - ${prospect.company}`, '_blank');
                    } else {
                        showToast('Pas d\'email configure pour ce prospect');
                    }
                    break;
                case 'schedule-followup':
                    const date = prompt('Date de relance (YYYY-MM-DD):');
                    if (date) {
                        prospect.nextFollowUp = date;
                        updateProspectInAirtable(prospect);
                        addActivityToProspect(prospect.id, 'note', `Relance planifiee pour le ${date}`);
                        showToast(`Relance planifiee pour le ${date}`);
                    }
                    break;
                case 'open-detail':
                    openProspectDetail(prospect.id);
                    break;
            }
        }

        function showStatusPicker(prospect) {
            const statuses = ['lead', 'contacted', 'meeting', 'proposal', 'won'];
            const choice = prompt(`Changer le statut de ${prospect.company}:\n\n1. Lead\n2. Contacte\n3. RDV/Audit\n4. Proposition\n5. Gagne\n\nEntrez le numero:`);
            const idx = parseInt(choice) - 1;
            if (idx >= 0 && idx < statuses.length) {
                const oldStatus = prospect.status;
                prospect.status = statuses[idx];
                updateProspectInAirtable(prospect);
                addNotification({
                    type: 'status',
                    title: `${prospect.company} a change de statut`,
                    desc: `${statusLabel(oldStatus)}  ${statusLabel(prospect.status)}`,
                    prospectId: prospect.id
                });
                addActivityToProspect(prospect.id, 'status', `Statut change: ${statusLabel(oldStatus)}  ${statusLabel(prospect.status)}`);
                renderAll();
            }
        }

        function showPriorityPicker(prospect) {
            const priorities = ['hot', 'chaud', 'tiede', 'froid'];
            const priorityLabels = [' Hot', 'Chaud', 'Tide', 'Froid'];
            const currentIdx = priorities.indexOf(prospect.priority);
            const currentLabel = currentIdx >= 0 ? priorityLabels[currentIdx] : prospect.priority;

            const choice = prompt(`Changer la temprature de ${prospect.company}:\n(Actuel: ${currentLabel})\n\n1.  Hot\n2. Chaud\n3. Tide\n4. Froid\n\nEntrez le numro:`);
            if (!choice) return;

            const idx = parseInt(choice) - 1;
            if (idx >= 0 && idx < priorities.length) {
                const oldPriority = prospect.priority;
                prospect.priority = priorities[idx];
                prospect.priorityUpdatedAt = Date.now();
                save();
                updateProspectInAirtable(prospect);
                addActivityToProspect(prospect.id, 'note', `Temprature change: ${priorityLabels[priorities.indexOf(oldPriority)] || oldPriority}  ${priorityLabels[idx]}`);
                renderAll();
                showToast(`Temprature mise  jour: ${priorityLabels[idx]}`);
            }
        }

        // Add context menu to pipeline cards
        const originalRenderPipelineStatus = renderPipelineStatus;
        renderPipelineStatus = function() {
            originalRenderPipelineStatus();
            // Add context menu event to cards
            document.querySelectorAll('.pipeline-card').forEach(card => {
                card.addEventListener('contextmenu', (e) => {
                    const id = parseInt(card.dataset.id);
                    showContextMenu(e, id);
                });
            });
        };

        // ============================================
        // ADVANCED STATS (Funnel)
        // ============================================
        function renderFunnelStats() {
            const stages = ['lead', 'contacted', 'meeting', 'proposal', 'won'];
            const labels = ['Lead', 'Contacte', 'RDV/Audit', 'Proposition', 'Gagne'];
            const counts = stages.map(s => prospects.filter(p => p.status === s).length);
            const total = prospects.length || 1;

            // Calculate conversion rates
            const conversions = [];
            for (let i = 0; i < stages.length - 1; i++) {
                const from = counts.slice(i).reduce((a, b) => a + b, 0);
                const to = counts.slice(i + 1).reduce((a, b) => a + b, 0);
                conversions.push(from > 0 ? Math.round((to / from) * 100) : 0);
            }

            return {
                stages: labels,
                counts,
                percentages: counts.map(c => Math.round((c / total) * 100)),
                conversions,
                totalValue: prospects.reduce((sum, p) => sum + (p.value || 0), 0),
                avgTimeInPipeline: '~15 jours' // Placeholder - would need real tracking
            };
        }

        // ============================================
        // FOCUS MODE
        // ============================================
        let isFocusMode = false;

        function toggleFocusMode() {
            isFocusMode = !isFocusMode;
            document.body.classList.toggle('focus-mode', isFocusMode);

            if (isFocusMode) {
                // Hide all other views, show focus view
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById('view-focus').classList.add('active');
                renderFocusMode();
            } else {
                // Return to dashboard
                document.getElementById('view-focus').classList.remove('active');
                document.getElementById('view-dashboard').classList.add('active');
            }
        }

        function renderFocusMode() {
            // Set date
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('focus-date').textContent = new Date().toLocaleDateString('fr-FR', options);

            // Render urgent tasks
            const urgentTasks = allTasks.filter(t => t.priority === 'Urgent' && t.status !== 'Termine');
            const urgentContainer = document.getElementById('focus-urgent-tasks');

            if (urgentTasks.length === 0) {
                urgentContainer.innerHTML = '<div class="empty"><p>Aucune tache urgente</p></div>';
            } else {
                urgentContainer.innerHTML = urgentTasks.map(t => `
                    <div class="focus-task">
                        <div class="focus-task-checkbox" onclick="toggleFocusTask(this)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
                        </div>
                        <div class="focus-task-content">
                            <div class="focus-task-title">${t.title}</div>
                            <div class="focus-task-meta">${t.project || 'PACIFIKAI'}${t.dueDate ? '  Echeance: ' + t.dueDate : ''}</div>
                        </div>
                        <span class="focus-task-priority urgent">Urgent</span>
                    </div>
                `).join('');
            }

            // Render today's follow-ups
            const today = new Date().toISOString().split('T')[0];
            const todayFollowups = prospects.filter(p => p.nextFollowUp === today);
            const followupsContainer = document.getElementById('focus-followups');

            if (todayFollowups.length === 0) {
                followupsContainer.innerHTML = '<div class="empty"><p>Aucune relance prevue aujourd\'hui</p></div>';
            } else {
                followupsContainer.innerHTML = todayFollowups.map(p => `
                    <div class="focus-followup">
                        <div class="focus-followup-avatar">${p.company.substring(0, 2).toUpperCase()}</div>
                        <div class="focus-followup-content">
                            <div class="focus-followup-company">${p.company}</div>
                            <div class="focus-followup-reason">${p.sector}  ${statusLabel(p.status)}</div>
                        </div>
                        <button class="focus-followup-action" onclick="openProspectDetail(${p.id}); toggleFocusMode();">Voir</button>
                    </div>
                `).join('');
            }

            // Pipeline stats
            const stats = renderFunnelStats();
            document.getElementById('focus-pipeline-value').textContent = fmtXPF(stats.totalValue);
            document.getElementById('focus-active-count').textContent = prospects.filter(p => p.status !== 'won').length;
            document.getElementById('focus-proposals').textContent = prospects.filter(p => p.status === 'proposal').length;

            const won = prospects.filter(p => p.status === 'won').length;
            const conversionRate = prospects.length > 0 ? Math.round((won / prospects.length) * 100) : 0;
            document.getElementById('focus-conversion').textContent = conversionRate + '%';
        }

        function toggleFocusTask(el) {
            el.classList.toggle('checked');
        }

        // ============================================
        // ANALYTICS VIEW
        // ============================================

        // Chart.js instances (for cleanup)
        let chartPipelineStatus = null;
        let chartSectors = null;
        let chartTemperature = null;
        let chartValueSector = null;

        function renderAnalyticsView() {
            const stats = renderFunnelStats();

            // KPI Row
            const won = prospects.filter(p => p.status === 'won').length;
            const conversionRate = prospects.length > 0 ? Math.round((won / prospects.length) * 100) : 0;
            const avgValue = prospects.length > 0 ? Math.round(stats.totalValue / prospects.length) : 0;

            document.getElementById('kpi-total').textContent = prospects.length;
            document.getElementById('kpi-pipeline').textContent = fmtXPF(stats.totalValue);
            document.getElementById('kpi-conversion').textContent = conversionRate + '%';
            document.getElementById('kpi-avg').textContent = fmtXPF(avgValue);

            // Destroy existing charts
            if (chartPipelineStatus) chartPipelineStatus.destroy();
            if (chartSectors) chartSectors.destroy();
            if (chartTemperature) chartTemperature.destroy();
            if (chartValueSector) chartValueSector.destroy();

            // Chart.js default config
            const chartColors = {
                accent: '#3b82f6',
                purple: '#a855f7',
                green: '#22c55e',
                yellow: '#eab308',
                red: '#ef4444',
                orange: '#f97316',
                text: '#e2e8f0',
                textMuted: '#64748b',
                border: '#1e293b',
                bg: '#0f172a'
            };

            Chart.defaults.color = chartColors.text;
            Chart.defaults.borderColor = chartColors.border;

            // 1. Pipeline by Status (Bar Chart)
            const statusCounts = {
                'Lead': prospects.filter(p => p.status === 'lead').length,
                'Contacte': prospects.filter(p => p.status === 'contacted').length,
                'RDV': prospects.filter(p => p.status === 'meeting').length,
                'Proposition': prospects.filter(p => p.status === 'proposal').length,
                'Gagne': prospects.filter(p => p.status === 'won').length
            };

            chartPipelineStatus = new Chart(document.getElementById('chart-pipeline-status'), {
                type: 'bar',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        label: 'Prospects',
                        data: Object.values(statusCounts),
                        backgroundColor: [
                            chartColors.textMuted,
                            chartColors.accent,
                            chartColors.purple,
                            chartColors.yellow,
                            chartColors.green
                        ],
                        borderRadius: 6,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 },
                            grid: { color: chartColors.border }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });

            // 2. Sector Distribution (Doughnut)
            const sectorCounts = {};
            prospects.forEach(p => {
                sectorCounts[p.sector] = (sectorCounts[p.sector] || 0) + 1;
            });
            const sectorLabels = Object.keys(sectorCounts);
            const sectorData = Object.values(sectorCounts);
            const sectorColors = sectorLabels.map((_, i) => {
                const hue = (i * 360 / sectorLabels.length + 200) % 360;
                return `hsl(${hue}, 70%, 55%)`;
            });

            chartSectors = new Chart(document.getElementById('chart-sectors'), {
                type: 'doughnut',
                data: {
                    labels: sectorLabels,
                    datasets: [{
                        data: sectorData,
                        backgroundColor: sectorColors,
                        borderWidth: 0,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { boxWidth: 12, padding: 8, font: { size: 11 } }
                        }
                    },
                    cutout: '60%'
                }
            });

            // 3. Temperature Distribution (Polar Area)
            const tempCounts = {
                'Hot': prospects.filter(p => p.priority === 'hot').length,
                'Chaud': prospects.filter(p => p.priority === 'chaud').length,
                'Tiede': prospects.filter(p => p.priority === 'tiede').length,
                'Froid': prospects.filter(p => p.priority === 'froid').length
            };

            chartTemperature = new Chart(document.getElementById('chart-temperature'), {
                type: 'polarArea',
                data: {
                    labels: Object.keys(tempCounts),
                    datasets: [{
                        data: Object.values(tempCounts),
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.7)',   // Hot - red
                            'rgba(249, 115, 22, 0.7)', // Chaud - orange
                            'rgba(234, 179, 8, 0.7)',  // Tiede - yellow
                            'rgba(59, 130, 246, 0.7)'  // Froid - blue
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { boxWidth: 12, padding: 8, font: { size: 11 } }
                        }
                    },
                    scales: {
                        r: {
                            ticks: { display: false },
                            grid: { color: chartColors.border }
                        }
                    }
                }
            });

            // 4. Value by Sector (Horizontal Bar)
            const sectorValues = {};
            prospects.forEach(p => {
                sectorValues[p.sector] = (sectorValues[p.sector] || 0) + (p.value || 0);
            });
            const sortedSectors = Object.entries(sectorValues).sort((a, b) => b[1] - a[1]);

            chartValueSector = new Chart(document.getElementById('chart-value-sector'), {
                type: 'bar',
                data: {
                    labels: sortedSectors.map(s => s[0]),
                    datasets: [{
                        label: 'Valeur (XPF)',
                        data: sortedSectors.map(s => s[1]),
                        backgroundColor: `linear-gradient(90deg, ${chartColors.accent}, ${chartColors.purple})`,
                        backgroundColor: sortedSectors.map((_, i) => {
                            const ratio = i / sortedSectors.length;
                            return `rgba(59, 130, 246, ${1 - ratio * 0.5})`;
                        }),
                        borderRadius: 4,
                        borderSkipped: false
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => fmtXPF(ctx.raw) + ' XPF'
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { color: chartColors.border },
                            ticks: {
                                callback: (val) => fmtXPF(val)
                            }
                        },
                        y: {
                            grid: { display: false }
                        }
                    }
                }
            });

            // 5. Funnel (keep existing)
            const funnelContainer = document.getElementById('analytics-funnel');
            const maxCount = Math.max(...stats.counts, 1);

            funnelContainer.innerHTML = stats.stages.map((stage, i) => {
                const width = (stats.counts[i] / maxCount) * 100;
                const rate = i > 0 && stats.counts[i-1] > 0 ? Math.round((stats.counts[i] / stats.counts[i-1]) * 100) : 100;
                return `
                    <div class="funnel-stage">
                        <div class="funnel-label">${stage}</div>
                        <div class="funnel-bar-wrapper">
                            <div class="funnel-bar" style="width: ${Math.max(width, 5)}%;">
                                ${width > 15 ? `<span class="funnel-value">${stats.counts[i]}</span>` : ''}
                            </div>
                        </div>
                        <div class="funnel-count">${stats.counts[i]} ${i > 0 ? `<span style="color: var(--text-dim); font-size: 0.75rem;">(${rate}%)</span>` : ''}</div>
                    </div>
                `;
            }).join('');
        }

        // Auto-render analytics when switching to that view
        const originalShowView = showView;
        showView = function(name) {
            originalShowView(name);
            if (name === 'analytics') {
                renderAnalyticsView();
            }
        };

        // ============================================
        // INITIALIZATION UPDATES
        // ============================================

        // Initialize notifications on load
        document.addEventListener('DOMContentLoaded', () => {
            renderNotifications();

            // Check task deadlines every minute
            setInterval(checkTaskDeadlines, 60000);
            checkTaskDeadlines();
        });
    </script>
    <style>
        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Small loading spinner for buttons */
        .loading-spinner-small {
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
            margin-right: 6px;
        }

        /* Success notification top-right */
        .success-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(16, 185, 129, 0.1));
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 12px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 10000;
            backdrop-filter: blur(12px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            transform: translateX(120%);
            transition: transform 0.3s ease;
            max-width: 320px;
        }
        .success-notification.show {
            transform: translateX(0);
        }
        .success-notification-icon {
            width: 36px;
            height: 36px;
            background: rgba(34, 197, 94, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .success-notification-icon svg {
            width: 18px;
            height: 18px;
            stroke: #22c55e;
        }
        .success-notification-title {
            font-weight: 600;
            font-size: 0.875rem;
            color: #22c55e;
        }
        .success-notification-subtitle {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 2px;
        }
    </style>

    <!-- Global Search Overlay -->
    <div class="search-overlay" id="search-overlay" onclick="closeGlobalSearch(event)">
        <div class="search-modal" onclick="event.stopPropagation()">
            <div class="search-input-wrapper">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                <input type="text" class="search-input" id="global-search-input" placeholder="Rechercher prospects, taches, actions..." oninput="handleGlobalSearch(this.value)">
                <span class="search-shortcut">ESC</span>
            </div>
            <div class="search-results" id="search-results">
                <div class="search-section">
                    <div class="search-section-title">Actions Rapides</div>
                    <div class="search-result" onclick="executeSearchAction('new-prospect')">
                        <div class="search-result-icon action"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></div>
                        <div class="search-result-content">
                            <div class="search-result-title">Nouveau prospect</div>
                            <div class="search-result-meta">Ouvrir Airtable pour ajouter</div>
                        </div>
                    </div>
                    <div class="search-result" onclick="executeSearchAction('focus')">
                        <div class="search-result-icon action"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg></div>
                        <div class="search-result-content">
                            <div class="search-result-title">Mode Focus</div>
                            <div class="search-result-meta">Vue concentree sur les taches du jour</div>
                        </div>
                    </div>
                    <div class="search-result" onclick="executeSearchAction('sync')">
                        <div class="search-result-icon action"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg></div>
                        <div class="search-result-content">
                            <div class="search-result-title">Synchroniser Airtable</div>
                            <div class="search-result-meta">Rafraichir les donnees</div>
                        </div>
                    </div>
                </div>
                <div class="search-section" id="search-prospects-section" style="display:none;">
                    <div class="search-section-title">Prospects</div>
                    <div id="search-prospects-results"></div>
                </div>
                <div class="search-section" id="search-tasks-section" style="display:none;">
                    <div class="search-section-title">Taches</div>
                    <div id="search-tasks-results"></div>
                </div>
            </div>
            <div class="search-footer">
                <span><kbd></kbd><kbd></kbd> Navigation</span>
                <span><kbd></kbd> Selectionner</span>
                <span><kbd>ESC</kbd> Fermer</span>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="context-menu">
        <div class="context-menu-item" onclick="contextMenuAction('change-status')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            Changer le statut
        </div>
        <div class="context-menu-item" onclick="contextMenuAction('change-priority')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
            Changer la priorite
        </div>
        <div class="context-menu-item" onclick="contextMenuAction('add-note')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
            Ajouter une note
        </div>
        <div class="context-menu-item" onclick="contextMenuAction('create-task')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="9" y1="9" x2="15" y2="15"/><line x1="15" y1="9" x2="9" y2="15"/></svg>
            Creer une tache liee
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="contextMenuAction('send-email')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
            Envoyer un email
        </div>
        <div class="context-menu-item" onclick="contextMenuAction('schedule-followup')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
            Planifier relance
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="contextMenuAction('open-detail')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
            Voir les details
        </div>
    </div>

    <!-- Focus Mode View -->
    <div class="view" id="view-focus">
        <header class="header">
            <div class="header-left">
                <h1>Mode Focus</h1>
                <p>Concentre-toi sur l'essentiel</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-ghost" onclick="toggleFocusMode()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    Quitter Focus
                </button>
            </div>
        </header>
        <div class="content">
            <div class="focus-panel">
                <div class="focus-header">
                    <div class="focus-date" id="focus-date"></div>
                    <div class="focus-greeting">Bonjour Jordy, voici ton plan du jour</div>
                </div>

                <!-- Urgent Tasks -->
                <div class="focus-section">
                    <div class="focus-section-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                        Taches Urgentes
                    </div>
                    <div id="focus-urgent-tasks"></div>
                </div>

                <!-- Today's Follow-ups -->
                <div class="focus-section">
                    <div class="focus-section-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                        Relances Prevues Aujourd'hui
                    </div>
                    <div id="focus-followups"></div>
                </div>

                <!-- Pipeline Summary -->
                <div class="focus-section">
                    <div class="focus-section-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                        Apercu Pipeline
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card-mini">
                            <div class="stat-card-mini-label">Valeur Pipeline</div>
                            <div class="stat-card-mini-value" id="focus-pipeline-value">0 XPF</div>
                        </div>
                        <div class="stat-card-mini">
                            <div class="stat-card-mini-label">Prospects Actifs</div>
                            <div class="stat-card-mini-value" id="focus-active-count">0</div>
                        </div>
                        <div class="stat-card-mini">
                            <div class="stat-card-mini-label">Propositions en cours</div>
                            <div class="stat-card-mini-value" id="focus-proposals">0</div>
                        </div>
                        <div class="stat-card-mini">
                            <div class="stat-card-mini-label">Taux de conversion</div>
                            <div class="stat-card-mini-value" id="focus-conversion">0%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics View -->
    <div class="view" id="view-analytics">
        <header class="header">
            <div class="header-left">
                <h1>Analytics</h1>
                <p>Performance du pipeline commercial</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-ghost" onclick="renderAnalyticsView()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                    Rafraichir
                </button>
            </div>
        </header>
        <div class="content">
            <!-- KPI Summary -->
            <div class="analytics-kpi-row" id="analytics-kpi-row">
                <div class="analytics-kpi">
                    <div class="analytics-kpi-value" id="kpi-total">0</div>
                    <div class="analytics-kpi-label">Total Prospects</div>
                </div>
                <div class="analytics-kpi">
                    <div class="analytics-kpi-value" id="kpi-pipeline" style="color: var(--green);">0</div>
                    <div class="analytics-kpi-label">Pipeline Total</div>
                </div>
                <div class="analytics-kpi">
                    <div class="analytics-kpi-value" id="kpi-conversion">0%</div>
                    <div class="analytics-kpi-label">Taux Conversion</div>
                </div>
                <div class="analytics-kpi">
                    <div class="analytics-kpi-value" id="kpi-avg">0</div>
                    <div class="analytics-kpi-label">Valeur Moyenne</div>
                </div>
            </div>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                <!-- Pipeline by Status (Bar Chart) -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                            Pipeline par Status
                        </div>
                    </div>
                    <div class="card-body" style="height: 280px;">
                        <canvas id="chart-pipeline-status"></canvas>
                    </div>
                </div>

                <!-- Sector Distribution (Doughnut Chart) -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
                            Repartition par Secteur
                        </div>
                    </div>
                    <div class="card-body" style="height: 280px;">
                        <canvas id="chart-sectors"></canvas>
                    </div>
                </div>

                <!-- Temperature Distribution (Polar Area) -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"/></svg>
                            Temperature des Prospects
                        </div>
                    </div>
                    <div class="card-body" style="height: 280px;">
                        <canvas id="chart-temperature"></canvas>
                    </div>
                </div>

                <!-- Conversion Funnel -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
                            Entonnoir de Conversion
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="funnel-container" id="analytics-funnel"></div>
                    </div>
                </div>

                <!-- Value by Sector (Horizontal Bar) -->
                <div class="card" style="grid-column: span 2;">
                    <div class="card-header">
                        <div class="card-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                            Valeur Pipeline par Secteur (XPF)
                        </div>
                    </div>
                    <div class="card-body" style="height: 250px;">
                        <canvas id="chart-value-sector"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
