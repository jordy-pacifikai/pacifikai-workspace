<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head><meta name="build-time" content="1769994207">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PACIFIK'AI | Dashboard</title>
    <link rel="icon" type="image/png" href="https://pacifikai.com/assets/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        /* ========================================
           LINEAR DARK DESIGN SYSTEM
           Inspired by Linear.app - Ultra-clean, modern
           Dark Mode Default - Electric Blue Accents
           ======================================== */

        :root {
            /* ========================================
               THEME ENELYS - Elegant Light Dashboard
               Inspired by Pinterest reference image
               ======================================== */

            /* Sidebar - Teal foncé profond */
            --sidebar-bg: #1a3a3a;
            --sidebar-bg-hover: #234747;
            --sidebar-text: #ffffff;
            --sidebar-text-muted: #a3bfbf;
            --sidebar-active-bg: rgba(255, 255, 255, 0.1);
            --sidebar-accent: #4a7c7c;

            /* Fond principal - Crème/Beige clair */
            --bg: #f8f6f3;
            --bg-subtle: #f5f3f0;
            --bg-muted: #efecea;
            --bg-hover: #e8e5e0;
            --bg-elevated: #ffffff;

            /* Bordures */
            --border: #e8e5e0;
            --border-subtle: #f0ede8;
            --border-hover: #d5d0c8;

            /* Texte */
            --text: #1a1a1a;
            --text-secondary: #4a4a4a;
            --text-muted: #8a8a8a;
            --text-dim: #b0b0b0;

            /* Accent - Teal (couleur principale) */
            --accent: #1a3a3a;
            --accent-secondary: #4a7c7c;
            --accent-glow: rgba(26, 58, 58, 0.20);
            --accent-gradient: linear-gradient(135deg, #1a3a3a 0%, #4a7c7c 100%);

            /* Accent Or/Doré pour montants */
            --gold: #c9a962;
            --gold-glow: rgba(201, 169, 98, 0.25);

            /* Status Colors - Adoucies */
            --green: #4a9e6a;
            --green-muted: #3d8559;
            --green-glow: rgba(74, 158, 106, 0.25);
            --yellow: #d4a84a;
            --yellow-glow: rgba(212, 168, 74, 0.25);
            --orange: #d4884a;
            --orange-glow: rgba(212, 136, 74, 0.25);
            --red: #c45a5a;
            --red-muted: #a84a4a;
            --red-glow: rgba(196, 90, 90, 0.25);
            --blue: #5a8ec4;
            --blue-glow: rgba(90, 142, 196, 0.25);
            --purple: #7a6ec4;
            --purple-glow: rgba(122, 110, 196, 0.25);
            --cyan: #5aacb8;
            --cyan-glow: rgba(90, 172, 184, 0.25);

            /* Vert Sauge (accent secondaire) */
            --sage: #7a9e7a;
            --sage-glow: rgba(122, 158, 122, 0.25);

            /* Shadows - Plus douces et légères */
            --shadow-xs: 0 1px 2px rgba(0,0,0,0.03);
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.06);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.08);
            --shadow-xl: 0 16px 48px rgba(0,0,0,0.10);
            --shadow-glow: 0 0 30px rgba(26, 58, 58, 0.08);
            --shadow-accent: 0 0 20px rgba(26, 58, 58, 0.12);

            /* Timing - Snappy and responsive */
            --transition-fast: 100ms ease;
            --transition-normal: 200ms ease;
            --transition-slow: 300ms ease;
            --transition-spring: 300ms cubic-bezier(0.34, 1.56, 0.64, 1);

            /* Radius - Coins arrondis modernes */
            --radius-xs: 4px;
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-2xl: 20px;
            --radius-full: 9999px;

            /* Glass effect - Très léger pour thème clair */
            --glass-bg: rgba(255, 255, 255, 0.92);
            --glass-border: rgba(0, 0, 0, 0.04);
            --glass-blur: blur(12px);

            /* Typography - Inter (clean, modern) */
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            --font-mono: 'JetBrains Mono', 'SF Mono', 'Fira Code', monospace;
        }

        /* Dark Mode - Linear Style */
        [data-theme="dark"] {
            --bg: #0A0A0B;
            --bg-subtle: #111113;
            --bg-muted: #18181B;
            --bg-hover: #1F1F23;
            --bg-elevated: #141416;
            --border: #27272A;
            --border-subtle: #1E1E21;
            --border-hover: #3F3F46;
            --text: #FAFAFA;
            --text-secondary: #A1A1AA;
            --text-muted: #71717A;
            --text-dim: #52525B;

            /* Accent - Electric Blue */
            --accent: #5E6AD2;
            --accent-secondary: #6E7AE2;
            --accent-glow: rgba(94, 106, 210, 0.15);
            --accent-gradient: linear-gradient(135deg, #5E6AD2 0%, #8B5CF6 100%);

            /* Or/Doré */
            --gold: #EAB308;
            --gold-glow: rgba(234, 179, 8, 0.15);

            /* Status Colors - Vibrant */
            --green: #22C55E;
            --green-muted: #16A34A;
            --green-glow: rgba(34, 197, 94, 0.15);
            --yellow: #EAB308;
            --yellow-glow: rgba(234, 179, 8, 0.15);
            --orange: #F97316;
            --orange-glow: rgba(249, 115, 22, 0.15);
            --red: #EF4444;
            --red-muted: #DC2626;
            --red-glow: rgba(239, 68, 68, 0.15);
            --blue: #3B82F6;
            --blue-glow: rgba(59, 130, 246, 0.15);
            --purple: #8B5CF6;
            --purple-glow: rgba(139, 92, 246, 0.15);
            --cyan: #06B6D4;
            --cyan-glow: rgba(6, 182, 212, 0.15);
            --sage: #22C55E;
            --sage-glow: rgba(34, 197, 94, 0.15);

            /* Shadows - Dark mode */
            --shadow-xs: 0 1px 2px rgba(0,0,0,0.3);
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.4);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.5);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.6);
            --shadow-xl: 0 16px 48px rgba(0,0,0,0.7);

            /* Glass effect - Dark */
            --glass-bg: rgba(17, 17, 19, 0.85);
            --glass-border: rgba(255, 255, 255, 0.06);

            /* Sidebar - Teal sombre */
            --sidebar-bg: #0d2626;
            --sidebar-bg-hover: #153838;
            --sidebar-active-bg: #1a4a4a;
        }

        /* Reset transitions for specific properties */
        *, *::before, *::after {
            transition: background-color var(--transition-normal),
                        border-color var(--transition-fast),
                        box-shadow var(--transition-normal),
                        color var(--transition-fast),
                        opacity var(--transition-fast);
        }

        /* Focus states - Linear style */
        :focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: var(--radius-full);
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--border-hover);
        }

        body {
            font-family: var(--font-sans);
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-feature-settings: 'ss01', 'ss02', 'cv01';
            letter-spacing: -0.01em;
        }

        /* Linear Typography - Clean sans-serif throughout */
        h1, h2, h3, .card-title, .modal-title, .header-left h1 {
            font-family: var(--font-sans);
            font-weight: 600;
            letter-spacing: -0.025em;
        }

        /* Layout */
        .layout {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar - Enelys Style (Teal foncé) */
        .sidebar {
            width: 240px;
            background: var(--sidebar-bg);
            border-right: none;
            padding: 0;
            position: fixed;
            height: 100vh;
            display: flex;
            flex-direction: column;
            z-index: 100;
            transition: width var(--transition-normal);
        }

        .sidebar-header {
            padding: 1.25rem 1rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            position: relative;
        }

        /* Sidebar Toggle Button */
        .sidebar-toggle {
            position: absolute;
            top: 1.25rem;
            right: 0.75rem;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            color: var(--sidebar-text-muted);
            transition: all var(--transition-fast);
            opacity: 0;
        }
        .sidebar:hover .sidebar-toggle,
        .sidebar.collapsed .sidebar-toggle {
            opacity: 1;
        }
        .sidebar-toggle:hover {
            background: var(--sidebar-bg-hover);
            color: var(--sidebar-text);
        }
        .sidebar.collapsed .sidebar-toggle svg {
            transform: rotate(180deg);
        }

        /* Sidebar Collapsed State */
        .sidebar.collapsed {
            width: 56px;
        }
        .sidebar.collapsed .logo-text,
        .sidebar.collapsed .nav-label,
        .sidebar.collapsed .nav-badge,
        .sidebar.collapsed .user-info {
            display: none;
        }
        .sidebar.collapsed .logo {
            justify-content: center;
            padding: 0.5rem;
        }
        /* Hide logo image in collapsed, show P icon */
        .sidebar.collapsed .logo-img {
            display: none;
        }
        .sidebar.collapsed .logo::after {
            content: 'P';
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--sidebar-text);
            font-family: var(--font-sans);
        }
        /* Reposition toggle in collapsed mode */
        .sidebar.collapsed .sidebar-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.75rem 0.5rem;
        }
        .sidebar.collapsed .sidebar-toggle {
            position: static;
            margin-top: 0.5rem;
            opacity: 1;
        }
        .sidebar.collapsed .nav {
            padding-left: 0;
            padding-right: 0;
        }
        .sidebar.collapsed .nav-item {
            width: 40px;
            height: 40px;
            margin: 0.25rem auto;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0;
            overflow: hidden;
            white-space: nowrap;
            border-radius: var(--radius-md);
        }
        .sidebar.collapsed .nav-item.active::before {
            display: none;
        }
        .sidebar.collapsed .nav-item svg {
            margin: 0;
            width: 20px;
            height: 20px;
        }
        .sidebar.collapsed .user {
            justify-content: center;
            padding: 0.5rem;
        }
        .sidebar.collapsed .logout-btn {
            display: none;
        }

        /* Adjust main content when sidebar collapsed */
        .layout.sidebar-collapsed .main {
            margin-left: 56px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            border-radius: var(--radius-md);
            transition: background var(--transition-fast);
        }

        .logo:hover {
            background: var(--sidebar-bg-hover);
        }

        .logo-img {
            height: 28px;
            width: auto;
            object-fit: contain;
            filter: brightness(0) invert(1);
        }

        .logo-text {
            font-family: var(--font-sans);
            font-size: 0.9375rem;
            font-weight: 600;
            letter-spacing: -0.01em;
            color: var(--sidebar-text);
        }

        .nav {
            flex: 1;
            padding: 0.75rem 0.5rem;
            overflow-y: auto;
        }

        /* Sidebar scrollbar - Glassy subtle */
        .nav::-webkit-scrollbar {
            width: 4px;
        }
        .nav::-webkit-scrollbar-track {
            background: transparent;
        }
        .nav::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: var(--radius-full);
        }
        .nav::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .nav-group {
            margin-bottom: 1rem;
        }

        .nav-label {
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--sidebar-text-muted);
            padding: 0.5rem 0.75rem 0.375rem;
            margin-bottom: 0.125rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius-md);
            color: var(--sidebar-text-muted);
            text-decoration: none;
            font-size: 0.8125rem;
            font-weight: 500;
            transition: all var(--transition-fast);
            cursor: pointer;
            margin: 0.125rem 0;
            position: relative;
        }

        .nav-item:hover {
            color: var(--sidebar-text);
        }
        .nav-item:hover svg {
            color: var(--gold);
            opacity: 1;
        }

        .nav-item.active {
            color: var(--sidebar-text);
        }

        .nav-item.active::before {
            display: none;
        }

        .nav-item svg {
            width: 18px;
            height: 18px;
            opacity: 0.7;
            flex-shrink: 0;
        }

        .nav-item:hover svg { opacity: 1; }
        .nav-item.active svg { opacity: 1; color: var(--gold); }

        .nav-badge {
            margin-left: auto;
            font-size: 0.625rem;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.2);
            color: var(--sidebar-text);
            padding: 0.125rem 0.5rem;
            border-radius: var(--radius-full);
        }

        .sidebar-footer {
            padding: 0.75rem;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(0, 0, 0, 0.1);
        }

        .user {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            border-radius: var(--radius-md);
            transition: background var(--transition-fast);
        }

        .user:hover {
            background: var(--sidebar-bg-hover);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #0d4040 0%, #1a6b6b 50%, #2d8a8a 100%);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .user-info { flex: 1; min-width: 0; }
        .user-name {
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--sidebar-text);
        }
        .user-role {
            font-size: 0.6875rem;
            color: var(--sidebar-text-muted);
        }

        .logout-btn {
            background: transparent;
            border: none;
            color: var(--sidebar-text-muted);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--radius-md);
            opacity: 0;
            transition: all var(--transition-fast);
        }

        .logout-btn svg {
            width: 16px;
            height: 16px;
        }

        .user:hover .logout-btn { opacity: 1; }
        .logout-btn:hover {
            background: rgba(196, 90, 90, 0.2);
            color: #ff8a8a;
        }

        /* Main - Enelys Style */
        .main {
            flex: 1;
            margin-left: 240px;
            min-height: 100vh;
            background: var(--bg);
            overflow-x: hidden;
        }

        /* Header - Enelys Style (Clean, Light) */
        .header {
            padding: 1.25rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            background: var(--bg-elevated);
            z-index: 50;
            box-shadow: var(--shadow-sm);
        }

        .header-left {
            display: flex;
            flex-direction: column;
            gap: 0.125rem;
        }

        .header-left h1 {
            font-size: 1.125rem;
            font-weight: 600;
            letter-spacing: -0.02em;
            color: var(--text);
        }

        .header-left p {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        /* Theme Toggle Button */
        .theme-toggle {
            width: 34px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            color: var(--text-muted);
            transition: all var(--transition-fast);
        }
        .theme-toggle:hover {
            background: var(--bg-hover);
            color: var(--text);
            border-color: var(--border-hover);
        }
        .theme-toggle svg {
            width: 16px;
            height: 16px;
        }
        [data-theme="light"] .icon-sun { display: none; }
        [data-theme="light"] .icon-moon { display: block; }
        [data-theme="dark"] .icon-sun { display: block; }
        [data-theme="dark"] .icon-moon { display: none; }

        /* Buttons - Vercel Style */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.5rem 0.875rem;
            font-size: 0.8125rem;
            font-weight: 500;
            border-radius: var(--radius-md);
            border: none;
            cursor: pointer;
            transition: all var(--transition-fast);
            font-family: inherit;
            text-decoration: none;
            white-space: nowrap;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn svg { width: 15px; height: 15px; flex-shrink: 0; }

        .btn-primary {
            background: var(--accent);
            color: white;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--accent);
        }

        .btn-primary:hover {
            background: var(--accent-secondary);
            border-color: var(--accent-secondary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-success {
            background: var(--green);
            color: white;
            border: 1px solid var(--green);
        }

        .btn-success:hover {
            background: var(--green-muted);
            border-color: var(--green-muted);
            box-shadow: var(--shadow-sm);
        }

        .btn-danger {
            background: var(--red);
            color: white;
            border: 1px solid var(--red);
        }

        .btn-danger:hover {
            background: var(--red-muted);
            border-color: var(--red-muted);
            box-shadow: var(--shadow-sm);
        }

        .btn-ghost {
            background: var(--bg-elevated);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .btn-ghost:hover {
            background: var(--bg-hover);
            color: var(--text);
            border-color: var(--border-hover);
        }

        .btn-icon {
            padding: 0.5rem;
            border-radius: var(--radius-md);
            background: var(--bg-elevated);
            color: var(--text-muted);
            border: 1px solid var(--border);
        }

        .btn-icon:hover {
            background: var(--bg-hover);
            color: var(--accent);
            border-color: var(--border-hover);
        }

        .btn-sm {
            padding: 0.375rem 0.625rem;
            font-size: 0.75rem;
        }

        .btn-sm svg {
            width: 13px;
            height: 13px;
        }

        .btn-lg {
            padding: 0.75rem 1.25rem;
            font-size: 0.875rem;
        }

        /* Filter Select */
        .filter-select {
            padding: 0.5rem 0.875rem;
            font-size: 0.8125rem;
            font-weight: 500;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            background: var(--bg-subtle);
            color: var(--text);
            cursor: pointer;
            font-family: inherit;
            transition: all var(--transition-fast);
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2371717a' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            padding-right: 2rem;
        }

        .filter-select:hover {
            border-color: var(--border-hover);
            background-color: var(--bg-hover);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        /* Content */
        .content {
            padding: 1.5rem;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Stats Row - Modern KPI Cards */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
            transition: all var(--transition-normal);
        }

        .stat:hover {
            border-color: var(--border-hover);
            box-shadow: var(--shadow-md);
        }

        .stat-label {
            font-size: 0.6875rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .stat-label svg { width: 12px; height: 12px; }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            letter-spacing: -0.03em;
            color: var(--text);
        }

        .stat-value.green { color: var(--green); }
        .stat-value.blue { color: var(--accent); }
        .stat-value.purple { color: var(--purple); }
        .stat-value.yellow { color: var(--yellow); }

        .stat-change {
            font-size: 0.6875rem;
            font-weight: 500;
            margin-top: 0.375rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .stat-change.up { color: var(--green); }
        .stat-change.down { color: var(--red); }

        /* Task Stat Cards */
        .stat-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1rem 1.25rem;
            transition: all var(--transition-normal);
        }

        .stat-card:hover {
            border-color: var(--border-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            min-width: 40px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-sm);
        }

        .stat-icon svg {
            width: 20px;
            height: 20px;
            stroke: white;
        }

        .stat-info {
            display: flex;
            flex-direction: column;
            gap: 0.125rem;
        }

        .stat-info .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            line-height: 1.2;
        }

        .stat-info .stat-label {
            font-size: 0.6875rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.04em;
            margin-bottom: 0;
        }

        /* Grid */
        .grid {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 1.25rem;
        }

        .grid-full { grid-column: 1 / -1; }

        /* Card - Glass Effect */
        .card {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            transition: all var(--transition-normal);
        }

        .card:hover {
            border-color: var(--border-hover);
        }

        .card-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-subtle);
        }

        .card-title {
            font-size: 0.8125rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text);
        }

        .card-title svg {
            width: 16px;
            height: 16px;
            color: var(--accent);
            opacity: 0.8;
        }

        .card-actions {
            display: flex;
            gap: 0.375rem;
        }

        .card-btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.6875rem;
            font-weight: 500;
            background: var(--bg-hover);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-family: inherit;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .card-btn:hover {
            background: var(--bg-muted);
            color: var(--text);
            border-color: var(--border-hover);
        }

        .card-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .card-body {
            padding: 1rem 1.25rem;
        }

        .card-body.flush {
            padding: 0;
        }

        /* Pipeline Kanban - Modern Linear Style */
        .pipeline {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.75rem;
            padding: 1rem 1.25rem;
        }

        /* Task Kanban (4 columns: A faire, En cours, Bloque, Termine) */
        #task-kanban {
            grid-template-columns: repeat(4, 1fr);
        }

        .pipeline-col {
            background: var(--bg);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: 0.875rem;
            min-height: 200px;
            min-width: 0;
            transition: all var(--transition-normal);
        }

        .pipeline-col:hover {
            border-color: var(--border);
        }

        .pipeline-col.drag-over {
            background: var(--accent-glow);
            border: 1px dashed var(--accent);
            box-shadow: inset 0 0 20px var(--accent-glow);
        }

        /* Task Kanban Columns */
        .pipeline-column {
            background: var(--bg);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: 0.875rem;
            min-height: 300px;
            min-width: 0;
            display: flex;
            flex-direction: column;
            transition: all var(--transition-normal);
        }

        .pipeline-cards {
            flex: 1;
            min-height: 100px;
            padding: 0.25rem;
        }

        .pipeline-cards.drag-over,
        .pipeline-column.drag-over {
            background: var(--accent-glow);
            border: 1px dashed var(--accent);
            border-radius: var(--radius-md);
        }

        .task-card.dragging {
            opacity: 0.6;
            transform: rotate(2deg) scale(1.02);
        }

        .task-view-btn.active {
            background: var(--accent) !important;
            color: white !important;
        }

        .task-list-row {
            border-bottom: 1px solid var(--border-subtle);
            transition: background 0.15s;
            font-size: 0.8rem;
        }
        .task-list-row:hover {
            background: var(--bg-muted);
        }
        .task-list-row td {
            padding: 0.5rem;
            vertical-align: middle;
        }
        .task-list-row.overdue {
            border-left: 3px solid var(--red);
        }
        .task-list-checkbox {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid var(--border);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            background: transparent;
        }
        .task-list-checkbox:hover {
            border-color: var(--green);
            background: var(--green-glow);
        }
        .task-list-checkbox.done {
            border-color: var(--green);
            background: var(--green);
        }
        .quick-priority {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.15s;
        }
        .quick-priority:hover { opacity: 0.8; }
        .quick-priority.Urgent { background: var(--red-glow); color: var(--red); }
        .quick-priority.Normal { background: var(--accent-glow); color: var(--accent); }
        .quick-priority.Faible { background: var(--bg-muted); color: var(--text-muted); }

        .task-kanban-overdue {
            border-left: 3px solid var(--red) !important;
        }

        .pipeline-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.875rem;
            padding-bottom: 0.625rem;
            border-bottom: 1px solid var(--border-subtle);
        }

        .pipeline-title {
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--text-muted);
        }

        .pipeline-count {
            font-size: 0.625rem;
            font-weight: 700;
            background: var(--bg-muted);
            padding: 0.1875rem 0.5rem;
            border-radius: var(--radius-full);
            color: var(--text-secondary);
        }

        .pipeline-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 0.875rem;
            margin-bottom: 0.5rem;
            cursor: grab;
            transition: all var(--transition-fast);
            user-select: none;
            position: relative;
        }

        .pipeline-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--accent);
            border-radius: var(--radius-md) 0 0 var(--radius-md);
            opacity: 0;
            transition: opacity var(--transition-fast);
        }

        .pipeline-card:hover {
            border-color: var(--border-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
            background: var(--bg-hover);
        }

        .pipeline-card:hover::before {
            opacity: 1;
        }

        .pipeline-card.dragging {
            opacity: 0.8;
            transform: rotate(2deg) scale(1.03);
            cursor: grabbing;
            box-shadow: var(--shadow-lg);
            z-index: 100;
            border-color: var(--accent);
        }

        .pipeline-card-name {
            font-size: 0.8125rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text);
        }

        .pipeline-card-company {
            font-size: 0.6875rem;
            color: var(--text-muted);
            margin-bottom: 0.625rem;
        }

        .pipeline-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border-subtle);
        }

        .pipeline-card-value {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--green);
        }

        .pipeline-card-date {
            font-size: 0.625rem;
            color: var(--text-dim);
        }

        /* Kanban Temperature - Linear Style */
        .kanban-temp {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            padding: 1rem 0;
        }

        .kanban-col {
            background: var(--bg-subtle);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: 1rem;
            min-height: 300px;
            transition: all var(--transition-normal);
        }

        .kanban-col:hover {
            border-color: var(--border-hover);
            background: var(--bg);
        }

        .kanban-col.drag-over {
            background: var(--accent-glow);
            border: 2px dashed var(--accent);
            box-shadow: inset 0 0 40px var(--accent-glow), 0 0 20px var(--accent-glow);
        }

        .kanban-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border);
            position: relative;
        }

        .kanban-header::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 40px;
            height: 2px;
            border-radius: 2px;
        }

        .kanban-header.hot { border-bottom-color: transparent; }
        .kanban-header.hot::after { background: linear-gradient(90deg, var(--red), transparent); width: 60px; }
        .kanban-header.chaud { border-bottom-color: transparent; }
        .kanban-header.chaud::after { background: linear-gradient(90deg, var(--orange), transparent); width: 60px; }
        .kanban-header.tiede { border-bottom-color: transparent; }
        .kanban-header.tiede::after { background: linear-gradient(90deg, var(--yellow), transparent); width: 60px; }
        .kanban-header.froid { border-bottom-color: transparent; }
        .kanban-header.froid::after { background: linear-gradient(90deg, var(--blue), transparent); width: 60px; }

        .kanban-title {
            font-size: 0.8125rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .kanban-title.hot { color: var(--red); }
        .kanban-title.chaud { color: var(--orange); }
        .kanban-title.tiede { color: var(--yellow); }
        .kanban-title.froid { color: var(--blue); }

        .kanban-stats {
            display: flex;
            gap: 0.625rem;
            font-size: 0.6875rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .kanban-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1rem;
            margin-bottom: 0.625rem;
            cursor: grab;
            transition: all var(--transition-normal);
            user-select: none;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .kanban-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--accent);
            border-radius: var(--radius-lg) 0 0 var(--radius-lg);
            opacity: 0;
            transition: opacity var(--transition-fast);
        }

        .kanban-card:hover {
            border-color: var(--border-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            background: var(--bg-elevated);
        }

        .kanban-card:hover::before {
            opacity: 1;
        }

        .kanban-card.dragging {
            opacity: 0.7;
            transform: rotate(2deg) scale(1.02);
            cursor: grabbing;
            box-shadow: var(--shadow-xl);
            z-index: 100;
        }

        .kanban-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
            gap: 0.5rem;
        }

        .kanban-card-company {
            font-size: 0.875rem;
            font-weight: 600;
            flex: 1;
            color: var(--text);
            line-height: 1.3;
        }

        .kanban-card-status {
            font-size: 0.5625rem;
            font-weight: 700;
            padding: 0.1875rem 0.5rem;
            border-radius: var(--radius-full);
            text-transform: uppercase;
            letter-spacing: 0.03em;
            flex-shrink: 0;
        }

        .kanban-card-contact {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .kanban-card-sector {
            font-size: 0.6875rem;
            color: var(--text-muted);
            margin-bottom: 0.625rem;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .kanban-card-sector::before {
            content: '';
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--accent);
            opacity: 0.6;
        }

        .kanban-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 0.625rem;
            border-top: 1px solid var(--border-subtle);
            margin-top: 0.5rem;
        }

        .kanban-card-value {
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--green);
        }

        /* Table */
        .table-wrap { overflow-x: auto; }

        table { width: 100%; border-collapse: collapse; }

        th {
            text-align: left;
            padding: 0.625rem 1rem;
            font-size: 0.6875rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-dim);
            background: var(--bg);
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 0.75rem 1rem;
            font-size: 0.8125rem;
            border-bottom: 1px solid var(--border);
        }

        tr:hover td { background: var(--bg-muted); }
        tr:last-child td { border-bottom: none; }

        .cell-name {
            display: flex;
            align-items: center;
            gap: 0.625rem;
        }

        .avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6875rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .avatar.blue { background: var(--accent-glow); color: var(--accent); }
        .avatar.green { background: var(--green-glow); color: var(--green); }
        .avatar.purple { background: var(--purple-glow); color: var(--purple); }
        .avatar.orange { background: var(--orange-glow); color: var(--orange); }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.6875rem;
            font-weight: 500;
            border-radius: 4px;
        }

        .badge-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: currentColor;
        }

        .badge.lead { background: var(--accent-glow); color: var(--accent); }
        .badge.contacted { background: var(--yellow-glow); color: var(--yellow); }
        .badge.meeting { background: var(--purple-glow); color: var(--purple); }
        .badge.proposal { background: var(--orange-glow); color: var(--orange); }
        .badge.won { background: var(--green-glow); color: var(--green); }
        .badge.lost { background: var(--red-glow); color: var(--red); }
        .badge.hot { background: var(--red-glow); color: var(--red); }
        .badge.chaud { background: var(--orange-glow); color: var(--orange); }
        .badge.tiede { background: var(--yellow-glow); color: var(--yellow); }
        .badge.froid { background: var(--accent-glow); color: var(--accent); }

        .pipeline-card-priority {
            font-size: 0.625rem;
            font-weight: 600;
            padding: 0.125rem 0.375rem;
            border-radius: 3px;
            text-transform: uppercase;
        }
        .pipeline-card-priority.hot { background: var(--red-glow); color: var(--red); }
        .pipeline-card-priority.chaud { background: var(--orange-glow); color: var(--orange); }
        .pipeline-card-priority.tiede { background: var(--yellow-glow); color: var(--yellow); }
        .pipeline-card-priority.froid { background: var(--accent-glow); color: var(--accent); }

        /* Asset indicators */
        .asset-icons {
            display: inline-flex;
            gap: 0.25rem;
            margin-left: 0.5rem;
        }
        .asset-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 4px;
            font-size: 0.625rem;
            cursor: help;
            position: relative;
            transition: transform 0.15s ease;
        }
        .asset-icon:hover {
            transform: scale(1.15);
        }
        .asset-icon.site { background: var(--purple-glow); color: var(--purple); }
        .asset-icon.dashboard { background: var(--green-glow); color: var(--green); }
        .asset-icon.workflow { background: var(--orange-glow); color: var(--orange); }
        .asset-icon.doc { background: var(--accent-glow); color: var(--accent); }

        /* Tooltip for asset icons */
        .asset-icon::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: calc(100% + 6px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 0.6875rem;
            font-weight: 500;
            padding: 0.375rem 0.5rem;
            border-radius: 6px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.15s ease, visibility 0.15s ease;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
            z-index: 100;
        }
        .asset-icon::before {
            content: '';
            position: absolute;
            bottom: calc(100% + 2px);
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-top-color: var(--border);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.15s ease, visibility 0.15s ease;
            z-index: 100;
        }
        .asset-icon:hover::after,
        .asset-icon:hover::before {
            opacity: 1;
            visibility: visible;
        }

        .pipeline-card-assets {
            display: flex;
            gap: 0.25rem;
            margin-top: 0.375rem;
        }
        .pipeline-card-assets .asset-icon {
            width: 16px;
            height: 16px;
            font-size: 0.5rem;
        }

        /* Checklist */
        .checklist { list-style: none; }

        .checklist-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }

        .checklist-item:last-child { border-bottom: none; }

        .checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border-subtle);
            border-radius: 4px;
            flex-shrink: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            margin-top: 1px;
        }

        .checkbox:hover { border-color: var(--accent); }
        .checkbox.checked { background: var(--green); border-color: var(--green); }
        .checkbox svg { width: 12px; height: 12px; stroke: white; opacity: 0; }
        .checkbox.checked svg { opacity: 1; }

        .checklist-content { flex: 1; min-width: 0; }

        .checklist-title {
            font-size: 0.8125rem;
            font-weight: 500;
            margin-bottom: 0.125rem;
        }

        .checklist-item.done .checklist-title {
            text-decoration: line-through;
            color: var(--text-dim);
        }

        .checklist-desc {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .checklist-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checklist-week {
            font-size: 0.625rem;
            font-weight: 600;
            padding: 0.125rem 0.375rem;
            border-radius: 3px;
            background: var(--bg-muted);
            color: var(--text-dim);
        }

        .checklist-week.current {
            background: var(--accent);
            color: white;
        }

        /* Progress */
        .progress-wrap { margin-bottom: 1rem; }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.375rem;
        }

        .progress-label { font-size: 0.75rem; color: var(--text-muted); }
        .progress-value { font-size: 0.75rem; font-weight: 600; color: var(--accent); }

        .progress-bar {
            height: 6px;
            background: var(--bg-muted);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* Quick Links */
        .quick-links {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .quick-link {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            padding: 0.75rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.8125rem;
            font-weight: 500;
            transition: all 0.15s;
        }

        .quick-link:hover {
            background: var(--bg-muted);
            color: var(--text);
            border-color: var(--border-subtle);
        }

        .quick-link svg { width: 16px; height: 16px; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.25rem;
            padding: 0.5rem;
            background: var(--bg);
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .tab {
            padding: 0.5rem 0.875rem;
            font-size: 0.8125rem;
            font-weight: 500;
            background: transparent;
            border: none;
            border-radius: 4px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.15s;
            font-family: inherit;
        }

        .tab:hover { color: var(--text); }
        .tab.active { background: var(--bg-muted); color: var(--text); }

        /* Views */
        .view { display: none; opacity: 0; }
        .view.active { display: block; animation: fadeInView 0.3s ease forwards; }

        @keyframes fadeInView {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* IA Tool Iframe View */
        .ia-tool-frame-container {
            height: calc(100vh - 60px);
            width: 100%;
            position: relative;
        }
        .ia-tool-frame-container iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: var(--bg);
        }
        .ia-tool-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1.5rem;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
        }
        .ia-tool-header h1 {
            font-size: 1.25rem;
            font-weight: 600;
        }
        .ia-tool-back-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--surface-hover);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .ia-tool-back-btn:hover {
            background: var(--border);
        }
        .ia-tool-external-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--primary);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }
        .ia-tool-external-btn:hover {
            opacity: 0.9;
        }

        /* ========================================
           MICRO-INTERACTIONS & ANIMATIONS
           Linear/Vercel style - Smooth & Subtle
           ======================================== */

        /* Button Scale on Active */
        .btn:active:not(:disabled) {
            transform: scale(0.97) !important;
        }

        /* Ripple Effect for Primary Buttons */
        .btn-primary {
            position: relative;
            overflow: hidden;
        }

        .btn-primary::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 10%, transparent 10.01%);
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10);
            opacity: 0;
            transition: transform 0.4s, opacity 0.4s;
        }

        .btn-primary:active::after {
            transform: scale(0);
            opacity: 1;
            transition: 0s;
        }

        /* Stagger Animation for List Items */
        @keyframes staggerFadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .kanban-card, .pipeline-card, .table-row, .message-item {
            animation: staggerFadeIn 0.3s ease forwards;
        }

        .kanban-card:nth-child(1), .pipeline-card:nth-child(1) { animation-delay: 0.02s; }
        .kanban-card:nth-child(2), .pipeline-card:nth-child(2) { animation-delay: 0.04s; }
        .kanban-card:nth-child(3), .pipeline-card:nth-child(3) { animation-delay: 0.06s; }
        .kanban-card:nth-child(4), .pipeline-card:nth-child(4) { animation-delay: 0.08s; }
        .kanban-card:nth-child(5), .pipeline-card:nth-child(5) { animation-delay: 0.10s; }

        /* Badge Pulse Animation for New Items */
        @keyframes badgePulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(208, 48, 39, 0.4); }
            50% { box-shadow: 0 0 0 6px rgba(208, 48, 39, 0); }
        }

        .sidebar-badge.new, .badge.new {
            animation: badgePulse 2s infinite;
        }

        /* Smooth Sidebar Item Hover */
        .sidebar-item {
            position: relative;
        }

        .sidebar-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 0;
            background: var(--accent-gradient);
            border-radius: 0 2px 2px 0;
            transition: height var(--transition-spring);
        }

        .sidebar-item:hover::before {
            height: 24px;
        }

        .sidebar-item.active::before {
            height: 32px;
        }

        /* Card Hover Lift Effect */
        .stat, .card, .kpi-chart {
            transition: all var(--transition-normal), box-shadow var(--transition-slow);
        }

        /* Focus Ring Animation */
        @keyframes focusRing {
            0% { box-shadow: 0 0 0 0 rgba(208, 48, 39, 0.3); }
            100% { box-shadow: 0 0 0 3px rgba(208, 48, 39, 0.1); }
        }

        input:focus, select:focus, textarea:focus, button:focus-visible {
            animation: focusRing 0.2s ease forwards;
        }

        /* Number Counter Animation */
        @keyframes countUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stat-value, .kpi-number {
            animation: countUp 0.4s ease;
        }

        /* Skeleton Loading Effect */
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .skeleton {
            background: linear-gradient(90deg,
                var(--bg-muted) 25%,
                var(--bg-hover) 50%,
                var(--bg-muted) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: var(--radius-md);
        }

        /* Icon Bounce on Hover */
        .sidebar-item:hover svg,
        .btn:hover svg {
            transform: scale(1.1);
            transition: transform var(--transition-spring);
        }

        /* Smooth Modal Backdrop */
        .modal-overlay {
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }

        /* Success Checkmark Animation */
        @keyframes checkmark {
            0% { stroke-dashoffset: 50; }
            100% { stroke-dashoffset: 0; }
        }

        .success-checkmark path {
            stroke-dasharray: 50;
            animation: checkmark 0.4s ease forwards;
        }

        /* Notification Slide In */
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification-toast {
            animation: slideInRight 0.3s var(--transition-spring);
        }

        /* Table Row Hover Highlight */
        tbody tr {
            transition: background var(--transition-fast), transform var(--transition-fast);
        }

        tbody tr:hover {
            background: var(--bg-hover);
            transform: scale(1.005);
        }

        /* Dropdown Menu Animation */
        @keyframes dropdownIn {
            from {
                opacity: 0;
                transform: translateY(-8px) scale(0.96);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .dropdown-menu, .context-menu {
            animation: dropdownIn 0.15s ease;
            transform-origin: top;
        }

        /* View Toggle */
        .view-toggle {
            display: inline-flex;
            background: var(--bg);
            border-radius: 6px;
            padding: 0.25rem;
            gap: 0.25rem;
        }

        .view-toggle-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
            background: transparent;
            border: none;
            border-radius: 4px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.15s;
            font-family: inherit;
        }

        .view-toggle-btn:hover {
            color: var(--text);
        }

        .view-toggle-btn.active {
            background: var(--bg-muted);
            color: var(--text);
        }

        .view-toggle-btn svg {
            width: 14px;
            height: 14px;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .toolbar-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Search */
        .search-box {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.375rem 0.75rem;
            min-width: 200px;
        }

        .search-box:focus-within {
            border-color: var(--accent);
        }

        .search-box svg {
            width: 14px;
            height: 14px;
            color: var(--text-dim);
            flex-shrink: 0;
        }

        .search-box input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 0.8125rem;
            font-family: inherit;
            outline: none;
        }

        .search-box input::placeholder {
            color: var(--text-dim);
        }

        /* Dropdown */
        .dropdown {
            position: relative;
        }

        .dropdown-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.15s;
            font-family: inherit;
        }

        .dropdown-btn:hover {
            background: var(--bg-muted);
            color: var(--text);
        }

        .dropdown-btn svg {
            width: 12px;
            height: 12px;
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 6px;
            min-width: 160px;
            box-shadow: var(--shadow-lg);
            z-index: 100;
            display: none;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.15s;
        }

        .dropdown-item:hover {
            background: var(--bg-muted);
            color: var(--text);
        }

        .dropdown-item.active {
            color: var(--accent);
        }

        .dropdown-item svg {
            width: 12px;
            height: 12px;
        }

        .dropdown-divider {
            height: 1px;
            background: var(--border);
            margin: 0.25rem 0;
        }

        /* Temperature Chips */
        .temp-chips {
            display: flex;
            gap: 0.25rem;
            padding: 0.125rem;
            background: var(--bg);
            border-radius: 6px;
        }

        .temp-chip {
            padding: 0.25rem 0.625rem;
            font-size: 0.6875rem;
            font-weight: 500;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s;
            font-family: inherit;
            background: transparent;
            color: var(--text-dim);
        }

        .temp-chip:hover { color: var(--text); background: var(--bg-muted); }
        .temp-chip.active { color: white; }
        .temp-chip.active[data-temp="all"] { background: var(--accent); }
        .temp-chip.active[data-temp="hot"], .temp-chip.hot.active { background: var(--red); }
        .temp-chip.active[data-temp="chaud"], .temp-chip.chaud.active { background: var(--orange); }
        .temp-chip.active[data-temp="tiede"], .temp-chip.tiede.active { background: var(--yellow); color: #1a1a2e; }
        .temp-chip.active[data-temp="froid"], .temp-chip.froid.active { background: var(--blue); }

        /* Filter Toggle Button */
        .filter-toggle {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.15s;
            font-family: inherit;
        }

        .filter-toggle:hover { background: var(--bg-muted); color: var(--text); }
        .filter-toggle.active { background: var(--accent); color: white; border-color: var(--accent); }
        .filter-toggle svg { width: 12px; height: 12px; }

        /* Active Filters Bar */
        .active-filters {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0;
            flex-wrap: wrap;
        }

        .active-filters:empty { display: none; }

        .filter-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.6875rem;
            background: var(--accent-glow);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 4px;
            color: var(--accent);
        }

        .filter-tag-close {
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.15s;
        }

        .filter-tag-close:hover { opacity: 1; }

        .clear-filters {
            font-size: 0.6875rem;
            color: var(--text-dim);
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border: none;
            background: none;
            font-family: inherit;
        }

        .clear-filters:hover { color: var(--red); }

        /* Grid View */
        .grid-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
            padding: 0.5rem 0;
        }

        .grid-card {
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            cursor: pointer;
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .grid-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--border);
            transition: background 0.2s;
        }

        .grid-card.hot::before { background: var(--red); }
        .grid-card.chaud::before { background: var(--orange); }
        .grid-card.tiede::before { background: var(--yellow); }
        .grid-card.froid::before { background: var(--blue); }

        .grid-card:hover {
            border-color: var(--border-hover);
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .grid-card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            gap: 0.5rem;
        }

        .prospect-menu-btn {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all var(--transition-fast);
            flex-shrink: 0;
            font-size: 1rem;
            line-height: 1;
        }

        .prospect-menu-btn:hover {
            background: var(--bg-hover);
            color: var(--text);
        }

        .grid-card-company {
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--text);
            line-height: 1.3;
        }

        .grid-card-badge {
            padding: 0.125rem 0.5rem;
            font-size: 0.625rem;
            font-weight: 600;
            border-radius: 9999px;
            white-space: nowrap;
        }

        .grid-card-badge.hot { background: rgba(239, 68, 68, 0.15); color: var(--red); }
        .grid-card-badge.chaud { background: rgba(245, 158, 11, 0.15); color: var(--orange); }
        .grid-card-badge.tiede { background: rgba(234, 179, 8, 0.15); color: var(--yellow); }
        .grid-card-badge.froid { background: rgba(59, 130, 246, 0.15); color: var(--blue); }

        .grid-card-info {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
            margin-bottom: 0.75rem;
        }

        .grid-card-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .grid-card-row strong { color: var(--text); font-weight: 500; }

        .grid-card-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }

        .grid-card-value {
            font-size: 1rem;
            font-weight: 700;
            color: var(--accent);
        }

        .grid-card-status {
            font-size: 0.6875rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            background: var(--bg-muted);
            color: var(--text-muted);
        }

        .grid-card-assets {
            display: flex;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }

        .grid-card-assets span {
            font-size: 0.625rem;
            padding: 0.125rem 0.375rem;
            background: var(--bg-muted);
            border-radius: 3px;
            color: var(--text-dim);
        }

        .grid-card.has-assets { border-left: 3px solid var(--accent); }

        /* Compact View */
        .compact-list {
            display: flex;
            flex-direction: column;
        }

        .compact-row {
            display: grid;
            grid-template-columns: 2.5rem 1fr 120px 100px 100px 80px 60px;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            border-bottom: 1px solid var(--border-subtle);
            cursor: pointer;
            transition: background 0.1s;
            font-size: 0.8125rem;
        }

        .compact-row:hover { background: var(--bg-muted); }
        .compact-row:last-child { border-bottom: none; }

        .compact-row .avatar {
            width: 2rem;
            height: 2rem;
            font-size: 0.625rem;
        }

        .compact-company {
            font-weight: 500;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .compact-sector {
            font-size: 0.75rem;
            color: var(--text-dim);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .compact-status {
            font-size: 0.6875rem;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            background: var(--bg-muted);
            color: var(--text-muted);
            text-align: center;
            white-space: nowrap;
        }

        .compact-value {
            font-weight: 600;
            color: var(--text);
            text-align: right;
        }

        .compact-temp {
            font-size: 0.625rem;
            font-weight: 600;
            padding: 0.15rem 0.375rem;
            border-radius: 3px;
            text-align: center;
        }

        .compact-temp.hot { background: rgba(239, 68, 68, 0.15); color: var(--red); }
        .compact-temp.chaud { background: rgba(245, 158, 11, 0.15); color: var(--orange); }
        .compact-temp.tiede { background: rgba(234, 179, 8, 0.15); color: var(--yellow); }
        .compact-temp.froid { background: rgba(59, 130, 246, 0.15); color: var(--blue); }

        .compact-assets-icon {
            font-size: 0.75rem;
            text-align: center;
            color: var(--accent);
        }

        .compact-header {
            display: grid;
            grid-template-columns: 2.5rem 1fr 120px 100px 100px 80px 60px;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            border-bottom: 2px solid var(--border);
            font-size: 0.6875rem;
            font-weight: 600;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .summary-card {
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .summary-card-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .summary-card-icon.hot { background: rgba(239, 68, 68, 0.15); }
        .summary-card-icon.chaud { background: rgba(249, 115, 22, 0.15); }
        .summary-card-icon.tiede { background: rgba(234, 179, 8, 0.15); }
        .summary-card-icon.froid { background: rgba(59, 130, 246, 0.15); }

        .summary-card-content { flex: 1; }

        .summary-card-value {
            font-size: 1.25rem;
            font-weight: 700;
            line-height: 1;
        }

        .summary-card-label {
            font-size: 0.6875rem;
            color: var(--text-dim);
            margin-top: 0.125rem;
        }

        .summary-card-pipeline {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--green);
        }

        /* Table sortable headers */
        th.sortable {
            cursor: pointer;
            user-select: none;
        }

        th.sortable:hover {
            color: var(--text);
        }

        th.sortable::after {
            content: '';
            display: inline-block;
            width: 0;
            height: 0;
            margin-left: 0.375rem;
            vertical-align: middle;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 4px solid var(--text-dim);
            opacity: 0.3;
        }

        th.sortable.asc::after {
            border-top: none;
            border-bottom: 4px solid var(--accent);
            opacity: 1;
        }

        th.sortable.desc::after {
            border-top: 4px solid var(--accent);
            opacity: 1;
        }

        /* View containers */
        .prospects-view-container { display: none; }
        .prospects-view-container.active { display: block; }

        /* Prospect cards with assets - highlighted */
        .kanban-card.has-assets,
        .pipeline-card.has-assets {
            border-left: 3px solid var(--accent);
            background: var(--accent-glow);
        }

        tr.has-assets td:first-child {
            border-left: 3px solid var(--accent);
        }

        /* Modal Overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 99999;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .modal-overlay.show {
            display: flex;
        }

        /* Force modal au centre et visible */
        .modal-overlay .modal {
            position: relative;
            margin: auto;
            max-height: calc(100vh - 2rem);
            overflow-y: auto;
        }

        /* Modal - Linear/Vercel Style */
        .modal {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            max-width: 900px;
            width: 100%;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: modalIn 0.25s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: var(--shadow-xl);
        }

        @keyframes modalIn {
            from {
                transform: scale(0.96) translateY(8px);
                opacity: 0;
            }
            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        /* Chart Animations */
        @keyframes chartBarIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes barGrow {
            from {
                transform: scaleY(0);
            }
            to {
                transform: scaleY(1);
            }
        }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 1rem;
            background: var(--bg-subtle);
        }

        .modal-title-section {
            flex: 1;
        }

        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
            letter-spacing: -0.02em;
            margin-bottom: 0.25rem;
            color: var(--text);
        }

        .modal-subtitle {
            font-size: 0.8125rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .modal-close:hover {
            background: var(--red-glow);
            border-color: var(--red);
            color: var(--red);
        }

        .modal-close svg {
            width: 16px;
            height: 16px;
        }

        .modal-body {
            padding: 0;
            overflow-y: auto;
            flex: 1;
        }

        /* Modal Tabs System */
        .modal-tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid var(--border);
            background: var(--bg-subtle);
            padding: 0 1.5rem;
            overflow-x: auto;
        }

        .modal-tab {
            padding: 0.875rem 1.25rem;
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--text-muted);
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.15s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-tab:hover {
            color: var(--text);
            background: var(--bg-hover);
        }

        .modal-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .modal-tab svg {
            width: 16px;
            height: 16px;
        }

        .modal-tab .tab-badge {
            background: var(--bg-hover);
            color: var(--text-muted);
            font-size: 0.6875rem;
            font-weight: 600;
            padding: 0.125rem 0.5rem;
            border-radius: 10px;
            min-width: 1.25rem;
            text-align: center;
        }

        .modal-tab.active .tab-badge {
            background: var(--accent);
            color: white;
        }

        .modal-tab-content {
            display: none;
            padding: 1.5rem;
        }

        .modal-tab-content.active {
            display: block;
        }

        /* Assets Filter Bar */
        .assets-filter-bar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .asset-filter-btn {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-muted);
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .asset-filter-btn:hover {
            border-color: var(--accent);
            color: var(--text);
        }

        .asset-filter-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .filter-icon {
            font-size: 0.875rem;
        }

        .filter-count {
            background: var(--bg-muted);
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-size: 0.6875rem;
            font-weight: 600;
        }

        .asset-filter-btn.active .filter-count {
            background: rgba(255,255,255,0.2);
        }

        /* Prospect Info */
        .prospect-info {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .prospect-info-item {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.875rem;
        }

        .prospect-info-label {
            font-size: 0.6875rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }

        .prospect-info-value {
            font-size: 0.9375rem;
            font-weight: 600;
        }

        /* Prospect Edit Section */
        .prospect-edit-section {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        /* Fiche IA Section - Prioritaire */
        .fiche-ia-section {
            background: var(--accent-glow);
            border: 1px solid var(--accent);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }

        .fiche-ia-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .fiche-ia-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text);
        }

        .fiche-ia-badge {
            font-size: 0.6875rem;
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            background: var(--bg-muted);
            color: var(--text-dim);
        }

        .fiche-ia-badge.available {
            background: rgba(34, 197, 94, 0.2);
            color: var(--green);
        }

        .fiche-ia-content {
            margin-top: 0.5rem;
        }

        .fiche-ia-empty {
            text-align: center;
            padding: 1rem;
        }

        .fiche-ia-empty p {
            font-size: 0.8125rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .fiche-ia-hint {
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-bottom: 1rem;
        }

        .fiche-ia-generate {
            background: var(--accent);
            border: 1px solid var(--accent);
        }

        .fiche-ia-generate:hover {
            background: var(--accent-secondary);
            border-color: var(--accent-secondary);
        }

        .fiche-ia-available {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .fiche-ia-preview {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .fiche-ia-preview-icon {
            width: 44px;
            height: 44px;
            background: var(--accent);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fiche-ia-preview-icon svg {
            width: 22px;
            height: 22px;
            stroke: white;
        }

        .fiche-ia-preview-name {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text);
        }

        .fiche-ia-preview-meta {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .fiche-ia-actions {
            display: flex;
            gap: 0.5rem;
        }

        @media (max-width: 600px) {
            .fiche-ia-available {
                flex-direction: column;
                align-items: stretch;
            }
            .fiche-ia-actions {
                justify-content: stretch;
            }
            .fiche-ia-actions .btn {
                flex: 1;
            }
        }

        .edit-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .edit-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .edit-toggle-btn {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--accent);
            background: transparent;
            border: 1px solid var(--accent);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .edit-toggle-btn:hover {
            background: var(--accent);
            color: white;
        }

        .edit-toggle-btn svg {
            width: 14px;
            height: 14px;
        }

        .edit-toggle-btn.active {
            background: var(--accent);
            color: white;
        }

        .prospect-edit-form {
            margin-top: 0.75rem;
        }

        .edit-form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .edit-field {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .edit-field label {
            font-size: 0.6875rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .edit-field input {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            transition: border-color 0.2s;
        }

        .edit-field input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .edit-field input::placeholder {
            color: var(--text-dim);
        }

        .edit-form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }

        @media (max-width: 600px) {
            .edit-form-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Assets Section */
        .assets-section {
            margin-bottom: 1.5rem;
        }

        .assets-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .assets-section-title svg {
            width: 14px;
            height: 14px;
        }

        .assets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 0.75rem;
        }

        .asset-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .asset-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .asset-card.favorite {
            border-color: var(--yellow);
            background: rgba(202, 138, 4, 0.08);
        }

        .asset-card.favorite .asset-card-name {
            color: var(--yellow);
        }

        .asset-card-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .asset-card-icon.site { background: var(--accent-glow); }
        .asset-card-icon.dash { background: rgba(45, 134, 89, 0.15); }
        .asset-card-icon.wf { background: rgba(200, 125, 47, 0.15); }
        .asset-card-icon.doc { background: rgba(59, 130, 246, 0.15); }

        .asset-card-content { flex: 1; min-width: 0; padding-right: 28px; }

        .asset-card-name {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.125rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .asset-card-desc {
            font-size: 0.75rem;
            color: var(--text-dim);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .asset-card-type {
            font-size: 0.6875rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .asset-card-arrow {
            color: var(--text-dim);
            transition: transform 0.15s;
        }

        .asset-card:hover .asset-card-arrow {
            transform: translateX(4px);
            color: var(--accent);
        }

        .asset-card-arrow svg {
            width: 16px;
            height: 16px;
        }

        .asset-card-menu {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            opacity: 0;
            transition: all 0.2s ease;
        }

        .asset-card {
            position: relative;
        }

        .asset-card:hover .asset-card-menu {
            opacity: 1;
        }

        .asset-card-menu:hover {
            background: var(--bg-muted);
            color: var(--text);
        }

        .asset-menu-dropdown {
            position: fixed;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            padding: 4px;
            z-index: 10000;
            min-width: 140px;
        }

        .asset-menu-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border: none;
            background: transparent;
            color: var(--text);
            cursor: pointer;
            width: 100%;
            text-align: left;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        .asset-menu-item:hover {
            background: var(--bg-muted);
        }

        .asset-menu-item.danger {
            color: #ef4444;
        }

        .asset-menu-item.danger:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        /* Asset Preview Modal */
        .asset-preview-container {
            width: 90vw;
            height: 90vh;
            max-width: 1400px;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .asset-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
        }

        .asset-preview-info h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.25rem;
        }

        .asset-preview-info span {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .asset-preview-actions {
            display: flex;
            gap: 0.5rem;
        }

        .asset-preview-content {
            flex: 1;
            background: #fff;
            overflow: hidden;
        }

        .asset-preview-content iframe,
        .asset-preview-content object {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* No Assets */
        .no-assets {
            text-align: center;
            padding: 2rem;
            color: var(--text-dim);
        }

        .no-assets svg {
            width: 48px;
            height: 48px;
            margin-bottom: 0.75rem;
            opacity: 0.3;
        }

        .no-assets p {
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .no-assets span {
            font-size: 0.75rem;
        }

        /* Featured Prospects Section - Portfolio Style */
        .featured-section {
            margin-bottom: 2rem;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.03) 0%, rgba(139, 92, 246, 0.03) 100%);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            border: 1px solid var(--border);
        }

        .featured-title {
            font-size: 0.6875rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--accent);
            margin-bottom: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.625rem;
        }

        .featured-title svg {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
            stroke-width: 2.5;
        }

        .featured-prospects {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 1rem;
        }

        .featured-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 0;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            position: relative;
        }

        .featured-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent), var(--purple));
            opacity: 0;
            transition: opacity 0.25s ease;
        }

        .featured-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px -12px rgba(59, 130, 246, 0.25);
            border-color: var(--accent);
        }

        .featured-card:hover::before {
            opacity: 1;
        }

        .featured-card-content {
            padding: 1.25rem;
        }

        .featured-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .featured-card-company {
            font-size: 0.9375rem;
            font-weight: 700;
            color: var(--text);
            line-height: 1.3;
            flex: 1;
        }

        .featured-card-badge {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.625rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 100px;
            background: rgba(34, 197, 94, 0.1);
            color: var(--green);
            white-space: nowrap;
        }

        .featured-card-badge svg {
            width: 10px;
            height: 10px;
        }

        .featured-card-sector {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .featured-card-sector::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--purple);
            opacity: 0.6;
        }

        .featured-card-assets {
            display: flex;
            gap: 0.5rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }

        .featured-card-assets .asset-icon {
            width: 28px;
            height: 28px;
            font-size: 0.6875rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .featured-card:hover .asset-icon {
            border-color: var(--accent);
            background: rgba(59, 130, 246, 0.05);
        }

        .featured-card-count {
            font-size: 0.6875rem;
            color: var(--text-dim);
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .featured-card-count svg {
            width: 12px;
            height: 12px;
            opacity: 0.6;
        }

        /* ============================================
           FOLLOW-UPS & REMINDERS
           ============================================ */
        .followup-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.625rem;
            font-weight: 600;
            padding: 0.125rem 0.375rem;
            border-radius: 3px;
            background: rgba(239, 68, 68, 0.15);
            color: var(--red);
        }

        .followup-badge.today {
            background: rgba(249, 115, 22, 0.15);
            color: var(--orange);
            animation: pulse 2s infinite;
        }

        .followup-badge.overdue {
            background: rgba(239, 68, 68, 0.25);
            color: var(--red);
        }

        .followup-badge.upcoming {
            background: rgba(59, 130, 246, 0.15);
            color: var(--accent);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Today's Follow-ups Widget */
        .followups-widget {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-left: 3px solid var(--orange);
            border-radius: var(--radius-lg);
            padding: 1rem 1.25rem;
            margin-bottom: 1.25rem;
            transition: all var(--transition-normal);
        }

        .followups-widget:hover {
            border-color: var(--border-hover);
            box-shadow: var(--shadow-md);
        }

        .followups-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.875rem;
        }

        .followups-title {
            font-size: 0.8125rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--orange);
        }

        .followups-title svg {
            width: 16px;
            height: 16px;
        }

        .followups-count {
            background: var(--orange);
            color: white;
            font-size: 0.625rem;
            font-weight: 700;
            padding: 0.1875rem 0.625rem;
            border-radius: var(--radius-full);
        }

        .followup-item {
            display: flex;
            align-items: center;
            gap: 0.875rem;
            padding: 0.625rem;
            margin: 0 -0.625rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .followup-item:hover {
            background: var(--bg-hover);
        }

        .followup-item-info { flex: 1; }
        .followup-item-company {
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--text);
        }
        .followup-item-note {
            font-size: 0.6875rem;
            color: var(--text-muted);
            margin-top: 0.125rem;
        }

        .followup-item-actions {
            display: flex;
            gap: 0.375rem;
        }

        .followup-action {
            width: 28px;
            height: 28px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            background: var(--bg-subtle);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .followup-action svg {
            width: 14px;
            height: 14px;
        }

        .followup-action:hover {
            background: var(--bg-muted);
            border-color: var(--accent);
            color: var(--accent);
        }

        .followup-action.done:hover {
            background: rgba(34, 197, 94, 0.2);
            color: var(--green);
            border-color: var(--green);
        }

        .followup-action svg { width: 14px; height: 14px; }

        /* ============================================
           QUICK ACTIONS
           ============================================ */
        .quick-actions {
            display: flex;
            gap: 0.25rem;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border);
        }

        .quick-action-btn {
            flex: 1;
            padding: 0.375rem;
            border-radius: 4px;
            border: none;
            background: var(--bg);
            color: var(--text-dim);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            font-size: 0.75rem;
        }

        .quick-action-btn:hover {
            background: var(--bg-muted);
            color: var(--text);
        }

        .quick-action-btn.email:hover { color: var(--accent); }
        .quick-action-btn.phone:hover { color: var(--green); }
        .quick-action-btn.whatsapp:hover { color: #25D366; }
        .quick-action-btn.note:hover { color: var(--yellow); }
        .quick-action-btn.reminder:hover { color: var(--orange); }

        .quick-action-btn svg { width: 14px; height: 14px; }

        /* ============================================
           NOTES SYSTEM
           ============================================ */
        .notes-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        .notes-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .notes-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .notes-title svg { width: 14px; height: 14px; }

        .note-input-wrap {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            align-items: center;
        }

        .note-input {
            flex: 1;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            font-size: 0.8125rem;
            font-family: inherit;
            color: var(--text);
            resize: none;
        }

        .note-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .note-input::placeholder { color: var(--text-dim); }

        .notes-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .note-item {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .note-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }

        .note-item-date {
            font-size: 0.625rem;
            color: var(--text-dim);
        }

        .note-item-delete {
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            padding: 0.125rem;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .note-item:hover .note-item-delete { opacity: 1; }
        .note-item-delete:hover { color: var(--red); }
        .note-item-delete svg { width: 12px; height: 12px; }

        .note-item-text {
            font-size: 0.8125rem;
            color: var(--text-muted);
            line-height: 1.4;
        }

        /* ============================================
           ANALYTICS CHARTS
           ============================================ */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .chart-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.25rem;
            box-shadow: var(--shadow-sm);
        }

        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .chart-title {
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--text);
            font-family: var(--font-sans);
        }

        .chart-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .chart-value.green { color: var(--green); }

        /* Temperature Bar Chart - Full Width Style */
        .bar-chart {
            display: flex;
            align-items: stretch;
            gap: 1rem;
            height: 140px;
            padding: 0.75rem 0;
            width: 100%;
        }

        .bar-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            min-width: 0; /* Allow flex shrink */
        }

        .bar-container {
            flex: 1;
            width: 100%;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            min-height: 80px;
        }

        .bar {
            width: 100%;
            max-width: 80px;
            min-height: 6px;
            border-radius: 6px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .bar:hover {
            opacity: 0.85;
        }

        .bar.hot { background: var(--red); }
        .bar.chaud { background: var(--orange); }
        .bar.tiede { background: var(--yellow); }
        .bar.froid { background: var(--blue); }
        .bar.lead { background: var(--blue); }
        .bar.contacted { background: var(--yellow); }
        .bar.meeting { background: var(--accent); }
        .bar.proposal { background: var(--orange); }
        .bar.won { background: var(--green); }

        .bar-value {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text);
            font-family: var(--font-sans);
        }

        .bar-label {
            font-size: 0.6875rem;
            font-weight: 500;
            color: var(--text-muted);
            letter-spacing: 0.02em;
        }

        /* Donut Chart */
        .donut-chart {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto;
        }

        .donut-chart svg {
            transform: rotate(-90deg);
        }

        .donut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .donut-value {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .donut-label {
            font-size: 0.625rem;
            color: var(--text-dim);
        }

        /* Conversion Funnel - Linear Dark Style */
        .funnel {
            display: flex;
            flex-direction: column;
            gap: 0.625rem;
        }

        .funnel-stage {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: opacity 0.2s ease;
        }

        .funnel-stage:hover {
            opacity: 0.85;
        }

        .funnel-label {
            font-size: 0.6875rem;
            color: var(--text-muted);
            width: 70px;
            text-align: right;
            font-weight: 500;
        }

        .funnel-bar-wrap {
            flex: 1;
            height: 24px;
            background: var(--bg-muted);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .funnel-bar {
            height: 100%;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding-left: 0.625rem;
            transition: width 0.5s ease;
            min-width: fit-content;
        }

        .funnel-bar span {
            font-size: 0.6875rem;
            font-weight: 600;
            color: white;
        }

        .funnel-count {
            font-size: 0.75rem;
            font-weight: 600;
            width: 36px;
            text-align: right;
            color: var(--text-muted);
            font-family: var(--font-mono);
        }

        /* Sync Status */
        .sync-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.6875rem;
            color: var(--text-dim);
            padding: 0.375rem 0.625rem;
            background: var(--bg-subtle);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-full);
        }

        .sync-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--green);
        }

        .sync-dot.syncing {
            background: var(--yellow);
            animation: pulse 1s ease infinite;
        }

        .sync-dot.error {
            background: var(--red);
        }

        /* Add Reminder Modal */
        .reminder-modal {
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1.25rem;
            width: 320px;
        }

        .reminder-modal h3 {
            font-size: 0.9375rem;
            margin-bottom: 1rem;
        }

        .reminder-form {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .form-group label {
            display: block;
            font-size: 0.6875rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 0.375rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 0.625rem 0.875rem;
            font-size: 0.8125rem;
            font-family: inherit;
            color: var(--text);
            transition: all var(--transition-fast);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: var(--text-dim);
        }

        .form-group input:hover,
        .form-group select:hover,
        .form-group textarea:hover {
            border-color: var(--border-hover);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .form-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-subtle);
        }

        .form-actions .btn { flex: 1; justify-content: center; }

        /* ============================================
           CONTENT CALENDAR (FACEBOOK)
           ============================================ */
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .content-stats {
            display: flex;
            gap: 1rem;
        }

        .content-stat {
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            text-align: center;
        }

        .content-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
        }

        .content-stat-label {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        /* Messages Module */
        .messages-layout {
            display: grid;
            grid-template-columns: 340px 1fr;
            gap: 1.5rem;
            height: calc(100vh - 220px);
            min-height: 500px;
        }

        .conversations-list {
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .conversations-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .conversations-header h3 {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .conversations-search {
            width: 100%;
            padding: 0.5rem 0.75rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.8125rem;
        }

        .conversations-search:focus {
            outline: none;
            border-color: var(--accent);
        }

        .conversations-items {
            flex: 1;
            overflow-y: auto;
        }

        .conversations-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 2rem;
            text-align: center;
            color: var(--text-dim);
        }

        .conversations-empty svg {
            width: 48px;
            height: 48px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .conversations-empty p {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .conversations-empty span {
            font-size: 0.75rem;
        }

        .conversation-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.15s;
        }

        .conversation-item:hover {
            background: var(--bg-muted);
        }

        .conversation-item.active {
            background: rgba(59, 130, 246, 0.15);
            border-left: 3px solid var(--accent);
        }

        .conversation-item.unread {
            background: rgba(59, 130, 246, 0.08);
        }

        .conversation-avatar {
            width: 40px;
            height: 40px;
            min-width: 40px;
            background: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 600;
            color: white;
        }

        .conversation-info {
            flex: 1;
            min-width: 0;
        }

        .conversation-name {
            font-size: 0.8125rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-preview {
            font-size: 0.75rem;
            color: var(--text-dim);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.25rem;
        }

        .conversation-time {
            font-size: 0.6875rem;
            color: var(--text-dim);
        }

        .conversation-badge {
            width: 18px;
            height: 18px;
            background: var(--accent);
            border-radius: 50%;
            font-size: 0.625rem;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Chat Detail */
        .chat-detail {
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-detail-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-dim);
        }

        .chat-detail-empty svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .chat-detail-empty p {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .chat-detail-empty span {
            font-size: 0.8125rem;
        }

        .chat-detail-content {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-detail-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
        }

        .chat-user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .chat-user-avatar {
            width: 40px;
            height: 40px;
            background: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 600;
            color: white;
        }

        .chat-user-name {
            font-size: 0.9375rem;
            font-weight: 600;
        }

        .chat-user-id {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .chat-header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-sm {
            padding: 0.375rem 0.5rem;
        }

        .btn-sm svg {
            width: 16px;
            height: 16px;
        }

        .chat-messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .msg-bubble {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 16px;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .msg-bubble.user {
            align-self: flex-start;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 16px 16px 16px 4px;
        }

        .msg-bubble.assistant {
            align-self: flex-end;
            background: var(--accent);
            color: white;
            border-radius: 16px 16px 4px 16px;
        }

        .msg-bubble.manual {
            background: var(--orange);
        }

        .msg-time {
            font-size: 0.6875rem;
            color: var(--text-dim);
            margin-top: 0.25rem;
        }

        .msg-bubble.assistant .msg-time,
        .msg-bubble.manual .msg-time {
            color: rgba(255, 255, 255, 0.7);
        }

        .msg-label {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.625rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            margin-bottom: 0.25rem;
            opacity: 0.8;
        }

        .msg-label svg {
            width: 10px;
            height: 10px;
        }

        /* Chat Input */
        .chat-input-container {
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--border);
            background: var(--bg);
        }

        .chat-input-row {
            display: flex;
            gap: 0.75rem;
        }

        .chat-input {
            flex: 1;
            padding: 0.75rem 1rem;
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-family: inherit;
            font-size: 0.875rem;
            resize: none;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .chat-input-note {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.75rem;
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .chat-input-note svg {
            width: 14px;
            height: 14px;
            min-width: 14px;
        }

        /* Blog Articles Grid */
        .blog-articles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.25rem;
        }

        .blog-article-card {
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s;
            cursor: pointer;
        }

        .blog-article-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .blog-article-image {
            height: 160px;
            background: var(--bg-muted);
            position: relative;
            overflow: hidden;
        }

        .blog-article-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .blog-article-category {
            position: absolute;
            top: 0.75rem;
            left: 0.75rem;
            padding: 0.25rem 0.5rem;
            background: var(--accent);
            color: white;
            font-size: 0.6875rem;
            font-weight: 600;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .blog-article-status {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.6875rem;
            font-weight: 600;
            border-radius: 4px;
        }

        .blog-article-status.published { background: var(--green); color: white; }
        .blog-article-status.scheduled { background: var(--accent); color: white; }
        .blog-article-status.draft { background: var(--bg-muted); color: var(--text-muted); }
        .blog-article-status.ready { background: var(--yellow); color: var(--text); }

        .blog-article-content {
            padding: 1rem;
        }

        .blog-article-title {
            font-size: 0.9375rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .blog-article-excerpt {
            font-size: 0.8125rem;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .blog-article-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .blog-article-featured {
            color: var(--yellow);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .blog-article-featured svg {
            width: 12px;
            height: 12px;
            fill: currentColor;
        }

        /* Newsletter Campaigns List */
        .newsletter-campaigns-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .newsletter-campaign-item {
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .newsletter-campaign-item:hover {
            border-color: var(--accent);
            background: var(--bg-muted);
        }

        .newsletter-campaign-icon {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .newsletter-campaign-icon.draft { background: rgba(100, 100, 120, 0.2); color: var(--text-muted); }
        .newsletter-campaign-icon.ready { background: rgba(234, 179, 8, 0.2); color: var(--yellow); }
        .newsletter-campaign-icon.scheduled { background: rgba(168, 85, 247, 0.2); color: var(--purple); }
        .newsletter-campaign-icon.sent { background: rgba(34, 197, 94, 0.2); color: var(--green); }

        .newsletter-campaign-icon svg {
            width: 22px;
            height: 22px;
        }

        .newsletter-campaign-info {
            flex: 1;
            min-width: 0;
        }

        .newsletter-campaign-subject {
            font-weight: 600;
            font-size: 0.9375rem;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .newsletter-campaign-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .newsletter-campaign-stats {
            display: flex;
            gap: 1.5rem;
            flex-shrink: 0;
        }

        .newsletter-stat {
            text-align: center;
        }

        .newsletter-stat-value {
            font-size: 1.125rem;
            font-weight: 700;
        }

        .newsletter-stat-label {
            font-size: 0.625rem;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .newsletter-campaign-actions {
            display: flex;
            gap: 0.5rem;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 1.5rem;
        }

        .content-calendar {
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .calendar-nav {
            display: flex;
            gap: 0.5rem;
        }

        .calendar-nav button {
            background: var(--bg-muted);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.375rem 0.75rem;
            color: var(--text);
            cursor: pointer;
            font-size: 0.8125rem;
        }

        .calendar-nav button:hover { background: var(--border); }

        .calendar-week {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .calendar-day-label {
            text-align: center;
            font-size: 0.6875rem;
            font-weight: 600;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.375rem;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
        }

        .calendar-day:hover { border-color: var(--accent); }
        .calendar-day.today { border-color: var(--accent); background: rgba(59, 130, 246, 0.1); }
        .calendar-day.other-month { opacity: 0.4; }
        .calendar-day.has-post::after {
            content: '';
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background: var(--purple);
            border-radius: 50%;
        }
        .calendar-day.has-post.published::after { background: var(--green); }

        .calendar-day-number {
            font-size: 0.75rem;
            font-weight: 500;
        }

        .post-sidebar {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .post-create-card {
            background: var(--accent-glow);
            border: 1px solid var(--accent);
            border-radius: var(--radius-md);
            padding: 1.25rem;
        }

        .post-create-card h3 {
            font-size: 0.9375rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .post-create-card h3 svg { width: 18px; height: 18px; stroke: var(--accent); }

        .post-textarea {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            color: var(--text);
            font-size: 0.8125rem;
            resize: vertical;
            min-height: 100px;
            margin-bottom: 0.75rem;
        }

        .post-textarea:focus { outline: none; border-color: var(--accent); }
        .post-textarea::placeholder { color: var(--text-dim); }

        .post-options {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .post-option {
            flex: 1;
            background: var(--bg-muted);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.5rem;
            text-align: center;
            cursor: pointer;
            font-size: 0.75rem;
            color: var(--text-muted);
            transition: all 0.15s;
        }

        .post-option:hover, .post-option.active {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(59, 130, 246, 0.1);
        }

        .post-schedule {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .post-schedule input {
            flex: 1;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.5rem;
            color: var(--text);
            font-size: 0.8125rem;
        }

        .post-schedule input:focus { outline: none; border-color: var(--accent); }

        .post-actions {
            display: flex;
            gap: 0.5rem;
        }

        .post-actions .btn { flex: 1; justify-content: center; }

        .posts-list {
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            flex: 1;
            overflow-y: auto;
        }

        .posts-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .posts-list-header h3 {
            font-size: 0.875rem;
            font-weight: 600;
        }

        .posts-list-tabs {
            display: flex;
            gap: 0.25rem;
        }

        .posts-list-tab {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.6875rem;
            cursor: pointer;
            color: var(--text-dim);
        }

        .posts-list-tab.active { background: var(--accent); color: white; }

        .post-item {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .post-item:hover { border-color: var(--border-subtle); }

        .post-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .post-item-date {
            font-size: 0.6875rem;
            color: var(--text-dim);
        }

        .post-item-status {
            font-size: 0.625rem;
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-weight: 500;
        }

        .post-item-status.scheduled { background: rgba(168, 85, 247, 0.2); color: var(--purple); }
        .post-item-status.published { background: rgba(34, 197, 94, 0.2); color: var(--green); }
        .post-item-status.draft { background: rgba(161, 161, 170, 0.2); color: var(--text-muted); }

        .post-item-preview {
            font-size: 0.75rem;
            color: var(--text-muted);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .post-item-image {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            margin-top: 0.5rem;
        }

        .ai-generate-btn {
            background: var(--accent);
            border: none;
            color: white;
            font-weight: 500;
        }

        .ai-generate-btn:hover { opacity: 0.9; }

        /* Content KPI Row */
        .content-kpi-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .content-kpi {
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
        }

        .content-kpi-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .content-kpi-label {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        /* Platform Badges */
        .platform-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.125rem 0.5rem;
            border-radius: 4px;
            font-size: 0.625rem;
            font-weight: 600;
            margin-right: 0.25rem;
        }

        .platform-badge.facebook { background: rgba(66, 103, 178, 0.2); color: #4267B2; }
        .platform-badge.linkedin { background: rgba(0, 119, 181, 0.2); color: #0077B5; }
        .platform-badge.instagram { background: rgba(225, 48, 108, 0.2); color: #E1306C; }

        /* Funnel Stage Badges */
        .funnel-badge {
            display: inline-block;
            padding: 0.125rem 0.5rem;
            border-radius: 4px;
            font-size: 0.625rem;
            font-weight: 600;
        }

        .funnel-badge.tofu { background: rgba(34, 197, 94, 0.2); color: var(--green); }
        .funnel-badge.mofu { background: rgba(234, 179, 8, 0.2); color: var(--yellow); }
        .funnel-badge.bofu { background: rgba(239, 68, 68, 0.2); color: var(--red); }

        /* Content Item Actions */
        .content-item-actions {
            display: flex;
            gap: 0.375rem;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .post-item:hover .content-item-actions { opacity: 1; }

        .content-action-btn {
            padding: 0.25rem;
            background: var(--bg-muted);
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .content-action-btn:hover { background: var(--border); color: var(--text); }
        .content-action-btn.delete:hover { background: rgba(239, 68, 68, 0.2); color: var(--red); }
        .content-action-btn svg { width: 12px; height: 12px; }

        /* Edit Content Modal */
        .edit-content-modal {
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 600px;
            width: 90%;
        }

        .edit-content-modal h3 {
            font-size: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .edit-form-group {
            margin-bottom: 1rem;
        }

        .edit-form-group label {
            display: block;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 0.375rem;
        }

        .edit-form-group input,
        .edit-form-group textarea,
        .edit-form-group select {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            color: var(--text);
            font-size: 0.8125rem;
            font-family: inherit;
        }

        .edit-form-group textarea { resize: vertical; min-height: 120px; }
        .edit-form-group input:focus,
        .edit-form-group textarea:focus,
        .edit-form-group select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .edit-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .edit-form-row-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        /* Content Preview Modal */
        .content-preview-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 2rem;
        }

        .content-preview-modal {
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .content-preview-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .content-preview-body {
            padding: 1rem;
            flex: 1;
            overflow-y: auto;
        }

        .content-preview-post {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            color: #1c1e21;
        }

        .content-preview-post-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .preview-avatar {
            width: 40px;
            height: 40px;
            background: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1rem;
        }

        .preview-post-info .preview-name { font-weight: 600; font-size: 0.9375rem; }
        .preview-post-info .preview-time { font-size: 0.75rem; color: #65676b; }

        .content-preview-text {
            font-size: 0.9375rem;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .content-preview-footer {
            padding: 1rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            gap: 0.5rem;
        }

        /* ============================================
           AI CHATBOT
           ============================================ */
        .chatbot-fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--accent);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
            transition: all 0.2s ease;
            z-index: 150;
        }

        .chatbot-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 28px rgba(59, 130, 246, 0.5);
        }

        .chatbot-fab svg {
            width: 24px;
            height: 24px;
            stroke: white;
        }

        .chatbot-fab .badge-notif {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 20px;
            height: 20px;
            background: var(--red);
            border-radius: 50%;
            font-size: 0.625rem;
            font-weight: 700;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chatbot-panel {
            position: fixed;
            bottom: 96px;
            right: 24px;
            width: 420px;
            height: 600px;
            max-height: calc(100vh - 120px);
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.5);
            display: none;
            flex-direction: column;
            overflow: hidden;
            z-index: 160;
            animation: chatbotIn 0.2s ease;
        }

        .chatbot-panel.open {
            display: flex;
        }

        @keyframes chatbotIn {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .chatbot-header {
            padding: 1rem 1.25rem;
            background: var(--accent);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .chatbot-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chatbot-avatar svg {
            width: 22px;
            height: 22px;
            stroke: white;
        }

        .chatbot-info { flex: 1; }
        .chatbot-name { font-weight: 600; font-size: 0.9375rem; }
        .chatbot-status { font-size: 0.6875rem; opacity: 0.8; display: flex; align-items: center; gap: 0.375rem; }
        .chatbot-status-dot { width: 6px; height: 6px; background: #22c55e; border-radius: 50%; }

        .chatbot-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.15s;
        }

        .chatbot-close:hover { background: rgba(255, 255, 255, 0.2); }
        .chatbot-close svg { width: 18px; height: 18px; }

        .chatbot-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .chat-message {
            display: flex;
            gap: 0.5rem;
            max-width: 85%;
        }

        .chat-message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .chat-message.assistant {
            align-self: flex-start;
        }

        .chat-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 0.75rem;
        }

        .chat-message.user .chat-avatar {
            background: var(--accent);
            color: white;
        }

        .chat-message.assistant .chat-avatar {
            background: var(--accent);
        }

        .chat-avatar svg { width: 14px; height: 14px; stroke: white; }

        .chat-bubble {
            padding: 0.75rem 1rem;
            border-radius: 12px;
            font-size: 0.8125rem;
            line-height: 1.5;
        }

        .chat-message.user .chat-bubble {
            background: var(--accent);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chat-message.assistant .chat-bubble {
            background: var(--bg-muted);
            color: var(--text);
            border-bottom-left-radius: 4px;
        }

        .chat-bubble p { margin-bottom: 0.5rem; }
        .chat-bubble p:last-child { margin-bottom: 0; }
        .chat-bubble strong { color: var(--text); font-weight: 600; }
        .chat-bubble code {
            background: rgba(0, 0, 0, 0.3);
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.75rem;
        }

        .chat-bubble ul, .chat-bubble ol {
            margin: 0.5rem 0;
            padding-left: 1.25rem;
        }

        .chat-bubble li { margin-bottom: 0.25rem; }

        /* Quick Actions in Chat */
        .chat-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.375rem;
            margin-top: 0.5rem;
        }

        .chat-action-btn {
            padding: 0.375rem 0.625rem;
            font-size: 0.6875rem;
            font-weight: 500;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.15s;
        }

        .chat-action-btn:hover {
            background: var(--bg-subtle);
            border-color: var(--accent);
            color: var(--accent);
        }

        .chat-timestamp {
            font-size: 0.625rem;
            color: var(--text-dim);
            margin-top: 0.375rem;
            text-align: right;
            opacity: 0.7;
        }

        .chat-message.user .chat-timestamp {
            text-align: left;
        }

        /* Typing indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.75rem 1rem;
            background: var(--bg-muted);
            border-radius: 12px;
            border-bottom-left-radius: 4px;
            width: fit-content;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: var(--text-dim);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out both;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingBounce {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* Chat Input */
        .chatbot-input-area {
            padding: 1rem;
            border-top: 1px solid var(--border);
            background: var(--bg);
        }

        .chatbot-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.375rem;
            margin-bottom: 0.75rem;
        }

        .suggestion-chip {
            padding: 0.375rem 0.625rem;
            font-size: 0.6875rem;
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.15s;
        }

        .suggestion-chip:hover {
            background: var(--bg-muted);
            border-color: var(--accent);
            color: var(--text);
        }

        .chatbot-input-wrap {
            display: flex;
            gap: 0.5rem;
        }

        .chatbot-input {
            flex: 1;
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            font-family: inherit;
            color: var(--text);
            resize: none;
            min-height: 44px;
            max-height: 150px;
            overflow-y: auto;
            line-height: 1.4;
            transition: height 0.1s ease;
        }

        .chatbot-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .chatbot-input::placeholder { color: var(--text-dim); }

        .chatbot-send {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            background: var(--accent);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .chatbot-send:hover {
            transform: scale(1.05);
        }

        .chatbot-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .chatbot-send svg {
            width: 18px;
            height: 18px;
            stroke: white;
        }

        /* Data Cards in Chat */
        .chat-data-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            margin-top: 0.5rem;
        }

        .chat-data-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .chat-data-title {
            font-weight: 600;
            font-size: 0.8125rem;
        }

        .chat-data-badge {
            font-size: 0.625rem;
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
        }

        .chat-data-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            padding: 0.25rem 0;
            border-bottom: 1px solid var(--border);
        }

        .chat-data-row:last-child { border-bottom: none; }
        .chat-data-label { color: var(--text-dim); }
        .chat-data-value { font-weight: 500; }

        .chat-prospect-list {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
            margin-top: 0.5rem;
        }

        .chat-prospect-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0.75rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .chat-prospect-item:hover {
            border-color: var(--accent);
            background: var(--bg-muted);
        }

        .chat-prospect-name { font-size: 0.8125rem; font-weight: 500; }
        .chat-prospect-meta { font-size: 0.6875rem; color: var(--text-dim); }

        /* Section Title */
        .section-title {
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-dim);
            margin-bottom: 0.75rem;
            padding-left: 0.125rem;
        }

        /* Empty */
        .empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-dim);
        }

        .empty svg {
            width: 32px;
            height: 32px;
            margin-bottom: 0.75rem;
            opacity: 0.5;
        }

        .empty p { font-size: 0.8125rem; }

        /* Responsive */
        @media (max-width: 1200px) {
            .grid { grid-template-columns: 1fr; }
            .stats-row { grid-template-columns: repeat(3, 1fr); }
            .pipeline { grid-template-columns: repeat(3, 1fr); }
            #task-kanban { grid-template-columns: repeat(2, 1fr); }
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
                padding: 1rem 1.5rem;
            }
            .header-actions {
                width: 100%;
                justify-content: flex-start;
            }
        }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main { margin-left: 0; }
            .stats-row { grid-template-columns: repeat(2, 1fr); }
            .pipeline { grid-template-columns: 1fr; }
            #task-kanban { grid-template-columns: 1fr; }
            .content { padding: 1rem; }
            .header { padding: 0.75rem 1rem; }
            .header-actions { gap: 0.375rem; }
            .filter-select { font-size: 0.75rem; padding: 0.375rem 0.5rem; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border-subtle); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

        /* ============================================
           NOTIFICATIONS SYSTEM
           ============================================ */
        .notification-bell {
            position: relative;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            transition: background 0.15s;
        }
        .notification-bell:hover { background: var(--bg-subtle); }
        .notification-bell svg { width: 18px; height: 18px; color: var(--text-muted); }
        .notification-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 16px;
            height: 16px;
            background: var(--red);
            border-radius: 50%;
            font-size: 0.625rem;
            font-weight: 700;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--bg);
        }
        .notification-badge.hidden { display: none; }

        .notification-panel {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            width: 360px;
            max-height: 480px;
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 10px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.4);
            z-index: 200;
            display: none;
            overflow: hidden;
        }
        .notification-panel.show { display: block; }
        .notification-header {
            padding: 0.875rem 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .notification-header h3 { font-size: 0.875rem; font-weight: 600; }
        .notification-clear {
            font-size: 0.75rem;
            color: var(--accent);
            cursor: pointer;
            background: none;
            border: none;
            font-family: inherit;
        }
        .notification-clear:hover { text-decoration: underline; }
        .notification-list {
            max-height: 380px;
            overflow-y: auto;
        }
        .notification-item {
            padding: 0.875rem 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 0.75rem;
            cursor: pointer;
            transition: background 0.15s;
        }
        .notification-item:hover { background: var(--bg-muted); }
        .notification-item.unread { background: rgba(59, 130, 246, 0.05); }
        .notification-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .notification-icon.status { background: rgba(59, 130, 246, 0.15); color: var(--accent); }
        .notification-icon.task { background: rgba(234, 179, 8, 0.15); color: var(--yellow); }
        .notification-icon.alert { background: rgba(239, 68, 68, 0.15); color: var(--red); }
        .notification-icon svg { width: 16px; height: 16px; }
        .notification-content { flex: 1; min-width: 0; }
        .notification-title { font-size: 0.8125rem; font-weight: 500; margin-bottom: 0.125rem; }
        .notification-desc { font-size: 0.75rem; color: var(--text-muted); }
        .notification-time { font-size: 0.6875rem; color: var(--text-dim); margin-top: 0.25rem; }
        .notification-empty {
            padding: 2rem;
            text-align: center;
            color: var(--text-dim);
            font-size: 0.8125rem;
        }

        /* Task badge in nav */
        .nav-badge.urgent { background: var(--red); animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* ============================================
           GLOBAL SEARCH (Cmd+K)
           ============================================ */
        .search-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 500;
            display: none;
            align-items: flex-start;
            justify-content: center;
            padding-top: 12vh;
        }
        .search-overlay.show { display: flex; }
        .search-modal {
            width: 100%;
            max-width: 560px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            animation: modalIn 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .search-input-wrapper {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            background: var(--bg-subtle);
        }
        .search-input-wrapper svg { width: 18px; height: 18px; color: var(--accent); flex-shrink: 0; }
        .search-input {
            flex: 1;
            background: transparent;
            border: none;
            font-size: 0.9375rem;
            color: var(--text);
            font-family: inherit;
            outline: none;
        }
        .search-input::placeholder { color: var(--text-dim); }
        .search-shortcut {
            font-size: 0.625rem;
            font-weight: 500;
            color: var(--text-dim);
            background: var(--bg);
            padding: 0.1875rem 0.375rem;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
        }
        .search-results {
            max-height: 400px;
            overflow-y: auto;
        }
        .search-section { padding: 0.5rem 0; }
        .search-section-title {
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-dim);
            padding: 0.5rem 1.25rem;
        }
        .search-result {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem 1.25rem;
            cursor: pointer;
            transition: background 0.1s;
        }
        .search-result:hover, .search-result.selected { background: var(--bg-muted); }
        .search-result-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .search-result-icon.prospect { background: rgba(59, 130, 246, 0.15); color: var(--accent); }
        .search-result-icon.task { background: rgba(234, 179, 8, 0.15); color: var(--yellow); }
        .search-result-icon.action { background: rgba(168, 85, 247, 0.15); color: var(--purple); }
        .search-result-icon svg { width: 16px; height: 16px; }
        .search-result-content { flex: 1; min-width: 0; }
        .search-result-title { font-size: 0.875rem; font-weight: 500; }
        .search-result-meta { font-size: 0.75rem; color: var(--text-muted); }
        .search-result-shortcut {
            font-size: 0.6875rem;
            color: var(--text-dim);
            background: var(--bg);
            padding: 0.125rem 0.375rem;
            border-radius: 3px;
        }
        .search-footer {
            padding: 0.75rem 1.25rem;
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.75rem;
            color: var(--text-dim);
        }
        .search-footer kbd {
            background: var(--bg);
            padding: 0.125rem 0.375rem;
            border-radius: 3px;
            border: 1px solid var(--border);
            font-size: 0.6875rem;
        }

        /* ============================================
           TIMELINE / ACTIVITY
           ============================================ */
        .timeline {
            position: relative;
            padding-left: 1.5rem;
        }
        .timeline::before {
            content: '';
            position: absolute;
            left: 5px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border);
        }
        .timeline-item {
            position: relative;
            padding-bottom: 1rem;
        }
        .timeline-item:last-child { padding-bottom: 0; }
        .timeline-dot {
            position: absolute;
            left: -1.5rem;
            top: 0.25rem;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--bg-muted);
            border: 2px solid var(--border-subtle);
        }
        .timeline-dot.status { background: var(--accent); border-color: var(--accent); }
        .timeline-dot.asset { background: var(--green); border-color: var(--green); }
        .timeline-dot.note { background: var(--yellow); border-color: var(--yellow); }
        .timeline-dot.task { background: var(--purple); border-color: var(--purple); }
        .timeline-content {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.625rem 0.875rem;
        }
        .timeline-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }
        .timeline-action { font-size: 0.8125rem; font-weight: 500; }
        .timeline-date { font-size: 0.6875rem; color: var(--text-dim); }
        .timeline-desc { font-size: 0.75rem; color: var(--text-muted); }

        /* ============================================
           CONTEXT MENU (Quick Actions)
           ============================================ */
        .context-menu {
            position: fixed;
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
            min-width: 180px;
            z-index: 300;
            display: none;
            padding: 0.375rem 0;
        }
        .context-menu.show { display: block; }
        .context-menu-item {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            padding: 0.5rem 0.875rem;
            font-size: 0.8125rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.1s;
        }
        .context-menu-item:hover { background: var(--bg-muted); color: var(--text); }
        .context-menu-item svg { width: 14px; height: 14px; }
        .context-menu-item.danger { color: var(--red); }
        .context-menu-item.danger:hover { background: rgba(239, 68, 68, 0.1); }
        .context-menu-divider { height: 1px; background: var(--border); margin: 0.375rem 0; }

        /* ============================================
           ANALYTICS KPI ROW
           ============================================ */
        .analytics-kpi-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .analytics-kpi {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
        }
        .analytics-kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.25rem;
        }
        .analytics-kpi-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        @media (max-width: 768px) {
            .analytics-kpi-row { grid-template-columns: repeat(2, 1fr); }
        }

        /* ============================================
           FUNNEL / ADVANCED STATS
           ============================================ */
        .funnel-container { padding: 1rem 0; }
        .funnel-stage {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.75rem;
        }
        .funnel-label {
            width: 100px;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: right;
        }
        .funnel-bar-wrapper {
            flex: 1;
            height: 28px;
            background: var(--bg);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        .funnel-bar {
            height: 100%;
            background: var(--accent);
            border-radius: 4px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 0.5rem;
        }
        .funnel-value {
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        .funnel-count {
            width: 60px;
            font-size: 0.8125rem;
            font-weight: 600;
            text-align: right;
        }
        .funnel-percent {
            font-size: 0.6875rem;
            color: var(--text-dim);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        .stat-card-mini {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
        }
        .stat-card-mini-label {
            font-size: 0.6875rem;
            color: var(--text-dim);
            margin-bottom: 0.375rem;
        }
        .stat-card-mini-value {
            font-size: 1.25rem;
            font-weight: 700;
        }
        .stat-card-mini-trend {
            font-size: 0.6875rem;
            margin-top: 0.25rem;
        }
        .stat-card-mini-trend.up { color: var(--green); }
        .stat-card-mini-trend.down { color: var(--red); }

        /* ============================================
           FOCUS MODE
           ============================================ */
        .focus-mode .sidebar { display: none; }
        .focus-mode .main { margin-left: 0; }
        .focus-mode .header { background: var(--bg-subtle); }

        .focus-panel {
            max-width: 800px;
            margin: 0 auto;
        }
        .focus-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .focus-date {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }
        .focus-greeting {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .focus-section {
            margin-bottom: 1.5rem;
        }
        .focus-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-dim);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .focus-section-title svg { width: 14px; height: 14px; }

        .focus-task {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1rem;
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.15s;
        }
        .focus-task:hover { border-color: var(--accent); }
        .focus-task-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-subtle);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s;
        }
        .focus-task-checkbox:hover { border-color: var(--accent); }
        .focus-task-checkbox.checked {
            background: var(--accent);
            border-color: var(--accent);
        }
        .focus-task-checkbox svg { width: 12px; height: 12px; color: white; opacity: 0; }
        .focus-task-checkbox.checked svg { opacity: 1; }
        .focus-task-content { flex: 1; }
        .focus-task-title { font-size: 0.875rem; font-weight: 500; }
        .focus-task-meta { font-size: 0.75rem; color: var(--text-muted); }
        .focus-task-priority {
            font-size: 0.6875rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }
        .focus-task-priority.urgent { background: rgba(239, 68, 68, 0.15); color: var(--red); }
        .focus-task-priority.normal { background: rgba(59, 130, 246, 0.15); color: var(--accent); }

        .focus-followup {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }
        .focus-followup-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .focus-followup-content { flex: 1; }
        .focus-followup-company { font-size: 0.875rem; font-weight: 500; }
        .focus-followup-reason { font-size: 0.75rem; color: var(--text-muted); }
        .focus-followup-action {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 500;
        }
        .focus-followup-action:hover { background: var(--accent-muted); }

        /* View Toggle Button */
        .view-toggle {
            display: flex;
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
        }
        .view-toggle-btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-family: inherit;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }
        .view-toggle-btn:hover { color: var(--text); }
        .view-toggle-btn.active { background: var(--accent); color: white; }
        .view-toggle-btn svg { width: 14px; height: 14px; }
    </style>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <img src="https://pacifikai.com/assets/logo.png" alt="PACIFIK'AI" class="logo-img" style="height: 36px;">
                </div>
                <button class="sidebar-toggle" onclick="toggleSidebar()" title="Réduire la sidebar">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 19l-7-7 7-7M4 12h16"/>
                    </svg>
                </button>
            </div>

            <nav class="nav">
                <!-- Overview -->
                <div class="nav-group">
                    <a class="nav-item active" data-view="dashboard">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
                        Dashboard
                    </a>
                </div>

                <!-- CRM & Sales -->
                <div class="nav-group">
                    <div class="nav-label">CRM</div>
                    <a class="nav-item" data-view="prospects">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        Prospects
                        <span class="nav-badge" id="nav-prospect-count">0</span>
                    </a>
                    <a class="nav-item" data-view="messages">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
                        Messages
                        <span class="nav-badge" id="nav-messages-count" style="background: var(--orange);">0</span>
                    </a>
                    <a class="nav-item" data-view="finance">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                        Finance
                        <span class="nav-badge" id="nav-finance-mrr" style="background: var(--green);">0</span>
                    </a>
                </div>

                <!-- Work -->
                <div class="nav-group">
                    <div class="nav-label">Travail</div>
                    <a class="nav-item" data-view="tasks">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                        Taches
                    </a>
                    <a class="nav-item" data-view="analytics">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                        Analytics
                    </a>
                </div>

                <!-- Marketing -->
                <div class="nav-group">
                    <div class="nav-label">Marketing</div>
                    <a class="nav-item" data-view="content">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                        Calendrier
                        <span class="nav-badge" id="nav-content-count" style="background: var(--purple);">0</span>
                    </a>
                    <a class="nav-item" data-view="blog">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg>
                        Blog
                        <span class="nav-badge" id="nav-blog-count" style="background: var(--green);">0</span>
                    </a>
                    <a class="nav-item" data-view="newsletter">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                        Newsletter
                        <span class="nav-badge" id="nav-newsletter-count" style="background: var(--cyan);">0</span>
                    </a>
                </div>

                <!-- Tools -->
                <div class="nav-group">
                    <div class="nav-label">Outils</div>
                    <a class="nav-item" href="https://pacifikai.com" target="_blank">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                        Landing Page
                    </a>
                    <a class="nav-item" href="https://supabase.com/dashboard/project/ogsimsfqwibcmotaeevb" target="_blank">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                        Supabase
                    </a>
                    <a class="nav-item" href="https://n8n.srv1140766.hstgr.cloud" target="_blank">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                        n8n
                    </a>
                    <a class="nav-item" href="https://www.facebook.com/profile.php?id=61587101037690" target="_blank">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/></svg>
                        Facebook
                    </a>
                </div>

                <!-- Firecrawl IA Tools -->
                <div class="nav-group">
                    <div class="nav-label">IA Tools</div>
                    <a class="nav-item" href="#" onclick="showIATool('https://open-lovable-black-psi.vercel.app', 'Site Cloner'); return false;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
                        Site Cloner
                    </a>
                    <a class="nav-item" href="#" onclick="showIATool('https://open-researcher-lake.vercel.app', 'Researcher'); return false;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                        Researcher
                    </a>
                    <a class="nav-item" href="#" onclick="showIATool('https://fire-enrich-beryl.vercel.app', 'B2B Enrichment'); return false;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        B2B Enrichment
                    </a>
                    <a class="nav-item" href="#" onclick="showIATool('https://firesearch-snowy.vercel.app', 'Deep Search'); return false;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                        Deep Search
                    </a>
                    <a class="nav-item" href="#" onclick="showIATool('https://fireplexity-iota.vercel.app', 'Fireplexity'); return false;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                        Fireplexity
                    </a>
                    <a class="nav-item" href="#" onclick="showIATool('https://firestarter-xi.vercel.app', 'RAG Chatbot'); return false;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                        RAG Chatbot
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="user" id="user-profile">
                    <div class="user-avatar" id="user-avatar">--</div>
                    <div class="user-info">
                        <div class="user-name" id="user-name">Chargement...</div>
                        <div class="user-role" id="user-role">-</div>
                    </div>
                    <button class="logout-btn" onclick="handleLogout()" title="Deconnexion">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                            <polyline points="16 17 21 12 16 7"/>
                            <line x1="21" y1="12" x2="9" y2="12"/>
                        </svg>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main -->
        <main class="main">
            <!-- Dashboard View -->
            <div class="view active" id="view-dashboard">
                <header class="header">
                    <div class="header-left">
                        <h1>Dashboard</h1>
                        <p id="current-date"></p>
                    </div>
                    <div class="header-actions">
                        <!-- Search Shortcut -->
                        <button class="btn btn-ghost" onclick="openGlobalSearch()" title="Recherche (Cmd+K)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                            <span class="search-shortcut">⌘K</span>
                        </button>
                        <!-- Focus Mode Toggle -->
                        <button class="btn btn-ghost" onclick="toggleFocusMode()" id="focus-toggle" title="Mode Focus">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg>
                            Focus
                        </button>
                        <!-- Theme Toggle -->
                        <button class="theme-toggle" onclick="toggleTheme()" title="Changer le thème">
                            <svg class="icon-sun" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                            </svg>
                            <svg class="icon-moon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                            </svg>
                        </button>
                        <!-- Guide Interactif Toggle -->
                        <button class="btn btn-ghost" onclick="startGuide()" id="guide-trigger-header" title="Guide Interactif">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                        </button>
                        <!-- Notifications -->
                        <div class="notification-bell" onclick="toggleNotifications(event)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                            <span class="notification-badge" id="notification-badge">0</span>
                            <!-- Notification Panel -->
                            <div class="notification-panel" id="notification-panel">
                                <div class="notification-header">
                                    <h3>Notifications</h3>
                                    <button class="notification-clear" onclick="clearAllNotifications(event)">Tout effacer</button>
                                </div>
                                <div class="notification-list" id="notification-list">
                                    <div class="notification-empty">Aucune notification</div>
                                </div>
                            </div>
                        </div>
                        <div class="sync-status" id="sync-status">
                            <span class="sync-dot"></span>
                            <span id="sync-text">Jamais sync</span>
                        </div>
                        <button class="btn btn-ghost" onclick="syncFromAirtable()" id="sync-btn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                            Sync
                        </button>
                        <button class="btn btn-primary" onclick="openNewProspectModal()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            Nouveau prospect
                        </button>
                    </div>
                </header>

                <div class="content">
                    <!-- Today's Follow-ups Widget -->
                    <div class="followups-widget" id="followups-widget" style="display: none;">
                        <div class="followups-header">
                            <div class="followups-title">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                                Relances du jour
                            </div>
                            <span class="followups-count" id="followups-count">0</span>
                        </div>
                        <div id="followups-list"></div>
                    </div>

                    <!-- Stats -->
                    <div class="stats-row">
                        <div class="stat">
                            <div class="stat-label">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
                                Prospects
                            </div>
                            <div class="stat-value" id="stat-total">0</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                                Contactes
                            </div>
                            <div class="stat-value" id="stat-contacted">0</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                RDV/Audits
                            </div>
                            <div class="stat-value" id="stat-meetings">0</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                                Pipeline
                            </div>
                            <div class="stat-value blue" id="stat-pipeline">0</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                                Clients
                            </div>
                            <div class="stat-value green" id="stat-won">0</div>
                        </div>
                    </div>

                    <!-- Analytics Grid -->
                    <div class="analytics-grid">
                        <div class="chart-card">
                            <div class="chart-header">
                                <span class="chart-title">Pipeline par Temperature</span>
                            </div>
                            <div class="bar-chart" id="chart-temp"></div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-header">
                                <span class="chart-title">Funnel de Conversion</span>
                            </div>
                            <div class="funnel" id="chart-funnel"></div>
                        </div>
                    </div>

                    <!-- Featured Prospects (with Assets) -->
                    <div class="featured-section">
                        <div class="featured-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                            Prospects avec prototypes crees
                        </div>
                        <div class="featured-prospects" id="featured-prospects"></div>
                    </div>

                    <!-- Pipeline -->
                    <div class="card" style="margin-bottom: 1.5rem;">
                        <div class="card-header">
                            <h3 class="card-title">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
                                Pipeline
                            </h3>
                        </div>
                        <div class="pipeline" id="pipeline-board"></div>
                    </div>

                    <!-- Grid -->
                    <div class="grid">
                        <!-- Recent Prospects -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
                                    Prospects recents
                                </h3>
                                <button class="card-btn" onclick="showView('prospects')">Voir tout</button>
                            </div>
                            <div class="card-body flush">
                                <div class="table-wrap">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Nom</th>
                                                <th>Secteur</th>
                                                <th>Status</th>
                                                <th>Valeur</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recent-prospects"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div>
                            <!-- Quick Links -->
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Actions rapides</h3>
                                </div>
                                <div class="card-body">
                                    <div class="quick-links">
                                        <a class="quick-link" href="https://supabase.com/dashboard/project/ogsimsfqwibcmotaeevb" target="_blank">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                                            Supabase
                                        </a>
                                        <a class="quick-link" href="mailto:jordy@pacifikai.com">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                                            Email
                                        </a>
                                        <a class="quick-link" href="https://calendly.com" target="_blank">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                            Calendly
                                        </a>
                                        <a class="quick-link" href="https://wa.me/68987123456" target="_blank">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
                                            WhatsApp
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Prospects View -->
            <div class="view" id="view-prospects">
                <header class="header">
                    <div class="header-left">
                        <h1>Prospects</h1>
                        <p>Gestion du CRM - <span id="prospects-count-header">0</span> prospects</p>
                    </div>
                    <div class="header-actions">
                        <div class="view-toggle">
                            <button class="view-toggle-btn active" data-pview="kanban" title="Kanban Temperature">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="5" height="18" rx="1"/><rect x="10" y="8" width="5" height="13" rx="1"/><rect x="17" y="5" width="5" height="16" rx="1"/></svg>
                                Kanban
                            </button>
                            <button class="view-toggle-btn" data-pview="list" title="Liste">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
                                Liste
                            </button>
                            <button class="view-toggle-btn" data-pview="grid" title="Grille">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
                                Grille
                            </button>
                            <button class="view-toggle-btn" data-pview="compact" title="Compact">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><line x1="3" y1="14" x2="21" y2="14"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
                                Compact
                            </button>
                            <button class="view-toggle-btn" data-pview="pipeline" title="Pipeline Status">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                                Pipeline
                            </button>
                        </div>
                        <button class="btn btn-ghost" onclick="syncProspectsFromAirtable()" title="Synchroniser depuis Airtable CRM">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                            Sync Airtable
                        </button>
                        <button class="btn btn-ghost" onclick="scoreAllProspects()" title="Scorer tous les prospects avec l'IA">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                            Score IA
                        </button>
                        <button class="btn btn-ghost" onclick="exportProspectsCSV()" title="Exporter en CSV">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            Export CSV
                        </button>
                        <button class="btn btn-primary" onclick="showNewProspectModal()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            Ajouter
                        </button>
                    </div>
                </header>
                <div class="content">
                    <!-- Summary Cards -->
                    <div class="summary-cards" id="summary-cards">
                        <div class="summary-card">
                            <div class="summary-card-icon hot">🔥</div>
                            <div class="summary-card-content">
                                <div class="summary-card-value" id="sum-hot">0</div>
                                <div class="summary-card-label">Hot</div>
                            </div>
                            <div class="summary-card-pipeline" id="sum-hot-val">0</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-card-icon chaud">🌡️</div>
                            <div class="summary-card-content">
                                <div class="summary-card-value" id="sum-chaud">0</div>
                                <div class="summary-card-label">Chaud</div>
                            </div>
                            <div class="summary-card-pipeline" id="sum-chaud-val">0</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-card-icon tiede">😐</div>
                            <div class="summary-card-content">
                                <div class="summary-card-value" id="sum-tiede">0</div>
                                <div class="summary-card-label">Tiede</div>
                            </div>
                            <div class="summary-card-pipeline" id="sum-tiede-val">0</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-card-icon froid">❄️</div>
                            <div class="summary-card-content">
                                <div class="summary-card-value" id="sum-froid">0</div>
                                <div class="summary-card-label">Froid</div>
                            </div>
                            <div class="summary-card-pipeline" id="sum-froid-val">0</div>
                        </div>
                    </div>

                    <!-- Toolbar -->
                    <div class="toolbar">
                        <div class="toolbar-left">
                            <div class="search-box">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                                <input type="text" id="search-prospects" placeholder="Rechercher..." oninput="filterProspects()">
                            </div>
                            <div class="dropdown">
                                <button class="dropdown-btn" onclick="toggleDropdown('sector-dropdown')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
                                    <span id="sector-filter-label">Tous secteurs</span>
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                                </button>
                                <div class="dropdown-menu" id="sector-dropdown"></div>
                            </div>
                            <div class="dropdown">
                                <button class="dropdown-btn" onclick="toggleDropdown('status-dropdown')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                    <span id="status-filter-label">Tous status</span>
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                                </button>
                                <div class="dropdown-menu" id="status-dropdown"></div>
                            </div>
                            <button class="btn btn-ghost" id="my-prospects-btn" onclick="toggleMyProspects()" style="font-size:0.8rem;padding:6px 12px;border-radius:8px;border:1px solid var(--accent);color:var(--accent);font-weight:500;gap:4px;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px;"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                Mes prospects
                            </button>
                            <!-- Assignee Filter -->
                            <div class="dropdown">
                                <button class="dropdown-btn" onclick="toggleDropdown('assignee-dropdown')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                    <span id="assignee-filter-label">Tous assignes</span>
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                                </button>
                                <div class="dropdown-menu" id="assignee-dropdown"></div>
                            </div>
                            <!-- Temperature Quick Filters -->
                            <div class="temp-chips" id="temp-chips">
                                <button class="temp-chip active" data-temp="all" onclick="setTempFilter('all')">Tous</button>
                                <button class="temp-chip hot" data-temp="hot" onclick="setTempFilter('hot')">Hot</button>
                                <button class="temp-chip chaud" data-temp="chaud" onclick="setTempFilter('chaud')">Chaud</button>
                                <button class="temp-chip tiede" data-temp="tiede" onclick="setTempFilter('tiede')">Tiede</button>
                                <button class="temp-chip froid" data-temp="froid" onclick="setTempFilter('froid')">Froid</button>
                            </div>
                            <!-- Has Assets Toggle -->
                            <button class="filter-toggle" id="assets-filter-toggle" onclick="toggleAssetsFilter()" title="Filtrer prospects avec assets">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                                Assets
                            </button>
                        </div>
                        <div class="toolbar-right">
                            <!-- Date Filter -->
                            <div class="dropdown">
                                <button class="dropdown-btn" onclick="toggleDropdown('date-dropdown')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                    <span id="date-filter-label">Toutes dates</span>
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                                </button>
                                <div class="dropdown-menu" id="date-dropdown">
                                    <div class="dropdown-item active" data-date="all" onclick="setDateFilter('all')">Toutes dates</div>
                                    <div class="dropdown-item" data-date="today" onclick="setDateFilter('today')">Aujourd'hui</div>
                                    <div class="dropdown-item" data-date="week" onclick="setDateFilter('week')">Cette semaine</div>
                                    <div class="dropdown-item" data-date="month" onclick="setDateFilter('month')">Ce mois</div>
                                    <div class="dropdown-item" data-date="quarter" onclick="setDateFilter('quarter')">Ce trimestre</div>
                                </div>
                            </div>
                            <!-- Sort -->
                            <div class="dropdown">
                                <button class="dropdown-btn" onclick="toggleDropdown('sort-dropdown')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="12" x2="14" y2="12"/><line x1="4" y1="18" x2="8" y2="18"/></svg>
                                    <span id="sort-label">Trier par</span>
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                                </button>
                                <div class="dropdown-menu" id="sort-dropdown">
                                    <div class="dropdown-item active" data-sort="priority" onclick="setSortBy('priority')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                                        Priorite (temp.)
                                    </div>
                                    <div class="dropdown-item" data-sort="value-desc" onclick="setSortBy('value-desc')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                                        Valeur (haut)
                                    </div>
                                    <div class="dropdown-item" data-sort="value-asc" onclick="setSortBy('value-asc')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                                        Valeur (bas)
                                    </div>
                                    <div class="dropdown-item" data-sort="company" onclick="setSortBy('company')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
                                        Entreprise (A-Z)
                                    </div>
                                    <div class="dropdown-item" data-sort="sector" onclick="setSortBy('sector')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
                                        Secteur (A-Z)
                                    </div>
                                    <div class="dropdown-item" data-sort="status" onclick="setSortBy('status')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                                        Status (pipeline)
                                    </div>
                                    <div class="dropdown-item" data-sort="assignee" onclick="setSortBy('assignee')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                        Assigne
                                    </div>
                                    <div class="dropdown-divider"></div>
                                    <div class="dropdown-item" data-sort="date-desc" onclick="setSortBy('date-desc')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                        Date (recent)
                                    </div>
                                    <div class="dropdown-item" data-sort="date-asc" onclick="setSortBy('date-asc')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                        Date (ancien)
                                    </div>
                                    <div class="dropdown-item" data-sort="score" onclick="setSortBy('score')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                                        Score IA
                                    </div>
                                    <div class="dropdown-divider"></div>
                                    <div class="dropdown-item" data-sort="assets" onclick="setSortBy('assets')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                                        Avec assets
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Kanban View (Temperature) -->
                    <div class="prospects-view-container active" id="pview-kanban">
                        <div class="kanban-temp" id="kanban-temp-board"></div>
                    </div>

                    <!-- List View -->
                    <div class="prospects-view-container" id="pview-list">
                        <div class="card">
                            <div class="card-body flush">
                                <div class="table-wrap">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th class="sortable" data-sort="company">Entreprise</th>
                                                <th>Contact</th>
                                                <th class="sortable" data-sort="sector">Secteur</th>
                                                <th class="sortable" data-sort="status">Status</th>
                                                <th class="sortable" data-sort="value">Valeur</th>
                                                <th>Score IA</th>
                                                <th class="sortable" data-sort="priority">Priorite</th>
                                                <th>Assigne</th>
                                            </tr>
                                        </thead>
                                        <tbody id="prospects-table"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Grid View (Cards) -->
                    <div class="prospects-view-container" id="pview-grid">
                        <div class="grid-view" id="grid-board"></div>
                    </div>

                    <!-- Compact View -->
                    <div class="prospects-view-container" id="pview-compact">
                        <div class="card">
                            <div class="card-body flush">
                                <div class="compact-list" id="compact-list"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Pipeline View (Status) -->
                    <div class="prospects-view-container" id="pview-pipeline">
                        <div class="pipeline" id="pipeline-status-board"></div>
                    </div>
                </div>
            </div>

            <!-- Tasks View -->
            <div class="view" id="view-tasks">
                <header class="header">
                    <div class="header-left">
                        <h1>Gestion des Taches</h1>
                        <p>Suivi des taches par projet et assignation</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-ghost" id="my-tasks-btn" onclick="toggleMyTasks()" style="font-size:0.8rem;padding:6px 12px;border-radius:8px;border:1px solid var(--accent);color:var(--accent);font-weight:500;gap:4px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                            Mes taches
                        </button>
                        <div class="search-input-wrapper" style="position:relative;width:180px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="position:absolute;left:8px;top:50%;transform:translateY(-50%);width:14px;height:14px;opacity:0.5;"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                            <input type="text" id="search-tasks" placeholder="Rechercher..." oninput="filterTasks()" style="width:100%;padding:6px 8px 6px 28px;background:var(--bg-muted);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:0.8rem;">
                        </div>
                        <select class="filter-select" id="task-assignee-filter" onchange="filterTasks()">
                            <option value="all">Tous</option>
                            <option value="unassigned">Non assigne</option>
                        </select>
                        <select class="filter-select" id="task-project-filter" onchange="filterTasks()">
                            <option value="all">Tous les projets</option>
                            <option value="ATN">Air Tahiti Nui</option>
                            <option value="PACIFIKAI">PACIFIK'AI</option>
                            <option value="HVC">High Value Capital</option>
                            <option value="COWAN">Cowan Motor</option>
                            <option value="other">Autres</option>
                        </select>
                        <select class="filter-select" id="task-priority-filter" onchange="filterTasks()">
                            <option value="all">Toutes priorites</option>
                            <option value="Urgent">Urgent</option>
                            <option value="Normal">Normal</option>
                            <option value="Faible">Faible</option>
                        </select>
                        <select class="filter-select" id="task-sort-select" onchange="filterTasks()">
                            <option value="priority">Tri: Priorite</option>
                            <option value="dueDate">Tri: Echeance</option>
                            <option value="assignee">Tri: Assigne</option>
                            <option value="project">Tri: Projet</option>
                            <option value="created">Tri: Creation</option>
                        </select>
                        <div class="view-toggle" style="display:flex;gap:2px;background:var(--bg-muted);border-radius:6px;padding:2px;">
                            <button class="btn btn-ghost task-view-btn active" id="task-view-kanban-btn" onclick="switchTaskView('kanban')" title="Vue Kanban" style="padding:4px 8px;border-radius:4px;font-size:0.75rem;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
                            </button>
                            <button class="btn btn-ghost task-view-btn" id="task-view-list-btn" onclick="switchTaskView('list')" title="Vue Liste" style="padding:4px 8px;border-radius:4px;font-size:0.75rem;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
                            </button>
                        </div>
                        <button class="btn btn-ghost" onclick="loadTasksFromAirtable()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                            Sync
                        </button>
                        <button class="btn btn-primary" onclick="openTaskModal()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            Nouvelle tache
                        </button>
                    </div>
                </header>
                <div class="content">
                    <!-- Task Stats -->
                    <div class="stats-row" style="margin-bottom: 1.5rem; grid-template-columns: repeat(4, 1fr);">
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--red);">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                            </div>
                            <div class="stat-info">
                                <span class="stat-value" id="task-urgent-count">0</span>
                                <span class="stat-label">Urgent</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--orange);">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                            </div>
                            <div class="stat-info">
                                <span class="stat-value" id="task-pending-count">0</span>
                                <span class="stat-label">A faire</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--blue);">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v4"/><path d="M12 18v4"/><path d="M4.93 4.93l2.83 2.83"/><path d="M16.24 16.24l2.83 2.83"/><path d="M2 12h4"/><path d="M18 12h4"/><path d="M4.93 19.07l2.83-2.83"/><path d="M16.24 7.76l2.83-2.83"/></svg>
                            </div>
                            <div class="stat-info">
                                <span class="stat-value" id="task-progress-count">0</span>
                                <span class="stat-label">En cours</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--green);">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                            </div>
                            <div class="stat-info">
                                <span class="stat-value" id="task-done-count">0</span>
                                <span class="stat-label">Termine</span>
                            </div>
                        </div>
                    </div>

                    <!-- Task Progress Bar -->
                    <div id="task-progress-bar-container" style="margin-bottom:1rem;background:var(--bg-muted);border-radius:8px;padding:0.5rem 1rem;display:flex;align-items:center;gap:1rem;">
                        <span style="font-size:0.75rem;color:var(--text-muted);white-space:nowrap;" id="task-progress-label">0% termine</span>
                        <div style="flex:1;height:6px;background:var(--bg-secondary);border-radius:3px;overflow:hidden;">
                            <div id="task-progress-fill" style="height:100%;background:var(--green);border-radius:3px;transition:width 0.3s;width:0%;"></div>
                        </div>
                        <span style="font-size:0.7rem;color:var(--text-dim);" id="task-progress-detail">0/0</span>
                        <span id="task-overdue-badge" style="display:none;font-size:0.7rem;background:rgba(239,68,68,0.15);color:var(--red);padding:2px 8px;border-radius:10px;font-weight:600;"></span>
                    </div>

                    <!-- Task List View -->
                    <div id="task-list-view" style="display:none;">
                        <div class="card" style="overflow-x:auto;">
                            <table style="width:100%;border-collapse:collapse;">
                                <thead>
                                    <tr style="border-bottom:1px solid var(--border);font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;">
                                        <th style="padding:0.5rem;text-align:left;width:32px;"></th>
                                        <th style="padding:0.5rem;text-align:left;">Titre</th>
                                        <th style="padding:0.5rem;text-align:left;width:80px;">Status</th>
                                        <th style="padding:0.5rem;text-align:left;width:80px;">Priorite</th>
                                        <th style="padding:0.5rem;text-align:left;width:90px;">Echeance</th>
                                        <th style="padding:0.5rem;text-align:left;width:60px;">Assigne</th>
                                        <th style="padding:0.5rem;text-align:left;width:80px;">Projet</th>
                                        <th style="padding:0.5rem;text-align:center;width:60px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="task-list-tbody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Task Kanban -->
                    <div class="pipeline" id="task-kanban">
                        <div class="pipeline-column" data-status="À faire">
                            <div class="pipeline-header">
                                <span class="pipeline-title">A faire</span>
                                <span class="pipeline-count" id="kanban-todo-count">0</span>
                            </div>
                            <div class="pipeline-cards" id="kanban-todo"></div>
                        </div>
                        <div class="pipeline-column" data-status="En cours">
                            <div class="pipeline-header">
                                <span class="pipeline-title">En cours</span>
                                <span class="pipeline-count" id="kanban-progress-count">0</span>
                            </div>
                            <div class="pipeline-cards" id="kanban-progress"></div>
                        </div>
                        <div class="pipeline-column" data-status="Bloqué">
                            <div class="pipeline-header">
                                <span class="pipeline-title">Bloque</span>
                                <span class="pipeline-count" id="kanban-blocked-count">0</span>
                            </div>
                            <div class="pipeline-cards" id="kanban-blocked"></div>
                        </div>
                        <div class="pipeline-column" data-status="Terminé">
                            <div class="pipeline-header">
                                <span class="pipeline-title">Termine</span>
                                <span class="pipeline-count" id="kanban-done-count">0</span>
                            </div>
                            <div class="pipeline-cards" id="kanban-done"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Calendar View -->
            <div class="view" id="view-content">
                <header class="header">
                    <div class="header-left">
                        <h1>Content Calendar</h1>
                        <p>Planification multi-plateforme (Facebook, LinkedIn, Instagram)</p>
                    </div>
                    <div class="header-actions">
                        <select class="filter-select" id="content-platform-filter" onchange="filterContent()">
                            <option value="all">Toutes plateformes</option>
                            <option value="Facebook">Facebook</option>
                            <option value="LinkedIn">LinkedIn</option>
                            <option value="Instagram">Instagram</option>
                        </select>
                        <select class="filter-select" id="content-status-filter" onchange="filterContent()">
                            <option value="all">Tous status</option>
                            <option value="Brouillon">Brouillon</option>
                            <option value="Planifié">Planifie</option>
                            <option value="Publié">Publie</option>
                        </select>
                        <button class="btn btn-ghost" onclick="loadContentFromAirtable()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                            Sync
                        </button>
                        <button class="btn ai-generate-btn" onclick="generateWeeklyContent()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1"/><circle cx="9" cy="18" r="2"/><path d="M9 11v5"/></svg>
                            Generer Semaine
                        </button>
                        <button class="btn btn-primary" onclick="openCreateContentModal()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            Nouveau
                        </button>
                    </div>
                </header>

                <div class="content" style="padding: 1.5rem 2rem;">
                    <!-- Content KPIs -->
                    <div class="content-kpi-row">
                        <div class="content-kpi">
                            <div class="content-kpi-value" id="kpi-total-posts" style="color: var(--accent);">0</div>
                            <div class="content-kpi-label">Total Posts</div>
                        </div>
                        <div class="content-kpi">
                            <div class="content-kpi-value" id="kpi-scheduled" style="color: var(--purple);">0</div>
                            <div class="content-kpi-label">Planifies</div>
                        </div>
                        <div class="content-kpi">
                            <div class="content-kpi-value" id="kpi-published" style="color: var(--green);">0</div>
                            <div class="content-kpi-label">Publies</div>
                        </div>
                        <div class="content-kpi">
                            <div class="content-kpi-value" id="kpi-engagement" style="color: var(--orange);">0</div>
                            <div class="content-kpi-label">Engagement Total</div>
                        </div>
                    </div>

                    <!-- Funnel Distribution Mini -->
                    <div class="stats-row" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 1.5rem;">
                        <div class="stat" style="border-left: 3px solid var(--green);">
                            <div class="stat-label">TOFU - Awareness</div>
                            <div class="stat-value" id="kpi-tofu">0</div>
                        </div>
                        <div class="stat" style="border-left: 3px solid var(--yellow);">
                            <div class="stat-label">MOFU - Consideration</div>
                            <div class="stat-value" id="kpi-mofu">0</div>
                        </div>
                        <div class="stat" style="border-left: 3px solid var(--red);">
                            <div class="stat-label">BOFU - Conversion</div>
                            <div class="stat-value" id="kpi-bofu">0</div>
                        </div>
                    </div>
                </div>

                <div class="content-grid" style="padding: 0 2rem 2rem;">
                    <!-- Calendar -->
                    <div class="content-calendar">
                        <div class="calendar-header">
                            <h3 id="calendar-month-year">Janvier 2026</h3>
                            <div class="calendar-nav">
                                <button onclick="navigateCalendar(-1)">&lt; Precedent</button>
                                <button onclick="navigateCalendar(0)">Aujourd'hui</button>
                                <button onclick="navigateCalendar(1)">Suivant &gt;</button>
                            </div>
                        </div>
                        <div class="calendar-week">
                            <div class="calendar-day-label">Lun</div>
                            <div class="calendar-day-label">Mar</div>
                            <div class="calendar-day-label">Mer</div>
                            <div class="calendar-day-label">Jeu</div>
                            <div class="calendar-day-label">Ven</div>
                            <div class="calendar-day-label">Sam</div>
                            <div class="calendar-day-label">Dim</div>
                        </div>
                        <div class="calendar-days" id="calendar-days">
                            <!-- Generated by JS -->
                        </div>
                    </div>

                    <!-- Sidebar -->
                    <div class="post-sidebar">
                        <!-- Quick Create Post -->
                        <div class="post-create-card">
                            <h3>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1"/></svg>
                                Creation Rapide
                            </h3>
                            <textarea class="post-textarea" id="post-content" placeholder="Ecris ton post ou laisse l'IA generer du contenu..."></textarea>

                            <div class="post-options">
                                <div class="post-option active" data-type="Actualité IA">Actu IA</div>
                                <div class="post-option" data-type="Cas client">Cas Client</div>
                                <div class="post-option" data-type="Tips">Conseil</div>
                            </div>

                            <div class="edit-form-row" style="margin-bottom: 0.75rem;">
                                <div>
                                    <label style="font-size: 0.6875rem; color: var(--text-dim); display: block; margin-bottom: 0.25rem;">Plateforme</label>
                                    <select id="post-platform" style="width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 0.5rem; color: var(--text); font-size: 0.8125rem;">
                                        <option value="Facebook">Facebook</option>
                                        <option value="LinkedIn">LinkedIn</option>
                                        <option value="Instagram">Instagram</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size: 0.6875rem; color: var(--text-dim); display: block; margin-bottom: 0.25rem;">Funnel</label>
                                    <select id="post-funnel" style="width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 0.5rem; color: var(--text); font-size: 0.8125rem;">
                                        <option value="TOFU - Awareness">TOFU</option>
                                        <option value="MOFU - Consideration">MOFU</option>
                                        <option value="BOFU - Conversion">BOFU</option>
                                    </select>
                                </div>
                            </div>

                            <div class="post-schedule">
                                <input type="date" id="post-date" />
                                <input type="time" id="post-time" value="08:00" />
                            </div>

                            <div class="post-actions">
                                <button class="btn ai-generate-btn" onclick="generatePostWithAI()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1"/></svg>
                                    Generer IA
                                </button>
                                <button class="btn btn-primary" onclick="createContentPost()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                                    Creer
                                </button>
                            </div>
                        </div>

                        <!-- Posts List from Airtable -->
                        <div class="posts-list">
                            <div class="posts-list-header">
                                <h3>Posts Airtable</h3>
                                <div class="posts-list-tabs">
                                    <div class="posts-list-tab active" data-filter="all">Tous</div>
                                    <div class="posts-list-tab" data-filter="Planifié">Planifies</div>
                                    <div class="posts-list-tab" data-filter="Publié">Publies</div>
                                </div>
                            </div>
                            <div id="posts-list-content">
                                <div style="text-align: center; color: var(--text-dim); padding: 2rem;">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 32px; height: 32px; margin-bottom: 0.5rem;"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
                                    <p>Chargement...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit Content Modal -->
            <div class="modal-overlay" id="edit-content-modal" style="display: none;" onclick="closeEditContentModal(event)">
                <div class="edit-content-modal" onclick="event.stopPropagation()">
                    <h3>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
                        <span id="edit-content-title">Modifier le post</span>
                    </h3>
                    <input type="hidden" id="edit-content-id" />

                    <div class="edit-form-group">
                        <label>Titre</label>
                        <input type="text" id="edit-content-titre" placeholder="Titre du post..." />
                    </div>

                    <div class="edit-form-group">
                        <label>Contenu</label>
                        <textarea id="edit-content-contenu" placeholder="Texte du post..."></textarea>
                    </div>

                    <div class="edit-form-row">
                        <div class="edit-form-group">
                            <label>Type</label>
                            <select id="edit-content-type">
                                <option value="Actualité IA">Actualite IA</option>
                                <option value="Cas client">Cas client</option>
                                <option value="Tips">Tips</option>
                                <option value="Promo">Promo</option>
                                <option value="Engagement">Engagement</option>
                                <option value="Behind the scenes">Behind the scenes</option>
                            </select>
                        </div>
                        <div class="edit-form-group">
                            <label>Status</label>
                            <select id="edit-content-status">
                                <option value="Brouillon">Brouillon</option>
                                <option value="Planifié">Planifie</option>
                                <option value="Publié">Publie</option>
                            </select>
                        </div>
                    </div>

                    <div class="edit-form-row-3">
                        <div class="edit-form-group">
                            <label>Plateforme(s)</label>
                            <select id="edit-content-platform" multiple style="height: 80px;">
                                <option value="Facebook">Facebook</option>
                                <option value="LinkedIn">LinkedIn</option>
                                <option value="Instagram">Instagram</option>
                            </select>
                        </div>
                        <div class="edit-form-group">
                            <label>Funnel Stage</label>
                            <select id="edit-content-funnel">
                                <option value="">Non defini</option>
                                <option value="TOFU - Awareness">TOFU - Awareness</option>
                                <option value="MOFU - Consideration">MOFU - Consideration</option>
                                <option value="BOFU - Conversion">BOFU - Conversion</option>
                            </select>
                        </div>
                        <div class="edit-form-group">
                            <label>Semaine</label>
                            <input type="number" id="edit-content-semaine" min="1" max="52" />
                        </div>
                    </div>

                    <div class="edit-form-row">
                        <div class="edit-form-group">
                            <label>Date publication</label>
                            <input type="date" id="edit-content-date" />
                        </div>
                        <div class="edit-form-group">
                            <label>Engagement (likes + comments)</label>
                            <input type="number" id="edit-content-engagement" min="0" />
                        </div>
                    </div>

                    <div class="edit-form-group">
                        <label>Image URL</label>
                        <input type="url" id="edit-content-image" placeholder="https://..." />
                    </div>

                    <div style="display: flex; justify-content: space-between; margin-top: 1.5rem;">
                        <button class="btn btn-ghost" onclick="closeEditContentModal()">Annuler</button>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn" style="background: var(--purple); color: white;" onclick="previewContentPost()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                                Previsualiser
                            </button>
                            <button class="btn btn-primary" onclick="saveContentPost()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                                Sauvegarder
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Preview Modal -->
            <div class="content-preview-overlay" id="content-preview-modal" style="display: none;" onclick="closeContentPreview(event)">
                <div class="content-preview-modal" onclick="event.stopPropagation()">
                    <div class="content-preview-header">
                        <h3 style="font-size: 0.9375rem; display: flex; align-items: center; gap: 0.5rem;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                            Apercu <span id="preview-platform-name">Facebook</span>
                        </h3>
                        <button onclick="closeContentPreview()" style="background: none; border: none; cursor: pointer; color: var(--text-muted);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                        </button>
                    </div>
                    <div class="content-preview-body">
                        <div class="content-preview-post">
                            <div class="content-preview-post-header">
                                <div class="preview-avatar">P</div>
                                <div class="preview-post-info">
                                    <div class="preview-name">PACIFIK'AI</div>
                                    <div class="preview-time" id="preview-date">Maintenant</div>
                                </div>
                            </div>
                            <div class="content-preview-text" id="preview-content">Contenu du post...</div>
                        </div>
                    </div>
                    <div class="content-preview-footer">
                        <button class="btn btn-ghost" onclick="closeContentPreview()">Fermer</button>
                        <button class="btn btn-primary" onclick="closeContentPreview(); saveContentPost();">
                            Valider & Sauvegarder
                        </button>
                    </div>
                </div>
            </div>

            <!-- Blog View -->
            <div class="view" id="view-blog">
                <header class="header">
                    <div class="header-left">
                        <h1>Blog Articles</h1>
                        <p>Gestion des articles du blog pacifikai.com</p>
                    </div>
                    <div class="header-actions">
                        <select class="filter-select" id="blog-category-filter" onchange="filterBlogArticles()">
                            <option value="all">Toutes categories</option>
                            <option value="Aviation">Aviation</option>
                            <option value="Hotellerie">Hotellerie</option>
                            <option value="Restauration">Restauration</option>
                            <option value="Finance">Finance</option>
                            <option value="Tourisme">Tourisme</option>
                            <option value="Logistique">Logistique</option>
                        </select>
                        <select class="filter-select" id="blog-status-filter" onchange="filterBlogArticles()">
                            <option value="all">Tous status</option>
                            <option value="Draft">Brouillon</option>
                            <option value="Ready">Pret</option>
                            <option value="Published">Publie</option>
                            <option value="Scheduled">Planifie</option>
                        </select>
                        <button class="btn btn-ghost" onclick="loadBlogArticles()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                            Sync
                        </button>
                        <a class="btn btn-ghost" href="https://pacifikai.com/blog/" target="_blank">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                            Voir Blog
                        </a>
                        <button class="btn btn-primary" onclick="openCreateBlogModal()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            Nouvel Article
                        </button>
                    </div>
                </header>

                <div class="content" style="padding: 1.5rem 2rem;">
                    <!-- Blog KPIs -->
                    <div class="stats-row" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 1.5rem;">
                        <div class="stat">
                            <div class="stat-label">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
                                Total Articles
                            </div>
                            <div class="stat-value blue" id="kpi-blog-total">0</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                Publies
                            </div>
                            <div class="stat-value green" id="kpi-blog-published">0</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                Planifies
                            </div>
                            <div class="stat-value" style="color: var(--purple);" id="kpi-blog-scheduled">0</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                                Brouillons
                            </div>
                            <div class="stat-value" style="color: var(--text-muted);" id="kpi-blog-drafts">0</div>
                        </div>
                    </div>

                    <!-- Blog Articles Grid -->
                    <div class="section-header" style="margin-bottom: 1rem;">
                        <h2 style="font-size: 1rem; font-weight: 600;">Articles</h2>
                    </div>
                    <div class="blog-articles-grid" id="blog-articles-grid">
                        <!-- Generated by JS -->
                        <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                            Chargement des articles...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Blog Article Modal -->
            <div class="modal-overlay" id="blog-article-modal" style="display: none;" onclick="closeBlogModal(event)">
                <div class="edit-content-modal" onclick="event.stopPropagation()" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                    <h3>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
                        <span id="blog-modal-title">Nouvel Article</span>
                    </h3>
                    <input type="hidden" id="blog-article-id" />

                    <div class="edit-form-group">
                        <label>Titre</label>
                        <input type="text" id="blog-article-title" placeholder="Titre de l'article..." />
                    </div>

                    <div class="edit-form-row">
                        <div class="edit-form-group">
                            <label>Slug (URL)</label>
                            <input type="text" id="blog-article-slug" placeholder="mon-article-slug" />
                        </div>
                        <div class="edit-form-group">
                            <label>Temps de lecture (min)</label>
                            <input type="number" id="blog-article-reading-time" min="1" max="60" value="5" />
                        </div>
                    </div>

                    <div class="edit-form-row">
                        <div class="edit-form-group">
                            <label>Categorie</label>
                            <select id="blog-article-category">
                                <option value="Aviation">Aviation</option>
                                <option value="Hotellerie">Hotellerie</option>
                                <option value="Restauration">Restauration</option>
                                <option value="Finance">Finance</option>
                                <option value="Tourisme">Tourisme</option>
                                <option value="Logistique">Logistique</option>
                            </select>
                        </div>
                        <div class="edit-form-group">
                            <label>Status</label>
                            <select id="blog-article-status">
                                <option value="Draft">Brouillon</option>
                                <option value="Ready">Pret</option>
                                <option value="Scheduled">Planifie</option>
                                <option value="Published">Publie</option>
                            </select>
                        </div>
                    </div>

                    <div class="edit-form-row">
                        <div class="edit-form-group">
                            <label>Date de publication</label>
                            <input type="date" id="blog-article-date" />
                        </div>
                        <div class="edit-form-group" style="display: flex; align-items: center; gap: 0.5rem; padding-top: 1.5rem;">
                            <input type="checkbox" id="blog-article-featured" style="width: auto;" />
                            <label for="blog-article-featured" style="margin: 0; cursor: pointer;">Article mis en avant</label>
                        </div>
                    </div>

                    <div class="edit-form-group">
                        <label>Extrait / Description courte</label>
                        <textarea id="blog-article-excerpt" placeholder="Resume de l'article en 2-3 phrases..." style="height: 80px;"></textarea>
                    </div>

                    <div class="edit-form-group">
                        <label>Contenu (Markdown)</label>
                        <textarea id="blog-article-content" placeholder="Contenu complet de l'article..." style="height: 200px; font-family: monospace; font-size: 0.8125rem;"></textarea>
                    </div>

                    <div class="edit-form-group">
                        <label>Image Hero (URL)</label>
                        <input type="url" id="blog-article-image" placeholder="https://..." />
                    </div>

                    <div class="edit-form-group">
                        <label>Sources (URLs, une par ligne)</label>
                        <textarea id="blog-article-sources" placeholder="https://source1.com&#10;https://source2.com" style="height: 60px; font-family: monospace; font-size: 0.75rem;"></textarea>
                    </div>

                    <div class="edit-form-row">
                        <div class="edit-form-group">
                            <label>CTA Titre</label>
                            <input type="text" id="blog-article-cta-title" placeholder="Pret a transformer votre entreprise ?" />
                        </div>
                        <div class="edit-form-group">
                            <label>CTA Texte</label>
                            <input type="text" id="blog-article-cta-text" placeholder="Discutons de votre projet" />
                        </div>
                    </div>

                    <div class="edit-form-group">
                        <label>Meta Description (SEO)</label>
                        <textarea id="blog-article-meta-desc" placeholder="Description pour les moteurs de recherche (150-160 caracteres)..." style="height: 60px;"></textarea>
                    </div>

                    <div style="display: flex; justify-content: space-between; margin-top: 1.5rem;">
                        <button class="btn btn-ghost" onclick="closeBlogModal()">Annuler</button>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn" style="background: var(--purple); color: white;" onclick="previewBlogArticle(document.getElementById('blog-article-id').value || null)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                                Voir sur le site
                            </button>
                            <button class="btn btn-primary" onclick="saveBlogArticle()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                                Sauvegarder
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Newsletter View -->
            <div class="view" id="view-newsletter">
                <header class="header">
                    <div class="header-left">
                        <h1>Newsletter</h1>
                        <p>Gestion des campagnes email PACIFIK'AI</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-ghost" onclick="loadNewsletterCampaigns()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                            Sync
                        </button>
                        <a class="btn btn-ghost" href="https://app.brevo.com" target="_blank">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                            Brevo
                        </a>
                        <button class="btn btn-primary" onclick="openCreateNewsletterModal()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            Nouvelle Campagne
                        </button>
                    </div>
                </header>

                <div class="content" style="padding: 1.5rem 2rem;">
                    <!-- Newsletter KPIs -->
                    <div class="stats-row" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 1.5rem;">
                        <div class="stat">
                            <div class="stat-label">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                                Abonnes
                            </div>
                            <div class="stat-value blue" id="kpi-newsletter-subscribers">0</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                                Campagnes
                            </div>
                            <div class="stat-value" id="kpi-newsletter-campaigns">0</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                Planifiees
                            </div>
                            <div class="stat-value" style="color: var(--purple);" id="kpi-newsletter-scheduled">0</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                Envoyees
                            </div>
                            <div class="stat-value green" id="kpi-newsletter-sent">0</div>
                        </div>
                    </div>

                    <!-- Campaigns List -->
                    <div class="section-header" style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="font-size: 1rem; font-weight: 600;">Campagnes</h2>
                        <div style="display: flex; gap: 0.5rem;">
                            <select class="filter-select" id="newsletter-status-filter" onchange="filterNewsletterCampaigns()">
                                <option value="all">Tous status</option>
                                <option value="Draft">Brouillon</option>
                                <option value="Ready">Pret</option>
                                <option value="Scheduled">Planifie</option>
                                <option value="Sent">Envoye</option>
                            </select>
                        </div>
                    </div>
                    <div class="newsletter-campaigns-list" id="newsletter-campaigns-list">
                        <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                            Chargement des campagnes...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Newsletter Editor Modal -->
            <div class="modal-overlay" id="newsletter-editor-modal" style="display: none;" onclick="closeNewsletterModal(event)">
                <div class="edit-content-modal" onclick="event.stopPropagation()" style="max-width: 1200px; max-height: 95vh; overflow: hidden; display: flex; flex-direction: column;">
                    <h3 style="flex-shrink: 0;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                        <span id="newsletter-modal-title">Nouvelle Campagne</span>
                    </h3>
                    <input type="hidden" id="newsletter-campaign-id" />

                    <div style="display: flex; gap: 1.5rem; flex: 1; overflow: hidden;">
                        <!-- Editor Panel -->
                        <div style="flex: 1; display: flex; flex-direction: column; overflow-y: auto;">
                            <div class="edit-form-group">
                                <label>Objet</label>
                                <input type="text" id="newsletter-subject" placeholder="Objet de l'email..." />
                            </div>

                            <div class="edit-form-group">
                                <label>Texte de preview</label>
                                <input type="text" id="newsletter-preview-text" placeholder="Texte visible dans la boite de reception..." />
                            </div>

                            <div class="edit-form-row">
                                <div class="edit-form-group">
                                    <label>Status</label>
                                    <select id="newsletter-status">
                                        <option value="Draft">Brouillon</option>
                                        <option value="Ready">Pret a envoyer</option>
                                        <option value="Scheduled">Planifie</option>
                                    </select>
                                </div>
                                <div class="edit-form-group">
                                    <label>Date d'envoi planifie</label>
                                    <input type="datetime-local" id="newsletter-scheduled-date" />
                                </div>
                            </div>

                            <div class="edit-form-group" style="flex: 1; display: flex; flex-direction: column;">
                                <label>Contenu (HTML)</label>
                                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <button type="button" class="btn btn-ghost" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="insertNewsletterBlock('header')">Header</button>
                                    <button type="button" class="btn btn-ghost" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="insertNewsletterBlock('article')">Article</button>
                                    <button type="button" class="btn btn-ghost" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="insertNewsletterBlock('cta')">CTA</button>
                                    <button type="button" class="btn btn-ghost" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="insertNewsletterBlock('footer')">Footer</button>
                                </div>
                                <textarea id="newsletter-content-html" placeholder="<h1>Titre</h1>..." style="flex: 1; min-height: 300px; font-family: monospace; font-size: 0.75rem;" oninput="updateNewsletterPreview()"></textarea>
                            </div>
                        </div>

                        <!-- Preview Panel -->
                        <div style="width: 400px; flex-shrink: 0; display: flex; flex-direction: column; border-left: 1px solid var(--bg-muted); padding-left: 1.5rem;">
                            <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                                Preview
                            </div>
                            <div style="flex: 1; background: white; border-radius: 8px; overflow: hidden; border: 1px solid var(--bg-muted);">
                                <div style="background: #f5f5f5; padding: 0.5rem 0.75rem; border-bottom: 1px solid #e0e0e0;">
                                    <div style="font-size: 0.625rem; color: #666;">De: PACIFIK'AI &lt;newsletter@pacifikai.com&gt;</div>
                                    <div style="font-size: 0.625rem; color: #666;">Objet: <span id="preview-subject" style="color: #333; font-weight: 500;">-</span></div>
                                </div>
                                <div id="newsletter-preview-content" style="padding: 1rem; color: #333; font-size: 0.8125rem; overflow-y: auto; max-height: 450px;">
                                    <p style="color: #999; text-align: center;">Apercu du contenu...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--bg-muted); flex-shrink: 0;">
                        <button class="btn btn-ghost" onclick="closeNewsletterModal()">Annuler</button>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn" style="background: var(--purple); color: white;" onclick="sendTestNewsletter()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                                Test Email
                            </button>
                            <button class="btn btn-primary" onclick="saveNewsletterCampaign()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                                Sauvegarder
                            </button>
                            <button class="btn" style="background: var(--green); color: white;" onclick="sendNewsletterCampaign()" id="btn-send-newsletter">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                                Envoyer
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Focus Mode View -->
            <div class="view" id="view-focus">
                <header class="header">
                    <div class="header-left">
                        <h1>Mode Focus</h1>
                        <p>Concentre-toi sur l'essentiel</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-ghost" onclick="toggleFocusMode()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                            Quitter Focus
                        </button>
                    </div>
                </header>
                <div class="content">
                    <div class="focus-panel">
                        <div class="focus-header">
                            <div class="focus-date" id="focus-date"></div>
                            <div class="focus-greeting">Bonjour Jordy, voici ton plan du jour</div>
                        </div>

                        <!-- Urgent Tasks -->
                        <div class="focus-section">
                            <div class="focus-section-title">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                                Taches Urgentes
                            </div>
                            <div id="focus-urgent-tasks"></div>
                        </div>

                        <!-- Today's Follow-ups -->
                        <div class="focus-section">
                            <div class="focus-section-title">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                                Relances Prevues Aujourd'hui
                            </div>
                            <div id="focus-followups"></div>
                        </div>

                        <!-- Pipeline Summary -->
                        <div class="focus-section">
                            <div class="focus-section-title">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                                Apercu Pipeline
                            </div>
                            <div class="stats-grid">
                                <div class="stat-card-mini">
                                    <div class="stat-card-mini-label">Valeur Pipeline</div>
                                    <div class="stat-card-mini-value" id="focus-pipeline-value">0 XPF</div>
                                </div>
                                <div class="stat-card-mini">
                                    <div class="stat-card-mini-label">Prospects Actifs</div>
                                    <div class="stat-card-mini-value" id="focus-active-count">0</div>
                                </div>
                                <div class="stat-card-mini">
                                    <div class="stat-card-mini-label">Propositions en cours</div>
                                    <div class="stat-card-mini-value" id="focus-proposals">0</div>
                                </div>
                                <div class="stat-card-mini">
                                    <div class="stat-card-mini-label">Taux de conversion</div>
                                    <div class="stat-card-mini-value" id="focus-conversion">0%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics View -->
            <div class="view" id="view-analytics">
                <header class="header">
                    <div class="header-left">
                        <h1>Analytics</h1>
                        <p>Performance du pipeline commercial</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-ghost" onclick="renderAnalyticsView()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                            Rafraichir
                        </button>
                    </div>
                </header>
                <div class="content">
                    <!-- KPI Summary -->
                    <div class="analytics-kpi-row" id="analytics-kpi-row">
                        <div class="analytics-kpi">
                            <div class="analytics-kpi-value" id="kpi-total">0</div>
                            <div class="analytics-kpi-label">Total Prospects</div>
                        </div>
                        <div class="analytics-kpi">
                            <div class="analytics-kpi-value" id="kpi-pipeline" style="color: var(--green);">0</div>
                            <div class="analytics-kpi-label">Pipeline Total</div>
                        </div>
                        <div class="analytics-kpi">
                            <div class="analytics-kpi-value" id="kpi-conversion">0%</div>
                            <div class="analytics-kpi-label">Taux Conversion</div>
                        </div>
                        <div class="analytics-kpi">
                            <div class="analytics-kpi-value" id="kpi-avg">0</div>
                            <div class="analytics-kpi-label">Valeur Moyenne</div>
                        </div>
                    </div>

                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <!-- Pipeline by Status (Bar Chart) -->
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                                    Pipeline par Status
                                </div>
                            </div>
                            <div class="card-body" style="height: 280px;">
                                <canvas id="chart-pipeline-status"></canvas>
                            </div>
                        </div>

                        <!-- Sector Distribution (Doughnut Chart) -->
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
                                    Repartition par Secteur
                                </div>
                            </div>
                            <div class="card-body" style="height: 280px;">
                                <canvas id="chart-sectors"></canvas>
                            </div>
                        </div>

                        <!-- Temperature Distribution (Polar Area) -->
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"/></svg>
                                    Temperature des Prospects
                                </div>
                            </div>
                            <div class="card-body" style="height: 280px;">
                                <canvas id="chart-temperature"></canvas>
                            </div>
                        </div>

                        <!-- Conversion Funnel -->
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
                                    Entonnoir de Conversion
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="funnel-container" id="analytics-funnel"></div>
                            </div>
                        </div>

                        <!-- Value by Sector (Horizontal Bar) -->
                        <div class="card" style="grid-column: span 2;">
                            <div class="card-header">
                                <div class="card-title">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                                    Valeur Pipeline par Secteur (XPF)
                                </div>
                            </div>
                            <div class="card-body" style="height: 250px;">
                                <canvas id="chart-value-sector"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Messages View -->
            <div class="view" id="view-messages">
                <header class="header">
                    <div class="header-left">
                        <h1>Messages Facebook</h1>
                        <p>Conversations Messenger avec le chatbot MANA</p>
                    </div>
                    <div class="header-actions">
                        <select class="filter-select" id="messages-filter" onchange="filterMessages()">
                            <option value="all">Toutes les conversations</option>
                            <option value="unread">Non lus</option>
                            <option value="manual">Reponses manuelles</option>
                        </select>
                        <button class="btn btn-ghost" onclick="loadMessengerConversations()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                            Sync
                        </button>
                        <a class="btn btn-primary" href="https://www.facebook.com/profile.php?id=61587101037690" target="_blank">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/></svg>
                            Ouvrir Facebook
                        </a>
                    </div>
                </header>

                <div class="content">
                    <!-- Messages KPIs -->
                    <div class="stats-row" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 1.5rem;">
                        <div class="stat">
                            <div class="stat-label">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
                                Total Conversations
                            </div>
                            <div class="stat-value" id="msg-total-conversations">0</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                Messages Aujourd'hui
                            </div>
                            <div class="stat-value blue" id="msg-today">0</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1"/></svg>
                                Reponses IA (auto)
                            </div>
                            <div class="stat-value green" id="msg-ai-responses">0</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                Reponses Manuelles
                            </div>
                            <div class="stat-value" style="color: var(--orange);" id="msg-manual-responses">0</div>
                        </div>
                    </div>

                    <!-- Messages Layout -->
                    <div class="messages-layout">
                        <!-- Conversations List -->
                        <div class="conversations-list">
                            <div class="conversations-header">
                                <h3>Conversations</h3>
                                <input type="text" class="conversations-search" placeholder="Rechercher..." id="conversations-search" oninput="searchConversations()">
                            </div>
                            <div class="conversations-items" id="conversations-items">
                                <!-- Generated by JS -->
                                <div class="conversations-empty">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
                                    <p>Aucune conversation</p>
                                    <span>Les messages Facebook Messenger apparaitront ici</span>
                                </div>
                            </div>
                        </div>

                        <!-- Chat Detail -->
                        <div class="chat-detail" id="chat-detail">
                            <div class="chat-detail-empty">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                                <p>Selectionne une conversation</p>
                                <span>Clique sur une conversation pour voir les messages</span>
                            </div>

                            <div class="chat-detail-content" id="chat-detail-content" style="display: none;">
                                <div class="chat-detail-header">
                                    <div class="chat-user-info">
                                        <div class="chat-user-avatar" id="chat-user-avatar">?</div>
                                        <div>
                                            <div class="chat-user-name" id="chat-user-name">Utilisateur</div>
                                            <div class="chat-user-id" id="chat-user-id">ID: ---</div>
                                        </div>
                                    </div>
                                    <div class="chat-header-actions">
                                        <button class="btn btn-ghost btn-sm" onclick="markConversationRead()" title="Marquer comme lu">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                        </button>
                                        <button class="btn btn-ghost btn-sm" onclick="openFacebookProfile()" title="Voir profil Facebook">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/></svg>
                                        </button>
                                    </div>
                                </div>

                                <div class="chat-messages-container" id="chat-messages-container">
                                    <!-- Messages generated by JS -->
                                </div>

                                <div class="chat-input-container">
                                    <div class="chat-input-row">
                                        <textarea class="chat-input" id="manual-reply-input" placeholder="Ecrire une reponse manuelle..." rows="2"></textarea>
                                        <button class="btn btn-primary" onclick="sendManualReply()">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                                            Envoyer
                                        </button>
                                    </div>
                                    <div class="chat-input-note">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                                        Les reponses manuelles sont envoyees via l'API Facebook et loguees dans Airtable
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Finance View -->
            <div class="view" id="view-finance">
                <header class="header">
                    <div class="header-left">
                        <h1>Finance & Revenue</h1>
                        <p>Suivi MRR, ARR et facturation</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-ghost" onclick="loadFinanceData()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                            Sync
                        </button>
                        <a class="btn btn-primary" href="https://invoice.zoho.com" target="_blank">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                            Zoho Invoice
                        </a>
                    </div>
                </header>

                <div class="content">
                    <!-- Finance KPIs -->
                    <div class="stats-row" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 1.5rem;">
                        <div class="stat">
                            <div class="stat-label">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                                MRR (Mensuel)
                            </div>
                            <div class="stat-value green" id="finance-mrr">0 XPF</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                                ARR (Annuel)
                            </div>
                            <div class="stat-value blue" id="finance-arr">0 XPF</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                Ce Mois (MTD)
                            </div>
                            <div class="stat-value" id="finance-mtd">0 XPF</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                En Attente
                            </div>
                            <div class="stat-value" style="color: var(--orange);" id="finance-pending">0 XPF</div>
                        </div>
                    </div>

                    <!-- Revenue Chart & Recent Invoices -->
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem;">
                        <!-- Revenue Trend Chart -->
                        <div class="card">
                            <div class="card-header">
                                <h3>Tendance Revenue (6 mois)</h3>
                            </div>
                            <div class="card-body" id="finance-chart-container" style="height: 300px; display: flex; align-items: flex-end; gap: 1rem; padding: 1rem 2rem;">
                                <!-- Chart bars generated by JS -->
                                <div style="text-align: center; width: 100%; color: var(--text-dim);">Chargement...</div>
                            </div>
                        </div>

                        <!-- Revenue Breakdown -->
                        <div class="card">
                            <div class="card-header">
                                <h3>Repartition</h3>
                            </div>
                            <div class="card-body" id="finance-breakdown">
                                <div style="display: flex; flex-direction: column; gap: 1rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="color: var(--text-muted);">Projets (Setup)</span>
                                        <span style="font-weight: 600;" id="finance-projects">0 XPF</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="color: var(--text-muted);">Recurrent (Mensuel)</span>
                                        <span style="font-weight: 600;" id="finance-recurring">0 XPF</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="color: var(--text-muted);">Upsells</span>
                                        <span style="font-weight: 600;" id="finance-upsells">0 XPF</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Invoices Table -->
                    <div class="card" style="margin-top: 1.5rem;">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h3>Factures Recentes</h3>
                            <button class="btn btn-ghost btn-sm" onclick="openNewInvoiceModal()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                Nouvelle
                            </button>
                        </div>
                        <div class="card-body" style="padding: 0;">
                            <table class="table" style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>Client</th>
                                        <th>Montant</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="finance-invoices-table">
                                    <tr>
                                        <td colspan="5" style="text-align: center; color: var(--text-dim); padding: 2rem;">
                                            Aucune facture. Configure Zoho Invoice pour synchroniser.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Clients MRR -->
                    <div class="card" style="margin-top: 1.5rem;">
                        <div class="card-header">
                            <h3>Clients Recurrents (MRR)</h3>
                        </div>
                        <div class="card-body">
                            <div id="finance-clients-mrr" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem;">
                                <div style="text-align: center; color: var(--text-dim); padding: 2rem; grid-column: 1 / -1;">
                                    Aucun client recurrent. Les clients avec abonnement mensuel apparaitront ici.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- IA Tool Iframe View -->
            <div class="view" id="view-ia-tool">
                <div class="ia-tool-header">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <button class="ia-tool-back-btn" onclick="closeIATool()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
                            Retour
                        </button>
                        <h1 id="ia-tool-title">Outil IA</h1>
                    </div>
                    <a class="ia-tool-external-btn" id="ia-tool-external-link" href="#" target="_blank">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                        Ouvrir en plein ecran
                    </a>
                </div>
                <div class="ia-tool-frame-container">
                    <iframe id="ia-tool-iframe" src="about:blank" allow="clipboard-read; clipboard-write"></iframe>
                </div>
            </div>
        </main>
    </div>

    <!-- AI Chatbot FAB -->
    <button class="chatbot-fab" onclick="toggleChatbot()" id="chatbot-fab">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        </svg>
    </button>

    <!-- AI Chatbot Panel -->
    <div class="chatbot-panel" id="chatbot-panel">
        <div class="chatbot-header">
            <div class="chatbot-avatar">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2M7.5 13A1.5 1.5 0 1 0 9 14.5 1.5 1.5 0 0 0 7.5 13m9 0a1.5 1.5 0 1 0 1.5 1.5 1.5 1.5 0 0 0-1.5-1.5M12 17c-1.5 0-2.5.5-2.5 1h5c0-.5-1-1-2.5-1"/>
                </svg>
            </div>
            <div class="chatbot-info">
                <div class="chatbot-name">MANA</div>
                <div class="chatbot-status">
                    <span class="chatbot-status-dot"></span>
                    Assistant CRM PACIFIK'AI
                </div>
            </div>
            <button class="chatbot-close" onclick="toggleChatbot()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>

        <div class="chatbot-messages" id="chatbot-messages">
            <!-- Welcome message -->
            <div class="chat-message assistant">
                <div class="chat-avatar">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1"/>
                    </svg>
                </div>
                <div class="chat-bubble">
                    <p><strong>Ia ora na Jordy!</strong></p>
                    <p>Je suis <strong>MANA</strong>, ton assistant CRM. Je connais tout sur PACIFIK'AI et je peux:</p>
                    <ul>
                        <li><strong>Lire:</strong> stats, pipeline, prospects, rappels</li>
                        <li><strong>Modifier:</strong> status, temperature, notes</li>
                    </ul>
                    <p>Parle-moi naturellement: "Air Tahiti est chaud" / "on a signe avec Four Seasons!"</p>
                    <div class="chat-actions">
                        <button class="chat-action-btn" onclick="sendChatMessage('Stats du pipeline')">Stats</button>
                        <button class="chat-action-btn" onclick="sendChatMessage('Prospects hot')">Hot</button>
                        <button class="chat-action-btn" onclick="sendChatMessage('Rappels du jour')">Rappels</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="chatbot-input-area">
            <div class="chatbot-suggestions" id="chatbot-suggestions">
                <span class="suggestion-chip" onclick="sendChatMessage('Combien de prospects?')">Combien de prospects?</span>
                <span class="suggestion-chip" onclick="sendChatMessage('Valeur totale du pipeline')">Pipeline total</span>
                <span class="suggestion-chip" onclick="sendChatMessage('Prospects a relancer')">A relancer</span>
            </div>
            <div class="chatbot-input-wrap">
                <textarea
                    class="chatbot-input"
                    id="chatbot-input"
                    placeholder="Demande quelque chose..."
                    rows="1"
                    onkeydown="handleChatKeydown(event)"
                ></textarea>
                <button class="chatbot-send" onclick="sendUserMessage()" id="chatbot-send">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Add Reminder Modal -->
    <div class="modal-overlay" id="reminder-modal" onclick="closeReminderModal(event)">
        <div class="reminder-modal" onclick="event.stopPropagation()">
            <h3>Ajouter un rappel</h3>
            <div class="reminder-form">
                <div class="form-group">
                    <label>Date de relance</label>
                    <input type="date" id="reminder-date">
                </div>
                <div class="form-group">
                    <label>Note (optionnel)</label>
                    <textarea id="reminder-note" rows="2" placeholder="Ex: Relancer par email pour devis..."></textarea>
                </div>
                <div class="form-actions">
                    <button class="btn btn-ghost" onclick="closeReminderModal()">Annuler</button>
                    <button class="btn btn-primary" onclick="saveReminder()">Ajouter</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Prospect Detail Modal -->
    <div class="modal-overlay" id="prospect-modal" onclick="closeProspectModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title-section">
                    <h2 class="modal-title" id="modal-company">-</h2>
                    <div class="modal-subtitle">
                        <span id="modal-sector">-</span>
                        <span>•</span>
                        <span class="badge" id="modal-status">-</span>
                        <span>•</span>
                        <span class="badge" id="modal-priority">-</span>
                        <span>•</span>
                        <select id="modal-assignee-select" onchange="assignProspectFromModal(this.value)" style="background:var(--bg-muted);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:2px 8px;font-size:0.75rem;cursor:pointer;outline:none;">
                            <option value="">Non assigne</option>
                        </select>
                    </div>
                </div>
                <button class="modal-close" onclick="closeProspectModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <!-- Modal Tabs Navigation -->
            <div class="modal-tabs">
                <button class="modal-tab active" onclick="switchProspectTab('info')" data-tab="info">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    Infos
                </button>
                <button class="modal-tab" onclick="switchProspectTab('ia')" data-tab="ia">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                    Fiche IA
                    <span class="tab-badge" id="tab-badge-ia">0</span>
                </button>
                <button class="modal-tab" onclick="switchProspectTab('assets')" data-tab="assets">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                    Assets
                    <span class="tab-badge" id="tab-badge-assets">0</span>
                </button>
                <button class="modal-tab" onclick="switchProspectTab('timeline')" data-tab="timeline">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    Timeline
                </button>
            </div>

            <div class="modal-body">
                <!-- TAB 1: Infos Contact -->
                <div class="modal-tab-content active" id="tab-content-info">
                    <!-- Stats Row -->
                    <div class="prospect-info">
                        <div class="prospect-info-item">
                            <div class="prospect-info-label">Valeur Pipeline</div>
                            <div class="prospect-info-value" id="modal-value" style="color: var(--green);">-</div>
                        </div>
                        <div class="prospect-info-item">
                            <div class="prospect-info-label">Date Ajout</div>
                            <div class="prospect-info-value" id="modal-date">-</div>
                        </div>
                        <div class="prospect-info-item">
                            <div class="prospect-info-label">Assets Crees</div>
                            <div class="prospect-info-value" id="modal-assets-count">0</div>
                        </div>
                        <div class="prospect-info-item">
                            <div class="prospect-info-label">Source</div>
                            <div class="prospect-info-value" id="modal-source">-</div>
                        </div>
                    </div>

                    <!-- Editable Contact Info Section -->
                    <div class="prospect-edit-section">
                        <div class="edit-section-header">
                            <span class="edit-section-title">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                Infos Contact
                            </span>
                            <button class="edit-toggle-btn" id="edit-toggle-btn" onclick="toggleEditMode()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                                Modifier
                            </button>
                        </div>
                        <div class="prospect-info" id="prospect-info-display">
                            <div class="prospect-info-item">
                                <div class="prospect-info-label">Contact</div>
                                <div class="prospect-info-value" id="modal-contact">-</div>
                            </div>
                            <div class="prospect-info-item">
                                <div class="prospect-info-label">Email</div>
                                <div class="prospect-info-value" id="modal-email">-</div>
                            </div>
                            <div class="prospect-info-item">
                                <div class="prospect-info-label">Telephone</div>
                                <div class="prospect-info-value" id="modal-phone">-</div>
                            </div>
                            <div class="prospect-info-item">
                                <div class="prospect-info-label">Poste</div>
                                <div class="prospect-info-value" id="modal-poste">-</div>
                            </div>
                        </div>
                        <!-- Edit Form (hidden by default) -->
                        <div class="prospect-edit-form" id="prospect-edit-form" style="display:none;">
                            <div class="edit-form-grid">
                                <div class="edit-field">
                                    <label>Nom du contact</label>
                                    <input type="text" id="edit-contact" placeholder="Ex: Jean Dupont">
                                </div>
                                <div class="edit-field">
                                    <label>Email</label>
                                    <input type="email" id="edit-email" placeholder="Ex: jean@company.com">
                                </div>
                                <div class="edit-field">
                                    <label>Telephone</label>
                                    <input type="tel" id="edit-phone" placeholder="Ex: 87 12 34 56">
                                </div>
                                <div class="edit-field">
                                    <label>Poste / Fonction</label>
                                    <input type="text" id="edit-poste" placeholder="Ex: Directeur Commercial">
                                </div>
                            </div>
                            <div class="edit-form-actions">
                                <button class="btn btn-ghost" onclick="cancelEditMode()">Annuler</button>
                                <button class="btn btn-primary" onclick="saveProspectEdits()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><polyline points="20 6 9 17 4 12"/></svg>
                                    Enregistrer
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Notes Section -->
                    <div class="notes-section">
                        <div class="notes-header">
                            <div class="notes-title">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                                Notes
                            </div>
                        </div>
                        <div class="note-input-wrap">
                            <textarea class="note-input" id="modal-note-input" placeholder="Ajouter une note..." rows="2"></textarea>
                            <button class="btn btn-primary" onclick="addNote()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            </button>
                        </div>
                        <div class="notes-list" id="modal-notes-list"></div>
                    </div>

                    <!-- Quick Actions -->
                    <div style="margin-top: 1.5rem; display: flex; gap: 0.75rem; flex-wrap: wrap;">
                        <a class="btn btn-primary" id="modal-supabase-link" href="https://supabase.com/dashboard/project/ogsimsfqwibcmotaeevb/editor" target="_blank">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                            Supabase
                        </a>
                        <button class="btn btn-ghost" onclick="sendEmail()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                            Email
                        </button>
                        <button class="btn btn-ghost" onclick="openWhatsApp()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
                            WhatsApp
                        </button>
                        <button class="btn btn-ghost" onclick="showAddReminder()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                            Rappel
                        </button>
                        <button class="btn btn-ghost" id="modal-open-folder" onclick="openProspectFolder()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
                            Dossier
                        </button>
                        <button class="btn btn-success" onclick="generatePortalLink()" title="Generer un lien pour le client portal">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                            Portal
                        </button>
                        <button class="btn btn-ghost" id="modal-infrastructure-btn" onclick="openInfrastructureModal()" title="Voir l'infrastructure IA deployee">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
                            Infra
                        </button>
                    </div>
                </div>

                <!-- TAB 2: Fiche IA -->
                <div class="modal-tab-content" id="tab-content-ia">
                    <div class="fiche-ia-section" id="fiche-ia-section">
                        <div class="fiche-ia-header">
                            <div class="fiche-ia-title">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px;color:var(--purple);">
                                    <path d="M12 2a10 10 0 1 0 10 10H12V2z"/>
                                    <path d="M12 2a10 10 0 0 1 10 10"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                                Fiche Recherche IA
                            </div>
                            <span class="fiche-ia-badge" id="fiche-ia-badge">Non generee</span>
                        </div>
                        <div class="fiche-ia-content" id="fiche-ia-content">
                            <div class="fiche-ia-empty" id="fiche-ia-empty">
                                <p>Aucune fiche de recherche generee pour ce prospect.</p>
                                <p class="fiche-ia-hint">La fiche contient: contexte entreprise, 10 features automatisables, script d'appel, email de prospection, estimation potentiel.</p>
                                <button class="btn btn-primary fiche-ia-generate" id="btn-generate-fiche" onclick="generateFicheIA()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
                                        <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                                    </svg>
                                    Generer la fiche
                                </button>
                                <button class="btn btn-ghost" onclick="generatePackComplet()" title="Fiche + Pitch + Dossier + Guide RDV (avec Quality Control IA)">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
                                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                                        <line x1="12" y1="11" x2="12" y2="17"/>
                                        <line x1="9" y1="14" x2="15" y2="14"/>
                                    </svg>
                                    Pack Complet
                                </button>
                            </div>
                            <div class="fiche-ia-available" id="fiche-ia-available" style="display:none;">
                                <div class="fiche-ia-preview">
                                    <div class="fiche-ia-preview-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                            <polyline points="14 2 14 8 20 8"/>
                                            <circle cx="12" cy="14" r="3"/>
                                        </svg>
                                    </div>
                                    <div class="fiche-ia-preview-info">
                                        <div class="fiche-ia-preview-name">FICHE_RECHERCHE.md</div>
                                        <div class="fiche-ia-preview-meta" id="fiche-ia-meta">Generee le --</div>
                                    </div>
                                </div>
                                <div class="fiche-ia-actions">
                                    <button class="btn btn-primary" onclick="openFicheIA()">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                            <circle cx="12" cy="12" r="3"/>
                                        </svg>
                                        Consulter
                                    </button>
                                    <button class="btn btn-ghost" onclick="regenerateFicheIA()">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
                                            <path d="M23 4v6h-6"/>
                                            <path d="M1 20v-6h6"/>
                                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10"/>
                                            <path d="M20.49 15a9 9 0 0 1-14.85 3.36L1 14"/>
                                        </svg>
                                        Regenerer
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 3: Assets -->
                <div class="modal-tab-content" id="tab-content-assets">
                    <div class="assets-section" id="modal-assets-section">
                        <!-- Assets Filter Bar -->
                        <div class="assets-filter-bar">
                            <button class="asset-filter-btn active" data-filter="all" onclick="filterAssets('all')">
                                Tous
                                <span class="filter-count" id="filter-count-all">0</span>
                            </button>
                            <button class="asset-filter-btn" data-filter="site" onclick="filterAssets('site')">
                                <span class="filter-icon">🌐</span> Landing
                                <span class="filter-count" id="filter-count-site">0</span>
                            </button>
                            <button class="asset-filter-btn" data-filter="dash" onclick="filterAssets('dash')">
                                <span class="filter-icon">📊</span> Dashboard
                                <span class="filter-count" id="filter-count-dash">0</span>
                            </button>
                            <button class="asset-filter-btn" data-filter="wf" onclick="filterAssets('wf')">
                                <span class="filter-icon">⚡</span> Workflow
                                <span class="filter-count" id="filter-count-wf">0</span>
                            </button>
                            <button class="asset-filter-btn" data-filter="doc" onclick="filterAssets('doc')">
                                <span class="filter-icon">📄</span> Document
                                <span class="filter-count" id="filter-count-doc">0</span>
                            </button>
                        </div>
                        <div class="assets-grid" id="modal-assets-grid">
                            <!-- Dynamically populated -->
                        </div>
                    </div>

                    <div id="modal-no-assets" style="display: none;">
                        <div class="no-assets">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg>
                            <p>Aucun document cree pour ce prospect</p>
                            <span>Demarre un projet pour ce prospect pour creer des assets</span>
                        </div>
                    </div>
                </div>

                <!-- TAB 4: Timeline -->
                <div class="modal-tab-content" id="tab-content-timeline">
                    <div class="notes-section">
                        <div class="notes-header">
                            <div class="notes-title">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                Historique d'activite
                            </div>
                        </div>
                        <div id="modal-timeline"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Edit Modal -->
    <div class="modal-overlay" id="task-modal" onclick="closeTaskModal(event)">
        <div class="modal" onclick="event.stopPropagation()" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-title-section">
                    <h2 class="modal-title" id="task-modal-title">Nouvelle Tache</h2>
                    <div class="modal-subtitle" id="task-modal-subtitle">Creer une nouvelle tache</div>
                </div>
                <button class="modal-close" onclick="closeTaskModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="task-form" onsubmit="saveTask(event)">
                    <input type="hidden" id="task-edit-id">

                    <!-- Title -->
                    <div class="edit-form-group" style="margin-bottom: 1rem;">
                        <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-muted); margin-bottom: 0.375rem;">Titre de la tache *</label>
                        <input type="text" id="task-title" required placeholder="Ex: Preparer proposition commerciale" style="width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 0.625rem 0.75rem; color: var(--text); font-size: 0.875rem;">
                    </div>

                    <!-- Row: Project + Priority -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="edit-form-group">
                            <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-muted); margin-bottom: 0.375rem;">Projet</label>
                            <select id="task-project" style="width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 0.625rem 0.75rem; color: var(--text); font-size: 0.875rem;">
                                <option value="">Aucun projet</option>
                                <option value="ATN">Air Tahiti Nui</option>
                                <option value="PACIFIKAI">PACIFIK'AI</option>
                                <option value="HVC">High Value Capital</option>
                                <option value="COWAN">Cowan Motor</option>
                            </select>
                        </div>
                        <div class="edit-form-group">
                            <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-muted); margin-bottom: 0.375rem;">Priorite</label>
                            <select id="task-priority" style="width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 0.625rem 0.75rem; color: var(--text); font-size: 0.875rem;">
                                <option value="Normal">Normal</option>
                                <option value="Urgent">Urgent</option>
                                <option value="Faible">Faible</option>
                            </select>
                        </div>
                    </div>

                    <!-- Row: Assignee + Due Date -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="edit-form-group">
                            <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-muted); margin-bottom: 0.375rem;">Assigne a</label>
                            <select id="task-assignee" style="width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 0.625rem 0.75rem; color: var(--text); font-size: 0.875rem;">
                                <option value="">Non assigne</option>
                                <!-- Populated dynamically by populateAssigneeDropdowns() -->
                            </select>
                        </div>
                        <div class="edit-form-group">
                            <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-muted); margin-bottom: 0.375rem;">Date d'echeance</label>
                            <input type="date" id="task-due-date" style="width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 0.625rem 0.75rem; color: var(--text); font-size: 0.875rem;">
                        </div>
                    </div>

                    <!-- Row: Status + Estimated Time -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="edit-form-group">
                            <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-muted); margin-bottom: 0.375rem;">Statut</label>
                            <select id="task-status" style="width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 0.625rem 0.75rem; color: var(--text); font-size: 0.875rem;">
                                <option value="À faire">A faire</option>
                                <option value="En cours">En cours</option>
                                <option value="Bloqué">Bloque</option>
                                <option value="Terminé">Termine</option>
                            </select>
                        </div>
                        <div class="edit-form-group">
                            <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-muted); margin-bottom: 0.375rem;">Temps estime (heures)</label>
                            <input type="number" id="task-estimated-time" min="0" step="0.5" placeholder="Ex: 2" style="width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 0.625rem 0.75rem; color: var(--text); font-size: 0.875rem;">
                        </div>
                    </div>

                    <!-- Linked Prospect -->
                    <div class="edit-form-group" style="margin-bottom: 1rem;">
                        <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-muted); margin-bottom: 0.375rem;">Prospect lie</label>
                        <select id="task-prospect" style="width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 0.625rem 0.75rem; color: var(--text); font-size: 0.875rem;">
                            <option value="">Aucun prospect</option>
                            <!-- Populated dynamically -->
                        </select>
                    </div>

                    <!-- Description -->
                    <div class="edit-form-group" style="margin-bottom: 1rem;">
                        <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-muted); margin-bottom: 0.375rem;">Description</label>
                        <textarea id="task-description" rows="3" placeholder="Details de la tache..." style="width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 0.625rem 0.75rem; color: var(--text); font-size: 0.875rem; resize: vertical;"></textarea>
                    </div>

                    <!-- Comments Section (only in edit mode) -->
                    <div id="task-comments-section" style="display: none; margin-bottom: 1rem;">
                        <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-muted); margin-bottom: 0.375rem;">Commentaires</label>
                        <div id="task-comments-list" style="max-height: 150px; overflow-y: auto; margin-bottom: 0.5rem;"></div>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" id="task-new-comment" placeholder="Ajouter un commentaire..." style="flex: 1; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 0.5rem 0.75rem; color: var(--text); font-size: 0.8125rem;">
                            <button type="button" class="btn btn-ghost" onclick="addTaskComment()" style="padding: 0.5rem 0.75rem;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            </button>
                        </div>
                    </div>

                    <!-- History Section (only in edit mode) -->
                    <div id="task-history-section" style="display: none; margin-bottom: 1rem;">
                        <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-muted); margin-bottom: 0.375rem;">Historique</label>
                        <div id="task-history-list" style="max-height: 120px; overflow-y: auto; font-size: 0.75rem; color: var(--text-dim);"></div>
                    </div>

                    <!-- Actions -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                        <div>
                            <button type="button" id="task-delete-btn" class="btn btn-ghost" onclick="deleteCurrentTask()" style="display: none; color: var(--red);">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                                Supprimer
                            </button>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button type="button" class="btn btn-ghost" onclick="closeTaskModal()">Annuler</button>
                            <button type="submit" class="btn btn-primary">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><polyline points="20 6 9 17 4 12"/></svg>
                                <span id="task-save-btn-text">Creer</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Infrastructure Modal -->
    <div class="modal-overlay" id="infrastructure-modal" onclick="closeInfrastructureModal(event)">
        <div class="modal" onclick="event.stopPropagation()" style="max-width: 900px; max-height: 90vh;">
            <div class="modal-header">
                <div class="modal-title-section">
                    <h2 class="modal-title" id="infra-modal-title">Infrastructure IA</h2>
                    <div class="modal-subtitle" id="infra-modal-subtitle">Dashboard, workflows et documents deployes</div>
                </div>
                <button class="modal-close" onclick="closeInfrastructureModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <div class="modal-body" style="padding: 1.5rem; overflow-y: auto; max-height: calc(90vh - 80px);">
                <!-- Loading State -->
                <div id="infra-loading" style="text-align: center; padding: 3rem;">
                    <div class="spinner" style="width: 40px; height: 40px; margin: 0 auto 1rem;"></div>
                    <p style="color: var(--text-muted);">Chargement de l'infrastructure...</p>
                </div>

                <!-- No Infrastructure State -->
                <div id="infra-no-data" style="display: none; text-align: center; padding: 3rem;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 48px; height: 48px; color: var(--text-dim); margin-bottom: 1rem;">
                        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/>
                    </svg>
                    <h3 style="font-size: 1rem; color: var(--text); margin-bottom: 0.5rem;">Aucune infrastructure deployee</h3>
                    <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 1.5rem;">
                        Utilise le skill <code style="background: var(--bg-muted); padding: 0.125rem 0.375rem; border-radius: 4px;">/infrastructure</code> pour deployer l'infrastructure IA de ce client.
                    </p>
                    <button class="btn btn-primary" onclick="closeInfrastructureModal(); showToast('Lance /infrastructure dans Claude Code');">
                        Commencer
                    </button>
                </div>

                <!-- Infrastructure Content -->
                <div id="infra-content" style="display: none;">
                    <!-- Quick Links -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem;">
                        <a id="infra-link-dashboard" href="#" target="_blank" class="btn btn-primary" style="flex-direction: column; padding: 1rem; height: auto;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px; margin-bottom: 0.5rem;"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
                            Dashboard
                        </a>
                        <a id="infra-link-supabase" href="#" target="_blank" class="btn btn-ghost" style="flex-direction: column; padding: 1rem; height: auto; border: 1px solid var(--border);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px; margin-bottom: 0.5rem;"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                            Supabase
                        </a>
                        <a id="infra-link-n8n" href="#" target="_blank" class="btn btn-ghost" style="flex-direction: column; padding: 1rem; height: auto; border: 1px solid var(--border);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px; margin-bottom: 0.5rem;"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v10"/><path d="m4.93 4.93 4.24 4.24m5.66 5.66 4.24 4.24"/><path d="M1 12h6m6 0h10"/><path d="m4.93 19.07 4.24-4.24m5.66-5.66 4.24-4.24"/></svg>
                            n8n Workflows
                        </a>
                        <a id="infra-link-chatbot" href="#" target="_blank" class="btn btn-ghost" style="flex-direction: column; padding: 1rem; height: auto; border: 1px solid var(--border);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px; margin-bottom: 0.5rem;"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                            Chatbot
                        </a>
                    </div>

                    <!-- Workflows Section -->
                    <div style="margin-bottom: 2rem;">
                        <h3 style="font-size: 0.875rem; font-weight: 600; color: var(--text); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v10"/></svg>
                            Workflows n8n
                            <span id="infra-workflow-count" class="nav-badge">0</span>
                        </h3>
                        <div id="infra-workflows-grid" style="display: grid; gap: 0.75rem;"></div>
                    </div>

                    <!-- Documents Section -->
                    <div style="margin-bottom: 2rem;">
                        <h3 style="font-size: 0.875rem; font-weight: 600; color: var(--text); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                            Documents Commerciaux
                            <span id="infra-doc-count" class="nav-badge">0</span>
                        </h3>
                        <div id="infra-docs-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.75rem;"></div>
                    </div>

                    <!-- Metadata Section -->
                    <div style="background: var(--bg-subtle); border-radius: var(--radius-lg); padding: 1rem; display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                        <div>
                            <div style="font-size: 0.6875rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.05em;">Slug</div>
                            <div id="infra-slug" style="font-size: 0.875rem; color: var(--text); font-family: var(--font-mono);">-</div>
                        </div>
                        <div>
                            <div style="font-size: 0.6875rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.05em;">Tier</div>
                            <div id="infra-tier" style="font-size: 0.875rem; color: var(--text);">-</div>
                        </div>
                        <div>
                            <div style="font-size: 0.6875rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.05em;">Date Deploy</div>
                            <div id="infra-deploy-date" style="font-size: 0.875rem; color: var(--text);">-</div>
                        </div>
                        <div>
                            <div style="font-size: 0.6875rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.05em;">Status</div>
                            <div id="infra-status" style="font-size: 0.875rem;">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase Client -->
    <script src="supabase-client.js"></script>

    <script>
        console.log('[PACIFIKAI Dashboard] Script chargement debut...');

        // ============================================
        // PACIFIK'AI CENTRALIZED CONFIGURATION
        // ============================================
        const PACIFIKAI_CONFIG = {
            supabase: {
                projectId: 'ogsimsfqwibcmotaeevb',
                url: 'https://ogsimsfqwibcmotaeevb.supabase.co',
                dashboardUrl: 'https://supabase.com/dashboard/project/ogsimsfqwibcmotaeevb',
                storageUrl: 'https://ogsimsfqwibcmotaeevb.supabase.co/storage/v1/object/public',
                tables: ['prospects', 'tasks', 'assets', 'activity_log', 'comments', 'content_calendar', 'team_members']
            },
            n8n: {
                baseUrl: 'https://n8n.srv1140766.hstgr.cloud',
                webhooks: {
                    mana: '/webhook/mana-chat',
                    deepResearch: '/webhook/deep-research',
                    generateDossier: '/webhook/generate-dossier-v2',
                    leadScoring: '/webhook/pacifikai-lead-scoring',
                    manualReply: '/webhook/pacifikai-manual-reply'
                },
                workflowIds: {
                    facebook: 'WiZ2HVZFVfzBxK3l'
                }
            },
            claude: {
                model: 'claude-sonnet-4-5-20250929'
            },
            contact: {
                email: 'jordy@pacifikai.com',
                phone: '+689 89 55 81 89',
                whatsapp: 'https://wa.me/68989558189',
                calendly: 'https://calendly.com/pacifikai'
            },
            social: {
                facebook: 'https://www.facebook.com/profile.php?id=61587101037690',
                website: 'https://pacifikai.com'
            }
        };

        // Helper functions for config
        const getN8nWebhook = (name) => PACIFIKAI_CONFIG.n8n.baseUrl + PACIFIKAI_CONFIG.n8n.webhooks[name];
        const getSupabaseEditorUrl = () => PACIFIKAI_CONFIG.supabase.dashboardUrl + '/editor';
        const getN8nWorkflowUrl = (id) => `${PACIFIKAI_CONFIG.n8n.baseUrl}/workflow/${id}`;

        // === SUPABASE AUTH ===
        let currentUser = null;
        let teamMembers = [];

        async function checkAuth() {
            const restored = await supabase.restoreSession();
            if (!restored) {
                window.location.href = 'login.html';
                return false;
            }
            currentUser = supabase.getCurrentUser();
            updateUserProfile();
            return true;
        }

        function updateUserProfile() {
            if (!currentUser) return;

            const initials = currentUser.display_name
                .split(' ')
                .map(n => n[0])
                .join('')
                .toUpperCase()
                .slice(0, 2);

            document.getElementById('user-avatar').textContent = initials;
            document.getElementById('user-avatar').style.background = currentUser.avatar_color || 'var(--accent)';
            document.getElementById('user-name').textContent = currentUser.display_name;
            document.getElementById('user-role').textContent = currentUser.role === 'admin' ? 'Admin' : 'Membre';
        }

        async function handleLogout() {
            await supabase.signOut();
            window.location.href = 'login.html';
        }

        async function loadTeamMembers() {
            try {
                teamMembers = await supabase.getTeamMembers();
            } catch (e) {
                console.error('Erreur chargement team members:', e);
            }
        }

        // Helper pour afficher les initiales d'un membre
        function getMemberInitials(memberId) {
            const member = teamMembers.find(m => m.id === memberId);
            if (!member) return '?';
            return member.display_name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        }

        function getMemberColor(memberId) {
            const member = teamMembers.find(m => m.id === memberId);
            return member?.avatar_color || '#3b82f6';
        }

        function getMemberName(memberId) {
            const member = teamMembers.find(m => m.id === memberId);
            return member?.display_name || 'Non assigne';
        }

        function renderAssigneeBadge(assignedTo, size = 20) {
            if (!assignedTo) return '';
            const name = getMemberName(assignedTo);
            const color = getMemberColor(assignedTo);
            const initials = getMemberInitials(assignedTo);
            return `<div style="width:${size}px;height:${size}px;border-radius:50%;background:${color};color:white;font-size:${Math.round(size*0.3)}rem;font-weight:600;display:inline-flex;align-items:center;justify-content:center;flex-shrink:0;" title="${name}">${initials}</div>`;
        }

        // Populate all assignee dropdowns with team members
        function populateAssigneeDropdowns() {
            const dropdowns = [
                document.getElementById('task-assignee'),
                document.getElementById('task-assignee-filter')
            ];

            dropdowns.forEach(dropdown => {
                if (!dropdown) return;

                // Keep first option(s) and "unassigned"
                const firstOption = dropdown.querySelector('option[value=""]') || dropdown.querySelector('option[value="all"]');
                const unassignedOption = dropdown.querySelector('option[value="unassigned"]');

                // Clear existing member options
                Array.from(dropdown.options).forEach(opt => {
                    if (opt.value && opt.value !== 'all' && opt.value !== '' && opt.value !== 'unassigned') {
                        opt.remove();
                    }
                });

                // Add team members
                teamMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.display_name;
                    option.style.color = member.avatar_color;

                    // Insert before "unassigned" if it exists, otherwise at the end
                    if (unassignedOption) {
                        dropdown.insertBefore(option, unassignedOption);
                    } else {
                        dropdown.appendChild(option);
                    }
                });
            });
        }

        // Render activity feed
        async function renderActivityFeed() {
            const container = document.getElementById('activity-feed');
            if (!container) return;

            try {
                const activities = await supabase.getRecentActivity(20);

                if (activities.length === 0) {
                    container.innerHTML = '<div class="empty-state" style="padding: 1rem; color: var(--text-dim); text-align: center;">Aucune activite recente</div>';
                    return;
                }

                container.innerHTML = activities.map(a => {
                    const actionIcons = {
                        'create': '<svg viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2" width="14" height="14"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
                        'update': '<svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" width="14" height="14"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
                        'delete': '<svg viewBox="0 0 24 24" fill="none" stroke="var(--red)" stroke-width="2" width="14" height="14"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>',
                        'assign': '<svg viewBox="0 0 24 24" fill="none" stroke="var(--purple)" stroke-width="2" width="14" height="14"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><path d="M20 8v6M23 11h-6"/></svg>',
                        'status_change': '<svg viewBox="0 0 24 24" fill="none" stroke="var(--yellow)" stroke-width="2" width="14" height="14"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>',
                        'comment': '<svg viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2" width="14" height="14"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>'
                    };

                    const icon = actionIcons[a.action] || actionIcons['update'];
                    const time = new Date(a.created_at).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                    const date = new Date(a.created_at).toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' });

                    return `
                        <div class="activity-item" style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.75rem 0; border-bottom: 1px solid var(--border);">
                            <div class="activity-icon" style="padding-top: 2px;">${icon}</div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-size: 0.8125rem; color: var(--text);">
                                    <strong>${a.user_name}</strong>
                                    <span style="color: var(--text-muted);">${getActionText(a.action)}</span>
                                    ${a.entity_name ? `<span style="color: var(--accent);">${a.entity_name}</span>` : ''}
                                </div>
                                <div style="font-size: 0.6875rem; color: var(--text-dim); margin-top: 2px;">${date} a ${time}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error('Erreur chargement activite:', e);
            }
        }

        function getActionText(action) {
            const texts = {
                'create': 'a cree',
                'update': 'a modifie',
                'delete': 'a supprime',
                'assign': 'a assigne',
                'status_change': 'a change le statut de',
                'comment': 'a commente sur'
            };
            return texts[action] || action;
        }

        // Data
        let prospects = [];
        let tasks = [];
        let notes = {}; // { prospectId: [{ id, text, date }] }
        let followups = []; // [{ id, prospectId, date, note, done }]
        let clientInfrastructures = {}; // { prospectId: infrastructureObject }
        let lastSync = null;
        let currentProspectsView = 'kanban';
        let currentSort = 'priority';
        let currentSectorFilter = 'all';
        let currentStatusFilter = 'all';
        let currentDateFilter = 'all';
        let currentTempFilter = 'all';
        let assetsFilterActive = false;
        let searchQuery = '';

        // Airtable Config - Clés chargées depuis localStorage uniquement
        const AIRTABLE_CONFIG = {
            baseId: 'appF7pltUaQkOlKM5',
            tableId: 'tbluw05otXoESeQkz',
            get apiKey() { return localStorage.getItem('PACIFIKAI_AIRTABLE_KEY') || ''; }
        };

        // Tasks Table Config
        const TASKS_TABLE_ID = 'tblOqUUWT2ExGfjGw';
        let currentTaskProjectFilter = 'all';
        let currentTaskPriorityFilter = 'all';
        let currentTaskAssigneeFilter = 'all';
        let currentAssigneeFilter = 'all'; // Prospect assignee filter
        let currentTaskView = 'kanban';
        let currentTaskSort = 'priority';
        let taskSearchQuery = '';
        let currentEditingTaskId = null;
        let taskComments = {}; // { taskId: [{ text, date, author }] }
        let taskHistory = {}; // { taskId: [{ action, date, details }] }

        // Content Calendar Table Config
        const CONTENT_TABLE_ID = 'tblj296C1kSmUcVvO';
        let airtableContent = [];
        let currentContentFilter = 'all';
        let currentPlatformFilter = 'all';
        let editingContentId = null;

        // Claude API Config - Clés chargées depuis localStorage uniquement (SECURITE)
        function getClaudeApiKey() {
            return localStorage.getItem('PACIFIKAI_CLAUDE_KEY') || '';
        }

        function getAirtableApiKey() {
            return localStorage.getItem('PACIFIKAI_AIRTABLE_KEY') || '';
        }

        // Vérifier si les clés sont configurées
        function areKeysConfigured() {
            return !!(getClaudeApiKey() && getAirtableApiKey());
        }

        // Fonction pour configurer les clés (console ou modal)
        window.configureKeys = function(claudeKey, airtableKey) {
            if (claudeKey && claudeKey.startsWith('sk-ant-')) {
                localStorage.setItem('PACIFIKAI_CLAUDE_KEY', claudeKey);
                console.log('Clé Claude configurée');
            }
            if (airtableKey && airtableKey.startsWith('pat')) {
                localStorage.setItem('PACIFIKAI_AIRTABLE_KEY', airtableKey);
                console.log('Clé Airtable configurée');
            }
            if (areKeysConfigured()) {
                showToast('Configuration sauvegardée!');
                hideConfigModal();
                init();
            }
        };

        // Fonction legacy pour compatibilité
        window.configureClaudeKey = function(key) {
            window.configureKeys(key, null);
        };

        // Fonction pour vérifier si les clés sont configurées
        window.checkKeys = function() {
            const claude = getClaudeApiKey();
            const airtable = getAirtableApiKey();
            console.log('Claude:', claude ? claude.substring(0, 15) + '...' : 'NON CONFIGURÉ');
            console.log('Airtable:', airtable ? airtable.substring(0, 15) + '...' : 'NON CONFIGURÉ');
            return areKeysConfigured();
        };

        // Afficher le modal de configuration
        function showConfigModal() {
            let overlay = document.getElementById('config-modal-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'config-modal-overlay';
                overlay.className = 'modal-overlay';
                overlay.onclick = function(e) {
                    // Ne pas fermer sur backdrop car config obligatoire
                    e.stopPropagation();
                };
                overlay.innerHTML = `
                    <div class="modal" style="max-width: 500px;" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <div class="modal-title-section">
                                <h2 class="modal-title" style="display: flex; align-items: center; gap: 0.5rem;">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                                    </svg>
                                    Configuration PACIFIK'AI
                                </h2>
                            </div>
                        </div>
                        <div class="modal-body" style="padding: 1.5rem;">
                            <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                                Pour utiliser le dashboard, configure tes clés API. Elles seront stockées localement dans ton navigateur.
                            </p>
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label class="form-label">Clé API Claude (Anthropic)</label>
                                <input type="password" id="config-claude-key" class="form-input"
                                       placeholder="sk-ant-api03-..."
                                       value="${getClaudeApiKey()}"
                                       style="font-family: monospace;">
                                <small style="color: var(--text-dim);">Obtenir sur console.anthropic.com</small>
                            </div>
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label class="form-label">Clé API Airtable</label>
                                <input type="password" id="config-airtable-key" class="form-input"
                                       placeholder="pat..."
                                       value="${getAirtableApiKey()}"
                                       style="font-family: monospace;">
                                <small style="color: var(--text-dim);">Obtenir sur airtable.com/create/tokens</small>
                            </div>
                        </div>
                        <div class="form-actions" style="padding: 1rem 1.5rem; border-top: 1px solid var(--border);">
                            <button class="btn btn-primary" onclick="saveConfigFromModal()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                                    <polyline points="17,21 17,13 7,13 7,21"/>
                                    <polyline points="7,3 7,8 15,8"/>
                                </svg>
                                Sauvegarder
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(overlay);
            }
            // Afficher avec animation
            document.body.style.overflow = 'hidden';
            setTimeout(() => overlay.classList.add('show'), 10);
        }

        function hideConfigModal() {
            const overlay = document.getElementById('config-modal-overlay');
            if (overlay) {
                overlay.classList.remove('show');
                document.body.style.overflow = '';
            }
        }

        function saveConfigFromModal() {
            const claudeKey = document.getElementById('config-claude-key').value.trim();
            const airtableKey = document.getElementById('config-airtable-key').value.trim();

            let errors = [];
            if (!claudeKey || !claudeKey.startsWith('sk-ant-')) {
                errors.push('Clé Claude invalide (doit commencer par sk-ant-)');
            }
            if (!airtableKey || !airtableKey.startsWith('pat')) {
                errors.push('Clé Airtable invalide (doit commencer par pat)');
            }

            if (errors.length > 0) {
                alert(errors.join('\\n'));
                return;
            }

            window.configureKeys(claudeKey, airtableKey);
        }

        // Fonction d'initialisation principale (appelée après config des clés)
        async function init() {
            console.time('[INIT] Total');

            // Phase 1: Setup UI immédiat (non-bloquant)
            loadData();
            setDate();
            render();
            setupNav();
            setupFilters();
            setupProspectsView();
            setupDropdowns();
            restoreFicheGenerationState();

            // Phase 2: Chargement données en parallèle (OPTIMISÉ)
            console.time('[INIT] Parallel loads');
            await Promise.all([
                loadAssetsManifest().catch(e => console.warn('[INIT] Assets manifest error:', e)),
                syncFromAirtable().catch(e => console.warn('[INIT] Sync error:', e))
            ]);
            console.timeEnd('[INIT] Parallel loads');

            console.timeEnd('[INIT] Total');
            console.log('%c[PACIFIK\'AI] Dashboard initialisé avec succès', 'color: #3b82f6; font-weight: bold');
        }

        // Bouton settings dans le header pour reconfigurer
        window.openSettings = function() {
            showConfigModal();
        };

        // Fonction pour supprimer toutes les fiches generees du localStorage
        window.clearAllFiches = function() {
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.startsWith('fiche_') || key === 'pacifikai_fiche_generation')) {
                    keysToRemove.push(key);
                }
            }
            keysToRemove.forEach(key => localStorage.removeItem(key));
            console.log('Fiches supprimees:', keysToRemove);
            if (typeof showToast === 'function') showToast(keysToRemove.length + ' fiches supprimees du localStorage');
            return keysToRemove;
        };

        // Auto-clear au chargement si parametre URL ?clearfiches=1
        if (new URLSearchParams(window.location.search).get('clearfiches') === '1') {
            window.clearAllFiches();
            // Retirer le parametre de l'URL
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        const CLAUDE_CONFIG = {
            get apiKey() { return getClaudeApiKey(); },
            model: 'claude-sonnet-4-5-20250929',
            // System prompt with full PACIFIK'AI context - AGENTIC VERSION
            systemPrompt: `Tu es **MANA**, l'assistant IA de Jordy Banks, fondateur de PACIFIK'AI.

MANA = Mon Assistant Numerique Automatise. Tu es le cerveau du CRM PACIFIK'AI.

## MEMOIRE PACIFIK'AI - CONTEXTE COMPLET

### Identite Entreprise
- **Nom**: PACIFIK'AI - Leader automatisation IA en Polynesie francaise
- **Fondateur**: Jordy Banks (base a Tahiti, Polynesie francaise)
- **Mission**: "100K Project" - Atteindre 100K€ de CA avec services B2B haute valeur
- **Email**: jordy@pacifikai.com
- **Site**: https://pacifikai.com
- **Facebook**: Page PACIFIK'AI (posts auto 3x/semaine)

### Parcours Jordy
- Ex-trader Forex (+10 ans, ~70K€/an revenus passifs)
- Methode ARD (trading proprietaire)
- Pivot vers l'IA et automatisation en 2024
- Formateur High Value Capital

### Marche & Positionnement
- **Zone**: Polynesie francaise (marche peu digitalise = opportunite)
- **Cibles prioritaires**:
  - Hotels 5* (Four Seasons, InterContinental, Conrad, St Regis...)
  - Compagnies aeriennes (Air Tahiti Nui, Air Tahiti)
  - Cabinets comptables (EDEC, FIDUPAC, HORWATH...)
  - Importateurs (Brasserie de Tahiti, CFAO, Pacific Petroleum...)
- **Canal dominant**: WhatsApp (culture locale)
- **Avantage concurrentiel**: Premier acteur IA avance sur ce marche insulaire

### Solutions Deployees
1. **Chatbot Hotels (RAG)** ✅ - Concierge 24/7 WhatsApp, multilingue, FAQ intelligente
2. **Extraction Comptable** ✅ - OCR + IA pour factures, automatisation saisie
3. **Commandes Importateurs** ✅ - WhatsApp -> bon de commande PDF automatique
4. **Reservations Restaurants** 🔄 - En cours de finalisation
5. **BookFlow** 🔄 - SaaS prise de RDV (React Native + Supabase)

### Stack Technique
- **Orchestration**: n8n self-hosted (Hostinger VPS)
- **IA**: Claude API (Sonnet 4.5 minimum, Haiku banni)
- **Communication**: Twilio (WhatsApp + SMS)
- **Databases**: Airtable (CRM), Supabase (PostgreSQL + Vector)
- **Embeddings**: Google Gemini text-embedding-004

### Pricing Standard
- **Setup**: 125K-500K XPF (1000-4000€) selon complexite
- **Mensuel**: 30-50K XPF (250-420€) maintenance
- **ROI client**: Rentabilise en 1-2 mois typiquement

### Clients Strategiques
- **Air Tahiti Nui**: Demo dashboard complete (15 workflows n8n), prospect hot
- **Air Tahiti**: Demo prete, statut contacte
- **COWAN MOTOR**: Proposition envoyee, en attente reponse

### Emails Polynesiens
- Ouverture: "Ia ora na" (bonjour en tahitien)
- Fermeture: "Mauruuru" (merci en tahitien)

## TON ROLE - MANA

Tu es l'assistant CRM intelligent de Jordy. Tu COMPRENDS le contexte et les intentions.

### Personnalite
- Direct, efficace, zero blabla
- Tu tutoies toujours Jordy
- Reponses courtes (2-4 phrases max)
- Tu connais TOUT sur PACIFIK'AI

### Comprendre Jordy
Il parle de facon informelle:
- "J'ai appele Air Tahiti" → Contact effectue
- "ils sont chauds" → Prospect interesse, passer en hot/chaud
- "rdv mardi" → Meeting planifie
- "c'est mort" / "ils veulent pas" → Prospect froid/perdu
- "on a signe!" → Prospect gagne (won)

## FORMAT DE REPONSE JSON OBLIGATOIRE

{
  "message": "Ta reponse pour Jordy",
  "actions": [
    {
      "type": "change_priority|change_status|add_note|create_task|update_task_status|delete_task|none",
      "target": "nom_entreprise ou titre_tache",
      "from": "valeur_actuelle (bulk)",
      "to": "nouvelle_valeur",
      "note": "texte note",
      "title": "titre de la tache (pour create_task)",
      "description": "description optionnelle",
      "priority": "Urgent/Normal/Faible",
      "dueDate": "YYYY-MM-DD",
      "project": "ATN/PACIFIKAI/etc"
    }
  ]
}

### Actions CRM (Prospects)
- **change_priority**: hot/chaud/tiede/froid
- **change_status**: lead/contacted/meeting/proposal/won
- **bulk_change_priority**: Changer tous les prospects d'une priorite
- **bulk_change_status**: Changer tous les prospects d'un status
- **add_note**: Ajouter une note a un prospect

### Actions TACHES (Task Manager)
- **create_task**: Creer une nouvelle tache (title obligatoire, description/priority/dueDate/project optionnels)
- **update_task_status**: Changer le statut (target=titre partiel, to=A faire/En cours/Termine/Bloque)
- **edit_task**: Modifier une tache existante (target=titre partiel, fields={description, priority, dueDate, status})
- **assign_task**: Assigner une tache (target=titre partiel, to="Jordy" ou "Honovai")
- **delete_task**: Supprimer une tache (target=titre partiel)

### Actions ASSIGNATION
- **assign_prospect**: Assigner un prospect a un membre (target=nom entreprise, to="Jordy"|"Honovai"|null)
- **none**: Juste repondre

## EQUIPE PACIFIK'AI
- **Jordy Banks** - Fondateur, business dev, technique
- **Honovai** - Assistante, support, suivi clients

Exemples:
- "cree une tache pour appeler ATN demain" → create_task avec title, dueDate, project=ATN
- "j'ai fini la tache video loom" → update_task_status avec target contenant "loom", to="Terminé"
- "assigne ATN a Honovai" → assign_prospect avec target="Air Tahiti Nui", to="Honovai"
- "change la priorite de la tache X en Urgent" → edit_task avec target="X", fields={priority:"Urgent"}
- "assigne la tache relance a Jordy" → assign_task avec target="relance", to="Jordy"
- "mes taches" → liste filtree par l'assignee courant
- "resume des taches" → synthese structuree de toutes les taches

IMPORTANT: JSON uniquement, pas de texte autour.`
        };

        // Chatbot state
        let chatHistory = [];
        let isChatbotOpen = false;
        let useClaudeAPI = true; // Toggle for Claude API vs local processing

        // MANA Agent n8n Webhook (avec mémoire persistante Airtable)
        const N8N_MANA_WEBHOOK = getN8nWebhook('mana');
        const MANA_SESSION_ID = localStorage.getItem('mana_session_id') || generateManaSessionId();

        // Génération Fiches Prospect Webhook (Tavily + Claude Sonnet)
        const N8N_FICHE_GENERATION_WEBHOOK = getN8nWebhook('deepResearch');

        function generateManaSessionId() {
            const id = 'mana_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('mana_session_id', id);
            return id;
        }

        function newManaSession() {
            localStorage.removeItem('mana_session_id');
            location.reload();
        }

        // Assets database - loaded dynamically from manifest
        // Generated by: ./scripts/generate-assets-manifest.sh
        let PROSPECT_ASSETS = {};

        // Load assets manifest on startup
        async function loadAssetsManifest() {
            try {
                const response = await fetch('assets-manifest.json?t=' + Date.now());
                if (response.ok) {
                    const manifest = await response.json();
                    PROSPECT_ASSETS = manifest.prospects || {};
                    console.log('[Assets] Manifest charge:', Object.keys(PROSPECT_ASSETS).length, 'prospects,',
                        Object.values(PROSPECT_ASSETS).reduce((acc, p) => acc + (p.files?.length || 0), 0), 'fichiers');
                    console.log('[Assets] Genere le:', manifest.generated);

                    // Fusionner avec les assets stockes en localStorage (fiches generees)
                    mergeLocalStorageAssets();

                    // Re-render if already loaded
                    if (prospects.length > 0) {
                        renderProspectsViews();
                    }
                } else {
                    console.warn('[Assets] Manifest non trouve, utilisation du fallback');
                    loadAssetsFallback();
                }
            } catch (error) {
                console.error('[Assets] Erreur chargement manifest:', error);
                loadAssetsFallback();
            }
        }

        // Fusionner les assets du localStorage avec PROSPECT_ASSETS
        function mergeLocalStorageAssets() {
            const savedAssets = localStorage.getItem('assetsManifest_updated');
            if (!savedAssets) return;

            try {
                const parsed = JSON.parse(savedAssets);
                const localProspects = parsed.prospects || {};

                for (const [company, data] of Object.entries(localProspects)) {
                    if (!data.files) continue;

                    // Filtrer seulement les fichiers generes (isGenerated: true)
                    const generatedFiles = data.files.filter(f => f.isGenerated === true);

                    if (generatedFiles.length === 0) continue;

                    // Creer l'entree si elle n'existe pas
                    if (!PROSPECT_ASSETS[company]) {
                        PROSPECT_ASSETS[company] = { folder: company, files: [] };
                    }

                    // Ajouter les fichiers generes s'ils n'existent pas deja
                    for (const genFile of generatedFiles) {
                        const exists = PROSPECT_ASSETS[company].files.some(f =>
                            f.file === genFile.file || (f.isGenerated && genFile.isGenerated)
                        );
                        if (!exists) {
                            PROSPECT_ASSETS[company].files.unshift(genFile);
                        }
                    }
                }

                console.log('[Assets] Fiches generees fusionnees depuis localStorage');
            } catch (e) {
                console.error('[Assets] Erreur fusion localStorage:', e);
            }
        }

        // Fallback assets si manifest non disponible
        function loadAssetsFallback() {
            PROSPECT_ASSETS = {
                'Air Tahiti Nui': {
                    folder: 'Air Tahiti Nui',
                    files: [
                        { type: 'dash', name: 'Dashboard', file: 'demo-site/dashboard.html', desc: 'Dashboard complet' },
                        { type: 'site', name: 'Landing Page', file: 'demo-site/index.html', desc: 'Page principale' },
                        { type: 'wf', name: 'Visualiseur n8n', file: 'demo-site/n8n-visualizer.html', desc: 'Workflows n8n' }
                    ]
                },
                'COWAN MOTOR': {
                    folder: 'COWAN MOTOR',
                    files: [
                        { type: 'doc', name: 'Proposition', file: 'proposition-commerciale.html', desc: 'Proposition commerciale' },
                        { type: 'doc', name: 'Script Appel', file: 'script-appel.md', desc: 'Script telephonique' }
                    ]
                }
            };
        }

        // Helper: Find assets for a prospect (handles name variations)
        function getProspectAssets(companyName) {
            // Direct match
            if (PROSPECT_ASSETS[companyName]) {
                return PROSPECT_ASSETS[companyName];
            }
            // Try without accents
            const normalized = companyName.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            for (const [key, value] of Object.entries(PROSPECT_ASSETS)) {
                const keyNormalized = key.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                if (keyNormalized.toLowerCase() === normalized.toLowerCase()) {
                    return value;
                }
            }
            // Try partial match
            for (const [key, value] of Object.entries(PROSPECT_ASSETS)) {
                if (key.toLowerCase().includes(companyName.toLowerCase()) ||
                    companyName.toLowerCase().includes(key.toLowerCase())) {
                    return value;
                }
            }
            return null;
        }

        // Refresh assets manifest (call after creating new files)
        function refreshAssetsManifest() {
            showToast('Actualisation des assets...');
            loadAssetsManifest().then(() => {
                showToast('Assets actualises');
            });
        }

        // Init
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Verifier l'authentification Supabase
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) return;

            // 2. Charger les membres de l'equipe
            await loadTeamMembers();

            // 3. Charger les données depuis Supabase (avant vérification clé Claude)
            await loadDataFromSupabase();

            // 4. Clés API Claude (optionnel - MANA peut fonctionner via n8n)
            // Modal de config supprimé - configuration via console si nécessaire

            // 5. Charger le manifest des assets AVANT le render (important pour Featured Prospects)
            await loadAssetsManifest();
            setDate();
            render();
            setupNav();
            setupFilters();
            setupProspectsView();
            setupDropdowns();

            // 5. Populer les dropdowns d'assignation avec les membres
            populateAssigneeDropdowns();

            // 6. Charger l'historique d'activite
            renderActivityFeed();

            // Restaurer l'etat de generation de fiche si en cours
            restoreFicheGenerationState();
        });

        // Charger les données depuis Supabase (remplace Airtable) - OPTIMISÉ PARALLÈLE
        async function loadDataFromSupabase() {
            console.time('[Supabase] Parallel fetch');
            try {
                // TOUTES les requêtes en parallèle pour un chargement ultra-rapide
                const [supabaseProspects, supabaseTasks, supabaseContent, supabaseInfras] = await Promise.all([
                    supabase.getProspects().catch(err => { console.error('[Supabase] getProspects FAILED:', err); return []; }),
                    supabase.getTasks().catch(err => { console.error('[Supabase] getTasks FAILED:', err); return []; }),
                    supabase.getContent().catch(err => { console.error('[Supabase] getContent FAILED:', err); return []; }),
                    supabase.getClientInfrastructures().catch(err => { console.error('[Supabase] getInfras FAILED:', err); return []; })
                ]);

                console.log('[Supabase] Raw prospects count:', supabaseProspects?.length || 0);
                console.log('[Supabase] First prospect:', supabaseProspects?.[0]);

                // Transformer prospects
                prospects = supabaseProspects.map(p => ({
                    id: p.id,
                    name: p.contact || '',
                    company: p.entreprise,
                    sector: p.secteur || '',
                    status: mapSupabaseStatus(p.status),
                    value: p.valeur_estimee || 0,
                    date: p.created_at?.split('T')[0] || '',
                    priority: mapSupabaseTemperature(p.temperature),
                    email: p.email || '',
                    phone: p.telephone || '',
                    notes: p.notes || '',
                    siteWeb: p.site_web || '',
                    linkedin: p.linkedin || '',
                    score: p.score,
                    scoreUrgence: p.score_urgence,
                    scoreBudget: p.score_budget,
                    scoreFit: p.score_fit,
                    scoreRaison: p.score_raison,
                    assignedTo: p.assigned_to,
                    supabaseId: p.id
                }));

                // Transformer tasks
                airtableTasks = supabaseTasks.map(t => ({
                    id: t.id,
                    title: t.titre,
                    description: t.description || '',
                    status: mapSupabaseTaskStatus(t.status),
                    priority: t.priorite || 'medium',
                    dueDate: t.due_date,
                    tempsEstime: t.temps_estime,
                    hours: t.temps_estime,
                    prospectId: t.prospect_id,
                    prospectName: t.prospect?.entreprise || '',
                    assignedTo: t.assigned_to,
                    assignee: t.assignee?.display_name || '',
                    assigneeName: t.assignee?.display_name || '',
                    assigneeColor: t.assignee?.avatar_color || '#3b82f6',
                    project: extractProject(t.titre || '')
                }));

                // Transformer content
                airtableContent = supabaseContent.map(c => ({
                    id: c.id,
                    titre: c.titre,
                    contenu: c.contenu,
                    plateforme: c.plateforme,
                    status: c.status,
                    date: c.publish_date,
                    hashtags: c.hashtags,
                    imageUrl: c.image_url
                }));

                // Transformer infrastructures
                clientInfrastructures = {};
                supabaseInfras.forEach(infra => {
                    if (infra.prospect_id) {
                        clientInfrastructures[infra.prospect_id] = infra;
                    }
                });

                console.timeEnd('[Supabase] Parallel fetch');
                console.log(`[Supabase] Loaded: ${prospects.length} prospects, ${airtableTasks.length} tasks, ${airtableContent.length} content, ${Object.keys(clientInfrastructures).length} infras`);

            } catch (e) {
                console.timeEnd('[Supabase] Parallel fetch');
                console.error('[Supabase] Erreur chargement (non-bloquant):', e);
            }
        }

        // Mapping des statuts Supabase vers dashboard
        function mapSupabaseStatus(status) {
            const map = {
                'lead': 'lead',
                'contacted': 'contacted',
                'meeting': 'meeting',
                'proposal': 'proposal',
                'won': 'won',
                'lost': 'lost'
            };
            return map[status] || 'lead';
        }

        function mapSupabaseTemperature(temp) {
            const map = {
                'cold': 'froid',
                'warm': 'tiede',
                'hot': 'chaud',
                'burning': 'hot'
            };
            return map[temp] || 'froid';
        }

        function mapSupabaseTaskStatus(status) {
            const map = {
                'todo': 'À faire',
                'in_progress': 'En cours',
                'blocked': 'Bloqué',
                'done': 'Terminé'
            };
            return map[status] || 'À faire';
        }

        function mapDashboardStatusToSupabase(status) {
            const map = {
                'lead': 'lead',
                'contacted': 'contacted',
                'meeting': 'meeting',
                'proposal': 'proposal',
                'won': 'won',
                'lost': 'lost'
            };
            return map[status] || 'lead';
        }

        function mapDashboardTaskStatusToSupabase(status) {
            const map = {
                'À faire': 'todo',
                'En cours': 'in_progress',
                'Bloqué': 'blocked',
                'Terminé': 'done'
            };
            return map[status] || 'todo';
        }

        function mapDashboardTemperatureToSupabase(temp) {
            // Inverse de mapSupabaseTemperature
            const map = {
                'froid': 'cold',
                'tiede': 'warm',
                'chaud': 'hot',
                'hot': 'burning'
            };
            return map[temp] || 'cold';
        }

        function loadData() {
            const p = localStorage.getItem('pk_prospects_v5'); // v5 = avec notes/followups
            const t = localStorage.getItem('pk_tasks');
            const n = localStorage.getItem('pk_notes');
            const f = localStorage.getItem('pk_followups');
            const sync = localStorage.getItem('pk_last_sync');

            if (p) prospects = JSON.parse(p);
            if (t) tasks = JSON.parse(t);
            if (n) notes = JSON.parse(n);
            if (f) followups = JSON.parse(f);
            if (sync) lastSync = new Date(sync);

            // Real data from Airtable CRM + Notion sync (56 prospects)
            // assets: site=demo-site, dash=dashboard, wf=workflow, doc=proposition
            if (!prospects.length) {
                prospects = [
                    // HOT - Priority targets
                    { id: 1, name: "Torea Colas", company: "Air Tahiti Nui", sector: "Transport", status: "lead", value: 3000000, date: "2026-01-28", priority: "hot", assets: ["site", "dash", "wf"] },
                    { id: 2, name: "", company: "Air Tahiti", sector: "Transport", status: "contacted", value: 3000000, date: "2026-01-28", priority: "hot", assets: ["site", "dash", "wf"] },
                    { id: 3, name: "Romain Chanet", company: "Four Seasons Bora Bora", sector: "Hotellerie", status: "lead", value: 3000000, date: "2026-01-28", priority: "hot" },
                    { id: 4, name: "Roger Godin", company: "Conrad Bora Bora Nui", sector: "Hotellerie", status: "lead", value: 3000000, date: "2026-01-28", priority: "hot" },
                    { id: 5, name: "Emmanuel Richardet", company: "St Regis Bora Bora", sector: "Hotellerie", status: "lead", value: 3000000, date: "2026-01-28", priority: "hot" },
                    { id: 6, name: "Anne Roure", company: "Sofitel Bora Bora Private Island", sector: "Hotellerie", status: "lead", value: 3000000, date: "2026-01-28", priority: "hot" },
                    { id: 7, name: "Rose Richmond", company: "Hilton Moorea Lagoon Resort", sector: "Hotellerie", status: "lead", value: 3000000, date: "2026-01-28", priority: "hot" },
                    { id: 8, name: "Emmanuel Richardet", company: "InterContinental Bora Bora Thalasso", sector: "Hotellerie", status: "lead", value: 3000000, date: "2026-01-28", priority: "hot" },
                    { id: 9, name: "Kareen Lisan", company: "Vini (OPT)", sector: "Telecom", status: "lead", value: 5000000, date: "2026-01-28", priority: "hot" },
                    { id: 10, name: "Maire Sabre", company: "OCA - Centre d'Appels", sector: "Services", status: "lead", value: 5000000, date: "2026-01-28", priority: "hot" },
                    { id: 11, name: "", company: "IMF Tahiti", sector: "Services", status: "lead", value: 4500000, date: "2026-01-28", priority: "hot" },
                    { id: 12, name: "Christel Gelormini", company: "Banque de Tahiti", sector: "Finance", status: "lead", value: 4500000, date: "2026-01-28", priority: "hot" },
                    // CHAUD
                    { id: 14, name: "", company: "Aranui", sector: "Transport", status: "contacted", value: 2500000, date: "2026-01-28", priority: "chaud", assets: ["site", "dash", "wf"] },
                    { id: 15, name: "", company: "Tahiti Tourisme", sector: "Tourisme", status: "lead", value: 6000000, date: "2026-01-28", priority: "chaud", assets: ["site", "dash", "wf"] },
                    { id: 16, name: "", company: "InterContinental Tahiti", sector: "Hotellerie", status: "lead", value: 4000000, date: "2026-01-28", priority: "chaud", assets: ["site", "dash"] },
                    { id: 17, name: "", company: "Groupama Gan PF", sector: "Assurance", status: "lead", value: 4000000, date: "2026-01-28", priority: "chaud" },
                    { id: 18, name: "", company: "Le Meridien Tahiti", sector: "Hotellerie", status: "lead", value: 3000000, date: "2026-01-28", priority: "chaud" },
                    { id: 19, name: "Sabine G. L.", company: "Sofitel Kia Ora Moorea", sector: "Hotellerie", status: "lead", value: 3000000, date: "2026-01-28", priority: "chaud" },
                    { id: 20, name: "", company: "Manava Beach Resort Moorea", sector: "Hotellerie", status: "lead", value: 3000000, date: "2026-01-28", priority: "chaud" },
                    { id: 21, name: "", company: "COWAN MOTOR", sector: "Import", status: "lead", value: 850000, date: "2026-01-28", priority: "chaud", assets: ["doc"] },
                    { id: 22, name: "", company: "EDEC SARL", sector: "Comptabilite", status: "lead", value: 2500000, date: "2026-01-28", priority: "chaud" },
                    { id: 23, name: "Jose Chanlin", company: "FIDUPAC SARL", sector: "Comptabilite", status: "lead", value: 2200000, date: "2026-01-28", priority: "chaud" },
                    { id: 24, name: "Thomas Wagener", company: "HORWATH SARL", sector: "Comptabilite", status: "lead", value: 2200000, date: "2026-01-28", priority: "chaud" },
                    { id: 25, name: "", company: "FIDELIANCE SARL", sector: "Comptabilite", status: "lead", value: 2200000, date: "2026-01-28", priority: "chaud" },
                    { id: 26, name: "Julie Hoarau", company: "CABINET MOREL & OUDET", sector: "Comptabilite", status: "lead", value: 2000000, date: "2026-01-28", priority: "chaud" },
                    { id: 27, name: "Philippe Bercegol", company: "EXPERTISE COMPTABLE TAHITI", sector: "Comptabilite", status: "lead", value: 2000000, date: "2026-01-28", priority: "chaud" },
                    { id: 28, name: "M. Sola", company: "AUDIT PACIFIQUE SARL", sector: "Comptabilite", status: "lead", value: 2000000, date: "2026-01-28", priority: "chaud" },
                    { id: 29, name: "Kevin Robson", company: "Brasserie de Tahiti", sector: "Import", status: "lead", value: 2000000, date: "2026-01-28", priority: "chaud" },
                    { id: 30, name: "", company: "Pacific Petroleum", sector: "Import", status: "lead", value: 2500000, date: "2026-01-28", priority: "chaud" },
                    { id: 31, name: "Gilles Afriat", company: "CFAO Tahiti", sector: "Import", status: "lead", value: 2200000, date: "2026-01-28", priority: "chaud" },
                    { id: 32, name: "", company: "SDO Tahiti", sector: "Import", status: "lead", value: 2000000, date: "2026-01-28", priority: "chaud" },
                    // TIEDE
                    { id: 33, name: "", company: "Banque de Polynesie", sector: "Finance", status: "lead", value: 5000000, date: "2026-01-28", priority: "tiede", assets: ["site", "dash", "wf"] },
                    { id: 34, name: "", company: "OPT", sector: "Telecom", status: "lead", value: 4000000, date: "2026-01-28", priority: "tiede", assets: ["site", "dash", "wf"] },
                    { id: 35, name: "Alain Ciantar", company: "Tahiti Auto Services", sector: "Import", status: "lead", value: 1800000, date: "2026-01-28", priority: "tiede" },
                    { id: 36, name: "Christophe Guardia", company: "Le Tahiti by Pearl Resorts", sector: "Hotellerie", status: "lead", value: 1000000, date: "2026-01-28", priority: "tiede" },
                    { id: 37, name: "Laurent LE SEAC'H", company: "Le Taha'a by Pearl Resorts", sector: "Hotellerie", status: "lead", value: 1000000, date: "2026-01-28", priority: "tiede" },
                    { id: 38, name: "Laurent LE SEAC'H", company: "Le Bora Bora by Pearl Resorts", sector: "Hotellerie", status: "lead", value: 1000000, date: "2026-01-28", priority: "tiede" },
                    { id: 39, name: "", company: "Le Tikehau by Pearl Resorts", sector: "Hotellerie", status: "lead", value: 1000000, date: "2026-01-28", priority: "tiede" },
                    { id: 40, name: "Michael Delmas", company: "Maitai Polynesia Bora Bora", sector: "Hotellerie", status: "lead", value: 1000000, date: "2026-01-28", priority: "tiede" },
                    { id: 41, name: "Laurent Campi", company: "Maitai Lapita Village Huahine", sector: "Hotellerie", status: "lead", value: 1000000, date: "2026-01-28", priority: "tiede" },
                    { id: 42, name: "Arieta Manager", company: "Royal Huahine", sector: "Hotellerie", status: "lead", value: 1000000, date: "2026-01-28", priority: "tiede" },
                    { id: 43, name: "Olivier Davin", company: "Hotel Le Mahana Huahine", sector: "Hotellerie", status: "lead", value: 1000000, date: "2026-01-28", priority: "tiede" },
                    { id: 44, name: "Philippe Sizaret", company: "Cook's Bay Hotel Moorea", sector: "Hotellerie", status: "lead", value: 1000000, date: "2026-01-28", priority: "tiede" },
                    { id: 45, name: "Natalee Martin", company: "Te Moana Tahiti Resort", sector: "Hotellerie", status: "lead", value: 1000000, date: "2026-01-28", priority: "tiede" },
                    { id: 46, name: "Loic Hurtrel", company: "Raiatea Lodge Hotel", sector: "Hotellerie", status: "lead", value: 1000000, date: "2026-01-28", priority: "tiede" },
                    { id: 47, name: "", company: "Hotel Kia Ora Rangiroa", sector: "Hotellerie", status: "lead", value: 1000000, date: "2026-01-28", priority: "tiede" },
                    { id: 48, name: "Cesar Marquez", company: "The Westin Bora Bora", sector: "Hotellerie", status: "lead", value: 1000000, date: "2026-01-28", priority: "tiede" },
                    // FROID
                    { id: 49, name: "", company: "The Moorings", sector: "Nautique", status: "lead", value: 1500000, date: "2026-01-28", priority: "froid", assets: ["site", "dash", "wf"] },
                    { id: 50, name: "Manutea Sachet", company: "Te Mana Import", sector: "Import", status: "lead", value: 1500000, date: "2026-01-28", priority: "froid" },
                    { id: 51, name: "Gilbert Liao", company: "Essor Import SARL", sector: "Import", status: "lead", value: 1500000, date: "2026-01-28", priority: "froid" },
                    { id: 52, name: "", company: "PORINETIA IMPORT EXPORT", sector: "Import", status: "lead", value: 1500000, date: "2026-01-28", priority: "froid" },
                    { id: 53, name: "F. Delsol", company: "AUDIFI SARL", sector: "Comptabilite", status: "lead", value: 1500000, date: "2026-01-28", priority: "froid" },
                    { id: 54, name: "Grand Michel", company: "Easy Rider Tahiti", sector: "Import", status: "lead", value: 1200000, date: "2026-01-28", priority: "froid" },
                    { id: 55, name: "Youk Moux", company: "Distillerie Moux", sector: "Import", status: "lead", value: 1200000, date: "2026-01-28", priority: "froid" },
                    { id: 56, name: "Chung Tonino", company: "Chung Import", sector: "Import", status: "lead", value: 1500000, date: "2026-01-28", priority: "froid" },
                ];
                save();
            }
        }

        function save() {
            localStorage.setItem('pk_prospects_v5', JSON.stringify(prospects));
            localStorage.setItem('pk_tasks', JSON.stringify(tasks));
            localStorage.setItem('pk_notes', JSON.stringify(notes));
            localStorage.setItem('pk_followups', JSON.stringify(followups));
            if (lastSync) localStorage.setItem('pk_last_sync', lastSync.toISOString());
        }

        // ============================================
        // SYNC PROSPECTS FROM AIRTABLE CRM
        // ============================================
        async function syncProspectsFromAirtable() {
            const apiKey = AIRTABLE_CONFIG.apiKey;
            if (!apiKey) {
                showToast('Cle API Airtable non configuree', 'error');
                return;
            }

            try {
                showToast('Synchronisation Airtable en cours...', 'info');

                const url = `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/CRM?pageSize=100`;
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${apiKey}` }
                });

                if (!response.ok) {
                    throw new Error(`Erreur Airtable: ${response.status}`);
                }

                const data = await response.json();

                // Map Airtable fields to dashboard format
                const mappedProspects = data.records.map((record, index) => {
                    const f = record.fields;

                    // Map status from French to English
                    const statusMap = {
                        'Prospect': 'lead',
                        'Lead': 'lead',
                        'Contacté': 'contacted',
                        'Contact': 'contacted',
                        'RDV planifié': 'meeting',
                        'Meeting': 'meeting',
                        'Proposition envoyée': 'proposal',
                        'Proposal': 'proposal',
                        'Gagné': 'won',
                        'Won': 'won',
                        'Perdu': 'lost',
                        'Lost': 'lost'
                    };

                    // Map priority/temperature from French to English
                    const priorityMap = {
                        'Hot': 'hot',
                        'Chaud': 'chaud',
                        'Tiède': 'tiede',
                        'Tiede': 'tiede',
                        'Froid': 'froid',
                        'Cold': 'froid'
                    };

                    return {
                        id: record.id,
                        name: f['Contact'] || f['Nom'] || '',
                        company: f['Entreprise'] || f['Company'] || 'Sans nom',
                        sector: f['Secteur'] || f['Sector'] || 'Autre',
                        status: statusMap[f['Status']] || 'lead',
                        value: f['Valeur estimée'] || f['Value'] || 0,
                        date: f['Created'] || new Date().toISOString().split('T')[0],
                        priority: priorityMap[f['Priorité']] || priorityMap[f['Temperature']] || 'tiede',
                        email: f['Email'] || '',
                        phone: f['Téléphone'] || f['Phone'] || '',
                        notes: f['Notes'] || '',
                        assets: [] // Will be populated from assets if linked
                    };
                });

                // Update prospects array
                prospects = mappedProspects;
                lastSync = new Date();
                save();

                // Re-render views
                renderProspectsViews();
                renderStats();
                renderPipeline();

                showToast(`${prospects.length} prospects synchronises depuis Airtable`, 'success');

                // Update sync status indicator
                const syncDot = document.querySelector('.sync-dot');
                if (syncDot) syncDot.classList.remove('syncing', 'error');

            } catch (error) {
                console.error('Erreur sync Airtable:', error);
                showToast(`Erreur sync: ${error.message}`, 'error');

                const syncDot = document.querySelector('.sync-dot');
                if (syncDot) {
                    syncDot.classList.remove('syncing');
                    syncDot.classList.add('error');
                }
            }
        }

        // Force reload with default data (for debugging)
        function resetToDefaultProspects() {
            if (!confirm('Recharger les 56 prospects par defaut? Les modifications locales seront perdues.')) return;

            localStorage.removeItem('pk_prospects_v5');
            prospects = [];
            loadData();
            renderProspectsViews();
            renderStats();
            renderPipeline();
            showToast('Prospects reinitialises', 'success');
        }

        function setDate() {
            const d = new Date();
            document.getElementById('current-date').textContent = d.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        }

        // Navigation
        function setupNav() {
            document.querySelectorAll('.nav-item[data-view]').forEach(el => {
                el.addEventListener('click', e => {
                    e.preventDefault();
                    showView(el.dataset.view);
                });
            });
        }

        function showView(name) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('view-' + name).classList.add('active');
            document.querySelector(`.nav-item[data-view="${name}"]`)?.classList.add('active');

            // Trigger view-specific renders
            if (name === 'analytics' && typeof renderAnalyticsView === 'function') {
                renderAnalyticsView();
            } else if (name === 'tasks' && typeof renderTasks === 'function') {
                renderTasks();
            } else if (name === 'prospects' && typeof renderProspectsTable === 'function') {
                renderProspectsTable('all');
            } else if (name === 'content' && typeof loadFacebookPosts === 'function') {
                loadFacebookPosts();
            } else if (name === 'focus' && typeof renderFocusMode === 'function') {
                renderFocusMode();
            } else if (name === 'messages' && typeof loadMessengerConversations === 'function') {
                loadMessengerConversations();
            } else if (name === 'finance' && typeof loadFinanceData === 'function') {
                loadFinanceData();
            }
        }

        // IA Tool Iframe Functions
        let currentIAToolUrl = null;

        function showIATool(url, name) {
            currentIAToolUrl = url;
            document.getElementById('ia-tool-title').textContent = name;
            document.getElementById('ia-tool-external-link').href = url;
            document.getElementById('ia-tool-iframe').src = url;

            // Hide all views and show IA tool view
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('view-ia-tool').classList.add('active');
        }

        function closeIATool() {
            // Clear iframe to stop any running processes
            document.getElementById('ia-tool-iframe').src = 'about:blank';
            currentIAToolUrl = null;

            // Return to dashboard
            showView('dashboard');
        }

        // Filters
        function setupFilters() {
            document.querySelectorAll('.card-btn[data-filter]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.card-btn[data-filter]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    renderProspectsTable(btn.dataset.filter);
                });
            });

        }

        // Render
        function render() {
            renderStats();
            renderFeaturedProspects();
            renderPipeline();
            renderRecentProspects();
            renderProspectsTable('all');
            renderTasks();
            renderProspectsViews();
        }

        function renderFeaturedProspects() {
            // Debug: afficher les noms disponibles
            console.log('[Featured] Prospects dans PROSPECT_ASSETS:', Object.keys(PROSPECT_ASSETS));
            console.log('[Featured] Prospects chargés:', prospects.map(p => p.company));

            // Filtrer les prospects qui ont des assets dans le manifest
            const featured = prospects.filter(p => {
                const assets = getProspectAssets(p.company);
                if (assets) console.log('[Featured] Match trouvé pour:', p.company, '→', assets.files?.length, 'fichiers');
                return assets && assets.files && assets.files.length > 0;
            });
            console.log('[Featured] Prospects avec assets:', featured.length);

            const container = document.getElementById('featured-prospects');

            if (featured.length === 0) {
                container.innerHTML = `
                    <div style="color: var(--text-muted); font-size: 0.875rem; padding: 2rem; text-align: center; grid-column: 1 / -1;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 32px; height: 32px; margin: 0 auto 0.75rem; opacity: 0.4;">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                        Aucun prospect avec prototype
                    </div>
                `;
                return;
            }

            container.innerHTML = featured.map(p => {
                const assets = getProspectAssets(p.company);
                const assetTypes = assets.files.map(f => f.type).filter((v, i, a) => a.indexOf(v) === i);
                const fileCount = assets.files.length;
                return `
                    <div class="featured-card" onclick="openProspectDetail('${p.id}')">
                        <div class="featured-card-content">
                            <div class="featured-card-header">
                                <div class="featured-card-company">${p.company}</div>
                                <div class="featured-card-badge">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                                    Actif
                                </div>
                            </div>
                            ${p.sector ? `<div class="featured-card-sector">${p.sector}</div>` : ''}
                            <div class="featured-card-assets">
                                ${renderAssetIcons(assetTypes)}
                                <div class="featured-card-count">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                                    ${fileCount} fichier${fileCount > 1 ? 's' : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function refreshAll() { render(); }

        function renderStats() {
            const total = prospects.length;
            const contacted = prospects.filter(p => ['contacted','meeting','proposal','won'].includes(p.status)).length;
            const meetings = prospects.filter(p => p.status === 'meeting').length;
            const won = prospects.filter(p => p.status === 'won').length;
            const pipeline = prospects.filter(p => p.status !== 'lost').reduce((s, p) => s + (p.value || 0), 0);

            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-contacted').textContent = contacted;
            document.getElementById('stat-meetings').textContent = meetings;
            document.getElementById('stat-won').textContent = won;
            document.getElementById('stat-pipeline').textContent = fmtXPF(pipeline);
            document.getElementById('nav-prospect-count').textContent = total;
        }

        // Check si un prospect a une infrastructure deployee
        function hasInfrastructure(prospectId) {
            return !!clientInfrastructures[prospectId];
        }

        // Render indicateur infrastructure (petite icone)
        function renderInfraIndicator(prospectId) {
            if (!hasInfrastructure(prospectId)) return '';
            const infra = clientInfrastructures[prospectId];
            const statusColor = infra.status === 'active' ? 'var(--green)' : infra.status === 'pilot' ? 'var(--yellow)' : 'var(--text-dim)';
            return `<span title="Infrastructure IA (${infra.status || 'pending'})" style="display: inline-flex; align-items: center; margin-left: 4px; color: ${statusColor};">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 12px; height: 12px;"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
            </span>`;
        }

        function renderPipeline() {
            const stages = [
                { key: 'lead', label: 'Lead' },
                { key: 'contacted', label: 'Contacte' },
                { key: 'meeting', label: 'RDV/Audit' },
                { key: 'proposal', label: 'Proposition' },
                { key: 'won', label: 'Gagne' }
            ];

            const board = document.getElementById('pipeline-board');
            board.innerHTML = stages.map(s => {
                const items = prospects.filter(p => p.status === s.key);
                return `
                    <div class="pipeline-col" data-status="${s.key}"
                         ondragover="handleDragOver(event)"
                         ondragleave="handleDragLeave(event)"
                         ondrop="handleStatusDrop(event, '${s.key}')">
                        <div class="pipeline-header">
                            <span class="pipeline-title">${s.label}</span>
                            <span class="pipeline-count">${items.length}</span>
                        </div>
                        ${items.map(p => {
                            const hasAssets = p.assets && p.assets.length > 0;
                            const scoreBadge = typeof getScoreBadge === 'function' ? getScoreBadge(p.id || p.airtableId) : '';
                            const infraIndicator = renderInfraIndicator(p.id);
                            return `
                            <div class="pipeline-card ${hasAssets ? 'has-assets' : ''}"
                                 draggable="true"
                                 data-id="${p.id}"
                                 ondragstart="handleDragStart(event, '${p.id}')"
                                 ondragend="handleDragEnd(event)"
                                 onclick="openProspectDetail('${p.id}')"
                                 style="cursor: pointer;">
                                <div class="pipeline-card-name">${p.company}${renderAssetIcons(p.assets, true)}${infraIndicator} ${scoreBadge}</div>
                                <div class="pipeline-card-company">${p.sector}</div>
                                <div class="pipeline-card-footer">
                                    <span class="pipeline-card-value">${fmtXPF(p.value)}</span>
                                    ${p.priority ? `<span class="pipeline-card-priority ${p.priority}">${priorityLabel(p.priority)}</span>` : ''}
                                </div>
                            </div>
                        `;}).join('')}
                    </div>
                `;
            }).join('');
        }

        function renderRecentProspects() {
            const recent = [...prospects].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 6);
            const tbody = document.getElementById('recent-prospects');
            tbody.innerHTML = recent.map(p => `
                <tr>
                    <td>
                        <div class="cell-name">
                            <div class="avatar ${getAvatarColor(p.status)}">${initials(p.company)}</div>
                            <span>${p.company}</span>${renderAssetIcons(p.assets)}
                        </div>
                    </td>
                    <td>${p.sector}</td>
                    <td><span class="badge ${p.status}"><span class="badge-dot"></span>${statusLabel(p.status)}</span></td>
                    <td>${fmtXPF(p.value)}</td>
                </tr>
            `).join('');
        }

        function renderProspectsTable(filter) {
            const filtered = getFilteredProspects();
            const tbody = document.getElementById('prospects-table');
            tbody.innerHTML = filtered.map(p => {
                const scoreBadge = typeof getScoreBadge === 'function' ? getScoreBadge(p.id || p.airtableId) : '-';
                const infraIndicator = renderInfraIndicator(p.id);
                return `
                <tr class="${p.assets?.length ? 'has-assets' : ''}" onclick="openProspectDetail('${p.id}')" style="cursor: pointer;">
                    <td>
                        <div class="cell-name">
                            <div class="avatar ${getAvatarColor(p.status)}">${initials(p.company)}</div>
                            <span>${p.company}</span>${renderAssetIcons(p.assets)}${infraIndicator}
                        </div>
                    </td>
                    <td>${p.name || '-'}</td>
                    <td>${p.sector}</td>
                    <td><span class="badge ${p.status}"><span class="badge-dot"></span>${statusLabel(p.status)}</span></td>
                    <td>${fmtXPF(p.value)}</td>
                    <td>${scoreBadge || '-'}</td>
                    <td>${p.priority ? `<span class="badge ${p.priority}">${priorityLabel(p.priority)}</span>` : '-'}</td>
                    <td>${renderAssigneeBadge(p.assignedTo, 22) || '<span style="color:var(--text-dim)">-</span>'}</td>
                </tr>
            `;}).join('');
        }

        // Tasks Data (loaded from Supabase via loadDataFromSupabase)
        let airtableTasks = [];

        async function loadTasksFromAirtable() {
            // Deprecated - tasks now loaded via loadDataFromSupabase
            // This function is kept for compatibility but just renders existing data
            try {
                // Load comments from Supabase
                if (airtableTasks.length > 0) {
                    for (const task of airtableTasks) {
                        const comments = await supabase.getComments('task', task.id);
                        taskComments[task.id] = comments.map(c => ({
                            text: c.content,
                            date: c.created_at,
                            author: c.user_name
                        }));
                    }
                }

                renderTasks();
                setupTaskDragAndDrop();
            } catch (err) {
                console.error('Erreur chargement tasks:', err);
            }
        }

        function extractProject(title) {
            const match = title.match(/^\[([^\]]+)\]/);
            return match ? match[1] : 'other';
        }

        function filterTasks() {
            currentTaskProjectFilter = document.getElementById('task-project-filter').value;
            currentTaskPriorityFilter = document.getElementById('task-priority-filter').value;
            currentTaskAssigneeFilter = document.getElementById('task-assignee-filter').value;
            currentTaskSort = document.getElementById('task-sort-select')?.value || 'priority';
            const searchEl = document.getElementById('search-tasks');
            taskSearchQuery = searchEl ? searchEl.value.toLowerCase().trim() : '';
            renderTasks();
        }

        function getFilteredTasks() {
            let tasks = airtableTasks.filter(t => {
                const projectMatch = currentTaskProjectFilter === 'all' ||
                    (currentTaskProjectFilter === 'other' && !['ATN', 'PACIFIKAI', 'HVC', 'COWAN'].includes(t.project)) ||
                    t.project === currentTaskProjectFilter;
                const priorityMatch = currentTaskPriorityFilter === 'all' || t.priority === currentTaskPriorityFilter;
                const assigneeMatch = currentTaskAssigneeFilter === 'all' ||
                    (currentTaskAssigneeFilter === 'unassigned' && !t.assignee) ||
                    t.assignee === currentTaskAssigneeFilter;
                const searchMatch = !taskSearchQuery ||
                    (t.title || '').toLowerCase().includes(taskSearchQuery) ||
                    (t.description || '').toLowerCase().includes(taskSearchQuery) ||
                    (t.prospectName || '').toLowerCase().includes(taskSearchQuery) ||
                    (t.assignee || '').toLowerCase().includes(taskSearchQuery);
                return projectMatch && priorityMatch && assigneeMatch && searchMatch;
            });

            // Sort
            const priorityOrder = { 'Urgent': 0, 'Normal': 1, 'Faible': 2 };
            switch (currentTaskSort) {
                case 'priority':
                    tasks.sort((a, b) => (priorityOrder[a.priority] ?? 9) - (priorityOrder[b.priority] ?? 9));
                    break;
                case 'dueDate':
                    tasks.sort((a, b) => {
                        if (!a.dueDate) return 1;
                        if (!b.dueDate) return -1;
                        return new Date(a.dueDate) - new Date(b.dueDate);
                    });
                    break;
                case 'assignee':
                    tasks.sort((a, b) => (a.assignee || 'ZZZ').localeCompare(b.assignee || 'ZZZ'));
                    break;
                case 'project':
                    tasks.sort((a, b) => (a.project || 'ZZZ').localeCompare(b.project || 'ZZZ'));
                    break;
                case 'created':
                    tasks.sort((a, b) => (b.id || '').localeCompare(a.id || ''));
                    break;
            }

            return tasks;
        }

        function renderTasks() {
            const filtered = getFilteredTasks();
            const now = new Date();

            // Stats
            const urgent = filtered.filter(t => t.priority === 'Urgent').length;
            const pending = filtered.filter(t => t.status === 'À faire').length;
            const progress = filtered.filter(t => t.status === 'En cours').length;
            const done = filtered.filter(t => t.status === 'Terminé').length;
            const total = filtered.length;
            const overdue = filtered.filter(t => t.dueDate && new Date(t.dueDate) < now && t.status !== 'Terminé').length;

            document.getElementById('task-urgent-count').textContent = urgent;
            document.getElementById('task-pending-count').textContent = pending;
            document.getElementById('task-progress-count').textContent = progress;
            document.getElementById('task-done-count').textContent = done;

            // Progress bar
            const pct = total > 0 ? Math.round((done / total) * 100) : 0;
            const progressLabel = document.getElementById('task-progress-label');
            const progressFill = document.getElementById('task-progress-fill');
            const progressDetail = document.getElementById('task-progress-detail');
            const overdueBadge = document.getElementById('task-overdue-badge');
            if (progressLabel) progressLabel.textContent = `${pct}% termine`;
            if (progressFill) progressFill.style.width = `${pct}%`;
            if (progressDetail) progressDetail.textContent = `${done}/${total}`;
            if (overdueBadge) {
                if (overdue > 0) {
                    overdueBadge.style.display = '';
                    overdueBadge.textContent = `${overdue} en retard`;
                } else {
                    overdueBadge.style.display = 'none';
                }
            }

            // Kanban view
            if (currentTaskView === 'kanban') {
                const columns = {
                    'À faire': { el: 'kanban-todo', count: 'kanban-todo-count' },
                    'En cours': { el: 'kanban-progress', count: 'kanban-progress-count' },
                    'Bloqué': { el: 'kanban-blocked', count: 'kanban-blocked-count' },
                    'Terminé': { el: 'kanban-done', count: 'kanban-done-count' }
                };

                Object.entries(columns).forEach(([status, cfg]) => {
                    const items = filtered.filter(t => t.status === status);
                    document.getElementById(cfg.count).textContent = items.length;
                    document.getElementById(cfg.el).innerHTML = items.map(t => renderTaskCard(t)).join('');
                });

                setupTaskDragAndDrop();
            }

            // List view
            if (currentTaskView === 'list') {
                renderTaskListView(filtered);
            }
        }

        function renderTaskCard(t) {
            const priorityClass = { 'Urgent': 'hot', 'Normal': '', 'Faible': 'tiede' }[t.priority] || '';
            const dueStr = t.dueDate ? new Date(t.dueDate).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }) : '';
            const isOverdue = t.dueDate && new Date(t.dueDate) < new Date() && t.status !== 'Terminé';
            const assigneeInitial = t.assignee ? t.assignee.charAt(0).toUpperCase() : '';
            const assigneeColor = t.assignee === 'Jordy' ? 'var(--accent)' : t.assignee === 'Honovai' ? 'var(--purple)' : 'var(--text-dim)';

            return `
                <div class="pipeline-card task-card ${isOverdue ? 'task-kanban-overdue' : ''}" data-task-id="${t.id}" draggable="true" onclick="openTaskModal('${t.id}')" style="cursor: pointer;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 0.5rem;">
                        <div class="pipeline-card-name" style="flex: 1;">${t.title.replace(/^\[[^\]]+\]\s*/, '')}</div>
                        ${t.assignee ? `<div style="width: 24px; height: 24px; border-radius: 50%; background: ${assigneeColor}; color: white; font-size: 0.625rem; font-weight: 600; display: flex; align-items: center; justify-content: center; flex-shrink: 0;" title="${t.assignee}">${assigneeInitial}</div>` : ''}
                    </div>
                    ${t.description ? `<div class="pipeline-card-company" style="font-size: 0.7rem; opacity: 0.7; margin-top: 0.25rem;">${t.description.substring(0, 60)}${t.description.length > 60 ? '...' : ''}</div>` : ''}
                    <div class="pipeline-card-footer" style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.25rem; align-items: center;">
                        ${t.project !== 'other' ? `<span class="badge" style="background: var(--purple); font-size: 0.6rem; padding: 0.1rem 0.3rem;">${t.project}</span>` : ''}
                        ${dueStr ? `<span style="font-size: 0.65rem; color: ${isOverdue ? 'var(--red)' : 'var(--text-muted)'};">${isOverdue ? '⚠ ' : ''}${dueStr}</span>` : ''}
                        ${t.priority === 'Urgent' ? `<span class="badge" style="background: rgba(239, 68, 68, 0.2); color: var(--red); font-size: 0.6rem; padding: 0.1rem 0.3rem;">Urgent</span>` : ''}
                        ${t.hours ? `<span style="font-size: 0.6rem; color: var(--text-dim);">${t.hours}h</span>` : ''}
                    </div>
                </div>
            `;
        }

        function switchTaskView(view) {
            currentTaskView = view;
            document.getElementById('task-kanban').style.display = view === 'kanban' ? '' : 'none';
            document.getElementById('task-list-view').style.display = view === 'list' ? '' : 'none';
            document.querySelectorAll('.task-view-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`task-view-${view}-btn`)?.classList.add('active');
            renderTasks();
        }

        function renderTaskListView(tasks) {
            const tbody = document.getElementById('task-list-tbody');
            if (!tbody) return;
            const now = new Date();

            tbody.innerHTML = tasks.map(t => {
                const isOverdue = t.dueDate && new Date(t.dueDate) < now && t.status !== 'Terminé';
                const isDone = t.status === 'Terminé';
                const dueStr = t.dueDate ? new Date(t.dueDate).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }) : '-';
                const isToday = t.dueDate && new Date(t.dueDate).toDateString() === now.toDateString();
                const dueColor = isOverdue ? 'var(--red)' : isToday ? 'var(--orange)' : 'var(--text-muted)';
                const assigneeInitial = t.assignee ? t.assignee.charAt(0).toUpperCase() : '';
                const assigneeColor = t.assignee === 'Jordy' ? 'var(--accent)' : t.assignee === 'Honovai' ? 'var(--purple)' : 'var(--text-dim)';
                const statusColors = { 'À faire': 'var(--text-muted)', 'En cours': 'var(--blue)', 'Bloqué': 'var(--orange)', 'Terminé': 'var(--green)' };
                const nextPriority = { 'Urgent': 'Normal', 'Normal': 'Faible', 'Faible': 'Urgent' };

                return `<tr class="task-list-row ${isOverdue ? 'overdue' : ''}" style="${isDone ? 'opacity:0.6;' : ''}">
                    <td>
                        <div class="task-list-checkbox ${isDone ? 'done' : ''}" onclick="event.stopPropagation(); quickToggleTask('${t.id}')" title="${isDone ? 'Reouvrir' : 'Terminer'}">
                            ${isDone ? '<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" style="width:12px;height:12px;"><polyline points="20 6 9 17 4 12"/></svg>' : ''}
                        </div>
                    </td>
                    <td style="cursor:pointer;${isDone ? 'text-decoration:line-through;' : ''}" onclick="openTaskModal('${t.id}')">
                        <div style="font-weight:500;">${t.title.replace(/^\[[^\]]+\]\s*/, '')}</div>
                        ${t.description ? `<div style="font-size:0.7rem;color:var(--text-dim);margin-top:2px;">${t.description.substring(0, 80)}${t.description.length > 80 ? '...' : ''}</div>` : ''}
                    </td>
                    <td><span style="font-size:0.7rem;color:${statusColors[t.status] || 'var(--text-muted)'};font-weight:500;">${t.status}</span></td>
                    <td><span class="quick-priority ${t.priority}" onclick="event.stopPropagation(); quickChangePriority('${t.id}', '${nextPriority[t.priority] || 'Normal'}')">${t.priority}</span></td>
                    <td style="font-size:0.75rem;color:${dueColor};font-weight:${isOverdue ? '600' : '400'};">${isOverdue ? '⚠ ' : ''}${dueStr}</td>
                    <td>${t.assignee ? `<div style="width:22px;height:22px;border-radius:50%;background:${assigneeColor};color:white;font-size:0.6rem;font-weight:600;display:flex;align-items:center;justify-content:center;" title="${t.assignee}">${assigneeInitial}</div>` : ''}</td>
                    <td>${t.project !== 'other' ? `<span class="badge" style="background:var(--purple);font-size:0.6rem;padding:0.1rem 0.3rem;">${t.project}</span>` : '-'}</td>
                    <td style="text-align:center;">
                        <button class="btn btn-ghost" onclick="event.stopPropagation(); openTaskModal('${t.id}')" style="padding:2px 6px;font-size:0.7rem;" title="Modifier">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px;"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                        </button>
                    </td>
                </tr>`;
            }).join('');
        }

        async function quickToggleTask(taskId) {
            const task = airtableTasks.find(t => t.id === taskId);
            if (!task) return;
            const newStatus = task.status === 'Terminé' ? 'À faire' : 'Terminé';
            task.status = newStatus;
            renderTasks();
            try {
                const statusMap = { 'À faire': 'todo', 'En cours': 'in_progress', 'Bloqué': 'blocked', 'Terminé': 'done' };
                await supabase.updateTask(taskId, { status: statusMap[newStatus] || 'todo' });
                showToast(newStatus === 'Terminé' ? 'Tache terminee' : 'Tache rouverte');
            } catch (err) {
                console.error('[Task] Quick toggle error:', err);
                task.status = newStatus === 'Terminé' ? 'À faire' : 'Terminé';
                renderTasks();
                showToast('Erreur mise a jour');
            }
        }

        async function quickChangePriority(taskId, newPriority) {
            const task = airtableTasks.find(t => t.id === taskId);
            if (!task) return;
            const oldPriority = task.priority;
            task.priority = newPriority;
            renderTasks();
            try {
                await supabase.updateTask(taskId, { priorite: newPriority });
                showToast(`Priorite: ${newPriority}`);
            } catch (err) {
                console.error('[Task] Quick priority error:', err);
                task.priority = oldPriority;
                renderTasks();
                showToast('Erreur mise a jour');
            }
        }

        // Task Modal Functions
        function openTaskModal(taskId = null) {
            currentEditingTaskId = taskId;
            const modal = document.getElementById('task-modal');
            const form = document.getElementById('task-form');

            // Populate prospect dropdown
            populateTaskProspectDropdown();

            if (taskId) {
                // Edit mode
                const task = airtableTasks.find(t => t.id === taskId);
                if (!task) return;

                document.getElementById('task-modal-title').textContent = 'Modifier la Tache';
                document.getElementById('task-modal-subtitle').textContent = `ID: ${taskId}`;
                document.getElementById('task-save-btn-text').textContent = 'Enregistrer';
                document.getElementById('task-delete-btn').style.display = 'inline-flex';
                document.getElementById('task-comments-section').style.display = 'block';
                document.getElementById('task-history-section').style.display = 'block';

                // Fill form
                document.getElementById('task-edit-id').value = taskId;
                document.getElementById('task-title').value = task.title.replace(/^\[[^\]]+\]\s*/, '');
                document.getElementById('task-project').value = task.project !== 'other' ? task.project : '';
                document.getElementById('task-priority').value = task.priority;
                document.getElementById('task-assignee').value = task.assignee || '';
                document.getElementById('task-due-date').value = task.dueDate || '';
                document.getElementById('task-status').value = task.status;
                document.getElementById('task-estimated-time').value = task.hours || '';
                document.getElementById('task-prospect').value = task.prospectId || '';
                document.getElementById('task-description').value = task.description;

                // Render comments
                renderTaskComments(taskId);
                // Render history
                renderTaskHistory(taskId);
            } else {
                // Create mode
                document.getElementById('task-modal-title').textContent = 'Nouvelle Tache';
                document.getElementById('task-modal-subtitle').textContent = 'Creer une nouvelle tache';
                document.getElementById('task-save-btn-text').textContent = 'Creer';
                document.getElementById('task-delete-btn').style.display = 'none';
                document.getElementById('task-comments-section').style.display = 'none';
                document.getElementById('task-history-section').style.display = 'none';

                form.reset();
                document.getElementById('task-status').value = 'À faire';
                document.getElementById('task-priority').value = 'Normal';
            }

            modal.style.display = 'flex';
        }

        function closeTaskModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('task-modal').style.display = 'none';
            currentEditingTaskId = null;
        }

        function populateTaskProspectDropdown() {
            const select = document.getElementById('task-prospect');
            select.innerHTML = '<option value="">Aucun prospect</option>';
            prospects.forEach(p => {
                select.innerHTML += `<option value="${p.id}">${p.company}</option>`;
            });
        }

        async function saveTask(event) {
            event.preventDefault();

            const taskId = document.getElementById('task-edit-id').value;
            const title = document.getElementById('task-title').value.trim();
            const project = document.getElementById('task-project').value;
            const priority = document.getElementById('task-priority').value;
            const assignee = document.getElementById('task-assignee').value;
            const dueDate = document.getElementById('task-due-date').value;
            const status = document.getElementById('task-status').value;
            const hours = document.getElementById('task-estimated-time').value;
            const prospectId = document.getElementById('task-prospect').value;
            const description = document.getElementById('task-description').value.trim();

            if (!title) {
                showToast('Le titre est obligatoire');
                return;
            }

            // Build full title with project prefix
            const fullTitle = project ? `[${project}] ${title}` : title;

            // Map status and priority to Supabase format
            const statusMap = {
                'À faire': 'todo',
                'En cours': 'in_progress',
                'Bloqué': 'blocked',
                'Terminé': 'done'
            };
            const priorityMap = {
                'Urgent': 'urgent',
                'Normal': 'medium',
                'Faible': 'low'
            };

            const taskData = {
                titre: fullTitle,
                description: description,
                status: statusMap[status] || 'todo',
                priorite: priorityMap[priority] || 'medium',
                due_date: dueDate || null,
                temps_estime: hours ? parseFloat(hours) : null,
                prospect_id: prospectId || null,
                assigned_to: assignee || null
            };

            try {
                if (taskId) {
                    // Update existing task
                    await supabase.updateTask(taskId, taskData);
                    showToast('Tache mise a jour!');
                } else {
                    // Create new task
                    await supabase.createTask(taskData);
                    showToast('Tache creee!');
                }

                closeTaskModal();
                await loadDataFromSupabase();
                renderTasks();
                setupTaskDragAndDrop();

            } catch (err) {
                console.error('Erreur save task:', err);
                showToast('Erreur lors de la sauvegarde');
            }
        }

        async function deleteCurrentTask() {
            if (!currentEditingTaskId) return;

            if (!confirm('Supprimer cette tache ?')) return;

            try {
                await supabase.deleteTask(currentEditingTaskId);
                showToast('Tache supprimee');
                closeTaskModal();
                await loadDataFromSupabase();
                renderTasks();
                setupTaskDragAndDrop();
            } catch (err) {
                console.error('Erreur delete task:', err);
                showToast('Erreur suppression');
            }
        }

        // Task Comments
        function renderTaskComments(taskId) {
            const list = document.getElementById('task-comments-list');
            const comments = taskComments[taskId] || [];

            if (comments.length === 0) {
                list.innerHTML = '<p style="font-size: 0.75rem; color: var(--text-dim); padding: 0.5rem;">Aucun commentaire</p>';
                return;
            }

            list.innerHTML = comments.map(c => `
                <div style="padding: 0.5rem; background: var(--bg); border-radius: 6px; margin-bottom: 0.375rem; font-size: 0.8125rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                        <span style="font-weight: 500; color: var(--accent);">${c.author || 'Jordy'}</span>
                        <span style="font-size: 0.6875rem; color: var(--text-dim);">${new Date(c.date).toLocaleDateString('fr-FR')}</span>
                    </div>
                    <div style="color: var(--text-muted);">${c.text}</div>
                </div>
            `).join('');
        }

        function addTaskComment() {
            const input = document.getElementById('task-new-comment');
            const text = input.value.trim();
            if (!text || !currentEditingTaskId) return;

            if (!taskComments[currentEditingTaskId]) {
                taskComments[currentEditingTaskId] = [];
            }

            taskComments[currentEditingTaskId].push({
                text,
                date: new Date().toISOString(),
                author: 'Jordy' // Could be dynamic based on logged in user
            });

            localStorage.setItem('pk_task_comments', JSON.stringify(taskComments));
            renderTaskComments(currentEditingTaskId);
            addTaskHistoryEntry(currentEditingTaskId, 'comment', `Commentaire ajoute: "${text.substring(0, 30)}..."`);
            input.value = '';
        }

        // Task History
        function renderTaskHistory(taskId) {
            const list = document.getElementById('task-history-list');
            const history = taskHistory[taskId] || [];

            if (history.length === 0) {
                list.innerHTML = '<p style="color: var(--text-dim); padding: 0.25rem;">Aucun historique</p>';
                return;
            }

            list.innerHTML = history.slice(-10).reverse().map(h => `
                <div style="padding: 0.25rem 0; border-bottom: 1px solid var(--border);">
                    <span style="color: var(--text-muted);">${new Date(h.date).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' })}</span>
                    <span style="margin-left: 0.5rem;">${h.details}</span>
                </div>
            `).join('');
        }

        function addTaskHistoryEntry(taskId, action, details) {
            if (!taskHistory[taskId]) {
                taskHistory[taskId] = [];
            }

            taskHistory[taskId].push({
                action,
                details,
                date: new Date().toISOString()
            });

            localStorage.setItem('pk_task_history', JSON.stringify(taskHistory));
        }

        // Drag and Drop for Tasks
        function setupTaskDragAndDrop() {
            const cards = document.querySelectorAll('.task-card');
            const dropZones = document.querySelectorAll('#task-kanban .pipeline-column');

            cards.forEach(card => {
                card.addEventListener('dragstart', handleTaskDragStart);
                card.addEventListener('dragend', handleTaskDragEnd);
            });

            dropZones.forEach(col => {
                col.addEventListener('dragover', handleTaskDragOver);
                col.addEventListener('dragleave', handleTaskDragLeave);
                col.addEventListener('drop', handleTaskDrop);
            });
        }

        let draggedTaskId = null;

        function handleTaskDragStart(e) {
            draggedTaskId = e.target.dataset.taskId;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleTaskDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('#task-kanban .pipeline-column').forEach(col => col.classList.remove('drag-over'));
        }

        function handleTaskDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleTaskDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleTaskDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');

            if (!draggedTaskId) return;

            const column = e.currentTarget.closest('.pipeline-column') || e.currentTarget;
            const newStatus = column.dataset.status;
            if (!newStatus) { draggedTaskId = null; return; }

            const taskId = draggedTaskId;
            draggedTaskId = null;

            // 1. DOM move instantane — deplacer la card directement
            const card = document.querySelector(`.task-card[data-task-id="${taskId}"]`);
            const targetCards = column.querySelector('.pipeline-cards');
            if (card && targetCards) {
                targetCards.appendChild(card);
            }

            // 2. Update data local
            const task = airtableTasks.find(t => t.id === taskId);
            if (!task) return;
            const oldStatus = task.status;
            task.status = newStatus;

            // 3. Update compteurs sans re-render
            updateTaskKanbanCounts();
            addTaskHistoryEntry(taskId, 'status_change', `Statut change vers: ${newStatus}`);

            // 4. Sync Supabase fire-and-forget
            const statusMap = { 'À faire': 'todo', 'En cours': 'in_progress', 'Bloqué': 'blocked', 'Terminé': 'done' };
            supabase.updateTaskStatus(taskId, statusMap[newStatus] || 'todo').catch(err => {
                console.error('[Task D&D] Rollback:', err);
                task.status = oldStatus;
                renderTasks();
                setupTaskDragAndDrop();
                showToast('Erreur: statut non sauvegarde', 'error');
            });
        }

        function updateTaskKanbanCounts() {
            const filtered = getFilteredTasks();
            const now = new Date();
            const done = filtered.filter(t => t.status === 'Terminé').length;
            const total = filtered.length;
            const overdue = filtered.filter(t => t.dueDate && new Date(t.dueDate) < now && t.status !== 'Terminé').length;

            document.getElementById('kanban-todo-count').textContent = filtered.filter(t => t.status === 'À faire').length;
            document.getElementById('kanban-progress-count').textContent = filtered.filter(t => t.status === 'En cours').length;
            document.getElementById('kanban-blocked-count').textContent = filtered.filter(t => t.status === 'Bloqué').length;
            document.getElementById('kanban-done-count').textContent = done;

            document.getElementById('task-urgent-count').textContent = filtered.filter(t => t.priority === 'Urgent').length;
            document.getElementById('task-pending-count').textContent = filtered.filter(t => t.status === 'À faire').length;
            document.getElementById('task-progress-count').textContent = filtered.filter(t => t.status === 'En cours').length;
            document.getElementById('task-done-count').textContent = done;

            const pct = total > 0 ? Math.round((done / total) * 100) : 0;
            const progressFill = document.getElementById('task-progress-fill');
            const progressLabel = document.getElementById('task-progress-label');
            const progressDetail = document.getElementById('task-progress-detail');
            const overdueBadge = document.getElementById('task-overdue-badge');
            if (progressLabel) progressLabel.textContent = `${pct}% termine`;
            if (progressFill) progressFill.style.width = `${pct}%`;
            if (progressDetail) progressDetail.textContent = `${done}/${total}`;
            if (overdueBadge) {
                overdueBadge.style.display = overdue > 0 ? '' : 'none';
                overdueBadge.textContent = overdue > 0 ? `${overdue} en retard` : '';
            }
        }

        async function updateTaskStatus(taskId, newStatus) {
            const task = airtableTasks.find(t => t.id === taskId);
            if (!task) return;
            const oldStatus = task.status;
            task.status = newStatus;
            renderTasks();
            setupTaskDragAndDrop();

            const statusMap = { 'À faire': 'todo', 'En cours': 'in_progress', 'Bloqué': 'blocked', 'Terminé': 'done' };
            try {
                await supabase.updateTaskStatus(taskId, statusMap[newStatus] || 'todo');
            } catch (err) {
                console.error('Erreur update task:', err);
                task.status = oldStatus;
                renderTasks();
                setupTaskDragAndDrop();
                showToast('Erreur sauvegarde', 'error');
            }
        }

        // Créer une tâche avec tous les détails (utilisé par MANA)
        async function createTaskInAirtableWithDetails(taskData) {
            try {
                // Build title with project prefix if provided
                let title = taskData.title;
                if (taskData.project && !title.startsWith('[')) {
                    title = `[${taskData.project}] ${title}`;
                }

                // Map priority values
                const priorityMap = {
                    'urgent': 'urgent',
                    'normal': 'medium',
                    'faible': 'low',
                    'low': 'low',
                    'high': 'high'
                };

                const newTask = {
                    titre: title,
                    description: taskData.description || '',
                    status: 'todo',
                    priorite: priorityMap[taskData.priority?.toLowerCase()] || 'medium',
                    due_date: taskData.dueDate || null,
                    prospect_id: taskData.prospectId || null,
                    assigned_to: taskData.assignedTo || currentUser?.id || null
                };

                console.log('[Tasks] Creating task in Supabase:', newTask);

                const result = await supabase.createTask(newTask);
                console.log('[Tasks] Task created successfully:', result);
                showToast('Tâche créée!');

                // Reload tasks
                await loadDataFromSupabase();
                renderTasks();
                setupTaskDragAndDrop();

            } catch (err) {
                console.error('[Tasks] Erreur creation task:', err);
                showToast('Erreur création tâche');
            }
        }

        // Supprimer une tâche
        async function deleteTaskInAirtable(taskId) {
            try {
                await supabase.deleteTask(taskId);
                console.log('[Tasks] Task deleted successfully');
                showToast('Tâche supprimée');

                // Reload tasks
                await loadDataFromSupabase();
                renderTasks();
                setupTaskDragAndDrop();
            } catch (err) {
                console.error('[Tasks] Erreur delete task:', err);
                showToast('Erreur suppression tâche');
            }
        }

        function toggleTask(id) {
            const t = tasks.find(i => i.id === id);
            if (t) { t.done = !t.done; save(); renderTasks(); }
        }

        function deleteTask(id) {
            tasks = tasks.filter(t => t.id !== id);
            save();
            renderTasks();
        }

        // Helpers
        function initials(name) { return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2); }

        function statusLabel(s) {
            return { lead: 'Lead', contacted: 'Contacte', meeting: 'RDV', proposal: 'Proposition', won: 'Gagne', lost: 'Perdu' }[s] || s;
        }

        function getAvatarColor(s) {
            return { lead: 'blue', contacted: 'orange', meeting: 'purple', proposal: 'orange', won: 'green' }[s] || 'blue';
        }

        function priorityLabel(p) {
            return { hot: '🔥 Hot', chaud: 'Chaud', tiede: 'Tiede', froid: 'Froid' }[p] || p;
        }

        function renderAssetIcons(assets, small) {
            if (!assets || !assets.length) return '';
            const icons = {
                site: { icon: '🌐', title: 'Demo Site', cls: 'site' },
                dash: { icon: '📊', title: 'Dashboard', cls: 'dashboard' },
                wf: { icon: '⚡', title: 'Workflow n8n', cls: 'workflow' },
                doc: { icon: '📄', title: 'Proposition', cls: 'doc' }
            };
            const html = assets.map(a => {
                const i = icons[a];
                return i ? `<span class="asset-icon ${i.cls}" data-tooltip="${i.title}">${i.icon}</span>` : '';
            }).join('');
            return `<span class="asset-icons">${html}</span>`;
        }

        function fmtXPF(v) {
            if (!v) return '-';
            if (v >= 1000000) return (v / 1000000).toFixed(1) + 'M';
            if (v >= 1000) return (v / 1000).toFixed(0) + 'K';
            return v + '';
        }

        function fmtDate(d) {
            if (!d) return '-';
            return new Date(d).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
        }

        // ============================================
        // PROSPECTS VIEW SYSTEM
        // ============================================

        function setupProspectsView() {
            // View toggle buttons
            document.querySelectorAll('.view-toggle-btn[data-pview]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentProspectsView = btn.dataset.pview;
                    showProspectsView(currentProspectsView);
                });
            });

            // Build sector and status dropdowns
            buildFilterDropdowns();
        }

        function showProspectsView(viewName) {
            document.querySelectorAll('.prospects-view-container').forEach(v => v.classList.remove('active'));
            document.getElementById('pview-' + viewName)?.classList.add('active');
            renderProspectsViews();
        }

        function buildFilterDropdowns() {
            // Sectors
            const sectors = [...new Set(prospects.map(p => p.sector))].sort();
            const sectorDropdown = document.getElementById('sector-dropdown');
            sectorDropdown.innerHTML = `
                <div class="dropdown-item ${currentSectorFilter === 'all' ? 'active' : ''}" onclick="setSectorFilter('all')">Tous secteurs</div>
                <div class="dropdown-divider"></div>
                ${sectors.map(s => `<div class="dropdown-item ${currentSectorFilter === s ? 'active' : ''}" onclick="setSectorFilter('${s}')">${s}</div>`).join('')}
            `;

            // Statuses
            const statuses = [
                { key: 'all', label: 'Tous status' },
                { key: 'lead', label: 'Lead' },
                { key: 'contacted', label: 'Contacte' },
                { key: 'meeting', label: 'RDV/Audit' },
                { key: 'proposal', label: 'Proposition' },
                { key: 'won', label: 'Gagne' },
                { key: 'lost', label: 'Perdu' }
            ];
            const statusDropdown = document.getElementById('status-dropdown');
            statusDropdown.innerHTML = statuses.map(s => `
                <div class="dropdown-item ${currentStatusFilter === s.key ? 'active' : ''}" onclick="setStatusFilter('${s.key}')">${s.label}</div>
            `).join('');

            // Assignees
            const assigneeDropdown = document.getElementById('assignee-dropdown');
            if (assigneeDropdown) {
                assigneeDropdown.innerHTML = `
                    <div class="dropdown-item ${currentAssigneeFilter === 'all' ? 'active' : ''}" onclick="setAssigneeFilter('all')">Tous assignes</div>
                    <div class="dropdown-divider"></div>
                    ${teamMembers.map(m => `
                        <div class="dropdown-item ${currentAssigneeFilter === m.id ? 'active' : ''}" onclick="setAssigneeFilter('${m.id}')">
                            <span style="display:inline-block;width:18px;height:18px;border-radius:50%;background:${m.avatar_color};color:white;font-size:0.6rem;text-align:center;line-height:18px;margin-right:6px;">${m.display_name.charAt(0)}</span>
                            ${m.display_name}
                        </div>
                    `).join('')}
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item ${currentAssigneeFilter === 'unassigned' ? 'active' : ''}" onclick="setAssigneeFilter('unassigned')">Non assigne</div>
                `;
            }
        }

        function setupDropdowns() {
            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.dropdown')) {
                    document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show'));
                }
            });
        }

        function toggleDropdown(id) {
            const menu = document.getElementById(id);
            const isOpen = menu.classList.contains('show');
            document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show'));
            if (!isOpen) menu.classList.add('show');
        }

        function setSectorFilter(sector) {
            currentSectorFilter = sector;
            document.getElementById('sector-filter-label').textContent = sector === 'all' ? 'Tous secteurs' : sector;
            buildFilterDropdowns();
            renderProspectsViews();
            toggleDropdown('sector-dropdown');
        }

        function setStatusFilter(status) {
            currentStatusFilter = status;
            document.getElementById('status-filter-label').textContent = status === 'all' ? 'Tous status' : statusLabel(status);
            buildFilterDropdowns();
            renderProspectsViews();
            toggleDropdown('status-dropdown');
        }

        function setSortBy(sort) {
            currentSort = sort;
            document.querySelectorAll('#sort-dropdown .dropdown-item').forEach(item => {
                item.classList.toggle('active', item.dataset.sort === sort);
            });
            const labels = {
                'priority': 'Priorite',
                'value-desc': 'Valeur ↓',
                'value-asc': 'Valeur ↑',
                'company': 'Entreprise',
                'sector': 'Secteur',
                'status': 'Status',
                'assignee': 'Assigne',
                'date-desc': 'Date ↓',
                'date-asc': 'Date ↑',
                'score': 'Score IA',
                'assets': 'Avec assets'
            };
            document.getElementById('sort-label').textContent = labels[sort] || 'Trier par';
            renderProspectsViews();
            toggleDropdown('sort-dropdown');
        }

        function setTempFilter(temp) {
            currentTempFilter = temp;
            document.querySelectorAll('.temp-chip').forEach(chip => {
                chip.classList.toggle('active', chip.dataset.temp === temp);
            });
            renderProspectsViews();
        }

        function toggleAssetsFilter() {
            assetsFilterActive = !assetsFilterActive;
            document.getElementById('assets-filter-toggle').classList.toggle('active', assetsFilterActive);
            renderProspectsViews();
        }

        function setAssigneeFilter(assigneeId) {
            currentAssigneeFilter = assigneeId;
            const label = assigneeId === 'all' ? 'Tous assignes' :
                          assigneeId === 'unassigned' ? 'Non assigne' :
                          getMemberName(assigneeId);
            document.getElementById('assignee-filter-label').textContent = label;
            buildFilterDropdowns();
            renderProspectsViews();
            toggleDropdown('assignee-dropdown');
        }

        async function assignProspectFromModal(memberId) {
            if (!currentProspectId) return;
            const prospect = prospects.find(p => p.id === currentProspectId);
            if (!prospect) return;

            const newValue = memberId || null;
            const oldValue = prospect.assignedTo;
            if (newValue === oldValue) return;

            prospect.assignedTo = newValue;
            const id = prospect.supabaseId || prospect.id;
            try {
                await supabase.updateProspect(id, { assigned_to: newValue });
                const name = newValue ? getMemberName(newValue) : 'personne';
                showToast(`${prospect.company} assigne a ${name}`);
                renderProspectsViews();
            } catch (err) {
                console.error('[Assign] Error:', err);
                prospect.assignedTo = oldValue;
                showToast('Erreur assignation');
            }
        }

        function toggleMyProspects() {
            const btn = document.getElementById('my-prospects-btn');
            if (!currentUser) return;
            const myId = currentUser.id;
            if (currentAssigneeFilter === myId) {
                setAssigneeFilter('all');
                btn.style.background = '';
                btn.style.color = '';
            } else {
                setAssigneeFilter(myId);
                btn.style.background = 'var(--accent)';
                btn.style.color = 'white';
            }
        }

        function toggleMyTasks() {
            const btn = document.getElementById('my-tasks-btn');
            const select = document.getElementById('task-assignee-filter');
            if (!currentUser) return;
            const myName = getMemberName(currentUser.id);
            if (currentTaskAssigneeFilter === myName) {
                currentTaskAssigneeFilter = 'all';
                if (select) select.value = 'all';
                btn.style.background = '';
                btn.style.color = '';
            } else {
                currentTaskAssigneeFilter = myName;
                if (select) select.value = myName;
                btn.style.background = 'var(--accent)';
                btn.style.color = 'white';
            }
            renderTasks();
        }

        // Context menu for prospect cards (right-click to assign)
        let contextMenuTarget = null;

        function showProspectContextMenu(event, prospectId) {
            event.preventDefault();
            event.stopPropagation();
            contextMenuTarget = prospectId;

            let menu = document.getElementById('prospect-context-menu');
            if (!menu) {
                menu = document.createElement('div');
                menu.id = 'prospect-context-menu';
                menu.style.cssText = 'position:fixed;z-index:9999;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.3);min-width:180px;padding:4px;display:none;';
                document.body.appendChild(menu);
            }

            const prospect = prospects.find(p => p.id === prospectId);
            if (!prospect) return;

            menu.innerHTML = `
                <div style="padding:6px 10px;font-size:0.7rem;color:var(--text-dim);font-weight:600;border-bottom:1px solid var(--border);margin-bottom:2px;">${prospect.company}</div>
                <div style="padding:4px 10px;font-size:0.7rem;color:var(--text-muted);">Assigner a:</div>
                ${teamMembers.map(m => `
                    <div style="padding:6px 10px;cursor:pointer;font-size:0.8rem;border-radius:4px;display:flex;align-items:center;gap:8px;${prospect.assignedTo === m.id ? 'background:var(--bg-muted);' : ''}"
                         onmouseover="this.style.background='var(--bg-muted)'" onmouseout="this.style.background='${prospect.assignedTo === m.id ? 'var(--bg-muted)' : ''}'"
                         onclick="quickAssignProspect('${prospectId}', '${m.id}')">
                        <span style="width:18px;height:18px;border-radius:50%;background:${m.avatar_color};color:white;font-size:0.55rem;display:flex;align-items:center;justify-content:center;font-weight:600;">${m.display_name.charAt(0)}</span>
                        ${m.display_name} ${prospect.assignedTo === m.id ? '✓' : ''}
                    </div>
                `).join('')}
                <div style="border-top:1px solid var(--border);margin-top:2px;padding:6px 10px;cursor:pointer;font-size:0.8rem;border-radius:4px;color:var(--text-muted);"
                     onmouseover="this.style.background='var(--bg-muted)'" onmouseout="this.style.background=''"
                     onclick="quickAssignProspect('${prospectId}', null)">
                    Retirer assignation
                </div>
            `;

            menu.style.left = Math.min(event.clientX, window.innerWidth - 200) + 'px';
            menu.style.top = Math.min(event.clientY, window.innerHeight - 250) + 'px';
            menu.style.display = 'block';

            // Close on click outside
            setTimeout(() => {
                document.addEventListener('click', closeContextMenu, { once: true });
            }, 10);
        }

        function closeContextMenu() {
            const menu = document.getElementById('prospect-context-menu');
            if (menu) menu.style.display = 'none';
        }

        async function quickAssignProspect(prospectId, memberId) {
            closeContextMenu();
            const prospect = prospects.find(p => p.id === prospectId);
            if (!prospect) return;
            prospect.assignedTo = memberId;
            renderProspectsViews();
            const id = prospect.supabaseId || prospect.id;
            try {
                await supabase.updateProspect(id, { assigned_to: memberId });
                const name = memberId ? getMemberName(memberId) : 'personne';
                showToast(`${prospect.company} assigne a ${name}`);
            } catch (err) {
                console.error('[Assign] Quick assign error:', err);
                showToast('Erreur assignation');
            }
        }

        function clearAllFilters() {
            searchQuery = '';
            currentSectorFilter = 'all';
            currentStatusFilter = 'all';
            currentDateFilter = 'all';
            currentTempFilter = 'all';
            currentAssigneeFilter = 'all';
            assetsFilterActive = false;
            currentSort = 'priority';
            document.getElementById('search-prospects').value = '';
            document.getElementById('sector-filter-label').textContent = 'Tous secteurs';
            document.getElementById('status-filter-label').textContent = 'Tous status';
            document.getElementById('date-filter-label').textContent = 'Toutes dates';
            document.getElementById('assignee-filter-label').textContent = 'Tous assignes';
            document.getElementById('sort-label').textContent = 'Priorite';
            document.getElementById('assets-filter-toggle').classList.remove('active');
            document.querySelectorAll('.temp-chip').forEach(chip => {
                chip.classList.toggle('active', chip.dataset.temp === 'all');
            });
            buildFilterDropdowns();
            renderProspectsViews();
        }

        function renderActiveFilters() {
            let container = document.getElementById('active-filters-bar');
            if (!container) {
                container = document.createElement('div');
                container.id = 'active-filters-bar';
                container.className = 'active-filters';
                const toolbar = document.querySelector('#view-prospects .toolbar');
                toolbar.insertAdjacentElement('afterend', container);
            }
            const tags = [];
            if (searchQuery) tags.push({ label: `Recherche: "${searchQuery}"`, clear: () => { searchQuery = ''; document.getElementById('search-prospects').value = ''; renderProspectsViews(); } });
            if (currentSectorFilter !== 'all') tags.push({ label: `Secteur: ${currentSectorFilter}`, clear: () => setSectorFilter('all') });
            if (currentStatusFilter !== 'all') tags.push({ label: `Status: ${statusLabel(currentStatusFilter)}`, clear: () => setStatusFilter('all') });
            if (currentTempFilter !== 'all') tags.push({ label: `Temp: ${currentTempFilter}`, clear: () => setTempFilter('all') });
            if (assetsFilterActive) tags.push({ label: 'Avec assets', clear: () => toggleAssetsFilter() });
            if (currentAssigneeFilter !== 'all') tags.push({ label: `Assigne: ${currentAssigneeFilter === 'unassigned' ? 'Non assigne' : getMemberName(currentAssigneeFilter)}`, clear: () => setAssigneeFilter('all') });
            if (currentDateFilter !== 'all') tags.push({ label: `Date: ${currentDateFilter}`, clear: () => setDateFilter('all') });

            if (tags.length === 0) { container.innerHTML = ''; return; }

            container.innerHTML = tags.map((t, i) =>
                `<span class="filter-tag">${t.label} <span class="filter-tag-close" onclick="activeFilterClearFns[${i}]()">&times;</span></span>`
            ).join('') + `<button class="clear-filters" onclick="clearAllFilters()">Tout effacer</button>`;

            window.activeFilterClearFns = tags.map(t => t.clear);
        }

        function setDateFilter(dateFilter) {
            currentDateFilter = dateFilter;
            document.querySelectorAll('#date-dropdown .dropdown-item').forEach(item => {
                item.classList.toggle('active', item.dataset.date === dateFilter);
            });
            const labels = {
                'all': 'Toutes dates',
                'today': "Aujourd'hui",
                'week': 'Cette semaine',
                'month': 'Ce mois',
                'quarter': 'Ce trimestre'
            };
            document.getElementById('date-filter-label').textContent = labels[dateFilter] || 'Toutes dates';
            renderProspectsViews();
            toggleDropdown('date-dropdown');
        }

        function filterProspects() {
            searchQuery = document.getElementById('search-prospects').value.toLowerCase();
            renderProspectsViews();
        }

        // ============================================
        // EXPORT CSV
        // ============================================

        function exportProspectsCSV() {
            const filtered = getFilteredProspects();

            if (filtered.length === 0) {
                showToast('Aucun prospect a exporter');
                return;
            }

            // CSV Header
            const headers = ['Entreprise', 'Contact', 'Email', 'Telephone', 'Poste', 'Secteur', 'Status', 'Priorite', 'Valeur XPF', 'Date', 'Assigne a'];

            // CSV Rows
            const rows = filtered.map(p => [
                p.company || '',
                p.contact || p.name || '',
                p.email || '',
                p.phone || '',
                p.poste || '',
                p.sector || '',
                statusLabel(p.status) || '',
                priorityLabel(p.priority) || '',
                p.value || 0,
                p.date || '',
                p.assignedTo ? getMemberName(p.assignedTo) : ''
            ]);

            // Build CSV content
            const csvContent = [
                headers.join(';'),
                ...rows.map(row => row.map(cell => {
                    // Escape quotes and wrap in quotes if contains separator
                    const str = String(cell).replace(/"/g, '""');
                    return str.includes(';') || str.includes('"') || str.includes('\n') ? `"${str}"` : str;
                }).join(';'))
            ].join('\n');

            // Add BOM for Excel UTF-8 compatibility
            const BOM = '\uFEFF';

            // Create and download file
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;

            const date = new Date().toISOString().split('T')[0];
            link.download = `pacifikai-prospects-${date}.csv`;

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showToast(`${filtered.length} prospects exportes en CSV`);
        }

        function getFilteredProspects() {
            let filtered = [...prospects];

            // Search filter
            if (searchQuery) {
                filtered = filtered.filter(p =>
                    p.company.toLowerCase().includes(searchQuery) ||
                    (p.name && p.name.toLowerCase().includes(searchQuery)) ||
                    p.sector.toLowerCase().includes(searchQuery)
                );
            }

            // Sector filter
            if (currentSectorFilter !== 'all') {
                filtered = filtered.filter(p => p.sector === currentSectorFilter);
            }

            // Status filter
            if (currentStatusFilter !== 'all') {
                filtered = filtered.filter(p => p.status === currentStatusFilter);
            }

            // Date filter
            if (currentDateFilter !== 'all') {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

                filtered = filtered.filter(p => {
                    if (!p.date) return false;
                    const prospectDate = new Date(p.date);

                    switch (currentDateFilter) {
                        case 'today':
                            return prospectDate >= today;
                        case 'week':
                            const weekAgo = new Date(today);
                            weekAgo.setDate(weekAgo.getDate() - 7);
                            return prospectDate >= weekAgo;
                        case 'month':
                            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                            return prospectDate >= monthStart;
                        case 'quarter':
                            const quarterStart = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1);
                            return prospectDate >= quarterStart;
                        default:
                            return true;
                    }
                });
            }

            // Temperature filter
            if (currentTempFilter !== 'all') {
                filtered = filtered.filter(p => p.priority === currentTempFilter);
            }

            // Assets filter
            if (assetsFilterActive) {
                filtered = filtered.filter(p => {
                    const assets = getProspectAssets(p.company);
                    return assets && assets.files && assets.files.length > 0;
                });
            }

            // Assignee filter
            if (currentAssigneeFilter !== 'all') {
                if (currentAssigneeFilter === 'unassigned') {
                    filtered = filtered.filter(p => !p.assignedTo);
                } else {
                    filtered = filtered.filter(p => p.assignedTo === currentAssigneeFilter);
                }
            }

            // Sort
            const priorityOrder = { hot: 0, chaud: 1, tiede: 2, froid: 3 };
            const statusOrder = { lead: 0, contacted: 1, meeting: 2, proposal: 3, won: 4, lost: 5 };

            switch (currentSort) {
                case 'priority':
                    filtered.sort((a, b) => (priorityOrder[a.priority] || 99) - (priorityOrder[b.priority] || 99));
                    break;
                case 'value-desc':
                    filtered.sort((a, b) => (b.value || 0) - (a.value || 0));
                    break;
                case 'value-asc':
                    filtered.sort((a, b) => (a.value || 0) - (b.value || 0));
                    break;
                case 'company':
                    filtered.sort((a, b) => a.company.localeCompare(b.company));
                    break;
                case 'sector':
                    filtered.sort((a, b) => a.sector.localeCompare(b.sector));
                    break;
                case 'status':
                    filtered.sort((a, b) => (statusOrder[a.status] || 99) - (statusOrder[b.status] || 99));
                    break;
                case 'date-desc':
                    filtered.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
                    break;
                case 'date-asc':
                    filtered.sort((a, b) => new Date(a.date || 0) - new Date(b.date || 0));
                    break;
                case 'score':
                    filtered.sort((a, b) => (b.score || 0) - (a.score || 0));
                    break;
                case 'assignee':
                    filtered.sort((a, b) => {
                        const nameA = a.assignedTo ? getMemberName(a.assignedTo) : 'ZZZ';
                        const nameB = b.assignedTo ? getMemberName(b.assignedTo) : 'ZZZ';
                        return nameA.localeCompare(nameB);
                    });
                    break;
                case 'assets':
                    filtered.sort((a, b) => {
                        const aAssets = getProspectAssets(a.company);
                        const bAssets = getProspectAssets(b.company);
                        return ((bAssets?.files?.length || 0) - (aAssets?.files?.length || 0));
                    });
                    break;
            }

            return filtered;
        }

        function renderProspectsViews() {
            renderSummaryCards();
            renderKanbanTemp();
            renderProspectsTable(currentStatusFilter === 'all' ? 'all' : currentStatusFilter);
            renderGridView();
            renderCompactView();
            renderPipelineStatus();
            renderActiveFilters();
            document.getElementById('prospects-count-header').textContent = getFilteredProspects().length;
        }

        function renderSummaryCards() {
            const temps = ['hot', 'chaud', 'tiede', 'froid'];
            temps.forEach(temp => {
                const items = prospects.filter(p => p.priority === temp);
                const total = items.reduce((s, p) => s + (p.value || 0), 0);
                document.getElementById('sum-' + temp).textContent = items.length;
                document.getElementById('sum-' + temp + '-val').textContent = fmtXPF(total);
            });
        }

        // ============================================
        // GRID VIEW (Cards)
        // ============================================

        function renderGridView() {
            const board = document.getElementById('grid-board');
            if (!board) return;
            const filtered = getFilteredProspects();

            if (filtered.length === 0) {
                board.innerHTML = '<div style="text-align:center;padding:3rem;color:var(--text-dim);">Aucun prospect ne correspond aux filtres</div>';
                return;
            }

            board.innerHTML = filtered.map(p => {
                const assets = getProspectAssets(p.company);
                const hasAssets = assets && assets.files && assets.files.length > 0;
                const initials = (p.company || '').split(' ').slice(0, 2).map(w => w[0]).join('').toUpperCase();
                const assetIcons = hasAssets ? `<div class="grid-card-assets">
                    ${assets.files.slice(0, 4).map(f => `<span>${f.type}</span>`).join('')}
                    ${assets.files.length > 4 ? `<span>+${assets.files.length - 4}</span>` : ''}
                </div>` : '';

                return `<div class="grid-card ${p.priority || 'froid'} ${hasAssets ? 'has-assets' : ''}" onclick="showProspectModal('${p.id}')" oncontextmenu="showProspectContextMenu(event, '${p.id}')">
                    <div class="grid-card-header">
                        <div class="grid-card-company">${p.company}</div>
                        <span class="grid-card-badge ${p.priority || 'froid'}">${priorityLabel(p.priority)}</span>
                        <button class="prospect-menu-btn" onclick="event.stopPropagation(); showContextMenu(event, '${p.id}')" title="Actions">⋮</button>
                    </div>
                    <div class="grid-card-info">
                        ${p.contact || p.name ? `<div class="grid-card-row"><span>Contact</span><strong>${p.contact || p.name}</strong></div>` : ''}
                        <div class="grid-card-row"><span>Secteur</span><strong>${p.sector || '-'}</strong></div>
                        <div class="grid-card-row"><span>Status</span><strong>${statusLabel(p.status)}</strong></div>
                        ${p.score ? `<div class="grid-card-row"><span>Score IA</span><strong>${p.score}/100</strong></div>` : ''}
                    </div>
                    ${assetIcons}
                    <div class="grid-card-footer">
                        <span class="grid-card-value">${fmtXPF(p.value)}</span>
                        ${renderAssigneeBadge(p.assignedTo, 20)}
                        <span class="grid-card-status">${statusLabel(p.status)}</span>
                    </div>
                </div>`;
            }).join('');
        }

        // ============================================
        // COMPACT VIEW (One-liner rows)
        // ============================================

        function renderCompactView() {
            const list = document.getElementById('compact-list');
            if (!list) return;
            const filtered = getFilteredProspects();

            const header = `<div class="compact-header">
                <span></span>
                <span>Entreprise</span>
                <span>Secteur</span>
                <span>Status</span>
                <span>Valeur</span>
                <span>Temp.</span>
                <span>Assigne</span>
                <span>Assets</span>
            </div>`;

            if (filtered.length === 0) {
                list.innerHTML = header + '<div style="text-align:center;padding:2rem;color:var(--text-dim);">Aucun resultat</div>';
                return;
            }

            const avatarColors = ['#8b5cf6', '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#ec4899'];
            list.innerHTML = header + filtered.map((p, i) => {
                const initials = (p.company || '').split(' ').slice(0, 2).map(w => w[0]).join('').toUpperCase();
                const color = avatarColors[i % avatarColors.length];
                const assets = getProspectAssets(p.company);
                const hasAssets = assets && assets.files && assets.files.length > 0;

                return `<div class="compact-row" onclick="showProspectModal('${p.id}')" oncontextmenu="showProspectContextMenu(event, '${p.id}')">
                    <div class="avatar" style="background:${color}">${initials}</div>
                    <div class="compact-company">${p.company}</div>
                    <div class="compact-sector">${p.sector || '-'}</div>
                    <div class="compact-status">${statusLabel(p.status)}</div>
                    <div class="compact-value">${fmtXPF(p.value)}</div>
                    <div class="compact-temp ${p.priority || 'froid'}">${priorityLabel(p.priority)}</div>
                    <div class="compact-assignee">${renderAssigneeBadge(p.assignedTo, 18)}</div>
                    <div class="compact-assets-icon">${hasAssets ? `${assets.files.length}` : '-'}</div>
                    <button class="prospect-menu-btn" onclick="event.stopPropagation(); showContextMenu(event, '${p.id}')" title="Actions">⋮</button>
                </div>`;
            }).join('');
        }

        // ============================================
        // KANBAN TEMPERATURE (with Drag & Drop)
        // ============================================

        function renderKanbanTemp() {
            const temps = [
                { key: 'hot', label: '🔥 Hot', emoji: '🔥' },
                { key: 'chaud', label: '🌡️ Chaud', emoji: '🌡️' },
                { key: 'tiede', label: '😐 Tiede', emoji: '😐' },
                { key: 'froid', label: '❄️ Froid', emoji: '❄️' }
            ];

            const filtered = getFilteredProspects();
            const board = document.getElementById('kanban-temp-board');

            board.innerHTML = temps.map(t => {
                const items = filtered.filter(p => p.priority === t.key);
                const total = items.reduce((s, p) => s + (p.value || 0), 0);
                return `
                    <div class="kanban-col" data-priority="${t.key}"
                         ondragover="handleDragOver(event)"
                         ondragleave="handleDragLeave(event)"
                         ondrop="handleDrop(event, '${t.key}')">
                        <div class="kanban-header ${t.key}">
                            <span class="kanban-title ${t.key}">${t.label}</span>
                            <div class="kanban-stats">
                                <span>${items.length}</span>
                                <span>•</span>
                                <span>${fmtXPF(total)}</span>
                            </div>
                        </div>
                        <div class="kanban-cards">
                            ${items.map(p => renderKanbanCard(p)).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderKanbanCard(p) {
            const hasAssets = p.assets && p.assets.length > 0;
            return `
                <div class="kanban-card ${hasAssets ? 'has-assets' : ''}"
                     draggable="true"
                     data-id="${p.id}"
                     ondragstart="handleDragStart(event, '${p.id}')"
                     ondragend="handleDragEnd(event)"
                     onclick="openProspectDetail('${p.id}')"
                     oncontextmenu="showProspectContextMenu(event, '${p.id}')">
                    <div class="kanban-card-header">
                        <span class="kanban-card-company">${p.company}${renderAssetIcons(p.assets)}</span>
                        <span class="kanban-card-status badge ${p.status}">${statusLabel(p.status)}</span>
                        <button class="prospect-menu-btn" onclick="event.stopPropagation(); showContextMenu(event, '${p.id}')" title="Actions">⋮</button>
                    </div>
                    ${p.name ? `<div class="kanban-card-contact">${p.name}</div>` : ''}
                    <div class="kanban-card-sector">${p.sector}</div>
                    <div class="kanban-card-footer">
                        <span class="kanban-card-value">${fmtXPF(p.value)}</span>
                        ${renderAssigneeBadge(p.assignedTo, 20)}
                    </div>
                </div>
            `;
        }

        // Drag & Drop handlers
        let draggedProspectId = null;

        function handleDragStart(event, id) {
            draggedProspectId = id;
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', id);
        }

        function handleDragEnd(event) {
            event.target.classList.remove('dragging');
            document.querySelectorAll('.kanban-col, .pipeline-col').forEach(col => {
                col.classList.remove('drag-over');
            });
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            event.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(event, newPriority) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');

            if (draggedProspectId !== null) {
                const prospect = prospects.find(p => p.id === draggedProspectId);
                console.log('[DROP] Prospect trouvé:', prospect?.company, 'ID:', draggedProspectId, 'Type ID:', typeof draggedProspectId);
                console.log('[DROP] Ancienne priorité:', prospect?.priority, '→ Nouvelle:', newPriority);

                if (prospect && prospect.priority !== newPriority) {
                    const oldPriority = prospect.priority;
                    prospect.priority = newPriority;
                    prospect.priorityUpdatedAt = Date.now();

                    console.log('[DROP] Mise à jour en mémoire effectuée');
                    console.log('[DROP] Vérification - prospect.priority maintenant:', prospect.priority);

                    // Compter les prospects par température AVANT render
                    const countBefore = {
                        hot: prospects.filter(p => p.priority === 'hot').length,
                        chaud: prospects.filter(p => p.priority === 'chaud').length,
                        tiede: prospects.filter(p => p.priority === 'tiede').length,
                        froid: prospects.filter(p => p.priority === 'froid').length
                    };
                    console.log('[DROP] Comptage température:', countBefore);

                    save();
                    // Render ALL views to ensure synchronization
                    render();

                    // Sync to Supabase
                    console.log('[DROP] Envoi vers Supabase...');
                    updateProspectInAirtable(prospect);

                    // Visual feedback
                    showToast(`${prospect.company} déplacé vers ${priorityLabel(newPriority)}`);
                } else {
                    console.log('[DROP] Pas de changement (même priorité ou prospect non trouvé)');
                }
                draggedProspectId = null;
            } else {
                console.log('[DROP] draggedProspectId est null');
            }
        }

        function handleStatusDrop(event, newStatus) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');

            if (draggedProspectId !== null) {
                const prospect = prospects.find(p => p.id === draggedProspectId);
                if (prospect && prospect.status !== newStatus) {
                    prospect.status = newStatus;
                    save();
                    render();
                    showToast(`${prospect.company} deplace vers ${statusLabel(newStatus)}`);
                    // Sync to Supabase
                    updateProspectInAirtable(prospect);
                }
                draggedProspectId = null;
            }
        }

        // Toast notification
        function showToast(message, type = 'info') {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();

            const colors = {
                info: 'var(--accent)',
                success: 'var(--green)',
                error: 'var(--red)',
                warning: 'var(--yellow)'
            };

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                <span style="width: 6px; height: 6px; border-radius: 50%; background: ${colors[type]}; flex-shrink: 0;"></span>
                <span>${message}</span>
            `;
            toast.style.cssText = `
                position: fixed;
                bottom: 24px;
                right: 24px;
                background: var(--bg-elevated);
                color: var(--text);
                padding: 0.75rem 1rem;
                border-radius: var(--radius-lg);
                font-size: 0.8125rem;
                font-weight: 500;
                box-shadow: var(--shadow-lg);
                border: 1px solid var(--border);
                z-index: 10000;
                display: flex;
                align-items: center;
                gap: 0.625rem;
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);
                animation: toastIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            `;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'toastOut 0.2s ease forwards';
                setTimeout(() => toast.remove(), 200);
            }, 3000);
        }

        // ============================================
        // PROSPECT DETAIL MODAL
        // ============================================

        let currentProspectId = null;

        // Modal pour créer un nouveau prospect
        function openNewProspectModal() {
            console.log('[MODAL] openNewProspectModal called');

            // Supprimer toute modal existante d'abord
            const existing = document.getElementById('new-prospect-modal-overlay');
            if (existing) {
                console.log('[MODAL] Removing existing modal');
                existing.remove();
            }

            // Créer le backdrop/overlay avec z-index correct
            const overlay = document.createElement('div');
            console.log('[MODAL] Creating overlay element');
            overlay.className = 'modal-overlay';
            overlay.id = 'new-prospect-modal-overlay';
            overlay.onclick = function(e) {
                // Fermer si click sur le backdrop (pas sur la modal elle-même)
                if (e.target === overlay) {
                    closeNewProspectModal();
                }
            };

            // Créer la modal à l'intérieur de l'overlay
            overlay.innerHTML = `
                <div class="modal" style="max-width: 520px; width: 95%; margin: auto;" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <div class="modal-title-section">
                            <h2 class="modal-title" style="display: flex; align-items: center; gap: 0.5rem;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; color: var(--accent);">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                                    <circle cx="9" cy="7" r="4"/>
                                    <line x1="19" y1="8" x2="19" y2="14"/>
                                    <line x1="22" y1="11" x2="16" y2="11"/>
                                </svg>
                                Nouveau Prospect
                            </h2>
                            <div class="modal-subtitle">Ajouter un nouveau lead au pipeline</div>
                        </div>
                        <button class="modal-close" onclick="closeNewProspectModal()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                        </button>
                    </div>
                    <div class="modal-body" style="padding: 1.5rem;">
                        <form onsubmit="createNewProspect(event)">
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label class="form-label" style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-muted); margin-bottom: 0.375rem;">Entreprise *</label>
                                <input type="text" id="new-prospect-company" class="form-input" required placeholder="Ex: Air Tahiti Nui" style="width: 100%; padding: 0.625rem 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-md); color: var(--text); font-size: 0.875rem;">
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div class="form-group">
                                    <label class="form-label" style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-muted); margin-bottom: 0.375rem;">Contact</label>
                                    <input type="text" id="new-prospect-contact" class="form-input" placeholder="Nom du contact" style="width: 100%; padding: 0.625rem 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-md); color: var(--text); font-size: 0.875rem;">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-muted); margin-bottom: 0.375rem;">Secteur</label>
                                    <select id="new-prospect-sector" class="form-select" style="width: 100%; padding: 0.625rem 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-md); color: var(--text); font-size: 0.875rem;">
                                        <option value="Transport">Transport</option>
                                        <option value="Hotellerie">Hôtellerie</option>
                                        <option value="Commerce">Commerce</option>
                                        <option value="Finance">Finance</option>
                                        <option value="Tech">Tech</option>
                                        <option value="Sante">Santé</option>
                                        <option value="Autre">Autre</option>
                                    </select>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div class="form-group">
                                    <label class="form-label" style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-muted); margin-bottom: 0.375rem;">Email</label>
                                    <input type="email" id="new-prospect-email" class="form-input" placeholder="email@company.com" style="width: 100%; padding: 0.625rem 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-md); color: var(--text); font-size: 0.875rem;">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-muted); margin-bottom: 0.375rem;">Téléphone</label>
                                    <input type="tel" id="new-prospect-phone" class="form-input" placeholder="87 12 34 56" style="width: 100%; padding: 0.625rem 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-md); color: var(--text); font-size: 0.875rem;">
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label class="form-label" style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-muted); margin-bottom: 0.375rem;">Valeur estimée (XPF)</label>
                                <input type="number" id="new-prospect-value" class="form-input" value="0" placeholder="5000000" style="width: 100%; padding: 0.625rem 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-md); color: var(--text); font-size: 0.875rem;">
                            </div>
                            <div class="form-group" style="margin-bottom: 1.5rem;">
                                <label class="form-label" style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-muted); margin-bottom: 0.375rem;">Notes</label>
                                <textarea id="new-prospect-notes" class="form-input" rows="3" placeholder="Informations complémentaires..." style="width: 100%; padding: 0.625rem 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-md); color: var(--text); font-size: 0.875rem; resize: vertical;"></textarea>
                            </div>
                            <div class="form-actions" style="display: flex; gap: 0.75rem; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid var(--border);">
                                <button type="button" class="btn btn-ghost" onclick="closeNewProspectModal()">Annuler</button>
                                <button type="submit" class="btn btn-primary">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><polyline points="20 6 9 17 4 12"/></svg>
                                    Créer le prospect
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);
            console.log('[MODAL] Overlay appended to body');
            console.log('[MODAL] Overlay in DOM:', document.getElementById('new-prospect-modal-overlay') !== null);

            // Bloquer le scroll du body
            document.body.style.overflow = 'hidden';

            // Afficher avec animation - FORCER la visibilité
            overlay.style.display = 'flex';
            overlay.classList.add('show');
            console.log('[MODAL] Show class added, display set to flex');

            setTimeout(() => {
                const input = document.getElementById('new-prospect-company');
                if (input) input.focus();
            }, 100);

            // Fermeture avec ESC
            overlay._escHandler = function(e) {
                if (e.key === 'Escape') closeNewProspectModal();
            };
            document.addEventListener('keydown', overlay._escHandler);
        }

        function closeNewProspectModal() {
            const overlay = document.getElementById('new-prospect-modal-overlay');
            if (overlay) {
                overlay.classList.remove('show');
                document.body.style.overflow = '';
                if (overlay._escHandler) {
                    document.removeEventListener('keydown', overlay._escHandler);
                }
                setTimeout(() => overlay.remove(), 200);
            }
        }

        async function createNewProspect(event) {
            event.preventDefault();

            const data = {
                entreprise: document.getElementById('new-prospect-company').value.trim(),
                contact: document.getElementById('new-prospect-contact').value.trim(),
                email: document.getElementById('new-prospect-email').value.trim(),
                telephone: document.getElementById('new-prospect-phone').value.trim(),
                secteur: document.getElementById('new-prospect-sector').value,
                valeur_estimee: parseInt(document.getElementById('new-prospect-value').value) || 0,
                notes: document.getElementById('new-prospect-notes').value.trim(),
                status: 'lead',
                temperature: 'warm',
                assigned_to: currentUser?.id || null
            };

            if (!data.entreprise) {
                showToast('Le nom de l\'entreprise est obligatoire');
                return;
            }

            try {
                await supabase.createProspect(data);
                showToast('Prospect créé!');
                closeNewProspectModal();
                await loadDataFromSupabase();
                render();
            } catch (err) {
                console.error('Erreur création prospect:', err);
                showToast('Erreur création prospect');
            }
        }

        function openProspectDetail(id) {
            const prospect = prospects.find(p => p.id === id);
            if (!prospect) return;

            currentProspectId = id;
            const assets = getProspectAssets(prospect.company);

            // Fill modal
            document.getElementById('modal-company').textContent = prospect.company;
            document.getElementById('modal-sector').textContent = prospect.sector;
            document.getElementById('modal-contact').textContent = prospect.contact || prospect.name || 'Non renseigne';
            document.getElementById('modal-email').textContent = prospect.email || 'Non renseigne';
            document.getElementById('modal-phone').textContent = prospect.phone || 'Non renseigne';
            document.getElementById('modal-poste').textContent = prospect.poste || 'Non renseigne';
            document.getElementById('modal-value').textContent = fmtXPF(prospect.value) + ' XPF';
            document.getElementById('modal-date').textContent = fmtDate(prospect.date);

            // Reset edit mode
            document.getElementById('prospect-info-display').style.display = '';
            document.getElementById('prospect-edit-form').style.display = 'none';
            document.getElementById('edit-toggle-btn').classList.remove('active');
            document.getElementById('edit-toggle-btn').innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> Modifier';

            // Update Fiche IA section
            updateFicheIASection(prospect);

            // Status badge
            const statusBadge = document.getElementById('modal-status');
            statusBadge.className = 'badge ' + prospect.status;
            statusBadge.innerHTML = `<span class="badge-dot"></span>${statusLabel(prospect.status)}`;

            // Priority badge
            const priorityBadge = document.getElementById('modal-priority');
            if (prospect.priority) {
                priorityBadge.className = 'badge ' + prospect.priority;
                priorityBadge.textContent = priorityLabel(prospect.priority);
                priorityBadge.style.display = '';
            } else {
                priorityBadge.style.display = 'none';
            }

            // Assignee select
            const assigneeSelect = document.getElementById('modal-assignee-select');
            if (assigneeSelect) {
                assigneeSelect.innerHTML = '<option value="">Non assigne</option>' +
                    teamMembers.map(m => `<option value="${m.id}" ${prospect.assignedTo === m.id ? 'selected' : ''}>${m.display_name}</option>`).join('');
            }

            // Assets
            const assetsSection = document.getElementById('modal-assets-section');
            const noAssets = document.getElementById('modal-no-assets');
            const assetsGrid = document.getElementById('modal-assets-grid');

            // Utiliser directement les fichiers du manifest (deja tries)
            const assetFiles = assets && assets.files ? assets.files : [];

            // Trier: favoris en premier
            const sortedFiles = [...assetFiles].sort((a, b) => {
                if (a.favorite && !b.favorite) return -1;
                if (!a.favorite && b.favorite) return 1;
                return 0;
            });

            if (sortedFiles.length > 0) {
                assetsSection.style.display = '';
                noAssets.style.display = 'none';
                document.getElementById('modal-assets-count').textContent = sortedFiles.length;
                document.getElementById('tab-badge-assets').textContent = sortedFiles.length;

                const typeIcons = {
                    site: '🌐',
                    dash: '📊',
                    wf: '⚡',
                    doc: '📄'
                };

                const typeLabels = {
                    site: 'Landing Page',
                    dash: 'Dashboard',
                    wf: 'Workflow',
                    doc: 'Document'
                };

                assetsGrid.innerHTML = sortedFiles.map((f, idx) => {
                    const folderEsc = JSON.stringify(assets.folder);
                    const fileEsc = JSON.stringify(f.file);
                    const companyEsc = JSON.stringify(prospect.company);
                    const urlEsc = f.url ? JSON.stringify(f.url) : 'null';
                    return `
                    <div class="asset-card ${f.favorite ? 'favorite' : ''}" data-asset-type="${f.type || 'doc'}" onclick="openAsset(${folderEsc}, ${fileEsc}, ${urlEsc})">
                        <div class="asset-card-icon ${f.type}">${typeIcons[f.type] || '📄'}</div>
                        <div class="asset-card-content">
                            <div class="asset-card-name">${f.favorite ? '★ ' : ''}${f.name}</div>
                            <div class="asset-card-desc">${f.desc}</div>
                            <div class="asset-card-type">${typeLabels[f.type] || 'Document'}</div>
                        </div>
                        <button class="asset-card-menu" onclick="event.stopPropagation(); showAssetMenu(event, ${companyEsc}, ${fileEsc})" title="Options">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                                <circle cx="12" cy="5" r="2"/>
                                <circle cx="12" cy="12" r="2"/>
                                <circle cx="12" cy="19" r="2"/>
                            </svg>
                        </button>
                    </div>
                `}).join('');

                // Update filter counts and reset to 'all'
                updateAssetFilterCounts(sortedFiles);
                currentAssetsFilter = 'all';
                document.querySelectorAll('.asset-filter-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.filter === 'all');
                });
            } else {
                assetsSection.style.display = 'none';
                noAssets.style.display = '';
                document.getElementById('modal-assets-count').textContent = '0';
                document.getElementById('tab-badge-assets').textContent = '0';
            }

            // Supabase link - déjà configuré en HTML statique

            // Activity Timeline
            document.getElementById('modal-timeline').innerHTML = renderProspectTimeline(id);

            // Reset to first tab
            switchProspectTab('info');

            // Show modal
            document.getElementById('prospect-modal').classList.add('show');
            document.body.style.overflow = 'hidden';

            // Update chat suggestions for this prospect
            updateChatSuggestions();
        }

        function closeProspectModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('prospect-modal').classList.remove('show');
            document.body.style.overflow = '';
            currentProspectId = null;

            // Reset chat suggestions to default
            updateChatSuggestions();
        }

        function switchProspectTab(tabName) {
            // Remove active from all tabs and contents
            document.querySelectorAll('.modal-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.modal-tab-content').forEach(content => content.classList.remove('active'));

            // Activate selected tab
            const selectedTab = document.querySelector(`.modal-tab[data-tab="${tabName}"]`);
            const selectedContent = document.getElementById(`tab-content-${tabName}`);

            if (selectedTab) selectedTab.classList.add('active');
            if (selectedContent) selectedContent.classList.add('active');

            // Update tab badges with counts if needed
            if (currentProspectId) {
                const prospect = prospects.find(p => p.id === currentProspectId);
                if (prospect) {
                    // Update assets count
                    const assetsTab = document.querySelector('.modal-tab[data-tab="assets"]');
                    if (assetsTab) {
                        const badge = assetsTab.querySelector('.tab-badge');
                        if (badge) {
                            const assets = getProspectAssets(prospect.company);
                            const assetFiles = assets && assets.files ? assets.files : [];
                            badge.textContent = assetFiles.length;
                        }
                    }
                }
            }
        }

        // Track current assets filter
        let currentAssetsFilter = 'all';

        function filterAssets(filterType) {
            currentAssetsFilter = filterType;

            // Update filter buttons
            document.querySelectorAll('.asset-filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filterType);
            });

            // Show/hide asset cards
            document.querySelectorAll('.asset-card').forEach(card => {
                const cardType = card.dataset.assetType;
                if (filterType === 'all' || cardType === filterType) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function updateAssetFilterCounts(assetFiles) {
            // Count by type
            const counts = { all: assetFiles.length, site: 0, dash: 0, wf: 0, doc: 0 };
            assetFiles.forEach(f => {
                if (counts[f.type] !== undefined) counts[f.type]++;
            });

            // Update count badges
            Object.keys(counts).forEach(type => {
                const countEl = document.getElementById(`filter-count-${type}`);
                if (countEl) countEl.textContent = counts[type];
            });

            // Hide filters with 0 count (except 'all')
            document.querySelectorAll('.asset-filter-btn').forEach(btn => {
                const filter = btn.dataset.filter;
                if (filter !== 'all' && counts[filter] === 0) {
                    btn.style.display = 'none';
                } else {
                    btn.style.display = '';
                }
            });
        }

        function openAsset(folder, file, directUrl = null) {
            // Si une URL directe est fournie (Supabase), l'utiliser
            // Sinon chercher dans le manifest
            let assetUrl = directUrl;

            if (!assetUrl) {
                // Chercher l'URL dans PROSPECT_ASSETS
                const assets = PROSPECT_ASSETS[folder];
                if (assets && assets.files) {
                    const assetFile = assets.files.find(f => f.file === file);
                    if (assetFile && assetFile.url) {
                        assetUrl = assetFile.url;
                    }
                }
            }

            // Fallback: construire URL relative (pour compatibilite)
            if (!assetUrl) {
                assetUrl = `/${encodeURIComponent(folder)}/${file.split('/').map(p => encodeURIComponent(p)).join('/')}`;
            }

            console.log('[openAsset] Folder:', folder);
            console.log('[openAsset] File:', file);
            console.log('[openAsset] URL:', assetUrl);

            const extension = file.split('.').pop().toLowerCase();
            const fileName = file.split('/').pop();

            // Ouvrir dans une popup preview
            openAssetPreview(folder, fileName, assetUrl, extension);
        }

        async function openAssetPreview(folder, fileName, url, extension) {
            // Supprimer popup existante si presente
            const existing = document.getElementById('asset-preview-modal');
            if (existing) existing.remove();

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'asset-preview-modal';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

            const isPdf = extension === 'pdf';
            const isHtml = ['html', 'htm'].includes(extension);
            const isMd = extension === 'md';

            // Pour les fichiers HTML depuis Supabase, on fetch et injecte via srcdoc
            // Car Supabase retourne text/plain au lieu de text/html
            let iframeContent = '';
            if (isHtml && url.includes('supabase.co')) {
                try {
                    const response = await fetch(url);
                    const htmlContent = await response.text();
                    // Echapper les caracteres speciaux pour srcdoc
                    iframeContent = htmlContent
                        .replace(/&/g, '&amp;')
                        .replace(/"/g, '&quot;');
                } catch (e) {
                    console.error('Erreur fetch HTML:', e);
                    iframeContent = '';
                }
            }

            modal.innerHTML = `
                <div class="asset-preview-container" onclick="event.stopPropagation()">
                    <div class="asset-preview-header">
                        <div class="asset-preview-info">
                            <h3>${fileName}</h3>
                            <span>${folder}</span>
                        </div>
                        <div class="asset-preview-actions">
                            <button class="btn btn-primary" onclick="window.open('${url}', '_blank'); document.getElementById('asset-preview-modal').remove();">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;margin-right:6px;">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                                    <polyline points="15 3 21 3 21 9"/>
                                    <line x1="10" y1="14" x2="21" y2="3"/>
                                </svg>
                                Ouvrir dans un onglet
                            </button>
                            <button class="btn btn-secondary" onclick="document.getElementById('asset-preview-modal').remove()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
                                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="asset-preview-content">
                        ${isPdf
                            ? `<object data="${url}" type="application/pdf" width="100%" height="100%">
                                 <p>Impossible d'afficher le PDF. <a href="${url}" target="_blank">Telecharger</a></p>
                               </object>`
                            : (iframeContent
                                ? `<iframe srcdoc="${iframeContent}" frameborder="0"></iframe>`
                                : `<iframe src="${url}" frameborder="0"></iframe>`)
                        }
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            setTimeout(() => modal.classList.add('show'), 10);
        }

        function showAssetModal(folder, file, fullPath) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'asset-modal';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

            const fileName = file.split('/').pop();
            const fullPathEsc = JSON.stringify(fullPath);

            modal.innerHTML = `
                <div class="modal" onclick="event.stopPropagation()" style="max-width: 500px;">
                    <div class="modal-header">
                        <div class="modal-title-section">
                            <h2 class="modal-title">${fileName}</h2>
                            <div class="modal-subtitle">${folder}</div>
                        </div>
                        <button class="modal-close" onclick="document.getElementById('asset-modal').remove()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 1rem;">
                            Le fichier ne s'est pas ouvert. Options:
                        </p>
                        <div style="background: var(--bg-subtle); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <p style="font-size: 0.75rem; color: var(--text-dim); margin-bottom: 0.5rem;">Chemin complet:</p>
                            <textarea id="asset-path-textarea" readonly style="display: block; width: 100%; font-size: 0.75rem; font-family: monospace; background: var(--bg); padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border); color: var(--text); resize: none; min-height: 50px;" onclick="this.select()">${fullPath}</textarea>
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="copyAssetPath(${fullPathEsc})">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                                Copier le chemin
                            </button>
                            <button class="btn btn-ghost" onclick="openInFinder(${fullPathEsc})">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
                                Ouvrir dans Finder
                            </button>
                        </div>
                        <p style="font-size: 0.75rem; color: var(--text-dim); margin-top: 1rem;">
                            Astuce: Lance un serveur local pour eviter ce probleme:<br>
                            <code style="background: var(--bg); padding: 0.25rem 0.5rem; border-radius: 4px;">cd PACIFIK'AI && python3 -m http.server 8080</code>
                        </p>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function copyAssetPath(path) {
            const textarea = document.getElementById('asset-path-textarea');
            if (textarea) {
                textarea.select();
                try {
                    document.execCommand('copy');
                    showToast('Chemin copie!');
                } catch (err) {
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(path).then(() => showToast('Chemin copie!'));
                    }
                }
            }
        }

        function openInFinder(path) {
            // Commande pour ouvrir dans Finder
            const folderPath = path.substring(0, path.lastIndexOf('/'));
            showToast('Ouvre le Finder a: ' + folderPath.split('/').pop());
            // On ne peut pas vraiment ouvrir Finder depuis le navigateur
            // Mais on peut copier la commande
            const cmd = `open "${folderPath}"`;
            if (navigator.clipboard) {
                navigator.clipboard.writeText(cmd).then(() => {
                    showToast('Commande copiee: ' + cmd);
                });
            }
        }

        function openProspectFolder() {
            const prospect = prospects.find(p => p.id === currentProspectId);
            if (!prospect) return;
            const assets = getProspectAssets(prospect.company);
            if (assets) {
                // Show toast with folder path
                showToast(`Dossier: PACIFIK'AI/${assets.folder}/`);
            }
        }

        // ============================================
        // FICHE IA (Recherche Claude Opus)
        // ============================================

        function checkFicheIA(prospect) {
            // 1. Verifier d'abord le localStorage (fiches generees)
            const ficheKey = `fiche_${prospect.company.replace(/[^a-zA-Z0-9]/g, '_')}`;
            const storedFiche = localStorage.getItem(ficheKey);
            if (storedFiche) {
                try {
                    const ficheData = JSON.parse(storedFiche);
                    return {
                        name: 'Fiche Recherche IA',
                        isGenerated: true,
                        date: ficheData.generatedAt ? new Date(ficheData.generatedAt).toLocaleDateString('fr-FR') : null,
                        fromLocalStorage: true,
                        data: ficheData
                    };
                } catch (e) {
                    console.error('[checkFicheIA] Erreur parsing localStorage:', e);
                }
            }

            // 2. Chercher dans les assets (manifest/Airtable)
            const assets = getProspectAssets(prospect.company);
            if (!assets || !assets.files) return null;

            const ficheFile = assets.files.find(f =>
                f.name.toLowerCase().includes('fiche recherche') ||
                f.name.toLowerCase().includes('fiche_recherche') ||
                f.name.toLowerCase().includes('fiche-recherche') ||
                f.file?.toLowerCase().includes('fiche_recherche') ||
                f.isGenerated === true
            );

            return ficheFile || null;
        }

        function updateFicheIASection(prospect) {
            const ficheExists = checkFicheIA(prospect);
            const emptyDiv = document.getElementById('fiche-ia-empty');
            const availableDiv = document.getElementById('fiche-ia-available');
            const badge = document.getElementById('fiche-ia-badge');
            const metaDiv = document.getElementById('fiche-ia-meta');

            if (ficheExists) {
                emptyDiv.style.display = 'none';
                availableDiv.style.display = 'flex';
                badge.textContent = 'Disponible';
                badge.classList.add('available');
                metaDiv.textContent = ficheExists.date ? `Generee le ${ficheExists.date}` : 'Fiche de recherche IA';
            } else {
                emptyDiv.style.display = 'block';
                availableDiv.style.display = 'none';
                badge.textContent = 'Non generee';
                badge.classList.remove('available');
            }

            // Mettre a jour l'etat du bouton selon l'etat de generation
            // Comparer par nom d'entreprise (stable) plutot que par ID
            const isGeneratingThisProspect = ficheGenerationProspect &&
                ficheGenerationProspect.company === prospect.company;

            if (isGeneratingThisProspect) {
                // Generation en cours pour CE prospect
                updateFicheButtonState('generating');
                // Afficher le modal de progression
                const existingModal = document.getElementById('fiche-progress-modal');
                if (!existingModal) {
                    showFicheProgressModal(ficheGenerationProspect);
                } else {
                    existingModal.classList.add('show');
                }
            } else {
                // Pas de generation en cours pour ce prospect
                updateFicheButtonState('idle');
            }
        }

        // Variable pour stocker la dernière fiche générée
        let lastGeneratedFiche = null;

        // Controller global pour pouvoir annuler la generation
        let ficheGenerationController = null;

        // Etat de la generation en cours (prospectId si en cours, null sinon)
        let ficheGenerationInProgress = null;
        let ficheGenerationProspect = null;
        let ficheGenerationStartTime = null;
        let ficheGenerationProgressInterval = null;

        // Clé localStorage pour persister l'état de génération
        const FICHE_GENERATION_STORAGE_KEY = 'pacifikai_fiche_generation';

        // Sauvegarder l'état dans localStorage
        function saveFicheGenerationState() {
            if (ficheGenerationInProgress && ficheGenerationProspect) {
                const stateToSave = {
                    prospectId: ficheGenerationInProgress,
                    prospectCompany: ficheGenerationProspect.company, // Utiliser le nom (stable) en plus de l'ID
                    prospect: ficheGenerationProspect,
                    startTime: ficheGenerationStartTime,
                    savedAt: Date.now()
                };
                localStorage.setItem(FICHE_GENERATION_STORAGE_KEY, JSON.stringify(stateToSave));
                console.log('[Fiche IA] Etat sauvegarde:', stateToSave);
            } else {
                console.log('[Fiche IA] Pas de sauvegarde - inProgress:', ficheGenerationInProgress, 'prospect:', ficheGenerationProspect);
            }
        }

        // Effacer l'état du localStorage
        function clearFicheGenerationState() {
            localStorage.removeItem(FICHE_GENERATION_STORAGE_KEY);
        }

        // Restaurer l'état depuis localStorage (appelé au chargement)
        function restoreFicheGenerationState() {
            console.log('[Fiche IA] Tentative de restauration...');
            const saved = localStorage.getItem(FICHE_GENERATION_STORAGE_KEY);
            console.log('[Fiche IA] Donnees localStorage:', saved);
            if (!saved) {
                console.log('[Fiche IA] Aucune donnee a restaurer');
                return;
            }

            try {
                const state = JSON.parse(saved);
                const elapsed = Date.now() - state.startTime;
                const maxDuration = 15 * 60 * 1000; // 15 minutes max

                // Si plus de 15 minutes, la generation est probablement terminee ou echouee
                if (elapsed > maxDuration) {
                    clearFicheGenerationState();
                    return;
                }

                // Restaurer l'etat
                ficheGenerationInProgress = state.prospectId;
                ficheGenerationProspect = state.prospect;
                ficheGenerationStartTime = state.startTime;

                // Note: Le bouton sera mis a jour automatiquement quand on ouvre un prospect
                // via updateFicheIASection()

                // Demarrer le timer de progression
                ficheGenerationProgressInterval = setInterval(() => {
                    const elapsedNow = Math.floor((Date.now() - ficheGenerationStartTime) / 1000);
                    updateFicheProgressTime(elapsedNow);

                    // Auto-clear apres 15 minutes
                    if (elapsedNow > 15 * 60) {
                        clearInterval(ficheGenerationProgressInterval);
                        resetFicheGenerationState();
                        clearFicheGenerationState();
                    }
                }, 1000);

                // Note: on ne peut pas reprendre le fetch, mais au moins l'UI est coherente
                // Le workflow n8n tourne independamment
                console.log('[Fiche IA] Etat restaure - generation en cours pour:', state.prospect.company);

                // IMPORTANT: Mettre a jour le bouton ET afficher le modal
                // Delai pour que le DOM soit pret (apres render())
                setTimeout(() => {
                    // 1. Mettre a jour le bouton (meme si le prospect n'est pas ouvert)
                    updateFicheButtonState('generating');
                    console.log('[Fiche IA] Bouton mis a jour en mode "generating"');

                    // 2. Afficher le modal de progression
                    showFicheProgressModal(state.prospect);
                    console.log('[Fiche IA] Modal de progression affiche');
                }, 300); // Petit delai pour que le DOM soit pret

                showToast('Generation en cours pour ' + state.prospect.company + ' (restauree)');

            } catch (e) {
                console.error('[Fiche IA] Erreur restauration etat:', e);
                clearFicheGenerationState();
            }
        }

        async function generateFicheIA() {
            const prospect = prospects.find(p => p.id === currentProspectId);

            if (!prospect) {
                showToast('Aucun prospect selectionne');
                return;
            }

            // Si une generation est deja en cours pour CE prospect, juste rouvrir le modal
            if (ficheGenerationInProgress === prospect.id) {
                reopenFicheProgressModal();
                return;
            }

            // Si une generation est en cours pour un AUTRE prospect, prevenir
            if (ficheGenerationInProgress !== null) {
                showToast('Generation deja en cours pour ' + ficheGenerationProspect.company);
                return;
            }

            // Marquer la generation comme en cours
            ficheGenerationInProgress = prospect.id;
            ficheGenerationProspect = prospect;
            ficheGenerationStartTime = Date.now();

            // Sauvegarder l'etat dans localStorage
            saveFicheGenerationState();

            // Mettre a jour le bouton
            updateFicheButtonState('generating');

            // Afficher le modal de progression
            showFicheProgressModal(prospect);

            // Creer un AbortController avec timeout de 15 minutes
            ficheGenerationController = new AbortController();
            const timeoutId = setTimeout(() => {
                ficheGenerationController.abort();
            }, 15 * 60 * 1000); // 15 minutes

            // Demarrer le timer de progression (utiliser variable globale)
            ficheGenerationProgressInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - ficheGenerationStartTime) / 1000);
                updateFicheProgressTime(elapsed);
            }, 1000);

            try {
                const response = await fetch(N8N_FICHE_GENERATION_WEBHOOK, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        company: prospect.company,
                        sector: prospect.sector || 'Business',
                        airtableId: prospect.airtableId || prospect.id
                    }),
                    signal: ficheGenerationController.signal
                });

                clearTimeout(timeoutId);
                if (ficheGenerationProgressInterval) {
                    clearInterval(ficheGenerationProgressInterval);
                    ficheGenerationProgressInterval = null;
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                console.log('[Fiche IA] Reponse recue:', data);

                if (data.success && (data.html || data.markdown)) {
                    // Stocker la fiche générée (supporte html ou markdown)
                    const content = data.html || data.markdown;
                    lastGeneratedFiche = {
                        company: prospect.company,
                        html: data.html,
                        markdown: data.markdown || data.html,
                        filename: data.filename || 'FICHE_RECHERCHE.html',
                        generatedAt: data.generatedAt
                    };

                    // Stocker dans localStorage pour persistence
                    const ficheKey = `fiche_${prospect.company.replace(/[^a-zA-Z0-9]/g, '_')}`;
                    localStorage.setItem(ficheKey, JSON.stringify(lastGeneratedFiche));

                    // Ajouter aux assets du prospect
                    addFicheToAssets(prospect.company, data);

                    // Mettre à jour la section Fiche IA
                    updateFicheIASection(prospect);

                    // Afficher le succes dans le modal
                    showFicheProgressSuccess(prospect, data);
                } else {
                    throw new Error(data.error || 'Erreur inconnue');
                }

            } catch (error) {
                clearTimeout(timeoutId);
                if (ficheGenerationProgressInterval) {
                    clearInterval(ficheGenerationProgressInterval);
                    ficheGenerationProgressInterval = null;
                }

                console.error('[Fiche IA] Erreur:', error);

                if (error.name === 'AbortError') {
                    showFicheProgressError(prospect, 'Generation annulee ou timeout (15 min)');
                } else {
                    showFicheProgressError(prospect, error.message);
                }
            } finally {
                ficheGenerationController = null;
                resetFicheGenerationState();
            }
        }

        function cancelFicheGeneration() {
            if (ficheGenerationController) {
                ficheGenerationController.abort();
            }
            if (ficheGenerationProgressInterval) {
                clearInterval(ficheGenerationProgressInterval);
                ficheGenerationProgressInterval = null;
            }
            resetFicheGenerationState();
            closeFicheProgressModal();
            showToast('Generation annulee');
        }

        function resetFicheGenerationState() {
            ficheGenerationInProgress = null;
            ficheGenerationProspect = null;
            ficheGenerationStartTime = null;
            clearFicheGenerationState(); // Effacer localStorage
            updateFicheButtonState('idle');
        }

        function updateFicheButtonState(state) {
            const btn = document.getElementById('btn-generate-fiche');
            if (!btn) {
                console.log('[Fiche IA] Bouton non trouve, etat demande:', state);
                return;
            }

            console.log('[Fiche IA] updateFicheButtonState:', state);

            btn.classList.remove('generating');
            btn.disabled = false;
            btn.style.opacity = '1';

            if (state === 'generating') {
                btn.innerHTML = '<span class="loading-spinner" style="width: 16px; height: 16px; margin-right: 8px;"></span>Generation en cours...';
                btn.classList.add('generating');
                btn.disabled = true;
            } else {
                btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>Generer la fiche';
            }
        }

        function hideFicheModal() {
            const modal = document.getElementById('fiche-progress-modal');
            if (modal) {
                modal.classList.remove('show');
            }
        }

        function reopenFicheProgressModal() {
            const modal = document.getElementById('fiche-progress-modal');
            if (modal) {
                modal.classList.add('show');
                // Mettre a jour le temps affiche
                if (ficheGenerationStartTime) {
                    const elapsed = Math.floor((Date.now() - ficheGenerationStartTime) / 1000);
                    updateFicheProgressTime(elapsed);
                }
            } else if (ficheGenerationProspect) {
                // Recreer le modal si il a ete supprime
                showFicheProgressModal(ficheGenerationProspect);
            }
        }

        function showFicheProgressModal(prospect) {
            // Supprimer modal existant
            const existing = document.getElementById('fiche-progress-modal');
            if (existing) existing.remove();

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'fiche-progress-modal';
            modal.innerHTML = `
                <div class="modal" onclick="event.stopPropagation()" style="max-width: 500px;">
                    <div class="modal-header" style="position: relative; padding-right: 40px;">
                        <h2 class="modal-title">Generation Fiche IA</h2>
                        <div class="modal-subtitle">${prospect.company} - ${prospect.sector || 'Business'}</div>
                        <button class="btn-close-modal" onclick="hideFicheModal()" title="Masquer (generation continue en arriere-plan)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                    <div class="modal-body" style="text-align: center; padding: 2rem;">
                        <div class="loading-spinner" style="margin: 0 auto 1.5rem; width: 48px; height: 48px;"></div>
                        <h3 style="margin-bottom: 0.5rem;">Deep Research en cours...</h3>
                        <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 1rem;">
                            5 recherches Tavily + synthese Claude Sonnet
                        </p>
                        <div id="fiche-progress-time" style="font-family: monospace; font-size: 1.5rem; color: var(--accent); margin-bottom: 1.5rem;">
                            00:00
                        </div>
                        <div style="background: var(--bg-subtle); border-radius: 8px; padding: 1rem; text-align: left; margin-bottom: 1.5rem;">
                            <div style="font-size: 0.75rem; color: var(--text-dim); margin-bottom: 0.75rem;">Pipeline Deep Research:</div>
                            <div id="fiche-progress-steps" style="font-size: 0.8125rem;">
                                <div class="progress-step active">1. Recherche pain points secteur</div>
                                <div class="progress-step">2. Recherche opportunites automation</div>
                                <div class="progress-step">3. Recherche tendances digitales</div>
                                <div class="progress-step">4. Recherche case studies</div>
                                <div class="progress-step">5. Recherche success stories</div>
                                <div class="progress-step">6. Synthese Claude Sonnet</div>
                            </div>
                        </div>
                        <p style="color: var(--text-dim); font-size: 0.75rem;">
                            Temps moyen: 5-12 minutes selon la complexite
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-ghost" onclick="cancelFicheGeneration()">Annuler</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Afficher le modal (ajouter classe show)
            requestAnimationFrame(() => {
                modal.classList.add('show');
            });

            // Si on restaure apres rechargement, afficher le temps ecoule
            if (ficheGenerationStartTime) {
                const elapsed = Math.floor((Date.now() - ficheGenerationStartTime) / 1000);
                updateFicheProgressTime(elapsed);
            }

            // Animation des steps
            animateFicheProgressSteps();
        }

        function animateFicheProgressSteps() {
            const steps = document.querySelectorAll('#fiche-progress-steps .progress-step');
            let currentStep = 0;

            const interval = setInterval(() => {
                if (!document.getElementById('fiche-progress-modal')) {
                    clearInterval(interval);
                    return;
                }

                steps.forEach((s, i) => {
                    s.classList.remove('active', 'done');
                    if (i < currentStep) s.classList.add('done');
                    if (i === currentStep) s.classList.add('active');
                });

                currentStep++;
                if (currentStep >= steps.length) {
                    currentStep = steps.length - 1; // Rester sur le dernier step
                    clearInterval(interval);
                }
            }, 15000); // Chaque step ~15 secondes
        }

        function updateFicheProgressTime(seconds) {
            const el = document.getElementById('fiche-progress-time');
            if (el) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                el.textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }
        }

        function showFicheProgressSuccess(prospect, data) {
            const modal = document.getElementById('fiche-progress-modal');
            if (!modal) return;

            const body = modal.querySelector('.modal-body');
            body.innerHTML = `
                <div style="color: var(--success); margin-bottom: 1rem;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 64px; height: 64px; margin: 0 auto;">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="16 10 10.5 15.5 8 13"/>
                    </svg>
                </div>
                <h3 style="margin-bottom: 0.5rem; color: var(--success);">Fiche generee avec succes!</h3>
                <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 1.5rem;">
                    ${prospect.company} - Deep Research complete
                </p>
                <div style="background: var(--bg-subtle); border-radius: 8px; padding: 1rem; text-align: left; max-height: 200px; overflow-y: auto; margin-bottom: 1rem;">
                    <pre style="font-size: 0.75rem; white-space: pre-wrap; margin: 0;">${(data.html || data.markdown || '').substring(0, 500)}...</pre>
                </div>
            `;

            const footer = modal.querySelector('.modal-footer');
            const companyEsc = JSON.stringify(prospect.company);
            footer.innerHTML = `
                <button class="btn btn-ghost" onclick="closeFicheProgressModal()">Fermer</button>
                <button class="btn btn-primary" onclick="viewGeneratedFiche(${companyEsc})">Voir la fiche complete</button>
            `;

            showSuccessNotification('Fiche generee pour ' + prospect.company, 'Ajoutee dans les assets');
        }

        function showFicheProgressError(prospect, errorMessage) {
            const modal = document.getElementById('fiche-progress-modal');
            if (!modal) return;

            const body = modal.querySelector('.modal-body');
            body.innerHTML = `
                <div style="color: var(--error); margin-bottom: 1rem;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 64px; height: 64px; margin: 0 auto;">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="15" y1="9" x2="9" y2="15"/>
                        <line x1="9" y1="9" x2="15" y2="15"/>
                    </svg>
                </div>
                <h3 style="margin-bottom: 0.5rem; color: var(--error);">Erreur de generation</h3>
                <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 1rem;">
                    ${errorMessage}
                </p>
                <div style="background: var(--bg-subtle); border-radius: 8px; padding: 1rem; text-align: left; font-size: 0.8125rem;">
                    <strong>Verifier:</strong>
                    <ul style="margin: 0.5rem 0 0 1rem; padding: 0;">
                        <li>Workflow n8n "Deep Research Prospect" actif</li>
                        <li>Cle API Tavily valide</li>
                        <li>Cle API Claude valide</li>
                    </ul>
                </div>
            `;

            const footer = modal.querySelector('.modal-footer');
            footer.innerHTML = `
                <button class="btn btn-ghost" onclick="closeFicheProgressModal()">Fermer</button>
                <button class="btn btn-primary" onclick="closeFicheProgressModal(); generateFicheIA();">Reessayer</button>
            `;
        }

        function closeFicheProgressModal() {
            const modal = document.getElementById('fiche-progress-modal');
            if (modal) modal.remove();
        }

        function viewGeneratedFiche(company) {
            closeFicheProgressModal();
            const ficheKey = `fiche_${company.replace(/[^a-zA-Z0-9]/g, '_')}`;
            const stored = localStorage.getItem(ficheKey);
            if (stored) {
                const data = JSON.parse(stored);
                showFichePreviewModal({ company }, data);
            }
        }

        // Notification succès en haut à droite
        function showSuccessNotification(title, subtitle) {
            const notif = document.createElement('div');
            notif.className = 'success-notification';
            notif.innerHTML = `
                <div class="success-notification-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                </div>
                <div class="success-notification-content">
                    <div class="success-notification-title">${title}</div>
                    <div class="success-notification-subtitle">${subtitle}</div>
                </div>
            `;
            document.body.appendChild(notif);

            // Animation entrée
            setTimeout(() => notif.classList.add('show'), 10);

            // Disparition après 4s
            setTimeout(() => {
                notif.classList.remove('show');
                setTimeout(() => notif.remove(), 300);
            }, 4000);
        }

        function showFicheGeneratingModal(prospect) {
            // Supprimer modal existant si présent
            const existingModal = document.getElementById('fiche-ia-modal');
            if (existingModal) existingModal.remove();

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'fiche-ia-modal';
            modal.innerHTML = `
                <div class="modal" onclick="event.stopPropagation()" style="max-width: 550px;">
                    <div class="modal-header">
                        <div class="modal-title-section">
                            <h2 class="modal-title">Generation Fiches IA - ${prospect.company}</h2>
                            <div class="modal-subtitle">Perplexity Pro + Claude Opus</div>
                        </div>
                    </div>
                    <div class="modal-body" id="fiche-modal-body">
                        <div style="text-align: center; padding: 2rem;">
                            <div class="loading-spinner" style="margin: 0 auto 1.5rem;"></div>
                            <h3 style="margin-bottom: 0.5rem;">Generation en cours...</h3>
                            <p style="color: var(--text-muted); font-size: 0.875rem;">
                                Recherche approfondie pour "${prospect.sector || 'Business'}"
                            </p>
                            <div style="margin-top: 1.5rem; background: var(--bg-subtle); border-radius: 8px; padding: 1rem; text-align: left;">
                                <div style="font-size: 0.75rem; color: var(--text-dim); margin-bottom: 0.5rem;">Pipeline Perplexity + Claude:</div>
                                <div id="research-steps" style="font-size: 0.8125rem;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                        <span class="step-indicator active"></span> Perplexity: Recherche contexte entreprise
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                        <span class="step-indicator"></span> Perplexity: Idees automatisations secteur
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                        <span class="step-indicator"></span> Perplexity: Idees dashboards equipe
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                        <span class="step-indicator"></span> Claude Opus: Synthese 5 fiches
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span class="step-indicator"></span> Sauvegarde Airtable
                                    </div>
                                </div>
                            </div>
                            <div style="margin-top: 1rem; display: flex; justify-content: center; gap: 1rem;">
                                <div style="text-align: center;">
                                    <div style="font-size: 0.65rem; color: var(--text-dim);">Fiches</div>
                                    <div style="font-size: 1.25rem; font-weight: 600; color: var(--accent);">5</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 0.65rem; color: var(--text-dim);">Temps</div>
                                    <div style="font-size: 1.25rem; font-weight: 600; color: var(--purple);">~2min</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            setTimeout(() => modal.classList.add('show'), 10);

            // Ajouter style pour les step indicators
            if (!document.getElementById('fiche-modal-styles')) {
                const style = document.createElement('style');
                style.id = 'fiche-modal-styles';
                style.textContent = `
                    .step-indicator {
                        width: 8px;
                        height: 8px;
                        border-radius: 50%;
                        background: var(--border);
                    }
                    .step-indicator.active {
                        background: var(--accent);
                        animation: pulse 1s infinite;
                    }
                    .step-indicator.done {
                        background: var(--green);
                    }
                    @keyframes pulse {
                        0%, 100% { opacity: 1; }
                        50% { opacity: 0.5; }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        function updateFicheModalSuccess(prospect, data) {
            const modalBody = document.getElementById('fiche-modal-body');
            if (!modalBody) return;

            const fiches = data.fiches;
            const tabs = [
                { id: 'contexte', label: 'Contexte', icon: 'M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z', data: fiches.fiche_contexte },
                { id: 'auto', label: 'Automatisations', icon: 'M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83', data: fiches.fiche_automatisations },
                { id: 'call', label: 'Script Appel', icon: 'M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72', data: fiches.fiche_call },
                { id: 'email', label: 'Email', icon: 'M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2zm16 2l-8 5-8-5', data: fiches.fiche_email },
                { id: 'dashboards', label: 'Dashboards', icon: 'M3 3h7v9H3zm11 0h7v5h-7zm0 9h7v9h-7zM3 16h7v5H3z', data: fiches.fiche_dashboards }
            ];

            modalBody.innerHTML = `
                <div style="text-align: center; padding: 0.75rem 1rem;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                        <div style="width: 40px; height: 40px; background: rgba(34, 197, 94, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2" style="width: 20px; height: 20px;">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        </div>
                        <div style="text-align: left;">
                            <h3 style="margin: 0; color: var(--green); font-size: 1rem;">5 Fiches generees!</h3>
                            <p style="color: var(--text-muted); font-size: 0.75rem; margin: 0;">${prospect.company}</p>
                        </div>
                    </div>
                </div>
                <div class="fiche-tabs" style="display: flex; gap: 0.25rem; border-bottom: 1px solid var(--border); padding: 0 0.5rem; overflow-x: auto;">
                    ${tabs.map((tab, i) => `
                        <button class="fiche-tab ${i === 0 ? 'active' : ''}" data-tab="${tab.id}" onclick="switchFicheTab('${tab.id}')" style="padding: 0.5rem 0.75rem; font-size: 0.75rem; border: none; background: none; color: var(--text-muted); cursor: pointer; white-space: nowrap; border-bottom: 2px solid transparent; transition: all 0.15s;">
                            ${tab.label}
                        </button>
                    `).join('')}
                </div>
                <div class="fiche-content" style="background: var(--bg-subtle); border-radius: 0 0 8px 8px; padding: 1rem; max-height: 350px; overflow-y: auto;">
                    ${tabs.map((tab, i) => `
                        <div id="fiche-tab-${tab.id}" class="fiche-tab-content" style="display: ${i === 0 ? 'block' : 'none'};">
                            <pre style="font-size: 0.75rem; white-space: pre-wrap; color: var(--text-muted); font-family: 'SF Mono', Monaco, monospace; margin: 0;">${JSON.stringify(tab.data, null, 2)}</pre>
                        </div>
                    `).join('')}
                </div>
                <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem; padding: 0 0.5rem;">
                    <button class="btn btn-ghost" onclick="document.getElementById('fiche-ia-modal').remove()">Fermer</button>
                    <button class="btn btn-ghost" onclick="copyCurrentFiche()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                        Copier
                    </button>
                    <button class="btn btn-primary" onclick="downloadAllFiches()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        Tout telecharger
                    </button>
                </div>
            `;

            // Add tab styles
            const style = document.createElement('style');
            style.textContent = `
                .fiche-tab.active { color: var(--accent) !important; border-bottom-color: var(--accent) !important; }
                .fiche-tab:hover { color: var(--text) !important; }
            `;
            modalBody.appendChild(style);
        }

        // Nouvelle fonction pour Deep Research (Tavily + Claude)
        // Fonction pour convertir Markdown en HTML basique
        function markdownToHtml(markdown) {
            if (!markdown) return '';
            return markdown
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/gim, '<em>$1</em>')
                .replace(/^\> (.*$)/gim, '<blockquote>$1</blockquote>')
                .replace(/`(.*?)`/gim, '<code>$1</code>')
                .replace(/^\- (.*$)/gim, '<li>$1</li>')
                .replace(/^\d+\. (.*$)/gim, '<li>$1</li>')
                .replace(/\n\n/gim, '</p><p>')
                .replace(/\n/gim, '<br>')
                .replace(/\|(.+)\|/g, (match) => {
                    const cells = match.split('|').filter(c => c.trim());
                    return '<tr>' + cells.map(c => `<td>${c.trim()}</td>`).join('') + '</tr>';
                });
        }

        // Fonction pour generer le HTML complet avec design premium
        function generateFicheHtml(company, sector, markdown, generatedAt) {
            const htmlContent = markdownToHtml(markdown);
            const date = new Date(generatedAt || Date.now()).toLocaleDateString('fr-FR', {
                day: 'numeric', month: 'long', year: 'numeric'
            });

            return `<!DOCTYPE html>
<html lang="fr">
<head><meta name="build-time" content="1769994207">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiche Recherche - ${company}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #D03027;
            --primary-dark: #B02820;
            --primary-light: #E04038;
            --accent: #2D8659;
            --warning: #C4A000;
            --danger: #D03027;
            --bg-dark: #0D0D0C;
            --bg-card: #1A1A18;
            --bg-surface: #242422;
            --text-primary: #F5F5F3;
            --text-secondary: #BEBEBE;
            --text-muted: #888888;
            --border: #3A3A38;
            --gradient-primary: #D03027;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }
        .header {
            background: var(--primary);
            padding: 60px 40px;
            position: relative;
            overflow: hidden;
        }
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 20px;
        }
        .company-name {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -1px;
        }
        .company-sector {
            font-size: 20px;
            opacity: 0.9;
        }
        .header-meta {
            display: flex;
            gap: 30px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            opacity: 0.85;
        }
        .main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px;
        }
        .section {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
        }
        .markdown-content h1 {
            font-size: 28px;
            font-weight: 700;
            margin: 32px 0 16px;
            color: var(--text-primary);
        }
        .markdown-content h2 {
            font-size: 22px;
            font-weight: 600;
            margin: 28px 0 14px;
            color: var(--primary-light);
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }
        .markdown-content h3 {
            font-size: 18px;
            font-weight: 600;
            margin: 24px 0 12px;
            color: var(--text-primary);
        }
        .markdown-content p {
            margin-bottom: 16px;
            color: var(--text-secondary);
        }
        .markdown-content ul, .markdown-content ol {
            margin: 16px 0;
            padding-left: 24px;
        }
        .markdown-content li {
            margin-bottom: 8px;
            color: var(--text-secondary);
        }
        .markdown-content blockquote {
            background: rgba(99,102,241,0.1);
            border-left: 4px solid var(--primary);
            padding: 16px 20px;
            margin: 20px 0;
            border-radius: 0 12px 12px 0;
            font-style: italic;
        }
        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .markdown-content th, .markdown-content td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .markdown-content th {
            background: var(--bg-surface);
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
        }
        .markdown-content code {
            background: var(--bg-surface);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 14px;
            color: var(--primary-light);
        }
        .markdown-content strong {
            color: var(--text-primary);
            font-weight: 600;
        }
        .footer {
            background: var(--bg-card);
            padding: 40px;
            margin-top: 40px;
            text-align: center;
            border-top: 1px solid var(--border);
        }
        .footer-logo {
            font-size: 24px;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 12px;
        }
        .footer-text {
            color: var(--text-muted);
            font-size: 14px;
        }
        .actions-bar {
            position: fixed;
            bottom: 24px;
            right: 24px;
            display: flex;
            gap: 12px;
            z-index: 100;
        }
        .action-btn {
            padding: 14px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .action-btn.primary {
            background: var(--gradient-primary);
            color: white;
        }
        .action-btn.secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        @media print {
            body { background: white; color: #1a1a1a; }
            .header { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .actions-bar { display: none; }
        }
        @media (max-width: 768px) {
            .header { padding: 40px 20px; }
            .company-name { font-size: 32px; }
            .main { padding: 20px; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="badge">Deep Research AI</div>
            <h1 class="company-name">${company}</h1>
            <p class="company-sector">${sector || 'Business'}</p>
            <div class="header-meta">
                <div class="meta-item">${date}</div>
                <div class="meta-item">Genere par PACIFIK'AI</div>
            </div>
        </div>
    </header>
    <main class="main">
        <div class="section">
            <div class="markdown-content">
                <p>${htmlContent}</p>
            </div>
        </div>
    </main>
    <footer class="footer">
        <div class="footer-logo">PACIFIK'AI</div>
        <p class="footer-text">Fiche generee automatiquement par Deep Research Agent | Tavily + Claude</p>
    </footer>
    <div class="actions-bar">
        <button class="action-btn secondary" onclick="window.print()">Imprimer / PDF</button>
        <button class="action-btn primary" onclick="navigator.clipboard.writeText(document.querySelector('.markdown-content').innerText).then(()=>alert('Copie!'))">Copier</button>
    </div>
</body>
</html>`;
        }

        function updateFicheModalSuccessDeepResearch(prospect, data) {
            const modalBody = document.getElementById('fiche-modal-body');
            if (!modalBody) return;

            // Generer le HTML
            const ficheHtml = generateFicheHtml(prospect.company, prospect.sector, data.markdown, data.generatedAt);

            // Stocker le HTML genere
            lastGeneratedFiche.html = ficheHtml;

            // Sauvegarder dans localStorage
            const ficheKey = `fiche_html_${prospect.company.replace(/[^a-zA-Z0-9]/g, '_')}`;
            localStorage.setItem(ficheKey, ficheHtml);

            modalBody.innerHTML = `
                <div style="text-align: center; padding: 0.75rem 1rem;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                        <div style="width: 40px; height: 40px; background: rgba(34, 197, 94, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2" style="width: 20px; height: 20px;">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        </div>
                        <div style="text-align: left;">
                            <h3 style="margin: 0; color: var(--green); font-size: 1rem;">Fiche Deep Research generee!</h3>
                            <p style="color: var(--text-muted); font-size: 0.75rem; margin: 0;">${prospect.company} - ${prospect.sector || 'Business'}</p>
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                    <button class="btn btn-ghost fiche-view-tab active" data-view="preview" onclick="switchFicheView('preview')" style="flex:1;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;margin-right:4px;"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/></svg>
                        Preview
                    </button>
                    <button class="btn btn-ghost fiche-view-tab" data-view="markdown" onclick="switchFicheView('markdown')" style="flex:1;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;margin-right:4px;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                        Markdown
                    </button>
                </div>
                <div id="fiche-view-preview" class="fiche-view-content" style="border-radius: 8px; overflow: hidden; height: 350px;">
                    <iframe id="fiche-preview-iframe" style="width: 100%; height: 100%; border: none; border-radius: 8px;"></iframe>
                </div>
                <div id="fiche-view-markdown" class="fiche-view-content" style="display: none; background: var(--bg-subtle); border-radius: 8px; padding: 1rem; max-height: 350px; overflow-y: auto;">
                    <pre style="font-size: 0.75rem; white-space: pre-wrap; color: var(--text-muted); font-family: 'SF Mono', Monaco, monospace; margin: 0;">${data.markdown.substring(0, 5000)}${data.markdown.length > 5000 ? '\n\n... (tronque pour affichage)' : ''}</pre>
                </div>
                <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem; padding: 0 0.5rem;">
                    <button class="btn btn-ghost" onclick="document.getElementById('fiche-ia-modal').remove()">Fermer</button>
                    <button class="btn btn-ghost" onclick="copyDeepResearchFiche()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                        Copier
                    </button>
                    <button class="btn btn-ghost" onclick="downloadDeepResearchFiche()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/></svg>
                        .md
                    </button>
                    <button class="btn btn-primary" onclick="downloadDeepResearchHtml()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        Telecharger HTML
                    </button>
                </div>
            `;

            // Charger le preview dans l'iframe
            setTimeout(() => {
                const iframe = document.getElementById('fiche-preview-iframe');
                if (iframe) {
                    iframe.srcdoc = ficheHtml;
                }
            }, 100);

            // Ajouter style pour les tabs
            if (!document.getElementById('fiche-view-styles')) {
                const style = document.createElement('style');
                style.id = 'fiche-view-styles';
                style.textContent = `
                    .fiche-view-tab.active {
                        background: var(--primary) !important;
                        color: white !important;
                    }
                `;
                document.head.appendChild(style);
            }
        }

        function switchFicheView(view) {
            document.querySelectorAll('.fiche-view-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.fiche-view-content').forEach(c => c.style.display = 'none');
            document.querySelector(`.fiche-view-tab[data-view="\${view}"]`)?.classList.add('active');
            document.getElementById(`fiche-view-\${view}`).style.display = 'block';
        }

        function copyDeepResearchFiche() {
            if (!lastGeneratedFiche?.markdown) return;
            navigator.clipboard.writeText(lastGeneratedFiche.markdown).then(() => showToast('Fiche copiee!'));
        }

        function downloadDeepResearchFiche() {
            if (!lastGeneratedFiche?.markdown) return;
            const blob = new Blob([lastGeneratedFiche.markdown], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `FICHE_RECHERCHE_${lastGeneratedFiche.company.replace(/[^a-zA-Z0-9]/g, '_')}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Fiche .md telechargee!');
        }

        function downloadDeepResearchHtml() {
            if (!lastGeneratedFiche?.html) return;
            const blob = new Blob([lastGeneratedFiche.html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `FICHE_RECHERCHE_${lastGeneratedFiche.company.replace(/[^a-zA-Z0-9]/g, '_')}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Fiche HTML telechargee! Place-la dans le dossier du prospect.');
        }

        let currentFicheTab = 'contexte';
        function switchFicheTab(tabId) {
            currentFicheTab = tabId;
            document.querySelectorAll('.fiche-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.fiche-tab-content').forEach(c => c.style.display = 'none');
            document.querySelector(`.fiche-tab[data-tab="${tabId}"]`)?.classList.add('active');
            document.getElementById(`fiche-tab-${tabId}`).style.display = 'block';
        }

        function copyCurrentFiche() {
            if (!lastGeneratedFiche?.fiches) return;
            const tabMap = {
                'contexte': 'fiche_contexte',
                'auto': 'fiche_automatisations',
                'call': 'fiche_call',
                'email': 'fiche_email',
                'dashboards': 'fiche_dashboards'
            };
            const content = JSON.stringify(lastGeneratedFiche.fiches[tabMap[currentFicheTab]], null, 2);
            navigator.clipboard.writeText(content).then(() => showToast('Fiche copiee!'));
        }

        function downloadAllFiches() {
            if (!lastGeneratedFiche?.fiches) return;
            const content = JSON.stringify(lastGeneratedFiche.fiches, null, 2);
            const blob = new Blob([content], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `FICHES_${lastGeneratedFiche.company.replace(/[^a-zA-Z0-9]/g, '_')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Fiches telechargees!');
        }

        function updateFicheModalError(prospect, errorMessage) {
            const modalBody = document.getElementById('fiche-modal-body');
            if (!modalBody) return;

            modalBody.innerHTML = `
                <div style="text-align: center; padding: 1rem;">
                    <div style="width: 64px; height: 64px; background: rgba(239, 68, 68, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="var(--red)" stroke-width="2" style="width: 32px; height: 32px;">
                            <circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>
                        </svg>
                    </div>
                    <h3 style="margin-bottom: 0.5rem; color: var(--red);">Erreur de generation</h3>
                    <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 1rem;">
                        ${errorMessage}
                    </p>
                    <div style="background: var(--bg-subtle); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; text-align: left;">
                        <p style="font-size: 0.8125rem; color: var(--text-muted);">
                            <strong>Verifications:</strong>
                        </p>
                        <ul style="font-size: 0.75rem; color: var(--text-dim); padding-left: 1.25rem; margin-top: 0.5rem;">
                            <li>Workflow n8n "Generation Fiches Prospect" est actif</li>
                            <li>Credential "Perplexity API" configuree</li>
                            <li>Variable ANTHROPIC_API_KEY configuree</li>
                        </ul>
                    </div>
                </div>
                <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                    <button class="btn btn-ghost" onclick="document.getElementById('fiche-ia-modal').remove()">Fermer</button>
                    <button class="btn btn-primary" onclick="generateFicheIA()">Reessayer</button>
                </div>
            `;
        }


        function addFicheToAssets(company, data) {
            // Ajouter la fiche aux assets locaux (pour l'affichage)
            if (!PROSPECT_ASSETS[company]) {
                PROSPECT_ASSETS[company] = {
                    folder: company,
                    files: []
                };
            }

            // Vérifier si FICHE_RECHERCHE existe déjà
            const existingIndex = PROSPECT_ASSETS[company].files.findIndex(
                f => f.name === 'Fiche Recherche IA' || f.file?.includes('FICHE_RECHERCHE')
            );

            const ficheEntry = {
                name: 'Fiche Recherche IA',
                file: 'FICHE_RECHERCHE.html',
                type: 'doc',
                desc: `Deep Research - ${new Date().toLocaleDateString('fr-FR')}`,
                favorite: true,
                date: data.generatedAt,
                isGenerated: true // Flag pour indiquer que c'est une fiche generee
            };

            if (existingIndex >= 0) {
                PROSPECT_ASSETS[company].files[existingIndex] = ficheEntry;
            } else {
                PROSPECT_ASSETS[company].files.unshift(ficheEntry);
            }

            // Sauvegarder le manifest mis a jour dans localStorage
            localStorage.setItem('assetsManifest_updated', JSON.stringify({prospects: PROSPECT_ASSETS}));

            // Mettre à jour l'affichage de la section Fiche IA
            const prospect = prospects.find(p => p.company === company);
            if (prospect) {
                updateFicheIASection(prospect);
            }

            console.log('[Fiche IA] Asset ajoute pour', company, '- Telecharge le HTML et place-le dans:', company + '/FICHE_RECHERCHE.html');
        }

        // Menu contextuel pour les assets
        let currentAssetMenu = null;

        function showAssetMenu(event, company, fileName) {
            event.preventDefault();
            event.stopPropagation();

            // Fermer menu existant
            closeAssetMenu();

            const companyEsc = JSON.stringify(company);
            const fileEsc = JSON.stringify(fileName);

            const menu = document.createElement('div');
            menu.className = 'asset-menu-dropdown';
            menu.id = 'current-asset-menu';
            menu.innerHTML = `
                <button class="asset-menu-item danger" onclick="deleteAsset(${companyEsc}, ${fileEsc})">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                        <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                    Supprimer
                </button>
            `;

            // Positionner le menu
            menu.style.left = event.clientX + 'px';
            menu.style.top = event.clientY + 'px';

            document.body.appendChild(menu);
            currentAssetMenu = menu;

            // Fermer au clic ailleurs (utiliser capture pour intercepter TOUS les clics)
            setTimeout(() => {
                document.addEventListener('click', handleAssetMenuClose, true);
            }, 0);
        }

        function handleAssetMenuClose(event) {
            const menu = document.getElementById('current-asset-menu');
            if (menu && !menu.contains(event.target)) {
                closeAssetMenu();
            }
        }

        function closeAssetMenu() {
            document.removeEventListener('click', handleAssetMenuClose, true);
            if (currentAssetMenu) {
                currentAssetMenu.remove();
                currentAssetMenu = null;
            }
        }

        function deleteAsset(company, fileName) {
            closeAssetMenu();

            if (!PROSPECT_ASSETS[company]) return;

            // Trouver et supprimer le fichier
            const fileIndex = PROSPECT_ASSETS[company].files.findIndex(f => f.file === fileName);
            if (fileIndex === -1) return;

            const file = PROSPECT_ASSETS[company].files[fileIndex];

            if (!confirm(`Supprimer "${file.name}" ?`)) return;

            PROSPECT_ASSETS[company].files.splice(fileIndex, 1);

            // Sauvegarder
            localStorage.setItem('assetsManifest_updated', JSON.stringify({prospects: PROSPECT_ASSETS}));

            // Re-render le prospect detail
            const prospect = prospects.find(p => p.company === company);
            if (prospect) {
                openProspectDetail(prospect.id);
            }

            showToast('Asset supprime');
            console.log('[Assets] Supprime:', fileName, 'pour', company);
        }

        function openFicheIA() {
            const prospect = prospects.find(p => p.id === currentProspectId);
            if (!prospect) return;

            // Si on a une fiche en mémoire, l'afficher
            if (lastGeneratedFiche && lastGeneratedFiche.company === prospect.company) {
                showFichePreviewModal(prospect, lastGeneratedFiche);
                return;
            }

            // Verifier via checkFicheIA (localStorage + assets)
            const fiche = checkFicheIA(prospect);

            // Si fiche trouvee dans localStorage
            if (fiche && fiche.fromLocalStorage && fiche.data) {
                // Charger dans lastGeneratedFiche pour les actions (copier, telecharger)
                lastGeneratedFiche = fiche.data;
                showFichePreviewModal(prospect, fiche.data);
                return;
            }

            // Verifier si on a le HTML en localStorage (ancien format)
            const ficheHtmlKey = `fiche_html_${prospect.company.replace(/[^a-zA-Z0-9]/g, '_')}`;
            const storedHtml = localStorage.getItem(ficheHtmlKey);
            if (storedHtml) {
                showFicheHtmlModal(prospect, storedHtml);
                return;
            }

            // Si fiche dans assets (Supabase/manifest)
            if (fiche) {
                const assets = getProspectAssets(prospect.company);
                openAsset(assets.folder, fiche.file || fiche.name);
            } else {
                showToast('Fiche non trouvee - Genere-la d\'abord');
            }
        }

        function showFicheHtmlModal(prospect, html) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'fiche-html-modal';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            modal.innerHTML = `
                <div class="modal" onclick="event.stopPropagation()" style="max-width: 1000px; max-height: 90vh; padding: 0;">
                    <div class="modal-header" style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border);">
                        <div class="modal-title-section">
                            <h2 class="modal-title">Fiche Recherche - ${prospect.company}</h2>
                            <div class="modal-subtitle">Deep Research AI</div>
                        </div>
                        <button class="btn btn-ghost" onclick="document.getElementById('fiche-html-modal').remove()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                        </button>
                    </div>
                    <div style="height: calc(90vh - 140px); overflow: hidden;">
                        <iframe id="fiche-html-iframe" style="width: 100%; height: 100%; border: none;"></iframe>
                    </div>
                    <div style="display: flex; gap: 0.5rem; justify-content: flex-end; padding: 1rem 1.5rem; border-top: 1px solid var(--border);">
                        <button class="btn btn-ghost" onclick="openFicheInNewTab()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                            Ouvrir plein ecran
                        </button>
                        <button class="btn btn-primary" onclick="downloadCurrentFicheHtml()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            Telecharger HTML
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            setTimeout(() => {
                modal.classList.add('show');
                const iframe = document.getElementById('fiche-html-iframe');
                if (iframe) iframe.srcdoc = html;
            }, 10);

            // Stocker le HTML courant pour les actions
            window.currentFicheHtml = html;
            window.currentFicheProspect = prospect;
        }

        function openFicheInNewTab() {
            if (!window.currentFicheHtml) return;
            const blob = new Blob([window.currentFicheHtml], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
        }

        function downloadCurrentFicheHtml() {
            if (!window.currentFicheHtml || !window.currentFicheProspect) return;
            const blob = new Blob([window.currentFicheHtml], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `FICHE_RECHERCHE_${window.currentFicheProspect.company.replace(/[^a-zA-Z0-9]/g, '_')}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Fiche HTML telechargee!');
        }

        function showFichePreviewModal(prospect, ficheData) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'fiche-preview-modal';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            modal.innerHTML = `
                <div class="modal" onclick="event.stopPropagation()" style="max-width: 800px; max-height: 90vh;">
                    <div class="modal-header">
                        <div class="modal-title-section">
                            <h2 class="modal-title">Fiche Recherche - ${prospect.company}</h2>
                            <div class="modal-subtitle">Generee le ${new Date(ficheData.generatedAt).toLocaleDateString('fr-FR')}</div>
                        </div>
                        <button class="modal-close" onclick="document.getElementById('fiche-preview-modal').remove()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                        </button>
                    </div>
                    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                        <div style="background: var(--bg-subtle); border-radius: 8px; padding: 1.5rem;">
                            <pre style="white-space: pre-wrap; font-family: 'Inter', sans-serif; font-size: 0.875rem; line-height: 1.6;">${ficheData.markdown}</pre>
                        </div>
                    </div>
                    <div style="padding: 1rem; border-top: 1px solid var(--border); display: flex; gap: 0.75rem; justify-content: flex-end;">
                        <button class="btn btn-ghost" onclick="copyFicheMarkdown()">Copier</button>
                        <button class="btn btn-primary" onclick="downloadFicheMarkdown()">Telecharger</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            setTimeout(() => modal.classList.add('show'), 10);
        }

        function regenerateFicheIA() {
            if (confirm('Regenerer la fiche va ecraser la version actuelle. Continuer?')) {
                generateFicheIA();
            }
        }

        // ============================================
        // PACK COMPLET (Dossier Commercial v2)
        // ============================================
        const PACK_COMPLET_WEBHOOK = getN8nWebhook('generateDossier');
        let packGenerationInProgress = false;

        async function generatePackComplet() {
            const prospect = prospects.find(p => p.id === currentProspectId);

            if (!prospect) {
                showToast('Aucun prospect selectionne');
                return;
            }

            if (packGenerationInProgress) {
                showToast('Generation deja en cours...');
                return;
            }

            packGenerationInProgress = true;
            showPackProgressModal(prospect);

            try {
                const controller = new AbortController();
                window.packAbortController = controller;

                const response = await fetch(PACK_COMPLET_WEBHOOK, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        company: prospect.company,
                        sector: prospect.sector
                    }),
                    signal: controller.signal
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (result.success) {
                    showPackProgressSuccess(result);
                    showToast(`Pack genere pour ${prospect.company} (Score QC: ${result.qcScore}/100)`);
                } else {
                    throw new Error(result.message || 'Echec generation');
                }

            } catch (e) {
                if (e.name === 'AbortError') {
                    showToast('Generation annulee');
                } else {
                    console.error('Pack generation error:', e);
                    showPackProgressError(e.message);
                }
            } finally {
                packGenerationInProgress = false;
                window.packAbortController = null;
            }
        }

        function showPackProgressModal(prospect) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay pack-progress-modal';
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>Generation Pack Complet</h3>
                        <button class="modal-close" onclick="cancelPackGeneration()">&times;</button>
                    </div>
                    <div class="modal-content">
                        <div style="text-align: center; margin-bottom: 2rem;">
                            <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">${prospect.company}</div>
                            <div style="color: var(--text-dim);">${prospect.sector}</div>
                        </div>

                        <div id="pack-progress-steps">
                            <div class="pack-step" data-step="1">
                                <span class="pack-step-icon loading">1</span>
                                <span>Recherche Firecrawl (10 queries)</span>
                            </div>
                            <div class="pack-step" data-step="2">
                                <span class="pack-step-icon pending">2</span>
                                <span>Synthese Claude Sonnet</span>
                            </div>
                            <div class="pack-step" data-step="3">
                                <span class="pack-step-icon pending">3</span>
                                <span>Quality Control (Claude Opus)</span>
                            </div>
                            <div class="pack-step" data-step="4">
                                <span class="pack-step-icon pending">4</span>
                                <span>Generation Documents</span>
                            </div>
                            <div class="pack-step" data-step="5">
                                <span class="pack-step-icon pending">5</span>
                                <span>Upload Supabase</span>
                            </div>
                        </div>

                        <div id="pack-timer" style="text-align: center; margin-top: 2rem; font-size: 0.9rem; color: var(--text-dim);">
                            Temps ecoule: <span id="pack-timer-value">0:00</span>
                        </div>

                        <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-subtle); border-radius: 8px; font-size: 0.8rem; color: var(--text-dim);">
                            Ce processus utilise la boucle autocritique: Claude Sonnet genere le contenu, puis Claude Opus l'evalue. Si le score est inferieur a 80/100, le contenu est regenere (max 3 iterations).
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-ghost" onclick="cancelPackGeneration()">Annuler</button>
                    </div>
                </div>
            `;

            // Add styles
            const style = document.createElement('style');
            style.textContent = `
                .pack-step { display: flex; align-items: center; gap: 1rem; padding: 0.75rem 0; border-bottom: 1px solid var(--border-subtle); }
                .pack-step:last-child { border-bottom: none; }
                .pack-step-icon { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 600; }
                .pack-step-icon.pending { background: var(--bg-subtle); color: var(--text-dim); }
                .pack-step-icon.loading { background: var(--accent); color: white; animation: pulse 1.5s infinite; }
                .pack-step-icon.done { background: var(--green); color: white; }
                .pack-step-icon.error { background: var(--red); color: white; }
                @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
            `;
            modal.appendChild(style);

            document.body.appendChild(modal);

            // Start timer
            let seconds = 0;
            window.packTimerInterval = setInterval(() => {
                seconds++;
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                document.getElementById('pack-timer-value').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;

                // Animate steps based on time
                if (seconds >= 5) updatePackStep(1, 'done');
                if (seconds >= 8) updatePackStep(2, 'loading');
                if (seconds >= 30) updatePackStep(2, 'done');
                if (seconds >= 35) updatePackStep(3, 'loading');
                if (seconds >= 60) updatePackStep(3, 'done');
                if (seconds >= 65) updatePackStep(4, 'loading');
                if (seconds >= 80) updatePackStep(4, 'done');
                if (seconds >= 85) updatePackStep(5, 'loading');
            }, 1000);
        }

        function updatePackStep(stepNum, status) {
            const step = document.querySelector(`.pack-step[data-step="${stepNum}"] .pack-step-icon`);
            if (step) {
                step.className = `pack-step-icon ${status}`;
                if (status === 'done') step.textContent = '✓';
            }
        }

        function showPackProgressSuccess(result) {
            clearInterval(window.packTimerInterval);

            // Mark all steps done
            for (let i = 1; i <= 5; i++) updatePackStep(i, 'done');

            const modal = document.querySelector('.pack-progress-modal .modal-content');
            if (modal) {
                modal.innerHTML += `
                    <div style="margin-top: 2rem; padding: 1.5rem; background: var(--green-glow); border-radius: var(--radius-md); text-align: center;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">✨</div>
                        <div style="font-size: 1.2rem; font-weight: 600; color: var(--green); margin-bottom: 0.5rem;">Pack Genere avec Succes!</div>
                        <div style="color: var(--text-dim); margin-bottom: 1rem;">Score Quality Control: ${result.qcScore}/100</div>
                        <a href="${result.supabaseUrl}" target="_blank" class="btn btn-primary" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                                <polyline points="15 3 21 3 21 9"/>
                                <line x1="10" y1="14" x2="21" y2="3"/>
                            </svg>
                            Ouvrir la Fiche
                        </a>
                    </div>
                `;
            }

            // Update footer
            const footer = document.querySelector('.pack-progress-modal .modal-footer');
            if (footer) {
                footer.innerHTML = `<button class="btn btn-primary" onclick="document.querySelector('.pack-progress-modal').remove()">Fermer</button>`;
            }
        }

        function showPackProgressError(message) {
            clearInterval(window.packTimerInterval);

            const modal = document.querySelector('.pack-progress-modal .modal-content');
            if (modal) {
                modal.innerHTML += `
                    <div style="margin-top: 2rem; padding: 1.5rem; background: var(--red)15; border: 1px solid var(--red); border-radius: 12px;">
                        <div style="font-size: 1.1rem; font-weight: 600; color: var(--red); margin-bottom: 0.5rem;">Erreur de Generation</div>
                        <div style="color: var(--text-dim); font-size: 0.9rem;">${message}</div>
                    </div>
                `;
            }

            const footer = document.querySelector('.pack-progress-modal .modal-footer');
            if (footer) {
                footer.innerHTML = `
                    <button class="btn btn-ghost" onclick="document.querySelector('.pack-progress-modal').remove()">Fermer</button>
                    <button class="btn btn-primary" onclick="document.querySelector('.pack-progress-modal').remove(); generatePackComplet();">Reessayer</button>
                `;
            }
        }

        function cancelPackGeneration() {
            if (window.packAbortController) {
                window.packAbortController.abort();
            }
            clearInterval(window.packTimerInterval);
            document.querySelector('.pack-progress-modal')?.remove();
            packGenerationInProgress = false;
        }

        // ============================================
        // CLIENT PORTAL MODULE
        // ============================================
        const PORTAL_BASE_URL = 'https://ogsimsfqwibcmotaeevb.supabase.co/storage/v1/object/public/pacifikai-assets/portal';
        let portalTokens = {}; // { prospectId: { token, createdAt, expiresAt } }

        // Charger les tokens depuis localStorage
        function loadPortalTokens() {
            const saved = localStorage.getItem('pk_portal_tokens');
            if (saved) portalTokens = JSON.parse(saved);
        }

        function savePortalTokens() {
            localStorage.setItem('pk_portal_tokens', JSON.stringify(portalTokens));
        }

        // Generer un token unique
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Generer un lien portal pour le prospect actuel
        function generatePortalLink() {
            const prospect = prospects.find(p => p.id === currentProspectId);
            if (!prospect) {
                showToast('Aucun prospect selectionne');
                return;
            }

            // Verifier si un token existe deja
            const existingToken = portalTokens[prospect.id];
            if (existingToken) {
                const expiresAt = new Date(existingToken.expiresAt);
                if (expiresAt > new Date()) {
                    showPortalLinkModal(prospect, existingToken.token, existingToken.expiresAt);
                    return;
                }
            }

            // Generer un nouveau token
            const token = generateUUID();
            const now = new Date();
            const expiresAt = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000); // 30 jours

            portalTokens[prospect.id] = {
                token,
                prospectId: prospect.id,
                company: prospect.company,
                createdAt: now.toISOString(),
                expiresAt: expiresAt.toISOString()
            };

            savePortalTokens();
            showPortalLinkModal(prospect, token, expiresAt.toISOString());
            showToast('Lien portal genere pour ' + prospect.company);
        }

        function showPortalLinkModal(prospect, token, expiresAt) {
            // Construire l'URL du portal avec les assets du prospect
            const prospectAssets = getProspectAssets(prospect.company);
            const portalUrl = `${window.location.origin}${window.location.pathname.replace('index.html', '')}client-portal.html?token=${token}`;

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal" style="max-width: 550px;">
                    <div class="modal-header">
                        <h3>Portal Client - ${prospect.company}</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                    </div>
                    <div class="modal-content">
                        <div style="background: var(--bg-subtle); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                            <div style="font-size: 0.75rem; color: var(--text-dim); margin-bottom: 0.5rem;">Lien d'acces client</div>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="text" id="portal-link-input" value="${portalUrl}" readonly
                                    style="flex: 1; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 0.85rem;">
                                <button class="btn btn-primary" onclick="copyPortalLink()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                                    </svg>
                                    Copier
                                </button>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                            <div style="padding: 1rem; background: var(--bg-subtle); border-radius: 8px;">
                                <div style="font-size: 0.75rem; color: var(--text-dim);">Token</div>
                                <div style="font-family: monospace; font-size: 0.8rem; color: var(--accent); word-break: break-all;">${token.substring(0, 8)}...</div>
                            </div>
                            <div style="padding: 1rem; background: var(--bg-subtle); border-radius: 8px;">
                                <div style="font-size: 0.75rem; color: var(--text-dim);">Expire le</div>
                                <div style="font-weight: 600;">${new Date(expiresAt).toLocaleDateString('fr-FR')}</div>
                            </div>
                        </div>

                        <div style="padding: 1rem; background: var(--green)15; border: 1px solid var(--green); border-radius: 8px; margin-bottom: 1rem;">
                            <div style="font-weight: 600; color: var(--green); margin-bottom: 0.5rem;">Ce que le client pourra voir:</div>
                            <ul style="margin: 0; padding-left: 1.25rem; color: var(--text-muted); font-size: 0.875rem;">
                                <li>Ses documents et livrables</li>
                                <li>Les fiches et presentations</li>
                                <li>L'avancement du projet</li>
                            </ul>
                        </div>

                        <div style="font-size: 0.8rem; color: var(--text-dim);">
                            Note: Le portal client est une page statique. Pour une version complete avec authentification, nous devrons creer une application dediee.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-ghost" onclick="revokePortalLink('${prospect.id}')">Revoquer l'acces</button>
                        <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">Fermer</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function copyPortalLink() {
            const input = document.getElementById('portal-link-input');
            input.select();
            document.execCommand('copy');
            showToast('Lien copie dans le presse-papiers');
        }

        function revokePortalLink(prospectId) {
            if (confirm('Revoquer l\'acces au portal pour ce client?')) {
                delete portalTokens[prospectId];
                savePortalTokens();
                document.querySelector('.modal-overlay')?.remove();
                showToast('Acces revoque');
            }
        }

        // Charger les tokens au demarrage
        loadPortalTokens();

        // ============================================
        // CLIENT INFRASTRUCTURE MODULE
        // Centralise acces dashboard, workflows, documents
        // ============================================

        let currentInfrastructure = null;

        async function openInfrastructureModal() {
            const prospect = prospects.find(p => p.id === currentProspectId);
            if (!prospect) {
                showToast('Aucun prospect selectionne');
                return;
            }

            // Reset modal state
            document.getElementById('infra-loading').style.display = '';
            document.getElementById('infra-no-data').style.display = 'none';
            document.getElementById('infra-content').style.display = 'none';

            // Update title
            document.getElementById('infra-modal-title').textContent = prospect.company + ' - Infrastructure IA';

            // Show modal
            document.getElementById('infrastructure-modal').classList.add('show');
            document.body.style.overflow = 'hidden';

            // Load infrastructure data
            try {
                const infra = await supabase.getClientInfrastructureByProspect(currentProspectId);

                if (!infra) {
                    document.getElementById('infra-loading').style.display = 'none';
                    document.getElementById('infra-no-data').style.display = '';
                    return;
                }

                currentInfrastructure = infra;
                renderInfrastructureModal(infra);
            } catch (error) {
                console.error('Erreur chargement infrastructure:', error);
                document.getElementById('infra-loading').style.display = 'none';
                document.getElementById('infra-no-data').style.display = '';
            }
        }

        function renderInfrastructureModal(infra) {
            // Hide loading, show content
            document.getElementById('infra-loading').style.display = 'none';
            document.getElementById('infra-content').style.display = '';

            // Quick Links
            const dashboardLink = document.getElementById('infra-link-dashboard');
            if (infra.dashboard_url) {
                dashboardLink.href = infra.dashboard_url;
                dashboardLink.style.display = '';
            } else {
                dashboardLink.style.display = 'none';
            }

            const supabaseLink = document.getElementById('infra-link-supabase');
            if (infra.supabase_dashboard_url) {
                supabaseLink.href = infra.supabase_dashboard_url;
                supabaseLink.style.display = '';
            } else if (infra.supabase_url) {
                supabaseLink.href = `https://supabase.com/dashboard/project/${infra.supabase_project_id || 'ogsimsfqwibcmotaeevb'}/editor`;
                supabaseLink.style.display = '';
            } else {
                supabaseLink.style.display = 'none';
            }

            const n8nLink = document.getElementById('infra-link-n8n');
            if (infra.n8n_folder_url) {
                n8nLink.href = infra.n8n_folder_url;
                n8nLink.style.display = '';
            } else {
                n8nLink.href = 'https://n8n.srv1140766.hstgr.cloud';
                n8nLink.style.display = '';
            }

            const chatbotLink = document.getElementById('infra-link-chatbot');
            if (infra.chatbot_webhook) {
                chatbotLink.href = infra.chatbot_webhook;
                chatbotLink.style.display = '';
            } else {
                chatbotLink.style.display = 'none';
            }

            // Workflows
            const workflows = infra.workflows || [];
            document.getElementById('infra-workflow-count').textContent = workflows.length;
            const workflowsGrid = document.getElementById('infra-workflows-grid');

            if (workflows.length > 0) {
                workflowsGrid.innerHTML = workflows.map(wf => `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; background: var(--bg-subtle); border-radius: var(--radius-md); border: 1px solid var(--border);">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div style="width: 8px; height: 8px; border-radius: 50%; background: ${wf.status === 'active' ? 'var(--green)' : 'var(--text-dim)'};"></div>
                            <div>
                                <div style="font-size: 0.875rem; font-weight: 500; color: var(--text);">${wf.name || 'Workflow'}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${wf.type || 'general'}</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            ${wf.webhook_url ? `<a href="${wf.webhook_url}" target="_blank" class="btn btn-ghost" style="padding: 0.375rem 0.625rem; font-size: 0.75rem;">Webhook</a>` : ''}
                            ${wf.n8n_id ? `<a href="https://n8n.srv1140766.hstgr.cloud/workflow/${wf.n8n_id}" target="_blank" class="btn btn-ghost" style="padding: 0.375rem 0.625rem; font-size: 0.75rem;">Ouvrir</a>` : ''}
                        </div>
                    </div>
                `).join('');
            } else {
                workflowsGrid.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--text-muted); font-size: 0.875rem;">Aucun workflow deploye</div>';
            }

            // Documents
            const documents = infra.documents || [];
            document.getElementById('infra-doc-count').textContent = documents.length;
            const docsGrid = document.getElementById('infra-docs-grid');

            if (documents.length > 0) {
                const docIcons = {
                    'pitch_deck': '📊',
                    'fiche_prospect': '📋',
                    'dossier_commercial': '📁',
                    'guide_rdv': '📝',
                    'default': '📄'
                };

                docsGrid.innerHTML = documents.map(doc => `
                    <a href="${doc.url}" target="_blank" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.875rem 1rem; background: var(--bg-subtle); border-radius: var(--radius-md); border: 1px solid var(--border); text-decoration: none; transition: all var(--transition-fast);" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">
                        <span style="font-size: 1.25rem;">${docIcons[doc.type] || docIcons.default}</span>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 0.8125rem; font-weight: 500; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${doc.name || 'Document'}</div>
                            <div style="font-size: 0.6875rem; color: var(--text-muted);">${doc.type?.replace('_', ' ') || 'document'}</div>
                        </div>
                    </a>
                `).join('');
            } else {
                docsGrid.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--text-muted); font-size: 0.875rem;">Aucun document</div>';
            }

            // Metadata
            document.getElementById('infra-slug').textContent = infra.client_slug || '-';
            document.getElementById('infra-tier').textContent = (infra.tier || 'starter').charAt(0).toUpperCase() + (infra.tier || 'starter').slice(1);
            document.getElementById('infra-deploy-date').textContent = infra.deploy_date ? new Date(infra.deploy_date).toLocaleDateString('fr-FR') : '-';

            const statusEl = document.getElementById('infra-status');
            const statusColors = {
                'active': 'var(--green)',
                'pilot': 'var(--yellow)',
                'pending': 'var(--orange)',
                'inactive': 'var(--text-dim)'
            };
            statusEl.innerHTML = `<span style="color: ${statusColors[infra.status] || 'var(--text)'};">${(infra.status || 'pending').charAt(0).toUpperCase() + (infra.status || 'pending').slice(1)}</span>`;
        }

        function closeInfrastructureModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('infrastructure-modal').classList.remove('show');
            document.body.style.overflow = '';
            currentInfrastructure = null;
        }

        // ============================================
        // PROSPECT EDIT MODE
        // ============================================

        function toggleEditMode() {
            const prospect = prospects.find(p => p.id === currentProspectId);
            if (!prospect) return;

            const displayDiv = document.getElementById('prospect-info-display');
            const formDiv = document.getElementById('prospect-edit-form');
            const toggleBtn = document.getElementById('edit-toggle-btn');

            if (formDiv.style.display === 'none') {
                // Switch to edit mode
                displayDiv.style.display = 'none';
                formDiv.style.display = 'block';
                toggleBtn.classList.add('active');
                toggleBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg> Annuler';

                // Pre-fill form with existing data
                document.getElementById('edit-contact').value = prospect.contact || prospect.name || '';
                document.getElementById('edit-email').value = prospect.email || '';
                document.getElementById('edit-phone').value = prospect.phone || '';
                document.getElementById('edit-poste').value = prospect.poste || '';

                // Focus first field
                document.getElementById('edit-contact').focus();
            } else {
                cancelEditMode();
            }
        }

        function cancelEditMode() {
            document.getElementById('prospect-info-display').style.display = '';
            document.getElementById('prospect-edit-form').style.display = 'none';
            document.getElementById('edit-toggle-btn').classList.remove('active');
            document.getElementById('edit-toggle-btn').innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> Modifier';
        }

        async function saveProspectEdits() {
            const prospect = prospects.find(p => p.id === currentProspectId);
            if (!prospect) return;

            // Get values from form
            const contact = document.getElementById('edit-contact').value.trim();
            const email = document.getElementById('edit-email').value.trim();
            const phone = document.getElementById('edit-phone').value.trim();
            const poste = document.getElementById('edit-poste').value.trim();

            // Check if anything changed
            const changes = {};
            if (contact && contact !== (prospect.contact || prospect.name || '')) {
                prospect.contact = contact;
                changes['Contact'] = contact;
            }
            if (email && email !== (prospect.email || '')) {
                prospect.email = email;
                changes['Email'] = email;
            }
            if (phone && phone !== (prospect.phone || '')) {
                prospect.phone = phone;
                changes['Téléphone'] = phone;
            }
            if (poste && poste !== (prospect.poste || '')) {
                prospect.poste = poste;
                changes['Poste'] = poste;
            }

            if (Object.keys(changes).length === 0) {
                showToast('Aucune modification');
                cancelEditMode();
                return;
            }

            // Update display
            document.getElementById('modal-contact').textContent = prospect.contact || prospect.name || 'Non renseigne';
            document.getElementById('modal-email').textContent = prospect.email || 'Non renseigne';
            document.getElementById('modal-phone').textContent = prospect.phone || 'Non renseigne';
            document.getElementById('modal-poste').textContent = prospect.poste || 'Non renseigne';

            // Save locally
            save();

            // Sync to Airtable
            try {
                await updateProspectInAirtable(prospect, changes);
                showToast('Infos contact mises a jour');

                // Add to activity timeline
                addActivityToProspect(prospect.id, 'update', 'Infos contact modifiees: ' + Object.keys(changes).join(', '));
                document.getElementById('modal-timeline').innerHTML = renderProspectTimeline(prospect.id);
            } catch (error) {
                console.error('Erreur sync Airtable:', error);
                showToast('Sauvegarde locale OK, sync Airtable echouee');
            }

            cancelEditMode();
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Don't trigger shortcuts when typing in inputs
            const tag = document.activeElement?.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') {
                if (e.key === 'Escape') {
                    document.activeElement.blur();
                }
                return;
            }

            if (e.key === 'Escape') {
                closeProspectModal();
                closeContextMenu();
            }

            // Ctrl/Cmd+K: Open MANA chat
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                const chatPanel = document.getElementById('chatbot-panel');
                if (chatPanel) {
                    chatPanel.classList.toggle('open');
                    if (chatPanel.classList.contains('open')) {
                        document.getElementById('chatbot-input')?.focus();
                    }
                }
            }

            // N: New task (when on tasks view)
            if ((e.key === 'n' || e.key === 'N') && !e.metaKey && !e.ctrlKey && !e.altKey) {
                const activeView = document.querySelector('.view.active');
                if (activeView?.id === 'view-tasks') {
                    e.preventDefault();
                    openTaskModal();
                }
            }
        });

        // ============================================
        // PIPELINE STATUS VIEW (with Drag & Drop)
        // ============================================

        function renderPipelineStatus() {
            const stages = [
                { key: 'lead', label: 'Lead' },
                { key: 'contacted', label: 'Contacte' },
                { key: 'meeting', label: 'RDV/Audit' },
                { key: 'proposal', label: 'Proposition' },
                { key: 'won', label: 'Gagne' }
            ];

            const filtered = getFilteredProspects();
            const board = document.getElementById('pipeline-status-board');

            board.innerHTML = stages.map(s => {
                const items = filtered.filter(p => p.status === s.key);
                const total = items.reduce((sum, p) => sum + (p.value || 0), 0);
                return `
                    <div class="pipeline-col" data-status="${s.key}"
                         ondragover="handleDragOver(event)"
                         ondragleave="handleDragLeave(event)"
                         ondrop="handleStatusDrop(event, '${s.key}')">
                        <div class="pipeline-header">
                            <span class="pipeline-title">${s.label}</span>
                            <span class="pipeline-count">${items.length} • ${fmtXPF(total)}</span>
                        </div>
                        ${items.map(p => {
                    const hasAssets = p.assets && p.assets.length > 0;
                    return `
                            <div class="pipeline-card ${hasAssets ? 'has-assets' : ''}"
                                 draggable="true"
                                 data-id="${p.id}"
                                 ondragstart="handleDragStart(event, '${p.id}')"
                                 ondragend="handleDragEnd(event)"
                                 onclick="openProspectDetail('${p.id}')"
                                 oncontextmenu="showProspectContextMenu(event, '${p.id}')"
                                 style="cursor: pointer;">
                                <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:0.5rem;">
                                    <div class="pipeline-card-name">${p.company}${renderAssetIcons(p.assets, true)}</div>
                                    <button class="prospect-menu-btn" onclick="event.stopPropagation(); showContextMenu(event, '${p.id}')" title="Actions">⋮</button>
                                </div>
                                <div class="pipeline-card-company">${p.sector}</div>
                                <div class="pipeline-card-footer">
                                    <span class="pipeline-card-value">${fmtXPF(p.value)}</span>
                                    ${renderAssigneeBadge(p.assignedTo, 18)}
                                    ${p.priority ? `<span class="pipeline-card-priority ${p.priority}">${priorityLabel(p.priority)}</span>` : ''}
                                </div>
                            </div>
                        `;
                }).join('')}
                    </div>
                `;
            }).join('');
        }
        // ============================================
        // SUPABASE SYNC (remplace Airtable)
        // ============================================

        async function syncFromAirtable() {
            // Renamed but keeps same name for compatibility with existing calls
            console.log('[SYNC] Starting Supabase sync...');
            const btn = document.getElementById('sync-btn');
            const syncDot = document.querySelector('.sync-dot');
            const syncText = document.getElementById('sync-text');

            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<svg class="spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg> Sync...';
            }
            if (syncDot) syncDot.classList.add('syncing');
            if (syncText) syncText.textContent = 'Synchronisation...';

            try {
                await loadDataFromSupabase();
                lastSync = new Date();
                save();
                render();
                renderTasks();

                if (syncDot) syncDot.classList.remove('syncing');
                if (syncText) syncText.textContent = 'Sync ' + lastSync.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                showToast(`${prospects.length} prospects synchronises`);

            } catch (error) {
                console.error('[SYNC] Error:', error);
                if (syncDot) {
                    syncDot.classList.remove('syncing');
                    syncDot.classList.add('error');
                }
                if (syncText) syncText.textContent = 'Erreur sync';
                showToast('Erreur de synchronisation');
                if (syncDot) setTimeout(() => syncDot.classList.remove('error'), 3000);
            }

            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg> Sync';
            }
        }

        async function updateProspectInAirtable(prospect, extraFields = {}) {
            // Utilise Supabase au lieu de Airtable
            const id = prospect.supabaseId || prospect.id;
            if (!id) {
                console.warn('[Supabase] No ID for prospect:', prospect.company);
                return;
            }

            const updates = {
                status: mapDashboardStatusToSupabase(prospect.status),
                temperature: mapDashboardTemperatureToSupabase(prospect.priority)
            };

            if (prospect.notes) updates.notes = prospect.notes;
            if (extraFields.Email) updates.email = extraFields.Email;
            if (extraFields.Contact) updates.contact = extraFields.Contact;
            if (extraFields['Téléphone']) updates.telephone = extraFields['Téléphone'];

            console.log('[Supabase] Updating prospect:', prospect.company, 'with:', updates);

            try {
                await supabase.updateProspect(id, updates);
                console.log('[Supabase] Update success for:', prospect.company);
            } catch (error) {
                console.error('[Supabase] Update error:', error);
                showToast('Erreur sync Supabase');
            }
        }

        function updateSyncStatus() {
            const syncText = document.getElementById('sync-text');
            if (lastSync) {
                const ago = Math.floor((Date.now() - lastSync.getTime()) / 60000);
                if (ago < 1) syncText.textContent = 'Sync a l\'instant';
                else if (ago < 60) syncText.textContent = `Sync il y a ${ago}min`;
                else syncText.textContent = 'Sync ' + lastSync.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            }
        }

        // ============================================
        // FOLLOW-UPS / REMINDERS
        // ============================================

        function renderFollowups() {
            const today = new Date().toISOString().split('T')[0];
            const todayFollowups = followups.filter(f => !f.done && f.date <= today);

            const widget = document.getElementById('followups-widget');
            const list = document.getElementById('followups-list');
            const count = document.getElementById('followups-count');

            if (todayFollowups.length === 0) {
                widget.style.display = 'none';
                return;
            }

            widget.style.display = 'block';
            count.textContent = todayFollowups.length;

            list.innerHTML = todayFollowups.map(f => {
                const prospect = prospects.find(p => p.id === f.prospectId);
                if (!prospect) return '';
                const isOverdue = f.date < today;
                return `
                    <div class="followup-item" onclick="openProspectDetail('${f.prospectId}')">
                        <div class="followup-item-info">
                            <div class="followup-item-company">${prospect.company}</div>
                            <div class="followup-item-note">${f.note || 'Relancer ce prospect'}</div>
                        </div>
                        <span class="followup-badge ${isOverdue ? 'overdue' : 'today'}">${isOverdue ? 'En retard' : 'Aujourd\'hui'}</span>
                        <div class="followup-item-actions">
                            <button class="followup-action done" onclick="event.stopPropagation(); markFollowupDone(${f.id})" title="Marquer comme fait">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                            </button>
                            <button class="followup-action" onclick="event.stopPropagation(); postponeFollowup(${f.id})" title="Reporter a demain">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showAddReminder() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('reminder-date').value = tomorrow.toISOString().split('T')[0];
            document.getElementById('reminder-note').value = '';
            document.getElementById('reminder-modal').classList.add('show');
        }

        function closeReminderModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('reminder-modal').classList.remove('show');
        }

        function saveReminder() {
            const date = document.getElementById('reminder-date').value;
            const note = document.getElementById('reminder-note').value;

            if (!date || !currentProspectId) return;

            followups.push({
                id: Date.now(),
                prospectId: currentProspectId,
                date: date,
                note: note,
                done: false
            });

            save();
            renderFollowups();
            closeReminderModal();

            const prospect = prospects.find(p => p.id === currentProspectId);
            showToast(`Rappel ajoute pour ${prospect?.company}`);
        }

        function markFollowupDone(id) {
            const f = followups.find(x => x.id === id);
            if (f) {
                f.done = true;
                save();
                renderFollowups();
                showToast('Rappel termine');
            }
        }

        function postponeFollowup(id) {
            const f = followups.find(x => x.id === id);
            if (f) {
                const newDate = new Date(f.date);
                newDate.setDate(newDate.getDate() + 1);
                f.date = newDate.toISOString().split('T')[0];
                save();
                renderFollowups();
                showToast('Reporte a demain');
            }
        }

        // ============================================
        // NOTES SYSTEM
        // ============================================

        function renderNotes(prospectId) {
            const prospectNotes = notes[prospectId] || [];
            const list = document.getElementById('modal-notes-list');

            if (prospectNotes.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: var(--text-dim); font-size: 0.75rem; padding: 1rem;">Aucune note</div>';
                return;
            }

            list.innerHTML = prospectNotes.sort((a, b) => new Date(b.date) - new Date(a.date)).map(n => `
                <div class="note-item">
                    <div class="note-item-header">
                        <span class="note-item-date">${new Date(n.date).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' })}</span>
                        <button class="note-item-delete" onclick="deleteNote(${currentProspectId}, ${n.id})">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                        </button>
                    </div>
                    <div class="note-item-text">${n.text}</div>
                </div>
            `).join('');
        }

        function addNote() {
            const input = document.getElementById('modal-note-input');
            const text = input.value.trim();

            if (!text || !currentProspectId) return;

            if (!notes[currentProspectId]) notes[currentProspectId] = [];

            notes[currentProspectId].push({
                id: Date.now(),
                text: text,
                date: new Date().toISOString()
            });

            // Add to activity timeline
            addActivityToProspect(currentProspectId, 'note', `Note ajoutee: "${text.substring(0, 50)}${text.length > 50 ? '...' : ''}"`);

            save();
            renderNotes(currentProspectId);
            document.getElementById('modal-timeline').innerHTML = renderProspectTimeline(currentProspectId);
            input.value = '';
            showToast('Note ajoutee');
        }

        function deleteNote(prospectId, noteId) {
            if (!notes[prospectId]) return;
            notes[prospectId] = notes[prospectId].filter(n => n.id !== noteId);
            save();
            renderNotes(prospectId);
        }

        // ============================================
        // QUICK ACTIONS
        // ============================================

        function sendEmail() {
            const prospect = prospects.find(p => p.id === currentProspectId);
            if (!prospect) return;
            const email = prospect.email || '';
            const subject = encodeURIComponent(`PACIFIK'AI - ${prospect.company}`);
            window.open(`mailto:${email}?subject=${subject}`, '_blank');
        }

        function openWhatsApp() {
            const prospect = prospects.find(p => p.id === currentProspectId);
            if (!prospect) return;
            const phone = prospect.phone?.replace(/\s/g, '') || '';
            const message = encodeURIComponent(`Bonjour, je vous contacte de la part de PACIFIK'AI concernant ${prospect.company}.`);
            if (phone) {
                window.open(`https://wa.me/${phone}?text=${message}`, '_blank');
            } else {
                showToast('Pas de numero de telephone');
            }
        }

        // ============================================
        // ANALYTICS CHARTS
        // ============================================

        function renderCharts() {
            renderTempChart();
            renderFunnelChart();
        }

        function renderTempChart() {
            const temps = ['hot', 'chaud', 'tiede', 'froid'];
            const data = temps.map(t => prospects.filter(p => p.priority === t).length);
            const max = Math.max(...data, 1);

            const chart = document.getElementById('chart-temp');
            chart.innerHTML = temps.map((t, i) => {
                // Hauteur proportionnelle avec minimum visible (90px max)
                const height = Math.max((data[i] / max) * 90, 8);
                const labels = { hot: 'Hot', chaud: 'Chaud', tiede: 'Tiede', froid: 'Froid' };
                return `
                    <div class="bar-item">
                        <span class="bar-value">${data[i]}</span>
                        <div class="bar-container">
                            <div class="bar ${t}" style="height: ${height}px;"></div>
                        </div>
                        <span class="bar-label">${labels[t]}</span>
                    </div>
                `;
            }).join('');
        }

        function renderFunnelChart() {
            const stages = [
                { key: 'lead', label: 'Leads', color: 'var(--blue)' },
                { key: 'contacted', label: 'Contactes', color: 'var(--yellow)' },
                { key: 'meeting', label: 'RDV', color: 'var(--accent)' },
                { key: 'proposal', label: 'Proposition', color: 'var(--orange)' },
                { key: 'won', label: 'Gagnes', color: 'var(--green)' }
            ];

            const data = stages.map(s => prospects.filter(p => p.status === s.key).length);
            const total = prospects.length || 1;

            const funnel = document.getElementById('chart-funnel');
            funnel.innerHTML = stages.map((s, i) => {
                const pct = (data[i] / total) * 100;
                const minWidth = data[i] > 0 ? Math.max(pct, 8) : 0;
                return `
                    <div class="funnel-stage">
                        <span class="funnel-label">${s.label}</span>
                        <div class="funnel-bar-wrap">
                            <div class="funnel-bar" style="width: ${minWidth}%; background: ${s.color};">
                                <span style="font-size: 0.75rem; font-weight: 600; color: white;">${data[i]}</span>
                            </div>
                        </div>
                        <span class="funnel-count">${Math.round(pct)}%</span>
                    </div>
                `;
            }).join('');
        }

        // Update render function
        const originalRender = render;
        render = function() {
            originalRender();
            renderFollowups();
            renderCharts();
            updateSyncStatus();
        };

        // Update openProspectDetail to include notes
        const originalOpenProspectDetail = openProspectDetail;
        openProspectDetail = function(id) {
            originalOpenProspectDetail(id);
            renderNotes(id);
        };

        // ============================================
        // AI CHATBOT
        // ============================================

        function toggleChatbot() {
            isChatbotOpen = !isChatbotOpen;
            document.getElementById('chatbot-panel').classList.toggle('open', isChatbotOpen);
            if (isChatbotOpen) {
                document.getElementById('chatbot-input').focus();
            }
        }

        function handleChatKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendUserMessage();
            }
        }

        // Auto-resize textarea as user types
        function autoResizeChatInput() {
            const input = document.getElementById('chatbot-input');
            input.style.height = 'auto';
            input.style.height = Math.min(input.scrollHeight, 150) + 'px';
        }

        // Initialize auto-resize on page load
        document.addEventListener('DOMContentLoaded', () => {
            const chatInput = document.getElementById('chatbot-input');
            if (chatInput) {
                chatInput.addEventListener('input', autoResizeChatInput);
            }
        });

        function sendChatMessage(text) {
            document.getElementById('chatbot-input').value = text;
            sendUserMessage();
        }

        // Update chat suggestions based on context (selected prospect, etc.)
        function updateChatSuggestions() {
            const suggestionsEl = document.getElementById('chatbot-suggestions');
            if (!suggestionsEl) return;

            let suggestions = [];

            // Detect active view
            const activeView = document.querySelector('.view.active');
            const activeViewId = activeView ? activeView.id.replace('view-', '') : 'dashboard';

            // If a prospect is currently selected (modal open)
            if (currentProspectId) {
                const prospect = prospects.find(p => p.id === currentProspectId);
                if (prospect) {
                    suggestions = [
                        { text: `Fiche de ${prospect.company}`, action: `Donne-moi la fiche complete de ${prospect.company}` },
                        { text: `Relancer ${prospect.company.split(' ')[0]}`, action: `Redige un email de relance pour ${prospect.company}` },
                        { text: 'Historique', action: `Quel est l'historique avec ${prospect.company}?` }
                    ];
                }
            } else if (activeViewId === 'tasks') {
                const overdue = airtableTasks.filter(t => t.dueDate && new Date(t.dueDate) < new Date() && t.status !== 'Terminé').length;
                suggestions = [
                    { text: 'Mes taches', action: 'Quelles sont mes taches?' },
                    { text: `En retard (${overdue})`, action: 'Liste les taches en retard' },
                    { text: 'Resume semaine', action: 'Fais un resume des taches de la semaine' },
                    { text: 'Taches urgentes', action: 'Quelles taches sont urgentes?' }
                ];
            } else {
                // Default suggestions
                suggestions = [
                    { text: 'Combien de prospects?', action: 'Combien de prospects?' },
                    { text: 'Pipeline total', action: 'Valeur totale du pipeline' },
                    { text: 'A relancer', action: 'Prospects a relancer' }
                ];
            }

            suggestionsEl.innerHTML = suggestions.map(s =>
                `<span class="suggestion-chip" onclick="sendChatMessage('${s.action.replace(/'/g, "\\'")}')">${s.text}</span>`
            ).join('');
        }

        // Get current time formatted
        function getChatTimestamp() {
            const now = new Date();
            return now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        }

        function resetChatInputHeight() {
            const input = document.getElementById('chatbot-input');
            input.style.height = '44px';
        }

        async function sendUserMessage() {
            const input = document.getElementById('chatbot-input');
            const message = input.value.trim();
            if (!message) return;

            input.value = '';
            resetChatInputHeight();
            addChatMessage('user', message);
            chatHistory.push({ role: 'user', content: message });

            // Show typing indicator
            showTypingIndicator();

            // Process with local AI (no API needed for basic commands)
            const response = await processMessage(message);

            hideTypingIndicator();
            addChatMessage('assistant', response.text, response.data);
            chatHistory.push({ role: 'assistant', content: response.text });
        }

        function addChatMessage(role, text, data = null) {
            const container = document.getElementById('chatbot-messages');
            const msg = document.createElement('div');
            msg.className = `chat-message ${role}`;

            const avatar = role === 'user'
                ? '<div class="chat-avatar">JB</div>'
                : `<div class="chat-avatar"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1"/></svg></div>`;

            let dataHtml = '';
            if (data) {
                if (data.type === 'stats') {
                    dataHtml = renderStatsCard(data);
                } else if (data.type === 'prospects') {
                    dataHtml = renderProspectsList(data.prospects);
                } else if (data.type === 'prospect') {
                    dataHtml = renderProspectCard(data.prospect);
                } else if (data.type === 'followups') {
                    dataHtml = renderFollowupsList(data.followups);
                }
            }

            const timestamp = getChatTimestamp();
            msg.innerHTML = `
                ${avatar}
                <div class="chat-bubble">
                    ${formatChatText(text)}
                    ${dataHtml}
                    <div class="chat-timestamp">${timestamp}</div>
                </div>
            `;

            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
        }

        function formatChatText(text) {
            return text
                .split('\n')
                .map(line => `<p>${line}</p>`)
                .join('')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/`(.*?)`/g, '<code>$1</code>');
        }

        function showTypingIndicator() {
            const container = document.getElementById('chatbot-messages');
            const typing = document.createElement('div');
            typing.id = 'typing-indicator';
            typing.className = 'chat-message assistant';
            typing.innerHTML = `
                <div class="chat-avatar"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1"/></svg></div>
                <div class="typing-indicator">
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                </div>
            `;
            container.appendChild(typing);
            container.scrollTop = container.scrollHeight;
        }

        function hideTypingIndicator() {
            const typing = document.getElementById('typing-indicator');
            if (typing) typing.remove();
        }

        // ============================================
        // NATURAL LANGUAGE UPDATE DETECTION
        // ============================================

        function detectAndApplyNaturalUpdate(message) {
            const msg = message.toLowerCase();

            // Step 1: Find if a company is mentioned
            let detectedCompany = null;
            for (const p of prospects) {
                const companyLower = p.company.toLowerCase();
                // Check full name
                if (msg.includes(companyLower)) {
                    detectedCompany = p;
                    break;
                }
                // Check significant words (3+ chars)
                const words = companyLower.split(/[\s\-]+/).filter(w => w.length >= 3);
                for (const word of words) {
                    if (msg.includes(word) && word !== 'the' && word !== 'les' && word !== 'des') {
                        detectedCompany = p;
                        break;
                    }
                }
                if (detectedCompany) break;
            }

            // No company mentioned = not an update
            if (!detectedCompany) return null;

            // Step 2: Detect interaction type (status change)
            const interactionPatterns = {
                'contacted': [
                    'appele', 'appelé', 'appel', 'telephone', 'téléphone',
                    'contacte', 'contacté', 'parle', 'parlé', 'discute', 'discuté',
                    'envoye mail', 'envoyé mail', 'envoye email', 'envoyé email',
                    'ecrit', 'écrit', 'message', 'ai contacte', 'ai contacté',
                    'ai appele', 'ai appelé', 'ai parle', 'ai parlé'
                ],
                'meeting': [
                    'rdv', 'rendez-vous', 'rendezvous', 'rencontre', 'rencontré',
                    'vu', 'meeting', 'reunion', 'réunion', 'audit', 'visite',
                    'ai rencontre', 'ai rencontré', 'ai vu'
                ],
                'proposal': [
                    'proposition', 'devis', 'offre envoy', 'envoye proposition',
                    'envoyé proposition', 'presente offre', 'présenté offre',
                    'ai envoye', 'ai envoyé'
                ],
                'won': [
                    'signe', 'signé', 'accepte', 'accepté', 'valide', 'validé',
                    'ok pour', 'dit oui', 'accord', 'd\'accord', 'client', 'gagne', 'gagné',
                    'a signe', 'a signé', 'ont signe', 'ont signé'
                ]
            };

            // Step 3: Detect interest level (priority change)
            const interestPatterns = {
                'hot': [
                    'tres interesse', 'très intéressé', 'super interesse', 'super intéressé',
                    'vraiment interesse', 'vraiment intéressé', 'hyper interesse',
                    'chaud bouillant', 'pret a signer', 'prêt à signer', 'urgent',
                    'veut commencer', 'veut demarrer', 'impatient', 'tres chaud', 'très chaud',
                    'super chaud', 'hyper chaud'
                ],
                'chaud': [
                    'interesse', 'intéressé', 'positif', 'receptif', 'réceptif',
                    'bonne discussion', 'bien passe', 'bien passé', 'enthousiaste',
                    'veut en savoir plus', 'curieux', 'ouvert',
                    'sont chauds', 'est chaud', 'ils sont chaud', 'il est chaud', 'elle est chaud'
                ],
                'tiede': [
                    'peut-etre', 'peut-être', 'hesitant', 'hésitant', 'reflechit', 'réfléchit',
                    'pas sur', 'pas sûr', 'mitige', 'mitigé', 'a voir', 'à voir',
                    'sont tiede', 'est tiede', 'sont tièdes', 'est tiède'
                ],
                'froid': [
                    'pas interesse', 'pas intéressé', 'refuse', 'refusé', 'non merci',
                    'pas le moment', 'plus tard', 'pas pour nous', 'budget',
                    'sont froids', 'est froid'
                ]
            };

            let newStatus = null;
            let newPriority = null;

            // Detect status
            for (const [status, patterns] of Object.entries(interactionPatterns)) {
                for (const pattern of patterns) {
                    if (msg.includes(pattern)) {
                        newStatus = status;
                        break;
                    }
                }
                if (newStatus) break;
            }

            // Detect priority
            for (const [priority, patterns] of Object.entries(interestPatterns)) {
                for (const pattern of patterns) {
                    if (msg.includes(pattern)) {
                        newPriority = priority;
                        break;
                    }
                }
                if (newPriority) break;
            }

            // Step 4: Extract structured data (email, contact name, phone)
            const extractedData = {};

            // Extract email
            const emailMatch = message.match(/[\w.-]+@[\w.-]+\.\w+/i);
            if (emailMatch) {
                extractedData.email = emailMatch[0].toLowerCase();
            }

            // Extract phone (various formats)
            const phoneMatch = message.match(/(?:\+689\s?)?(?:87|89|40)\s?\d{2}\s?\d{2}\s?\d{2}|\d{2}[\s.-]?\d{2}[\s.-]?\d{2}[\s.-]?\d{2}/);
            if (phoneMatch) {
                extractedData.phone = phoneMatch[0].replace(/[\s.-]/g, ' ').trim();
            }

            // Extract contact name patterns
            const contactPatterns = [
                /contact(?:e|é)?(?:\s+(?:est|c'est|:))?\s+([A-Z][a-zéèêë]+(?:\s+[A-Z][a-zéèêë]+)?)/i,
                /(?:parle|parlé|discute|discuté)\s+(?:avec|a)\s+([A-Z][a-zéèêë]+(?:\s+[A-Z][a-zéèêë]+)?)/i,
                /(?:son|leur)\s+(?:nom|contact)\s+(?:est|c'est|:)\s+([A-Z][a-zéèêë]+(?:\s+[A-Z][a-zéèêë]+)?)/i,
                /(?:il|elle)\s+s'appelle\s+([A-Z][a-zéèêë]+(?:\s+[A-Z][a-zéèêë]+)?)/i,
                /([A-Z][a-zéèêë]+(?:\s+[A-Z][a-zéèêë]+)?)\s+(?:est le|est la)\s+(?:contact|responsable|directeur|manager)/i
            ];
            for (const pattern of contactPatterns) {
                const match = message.match(pattern);
                if (match && match[1]) {
                    extractedData.contact = match[1].trim();
                    break;
                }
            }

            // Extract job title/position
            const postePatterns = [
                /(?:son|leur)\s+poste\s+(?:est|c'est|:)\s+([^,.]+)/i,
                /(?:il|elle)\s+est\s+(directeur|manager|responsable|chef|CEO|DG|PDG|gérant|commercial)[^,.]*(?:de|du|des)?[^,.]*/i,
                /(directeur|manager|responsable|chef|CEO|DG|PDG|gérant|commercial)\s+(?:de|du|des)?\s*([^,.]+)/i
            ];
            for (const pattern of postePatterns) {
                const match = message.match(pattern);
                if (match) {
                    extractedData.poste = match[0].replace(/(?:son|leur)\s+poste\s+(?:est|c'est|:)\s+/i, '').trim();
                    break;
                }
            }

            // If nothing detected (no status, no priority, no data), not an update message
            if (!newStatus && !newPriority && Object.keys(extractedData).length === 0) return null;

            // Step 5: Apply changes
            const actions = [];
            const oldStatus = detectedCompany.status;
            const oldPriority = detectedCompany.priority;
            const airtableUpdates = {};

            if (newStatus && newStatus !== oldStatus) {
                detectedCompany.status = newStatus;
                actions.push(`Status: ${statusLabel(oldStatus)} → ${statusLabel(newStatus)}`);
            }

            if (newPriority && newPriority !== oldPriority) {
                detectedCompany.priority = newPriority;
                actions.push(`Temperature: ${priorityLabel(oldPriority)} → ${priorityLabel(newPriority)}`);
            }

            // Apply extracted data
            if (extractedData.email) {
                detectedCompany.email = extractedData.email;
                airtableUpdates['Email'] = extractedData.email;
                actions.push(`Email: ${extractedData.email}`);
            }
            if (extractedData.phone) {
                detectedCompany.phone = extractedData.phone;
                airtableUpdates['Téléphone'] = extractedData.phone;
                actions.push(`Tel: ${extractedData.phone}`);
            }
            if (extractedData.contact) {
                detectedCompany.contact = extractedData.contact;
                airtableUpdates['Contact'] = extractedData.contact;
                actions.push(`Contact: ${extractedData.contact}`);
            }
            if (extractedData.poste) {
                detectedCompany.poste = extractedData.poste;
                airtableUpdates['Poste'] = extractedData.poste;
                actions.push(`Poste: ${extractedData.poste}`);
            }

            // Step 6: Generate synthesized note (not raw message)
            if (actions.length > 0) {
                // Build a synthesized note
                const today = new Date().toLocaleDateString('fr-FR');
                const synthesizedNote = synthesizeNote(message, newStatus, newPriority, extractedData);

                if (synthesizedNote) {
                    if (!notes[detectedCompany.id]) notes[detectedCompany.id] = [];
                    notes[detectedCompany.id].unshift({
                        id: Date.now(),
                        text: synthesizedNote,
                        date: new Date().toISOString()
                    });
                    localStorage.setItem('pk_notes', JSON.stringify(notes));
                    actions.push('Note synthetisee');
                }

                // Add to activity timeline
                addActivityToProspect(detectedCompany.id, 'update', actions.filter(a => !a.includes('Note')).join(', '));

                // Save and sync
                save();
                renderProspectsViews();
                updateProspectInAirtable(detectedCompany, airtableUpdates);

                // Add notification
                addNotification({
                    type: 'status',
                    title: `${detectedCompany.company} mis a jour`,
                    desc: actions.filter(a => !a.includes('Note')).join(' | '),
                    prospectId: detectedCompany.id
                });
            }

            // Return response
            if (actions.length > 0) {
                return {
                    text: `Compris! J'ai mis a jour **${detectedCompany.company}**:\n\n${actions.map(a => '• ' + a).join('\n')}`,
                    data: { type: 'prospect', prospect: detectedCompany }
                };
            }

            return null;
        }

        // Synthesize a clean note from the raw message
        function synthesizeNote(message, newStatus, newPriority, extractedData) {
            const today = new Date().toLocaleDateString('fr-FR');
            let noteParts = [];

            // Determine the action type
            if (newStatus === 'contacted') {
                noteParts.push('Premier contact etabli');
            } else if (newStatus === 'meeting') {
                noteParts.push('RDV effectue');
            } else if (newStatus === 'proposal') {
                noteParts.push('Proposition envoyee');
            } else if (newStatus === 'won') {
                noteParts.push('Client gagne!');
            }

            // Add sentiment
            if (newPriority === 'hot') {
                noteParts.push('Tres interesse, a closer rapidement');
            } else if (newPriority === 'chaud') {
                noteParts.push('Bonne reception, interesse');
            } else if (newPriority === 'tiede') {
                noteParts.push('A relancer, hesitant');
            } else if (newPriority === 'froid') {
                noteParts.push('Pas interesse pour le moment');
            }

            // Extract any additional context (remove extracted data from message)
            let contextMsg = message;
            if (extractedData.email) contextMsg = contextMsg.replace(extractedData.email, '');
            if (extractedData.phone) contextMsg = contextMsg.replace(extractedData.phone, '');
            if (extractedData.contact) contextMsg = contextMsg.replace(new RegExp(extractedData.contact, 'gi'), '');

            // Look for specific context clues
            const contextPatterns = [
                { pattern: /rappel(?:er|le)?\s+(.+?)(?:\.|$)/i, prefix: 'A rappeler: ' },
                { pattern: /besoin\s+(?:de|d')?\s*(.+?)(?:\.|$)/i, prefix: 'Besoin: ' },
                { pattern: /interesse\s+par\s+(.+?)(?:\.|$)/i, prefix: 'Interesse par: ' },
                { pattern: /prochain(?:e)?\s+(?:etape|action|rdv)\s*[:\s]+(.+?)(?:\.|$)/i, prefix: 'Prochaine etape: ' }
            ];

            for (const { pattern, prefix } of contextPatterns) {
                const match = message.match(pattern);
                if (match && match[1]) {
                    noteParts.push(prefix + match[1].trim());
                }
            }

            // If no parts were generated, don't create a note
            if (noteParts.length === 0) return null;

            return `[${today}] ` + noteParts.join('. ') + '.';
        }

        // ============================================
        // AI MESSAGE PROCESSING (Local Intelligence)
        // ============================================

        async function processMessage(message) {
            // ============================================
            // MANA AGENT v3 - INTELLIGENT ROUTING
            // Mémoire persistante dans Airtable
            // Vision 360° (CRM, Tasks, Roadmap, Content, Workflows, Assets)
            // ============================================

            // Detect intent for routing
            const intent = detectIntent(message);
            console.log('[MANA v3] Intent detected:', intent.type, 'confidence:', intent.confidence);

            // Build enriched context
            const fullContext = buildFullContext();

            // Get current prospect context if modal is open
            let prospectContext = '';
            if (currentProspectId) {
                const prospect = prospects.find(p => p.id === currentProspectId);
                if (prospect) {
                    const assets = getProspectAssets(prospect.company);
                    prospectContext = `\n\n### PROSPECT ACTUELLEMENT SELECTIONNE\n` +
                        `- Entreprise: ${prospect.company}\n` +
                        `- Secteur: ${prospect.sector}\n` +
                        `- Status: ${statusLabel(prospect.status)}\n` +
                        `- Priorite: ${prospect.priority}\n` +
                        `- Valeur: ${fmtXPF(prospect.value)}\n` +
                        `- Contact: ${prospect.contact || 'N/A'}\n` +
                        `- Assets: ${assets ? assets.files.map(f => f.name).join(', ') : 'Aucun'}`;
                }
            }

            try {
                console.log('[MANA v3] Envoi au webhook n8n avec session:', MANA_SESSION_ID, 'intent:', intent.type);

                const response = await fetch(N8N_MANA_WEBHOOK, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        session_id: MANA_SESSION_ID,
                        intent: intent.type,
                        context: fullContext + prospectContext
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[MANA v3] Erreur webhook:', response.status, errorText);
                    // Fallback to local processing if webhook fails
                    return await processMessageLocal(message);
                }

                const data = await response.json();
                console.log('[MANA v3] Reponse recue:', data.success ? 'OK' : 'Erreur', data.tool_executed || '');

                if (data.success && data.response) {
                    // Handle actions returned by MANA v3 (update_prospect, etc.)
                    if (data.action && data.action.type === 'update_prospect') {
                        const actionData = data.action.data;
                        console.log('[MANA v3] Action update_prospect:', actionData);

                        // Update local prospect data to match Airtable change
                        const prospect = prospects.find(p =>
                            p.company.toLowerCase() === actionData.company.toLowerCase() ||
                            p.airtableId === actionData.airtableId
                        );

                        if (prospect) {
                            if (actionData.newPriority) {
                                prospect.priority = actionData.newPriority;
                                prospect.priorityUpdatedAt = Date.now(); // Track when updated
                            }
                            if (actionData.newStatus) {
                                prospect.status = actionData.newStatus;
                                prospect.statusUpdatedAt = Date.now();
                            }
                            save();
                            render();
                            console.log('[MANA v3] Prospect local mis a jour:', prospect.company);
                        }
                    }

                    return { text: data.response, stats: data.stats };
                } else {
                    console.warn('[MANA v3] Reponse incomplete, fallback local');
                    return await processMessageLocal(message);
                }

            } catch (error) {
                console.error('[MANA v2] Erreur:', error);
                // Fallback to local processing
                return await processMessageLocal(message);
            }
        }

        // Fallback: traitement local si webhook indisponible
        async function processMessageLocal(message) {
            const apiKey = getClaudeApiKey();
            if (!apiKey) {
                return {
                    text: "⚠️ **MANA n'est pas joignable via n8n et la clé API Claude n'est pas configurée.**\n\nVérifie que le workflow n8n est actif ou configure une clé API:\n```\nconfigureClaudeKey('sk-ant-ta-cle')\n```"
                };
            }

            try {
                const context = buildFullContext();
                console.log('[MANA Fallback] Utilisation API Claude directe...');

                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: CLAUDE_CONFIG.model,
                        max_tokens: 1024,
                        system: CLAUDE_CONFIG.systemPrompt + '\n\n## DONNEES CRM EN TEMPS REEL\n' + context,
                        messages: [
                            ...chatHistory.slice(-6),
                            { role: 'user', content: message }
                        ]
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    return { text: `Erreur API Claude: ${error.error?.message || 'Inconnue'}` };
                }

                const data = await response.json();
                const assistantResponse = data.content[0].text;

                // Parse JSON response from Claude
                let parsed;
                try {
                    const jsonMatch = assistantResponse.match(/```json\s*([\s\S]*?)\s*```/) ||
                                     assistantResponse.match(/\{[\s\S]*\}/);
                    const jsonStr = jsonMatch ? (jsonMatch[1] || jsonMatch[0]) : assistantResponse;
                    parsed = JSON.parse(jsonStr);
                } catch (e) {
                    return { text: assistantResponse };
                }

                // Execute actions from Claude
                if (parsed.actions && parsed.actions.length > 0) {
                    for (const action of parsed.actions) {
                        await executeClaudeAction(action);
                    }
                }

                return { text: parsed.message || assistantResponse };

            } catch (error) {
                return { text: `Erreur de connexion: ${error.message}` };
            }
        }

        // Build comprehensive context for Claude
        // ============================================
        // INTENT DETECTION - Route to MANA or RAG
        // ============================================
        function detectIntent(message) {
            const msg = message.toLowerCase().trim();

            // CRM Actions - Route to MANA
            const crmPatterns = [
                /\b(modifi|chang|met|passe)\b.*(priorit|status|statut|temperature)/i,
                /\b(creer?|ajoute|nouveau)\b.*(prospect|tache|task|rappel|followup)/i,
                /\b(supprim|efface|retire)\b/i,
                /\b(relance|email|appel|contact)\b.*\b(prospect|client)\b/i,
                /\b(liste|affiche|montre|donne)\b.*(prospect|tache|task|pipeline)/i,
                /combien\s+(de\s+)?(prospect|client|tache)/i,
                /\b(pipeline|total|valeur)\b/i,
                /\bfiche\b.*\b(de|du|d')\b/i,
                /\b(qui|quel)\b.*\b(hot|chaud|tiede|froid|prioritaire)\b/i,
                /\ba\s+relancer\b/i,
                /\b(assigne|attribu)\b.*(tache|task|prospect|client)/i,
                /\b(resume|synthese|recap)\b.*(tache|task|semaine)/i,
                /\bmes\s+taches\b/i,
                /\btaches?\s*(urgent|en retard|overdue|bloque)/i,
                /\b(modifi|edit|change)\b.*(tache|task)/i,
            ];

            // FAQ/Knowledge - Could route to RAG (currently uses MANA with context)
            const faqPatterns = [
                /\b(qu'est-ce|c'est quoi|explique|comment)\b.*\b(pacifik|service|offre|tarif|prix)\b/i,
                /\b(process|methode|etape)\b/i,
                /\b(avantage|benefice|pourquoi)\b.*\b(ia|automatisation|n8n)\b/i,
            ];

            // Check CRM patterns
            for (const pattern of crmPatterns) {
                if (pattern.test(msg)) {
                    return { type: 'crm_action', confidence: 0.9 };
                }
            }

            // Check FAQ patterns
            for (const pattern of faqPatterns) {
                if (pattern.test(msg)) {
                    return { type: 'question_faq', confidence: 0.7 };
                }
            }

            // Default to CRM (MANA handles both with context)
            return { type: 'crm_action', confidence: 0.5 };
        }

        // ============================================
        // BUILD FULL CONTEXT - Enhanced with all data
        // ============================================
        function buildFullContext() {
            const stats = {
                total: prospects.length,
                byPriority: {
                    hot: prospects.filter(p => p.priority === 'hot'),
                    chaud: prospects.filter(p => p.priority === 'chaud'),
                    tiede: prospects.filter(p => p.priority === 'tiede'),
                    froid: prospects.filter(p => p.priority === 'froid')
                },
                byStatus: {
                    lead: prospects.filter(p => p.status === 'lead').length,
                    contacted: prospects.filter(p => p.status === 'contacted').length,
                    meeting: prospects.filter(p => p.status === 'meeting').length,
                    proposal: prospects.filter(p => p.status === 'proposal').length,
                    won: prospects.filter(p => p.status === 'won').length
                },
                totalPipeline: prospects.reduce((s, p) => s + (p.value || 0), 0)
            };

            const hotList = stats.byPriority.hot.map(p => `- ${p.company} (${p.sector}) - ${statusLabel(p.status)} - ${fmtXPF(p.value)}`).join('\n');
            const chaudList = stats.byPriority.chaud.map(p => `- ${p.company} (${p.sector})`).join('\n');

            const todayFollowups = followups.filter(f => !f.done).slice(0, 5).map(f => {
                const p = prospects.find(pr => pr.id === f.prospectId);
                return `- ${p?.company || 'Inconnu'}: ${f.note}`;
            }).join('\n');

            // Build tasks context
            const now = new Date();
            const urgentTasks = airtableTasks.filter(t => t.priority === 'Urgent' && t.status !== 'Terminé');
            const pendingTasks = airtableTasks.filter(t => t.status === 'À faire');
            const inProgressTasks = airtableTasks.filter(t => t.status === 'En cours');
            const doneTasks = airtableTasks.filter(t => t.status === 'Terminé');
            const overdueTasks = airtableTasks.filter(t => t.dueDate && new Date(t.dueDate) < now && t.status !== 'Terminé');

            const tasksList = airtableTasks.map(t => {
                const dueStr = t.dueDate ? ` (due: ${t.dueDate})` : '';
                const assignStr = t.assignee ? ` [${t.assignee}]` : '';
                const projectStr = t.project && t.project !== 'other' ? ` {${t.project}}` : '';
                return `- [${t.status}] ${t.title}${dueStr}${assignStr}${projectStr} - ${t.priority}`;
            }).join('\n');

            // Team & assignments context
            const teamContext = teamMembers.map(m => `- ${m.display_name} (${m.id})`).join('\n');
            const assignedProspects = prospects.filter(p => p.assignedTo);
            const assignmentContext = teamMembers.map(m => {
                const assigned = assignedProspects.filter(p => p.assignedTo === m.id);
                return `- ${m.display_name}: ${assigned.length > 0 ? assigned.map(p => p.company).join(', ') : 'Aucun'}`;
            }).join('\n');

            // Build assets context per prospect
            const assetsContext = prospects.slice(0, 10).map(p => {
                const assets = getProspectAssets(p.company);
                if (assets && assets.files && assets.files.length > 0) {
                    const filesList = assets.files.map(f => `${f.type}: ${f.name}`).join(', ');
                    return `- ${p.company}: ${filesList}`;
                }
                return null;
            }).filter(Boolean).join('\n');

            // Build conversation history context
            const recentHistory = chatHistory.slice(-5).map(m =>
                `[${m.role}]: ${m.content.substring(0, 100)}...`
            ).join('\n');

            return `### Statistiques Pipeline
- Total prospects: ${stats.total}
- Pipeline total: ${fmtXPF(stats.totalPipeline)}

### Par Temperature
- Hot (${stats.byPriority.hot.length}): Tres interesse
- Chaud (${stats.byPriority.chaud.length}): Interesse
- Tiede (${stats.byPriority.tiede.length}): A relancer
- Froid (${stats.byPriority.froid.length}): Peu interesse

### Par Status
- Lead: ${stats.byStatus.lead}
- Contacte: ${stats.byStatus.contacted}
- RDV: ${stats.byStatus.meeting}
- Proposition: ${stats.byStatus.proposal}
- Gagne: ${stats.byStatus.won}

### Prospects HOT (prioritaires)
${hotList || 'Aucun'}

### Prospects CHAUD
${chaudList || 'Aucun'}

### Rappels en attente
${todayFollowups || 'Aucun'}

### EQUIPE
${teamContext || 'Aucun membre'}

### ASSIGNATION PROSPECTS
${assignmentContext || 'Aucune assignation'}

### TACHES (${airtableTasks.length} total)
- Urgentes: ${urgentTasks.length}
- A faire: ${pendingTasks.length}
- En cours: ${inProgressTasks.length}
- Terminees: ${doneTasks.length}
- EN RETARD: ${overdueTasks.length}

### TACHES EN RETARD
${overdueTasks.length > 0 ? overdueTasks.map(t => `- ⚠ ${t.title} (due: ${t.dueDate}) - ${t.assignee || 'Non assigne'}`).join('\n') : 'Aucune'}

### Liste des taches
${tasksList || 'Aucune tache'}

### ASSETS PAR PROSPECT
${assetsContext || 'Aucun asset'}

### HISTORIQUE CONVERSATION RECENTE
${recentHistory || 'Nouvelle conversation'}

### Liste complete des prospects
${prospects.map(p => `- ${p.company} | ${p.sector} | ${p.priority} | ${statusLabel(p.status)} | ${fmtXPF(p.value)}`).join('\n')}

### Date: ${new Date().toLocaleDateString('fr-FR')}`;
        }

        // Refresh ALL views (dashboard + prospects + charts + tasks)
        function refreshAllViews() {
            renderStats();
            renderPipeline();
            renderRecentProspects();
            renderProspectsViews();
            renderTempChart();
            renderFunnelChart();
            renderTasks(); // Also refresh tasks view
            console.log('[PACIFIKAI] Views refreshed');
        }

        // Execute action returned by Claude
        async function executeClaudeAction(action) {
            console.log('[PACIFIKAI Assistant] Execution action:', action);

            let needsRefresh = false;

            switch (action.type) {
                case 'change_priority':
                    const prospect = findProspectByName(action.target);
                    if (prospect) {
                        prospect.priority = action.to;
                        prospect.priorityUpdatedAt = Date.now();
                        save();
                        updateProspectInAirtable(prospect);
                        needsRefresh = true;
                    }
                    break;

                case 'change_status':
                    const prospectS = findProspectByName(action.target);
                    if (prospectS) {
                        const statusMap = { 'contacte': 'contacted', 'rdv': 'meeting', 'proposition': 'proposal', 'gagne': 'won' };
                        prospectS.status = statusMap[action.to] || action.to;
                        save();
                        updateProspectInAirtable(prospectS);
                        needsRefresh = true;
                    }
                    break;

                case 'bulk_change_priority':
                    const toChangePriority = prospects.filter(p => p.priority === action.from);
                    toChangePriority.forEach(p => {
                        p.priority = action.to;
                        updateProspectInAirtable(p);
                    });
                    save();
                    needsRefresh = true;
                    break;

                case 'bulk_change_status':
                    const statusMapBulk = { 'contacte': 'contacted', 'rdv': 'meeting', 'proposition': 'proposal', 'gagne': 'won' };
                    const fromStatus = statusMapBulk[action.from] || action.from;
                    const toStatus = statusMapBulk[action.to] || action.to;
                    const toChangeStatus = prospects.filter(p => p.status === fromStatus);
                    toChangeStatus.forEach(p => {
                        p.status = toStatus;
                        updateProspectInAirtable(p);
                    });
                    save();
                    needsRefresh = true;
                    break;

                case 'add_note':
                    const prospectN = findProspectByName(action.target);
                    if (prospectN) {
                        prospectN.notes = (prospectN.notes || '') + '\n[' + new Date().toLocaleDateString('fr-FR') + '] ' + action.note;
                        save();
                        updateProspectInAirtable(prospectN);
                    }
                    break;

                case 'create_task':
                    // Créer une nouvelle tâche dans Airtable
                    await createTaskInAirtableWithDetails({
                        title: action.title || action.target,
                        description: action.description || '',
                        priority: action.priority || 'Normal',
                        dueDate: action.dueDate || null,
                        project: action.project || null
                    });
                    needsRefresh = true;
                    break;

                case 'update_task_status':
                    // Mettre à jour le statut d'une tâche existante
                    const task = airtableTasks.find(t =>
                        t.title.toLowerCase().includes(action.target.toLowerCase())
                    );
                    if (task) {
                        await updateTaskStatus(task.id, action.to);
                        needsRefresh = true;
                    }
                    break;

                case 'delete_task':
                    // Supprimer une tâche
                    const taskToDelete = airtableTasks.find(t =>
                        t.title.toLowerCase().includes(action.target.toLowerCase())
                    );
                    if (taskToDelete) {
                        await deleteTaskInAirtable(taskToDelete.id);
                        needsRefresh = true;
                    }
                    break;

                case 'edit_task':
                    const taskToEdit = airtableTasks.find(t =>
                        t.title.toLowerCase().includes(action.target.toLowerCase())
                    );
                    if (taskToEdit) {
                        const fields = action.fields || {};
                        const updates = {};
                        if (fields.priority) { taskToEdit.priority = fields.priority; updates.priorite = fields.priority; }
                        if (fields.description) { taskToEdit.description = fields.description; updates.description = fields.description; }
                        if (fields.dueDate) { taskToEdit.dueDate = fields.dueDate; updates.due_date = fields.dueDate; }
                        if (fields.status) {
                            const statusMap = { 'À faire': 'todo', 'En cours': 'in_progress', 'Bloqué': 'blocked', 'Terminé': 'done' };
                            taskToEdit.status = fields.status;
                            updates.status = statusMap[fields.status] || fields.status;
                        }
                        if (Object.keys(updates).length > 0) {
                            await supabase.updateTask(taskToEdit.id, updates);
                        }
                        needsRefresh = true;
                    }
                    break;

                case 'assign_task':
                    const taskToAssign = airtableTasks.find(t =>
                        t.title.toLowerCase().includes(action.target.toLowerCase())
                    );
                    if (taskToAssign) {
                        const member = teamMembers.find(m =>
                            m.display_name.toLowerCase() === (action.to || '').toLowerCase()
                        );
                        if (member) {
                            taskToAssign.assignee = member.display_name;
                            taskToAssign.assignedTo = member.id;
                            await supabase.updateTask(taskToAssign.id, { assigned_to: member.id });
                            needsRefresh = true;
                        }
                    }
                    break;

                case 'assign_prospect':
                    const prospectToAssign = findProspectByName(action.target);
                    if (prospectToAssign) {
                        if (action.to === null || action.to === 'null' || action.to === '') {
                            prospectToAssign.assignedTo = null;
                            const pid = prospectToAssign.supabaseId || prospectToAssign.id;
                            await supabase.updateProspect(pid, { assigned_to: null });
                        } else {
                            const memberP = teamMembers.find(m =>
                                m.display_name.toLowerCase() === action.to.toLowerCase()
                            );
                            if (memberP) {
                                prospectToAssign.assignedTo = memberP.id;
                                const pid = prospectToAssign.supabaseId || prospectToAssign.id;
                                await supabase.updateProspect(pid, { assigned_to: memberP.id });
                            }
                        }
                        needsRefresh = true;
                    }
                    break;

                case 'none':
                default:
                    // No action needed
                    break;
            }

            // Instant refresh after any data change
            if (needsRefresh) {
                refreshAllViews();
            }
        }

        // ============================================
        // CHATBOT TOOLS / FUNCTIONS
        // ============================================
        // Note: Legacy functions removed (callClaudeAPI, processMessageLocal,
        // buildContextForClaude, parseClaudeAction) - tout passe maintenant
        // par processMessage() qui utilise Claude Sonnet 4.5 directement

        function getStats() {
            const total = prospects.length;
            const byPriority = {
                hot: prospects.filter(p => p.priority === 'hot').length,
                chaud: prospects.filter(p => p.priority === 'chaud').length,
                tiede: prospects.filter(p => p.priority === 'tiede').length,
                froid: prospects.filter(p => p.priority === 'froid').length
            };
            const byStatus = {
                lead: prospects.filter(p => p.status === 'lead').length,
                contacted: prospects.filter(p => p.status === 'contacted').length,
                meeting: prospects.filter(p => p.status === 'meeting').length,
                proposal: prospects.filter(p => p.status === 'proposal').length,
                won: prospects.filter(p => p.status === 'won').length
            };
            const totalPipeline = prospects.reduce((s, p) => s + (p.value || 0), 0);
            const withAssets = prospects.filter(p => p.assets?.length > 0).length;
            const todayFollowups = followups.filter(f => !f.done && f.date <= new Date().toISOString().split('T')[0]).length;

            return {
                text: `Voici les stats de ton pipeline:`,
                data: {
                    type: 'stats',
                    total,
                    byPriority,
                    byStatus,
                    totalPipeline,
                    withAssets,
                    todayFollowups
                }
            };
        }

        function getProspectsByPriority(priority) {
            const list = prospects.filter(p => p.priority === priority);
            const labels = { hot: 'Hot 🔥', chaud: 'Chaud 🌡️', tiede: 'Tiede 😐', froid: 'Froid ❄️' };
            const total = list.reduce((s, p) => s + (p.value || 0), 0);

            return {
                text: `**${list.length} prospects ${labels[priority]}** (${fmtXPF(total)} XPF):`,
                data: { type: 'prospects', prospects: list.slice(0, 8) }
            };
        }

        function getProspectsByStatus(status) {
            const list = prospects.filter(p => p.status === status);
            const labels = { lead: 'Lead', contacted: 'Contacte', meeting: 'RDV/Audit', proposal: 'Proposition', won: 'Gagne' };

            return {
                text: `**${list.length} prospects en "${labels[status]}"**:`,
                data: { type: 'prospects', prospects: list.slice(0, 8) }
            };
        }

        function getProspectDetails(prospect) {
            const prospectNotes = notes[prospect.id] || [];
            const prospectFollowups = followups.filter(f => f.prospectId === prospect.id && !f.done);

            return {
                text: `Voici la fiche de **${prospect.company}**:`,
                data: {
                    type: 'prospect',
                    prospect: {
                        ...prospect,
                        notesCount: prospectNotes.length,
                        followupsCount: prospectFollowups.length
                    }
                }
            };
        }

        function getFollowups() {
            const today = new Date().toISOString().split('T')[0];
            const pending = followups.filter(f => !f.done);
            const todayList = pending.filter(f => f.date <= today);
            const upcoming = pending.filter(f => f.date > today).slice(0, 5);

            if (todayList.length === 0 && upcoming.length === 0) {
                return { text: "Aucun rappel en attente. Tu es a jour! 🎉" };
            }

            const items = [...todayList, ...upcoming].map(f => ({
                ...f,
                prospect: prospects.find(p => p.id === f.prospectId),
                isOverdue: f.date < today,
                isToday: f.date === today
            }));

            return {
                text: `**${todayList.length} rappel(s) aujourd'hui** + ${upcoming.length} a venir:`,
                data: { type: 'followups', followups: items }
            };
        }

        function getProspectsWithAssets() {
            const list = prospects.filter(p => p.assets?.length > 0);
            return {
                text: `**${list.length} prospects avec prototypes/assets crees**:`,
                data: { type: 'prospects', prospects: list }
            };
        }

        function getProspectsBySector(sector) {
            const list = prospects.filter(p => p.sector.toLowerCase().includes(sector.toLowerCase()));
            const total = list.reduce((s, p) => s + (p.value || 0), 0);

            return {
                text: `**${list.length} prospects en ${sector}** (${fmtXPF(total)} XPF):`,
                data: { type: 'prospects', prospects: list.slice(0, 8) }
            };
        }

        function getSectorAnalysis() {
            const sectors = {};
            prospects.forEach(p => {
                if (!sectors[p.sector]) sectors[p.sector] = { count: 0, value: 0 };
                sectors[p.sector].count++;
                sectors[p.sector].value += p.value || 0;
            });

            const sorted = Object.entries(sectors).sort((a, b) => b[1].value - a[1].value);
            const text = sorted.slice(0, 5).map(([s, d]) => `• **${s}**: ${d.count} prospects (${fmtXPF(d.value)})`).join('\n');

            return { text: `Top secteurs par valeur:\n\n${text}` };
        }

        function getTopProspects() {
            const sorted = [...prospects].sort((a, b) => {
                const priorityOrder = { hot: 0, chaud: 1, tiede: 2, froid: 3 };
                const pDiff = (priorityOrder[a.priority] || 99) - (priorityOrder[b.priority] || 99);
                if (pDiff !== 0) return pDiff;
                return (b.value || 0) - (a.value || 0);
            });

            return {
                text: `**Top 8 prospects** (priorite + valeur):`,
                data: { type: 'prospects', prospects: sorted.slice(0, 8) }
            };
        }

        function getHelp() {
            return {
                text: `**Commandes disponibles:**\n\n**LECTURE:**\n• **stats** / **pipeline** - Statistiques generales\n• **prospects hot/chaud/tiede/froid** - Par temperature\n• **prospects lead/contacte/rdv** - Par status\n• **cherche [nom]** - Trouver un prospect\n• **rappels** - Relances du jour\n• **top prospects** - Meilleures opportunites\n• **secteur [nom]** - Analyse sectorielle\n\n**MODIFICATION:**\n• **passe [nom] en [status]** - Changer le status (lead/contacte/rdv/proposition/gagne)\n• **[nom] devient [temp]** - Changer la temperature (hot/chaud/tiede/froid)\n• **note pour [nom]: [texte]** - Ajouter une note\n• **rappel [nom] dans X jours** - Creer un rappel\n• **rappel fait [nom]** - Marquer un rappel comme fait\n\n**AUTRES:**\n• **sync** - Synchroniser Airtable`
            };
        }

        // ============================================
        // CHATBOT MODIFICATION FUNCTIONS
        // ============================================

        function findProspectByName(search) {
            const searchLower = search.toLowerCase().trim();
            // Exact match first
            let prospect = prospects.find(p => p.company.toLowerCase() === searchLower);
            if (prospect) return prospect;
            // Partial match
            prospect = prospects.find(p => p.company.toLowerCase().includes(searchLower));
            if (prospect) return prospect;
            // Word match
            const words = searchLower.split(' ').filter(w => w.length > 2);
            for (const word of words) {
                prospect = prospects.find(p => p.company.toLowerCase().includes(word));
                if (prospect) return prospect;
            }
            return null;
        }

        function changeProspectStatus(companySearch, newStatus) {
            const prospect = findProspectByName(companySearch);
            if (!prospect) {
                return { text: `Je n'ai pas trouve de prospect correspondant a "${companySearch}".` };
            }

            // Normalize status
            const statusMap = {
                'lead': 'lead',
                'contacte': 'contacted', 'contacted': 'contacted',
                'rdv': 'meeting', 'meeting': 'meeting', 'audit': 'meeting',
                'proposition': 'proposal', 'proposal': 'proposal', 'devis': 'proposal',
                'gagne': 'won', 'won': 'won', 'client': 'won'
            };
            const status = statusMap[newStatus.toLowerCase()];
            if (!status) {
                return { text: `Status "${newStatus}" non reconnu. Utilise: lead, contacte, rdv, proposition, gagne.` };
            }

            const oldStatus = prospect.status;
            prospect.status = status;
            save();
            renderProspectsViews();

            // Sync to Airtable
            updateProspectInAirtable(prospect);

            return {
                text: `**${prospect.company}** passe de "${statusLabel(oldStatus)}" a "${statusLabel(status)}"`,
                data: { type: 'prospect', prospect }
            };
        }

        function changeProspectPriority(companySearch, newPriority) {
            const prospect = findProspectByName(companySearch);
            if (!prospect) {
                return { text: `Je n'ai pas trouve de prospect correspondant a "${companySearch}".` };
            }

            const validPriorities = ['hot', 'chaud', 'tiede', 'froid'];
            const priority = newPriority.toLowerCase();
            if (!validPriorities.includes(priority)) {
                return { text: `Temperature "${newPriority}" non reconnue. Utilise: hot, chaud, tiede, froid.` };
            }

            const oldPriority = prospect.priority;
            prospect.priority = priority;
            prospect.priorityUpdatedAt = Date.now();
            save();
            renderProspectsViews();

            // Sync to Airtable
            updateProspectInAirtable(prospect);

            return {
                text: `**${prospect.company}** passe de "${priorityLabel(oldPriority)}" a "${priorityLabel(priority)}"`,
                data: { type: 'prospect', prospect }
            };
        }

        function changeBulkPriority(fromPriority, toPriority) {
            const validPriorities = ['hot', 'chaud', 'tiede', 'froid'];
            if (!validPriorities.includes(fromPriority) || !validPriorities.includes(toPriority)) {
                return { text: `Temperature non reconnue. Utilise: hot, chaud, tiede, froid.` };
            }

            const toChange = prospects.filter(p => p.priority === fromPriority);
            if (toChange.length === 0) {
                return { text: `Aucun prospect "${priorityLabel(fromPriority)}" trouve.` };
            }

            const now = Date.now();
            toChange.forEach(p => {
                p.priority = toPriority;
                p.priorityUpdatedAt = now;
                updateProspectInAirtable(p);
            });

            save();
            renderProspectsViews();

            return {
                text: `**${toChange.length} prospect(s)** passes de "${priorityLabel(fromPriority)}" a "${priorityLabel(toPriority)}":\n${toChange.map(p => `• ${p.company}`).join('\n')}`
            };
        }

        function changeBulkStatus(fromStatus, toStatus) {
            const validStatuses = ['lead', 'contacted', 'meeting', 'proposal', 'won'];
            if (!validStatuses.includes(fromStatus) || !validStatuses.includes(toStatus)) {
                return { text: `Status non reconnu. Utilise: lead, contacte, rdv, proposition, gagne.` };
            }

            const toChange = prospects.filter(p => p.status === fromStatus);
            if (toChange.length === 0) {
                return { text: `Aucun prospect avec status "${statusLabel(fromStatus)}" trouve.` };
            }

            toChange.forEach(p => {
                p.status = toStatus;
                updateProspectInAirtable(p);
            });

            save();
            renderProspectsViews();

            return {
                text: `**${toChange.length} prospect(s)** passes de "${statusLabel(fromStatus)}" a "${statusLabel(toStatus)}":\n${toChange.map(p => `• ${p.company}`).join('\n')}`
            };
        }

        function addNoteToProspect(companySearch, noteText) {
            const prospect = findProspectByName(companySearch);
            if (!prospect) {
                return { text: `Je n'ai pas trouve de prospect correspondant a "${companySearch}".` };
            }

            if (!noteText || noteText.trim().length < 2) {
                return { text: `Le texte de la note est trop court ou vide.` };
            }

            // Add note
            if (!notes[prospect.id]) notes[prospect.id] = [];
            const note = {
                id: Date.now(),
                text: noteText.trim(),
                date: new Date().toISOString()
            };
            notes[prospect.id].unshift(note);
            localStorage.setItem('pk_notes', JSON.stringify(notes));

            return {
                text: `Note ajoutee pour **${prospect.company}**:\n"${noteText.trim()}"`,
                data: { type: 'prospect', prospect: { ...prospect, notesCount: notes[prospect.id].length } }
            };
        }

        function addReminderToProspect(message) {
            const msg = message.toLowerCase();

            // Find prospect name in message
            let prospect = null;
            for (const p of prospects) {
                const words = p.company.toLowerCase().split(' ');
                if (words.some(w => w.length > 3 && msg.includes(w))) {
                    prospect = p;
                    break;
                }
            }

            if (!prospect) {
                return { text: `Je n'ai pas trouve de prospect dans ta demande. Essaie: "rappel Air Tahiti dans 3 jours"` };
            }

            // Parse date
            let date = new Date();
            if (msg.includes('demain')) {
                date.setDate(date.getDate() + 1);
            } else if (msg.includes('apres-demain') || msg.includes('apres demain')) {
                date.setDate(date.getDate() + 2);
            } else if (msg.includes('semaine')) {
                date.setDate(date.getDate() + 7);
            } else {
                // "dans X jours"
                const daysMatch = msg.match(/dans\s+(\d+)\s*(?:jour|j)/);
                if (daysMatch) {
                    date.setDate(date.getDate() + parseInt(daysMatch[1]));
                } else {
                    date.setDate(date.getDate() + 3); // Default 3 days
                }
            }

            // Extract note if any (after "pour" or ":")
            let noteText = '';
            const noteMatch = message.match(/(?:pour|:)\s+(.+)$/i);
            if (noteMatch) noteText = noteMatch[1].trim();

            // Create followup
            const followup = {
                id: Date.now(),
                prospectId: prospect.id,
                date: date.toISOString().split('T')[0],
                note: noteText || `Relancer ${prospect.company}`,
                done: false
            };
            followups.push(followup);
            localStorage.setItem('pk_followups', JSON.stringify(followups));
            renderFollowups();

            const dateStr = date.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
            return {
                text: `Rappel cree pour **${prospect.company}** le **${dateStr}**${noteText ? `\nNote: "${noteText}"` : ''}`
            };
        }

        function markFollowupDoneChat(prospectId) {
            const pendingFollowups = followups.filter(f => f.prospectId === prospectId && !f.done);
            if (pendingFollowups.length === 0) {
                const prospect = prospects.find(p => p.id === prospectId);
                return { text: `Aucun rappel en attente pour ${prospect?.company || 'ce prospect'}.` };
            }

            // Mark the most recent/urgent one as done
            const today = new Date().toISOString().split('T')[0];
            const urgent = pendingFollowups.find(f => f.date <= today) || pendingFollowups[0];
            urgent.done = true;
            localStorage.setItem('pk_followups', JSON.stringify(followups));
            renderFollowups();

            const prospect = prospects.find(p => p.id === prospectId);
            return {
                text: `Rappel marque comme fait pour **${prospect?.company}**`
            };
        }

        // ============================================
        // CONTENT CALENDAR (FACEBOOK)
        // ============================================

        let facebookPosts = [];
        let currentCalendarMonth = new Date();
        let selectedPostType = 'ai-news';
        const N8N_WEBHOOK_URL = 'https://n8n.srv1140766.hstgr.cloud/webhook/';
        const FACEBOOK_WORKFLOW_ID = 'hZotr6emniXBXMO4';

        // Load posts from localStorage
        function loadFacebookPosts() {
            const stored = localStorage.getItem('pk_facebook_posts');
            if (stored) facebookPosts = JSON.parse(stored);
            renderCalendar();
            renderPostsList();
            updateContentStats();
        }

        function saveFacebookPosts() {
            localStorage.setItem('pk_facebook_posts', JSON.stringify(facebookPosts));
        }

        function updateContentStats() {
            // Use Airtable content if available, otherwise fall back to localStorage
            const posts = airtableContent.length > 0 ? airtableContent : facebookPosts;

            const scheduled = posts.filter(p => p.status === 'Planifié' || p.status === 'scheduled').length;
            const published = posts.filter(p => p.status === 'Publié' || p.status === 'published').length;
            const total = posts.length;
            const totalEngagement = posts.reduce((sum, p) => sum + (p.engagement || 0), 0);

            // Update KPIs
            const kpiTotal = document.getElementById('kpi-total-posts');
            const kpiScheduled = document.getElementById('kpi-scheduled');
            const kpiPublished = document.getElementById('kpi-published');
            const kpiEngagement = document.getElementById('kpi-engagement');

            if (kpiTotal) kpiTotal.textContent = total;
            if (kpiScheduled) kpiScheduled.textContent = scheduled;
            if (kpiPublished) kpiPublished.textContent = published;
            if (kpiEngagement) kpiEngagement.textContent = totalEngagement.toLocaleString('fr-FR');

            // Update funnel KPIs
            const tofu = posts.filter(p => p.funnelStage?.includes('TOFU')).length;
            const mofu = posts.filter(p => p.funnelStage?.includes('MOFU')).length;
            const bofu = posts.filter(p => p.funnelStage?.includes('BOFU')).length;

            const kpiTofu = document.getElementById('kpi-tofu');
            const kpiMofu = document.getElementById('kpi-mofu');
            const kpiBofu = document.getElementById('kpi-bofu');

            if (kpiTofu) kpiTofu.textContent = tofu;
            if (kpiMofu) kpiMofu.textContent = mofu;
            if (kpiBofu) kpiBofu.textContent = bofu;

            // Update nav badge
            const navCount = document.getElementById('nav-content-count');
            if (navCount) navCount.textContent = scheduled;
        }

        // ============================================
        // AIRTABLE CONTENT MANAGEMENT
        // ============================================

        async function loadContentFromAirtable() {
            try {
                const url = `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${CONTENT_TABLE_ID}?sort%5B0%5D%5Bfield%5D=Date%20publication&sort%5B0%5D%5Bdirection%5D=desc`;

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}` }
                });

                if (!response.ok) throw new Error('Airtable fetch failed');

                const data = await response.json();

                airtableContent = data.records.map(record => ({
                    id: record.id,
                    titre: record.fields['Titre'] || '',
                    contenu: record.fields['Contenu'] || '',
                    type: record.fields['Type'] || '',
                    date: record.fields['Date publication'] || '',
                    status: record.fields['Status'] || 'Brouillon',
                    engagement: record.fields['Engagement'] || 0,
                    imageUrl: record.fields['Image URL'] || '',
                    platforms: record.fields['Plateforme'] || [],
                    funnelStage: record.fields['Funnel Stage'] || '',
                    semaine: record.fields['Semaine'] || null
                }));

                console.log(`[Content Calendar] Loaded ${airtableContent.length} posts from Airtable`);

                renderContentList();
                renderCalendar();
                updateContentStats();
                showToast(`${airtableContent.length} posts charges depuis Airtable`);

            } catch (error) {
                console.error('[Content Calendar] Error loading from Airtable:', error);
                // Pas de toast - erreur non-bloquante, les donnees Supabase sont la source principale
            }
        }

        function filterContent() {
            const platformFilter = document.getElementById('content-platform-filter')?.value || 'all';
            const statusFilter = document.getElementById('content-status-filter')?.value || 'all';

            currentPlatformFilter = platformFilter;
            currentContentFilter = statusFilter;

            renderContentList();
        }

        function renderContentList(filter = null) {
            const container = document.getElementById('posts-list-content');
            if (!container) return;

            // Apply filters
            let posts = [...airtableContent];

            // Platform filter
            if (currentPlatformFilter && currentPlatformFilter !== 'all') {
                posts = posts.filter(p => p.platforms.includes(currentPlatformFilter));
            }

            // Status filter from header
            if (currentContentFilter && currentContentFilter !== 'all') {
                posts = posts.filter(p => p.status === currentContentFilter);
            }

            // Tab filter
            if (filter && filter !== 'all') {
                posts = posts.filter(p => p.status === filter);
            }

            // Sort by date desc
            posts.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));

            if (posts.length === 0) {
                container.innerHTML = `<div style="text-align: center; color: var(--text-dim); padding: 2rem;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 32px; height: 32px; margin-bottom: 0.5rem;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                    <p>Aucun post</p>
                </div>`;
                return;
            }

            container.innerHTML = posts.slice(0, 15).map(post => `
                <div class="post-item" onclick="openEditContentModal('${post.id}')">
                    <div class="post-item-header">
                        <div style="display: flex; gap: 0.25rem; flex-wrap: wrap;">
                            ${post.platforms.map(p => `<span class="platform-badge ${p.toLowerCase()}">${p}</span>`).join('')}
                            ${post.funnelStage ? `<span class="funnel-badge ${post.funnelStage.toLowerCase().includes('tofu') ? 'tofu' : post.funnelStage.toLowerCase().includes('mofu') ? 'mofu' : 'bofu'}">${post.funnelStage.split(' - ')[0]}</span>` : ''}
                        </div>
                        <div class="content-item-actions">
                            <button class="content-action-btn" onclick="event.stopPropagation(); previewContentById('${post.id}')" title="Previsualiser">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                            </button>
                            <button class="content-action-btn delete" onclick="event.stopPropagation(); deleteContentPost('${post.id}')" title="Supprimer">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                            </button>
                        </div>
                    </div>
                    <div style="font-size: 0.75rem; font-weight: 600; margin-bottom: 0.25rem; color: var(--text);">${post.titre || 'Sans titre'}</div>
                    <div class="post-item-preview">${post.contenu?.substring(0, 100) || 'Contenu vide'}...</div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
                        <span class="post-item-date">${post.date ? formatPostDate(post.date) : 'Non planifie'}</span>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            ${post.engagement ? `<span style="font-size: 0.625rem; color: var(--orange);">❤️ ${post.engagement}</span>` : ''}
                            <span class="post-item-status ${post.status === 'Planifié' ? 'scheduled' : post.status === 'Publié' ? 'published' : 'draft'}">${post.status}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function openEditContentModal(contentId) {
            const post = airtableContent.find(p => p.id === contentId);
            if (!post) return;

            editingContentId = contentId;

            document.getElementById('edit-content-id').value = contentId;
            document.getElementById('edit-content-titre').value = post.titre || '';
            document.getElementById('edit-content-contenu').value = post.contenu || '';
            document.getElementById('edit-content-type').value = post.type || 'Actualité IA';
            document.getElementById('edit-content-status').value = post.status || 'Brouillon';
            document.getElementById('edit-content-date').value = post.date || '';
            document.getElementById('edit-content-engagement').value = post.engagement || '';
            document.getElementById('edit-content-image').value = post.imageUrl || '';
            document.getElementById('edit-content-funnel').value = post.funnelStage || '';
            document.getElementById('edit-content-semaine').value = post.semaine || '';

            // Handle multi-select platforms
            const platformSelect = document.getElementById('edit-content-platform');
            Array.from(platformSelect.options).forEach(opt => {
                opt.selected = post.platforms.includes(opt.value);
            });

            document.getElementById('edit-content-title').textContent = 'Modifier: ' + (post.titre || 'Sans titre');
            document.getElementById('edit-content-modal').style.display = 'flex';
        }

        function openCreateContentModal() {
            editingContentId = null;

            document.getElementById('edit-content-id').value = '';
            document.getElementById('edit-content-titre').value = '';
            document.getElementById('edit-content-contenu').value = '';
            document.getElementById('edit-content-type').value = 'Actualité IA';
            document.getElementById('edit-content-status').value = 'Brouillon';
            document.getElementById('edit-content-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('edit-content-engagement').value = '';
            document.getElementById('edit-content-image').value = '';
            document.getElementById('edit-content-funnel').value = 'TOFU - Awareness';
            document.getElementById('edit-content-semaine').value = '';

            // Reset platform select
            const platformSelect = document.getElementById('edit-content-platform');
            Array.from(platformSelect.options).forEach(opt => {
                opt.selected = opt.value === 'Facebook';
            });

            document.getElementById('edit-content-title').textContent = 'Nouveau Post';
            document.getElementById('edit-content-modal').style.display = 'flex';
        }

        function closeEditContentModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('edit-content-modal').style.display = 'none';
            editingContentId = null;
        }

        async function saveContentPost() {
            const id = document.getElementById('edit-content-id').value;
            const titre = document.getElementById('edit-content-titre').value;
            const contenu = document.getElementById('edit-content-contenu').value;
            const type = document.getElementById('edit-content-type').value;
            const status = document.getElementById('edit-content-status').value;
            const date = document.getElementById('edit-content-date').value;
            const engagement = parseInt(document.getElementById('edit-content-engagement').value) || 0;
            const imageUrl = document.getElementById('edit-content-image').value;
            const funnelStage = document.getElementById('edit-content-funnel').value;
            const semaine = parseInt(document.getElementById('edit-content-semaine').value) || null;

            // Get selected platforms
            const platformSelect = document.getElementById('edit-content-platform');
            const platforms = Array.from(platformSelect.selectedOptions).map(opt => opt.value);

            const fields = {
                'Titre': titre,
                'Contenu': contenu,
                'Type': type,
                'Status': status,
                'Engagement': engagement
            };

            if (date) fields['Date publication'] = date;
            if (imageUrl) fields['Image URL'] = imageUrl;
            if (platforms.length > 0) fields['Plateforme'] = platforms;
            if (funnelStage) fields['Funnel Stage'] = funnelStage;
            if (semaine) fields['Semaine'] = semaine;

            try {
                let url, method;
                if (id) {
                    // Update existing
                    url = `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${CONTENT_TABLE_ID}/${id}`;
                    method = 'PATCH';
                } else {
                    // Create new
                    url = `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${CONTENT_TABLE_ID}`;
                    method = 'POST';
                }

                const body = id ? { fields } : { records: [{ fields }] };

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                if (!response.ok) throw new Error('Airtable save failed');

                closeEditContentModal();
                showToast(id ? 'Post mis a jour!' : 'Post cree!');

                // Reload content
                await loadContentFromAirtable();

            } catch (error) {
                console.error('[Content Calendar] Save error:', error);
                showToast('Erreur sauvegarde');
            }
        }

        async function createContentPost() {
            const contenu = document.getElementById('post-content').value.trim();
            const type = selectedPostType;
            const platform = document.getElementById('post-platform').value;
            const funnelStage = document.getElementById('post-funnel').value;
            const date = document.getElementById('post-date').value;

            if (!contenu) {
                showToast('Ecris du contenu avant de creer');
                return;
            }

            const fields = {
                'Titre': contenu.substring(0, 50) + (contenu.length > 50 ? '...' : ''),
                'Contenu': contenu,
                'Type': type,
                'Status': 'Planifié',
                'Plateforme': [platform],
                'Funnel Stage': funnelStage
            };

            if (date) fields['Date publication'] = date;

            try {
                const response = await fetch(`https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${CONTENT_TABLE_ID}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ records: [{ fields }] })
                });

                if (!response.ok) throw new Error('Create failed');

                // Clear form
                document.getElementById('post-content').value = '';
                showToast('Post cree dans Airtable!');

                await loadContentFromAirtable();

            } catch (error) {
                console.error('[Content Calendar] Create error:', error);
                showToast('Erreur creation');
            }
        }

        async function deleteContentPost(contentId) {
            if (!confirm('Supprimer ce post?')) return;

            try {
                const response = await fetch(`https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${CONTENT_TABLE_ID}/${contentId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`
                    }
                });

                if (!response.ok) throw new Error('Delete failed');

                showToast('Post supprime');
                await loadContentFromAirtable();

            } catch (error) {
                console.error('[Content Calendar] Delete error:', error);
                showToast('Erreur suppression');
            }
        }

        function previewContentById(contentId) {
            const post = airtableContent.find(p => p.id === contentId);
            if (!post) return;

            const platform = post.platforms[0] || 'Facebook';
            document.getElementById('preview-platform-name').textContent = platform;
            document.getElementById('preview-content').textContent = post.contenu || 'Contenu vide';
            document.getElementById('preview-date').textContent = post.date ? formatPostDate(post.date) : 'Non planifie';

            document.getElementById('content-preview-modal').style.display = 'flex';
        }

        function previewContentPost() {
            const contenu = document.getElementById('edit-content-contenu').value;
            const date = document.getElementById('edit-content-date').value;
            const platformSelect = document.getElementById('edit-content-platform');
            const platform = Array.from(platformSelect.selectedOptions)[0]?.value || 'Facebook';

            document.getElementById('preview-platform-name').textContent = platform;
            document.getElementById('preview-content').textContent = contenu || 'Contenu vide';
            document.getElementById('preview-date').textContent = date ? formatPostDate(date) : 'Non planifie';

            document.getElementById('content-preview-modal').style.display = 'flex';
        }

        function closeContentPreview(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('content-preview-modal').style.display = 'none';
        }

        // Generate a full week of content using Claude API
        async function generateWeeklyContent() {
            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<svg class="spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg> Generation...';
            btn.disabled = true;

            try {
                // Calculate next week number and dates
                const today = new Date();
                const startOfYear = new Date(today.getFullYear(), 0, 1);
                const currentWeek = Math.ceil((((today - startOfYear) / 86400000) + startOfYear.getDay() + 1) / 7);

                // Find max week in existing content
                let maxWeek = currentWeek;
                airtableContent.forEach(item => {
                    if (item.semaine && item.semaine > maxWeek) maxWeek = item.semaine;
                });
                const targetWeek = maxWeek + 1;

                // Calculate dates for next week (Mon-Fri)
                const getNextMonday = (date) => {
                    const d = new Date(date);
                    const day = d.getDay();
                    const diff = d.getDate() - day + (day === 0 ? 1 : 8);
                    // If we already have content for this week, skip to next
                    const weeksAhead = targetWeek - currentWeek;
                    d.setDate(diff + (weeksAhead * 7));
                    return d;
                };

                const monday = getNextMonday(today);
                const dates = [];
                for (let i = 0; i < 5; i++) {
                    const d = new Date(monday);
                    d.setDate(monday.getDate() + i);
                    dates.push(d.toISOString().split('T')[0]);
                }

                // Content plan for the week
                const contentPlan = [
                    { day: 'Lundi', date: dates[0], platform: 'LinkedIn', funnel: 'TOFU - Awareness', type: 'Actualité IA', topic: 'actualite IA recente et son impact pour les PME polynesiennes' },
                    { day: 'Mardi', date: dates[1], platform: 'Facebook', funnel: 'MOFU - Consideration', type: 'Cas client', topic: 'cas client fictif mais realiste montrant les resultats concrets de PACIFIKAI' },
                    { day: 'Mercredi', date: dates[2], platform: 'LinkedIn', funnel: 'TOFU - Awareness', type: 'Tips', topic: 'conseil pratique sur l\'automatisation pour les entrepreneurs' },
                    { day: 'Jeudi', date: dates[3], platform: 'Facebook', funnel: 'BOFU - Conversion', type: 'Promo', topic: 'appel a l\'action pour un audit gratuit ou une demo PACIFIKAI' },
                    { day: 'Vendredi', date: dates[4], platform: 'LinkedIn', funnel: 'MOFU - Consideration', type: 'Behind the scenes', topic: 'coulisses de PACIFIKAI, ce qu\'on construit, notre vision' }
                ];

                showToast(`Generation de 5 posts pour la semaine ${targetWeek}...`);

                let createdCount = 0;
                for (const plan of contentPlan) {
                    try {
                        // Generate content with Claude
                        const prompt = `Tu es le community manager de PACIFIK'AI, leader de l'automatisation IA en Polynesie francaise. Le fondateur est Jordy Banks, base a Tahiti.

Genere un post ${plan.platform} professionnel sur le sujet suivant: ${plan.topic}

REGLES:
- Plateforme: ${plan.platform}
- Type: ${plan.type}
- Funnel stage: ${plan.funnel}
- Longueur: 200-300 mots pour LinkedIn, 150-250 pour Facebook
- Ton: Professionnel mais accessible, oriente action
- Inclus 3-5 hashtags pertinents a la fin
- Inclus un appel a l'action ou une question engageante
- Mentionne Polynesie/Tahiti au moins une fois pour l'ancrage local

FORMAT DE REPONSE (JSON strict):
{
  "titre": "Titre accrocheur (max 60 caracteres)",
  "contenu": "Le texte complet du post avec emojis pertinents"
}

Reponds UNIQUEMENT avec le JSON, sans texte supplementaire.`;

                        const response = await fetch('https://api.anthropic.com/v1/messages', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'x-api-key': CLAUDE_CONFIG.apiKey,
                                'anthropic-version': '2023-06-01',
                                'anthropic-dangerous-direct-browser-access': 'true'
                            },
                            body: JSON.stringify({
                                model: CLAUDE_CONFIG.model,
                                max_tokens: 1000,
                                messages: [{ role: 'user', content: prompt }]
                            })
                        });

                        if (!response.ok) throw new Error('Claude API error');

                        const data = await response.json();
                        const text = data.content[0].text;

                        // Parse JSON from Claude response
                        const jsonMatch = text.match(/\{[\s\S]*\}/);
                        let content;
                        if (jsonMatch) {
                            content = JSON.parse(jsonMatch[0]);
                        } else {
                            content = { titre: `Post ${plan.day}`, contenu: text };
                        }

                        // Create in Airtable
                        const fields = {
                            'Titre': content.titre,
                            'Contenu': content.contenu,
                            'Type': plan.type,
                            'Date publication': plan.date,
                            'Status': 'Planifié',
                            'Plateforme': [plan.platform],
                            'Funnel Stage': plan.funnel,
                            'Semaine': targetWeek
                        };

                        await fetch(`https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${CONTENT_TABLE_ID}`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ records: [{ fields }] })
                        });

                        createdCount++;
                        console.log(`[Content Generator] Created post for ${plan.day}`);

                    } catch (err) {
                        console.error(`[Content Generator] Error for ${plan.day}:`, err);
                    }
                }

                // Reload content
                await loadContentFromAirtable();
                showToast(`${createdCount} posts crees pour la semaine ${targetWeek}!`);

            } catch (error) {
                console.error('[Content Generator] Error:', error);
                showToast('Erreur generation');
            }

            btn.innerHTML = originalText;
            btn.disabled = false;
        }

        function renderCalendar() {
            const container = document.getElementById('calendar-days');
            const monthYear = document.getElementById('calendar-month-year');

            const year = currentCalendarMonth.getFullYear();
            const month = currentCalendarMonth.getMonth();

            const monthNames = ['Janvier', 'Fevrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Aout', 'Septembre', 'Octobre', 'Novembre', 'Decembre'];
            monthYear.textContent = `${monthNames[month]} ${year}`;

            // First day of month (0 = Sunday, we need Monday = 0)
            const firstDay = new Date(year, month, 1);
            let startDay = firstDay.getDay() - 1;
            if (startDay < 0) startDay = 6;

            // Days in month
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Today
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];

            let html = '';

            // Previous month padding
            const prevMonth = new Date(year, month, 0);
            const prevDays = prevMonth.getDate();
            for (let i = startDay - 1; i >= 0; i--) {
                const day = prevDays - i;
                html += `<div class="calendar-day other-month"><span class="calendar-day-number">${day}</span></div>`;
            }

            // Current month - use Airtable content if available
            const posts = airtableContent.length > 0 ? airtableContent : facebookPosts;

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = dateStr === todayStr;
                const dayPosts = posts.filter(p => p.date === dateStr);
                const hasPost = dayPosts.length > 0;
                const isPublished = dayPosts.some(p => p.status === 'Publié' || p.status === 'published');

                let classes = 'calendar-day';
                if (isToday) classes += ' today';
                if (hasPost) classes += ' has-post';
                if (isPublished) classes += ' published';

                const preview = dayPosts.length > 0 ? `${dayPosts.length} post(s): ${dayPosts[0].titre || dayPosts[0].preview || ''}` : '';

                html += `<div class="${classes}" onclick="selectCalendarDay('${dateStr}')" title="${preview}">
                    <span class="calendar-day-number">${day}</span>
                    ${hasPost ? `<span style="position: absolute; top: 2px; right: 2px; font-size: 0.5rem; color: var(--text-dim);">${dayPosts.length}</span>` : ''}
                </div>`;
            }

            // Next month padding
            const totalCells = startDay + daysInMonth;
            const remaining = 7 - (totalCells % 7);
            if (remaining < 7) {
                for (let i = 1; i <= remaining; i++) {
                    html += `<div class="calendar-day other-month"><span class="calendar-day-number">${i}</span></div>`;
                }
            }

            container.innerHTML = html;
        }

        function navigateCalendar(direction) {
            if (direction === 0) {
                currentCalendarMonth = new Date();
            } else {
                currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + direction);
            }
            renderCalendar();
        }

        function selectCalendarDay(dateStr) {
            document.getElementById('post-date').value = dateStr;

            // Check Airtable content first
            const airtablePost = airtableContent.find(p => p.date === dateStr);
            if (airtablePost) {
                document.getElementById('post-content').value = airtablePost.contenu || '';
                // Open the edit modal for this post
                openEditContentModal(airtablePost.id);
                return;
            }

            // Fallback to localStorage posts
            const localPost = facebookPosts.find(p => p.date === dateStr);
            if (localPost) {
                document.getElementById('post-content').value = localPost.content;
            }
        }

        function renderPostsList(filter = 'all') {
            const container = document.getElementById('posts-list-content');
            let posts = [...facebookPosts].sort((a, b) => new Date(b.date) - new Date(a.date));

            if (filter !== 'all') {
                posts = posts.filter(p => p.status === filter);
            }

            if (posts.length === 0) {
                container.innerHTML = `<div style="text-align: center; color: var(--text-dim); padding: 2rem;">Aucun post</div>`;
                return;
            }

            container.innerHTML = posts.slice(0, 10).map(post => `
                <div class="post-item" onclick="editPost('${post.id}')">
                    <div class="post-item-header">
                        <span class="post-item-date">${formatPostDate(post.date)} ${post.time || '08:00'}</span>
                        <span class="post-item-status ${post.status}">${post.status === 'scheduled' ? 'Planifie' : post.status === 'published' ? 'Publie' : 'Brouillon'}</span>
                    </div>
                    <div class="post-item-preview">${post.preview || post.content.substring(0, 100)}...</div>
                    ${post.imageUrl ? `<img class="post-item-image" src="${post.imageUrl}" alt="Post image" />` : ''}
                </div>
            `).join('');
        }

        function formatPostDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' });
        }

        function editPost(postId) {
            const post = facebookPosts.find(p => p.id === postId);
            if (!post) return;
            document.getElementById('post-content').value = post.content;
            document.getElementById('post-date').value = post.date;
            document.getElementById('post-time').value = post.time || '08:00';
            document.getElementById('post-content').dataset.editId = postId;
        }

        async function generatePostWithAI() {
            const btn = document.querySelector('.ai-generate-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<svg class="spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg> Generation...';
            btn.disabled = true;

            const postType = selectedPostType;
            let prompt = '';

            switch (postType) {
                case 'ai-news':
                    prompt = `Tu es le community manager de PACIFIK'AI, une agence d'automatisation IA en Polynesie francaise.
Ecris un post Facebook engageant (max 280 caracteres) sur une actualite IA recente qui pourrait interesser les entrepreneurs polynesiens.
Le post doit:
- Etre en francais
- Avoir un angle local/pratique
- Inciter a l'engagement (question ou CTA)
- Inclure 2-3 hashtags pertinents

Reponds UNIQUEMENT avec le texte du post, sans guillemets ni explications.`;
                    break;
                case 'case-study':
                    prompt = `Tu es le community manager de PACIFIK'AI.
Ecris un post Facebook (max 300 caracteres) presentant un cas d'usage fictif mais realiste d'une entreprise polynesienne qui a automatise une tache avec l'IA.
Exemples de secteurs: restaurant, hotel, cabinet comptable, importateur, garage auto.
Le post doit montrer un resultat concret (temps gagne, erreurs evitees, client satisfait).
Termine par une question pour engager.

Reponds UNIQUEMENT avec le texte du post.`;
                    break;
                case 'tip':
                    prompt = `Tu es le community manager de PACIFIK'AI.
Ecris un post Facebook court (max 250 caracteres) donnant un conseil pratique aux entrepreneurs sur l'automatisation ou l'IA.
Le conseil doit etre actionnable et simple.
Inclus un emoji pertinent au debut.

Reponds UNIQUEMENT avec le texte du post.`;
                    break;
            }

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': CLAUDE_CONFIG.apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: CLAUDE_CONFIG.model,
                        max_tokens: 500,
                        messages: [{ role: 'user', content: prompt }]
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('post-content').value = data.content[0].text;
                } else {
                    throw new Error('API error');
                }
            } catch (error) {
                console.error('AI generation error:', error);
                document.getElementById('post-content').value = "Erreur de generation. Ecris ton post manuellement.";
            }

            btn.innerHTML = originalText;
            btn.disabled = false;
        }

        function schedulePost() {
            const content = document.getElementById('post-content').value.trim();
            const date = document.getElementById('post-date').value;
            const time = document.getElementById('post-time').value;
            const editId = document.getElementById('post-content').dataset.editId;

            if (!content) {
                alert('Ecris ou genere du contenu avant de planifier.');
                return;
            }

            if (!date) {
                alert('Selectionne une date de publication.');
                return;
            }

            if (editId) {
                // Update existing
                const post = facebookPosts.find(p => p.id === editId);
                if (post) {
                    post.content = content;
                    post.date = date;
                    post.time = time;
                    post.preview = content.substring(0, 80);
                }
                delete document.getElementById('post-content').dataset.editId;
            } else {
                // Create new
                const post = {
                    id: Date.now().toString(),
                    content,
                    date,
                    time,
                    status: 'scheduled',
                    preview: content.substring(0, 80),
                    type: selectedPostType,
                    createdAt: new Date().toISOString()
                };
                facebookPosts.push(post);
            }

            saveFacebookPosts();
            renderCalendar();
            renderPostsList();
            updateContentStats();

            // Clear form
            document.getElementById('post-content').value = '';
            showToast('Post planifie!');
        }

        async function triggerFacebookWorkflow() {
            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<svg class="spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg> Execution...';
            btn.disabled = true;

            try {
                // Activate workflow if not active
                const activateResponse = await fetch(`https://n8n.srv1140766.hstgr.cloud/api/v1/workflows/${FACEBOOK_WORKFLOW_ID}/activate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                // For manual trigger, we'd need a webhook endpoint
                // For now, show a message
                showToast('Workflow lance! Verifie n8n pour le statut.');

            } catch (error) {
                console.error('Workflow trigger error:', error);
                showToast('Erreur - Ouvre n8n manuellement');
            }

            btn.innerHTML = originalText;
            btn.disabled = false;
        }

        // Post type selection
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('post-option')) {
                document.querySelectorAll('.post-option').forEach(o => o.classList.remove('active'));
                e.target.classList.add('active');
                selectedPostType = e.target.dataset.type;
            }

            if (e.target.classList.contains('posts-list-tab')) {
                document.querySelectorAll('.posts-list-tab').forEach(t => t.classList.remove('active'));
                e.target.classList.add('active');
                renderPostsList(e.target.dataset.filter);
            }
        });

        // Initialize date input and load content from Airtable
        document.addEventListener('DOMContentLoaded', function() {
            const dateInput = document.getElementById('post-date');
            if (dateInput) {
                dateInput.value = new Date().toISOString().split('T')[0];
            }
            // Load from Airtable first, then fallback to localStorage
            loadContentFromAirtable().catch(() => {
                loadFacebookPosts();
            });
        });

        // Posts list tab click handler (for Airtable content)
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('posts-list-tab')) {
                document.querySelectorAll('.posts-list-tab').forEach(t => t.classList.remove('active'));
                e.target.classList.add('active');
                const filter = e.target.dataset.filter;
                // Use Airtable render if we have data
                if (airtableContent.length > 0) {
                    renderContentList(filter);
                } else {
                    renderPostsList(filter);
                }
            }
        });

        // ============================================
        // CHATBOT RENDER HELPERS
        // ============================================

        function renderStatsCard(data) {
            return `
                <div class="chat-data-card">
                    <div class="chat-data-row">
                        <span class="chat-data-label">Total prospects</span>
                        <span class="chat-data-value">${data.total}</span>
                    </div>
                    <div class="chat-data-row">
                        <span class="chat-data-label">Pipeline total</span>
                        <span class="chat-data-value" style="color: var(--green);">${fmtXPF(data.totalPipeline)} XPF</span>
                    </div>
                    <div class="chat-data-row">
                        <span class="chat-data-label">Par temperature</span>
                        <span class="chat-data-value">🔥${data.byPriority.hot} 🌡️${data.byPriority.chaud} 😐${data.byPriority.tiede} ❄️${data.byPriority.froid}</span>
                    </div>
                    <div class="chat-data-row">
                        <span class="chat-data-label">Avec assets</span>
                        <span class="chat-data-value">${data.withAssets} prospects</span>
                    </div>
                    <div class="chat-data-row">
                        <span class="chat-data-label">Rappels aujourd'hui</span>
                        <span class="chat-data-value" style="color: ${data.todayFollowups > 0 ? 'var(--orange)' : 'var(--green)'};">${data.todayFollowups}</span>
                    </div>
                </div>
            `;
        }

        function renderProspectsList(list) {
            return `
                <div class="chat-prospect-list">
                    ${list.map(p => `
                        <div class="chat-prospect-item" onclick="openProspectDetail('${p.id}'); toggleChatbot();">
                            <div>
                                <div class="chat-prospect-name">${p.company} ${p.assets?.length ? renderAssetIcons(p.assets) : ''}</div>
                                <div class="chat-prospect-meta">${p.sector} • ${fmtXPF(p.value)}</div>
                            </div>
                            <span class="badge ${p.priority}" style="font-size: 0.5625rem;">${priorityLabel(p.priority)}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderProspectCard(p) {
            return `
                <div class="chat-data-card">
                    <div class="chat-data-header">
                        <span class="chat-data-title">${p.company}</span>
                        <span class="badge ${p.priority}" style="font-size: 0.5625rem;">${priorityLabel(p.priority)}</span>
                    </div>
                    <div class="chat-data-row">
                        <span class="chat-data-label">Contact</span>
                        <span class="chat-data-value">${p.name || '-'}</span>
                    </div>
                    <div class="chat-data-row">
                        <span class="chat-data-label">Secteur</span>
                        <span class="chat-data-value">${p.sector}</span>
                    </div>
                    <div class="chat-data-row">
                        <span class="chat-data-label">Status</span>
                        <span class="chat-data-value">${statusLabel(p.status)}</span>
                    </div>
                    <div class="chat-data-row">
                        <span class="chat-data-label">Valeur</span>
                        <span class="chat-data-value" style="color: var(--green);">${fmtXPF(p.value)} XPF</span>
                    </div>
                    ${p.assets?.length ? `
                    <div class="chat-data-row">
                        <span class="chat-data-label">Assets</span>
                        <span class="chat-data-value">${renderAssetIcons(p.assets)}</span>
                    </div>
                    ` : ''}
                    <div class="chat-data-row">
                        <span class="chat-data-label">Notes</span>
                        <span class="chat-data-value">${p.notesCount || 0}</span>
                    </div>
                    <div class="chat-actions">
                        <button class="chat-action-btn" onclick="openProspectDetail('${p.id}'); toggleChatbot();">Ouvrir fiche</button>
                    </div>
                </div>
            `;
        }

        function renderFollowupsList(list) {
            return `
                <div class="chat-prospect-list">
                    ${list.map(f => `
                        <div class="chat-prospect-item" onclick="openProspectDetail('${f.prospectId}'); toggleChatbot();">
                            <div>
                                <div class="chat-prospect-name">${f.prospect?.company || 'Inconnu'}</div>
                                <div class="chat-prospect-meta">${f.note || 'Relancer'}</div>
                            </div>
                            <span class="followup-badge ${f.isOverdue ? 'overdue' : f.isToday ? 'today' : 'upcoming'}">
                                ${f.isOverdue ? 'En retard' : f.isToday ? "Aujourd'hui" : fmtDate(f.date)}
                            </span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Update drag handlers to add notifications (Supabase sync is already in original functions)
        const originalHandleStatusDrop = handleStatusDrop;
        handleStatusDrop = function(event, newStatus) {
            const prospectId = draggedProspectId;
            const oldStatus = prospects.find(p => p.id === prospectId)?.status;
            originalHandleStatusDrop(event, newStatus);
            // Add notification for status change (Supabase sync already done in originalHandleStatusDrop)
            if (prospectId && oldStatus !== newStatus) {
                const prospect = prospects.find(p => p.id === prospectId);
                if (prospect) {
                    addNotification({
                        type: 'status',
                        title: `${prospect.company} a change de statut`,
                        desc: `${statusLabel(oldStatus)} → ${statusLabel(newStatus)}`,
                        prospectId: prospect.id
                    });
                    addActivityToProspect(prospect.id, 'status', `Statut change: ${statusLabel(oldStatus)} → ${statusLabel(newStatus)}`);
                }
            }
        };

        // ============================================
        // NOTIFICATIONS SYSTEM
        // ============================================
        let notifications = JSON.parse(localStorage.getItem('pacifikai_notifications') || '[]');

        function statusLabel(s) {
            const labels = { lead: 'Lead', contacted: 'Contacte', meeting: 'RDV/Audit', proposal: 'Proposition', won: 'Gagne' };
            return labels[s] || s;
        }

        function addNotification(notif) {
            const notification = {
                id: Date.now(),
                ...notif,
                time: new Date().toISOString(),
                read: false
            };
            notifications.unshift(notification);
            if (notifications.length > 50) notifications = notifications.slice(0, 50);
            localStorage.setItem('pacifikai_notifications', JSON.stringify(notifications));
            renderNotifications();
        }

        function renderNotifications() {
            const list = document.getElementById('notification-list');
            const badge = document.getElementById('notification-badge');
            const unreadCount = notifications.filter(n => !n.read).length;

            badge.textContent = unreadCount;
            badge.classList.toggle('hidden', unreadCount === 0);

            if (notifications.length === 0) {
                list.innerHTML = '<div class="notification-empty">Aucune notification</div>';
                return;
            }

            const icons = {
                status: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',
                task: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
                alert: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>'
            };

            list.innerHTML = notifications.slice(0, 20).map(n => `
                <div class="notification-item ${n.read ? '' : 'unread'}" onclick="handleNotificationClick(${n.id}, ${n.prospectId || 'null'})">
                    <div class="notification-icon ${n.type}">${icons[n.type] || icons.alert}</div>
                    <div class="notification-content">
                        <div class="notification-title">${n.title}</div>
                        <div class="notification-desc">${n.desc}</div>
                        <div class="notification-time">${formatTimeAgo(n.time)}</div>
                    </div>
                </div>
            `).join('');
        }

        function formatTimeAgo(isoTime) {
            const now = new Date();
            const time = new Date(isoTime);
            const diffMs = now - time;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'A l\'instant';
            if (diffMins < 60) return `Il y a ${diffMins} min`;
            if (diffHours < 24) return `Il y a ${diffHours}h`;
            if (diffDays < 7) return `Il y a ${diffDays}j`;
            return time.toLocaleDateString('fr-FR');
        }

        function toggleNotifications(event) {
            event.stopPropagation();
            const panel = document.getElementById('notification-panel');
            panel.classList.toggle('show');
        }

        function handleNotificationClick(notifId, prospectId) {
            const notif = notifications.find(n => n.id === notifId);
            if (notif) notif.read = true;
            localStorage.setItem('pacifikai_notifications', JSON.stringify(notifications));
            renderNotifications();

            document.getElementById('notification-panel').classList.remove('show');

            if (prospectId) {
                openProspectDetail(prospectId);
            }
        }

        function clearAllNotifications(event) {
            event.stopPropagation();
            notifications = [];
            localStorage.setItem('pacifikai_notifications', JSON.stringify(notifications));
            renderNotifications();
        }

        // Close notifications when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.notification-bell')) {
                document.getElementById('notification-panel').classList.remove('show');
            }
        });

        // Check for task deadlines periodically
        function checkTaskDeadlines() {
            const today = new Date().toISOString().split('T')[0];
            const urgentTasks = tasks.filter(t => {
                if (!t.dueDate || t.status === 'Termine') return false;
                return t.dueDate <= today && t.status !== 'Termine';
            });

            // Update nav badge
            const navBadge = document.querySelector('.nav-item[onclick*="tasks"] .nav-badge');
            if (navBadge && urgentTasks.length > 0) {
                navBadge.textContent = urgentTasks.length;
                navBadge.classList.add('urgent');
            }
        }

        // ============================================
        // ACTIVITY TIMELINE PER PROSPECT
        // ============================================
        let prospectActivities = JSON.parse(localStorage.getItem('pacifikai_activities') || '{}');

        function addActivityToProspect(prospectId, type, description) {
            if (!prospectActivities[prospectId]) prospectActivities[prospectId] = [];
            prospectActivities[prospectId].unshift({
                id: Date.now(),
                type,
                description,
                time: new Date().toISOString()
            });
            if (prospectActivities[prospectId].length > 50) {
                prospectActivities[prospectId] = prospectActivities[prospectId].slice(0, 50);
            }
            localStorage.setItem('pacifikai_activities', JSON.stringify(prospectActivities));
        }

        function getProspectTimeline(prospectId) {
            return prospectActivities[prospectId] || [];
        }

        function renderProspectTimeline(prospectId) {
            const activities = getProspectTimeline(prospectId);
            if (activities.length === 0) {
                return '<div class="empty"><p>Aucune activite enregistree</p></div>';
            }

            return `<div class="timeline">${activities.slice(0, 10).map(a => `
                <div class="timeline-item">
                    <div class="timeline-dot ${a.type}"></div>
                    <div class="timeline-content">
                        <div class="timeline-header">
                            <span class="timeline-action">${a.description}</span>
                            <span class="timeline-date">${formatTimeAgo(a.time)}</span>
                        </div>
                    </div>
                </div>
            `).join('')}</div>`;
        }

        // ============================================
        // GLOBAL SEARCH (Cmd+K)
        // ============================================
        let searchSelectedIndex = 0;

        function openGlobalSearch() {
            const overlay = document.getElementById('search-overlay');
            overlay.classList.add('show');
            setTimeout(() => {
                document.getElementById('global-search-input').focus();
            }, 100);
            searchSelectedIndex = 0;
        }

        function closeGlobalSearch(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('search-overlay').classList.remove('show');
            document.getElementById('global-search-input').value = '';
            document.getElementById('search-prospects-section').style.display = 'none';
            document.getElementById('search-tasks-section').style.display = 'none';
        }

        function handleGlobalSearch(query) {
            const prospectsSection = document.getElementById('search-prospects-section');
            const prospectsResults = document.getElementById('search-prospects-results');
            const tasksSection = document.getElementById('search-tasks-section');
            const tasksResults = document.getElementById('search-tasks-results');

            if (!query || query.length < 2) {
                prospectsSection.style.display = 'none';
                tasksSection.style.display = 'none';
                return;
            }

            const q = query.toLowerCase();

            // Search prospects
            const matchedProspects = prospects.filter(p =>
                p.company.toLowerCase().includes(q) ||
                p.sector.toLowerCase().includes(q) ||
                (p.contact && p.contact.toLowerCase().includes(q))
            ).slice(0, 5);

            if (matchedProspects.length > 0) {
                prospectsSection.style.display = 'block';
                prospectsResults.innerHTML = matchedProspects.map(p => `
                    <div class="search-result" onclick="executeSearchAction('prospect', ${p.id})">
                        <div class="search-result-icon prospect">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        </div>
                        <div class="search-result-content">
                            <div class="search-result-title">${p.company}</div>
                            <div class="search-result-meta">${p.sector} • ${statusLabel(p.status)}</div>
                        </div>
                    </div>
                `).join('');
            } else {
                prospectsSection.style.display = 'none';
            }

            // Search tasks
            const matchedTasks = tasks.filter(t =>
                t.title.toLowerCase().includes(q) ||
                (t.description && t.description.toLowerCase().includes(q))
            ).slice(0, 5);

            if (matchedTasks.length > 0) {
                tasksSection.style.display = 'block';
                tasksResults.innerHTML = matchedTasks.map(t => `
                    <div class="search-result" onclick="executeSearchAction('task', '${t.id}')">
                        <div class="search-result-icon task">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                        </div>
                        <div class="search-result-content">
                            <div class="search-result-title">${t.title}</div>
                            <div class="search-result-meta">${t.status}${t.dueDate ? ' • ' + t.dueDate : ''}</div>
                        </div>
                    </div>
                `).join('');
            } else {
                tasksSection.style.display = 'none';
            }
        }

        function executeSearchAction(action, id) {
            closeGlobalSearch();
            switch(action) {
                case 'new-prospect':
                    showNewProspectModal();
                    break;
                case 'focus':
                    toggleFocusMode();
                    break;
                case 'sync':
                    syncFromAirtable();
                    break;
                case 'prospect':
                    openProspectDetail(id);
                    break;
                case 'task':
                    switchView('tasks');
                    break;
            }
        }

        // Keyboard shortcut (Cmd+K / Ctrl+K)
        document.addEventListener('keydown', (e) => {
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                e.preventDefault();
                openGlobalSearch();
            }
            if (e.key === 'Escape') {
                closeGlobalSearch();
            }
        });

        // ============================================
        // CONTEXT MENU (Quick Actions)
        // ============================================
        let contextMenuProspectId = null;

        function showContextMenu(event, prospectId) {
            event.preventDefault();
            event.stopPropagation();

            contextMenuProspectId = prospectId;
            const menu = document.getElementById('context-menu');

            // Position menu
            let x = event.clientX;
            let y = event.clientY;

            // Adjust if near edge
            if (x + 200 > window.innerWidth) x = window.innerWidth - 210;
            if (y + 300 > window.innerHeight) y = window.innerHeight - 310;

            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.classList.add('show');
        }

        function hideContextMenu() {
            document.getElementById('context-menu').classList.remove('show');
            contextMenuProspectId = null;
        }

        document.addEventListener('click', hideContextMenu);
        document.addEventListener('contextmenu', (e) => {
            if (!e.target.closest('.pipeline-card')) {
                hideContextMenu();
            }
        });

        function contextMenuAction(action) {
            if (!contextMenuProspectId) return;
            const prospect = prospects.find(p => p.id === contextMenuProspectId);
            if (!prospect) return;

            hideContextMenu();

            switch(action) {
                case 'change-status':
                    showStatusPicker(prospect);
                    break;
                case 'change-priority':
                    showPriorityPicker(prospect);
                    break;
                case 'add-note':
                    openProspectDetail(prospect.id);
                    setTimeout(() => document.querySelector('.note-input')?.focus(), 300);
                    break;
                case 'create-task':
                    const taskTitle = prompt(`Nouvelle tache pour ${prospect.company}:`);
                    if (taskTitle) {
                        showToast(`Tache "${taskTitle}" a creer dans Airtable`);
                        addActivityToProspect(prospect.id, 'task', `Tache creee: ${taskTitle}`);
                    }
                    break;
                case 'send-email':
                    if (prospect.email) {
                        window.open(`mailto:${prospect.email}?subject=PACIFIK'AI - ${prospect.company}`, '_blank');
                    } else {
                        showToast('Pas d\'email configure pour ce prospect');
                    }
                    break;
                case 'schedule-followup':
                    const date = prompt('Date de relance (YYYY-MM-DD):');
                    if (date) {
                        prospect.nextFollowUp = date;
                        updateProspectInAirtable(prospect);
                        addActivityToProspect(prospect.id, 'note', `Relance planifiee pour le ${date}`);
                        showToast(`Relance planifiee pour le ${date}`);
                    }
                    break;
                case 'open-detail':
                    openProspectDetail(prospect.id);
                    break;
            }
        }

        function showStatusPicker(prospect) {
            const statuses = ['lead', 'contacted', 'meeting', 'proposal', 'won'];
            const choice = prompt(`Changer le statut de ${prospect.company}:\n\n1. Lead\n2. Contacte\n3. RDV/Audit\n4. Proposition\n5. Gagne\n\nEntrez le numero:`);
            const idx = parseInt(choice) - 1;
            if (idx >= 0 && idx < statuses.length) {
                const oldStatus = prospect.status;
                prospect.status = statuses[idx];
                updateProspectInAirtable(prospect);
                addNotification({
                    type: 'status',
                    title: `${prospect.company} a change de statut`,
                    desc: `${statusLabel(oldStatus)} → ${statusLabel(prospect.status)}`,
                    prospectId: prospect.id
                });
                addActivityToProspect(prospect.id, 'status', `Statut change: ${statusLabel(oldStatus)} → ${statusLabel(prospect.status)}`);
                renderAll();
            }
        }

        function showPriorityPicker(prospect) {
            const priorities = ['hot', 'chaud', 'tiede', 'froid'];
            const priorityLabels = ['🔥 Hot', 'Chaud', 'Tiède', 'Froid'];
            const currentIdx = priorities.indexOf(prospect.priority);
            const currentLabel = currentIdx >= 0 ? priorityLabels[currentIdx] : prospect.priority;

            const choice = prompt(`Changer la priorité de ${prospect.company}:\n(Actuel: ${currentLabel})\n\n1. 🔥 Hot\n2. Chaud\n3. Tiède\n4. Froid\n\nEntrez le numéro:`);
            if (!choice) return;

            const idx = parseInt(choice) - 1;
            if (idx >= 0 && idx < priorities.length) {
                const oldPriority = prospect.priority;
                prospect.priority = priorities[idx];
                prospect.priorityUpdatedAt = Date.now(); // Track update time
                save(); // Save locally first
                updateProspectInAirtable(prospect);
                addActivityToProspect(prospect.id, 'note', `Priorité changée: ${priorityLabels[priorities.indexOf(oldPriority)] || oldPriority} → ${priorityLabels[idx]}`);
                renderAll();
                showToast(`Priorité mise à jour: ${priorityLabels[idx]}`);
            }
        }

        // Add context menu to pipeline cards
        const originalRenderPipelineStatus = renderPipelineStatus;
        renderPipelineStatus = function() {
            originalRenderPipelineStatus();
            // Add context menu event to cards
            document.querySelectorAll('.pipeline-card').forEach(card => {
                card.addEventListener('contextmenu', (e) => {
                    const id = parseInt(card.dataset.id);
                    showContextMenu(e, id);
                });
            });
        };

        // ============================================
        // ADVANCED STATS (Funnel)
        // ============================================
        function renderFunnelStats() {
            const stages = ['lead', 'contacted', 'meeting', 'proposal', 'won'];
            const labels = ['Lead', 'Contacte', 'RDV/Audit', 'Proposition', 'Gagne'];
            const counts = stages.map(s => prospects.filter(p => p.status === s).length);
            const total = prospects.length || 1;

            // Calculate conversion rates
            const conversions = [];
            for (let i = 0; i < stages.length - 1; i++) {
                const from = counts.slice(i).reduce((a, b) => a + b, 0);
                const to = counts.slice(i + 1).reduce((a, b) => a + b, 0);
                conversions.push(from > 0 ? Math.round((to / from) * 100) : 0);
            }

            return {
                stages: labels,
                counts,
                percentages: counts.map(c => Math.round((c / total) * 100)),
                conversions,
                totalValue: prospects.reduce((sum, p) => sum + (p.value || 0), 0),
                avgTimeInPipeline: '~15 jours' // Placeholder - would need real tracking
            };
        }

        // ============================================
        // THEME TOGGLE
        // ============================================
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('pacifikai-theme', newTheme);
        }

        // Init theme from localStorage
        (function() {
            const saved = localStorage.getItem('pacifikai-theme');
            if (saved) {
                document.documentElement.setAttribute('data-theme', saved);
            }
        })();

        // ============================================
        // SIDEBAR TOGGLE
        // ============================================
        function toggleSidebar() {
            const layout = document.querySelector('.layout');
            const sidebar = document.querySelector('.sidebar');
            const isCollapsed = sidebar.classList.toggle('collapsed');
            layout.classList.toggle('sidebar-collapsed', isCollapsed);
            localStorage.setItem('pacifikai-sidebar-collapsed', isCollapsed);
        }

        // Init sidebar state from localStorage
        (function() {
            const collapsed = localStorage.getItem('pacifikai-sidebar-collapsed') === 'true';
            if (collapsed) {
                document.querySelector('.sidebar')?.classList.add('collapsed');
                document.querySelector('.layout')?.classList.add('sidebar-collapsed');
            }
        })();

        // ============================================
        // FOCUS MODE
        // ============================================
        let isFocusMode = false;

        function toggleFocusMode() {
            isFocusMode = !isFocusMode;
            document.body.classList.toggle('focus-mode', isFocusMode);

            if (isFocusMode) {
                // Hide all other views, show focus view
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById('view-focus').classList.add('active');
                renderFocusMode();
            } else {
                // Return to dashboard
                document.getElementById('view-focus').classList.remove('active');
                document.getElementById('view-dashboard').classList.add('active');
            }
        }

        function renderFocusMode() {
            // Set date
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('focus-date').textContent = new Date().toLocaleDateString('fr-FR', options);

            // Render urgent tasks
            const urgentTasks = tasks.filter(t => t.priority === 'Urgent' && t.status !== 'Termine');
            const urgentContainer = document.getElementById('focus-urgent-tasks');

            if (urgentTasks.length === 0) {
                urgentContainer.innerHTML = '<div class="empty"><p>Aucune tache urgente</p></div>';
            } else {
                urgentContainer.innerHTML = urgentTasks.map(t => `
                    <div class="focus-task">
                        <div class="focus-task-checkbox" onclick="toggleFocusTask(this)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
                        </div>
                        <div class="focus-task-content">
                            <div class="focus-task-title">${t.title}</div>
                            <div class="focus-task-meta">${t.project || 'PACIFIKAI'}${t.dueDate ? ' • Echeance: ' + t.dueDate : ''}</div>
                        </div>
                        <span class="focus-task-priority urgent">Urgent</span>
                    </div>
                `).join('');
            }

            // Render today's follow-ups
            const today = new Date().toISOString().split('T')[0];
            const todayFollowups = prospects.filter(p => p.nextFollowUp === today);
            const followupsContainer = document.getElementById('focus-followups');

            if (todayFollowups.length === 0) {
                followupsContainer.innerHTML = '<div class="empty"><p>Aucune relance prevue aujourd\'hui</p></div>';
            } else {
                followupsContainer.innerHTML = todayFollowups.map(p => `
                    <div class="focus-followup">
                        <div class="focus-followup-avatar">${p.company.substring(0, 2).toUpperCase()}</div>
                        <div class="focus-followup-content">
                            <div class="focus-followup-company">${p.company}</div>
                            <div class="focus-followup-reason">${p.sector} • ${statusLabel(p.status)}</div>
                        </div>
                        <button class="focus-followup-action" onclick="openProspectDetail('${p.id}'); toggleFocusMode();">Voir</button>
                    </div>
                `).join('');
            }

            // Pipeline stats
            const stats = renderFunnelStats();
            document.getElementById('focus-pipeline-value').textContent = fmtXPF(stats.totalValue);
            document.getElementById('focus-active-count').textContent = prospects.filter(p => p.status !== 'won').length;
            document.getElementById('focus-proposals').textContent = prospects.filter(p => p.status === 'proposal').length;

            const won = prospects.filter(p => p.status === 'won').length;
            const conversionRate = prospects.length > 0 ? Math.round((won / prospects.length) * 100) : 0;
            document.getElementById('focus-conversion').textContent = conversionRate + '%';
        }

        function toggleFocusTask(el) {
            el.classList.toggle('checked');
        }

        // ============================================
        // ANALYTICS VIEW
        // ============================================

        // Chart.js instances (for cleanup)
        let chartPipelineStatus = null;
        let chartSectors = null;
        let chartTemperature = null;
        let chartValueSector = null;

        function renderAnalyticsView() {
            const stats = renderFunnelStats();

            // KPI Row
            const won = prospects.filter(p => p.status === 'won').length;
            const conversionRate = prospects.length > 0 ? Math.round((won / prospects.length) * 100) : 0;
            const avgValue = prospects.length > 0 ? Math.round(stats.totalValue / prospects.length) : 0;

            document.getElementById('kpi-total').textContent = prospects.length;
            document.getElementById('kpi-pipeline').textContent = fmtXPF(stats.totalValue);
            document.getElementById('kpi-conversion').textContent = conversionRate + '%';
            document.getElementById('kpi-avg').textContent = fmtXPF(avgValue);

            // Destroy existing charts
            if (chartPipelineStatus) chartPipelineStatus.destroy();
            if (chartSectors) chartSectors.destroy();
            if (chartTemperature) chartTemperature.destroy();
            if (chartValueSector) chartValueSector.destroy();

            // Chart.js default config
            const chartColors = {
                accent: '#3b82f6',
                purple: '#a855f7',
                green: '#22c55e',
                yellow: '#eab308',
                red: '#ef4444',
                orange: '#f97316',
                text: '#e2e8f0',
                textMuted: '#64748b',
                border: '#1e293b',
                bg: '#0f172a'
            };

            Chart.defaults.color = chartColors.text;
            Chart.defaults.borderColor = chartColors.border;

            // 1. Pipeline by Status (Bar Chart)
            const statusCounts = {
                'Lead': prospects.filter(p => p.status === 'lead').length,
                'Contacte': prospects.filter(p => p.status === 'contacted').length,
                'RDV': prospects.filter(p => p.status === 'meeting').length,
                'Proposition': prospects.filter(p => p.status === 'proposal').length,
                'Gagne': prospects.filter(p => p.status === 'won').length
            };

            chartPipelineStatus = new Chart(document.getElementById('chart-pipeline-status'), {
                type: 'bar',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        label: 'Prospects',
                        data: Object.values(statusCounts),
                        backgroundColor: [
                            chartColors.textMuted,
                            chartColors.accent,
                            chartColors.purple,
                            chartColors.yellow,
                            chartColors.green
                        ],
                        borderRadius: 6,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 800,
                        easing: 'easeOutQuart',
                        delay: (ctx) => ctx.dataIndex * 100
                    },
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 },
                            grid: { color: chartColors.border }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });

            // 2. Sector Distribution (Doughnut)
            const sectorCounts = {};
            prospects.forEach(p => {
                sectorCounts[p.sector] = (sectorCounts[p.sector] || 0) + 1;
            });
            const sectorLabels = Object.keys(sectorCounts);
            const sectorData = Object.values(sectorCounts);
            const sectorColors = sectorLabels.map((_, i) => {
                const hue = (i * 360 / sectorLabels.length + 200) % 360;
                return `hsl(${hue}, 70%, 55%)`;
            });

            chartSectors = new Chart(document.getElementById('chart-sectors'), {
                type: 'doughnut',
                data: {
                    labels: sectorLabels,
                    datasets: [{
                        data: sectorData,
                        backgroundColor: sectorColors,
                        borderWidth: 0,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 1000,
                        easing: 'easeOutBack'
                    },
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { boxWidth: 12, padding: 8, font: { size: 11 } }
                        }
                    },
                    cutout: '60%'
                }
            });

            // 3. Temperature Distribution (Polar Area)
            const tempCounts = {
                'Hot': prospects.filter(p => p.priority === 'hot').length,
                'Chaud': prospects.filter(p => p.priority === 'chaud').length,
                'Tiede': prospects.filter(p => p.priority === 'tiede').length,
                'Froid': prospects.filter(p => p.priority === 'froid').length
            };

            chartTemperature = new Chart(document.getElementById('chart-temperature'), {
                type: 'polarArea',
                data: {
                    labels: Object.keys(tempCounts),
                    datasets: [{
                        data: Object.values(tempCounts),
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.7)',   // Hot - red
                            'rgba(249, 115, 22, 0.7)', // Chaud - orange
                            'rgba(234, 179, 8, 0.7)',  // Tiede - yellow
                            'rgba(59, 130, 246, 0.7)'  // Froid - blue
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 900,
                        easing: 'easeOutElastic'
                    },
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { boxWidth: 12, padding: 8, font: { size: 11 } }
                        }
                    },
                    scales: {
                        r: {
                            ticks: { display: false },
                            grid: { color: chartColors.border }
                        }
                    }
                }
            });

            // 4. Value by Sector (Horizontal Bar)
            const sectorValues = {};
            prospects.forEach(p => {
                sectorValues[p.sector] = (sectorValues[p.sector] || 0) + (p.value || 0);
            });
            const sortedSectors = Object.entries(sectorValues).sort((a, b) => b[1] - a[1]);

            chartValueSector = new Chart(document.getElementById('chart-value-sector'), {
                type: 'bar',
                data: {
                    labels: sortedSectors.map(s => s[0]),
                    datasets: [{
                        label: 'Valeur (XPF)',
                        data: sortedSectors.map(s => s[1]),
                        backgroundColor: sortedSectors.map((_, i) => {
                            // Gradient violet -> cyan pour un look moderne
                            const colors = [
                                'rgba(139, 92, 246, 0.9)',   // violet
                                'rgba(99, 102, 241, 0.85)',  // indigo
                                'rgba(59, 130, 246, 0.8)',   // blue
                                'rgba(6, 182, 212, 0.75)',   // cyan
                                'rgba(34, 197, 94, 0.7)'     // green
                            ];
                            return colors[i % colors.length];
                        }),
                        hoverBackgroundColor: sortedSectors.map((_, i) => {
                            const colors = [
                                'rgba(139, 92, 246, 1)',
                                'rgba(99, 102, 241, 1)',
                                'rgba(59, 130, 246, 1)',
                                'rgba(6, 182, 212, 1)',
                                'rgba(34, 197, 94, 1)'
                            ];
                            return colors[i % colors.length];
                        }),
                        borderRadius: 6,
                        borderSkipped: false
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart',
                        delay: (ctx) => ctx.dataIndex * 80
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => fmtXPF(ctx.raw) + ' XPF'
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { color: chartColors.border },
                            ticks: {
                                callback: (val) => fmtXPF(val)
                            }
                        },
                        y: {
                            grid: { display: false }
                        }
                    }
                }
            });

            // 5. Funnel (keep existing)
            const funnelContainer = document.getElementById('analytics-funnel');
            const maxCount = Math.max(...stats.counts, 1);

            funnelContainer.innerHTML = stats.stages.map((stage, i) => {
                const width = (stats.counts[i] / maxCount) * 100;
                const rate = i > 0 && stats.counts[i-1] > 0 ? Math.round((stats.counts[i] / stats.counts[i-1]) * 100) : 100;
                return `
                    <div class="funnel-stage">
                        <div class="funnel-label">${stage}</div>
                        <div class="funnel-bar-wrapper">
                            <div class="funnel-bar" style="width: ${Math.max(width, 5)}%;">
                                ${width > 15 ? `<span class="funnel-value">${stats.counts[i]}</span>` : ''}
                            </div>
                        </div>
                        <div class="funnel-count">${stats.counts[i]} ${i > 0 ? `<span style="color: var(--text-dim); font-size: 0.75rem;">(${rate}%)</span>` : ''}</div>
                    </div>
                `;
            }).join('');
        }

        // Auto-render analytics when switching to that view
        const originalShowView = showView;
        showView = function(name) {
            originalShowView(name);
            if (name === 'analytics') {
                renderAnalyticsView();
            }
            if (name === 'blog') {
                loadBlogArticles();
            }
            if (name === 'newsletter') {
                loadNewsletterCampaigns();
            }
            // Update MANA suggestions based on active view
            if (typeof updateChatSuggestions === 'function') {
                updateChatSuggestions();
            }
        };

        // ============================================
        // BLOG ARTICLES MANAGEMENT (Supabase)
        // ============================================

        let blogArticles = [];
        let currentBlogCategoryFilter = 'all';
        let currentBlogStatusFilter = 'all';
        let editingBlogArticleId = null;

        // ===== MESSAGES MODULE (Supabase) =====
        let messengerConversations = [];
        let currentConversationId = null;
        let currentMessagesFilter = 'all';

        async function loadMessengerConversations() {
            try {
                // Load from Supabase messenger_messages table
                const messages = await supabase.getMessengerMessages();
                const prospects = await supabase.getMessengerProspects();

                // Create a map of prospects by sender_id
                const prospectsMap = new Map();
                prospects.forEach(p => {
                    prospectsMap.set(p.sender_id, {
                        name: p.name || p.first_name || 'Utilisateur',
                        profilePic: p.profile_pic
                    });
                });

                // Group messages by sender_id
                const conversationsMap = new Map();

                messages.forEach(record => {
                    const senderId = record.sender_id;
                    if (!senderId) return;

                    if (!conversationsMap.has(senderId)) {
                        const prospectInfo = prospectsMap.get(senderId) || {};
                        conversationsMap.set(senderId, {
                            senderId: senderId,
                            userName: prospectInfo.name || 'Utilisateur',
                            profilePic: prospectInfo.profilePic,
                            messages: [],
                            lastMessage: null,
                            unreadCount: 0
                        });
                    }

                    const conv = conversationsMap.get(senderId);
                    const msg = {
                        id: record.id,
                        role: record.role || 'user',
                        content: record.content || '',
                        createdAt: record.created_at,
                        read: record.read || false,
                        manual: record.responded_manually || false
                    };

                    conv.messages.push(msg);

                    if (!conv.lastMessage || new Date(msg.createdAt) > new Date(conv.lastMessage.createdAt)) {
                        conv.lastMessage = msg;
                    }

                    if (msg.role === 'user' && !msg.read) {
                        conv.unreadCount++;
                    }
                });

                messengerConversations = Array.from(conversationsMap.values());

                // Sort by last message date
                messengerConversations.sort((a, b) => {
                    const dateA = a.lastMessage ? new Date(a.lastMessage.createdAt) : new Date(0);
                    const dateB = b.lastMessage ? new Date(b.lastMessage.createdAt) : new Date(0);
                    return dateB - dateA;
                });

                console.log(`[Messages] Loaded ${messengerConversations.length} conversations from Supabase`);

                renderConversationsList();
                updateMessagesKPIs();
                updateNavMessagesCount();

            } catch (error) {
                console.error('[Messages] Error loading from Supabase:', error);
            }
        }

        function renderConversationsList() {
            const container = document.getElementById('conversations-items');
            if (!container) return;

            let filtered = messengerConversations;

            // Apply filter
            if (currentMessagesFilter === 'unread') {
                filtered = filtered.filter(c => c.unreadCount > 0);
            } else if (currentMessagesFilter === 'manual') {
                filtered = filtered.filter(c => c.messages.some(m => m.manual));
            }

            // Apply search
            const searchTerm = document.getElementById('conversations-search')?.value?.toLowerCase() || '';
            if (searchTerm) {
                filtered = filtered.filter(c =>
                    c.userName.toLowerCase().includes(searchTerm) ||
                    c.senderId.includes(searchTerm) ||
                    c.messages.some(m => m.content.toLowerCase().includes(searchTerm))
                );
            }

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="conversations-empty">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
                        <p>Aucune conversation</p>
                        <span>${searchTerm ? 'Aucun resultat pour cette recherche' : 'Les messages Facebook Messenger apparaitront ici'}</span>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(conv => {
                const initials = conv.userName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                const preview = conv.lastMessage ? conv.lastMessage.content.substring(0, 50) + (conv.lastMessage.content.length > 50 ? '...' : '') : '';
                const time = conv.lastMessage ? formatMessageTime(conv.lastMessage.createdAt) : '';
                const isActive = currentConversationId === conv.senderId;
                const isUnread = conv.unreadCount > 0;

                return `
                    <div class="conversation-item ${isActive ? 'active' : ''} ${isUnread ? 'unread' : ''}" onclick="selectConversation('${conv.senderId}')">
                        <div class="conversation-avatar">${initials}</div>
                        <div class="conversation-info">
                            <div class="conversation-name">${conv.userName}</div>
                            <div class="conversation-preview">${preview}</div>
                        </div>
                        <div class="conversation-meta">
                            <div class="conversation-time">${time}</div>
                            ${isUnread ? `<div class="conversation-badge">${conv.unreadCount}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function formatMessageTime(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));

            if (days === 0) {
                return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            } else if (days === 1) {
                return 'Hier';
            } else if (days < 7) {
                return date.toLocaleDateString('fr-FR', { weekday: 'short' });
            } else {
                return date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
            }
        }

        function selectConversation(senderId) {
            currentConversationId = senderId;
            const conv = messengerConversations.find(c => c.senderId === senderId);
            if (!conv) return;

            // Update UI
            document.querySelector('.chat-detail-empty').style.display = 'none';
            document.getElementById('chat-detail-content').style.display = 'flex';

            // Update header
            const initials = conv.userName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            document.getElementById('chat-user-avatar').textContent = initials;
            document.getElementById('chat-user-name').textContent = conv.userName;
            document.getElementById('chat-user-id').textContent = `ID: ${conv.senderId}`;

            // Render messages
            const container = document.getElementById('chat-messages-container');
            const sortedMessages = [...conv.messages].sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));

            container.innerHTML = sortedMessages.map(msg => {
                const time = new Date(msg.createdAt).toLocaleString('fr-FR', {
                    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
                });

                const isAssistant = msg.role === 'assistant';
                const isManual = msg.manual;

                let labelHtml = '';
                if (isAssistant) {
                    if (isManual) {
                        labelHtml = `<div class="msg-label"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> Reponse manuelle</div>`;
                    } else {
                        labelHtml = `<div class="msg-label"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1"/></svg> MANA (IA)</div>`;
                    }
                }

                return `
                    <div class="msg-bubble ${msg.role} ${isManual ? 'manual' : ''}">
                        ${labelHtml}
                        <div>${msg.content}</div>
                        <div class="msg-time">${time}</div>
                    </div>
                `;
            }).join('');

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;

            // Update conversations list active state
            renderConversationsList();
        }

        function filterMessages() {
            currentMessagesFilter = document.getElementById('messages-filter').value;
            renderConversationsList();
        }

        function searchConversations() {
            renderConversationsList();
        }

        function updateMessagesKPIs() {
            const totalConvs = messengerConversations.length;
            const today = new Date().toDateString();
            let todayMessages = 0;
            let aiResponses = 0;
            let manualResponses = 0;

            messengerConversations.forEach(conv => {
                conv.messages.forEach(msg => {
                    if (msg.createdAt && new Date(msg.createdAt).toDateString() === today) {
                        todayMessages++;
                    }
                    if (msg.role === 'assistant') {
                        if (msg.manual) {
                            manualResponses++;
                        } else {
                            aiResponses++;
                        }
                    }
                });
            });

            document.getElementById('msg-total-conversations').textContent = totalConvs;
            document.getElementById('msg-today').textContent = todayMessages;
            document.getElementById('msg-ai-responses').textContent = aiResponses;
            document.getElementById('msg-manual-responses').textContent = manualResponses;
        }

        function updateNavMessagesCount() {
            const unreadTotal = messengerConversations.reduce((sum, c) => sum + c.unreadCount, 0);
            const badge = document.getElementById('nav-messages-count');
            if (badge) {
                badge.textContent = unreadTotal;
                badge.style.display = unreadTotal > 0 ? 'inline-block' : 'none';
            }
        }

        async function markConversationRead() {
            if (!currentConversationId) return;

            const conv = messengerConversations.find(c => c.senderId === currentConversationId);
            if (!conv) return;

            // Get unread message IDs
            const unreadIds = conv.messages.filter(m => m.role === 'user' && !m.read).map(m => m.id);
            if (unreadIds.length === 0) return;

            try {
                // Update in Supabase (batch)
                await supabase.updateMessengerMessagesBatch(unreadIds, { read: true });

                // Update local state
                conv.messages.forEach(m => { if (m.role === 'user') m.read = true; });
                conv.unreadCount = 0;

                renderConversationsList();
                updateNavMessagesCount();
                addNotification('info', 'Conversation marquee comme lue');

            } catch (error) {
                console.error('[Messages] Error marking as read:', error);
            }
        }

        function openFacebookProfile() {
            if (!currentConversationId) return;
            // Note: Facebook PSID cannot be used to open profile directly
            // This would need Page-scoped user ID mapping
            window.open('https://www.facebook.com/profile.php?id=61587101037690', '_blank');
        }

        async function sendManualReply() {
            const input = document.getElementById('manual-reply-input');
            const message = input.value.trim();
            if (!message || !currentConversationId) return;

            try {
                // 1. Send via Facebook Graph API (via n8n webhook)
                const sendResponse = await fetch('https://n8n.srv1140766.hstgr.cloud/webhook/pacifikai-manual-reply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        recipientId: currentConversationId,
                        message: message
                    })
                });

                // 2. Log in Supabase
                await supabase.createMessengerMessage({
                    sender_id: currentConversationId,
                    role: 'assistant',
                    content: message,
                    responded_manually: true,
                    read: true
                });

                // 3. Update UI
                input.value = '';
                addNotification('success', 'Reponse envoyee');

                // Reload conversations
                await loadMessengerConversations();
                selectConversation(currentConversationId);

            } catch (error) {
                console.error('[Messages] Error sending reply:', error);
                addNotification('error', 'Erreur envoi: ' + error.message);
            }
        }

        // ===== END MESSAGES MODULE =====

        // ============================================
        // FINANCE MODULE
        // ============================================
        const FINANCE_TABLE_ID = 'tblFinanceRevenue'; // Table a creer dans Airtable
        let financeData = {
            mrr: 0,
            arr: 0,
            mtd: 0,
            pending: 0,
            projects: 0,
            recurring: 0,
            upsells: 0,
            invoices: [],
            clients: [],
            monthlyTrend: []
        };

        async function loadFinanceData() {
            try {
                showToast('Chargement des donnees finance...');

                // Pour l'instant, on simule avec les prospects "won"
                const wonProspects = prospects.filter(p => p.status === 'won');

                // Calculer MRR basé sur les prospects gagnés
                // Hypothèse: 10% de la valeur du deal = MRR
                const totalValue = wonProspects.reduce((sum, p) => sum + (p.value || 0), 0);
                financeData.mrr = Math.round(totalValue * 0.1);
                financeData.arr = financeData.mrr * 12;

                // MTD = deals gagnés ce mois
                const now = new Date();
                const thisMonth = now.toISOString().substring(0, 7);
                const mtdProspects = wonProspects.filter(p => p.date?.startsWith(thisMonth));
                financeData.mtd = mtdProspects.reduce((sum, p) => sum + (p.value || 0), 0);

                // Pending = deals en "proposal"
                const proposalProspects = prospects.filter(p => p.status === 'proposal');
                financeData.pending = proposalProspects.reduce((sum, p) => sum + (p.value || 0), 0);

                // Breakdown approximatif
                financeData.projects = Math.round(totalValue * 0.6);
                financeData.recurring = financeData.mrr;
                financeData.upsells = Math.round(totalValue * 0.1);

                // Clients MRR (prospects gagnés avec valeur)
                financeData.clients = wonProspects.map(p => ({
                    name: p.company,
                    mrr: Math.round((p.value || 0) * 0.1),
                    since: p.date
                })).filter(c => c.mrr > 0);

                // Générer trend 6 mois (simulation)
                financeData.monthlyTrend = generateMonthlyTrend();

                // Render
                renderFinanceData();

                showToast('Donnees finance chargees');

            } catch (error) {
                console.error('[Finance] Error:', error);
                showToast('Erreur chargement finance');
            }
        }

        function generateMonthlyTrend() {
            const months = [];
            const now = new Date();
            for (let i = 5; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthName = date.toLocaleDateString('fr-FR', { month: 'short' });
                // Simulation croissance
                const baseValue = financeData.mrr || 500000;
                const value = Math.round(baseValue * (0.5 + (5 - i) * 0.1));
                months.push({ month: monthName, value });
            }
            return months;
        }

        function renderFinanceData() {
            // Update KPIs
            document.getElementById('finance-mrr').textContent = fmtXPF(financeData.mrr);
            document.getElementById('finance-arr').textContent = fmtXPF(financeData.arr);
            document.getElementById('finance-mtd').textContent = fmtXPF(financeData.mtd);
            document.getElementById('finance-pending').textContent = fmtXPF(financeData.pending);

            // Update sidebar badge
            const navBadge = document.getElementById('nav-finance-mrr');
            if (navBadge) {
                navBadge.textContent = financeData.mrr > 0 ? (financeData.mrr / 1000000).toFixed(1) + 'M' : '0';
            }

            // Update breakdown
            document.getElementById('finance-projects').textContent = fmtXPF(financeData.projects);
            document.getElementById('finance-recurring').textContent = fmtXPF(financeData.recurring);
            document.getElementById('finance-upsells').textContent = fmtXPF(financeData.upsells);

            // Render chart
            renderFinanceChart();

            // Render clients MRR
            renderClientsMRR();
        }

        function renderFinanceChart() {
            const container = document.getElementById('finance-chart-container');
            if (!container || !financeData.monthlyTrend.length) return;

            const maxValue = Math.max(...financeData.monthlyTrend.map(m => m.value));

            container.innerHTML = financeData.monthlyTrend.map((m, i) => {
                const height = maxValue > 0 ? (m.value / maxValue * 100) : 10;
                return `
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.5rem; opacity: 0; animation: chartBarIn 0.5s ease forwards; animation-delay: ${i * 100}ms;">
                        <div style="font-size: 0.75rem; color: var(--text-muted);">${(m.value / 1000000).toFixed(1)}M</div>
                        <div class="finance-bar" style="width: 100%; height: ${height}%; min-height: 20px; background: linear-gradient(180deg, var(--accent) 0%, var(--purple) 100%); border-radius: 8px 8px 0 0; transform-origin: bottom; animation: barGrow 0.6s ease forwards; animation-delay: ${i * 100}ms;"></div>
                        <div style="font-size: 0.75rem; color: var(--text-dim); text-transform: capitalize;">${m.month}</div>
                    </div>
                `;
            }).join('');
        }

        function renderClientsMRR() {
            const container = document.getElementById('finance-clients-mrr');
            if (!container) return;

            if (financeData.clients.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: var(--text-dim); padding: 2rem; grid-column: 1 / -1;">
                        Aucun client recurrent. Les clients avec abonnement mensuel apparaitront ici.
                    </div>
                `;
                return;
            }

            container.innerHTML = financeData.clients.map(c => `
                <div style="background: var(--bg-subtle); border-radius: 12px; padding: 1rem; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 600;">${c.name}</div>
                        <div style="font-size: 0.75rem; color: var(--text-dim);">Depuis ${c.since || 'N/A'}</div>
                    </div>
                    <div style="font-size: 1.25rem; font-weight: 700; color: var(--green);">${fmtXPF(c.mrr)}/mois</div>
                </div>
            `).join('');
        }

        function openNewInvoiceModal() {
            // Ouvrir Zoho Invoice dans un nouvel onglet
            window.open('https://invoice.zoho.com/app/invoices#/invoices/new', '_blank');
            showToast('Redirection vers Zoho Invoice...');
        }

        // ===== END FINANCE MODULE =====

        // ============================================
        // LEAD SCORING MODULE
        // ============================================
        const LEAD_SCORING_WEBHOOK = getN8nWebhook('leadScoring');
        let prospectScores = {}; // Cache des scores { prospectId: { score, urgence, ... } }

        // Charger les scores depuis localStorage au démarrage
        function loadProspectScores() {
            const saved = localStorage.getItem('pk_prospect_scores');
            if (saved) {
                prospectScores = JSON.parse(saved);
            }
        }

        // Sauvegarder les scores dans localStorage
        function saveProspectScores() {
            localStorage.setItem('pk_prospect_scores', JSON.stringify(prospectScores));
        }

        // Scorer un prospect via le workflow n8n
        async function scoreProspect(prospect) {
            try {
                const response = await fetch(LEAD_SCORING_WEBHOOK, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prospectId: prospect.id || prospect.airtableId,
                        company: prospect.company,
                        sector: prospect.sector,
                        contact: prospect.name,
                        notes: prospect.notes || '',
                        value: prospect.value
                    })
                });

                if (!response.ok) throw new Error('Scoring failed');

                const result = await response.json();

                // Stocker le score
                const prospectKey = prospect.id || prospect.airtableId;
                prospectScores[prospectKey] = {
                    score: result.score,
                    urgence: result.urgence,
                    budget_estime: result.budget_estime,
                    fit_score: result.fit_score,
                    pain_points: result.pain_points,
                    recommandation: result.recommandation,
                    scored_at: result.scored_at
                };

                saveProspectScores();
                showToast(`Score: ${result.score}/100 pour ${prospect.company}`);

                // Rafraîchir l'affichage
                renderProspectsTable('all');
                renderPipeline();

                return result;
            } catch (e) {
                console.error('Lead scoring error:', e);
                showToast('Erreur lors du scoring', 'error');
                return null;
            }
        }

        // Scorer tous les prospects sans score
        async function scoreAllProspects() {
            const unscored = prospects.filter(p => {
                const key = p.id || p.airtableId;
                return !prospectScores[key];
            });

            if (unscored.length === 0) {
                showToast('Tous les prospects sont deja scores');
                return;
            }

            showToast(`Scoring de ${unscored.length} prospects...`);

            for (const prospect of unscored) {
                await scoreProspect(prospect);
                // Pause entre les requêtes pour ne pas surcharger
                await new Promise(r => setTimeout(r, 500));
            }

            showToast(`${unscored.length} prospects scores`);
        }

        // Obtenir le badge HTML pour un score
        function getScoreBadge(prospectId) {
            const scoreData = prospectScores[prospectId];
            if (!scoreData) return '';

            const score = scoreData.score;
            let color = 'var(--red)';
            let label = 'Froid';

            if (score >= 80) {
                color = 'var(--green)';
                label = 'Hot';
            } else if (score >= 60) {
                color = 'var(--yellow)';
                label = 'Warm';
            } else if (score >= 40) {
                color = 'var(--orange)';
                label = 'Tiède';
            }

            return `
                <span class="score-badge" style="background: ${color}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; cursor: pointer;"
                      onclick="showScoreDetails('${prospectId}')" title="Cliquer pour détails">
                    ${score}
                </span>
            `;
        }

        // Afficher les détails du score dans une modal
        function showScoreDetails(prospectId) {
            const scoreData = prospectScores[prospectId];
            if (!scoreData) return;

            const prospect = prospects.find(p => (p.id == prospectId || p.airtableId == prospectId));
            const companyName = prospect ? prospect.company : 'Prospect';

            const urgenceColors = {
                'critical': 'var(--red)',
                'high': 'var(--orange)',
                'medium': 'var(--yellow)',
                'low': 'var(--text-dim)'
            };

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>Score IA: ${companyName}</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                    </div>
                    <div class="modal-content">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                            <div style="text-align: center; padding: 1rem; background: var(--bg-subtle); border-radius: 12px;">
                                <div style="font-size: 2.5rem; font-weight: 700; color: ${scoreData.score >= 80 ? 'var(--green)' : scoreData.score >= 50 ? 'var(--yellow)' : 'var(--red)'};">${scoreData.score}</div>
                                <div style="font-size: 0.75rem; color: var(--text-dim);">Score Global</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: var(--bg-subtle); border-radius: 12px;">
                                <div style="font-size: 2.5rem; font-weight: 700; color: var(--purple);">${scoreData.fit_score || 'N/A'}</div>
                                <div style="font-size: 0.75rem; color: var(--text-dim);">Fit Score</div>
                            </div>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <div style="font-size: 0.75rem; color: var(--text-dim); margin-bottom: 0.25rem;">Urgence</div>
                            <span style="background: ${urgenceColors[scoreData.urgence] || 'var(--text-dim)'}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; text-transform: uppercase;">
                                ${scoreData.urgence || 'N/A'}
                            </span>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <div style="font-size: 0.75rem; color: var(--text-dim); margin-bottom: 0.25rem;">Budget Estimé</div>
                            <div style="font-weight: 600; color: var(--green);">${scoreData.budget_estime || 'Non estimé'}</div>
                        </div>

                        ${scoreData.pain_points && scoreData.pain_points.length ? `
                            <div style="margin-bottom: 1rem;">
                                <div style="font-size: 0.75rem; color: var(--text-dim); margin-bottom: 0.5rem;">Pain Points Identifiés</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                    ${scoreData.pain_points.map(p => `<span style="background: var(--bg-hover); padding: 4px 10px; border-radius: 16px; font-size: 0.75rem;">${p}</span>`).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <div style="margin-bottom: 1rem;">
                            <div style="font-size: 0.75rem; color: var(--text-dim); margin-bottom: 0.25rem;">Recommandation</div>
                            <div style="color: var(--text); line-height: 1.5;">${scoreData.recommandation || 'Aucune recommandation'}</div>
                        </div>

                        <div style="font-size: 0.7rem; color: var(--text-dim); text-align: right;">
                            Scoré le ${new Date(scoreData.scored_at).toLocaleDateString('fr-FR')}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="this.closest('.modal-overlay').remove()">Fermer</button>
                        <button class="btn btn-primary" onclick="rescoreProspect('${prospectId}')">Re-scorer</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Re-scorer un prospect
        async function rescoreProspect(prospectId) {
            const prospect = prospects.find(p => (p.id == prospectId || p.airtableId == prospectId));
            if (!prospect) return;

            document.querySelector('.modal-overlay')?.remove();
            await scoreProspect(prospect);
        }

        // Charger les scores au démarrage
        loadProspectScores();

        // ===== END LEAD SCORING MODULE =====

        async function loadBlogArticles() {
            try {
                const data = await supabase.getBlogArticles();

                blogArticles = data.map(record => ({
                    id: record.id,
                    title: record.title || '',
                    slug: record.slug || '',
                    category: record.category || '',
                    status: record.status || 'draft',
                    excerpt: record.excerpt || '',
                    content: record.content || '',
                    heroImage: record.image_url || '',
                    readingTime: 5,
                    featured: false,
                    publishDate: record.publish_date || '',
                    sources: '',
                    ctaTitle: '',
                    ctaText: '',
                    metaDescription: ''
                }));

                console.log(`[Blog] Loaded ${blogArticles.length} articles from Supabase`);

                renderBlogArticles();
                updateBlogStats();
                if (blogArticles.length > 0) {
                    showToast(`${blogArticles.length} articles charges`);
                }

            } catch (error) {
                console.error('[Blog] Error loading from Supabase:', error);
                showToast('Erreur chargement articles');
            }
        }

        function filterBlogArticles() {
            currentBlogCategoryFilter = document.getElementById('blog-category-filter')?.value || 'all';
            currentBlogStatusFilter = document.getElementById('blog-status-filter')?.value || 'all';
            renderBlogArticles();
        }

        function renderBlogArticles() {
            const container = document.getElementById('blog-articles-grid');
            if (!container) return;

            let articles = [...blogArticles];

            // Apply category filter
            if (currentBlogCategoryFilter && currentBlogCategoryFilter !== 'all') {
                articles = articles.filter(a => a.category === currentBlogCategoryFilter);
            }

            // Apply status filter
            if (currentBlogStatusFilter && currentBlogStatusFilter !== 'all') {
                articles = articles.filter(a => a.status === currentBlogStatusFilter);
            }

            if (articles.length === 0) {
                container.innerHTML = `<div style="grid-column: 1 / -1; text-align: center; color: var(--text-dim); padding: 3rem;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 48px; height: 48px; margin-bottom: 1rem; opacity: 0.5;"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
                    <p>Aucun article</p>
                </div>`;
                return;
            }

            container.innerHTML = articles.map(article => `
                <div class="blog-article-card" onclick="openEditBlogModal('${article.id}')">
                    <div class="blog-article-image">
                        ${article.heroImage ? `<img src="${article.heroImage}" alt="${article.title}" />` : `<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: var(--bg-muted);"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 32px; height: 32px; opacity: 0.3;"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg></div>`}
                        ${article.category ? `<span class="blog-article-category">${article.category}</span>` : ''}
                        ${article.featured ? `<span style="position: absolute; top: 8px; right: 8px; background: var(--yellow); color: #000; padding: 2px 6px; border-radius: 4px; font-size: 0.625rem; font-weight: 600;">FEATURED</span>` : ''}
                    </div>
                    <div class="blog-article-content">
                        <div class="blog-article-meta">
                            <span class="blog-article-status ${article.status.toLowerCase()}">${article.status}</span>
                            <span>${article.readingTime} min</span>
                        </div>
                        <h3 class="blog-article-title">${article.title || 'Sans titre'}</h3>
                        <p class="blog-article-excerpt">${article.excerpt?.substring(0, 120) || 'Pas de description'}${article.excerpt?.length > 120 ? '...' : ''}</p>
                        <div class="blog-article-footer">
                            <span>${article.publishDate ? new Date(article.publishDate).toLocaleDateString('fr-FR') : 'Non planifie'}</span>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="content-action-btn" onclick="event.stopPropagation(); previewBlogArticle('${article.id}')" title="Voir sur le site">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                                </button>
                                <button class="content-action-btn delete" onclick="event.stopPropagation(); deleteBlogArticle('${article.id}')" title="Supprimer">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateBlogStats() {
            const total = blogArticles.length;
            const published = blogArticles.filter(a => a.status === 'Published').length;
            const scheduled = blogArticles.filter(a => a.status === 'Scheduled').length;
            const drafts = blogArticles.filter(a => a.status === 'Draft' || a.status === 'Ready').length;

            const kpiTotal = document.getElementById('kpi-blog-total');
            const kpiPublished = document.getElementById('kpi-blog-published');
            const kpiScheduled = document.getElementById('kpi-blog-scheduled');
            const kpiDrafts = document.getElementById('kpi-blog-drafts');

            if (kpiTotal) kpiTotal.textContent = total;
            if (kpiPublished) kpiPublished.textContent = published;
            if (kpiScheduled) kpiScheduled.textContent = scheduled;
            if (kpiDrafts) kpiDrafts.textContent = drafts;

            // Update nav badge
            const navCount = document.getElementById('nav-blog-count');
            if (navCount) navCount.textContent = published;
        }

        function previewBlogArticle(articleId) {
            const article = blogArticles.find(a => a.id === articleId);
            if (!article || !article.slug) {
                showToast('Article sans slug');
                return;
            }
            window.open(`https://pacifikai.com/blog/articles/${article.slug}.html`, '_blank');
        }

        async function deleteBlogArticle(articleId) {
            if (!confirm('Supprimer cet article ?')) return;

            try {
                await supabase.deleteBlogArticle(articleId);

                blogArticles = blogArticles.filter(a => a.id !== articleId);
                renderBlogArticles();
                updateBlogStats();
                showToast('Article supprime');

            } catch (error) {
                console.error('[Blog] Delete error:', error);
                showToast('Erreur suppression');
            }
        }

        function openCreateBlogModal() {
            editingBlogArticleId = null;

            document.getElementById('blog-modal-title').textContent = 'Nouvel Article';
            document.getElementById('blog-article-id').value = '';
            document.getElementById('blog-article-title').value = '';
            document.getElementById('blog-article-slug').value = '';
            document.getElementById('blog-article-category').value = 'Aviation';
            document.getElementById('blog-article-status').value = 'Draft';
            document.getElementById('blog-article-excerpt').value = '';
            document.getElementById('blog-article-content').value = '';
            document.getElementById('blog-article-image').value = '';
            document.getElementById('blog-article-reading-time').value = '5';
            document.getElementById('blog-article-featured').checked = false;
            document.getElementById('blog-article-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('blog-article-sources').value = '';
            document.getElementById('blog-article-cta-title').value = '';
            document.getElementById('blog-article-cta-text').value = '';
            document.getElementById('blog-article-meta-desc').value = '';

            document.getElementById('blog-article-modal').style.display = 'flex';
        }

        function openEditBlogModal(articleId) {
            const article = blogArticles.find(a => a.id === articleId);
            if (!article) return;

            editingBlogArticleId = articleId;

            document.getElementById('blog-modal-title').textContent = 'Modifier: ' + (article.title || 'Sans titre');
            document.getElementById('blog-article-id').value = articleId;
            document.getElementById('blog-article-title').value = article.title || '';
            document.getElementById('blog-article-slug').value = article.slug || '';
            document.getElementById('blog-article-category').value = article.category || 'Aviation';
            document.getElementById('blog-article-status').value = article.status || 'Draft';
            document.getElementById('blog-article-excerpt').value = article.excerpt || '';
            document.getElementById('blog-article-content').value = article.content || '';
            document.getElementById('blog-article-image').value = article.heroImage || '';
            document.getElementById('blog-article-reading-time').value = article.readingTime || 5;
            document.getElementById('blog-article-featured').checked = article.featured || false;
            document.getElementById('blog-article-date').value = article.publishDate || '';
            document.getElementById('blog-article-sources').value = article.sources || '';
            document.getElementById('blog-article-cta-title').value = article.ctaTitle || '';
            document.getElementById('blog-article-cta-text').value = article.ctaText || '';
            document.getElementById('blog-article-meta-desc').value = article.metaDescription || '';

            document.getElementById('blog-article-modal').style.display = 'flex';
        }

        function closeBlogModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('blog-article-modal').style.display = 'none';
            editingBlogArticleId = null;
        }

        async function saveBlogArticle() {
            const id = document.getElementById('blog-article-id').value;
            const title = document.getElementById('blog-article-title').value;
            const slug = document.getElementById('blog-article-slug').value || title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
            const category = document.getElementById('blog-article-category').value;
            const status = document.getElementById('blog-article-status').value;
            const excerpt = document.getElementById('blog-article-excerpt').value;
            const content = document.getElementById('blog-article-content').value;
            const heroImage = document.getElementById('blog-article-image').value;
            const readingTime = parseInt(document.getElementById('blog-article-reading-time').value) || 5;
            const featured = document.getElementById('blog-article-featured').checked;
            const publishDate = document.getElementById('blog-article-date').value;
            const sources = document.getElementById('blog-article-sources').value;
            const ctaTitle = document.getElementById('blog-article-cta-title').value;
            const ctaText = document.getElementById('blog-article-cta-text').value;
            const metaDescription = document.getElementById('blog-article-meta-desc').value;

            if (!title) {
                showToast('Titre requis');
                return;
            }

            // Supabase data format
            const data = {
                title: title,
                slug: slug,
                category: category,
                status: status,
                excerpt: excerpt || null,
                content: content || null,
                image_url: heroImage || null,
                publish_date: publishDate || null,
                author: 'PACIFIK\'AI'
            };

            try {
                if (id) {
                    await supabase.updateBlogArticle(id, data);
                } else {
                    await supabase.createBlogArticle(data);
                }

                closeBlogModal();
                await loadBlogArticles();
                showToast(id ? 'Article mis a jour' : 'Article cree');

            } catch (error) {
                console.error('[Blog] Save error:', error);
                showToast('Erreur: ' + error.message);
            }
        }

        // ============================================
        // NEWSLETTER MANAGEMENT (Supabase)
        // ============================================

        const BREVO_API_KEY = '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';
        const BREVO_LIST_ID = 6;
        let newsletterCampaigns = [];
        let currentNewsletterFilter = 'all';
        let editingNewsletterCampaignId = null;

        async function loadNewsletterCampaigns() {
            try {
                const data = await supabase.getNewsletterCampaigns();

                newsletterCampaigns = data.map(record => ({
                    id: record.id,
                    subject: record.subject || '',
                    previewText: record.preview_text || '',
                    contentHtml: record.content || '',
                    contentJson: '',
                    status: record.status ? record.status.charAt(0).toUpperCase() + record.status.slice(1) : 'Draft',
                    scheduledDate: record.scheduled_date || '',
                    sentDate: record.sent_date || '',
                    brevoCampaignId: '',
                    listId: BREVO_LIST_ID,
                    opens: Math.round((record.open_rate || 0) * (record.recipients_count || 0)),
                    clicks: Math.round((record.click_rate || 0) * (record.recipients_count || 0)),
                    recipients: record.recipients_count || 0
                }));

                console.log(`[Newsletter] Loaded ${newsletterCampaigns.length} campaigns from Supabase`);

                renderNewsletterCampaigns();
                updateNewsletterStats();
                if (newsletterCampaigns.length > 0) {
                    showToast(`${newsletterCampaigns.length} campagnes chargees`);
                }

            } catch (error) {
                console.error('[Newsletter] Error loading from Supabase:', error);
                showToast('Erreur chargement campagnes');
            }
        }

        function filterNewsletterCampaigns() {
            currentNewsletterFilter = document.getElementById('newsletter-status-filter')?.value || 'all';
            renderNewsletterCampaigns();
        }

        function renderNewsletterCampaigns() {
            const container = document.getElementById('newsletter-campaigns-list');
            if (!container) return;

            let campaigns = [...newsletterCampaigns];

            if (currentNewsletterFilter && currentNewsletterFilter !== 'all') {
                campaigns = campaigns.filter(c => c.status === currentNewsletterFilter);
            }

            if (campaigns.length === 0) {
                container.innerHTML = `<div style="text-align: center; color: var(--text-dim); padding: 3rem;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 48px; height: 48px; margin-bottom: 1rem; opacity: 0.5;"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                    <p>Aucune campagne</p>
                </div>`;
                return;
            }

            container.innerHTML = campaigns.map(campaign => `
                <div class="newsletter-campaign-item" onclick="openEditNewsletterModal('${campaign.id}')">
                    <div class="newsletter-campaign-icon ${campaign.status.toLowerCase()}">
                        ${campaign.status === 'Sent' ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>' :
                          campaign.status === 'Scheduled' ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>' :
                          campaign.status === 'Ready' ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>' :
                          '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>'}
                    </div>
                    <div class="newsletter-campaign-info">
                        <div class="newsletter-campaign-subject">${campaign.subject || 'Sans objet'}</div>
                        <div class="newsletter-campaign-meta">
                            <span>${campaign.status}</span>
                            ${campaign.scheduledDate ? `<span>Planifie: ${new Date(campaign.scheduledDate).toLocaleDateString('fr-FR')}</span>` : ''}
                            ${campaign.sentDate ? `<span>Envoye: ${new Date(campaign.sentDate).toLocaleDateString('fr-FR')}</span>` : ''}
                        </div>
                    </div>
                    ${campaign.status === 'Sent' ? `
                    <div class="newsletter-campaign-stats">
                        <div class="newsletter-stat">
                            <div class="newsletter-stat-value">${campaign.recipients}</div>
                            <div class="newsletter-stat-label">Envois</div>
                        </div>
                        <div class="newsletter-stat">
                            <div class="newsletter-stat-value" style="color: var(--green);">${campaign.opens}</div>
                            <div class="newsletter-stat-label">Ouvertures</div>
                        </div>
                        <div class="newsletter-stat">
                            <div class="newsletter-stat-value" style="color: var(--accent);">${campaign.clicks}</div>
                            <div class="newsletter-stat-label">Clics</div>
                        </div>
                    </div>
                    ` : ''}
                    <div class="newsletter-campaign-actions">
                        <button class="content-action-btn delete" onclick="event.stopPropagation(); deleteNewsletterCampaign('${campaign.id}')" title="Supprimer">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function updateNewsletterStats() {
            const total = newsletterCampaigns.length;
            const scheduled = newsletterCampaigns.filter(c => c.status === 'Scheduled').length;
            const sent = newsletterCampaigns.filter(c => c.status === 'Sent').length;

            // Fetch subscribers count from Brevo
            let subscribers = 0;
            try {
                const res = await fetch(`https://api.brevo.com/v3/contacts/lists/${BREVO_LIST_ID}`, {
                    headers: { 'api-key': BREVO_API_KEY }
                });
                if (res.ok) {
                    const data = await res.json();
                    subscribers = data.uniqueSubscribers || 0;
                }
            } catch (e) { console.log('Could not fetch Brevo stats'); }

            document.getElementById('kpi-newsletter-subscribers').textContent = subscribers;
            document.getElementById('kpi-newsletter-campaigns').textContent = total;
            document.getElementById('kpi-newsletter-scheduled').textContent = scheduled;
            document.getElementById('kpi-newsletter-sent').textContent = sent;

            const navCount = document.getElementById('nav-newsletter-count');
            if (navCount) navCount.textContent = scheduled || total;
        }

        function openCreateNewsletterModal() {
            editingNewsletterCampaignId = null;

            document.getElementById('newsletter-modal-title').textContent = 'Nouvelle Campagne';
            document.getElementById('newsletter-campaign-id').value = '';
            document.getElementById('newsletter-subject').value = '';
            document.getElementById('newsletter-preview-text').value = '';
            document.getElementById('newsletter-status').value = 'Draft';
            document.getElementById('newsletter-scheduled-date').value = '';
            document.getElementById('newsletter-content-html').value = getDefaultNewsletterTemplate();

            updateNewsletterPreview();
            document.getElementById('newsletter-editor-modal').style.display = 'flex';
        }

        function openEditNewsletterModal(campaignId) {
            const campaign = newsletterCampaigns.find(c => c.id === campaignId);
            if (!campaign) return;

            editingNewsletterCampaignId = campaignId;

            document.getElementById('newsletter-modal-title').textContent = 'Modifier: ' + (campaign.subject || 'Sans objet');
            document.getElementById('newsletter-campaign-id').value = campaignId;
            document.getElementById('newsletter-subject').value = campaign.subject || '';
            document.getElementById('newsletter-preview-text').value = campaign.previewText || '';
            document.getElementById('newsletter-status').value = campaign.status || 'Draft';
            document.getElementById('newsletter-scheduled-date').value = campaign.scheduledDate ? campaign.scheduledDate.slice(0, 16) : '';
            document.getElementById('newsletter-content-html').value = campaign.contentHtml || getDefaultNewsletterTemplate();

            updateNewsletterPreview();
            document.getElementById('newsletter-editor-modal').style.display = 'flex';
        }

        function closeNewsletterModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('newsletter-editor-modal').style.display = 'none';
            editingNewsletterCampaignId = null;
        }

        function updateNewsletterPreview() {
            const subject = document.getElementById('newsletter-subject').value;
            const content = document.getElementById('newsletter-content-html').value;

            document.getElementById('preview-subject').textContent = subject || '-';
            document.getElementById('newsletter-preview-content').innerHTML = content || '<p style="color: #999; text-align: center;">Apercu du contenu...</p>';
        }

        function getDefaultNewsletterTemplate() {
            return `<div style="font-family: 'Helvetica Neue', Arial, sans-serif; max-width: 600px; margin: 0 auto;">
    <div style="text-align: center; padding: 20px 0; border-bottom: 2px solid #3b82f6;">
        <h1 style="color: #3b82f6; font-size: 24px; margin: 0;">PACIFIK'AI</h1>
        <p style="color: #666; font-size: 12px; margin-top: 5px;">Solutions IA pour la Polynesie</p>
    </div>

    <div style="padding: 30px 20px;">
        <h2 style="color: #333; font-size: 20px;">Titre de l'article</h2>
        <p style="color: #555; line-height: 1.6;">
            Votre contenu ici. Partagez des insights sur l'IA, des cas d'usage locaux, ou des actualites du secteur.
        </p>
    </div>

    <div style="background: #f8f9fa; padding: 20px; text-align: center; border-radius: 8px; margin: 20px;">
        <h3 style="color: #333; margin-bottom: 10px;">Pret a transformer votre entreprise ?</h3>
        <a href="https://pacifikai.com" style="display: inline-block; background: #3b82f6; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; font-weight: 600;">Discutons de votre projet</a>
    </div>

    <div style="text-align: center; padding: 20px; color: #999; font-size: 12px; border-top: 1px solid #eee;">
        <p>PACIFIK'AI - Tahiti, Polynesie francaise</p>
        <p><a href="https://pacifikai.com" style="color: #3b82f6;">pacifikai.com</a></p>
    </div>
</div>`;
        }

        function insertNewsletterBlock(type) {
            const textarea = document.getElementById('newsletter-content-html');
            let block = '';

            switch(type) {
                case 'header':
                    block = `<div style="text-align: center; padding: 20px 0; border-bottom: 2px solid #3b82f6;">
    <h1 style="color: #3b82f6; font-size: 24px; margin: 0;">PACIFIK'AI</h1>
    <p style="color: #666; font-size: 12px; margin-top: 5px;">Solutions IA pour la Polynesie</p>
</div>`;
                    break;
                case 'article':
                    block = `<div style="padding: 30px 20px;">
    <h2 style="color: #333; font-size: 20px;">Titre</h2>
    <p style="color: #555; line-height: 1.6;">Contenu de l'article...</p>
</div>`;
                    break;
                case 'cta':
                    block = `<div style="background: #f8f9fa; padding: 20px; text-align: center; border-radius: 8px; margin: 20px;">
    <h3 style="color: #333; margin-bottom: 10px;">Appel a l'action</h3>
    <a href="https://pacifikai.com" style="display: inline-block; background: #3b82f6; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; font-weight: 600;">Bouton</a>
</div>`;
                    break;
                case 'footer':
                    block = `<div style="text-align: center; padding: 20px; color: #999; font-size: 12px; border-top: 1px solid #eee;">
    <p>PACIFIK'AI - Tahiti, Polynesie francaise</p>
    <p><a href="https://pacifikai.com" style="color: #3b82f6;">pacifikai.com</a></p>
</div>`;
                    break;
            }

            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            textarea.value = textarea.value.substring(0, start) + block + textarea.value.substring(end);
            updateNewsletterPreview();
        }

        async function saveNewsletterCampaign() {
            const id = document.getElementById('newsletter-campaign-id').value;
            const subject = document.getElementById('newsletter-subject').value;
            const previewText = document.getElementById('newsletter-preview-text').value;
            const status = document.getElementById('newsletter-status').value;
            const scheduledDate = document.getElementById('newsletter-scheduled-date').value;
            const contentHtml = document.getElementById('newsletter-content-html').value;

            if (!subject) {
                showToast('Objet requis');
                return;
            }

            // Supabase data format
            const data = {
                subject: subject,
                preview_text: previewText || null,
                status: status.toLowerCase(),
                content: contentHtml || null,
                scheduled_date: scheduledDate ? new Date(scheduledDate).toISOString() : null
            };

            try {
                if (id) {
                    await supabase.updateNewsletterCampaign(id, data);
                } else {
                    await supabase.createNewsletterCampaign(data);
                }

                closeNewsletterModal();
                await loadNewsletterCampaigns();
                showToast(id ? 'Campagne mise a jour' : 'Campagne creee');

            } catch (error) {
                console.error('[Newsletter] Save error:', error);
                showToast('Erreur sauvegarde');
            }
        }

        async function deleteNewsletterCampaign(campaignId) {
            if (!confirm('Supprimer cette campagne ?')) return;

            try {
                await supabase.deleteNewsletterCampaign(campaignId);

                newsletterCampaigns = newsletterCampaigns.filter(c => c.id !== campaignId);
                renderNewsletterCampaigns();
                updateNewsletterStats();
                showToast('Campagne supprimee');

            } catch (error) {
                console.error('[Newsletter] Delete error:', error);
                showToast('Erreur suppression');
            }
        }

        async function sendTestNewsletter() {
            const subject = document.getElementById('newsletter-subject').value;
            const contentHtml = document.getElementById('newsletter-content-html').value;

            if (!subject || !contentHtml) {
                showToast('Objet et contenu requis');
                return;
            }

            try {
                const response = await fetch('https://api.brevo.com/v3/smtp/email', {
                    method: 'POST',
                    headers: {
                        'api-key': BREVO_API_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sender: { name: "PACIFIK'AI", email: 'newsletter@pacifikai.com' },
                        to: [{ email: 'jordy@pacifikai.com', name: 'Jordy Banks' }],
                        subject: '[TEST] ' + subject,
                        htmlContent: contentHtml
                    })
                });

                if (response.ok) {
                    showToast('Email test envoye a jordy@pacifikai.com');
                } else {
                    const err = await response.json();
                    throw new Error(err.message || 'Erreur envoi');
                }
            } catch (error) {
                console.error('[Newsletter] Test error:', error);
                showToast('Erreur: ' + error.message);
            }
        }

        async function sendNewsletterCampaign() {
            const id = document.getElementById('newsletter-campaign-id').value;
            const subject = document.getElementById('newsletter-subject').value;
            const previewText = document.getElementById('newsletter-preview-text').value;
            const contentHtml = document.getElementById('newsletter-content-html').value;

            if (!subject || !contentHtml) {
                showToast('Objet et contenu requis');
                return;
            }

            if (!confirm('Envoyer cette campagne a tous les abonnes ?')) return;

            try {
                // Create campaign in Brevo
                const createRes = await fetch('https://api.brevo.com/v3/emailCampaigns', {
                    method: 'POST',
                    headers: {
                        'api-key': BREVO_API_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: subject + ' - ' + new Date().toISOString().split('T')[0],
                        subject: subject,
                        previewText: previewText,
                        sender: { name: "PACIFIK'AI", email: 'newsletter@pacifikai.com' },
                        htmlContent: contentHtml,
                        recipients: { listIds: [BREVO_LIST_ID] }
                    })
                });

                if (!createRes.ok) {
                    const err = await createRes.json();
                    throw new Error(err.message || 'Erreur creation campagne');
                }

                const campaign = await createRes.json();

                // Send campaign
                const sendRes = await fetch(`https://api.brevo.com/v3/emailCampaigns/${campaign.id}/sendNow`, {
                    method: 'POST',
                    headers: { 'api-key': BREVO_API_KEY }
                });

                if (!sendRes.ok) {
                    const err = await sendRes.json();
                    throw new Error(err.message || 'Erreur envoi');
                }

                // Update Supabase
                if (id) {
                    await supabase.updateNewsletterCampaign(id, {
                        status: 'sent',
                        sent_date: new Date().toISOString()
                    });
                }

                closeNewsletterModal();
                await loadNewsletterCampaigns();
                showToast('Campagne envoyee !');

            } catch (error) {
                console.error('[Newsletter] Send error:', error);
                showToast('Erreur: ' + error.message);
            }
        }

        // ============================================
        // INITIALIZATION UPDATES
        // ============================================

        // Initialize notifications on load
        document.addEventListener('DOMContentLoaded', () => {
            renderNotifications();

            // Check task deadlines every minute
            setInterval(checkTaskDeadlines, 60000);
            checkTaskDeadlines();
        });
    </script>
    <style>
        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        @keyframes toastIn {
            from { transform: translateY(16px) scale(0.96); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        @keyframes toastOut {
            from { transform: translateY(0) scale(1); opacity: 1; }
            to { transform: translateY(-8px) scale(0.96); opacity: 0; }
        }
        .spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Small loading spinner for buttons */
        .loading-spinner-small {
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
            margin-right: 6px;
        }

        /* Progress steps for fiche generation */
        .progress-step {
            padding: 6px 0;
            padding-left: 24px;
            position: relative;
            color: var(--text-dim);
            transition: all 0.3s ease;
        }
        .progress-step::before {
            content: '';
            position: absolute;
            left: 4px;
            top: 50%;
            transform: translateY(-50%);
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--border);
            transition: all 0.3s ease;
        }
        .progress-step.active {
            color: var(--accent);
            font-weight: 500;
        }
        .progress-step.active::before {
            background: var(--accent);
            box-shadow: 0 0 8px var(--accent);
            animation: pulse-step 1.5s ease infinite;
        }
        .progress-step.done {
            color: var(--success);
        }
        .progress-step.done::before {
            background: var(--success);
        }
        @keyframes pulse-step {
            0%, 100% { transform: translateY(-50%) scale(1); opacity: 1; }
            50% { transform: translateY(-50%) scale(1.2); opacity: 0.7; }
        }

        /* Bouton close modal */
        .btn-close-modal {
            position: absolute;
            top: 12px;
            right: 12px;
            background: transparent;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        .btn-close-modal:hover {
            background: var(--bg-subtle);
            color: var(--text);
        }

        /* Bouton generation en cours */
        .fiche-ia-generate.generating {
            pointer-events: auto;
            background: var(--accent);
            animation: pulse-generating 2s ease-in-out infinite;
        }
        @keyframes pulse-generating {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Success notification top-right */
        .success-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--green-glow);
            border: 1px solid var(--green);
            border-radius: var(--radius-md);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 10000;
            backdrop-filter: blur(12px);
            box-shadow: var(--shadow-lg);
            transform: translateX(120%);
            transition: transform 0.3s ease;
            max-width: 320px;
        }
        .success-notification.show {
            transform: translateX(0);
        }
        .success-notification-icon {
            width: 36px;
            height: 36px;
            background: rgba(34, 197, 94, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .success-notification-icon svg {
            width: 18px;
            height: 18px;
            stroke: #22c55e;
        }
        .success-notification-title {
            font-weight: 600;
            font-size: 0.875rem;
            color: #22c55e;
        }
        .success-notification-subtitle {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 2px;
        }
    </style>

    <!-- Global Search Overlay -->
    <div class="search-overlay" id="search-overlay" onclick="closeGlobalSearch(event)">
        <div class="search-modal" onclick="event.stopPropagation()">
            <div class="search-input-wrapper">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                <input type="text" class="search-input" id="global-search-input" placeholder="Rechercher prospects, taches, actions..." oninput="handleGlobalSearch(this.value)">
                <span class="search-shortcut">ESC</span>
            </div>
            <div class="search-results" id="search-results">
                <div class="search-section">
                    <div class="search-section-title">Actions Rapides</div>
                    <div class="search-result" onclick="executeSearchAction('new-prospect')">
                        <div class="search-result-icon action"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></div>
                        <div class="search-result-content">
                            <div class="search-result-title">Nouveau prospect</div>
                            <div class="search-result-meta">Ouvrir Airtable pour ajouter</div>
                        </div>
                    </div>
                    <div class="search-result" onclick="executeSearchAction('focus')">
                        <div class="search-result-icon action"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg></div>
                        <div class="search-result-content">
                            <div class="search-result-title">Mode Focus</div>
                            <div class="search-result-meta">Vue concentree sur les taches du jour</div>
                        </div>
                    </div>
                    <div class="search-result" onclick="executeSearchAction('sync')">
                        <div class="search-result-icon action"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg></div>
                        <div class="search-result-content">
                            <div class="search-result-title">Synchroniser Airtable</div>
                            <div class="search-result-meta">Rafraichir les donnees</div>
                        </div>
                    </div>
                </div>
                <div class="search-section" id="search-prospects-section" style="display:none;">
                    <div class="search-section-title">Prospects</div>
                    <div id="search-prospects-results"></div>
                </div>
                <div class="search-section" id="search-tasks-section" style="display:none;">
                    <div class="search-section-title">Taches</div>
                    <div id="search-tasks-results"></div>
                </div>
            </div>
            <div class="search-footer">
                <span><kbd>↑</kbd><kbd>↓</kbd> Navigation</span>
                <span><kbd>↵</kbd> Selectionner</span>
                <span><kbd>ESC</kbd> Fermer</span>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="context-menu">
        <div class="context-menu-item" onclick="contextMenuAction('change-status')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            Changer le statut
        </div>
        <div class="context-menu-item" onclick="contextMenuAction('change-priority')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
            Changer la priorite
        </div>
        <div class="context-menu-item" onclick="contextMenuAction('add-note')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
            Ajouter une note
        </div>
        <div class="context-menu-item" onclick="contextMenuAction('create-task')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="9" y1="9" x2="15" y2="15"/><line x1="15" y1="9" x2="9" y2="15"/></svg>
            Creer une tache liee
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="contextMenuAction('send-email')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
            Envoyer un email
        </div>
        <div class="context-menu-item" onclick="contextMenuAction('schedule-followup')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
            Planifier relance
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="contextMenuAction('open-detail')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
            Voir les details
        </div>
    </div>

    <!-- Guide Interactif Button - SUPPRIME (deplace dans header) -->

    <!-- Guide Interactif Overlay -->
    <div class="guide-overlay" id="guide-overlay"></div>
    <div class="guide-tooltip" id="guide-tooltip">
        <div class="guide-tooltip-header">
            <span class="guide-step-indicator" id="guide-step-indicator">1/8</span>
            <button class="guide-close" onclick="endGuide()">&times;</button>
        </div>
        <h3 class="guide-tooltip-title" id="guide-tooltip-title"></h3>
        <p class="guide-tooltip-content" id="guide-tooltip-content"></p>
        <div class="guide-tooltip-actions">
            <button class="btn btn-ghost guide-prev" id="guide-prev" onclick="prevGuideStep()">Precedent</button>
            <button class="btn btn-primary guide-next" id="guide-next" onclick="nextGuideStep()">Suivant</button>
        </div>
    </div>

    <style>
        /* Guide Interactif Styles */
        .guide-trigger {
            position: fixed;
            bottom: 100px;
            right: 24px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--accent);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-lg);
            z-index: 998;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .guide-trigger:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.4);
        }
        .guide-trigger svg {
            width: 24px;
            height: 24px;
        }

        .guide-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9998;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            pointer-events: none;
        }
        .guide-overlay.active {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        .guide-tooltip {
            position: fixed;
            background: var(--bg-subtle);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            max-width: 360px;
            width: 90%;
            z-index: 10001;
            box-shadow: var(--shadow-lg);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
            transform: translateY(10px);
        }
        .guide-tooltip.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .guide-tooltip-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .guide-step-indicator {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--accent);
            background: var(--accent-glow);
            padding: 0.25rem 0.625rem;
            border-radius: 20px;
        }
        .guide-close {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            transition: color 0.15s;
        }
        .guide-close:hover { color: var(--text); }

        .guide-tooltip-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.5rem;
        }
        .guide-tooltip-content {
            font-size: 0.875rem;
            color: var(--text-muted);
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .guide-tooltip-actions {
            display: flex;
            justify-content: space-between;
            gap: 0.75rem;
        }
        .guide-prev { flex: 1; }
        .guide-next { flex: 1; }

        .guide-highlight {
            position: relative;
            z-index: 9999 !important;
            box-shadow: 0 0 0 4px var(--accent), 0 0 0 8px rgba(59, 130, 246, 0.3) !important;
            border-radius: var(--radius-md);
        }

        /* Pointer arrow for tooltip */
        .guide-tooltip::before {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--bg-subtle);
            border: 1px solid var(--border-subtle);
            border-right: none;
            border-bottom: none;
            transform: rotate(45deg);
        }
        .guide-tooltip.arrow-left::before {
            left: -7px;
            top: 24px;
        }
        .guide-tooltip.arrow-right::before {
            right: -7px;
            top: 24px;
            transform: rotate(-135deg);
        }
        .guide-tooltip.arrow-top::before {
            top: -7px;
            left: 50%;
            margin-left: -6px;
            transform: rotate(45deg);
        }
        .guide-tooltip.arrow-bottom::before {
            bottom: -7px;
            left: 50%;
            margin-left: -6px;
            transform: rotate(-135deg);
        }
    </style>

    <script>
        // ========== GUIDE INTERACTIF ==========
        const guideSteps = [
            {
                target: '.sidebar',
                title: 'Barre laterale de navigation',
                content: 'Navigue facilement entre les differentes sections du dashboard. Les badges indiquent le nombre d\'elements dans chaque section.',
                position: 'right'
            },
            {
                target: '[data-view="dashboard"]',
                title: 'Dashboard - Vue d\'ensemble',
                content: 'Ta page d\'accueil avec les KPIs cles: prospects, taches, revenus. Visualise rapidement l\'etat de ton business.',
                position: 'right'
            },
            {
                target: '[data-view="prospects"]',
                title: 'CRM - Gestion des Prospects',
                content: 'Gere tous tes prospects avec un pipeline visuel. Filtre par statut, temperature, secteur. Glisse-depose pour changer le statut.',
                position: 'right'
            },
            {
                target: '[data-view="tasks"]',
                title: 'Gestion des Taches',
                content: 'Organise ton travail en Kanban: A faire, En cours, Bloque, Termine. Assigne les taches a Jordy ou Honovai.',
                position: 'right'
            },
            {
                target: '[data-view="analytics"]',
                title: 'Analytics',
                content: 'Analyse les performances de ton pipeline commercial. Graphiques de conversion, tendances, et metriques cles.',
                position: 'right'
            },
            {
                target: '[data-view="content"]',
                title: 'Calendrier de Contenu',
                content: 'Planifie tes publications sur Facebook, LinkedIn, Instagram. Visualise le calendrier et programme les posts.',
                position: 'right'
            },
            {
                target: '[data-view="blog"]',
                title: 'Blog Articles',
                content: 'Gere les articles du blog pacifikai.com. Cree, edite et publie du contenu pour generer des leads.',
                position: 'right'
            },
            {
                target: '[data-view="newsletter"]',
                title: 'Newsletter',
                content: 'Gestion des campagnes email via Brevo. Cree et envoie des newsletters a tes subscribers.',
                position: 'right'
            },
            {
                target: '[data-view="messages"]',
                title: 'Messages Facebook',
                content: 'Conversations Messenger de ta page Facebook. Reponds directement ou laisse MANA repondre automatiquement.',
                position: 'right'
            },
            {
                target: '[data-view="finance"]',
                title: 'Suivi Financier',
                content: 'Visualise ton MRR, ARR, et le pipeline de revenus. Connecte a Zoho Invoice pour le suivi des factures.',
                position: 'right'
            },
            {
                target: '.chat-bubble',
                title: 'MANA - Assistant IA',
                content: 'Ton assistant commercial intelligent! Demande-lui les stats, cree des prospects, ou genere des rapports.',
                position: 'left',
                showArrow: true
            },
            {
                target: '.header-actions',
                title: 'Actions rapides',
                content: 'Cmd+K pour la recherche globale. Mode Focus pour te concentrer. Le bouton ? relance ce guide.',
                position: 'bottom'
            }
        ];

        let currentGuideStep = 0;
        let previousHighlight = null;

        function startGuide() {
            currentGuideStep = 0;
            document.getElementById('guide-overlay').classList.add('active');
            showGuideStep(currentGuideStep);
        }

        function endGuide() {
            document.getElementById('guide-overlay').classList.remove('active');
            document.getElementById('guide-tooltip').classList.remove('active');
            if (previousHighlight) {
                previousHighlight.classList.remove('guide-highlight');
                previousHighlight = null;
            }
            // Marquer comme vu
            localStorage.setItem('pk_guide_seen', 'true');
        }

        function showGuideStep(index) {
            const step = guideSteps[index];
            if (!step) return endGuide();

            // Retirer le highlight precedent
            if (previousHighlight) {
                previousHighlight.classList.remove('guide-highlight');
            }

            // Trouver l'element cible
            let target = document.querySelector(step.target);

            // Si c'est le chatbot, chercher le bon element
            if (step.target.includes('mana-toggle') || step.target.includes('chat-bubble')) {
                target = document.querySelector('.mana-toggle') || document.querySelector('.chat-bubble');
            }

            if (!target) {
                console.warn('Guide: element non trouve:', step.target);
                // Passer a l'etape suivante si l'element n'existe pas
                nextGuideStep();
                return;
            }

            // Executer l'action si definie
            if (step.action) {
                step.action();
            }

            // Ajouter le highlight
            target.classList.add('guide-highlight');
            previousHighlight = target;

            // Mettre a jour le contenu du tooltip
            document.getElementById('guide-step-indicator').textContent = `${index + 1}/${guideSteps.length}`;
            document.getElementById('guide-tooltip-title').textContent = step.title;
            document.getElementById('guide-tooltip-content').textContent = step.content;

            // Gerer les boutons
            document.getElementById('guide-prev').style.visibility = index === 0 ? 'hidden' : 'visible';
            document.getElementById('guide-next').textContent = index === guideSteps.length - 1 ? 'Terminer' : 'Suivant';

            // Positionner le tooltip
            const tooltip = document.getElementById('guide-tooltip');
            tooltip.className = 'guide-tooltip active';

            const rect = target.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();

            let top, left;

            switch (step.position) {
                case 'right':
                    top = rect.top + (rect.height / 2) - 60;
                    left = rect.right + 20;
                    tooltip.classList.add('arrow-left');
                    break;
                case 'left':
                    top = rect.top + (rect.height / 2) - 60;
                    left = rect.left - tooltipRect.width - 20;
                    tooltip.classList.add('arrow-right');
                    break;
                case 'bottom':
                    top = rect.bottom + 20;
                    left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
                    tooltip.classList.add('arrow-top');
                    break;
                case 'top':
                    top = rect.top - tooltipRect.height - 20;
                    left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
                    tooltip.classList.add('arrow-bottom');
                    break;
                default:
                    top = rect.bottom + 20;
                    left = rect.left;
            }

            // S'assurer que le tooltip reste dans l'ecran
            const maxTop = window.innerHeight - tooltipRect.height - 20;
            const maxLeft = window.innerWidth - tooltipRect.width - 20;
            top = Math.max(20, Math.min(top, maxTop));
            left = Math.max(20, Math.min(left, maxLeft));

            tooltip.style.top = `${top}px`;
            tooltip.style.left = `${left}px`;

            // Scroll vers l'element si necessaire
            target.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function nextGuideStep() {
            currentGuideStep++;
            if (currentGuideStep >= guideSteps.length) {
                endGuide();
            } else {
                showGuideStep(currentGuideStep);
            }
        }

        function prevGuideStep() {
            if (currentGuideStep > 0) {
                currentGuideStep--;
                showGuideStep(currentGuideStep);
            }
        }

        // Afficher automatiquement le guide pour les nouveaux utilisateurs
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                if (!localStorage.getItem('pk_guide_seen')) {
                    // Animation sur le bouton guide dans le header pour attirer l'attention
                    const trigger = document.getElementById('guide-trigger-header');
                    if (trigger) {
                        trigger.style.animation = 'pulse 2s infinite';
                        trigger.title = 'Nouveau? Clique ici pour un tour guide!';
                    }
                }
            }, 2000);
        });

        // Animation pulse pour attirer l'attention
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
                70% { box-shadow: 0 0 0 15px rgba(59, 130, 246, 0); }
                100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
// Force rebuild Sun Feb  1 15:01:19 -10 2026
