<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COWAN MOTOR | Dashboard Marketing</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%230ea5e9'/%3E%3Ctext x='50' y='65' text-anchor='middle' fill='white' font-size='50' font-weight='bold'%3ECM%3C/text%3E%3C/svg%3E">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #09090b;
            --bg-subtle: #18181b;
            --bg-muted: #27272a;
            --border: #27272a;
            --border-subtle: #3f3f46;
            --text: #fafafa;
            --text-muted: #a1a1aa;
            --text-dim: #71717a;
            --accent: #0ea5e9;
            --accent-muted: #0284c7;
            --green: #22c55e;
            --yellow: #eab308;
            --red: #ef4444;
            --blue: #3b82f6;
            --purple: #a855f7;

            /* Page colors */
            --page-cowan: #0ea5e9;
            --page-echappement: #6366f1;
            --page-pneus: #10b981;
            --page-pacific: #8b5cf6;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            min-height: 100vh;
        }

        /* Layout */
        .layout {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 240px;
            background: var(--bg);
            border-right: 1px solid var(--border);
            padding: 1.25rem 0.75rem;
            position: fixed;
            height: 100vh;
            display: flex;
            flex-direction: column;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0 0.75rem;
            margin-bottom: 2rem;
        }

        .logo-mark {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent) 0%, #22d3ee 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }

        .logo-text {
            font-weight: 700;
            font-size: 1rem;
        }

        .logo-text span {
            color: var(--accent);
        }

        .nav { flex: 1; }
        .nav-group { margin-bottom: 1.5rem; }

        .nav-label {
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-dim);
            padding: 0 0.75rem;
            margin-bottom: 0.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem 0.75rem;
            border-radius: 8px;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.15s;
            cursor: pointer;
        }

        .nav-item:hover { background: var(--bg-subtle); color: var(--text); }
        .nav-item.active { background: var(--bg-muted); color: var(--text); }
        .nav-item svg { width: 18px; height: 18px; opacity: 0.7; }
        .nav-item.active svg { opacity: 1; }

        .nav-badge {
            margin-left: auto;
            font-size: 0.6875rem;
            font-weight: 600;
            background: var(--accent);
            color: white;
            padding: 0.125rem 0.5rem;
            border-radius: 4px;
        }

        .sidebar-footer {
            padding: 0.75rem;
            border-top: 1px solid var(--border);
        }

        .powered-by {
            font-size: 0.6875rem;
            color: var(--text-dim);
            text-align: center;
        }

        .powered-by a {
            color: var(--accent);
            text-decoration: none;
        }

        /* Main */
        .main {
            flex: 1;
            margin-left: 240px;
            min-height: 100vh;
        }

        /* Header */
        .header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .header-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
        }

        /* Content */
        .content {
            padding: 2rem;
        }

        /* Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-muted);
        }

        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-icon svg {
            width: 20px;
            height: 20px;
        }

        .card-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .card-change {
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .card-change.positive { color: var(--green); }
        .card-change.negative { color: var(--red); }

        /* Page Cards */
        .page-card {
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .page-card:hover {
            border-color: var(--border-subtle);
            transform: translateY(-2px);
        }

        .page-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
            color: white;
        }

        .page-info { flex: 1; }

        .page-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .page-stats {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .page-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--green);
        }

        .page-status.pending { background: var(--yellow); }
        .page-status.offline { background: var(--red); }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.625rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            border: none;
            text-decoration: none;
        }

        .btn svg {
            width: 16px;
            height: 16px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-muted);
        }

        .btn-secondary {
            background: var(--bg-muted);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-muted);
        }

        .btn-ghost:hover {
            background: var(--bg-muted);
            color: var(--text);
        }

        /* Section */
        .section {
            margin-bottom: 2rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .section-title {
            font-size: 1rem;
            font-weight: 600;
        }

        /* Calendar Preview */
        .calendar-preview {
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .calendar-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .calendar-nav {
            display: flex;
            gap: 0.5rem;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .calendar-day-header {
            padding: 0.75rem;
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
        }

        .calendar-day {
            min-height: 100px;
            padding: 0.5rem;
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
        }

        .calendar-day:nth-child(7n) {
            border-right: none;
        }

        .calendar-date {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .calendar-date.today {
            color: var(--accent);
            font-weight: 600;
        }

        .calendar-event {
            font-size: 0.6875rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .calendar-event.cowan { background: rgba(14, 165, 233, 0.2); color: var(--page-cowan); }
        .calendar-event.echappement { background: rgba(99, 102, 241, 0.2); color: var(--page-echappement); }
        .calendar-event.pneus { background: rgba(16, 185, 129, 0.2); color: var(--page-pneus); }
        .calendar-event.pacific { background: rgba(139, 92, 246, 0.2); color: var(--page-pacific); }

        /* Views */
        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .empty-state p {
            font-size: 0.875rem;
            margin-bottom: 1.5rem;
        }

        /* Upload Zone */
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-zone:hover {
            border-color: var(--accent);
            background: rgba(249, 115, 22, 0.05);
        }

        .upload-zone.dragover {
            border-color: var(--accent);
            background: rgba(249, 115, 22, 0.1);
        }

        .upload-zone svg {
            width: 48px;
            height: 48px;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .upload-zone h4 {
            margin-bottom: 0.5rem;
        }

        .upload-zone p {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        /* Products Grid */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .product-card {
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
        }

        .product-card:hover {
            border-color: var(--border-subtle);
            transform: translateY(-2px);
        }

        .product-image {
            height: 150px;
            background: var(--bg-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-dim);
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-info {
            padding: 1rem;
        }

        .product-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .product-category {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Generator Types */
        .generator-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .generator-card {
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .generator-card:hover {
            border-color: var(--accent);
            background: rgba(249, 115, 22, 0.05);
        }

        .generator-icon {
            width: 48px;
            height: 48px;
            background: rgba(249, 115, 22, 0.1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .generator-card h4 {
            margin-bottom: 0.5rem;
        }

        .generator-card p {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .main {
                margin-left: 0;
            }
        }

        /* Generation Modal */
        .generation-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .generation-modal-content {
            background: var(--bg-primary);
            padding: 2rem;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        .generation-modal-content h3 {
            margin-bottom: 1rem;
            color: var(--accent);
        }

        .generation-steps {
            text-align: left;
            margin: 1.5rem 0;
        }

        .generation-steps .step {
            padding: 0.5rem 1rem;
            margin: 0.5rem 0;
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-muted);
            transition: all 0.3s ease;
        }

        .generation-steps .step.active {
            background: var(--accent);
            color: white;
        }

        .generation-timer {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent);
            margin: 1rem 0;
        }

        .generation-result img {
            max-width: 100%;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .generation-modal button {
            background: var(--bg-secondary);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            transition: background 0.2s;
        }

        .generation-modal button:hover {
            background: var(--accent);
        }

        /* Calendar Styles */
        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .calendar-nav h2 {
            min-width: 200px;
            text-align: center;
            font-size: 1.25rem;
        }

        .btn-icon {
            background: var(--bg-secondary);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-primary);
        }

        .btn-icon:hover {
            background: var(--accent);
        }

        .calendar-filters {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .filter-label {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .page-filter {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border-radius: 20px;
            font-size: 0.875rem;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .page-filter:has(input:checked) {
            border-color: var(--page-color);
            background: color-mix(in srgb, var(--page-color) 20%, transparent);
        }

        .page-filter input {
            accent-color: var(--page-color);
        }

        .calendar-container {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1rem;
            overflow: hidden;
        }

        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 8px;
        }

        .calendar-day-name {
            text-align: center;
            font-weight: 600;
            color: var(--text-muted);
            padding: 0.5rem;
            font-size: 0.875rem;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .calendar-day {
            min-height: 120px;
            max-height: 150px;
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 0.35rem;
            position: relative;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .calendar-day::-webkit-scrollbar {
            width: 3px;
        }

        .calendar-day::-webkit-scrollbar-thumb {
            background: var(--border-subtle);
            border-radius: 3px;
        }

        .calendar-day.other-month {
            opacity: 0.4;
        }

        .calendar-day.today {
            border: 2px solid var(--accent);
        }

        .calendar-day-number {
            font-weight: 600;
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
            color: var(--text-muted);
        }

        .calendar-day.today .calendar-day-number {
            color: var(--accent);
        }

        .calendar-post {
            font-size: 0.65rem;
            padding: 0.15rem 0.35rem;
            border-radius: 3px;
            margin-bottom: 2px;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border-left: 2px solid var(--post-color, var(--accent));
            background: color-mix(in srgb, var(--post-color, var(--accent)) 15%, var(--bg-secondary));
            transition: transform 0.1s;
            line-height: 1.3;
        }

        .calendar-post:hover {
            transform: translateX(2px);
        }

        .calendar-post.status-brouillon { opacity: 0.7; }
        .calendar-post.status-planifie { opacity: 1; }
        .calendar-post.status-publie { opacity: 0.5; }
        .calendar-post.status-echec { border-left-color: var(--danger); }

        .calendar-legend {
            display: flex;
            gap: 1.5rem;
            margin-top: 1rem;
            justify-content: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .status-dot.status-brouillon { background: var(--text-muted); }
        .status-dot.status-planifie { background: var(--accent); }
        .status-dot.status-publie { background: var(--success); }
        .status-dot.status-echec { background: var(--danger); }

        /* Post Detail Modal */
        .post-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .post-modal-content {
            background: var(--bg-primary);
            padding: 2rem;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .post-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .post-modal-header h3 {
            color: var(--accent);
        }

        .post-modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.5rem;
        }

        .post-preview-image {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .post-preview-text {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 8px;
            white-space: pre-wrap;
            margin-bottom: 1rem;
        }

        .post-meta {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .post-meta-item {
            background: var(--bg-secondary);
            padding: 0.75rem;
            border-radius: 8px;
        }

        .post-meta-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }

        .post-modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        /* Ideas View Styles */
        .btn-toggle {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.15s;
        }

        .btn-toggle.active {
            background: var(--accent);
            color: white;
        }

        .filter-select {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-subtle);
            color: var(--text);
            font-size: 0.875rem;
        }

        .ideas-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .idea-card {
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.15s;
        }

        .idea-card:hover {
            border-color: var(--accent);
        }

        .idea-checkbox {
            width: 20px;
            height: 20px;
            accent-color: var(--accent);
        }

        .idea-page-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .idea-content {
            flex: 1;
            min-width: 0;
        }

        .idea-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .idea-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            display: flex;
            gap: 1rem;
        }

        .idea-actions {
            display: flex;
            gap: 0.5rem;
        }

        .idea-status {
            font-size: 0.6875rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            background: var(--bg-muted);
        }

        .idea-status.status-idee { background: rgba(168, 85, 247, 0.2); color: var(--purple); }
        .idea-status.status-acceptee { background: rgba(34, 197, 94, 0.2); color: var(--green); }
        .idea-status.status-en-generation { background: rgba(234, 179, 8, 0.2); color: var(--yellow); }
        .idea-status.status-generee { background: rgba(59, 130, 246, 0.2); color: var(--blue); }

        /* Kanban Styles */
        .kanban-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            min-height: 500px;
        }

        .kanban-column {
            background: var(--bg-subtle);
            border-radius: 12px;
            padding: 1rem;
        }

        .kanban-header {
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .kanban-count {
            font-size: 0.75rem;
            background: var(--bg-muted);
            padding: 0.125rem 0.5rem;
            border-radius: 4px;
        }

        .kanban-items {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .kanban-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            cursor: pointer;
        }

        .kanban-card:hover {
            border-color: var(--accent);
        }

        .kanban-card-title {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .kanban-card-meta {
            font-size: 0.6875rem;
            color: var(--text-muted);
        }

        /* Avatars Grid */
        .avatars-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .avatar-card {
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
        }

        .avatar-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .avatar-images {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 2px;
            height: 200px;
        }

        .avatar-images img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-info {
            padding: 1rem;
        }

        .avatar-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .avatar-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .avatar-tags {
            display: flex;
            gap: 0.5rem;
        }

        .avatar-tag {
            font-size: 0.6875rem;
            padding: 0.125rem 0.5rem;
            background: var(--bg-muted);
            border-radius: 4px;
        }

        /* Settings Grid */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .settings-card {
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .settings-card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .settings-page-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }

        .settings-card-title {
            font-weight: 600;
            flex: 1;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }

        .settings-row:last-child {
            border-bottom: none;
        }

        .settings-label {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .settings-value {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-muted);
            border-radius: 12px;
            transition: 0.2s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.2s;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: var(--accent);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .number-input {
            width: 60px;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--text);
            text-align: center;
        }

        /* Featured Products */
        .featured-products-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .featured-product-item {
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .featured-product-item img {
            width: 50px;
            height: 50px;
            border-radius: 6px;
            object-fit: cover;
        }

        .featured-product-info {
            flex: 1;
        }

        .featured-product-name {
            font-weight: 500;
        }

        .featured-product-period {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Idea Detail Modal */
        .idea-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .idea-modal-content {
            background: var(--bg);
            padding: 2rem;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .idea-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }

        .idea-modal-header h3 {
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .idea-modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.5rem;
        }

        .idea-detail-section {
            margin-bottom: 1.5rem;
        }

        .idea-detail-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .idea-detail-value {
            background: var(--bg-subtle);
            padding: 0.75rem 1rem;
            border-radius: 8px;
        }

        .idea-selects {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .idea-select-group label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .idea-modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        /* Avatar Create Modal */
        .avatar-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .avatar-modal-content {
            background: var(--bg);
            padding: 2rem;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
        }

        .avatar-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .avatar-form-group {
            margin-bottom: 1rem;
        }

        .avatar-form-group label {
            display: block;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .avatar-form-group input,
        .avatar-form-group select,
        .avatar-form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-subtle);
            color: var(--text);
            font-size: 0.875rem;
        }

        .avatar-form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Demo Button Animation */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(139, 92, 246, 0.5), 0 0 20px rgba(236, 72, 153, 0.3); transform: scale(1); }
            50% { box-shadow: 0 0 20px rgba(139, 92, 246, 0.8), 0 0 40px rgba(236, 72, 153, 0.5); transform: scale(1.02); }
        }

        /* Demo Modal */
        .demo-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .demo-modal.active { display: flex; }

        .demo-content {
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 3rem;
            max-width: 800px;
            width: 90%;
            text-align: center;
            position: relative;
        }

        .demo-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.5rem;
        }
        .demo-close:hover { color: var(--text); }

        .demo-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #8b5cf6, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .demo-subtitle {
            color: var(--text-muted);
            margin-bottom: 2rem;
        }

        .demo-pages {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .demo-page {
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            transition: all 0.3s;
        }
        .demo-page.generating { border-color: var(--yellow); animation: demo-pulse 1s infinite; }
        .demo-page.complete { border-color: var(--green); }

        @keyframes demo-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .demo-page-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin: 0 auto 0.5rem;
        }
        .demo-page[data-page="cowan"] .demo-page-icon { background: var(--page-cowan); }
        .demo-page[data-page="echappement"] .demo-page-icon { background: var(--page-echappement); }
        .demo-page[data-page="pneus"] .demo-page-icon { background: var(--page-pneus); }
        .demo-page[data-page="pacific"] .demo-page-icon { background: var(--page-pacific); }

        .demo-page-name { font-size: 0.75rem; font-weight: 600; margin-bottom: 0.5rem; }
        .demo-page-status { font-size: 0.6875rem; color: var(--text-muted); }
        .demo-page.generating .demo-page-status { color: var(--yellow); }
        .demo-page.complete .demo-page-status { color: var(--green); }

        .demo-progress {
            background: var(--bg);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .demo-progress-bar {
            height: 8px;
            background: var(--bg-muted);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .demo-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6, #ec4899);
            width: 0%;
            transition: width 0.5s ease;
        }

        .demo-step {
            font-size: 0.875rem;
            color: var(--text-muted);
        }
        .demo-step.active { color: var(--text); font-weight: 500; }

        .demo-results {
            display: none;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .demo-results.active { display: grid; }

        .demo-result-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            text-align: left;
        }

        .demo-result-image {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            background: var(--bg-muted);
        }

        .demo-result-content {
            padding: 1rem;
        }

        .demo-result-page {
            display: inline-block;
            font-size: 0.6875rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }

        .demo-result-text {
            font-size: 0.8125rem;
            color: var(--text);
            line-height: 1.4;
        }

        .demo-cta {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border);
        }

        .demo-cta-text {
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .demo-cta-btn {
            background: linear-gradient(135deg, #8b5cf6, #ec4899);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .demo-cta-btn:hover { transform: scale(1.05); }

        /* ========================================
           WIZARD DEMYSTIFIER - STYLES
           ======================================== */

        /* Wizard Steps Indicator */
        .demo-wizard-steps {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0;
            margin-bottom: 2rem;
            padding: 1rem 0;
        }

        .wizard-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            opacity: 0.4;
            transition: all 0.3s;
        }

        .wizard-step.active { opacity: 1; }
        .wizard-step.completed { opacity: 0.8; }

        .wizard-step-number {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg-muted);
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.3s;
        }

        .wizard-step.active .wizard-step-number {
            background: linear-gradient(135deg, #8b5cf6, #ec4899);
            border-color: transparent;
            color: white;
        }

        .wizard-step.completed .wizard-step-number {
            background: var(--green);
            border-color: transparent;
            color: white;
        }

        .wizard-step-label {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-muted);
            white-space: nowrap;
        }

        .wizard-step.active .wizard-step-label { color: var(--text); }

        .wizard-step-line {
            width: 60px;
            height: 2px;
            background: var(--border);
            margin: 0 0.5rem;
            margin-bottom: 1.5rem;
        }

        .wizard-step-line.completed {
            background: linear-gradient(90deg, #8b5cf6, #ec4899);
        }

        /* Demo Step Content */
        .demo-step-content {
            display: none;
            text-align: left;
        }

        .demo-step-content.active { display: block; }

        .demo-actions {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        .selected-count {
            margin-right: auto;
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        /* Editorial Lines (Step 1) */
        .editorial-loading {
            text-align: center;
            padding: 3rem;
        }

        .editorial-loading .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .editorial-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .editorial-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            transition: all 0.2s;
        }

        .editorial-card:hover {
            border-color: var(--border-subtle);
        }

        .editorial-card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .editorial-page-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .editorial-page-name {
            font-weight: 600;
            font-size: 0.9375rem;
        }

        .editorial-themes {
            margin-bottom: 1rem;
        }

        .editorial-themes-title {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .editorial-themes-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .editorial-theme-tag {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            background: var(--bg-muted);
            border-radius: 9999px;
            color: var(--text);
        }

        .editorial-products {
            margin-bottom: 1rem;
        }

        .editorial-products-title {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .editorial-product-item {
            font-size: 0.8125rem;
            color: var(--text);
            padding: 0.25rem 0;
        }

        .editorial-content-plan {
            border-top: 1px solid var(--border);
            padding-top: 1rem;
        }

        .editorial-content-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8125rem;
            padding: 0.375rem 0;
        }

        .editorial-content-type { color: var(--text-muted); }
        .editorial-content-count { font-weight: 600; color: var(--text); }

        /* Generation Progress */
        .generation-progress {
            margin-top: 1rem;
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        /* Ideas Toolbar (Step 3) */
        .ideas-toolbar {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            flex-wrap: wrap;
        }

        .view-toggle {
            display: flex;
            background: var(--bg-muted);
            border-radius: 8px;
            padding: 4px;
        }

        .view-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            border-radius: 6px;
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.15s;
        }

        .view-btn:hover { color: var(--text); }
        .view-btn.active {
            background: var(--bg-subtle);
            color: var(--text);
        }

        .ideas-filters {
            display: flex;
            gap: 0.5rem;
        }

        .ideas-filters select {
            background: var(--bg-muted);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            color: var(--text);
            font-size: 0.8125rem;
            cursor: pointer;
        }

        .bulk-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-left: auto;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8125rem;
            color: var(--text-muted);
            cursor: pointer;
        }

        .checkbox-label input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--accent);
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }

        /* Demo Views */
        .demo-view {
            display: none;
        }

        .demo-view.active { display: block; }

        /* Calendar View */
        .demo-calendar {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .demo-calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: var(--bg-muted);
        }

        .demo-calendar-header-cell {
            padding: 0.75rem;
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            border-right: 1px solid var(--border);
        }

        .demo-calendar-header-cell:last-child { border-right: none; }

        .demo-calendar-body {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .demo-calendar-day {
            min-height: 120px;
            padding: 0.5rem;
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            background: var(--bg);
            transition: background 0.15s;
            cursor: pointer;
        }

        .demo-calendar-day:nth-child(7n) { border-right: none; }
        .demo-calendar-day:hover { background: var(--bg-subtle); }
        .demo-calendar-day.other-month { opacity: 0.3; }
        .demo-calendar-day.today { background: rgba(249, 115, 22, 0.05); }
        .demo-calendar-day.drop-target {
            background: rgba(139, 92, 246, 0.1);
            border: 2px dashed var(--purple);
        }

        .demo-calendar-date {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .demo-calendar-day.today .demo-calendar-date {
            color: var(--accent);
            font-weight: 600;
        }

        .demo-idea-chip {
            font-size: 0.6875rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.25rem;
            cursor: grab;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 0.375rem;
            user-select: none;
        }

        .demo-idea-chip:hover { transform: translateX(2px); }
        .demo-idea-chip.dragging { opacity: 0.5; cursor: grabbing; }
        .demo-idea-chip.selected { box-shadow: 0 0 0 2px white; }

        .demo-idea-chip[data-page="Cowan Motor"] { background: rgba(14, 165, 233, 0.2); color: var(--page-cowan); }
        .demo-idea-chip[data-page="Tahiti Echappement"] { background: rgba(99, 102, 241, 0.2); color: var(--page-echappement); }
        .demo-idea-chip[data-page="Punaauia Pneus"] { background: rgba(16, 185, 129, 0.2); color: var(--page-pneus); }
        .demo-idea-chip[data-page="Station Pacific Hitiaa"] { background: rgba(139, 92, 246, 0.2); color: var(--page-pacific); }

        .idea-chip-checkbox {
            width: 12px;
            height: 12px;
            accent-color: currentColor;
        }

        /* Kanban View */
        .demo-kanban {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        .kanban-column {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .kanban-column-header {
            padding: 1rem;
            font-weight: 600;
            font-size: 0.875rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .kanban-column-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .kanban-column-count {
            margin-left: auto;
            font-size: 0.75rem;
            color: var(--text-muted);
            background: var(--bg-muted);
            padding: 0.125rem 0.5rem;
            border-radius: 4px;
        }

        .kanban-column-body {
            padding: 0.75rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .kanban-card {
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .kanban-card:hover {
            border-color: var(--border-subtle);
            transform: translateY(-1px);
        }

        .kanban-card-checkbox {
            margin-top: 2px;
        }

        .kanban-card-content { flex: 1; }

        .kanban-card-type {
            font-size: 0.6875rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }

        .kanban-card-title {
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--text);
            line-height: 1.3;
        }

        .kanban-card-date {
            font-size: 0.6875rem;
            color: var(--text-dim);
            margin-top: 0.5rem;
        }

        /* List View */
        .demo-list {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .list-header {
            display: grid;
            grid-template-columns: 40px 2fr 1fr 1fr 1fr 100px;
            gap: 1rem;
            padding: 0.75rem 1rem;
            background: var(--bg-muted);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
        }

        .list-row {
            display: grid;
            grid-template-columns: 40px 2fr 1fr 1fr 1fr 100px;
            gap: 1rem;
            padding: 0.75rem 1rem;
            font-size: 0.8125rem;
            border-bottom: 1px solid var(--border);
            align-items: center;
            cursor: pointer;
            transition: background 0.15s;
        }

        .list-row:hover { background: var(--bg-subtle); }
        .list-row:last-child { border-bottom: none; }

        .list-page-badge {
            font-size: 0.6875rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 500;
        }

        .list-action-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.6875rem;
            background: var(--bg-muted);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text);
            cursor: pointer;
        }

        .list-action-btn:hover { background: var(--border); }

        /* Visuals Grid (Step 4) */
        .visuals-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .visual-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .visual-card-image {
            aspect-ratio: 1;
            background: var(--bg-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .visual-card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .visual-card-generating {
            text-align: center;
            color: var(--text-muted);
        }

        .visual-card-generating .spinner {
            width: 32px;
            height: 32px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 0.5rem;
        }

        .visual-card-info {
            padding: 1rem;
        }

        .visual-card-page {
            font-size: 0.6875rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            display: inline-block;
            margin-bottom: 0.5rem;
        }

        .visual-card-title {
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--text);
        }

        /* Idea Detail Modal */
        .idea-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1100;
            align-items: center;
            justify-content: center;
        }

        .idea-modal.active { display: flex; }

        .idea-modal-content {
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .idea-modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        .idea-modal-form { }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.875rem;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: flex;
            gap: 1rem;
        }

        .idea-page-badge {
            display: inline-block;
            font-size: 0.8125rem;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            background: var(--bg);
        }

        .product-recommendation {
            font-size: 0.75rem;
            color: var(--green);
            margin-top: 0.5rem;
        }

        .idea-modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        /* Pulse animation for DEMYSTIFIER button */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.4); }
            50% { box-shadow: 0 0 20px 5px rgba(139, 92, 246, 0.3); }
        }

        /* Notification animations */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Calendar day cell hover */
        .calendar-day-cell:hover {
            background: var(--bg-muted) !important;
        }

        .calendar-idea-chip:hover {
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div class="layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <div class="logo-mark">CM</div>
                <div class="logo-text">COWAN <span>MOTOR</span></div>
            </div>

            <nav class="nav">
                <div class="nav-group">
                    <div class="nav-label">Principal</div>
                    <a class="nav-item active" data-view="dashboard">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
                        Vue 360
                    </a>
                    <a class="nav-item" data-view="calendar">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                        Calendrier
                        <span class="nav-badge">3</span>
                    </a>
                    <a class="nav-item" data-view="generator">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                        Generateur
                    </a>
                </div>

                <div class="nav-group">
                    <div class="nav-label">Editorial</div>
                    <a class="nav-item" data-view="ideas">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                        Idees
                        <span class="nav-badge" id="ideas-count">0</span>
                    </a>
                    <a class="nav-item" data-view="avatars">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        Avatars
                    </a>
                    <a class="nav-item" data-view="settings">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
                        Parametres
                    </a>
                </div>

                <div class="nav-group">
                    <div class="nav-label">Contenu</div>
                    <a class="nav-item" data-view="products">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                        Catalogue
                    </a>
                    <a class="nav-item" data-view="gallery">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                        Bibliotheque
                    </a>
                </div>

                <div class="nav-group">
                    <div class="nav-label">Pages Facebook</div>
                    <a class="nav-item" data-view="page-cowan">
                        <span style="width: 10px; height: 10px; background: var(--page-cowan); border-radius: 50%;"></span>
                        Cowan Motor
                    </a>
                    <a class="nav-item" data-view="page-echappement">
                        <span style="width: 10px; height: 10px; background: var(--page-echappement); border-radius: 50%;"></span>
                        Tahiti Echappement
                    </a>
                    <a class="nav-item" data-view="page-pneus">
                        <span style="width: 10px; height: 10px; background: var(--page-pneus); border-radius: 50%;"></span>
                        Punaauia Pneus
                    </a>
                    <a class="nav-item" data-view="page-pacific">
                        <span style="width: 10px; height: 10px; background: var(--page-pacific); border-radius: 50%; opacity: 0.5;"></span>
                        Station Pacific
                        <span class="nav-badge" style="background: var(--yellow);">Bientot</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="powered-by">
                    Propulse par <a href="https://pacifikai.com" target="_blank">PACIFIK'AI</a>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main">
            <!-- Dashboard View -->
            <div class="view active" id="view-dashboard">
                <header class="header">
                    <h1 class="header-title">Vue 360 - Toutes les pages</h1>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="refreshStats()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                            Actualiser
                        </button>
                        <button class="btn btn-primary" onclick="showView('generator')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            Creer du contenu
                        </button>
                        <button class="btn" onclick="launchDemo()" style="background: linear-gradient(135deg, #8b5cf6, #ec4899); color: white; font-weight: 600; padding: 12px 24px; font-size: 1rem; gap: 10px; animation: pulse-glow 2s infinite;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                            DEMYSTIFIER
                        </button>
                    </div>
                </header>

                <div class="content">
                    <!-- Stats Cards -->
                    <div class="cards-grid">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Total Abonnes</span>
                                <div class="card-icon" style="background: rgba(249, 115, 22, 0.1);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                                </div>
                            </div>
                            <div class="card-value" id="stat-followers">--</div>
                            <div class="card-change positive">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/></svg>
                                4 pages combinees
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Posts ce mois</span>
                                <div class="card-icon" style="background: rgba(34, 197, 94, 0.1);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                                </div>
                            </div>
                            <div class="card-value" id="stat-posts">0</div>
                            <div class="card-change">
                                <span style="color: var(--text-muted);">Objectif: 32/mois</span>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Engagement moyen</span>
                                <div class="card-icon" style="background: rgba(59, 130, 246, 0.1);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--blue)" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                                </div>
                            </div>
                            <div class="card-value" id="stat-engagement">--%</div>
                            <div class="card-change positive">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/></svg>
                                +2.3% vs mois dernier
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Posts planifies</span>
                                <div class="card-icon" style="background: rgba(168, 85, 247, 0.1);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--purple)" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                </div>
                            </div>
                            <div class="card-value" id="stat-scheduled">0</div>
                            <div class="card-change">
                                <span style="color: var(--text-muted);">Cette semaine</span>
                            </div>
                        </div>
                    </div>

                    <!-- Pages Overview -->
                    <section class="section">
                        <div class="section-header">
                            <h2 class="section-title">Pages Facebook</h2>
                            <button class="btn btn-ghost">Voir tout</button>
                        </div>
                        <div class="cards-grid">
                            <div class="page-card" onclick="showView('page-cowan')">
                                <div class="page-avatar" style="background: var(--page-cowan);">CM</div>
                                <div class="page-info">
                                    <div class="page-name">Cowan Motor</div>
                                    <div class="page-stats">8,342 abonnes - 12 posts/mois</div>
                                </div>
                                <div class="page-status"></div>
                            </div>

                            <div class="page-card" onclick="showView('page-echappement')">
                                <div class="page-avatar" style="background: var(--page-echappement);">TE</div>
                                <div class="page-info">
                                    <div class="page-name">Tahiti Echappement</div>
                                    <div class="page-stats">2,156 abonnes - 8 posts/mois</div>
                                </div>
                                <div class="page-status"></div>
                            </div>

                            <div class="page-card" onclick="showView('page-pneus')">
                                <div class="page-avatar" style="background: var(--page-pneus);">PP</div>
                                <div class="page-info">
                                    <div class="page-name">Punaauia Pneus</div>
                                    <div class="page-stats">1,834 abonnes - 6 posts/mois</div>
                                </div>
                                <div class="page-status"></div>
                            </div>

                            <div class="page-card" onclick="showView('page-pacific')">
                                <div class="page-avatar" style="background: var(--page-pacific); opacity: 0.5;">SP</div>
                                <div class="page-info">
                                    <div class="page-name">Station Pacific Hitiaa</div>
                                    <div class="page-stats">Lancement prevu - Page en preparation</div>
                                </div>
                                <div class="page-status pending"></div>
                            </div>
                        </div>
                    </section>

                    <!-- Calendar Preview - Dynamic from Airtable -->
                    <section class="section">
                        <div class="section-header">
                            <h2 class="section-title">Posts planifies cette semaine</h2>
                            <button class="btn btn-secondary" onclick="showView('calendar')">Voir le calendrier complet</button>
                        </div>
                        <div id="week-preview-container" class="calendar-preview">
                            <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                                <div class="spinner" style="margin: 0 auto 1rem;"></div>
                                Chargement des posts planifies...
                            </div>
                        </div>
                    </section>
                </div>
            </div>

            <!-- Calendar View -->
            <div class="view" id="view-calendar">
                <header class="header">
                    <h1 class="header-title">Calendrier Editorial</h1>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="loadCalendarContent()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                            Actualiser
                        </button>
                        <button class="btn btn-primary" onclick="showView('generator')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            Nouveau contenu
                        </button>
                    </div>
                </header>
                <div class="content">
                    <!-- Calendar Navigation -->
                    <div class="calendar-nav">
                        <button class="btn btn-icon" onclick="changeMonth(-1)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
                        </button>
                        <h2 id="calendar-month-title">Janvier 2026</h2>
                        <button class="btn btn-icon" onclick="changeMonth(1)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                        </button>
                        <button class="btn btn-secondary" onclick="goToToday()" style="margin-left: 1rem;">Aujourd'hui</button>
                    </div>

                    <!-- Page Filter -->
                    <div class="calendar-filters">
                        <span class="filter-label">Pages:</span>
                        <label class="page-filter" style="--page-color: #3b82f6;">
                            <input type="checkbox" checked onchange="filterCalendar()" data-page="Cowan Motor"> Cowan Motor
                        </label>
                        <label class="page-filter" style="--page-color: #10b981;">
                            <input type="checkbox" checked onchange="filterCalendar()" data-page="Tahiti Echappement"> Tahiti Echappement
                        </label>
                        <label class="page-filter" style="--page-color: #f59e0b;">
                            <input type="checkbox" checked onchange="filterCalendar()" data-page="Punaauia Pneus"> Punaauia Pneus
                        </label>
                        <label class="page-filter" style="--page-color: #8b5cf6;">
                            <input type="checkbox" checked onchange="filterCalendar()" data-page="Station Pacific Hitiaa"> Station Pacific
                        </label>
                    </div>

                    <!-- Calendar Grid -->
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <div class="calendar-day-name">Lun</div>
                            <div class="calendar-day-name">Mar</div>
                            <div class="calendar-day-name">Mer</div>
                            <div class="calendar-day-name">Jeu</div>
                            <div class="calendar-day-name">Ven</div>
                            <div class="calendar-day-name">Sam</div>
                            <div class="calendar-day-name">Dim</div>
                        </div>
                        <div class="calendar-grid" id="calendar-grid">
                            <!-- Days will be generated by JS -->
                        </div>
                    </div>

                    <!-- Status Legend -->
                    <div class="calendar-legend">
                        <div class="legend-item"><span class="status-dot status-brouillon"></span> Brouillon</div>
                        <div class="legend-item"><span class="status-dot status-planifie"></span> Planifie</div>
                        <div class="legend-item"><span class="status-dot status-publie"></span> Publie</div>
                        <div class="legend-item"><span class="status-dot status-echec"></span> Echec</div>
                    </div>
                </div>
            </div>

            <!-- Generator View -->
            <div class="view" id="view-generator">
                <header class="header">
                    <h1 class="header-title">Generateur de Contenu</h1>
                </header>
                <div class="content">
                    <section class="section">
                        <div class="section-header">
                            <h2 class="section-title">Que voulez-vous creer ?</h2>
                        </div>
                        <div class="generator-grid">
                            <div class="generator-card" onclick="generateQuiz()">
                                <div class="generator-icon">?</div>
                                <h4>Quiz "Le saviez-vous ?"</h4>
                                <p>Question + 3 reponses + visuel genere automatiquement</p>
                            </div>

                            <div class="generator-card" onclick="generateProductPost()">
                                <div class="generator-icon">&#x1F6DE;</div>
                                <h4>Post Produit</h4>
                                <p>Selectionnez un produit, l'IA genere le texte et le visuel</p>
                            </div>

                            <div class="generator-card" onclick="generatePromo()">
                                <div class="generator-icon">&#x1F525;</div>
                                <h4>Post Promo</h4>
                                <p>Annonce promotion avec visuel accrocheur</p>
                            </div>

                            <div class="generator-card" onclick="generateCustom()">
                                <div class="generator-icon">&#x2728;</div>
                                <h4>Visuel Libre</h4>
                                <p>Decrivez ce que vous voulez, l'IA cree le visuel</p>
                            </div>
                        </div>
                    </section>
                </div>
            </div>

            <!-- Products View -->
            <div class="view" id="view-products">
                <header class="header">
                    <h1 class="header-title">Catalogue Produits</h1>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="showUploadModal()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                            Ajouter un produit
                        </button>
                    </div>
                </header>
                <div class="content">
                    <section class="section">
                        <div class="upload-zone" id="upload-zone">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                            <h4>Glissez vos images ici</h4>
                            <p>ou cliquez pour parcourir (PNG, JPG jusqu'a 10MB)</p>
                        </div>
                    </section>

                    <section class="section">
                        <div class="section-header">
                            <h2 class="section-title">Produits (0)</h2>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-ghost">Pneus</button>
                                <button class="btn btn-ghost">Vehicules</button>
                                <button class="btn btn-ghost">Services</button>
                            </div>
                        </div>
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                            <h3>Aucun produit</h3>
                            <p>Commencez par ajouter vos produits (pneus, vehicules, accessoires)</p>
                            <button class="btn btn-primary">Ajouter un produit</button>
                        </div>
                    </section>
                </div>
            </div>

            <!-- Gallery View -->
            <div class="view" id="view-gallery">
                <header class="header">
                    <h1 class="header-title">Bibliotheque de Visuels</h1>
                </header>
                <div class="content">
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                        <h3>Aucun visuel genere</h3>
                        <p>Les visuels crees apparaitront ici pour etre reutilises</p>
                        <button class="btn btn-primary" onclick="showView('generator')">Creer un visuel</button>
                    </div>
                </div>
            </div>

            <!-- Ideas View -->
            <div class="view" id="view-ideas">
                <header class="header">
                    <h1 class="header-title">Idees Editoriales</h1>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="generateEditorialIdeas()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                            Generer idees (2 sem)
                        </button>
                        <button class="btn btn-primary" onclick="bulkAcceptIdeas()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
                            Accepter tout
                        </button>
                    </div>
                </header>
                <div class="content">
                    <!-- View Mode Toggle -->
                    <div class="ideas-toolbar" style="display: flex; gap: 1rem; margin-bottom: 1.5rem; align-items: center; flex-wrap: wrap;">
                        <div class="view-toggle" style="display: flex; background: var(--bg-muted); border-radius: 8px; overflow: hidden;">
                            <button class="btn-toggle active" data-ideas-view="list" onclick="setIdeasView('list')">Liste</button>
                            <button class="btn-toggle" data-ideas-view="kanban" onclick="setIdeasView('kanban')">Kanban</button>
                            <button class="btn-toggle" data-ideas-view="calendar" onclick="setIdeasView('calendar')">Calendrier</button>
                        </div>
                        <select id="ideas-page-filter" onchange="filterIdeas()" class="filter-select">
                            <option value="">Toutes les pages</option>
                            <option value="Cowan Motor">Cowan Motor</option>
                            <option value="Tahiti Echappement">Tahiti Echappement</option>
                            <option value="Punaauia Pneus">Punaauia Pneus</option>
                            <option value="Station Pacific Hitiaa">Station Pacific</option>
                        </select>
                        <select id="ideas-status-filter" onchange="filterIdeas()" class="filter-select">
                            <option value="">Tous les statuts</option>
                            <option value="Idee">Idees</option>
                            <option value="Acceptee">Acceptees</option>
                            <option value="En Generation">En generation</option>
                            <option value="Generee">Generees</option>
                        </select>
                        <select id="ideas-type-filter" onchange="filterIdeas()" class="filter-select">
                            <option value="">Tous les types</option>
                            <option value="Post Produit">Post Produit</option>
                            <option value="Quiz">Quiz</option>
                            <option value="Promo">Promo</option>
                            <option value="Story">Story</option>
                            <option value="Conseil">Conseil</option>
                        </select>
                    </div>

                    <!-- Ideas List View -->
                    <div id="ideas-list-view" class="ideas-view-container">
                        <div id="ideas-list" class="ideas-list">
                            <!-- Ideas will be loaded here -->
                        </div>
                    </div>

                    <!-- Ideas Kanban View -->
                    <div id="ideas-kanban-view" class="ideas-view-container" style="display: none;">
                        <div class="kanban-board">
                            <div class="kanban-column" data-status="Idee">
                                <div class="kanban-header">Idees <span class="kanban-count">0</span></div>
                                <div class="kanban-items" id="kanban-idee"></div>
                            </div>
                            <div class="kanban-column" data-status="Acceptee">
                                <div class="kanban-header">Acceptees <span class="kanban-count">0</span></div>
                                <div class="kanban-items" id="kanban-acceptee"></div>
                            </div>
                            <div class="kanban-column" data-status="En Generation">
                                <div class="kanban-header">En generation <span class="kanban-count">0</span></div>
                                <div class="kanban-items" id="kanban-generation"></div>
                            </div>
                            <div class="kanban-column" data-status="Generee">
                                <div class="kanban-header">Generees <span class="kanban-count">0</span></div>
                                <div class="kanban-items" id="kanban-generee"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Ideas Calendar View -->
                    <div id="ideas-calendar-view" class="ideas-view-container" style="display: none;">
                        <div id="ideas-calendar-grid" class="calendar-container">
                            <!-- Calendar will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Avatars View -->
            <div class="view" id="view-avatars">
                <header class="header">
                    <h1 class="header-title">Bibliotheque Avatars</h1>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="showCreateAvatarModal()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            Creer un avatar
                        </button>
                    </div>
                </header>
                <div class="content">
                    <div class="avatars-filters" style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                        <select id="avatar-style-filter" onchange="filterAvatars()" class="filter-select">
                            <option value="">Tous les styles</option>
                            <option value="Professionnel">Professionnel</option>
                            <option value="Decontracte">Decontracte</option>
                            <option value="Sportif">Sportif</option>
                            <option value="Elegant">Elegant</option>
                        </select>
                        <select id="avatar-gender-filter" onchange="filterAvatars()" class="filter-select">
                            <option value="">Tous</option>
                            <option value="Homme">Homme</option>
                            <option value="Femme">Femme</option>
                            <option value="Neutre">Neutre</option>
                        </select>
                    </div>
                    <div id="avatars-grid" class="avatars-grid">
                        <!-- Avatars will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Settings View -->
            <div class="view" id="view-settings">
                <header class="header">
                    <h1 class="header-title">Parametres</h1>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="saveAllSettings()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                            Sauvegarder
                        </button>
                    </div>
                </header>
                <div class="content">
                    <section class="section">
                        <h2 class="section-title">Configuration par page</h2>
                        <div id="settings-pages" class="settings-grid">
                            <!-- Settings will be loaded here -->
                        </div>
                    </section>

                    <section class="section" style="margin-top: 2rem;">
                        <h2 class="section-title">Produits mis en avant</h2>
                        <div id="featured-products-list" class="featured-products-list">
                            <!-- Featured products will be loaded here -->
                        </div>
                        <button class="btn btn-secondary" onclick="addFeaturedProduct()" style="margin-top: 1rem;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            Ajouter produit vedette
                        </button>
                    </section>

                    <section class="section" style="margin-top: 2rem;">
                        <h2 class="section-title">Parametres globaux</h2>
                        <div class="settings-card" style="background: var(--bg-subtle); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                                <div class="setting-group">
                                    <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; color: var(--text);">
                                        Qualite des images generees
                                    </label>
                                    <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.75rem;">
                                        Resolution des visuels generes par FAL.ai
                                    </p>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button class="btn image-quality-btn" data-quality="1K" onclick="setImageQuality('1K')" style="flex: 1;">
                                            1K
                                            <span style="display: block; font-size: 0.6875rem; font-weight: 400; color: var(--text-muted);">1024px</span>
                                        </button>
                                        <button class="btn image-quality-btn active" data-quality="2K" onclick="setImageQuality('2K')" style="flex: 1; background: var(--accent); color: white;">
                                            2K
                                            <span style="display: block; font-size: 0.6875rem; font-weight: 400; opacity: 0.8;">2048px</span>
                                        </button>
                                        <button class="btn image-quality-btn" data-quality="4K" onclick="setImageQuality('4K')" style="flex: 1;">
                                            4K
                                            <span style="display: block; font-size: 0.6875rem; font-weight: 400; color: var(--text-muted);">4096px</span>
                                        </button>
                                    </div>
                                    <p id="quality-info" style="font-size: 0.6875rem; color: var(--text-dim); margin-top: 0.5rem;">
                                        2K recommande - bon equilibre qualite/vitesse
                                    </p>
                                </div>

                                <div class="setting-group">
                                    <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; color: var(--text);">
                                        Mode de publication
                                    </label>
                                    <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.75rem;">
                                        Publication automatique ou validation manuelle
                                    </p>
                                    <select id="global-publish-mode" onchange="setPublishMode(this.value)" style="width: 100%; padding: 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 0.875rem;">
                                        <option value="manual">Validation manuelle requise</option>
                                        <option value="auto">Publication automatique</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>

            <!-- Page Views (placeholder) -->
            <div class="view" id="view-page-cowan">
                <header class="header">
                    <h1 class="header-title">
                        <span style="display: inline-block; width: 12px; height: 12px; background: var(--page-cowan); border-radius: 50%; margin-right: 8px;"></span>
                        Cowan Motor
                    </h1>
                    <div class="header-actions">
                        <a href="https://facebook.com/cowanmotor" target="_blank" class="btn btn-secondary">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                            Voir sur Facebook
                        </a>
                    </div>
                </header>
                <div class="content">
                    <div class="empty-state">
                        <h3>Page Cowan Motor</h3>
                        <p>Stats detaillees et posts de cette page - En cours de developpement</p>
                    </div>
                </div>
            </div>

            <div class="view" id="view-page-echappement">
                <header class="header">
                    <h1 class="header-title">
                        <span style="display: inline-block; width: 12px; height: 12px; background: var(--page-echappement); border-radius: 50%; margin-right: 8px;"></span>
                        Tahiti Echappement
                    </h1>
                </header>
                <div class="content">
                    <div class="empty-state">
                        <h3>Page Tahiti Echappement</h3>
                        <p>Stats detaillees et posts de cette page - En cours de developpement</p>
                    </div>
                </div>
            </div>

            <div class="view" id="view-page-pneus">
                <header class="header">
                    <h1 class="header-title">
                        <span style="display: inline-block; width: 12px; height: 12px; background: var(--page-pneus); border-radius: 50%; margin-right: 8px;"></span>
                        Punaauia Pneus
                    </h1>
                </header>
                <div class="content">
                    <div class="empty-state">
                        <h3>Page Punaauia Pneus</h3>
                        <p>Stats detaillees et posts de cette page - En cours de developpement</p>
                    </div>
                </div>
            </div>

            <div class="view" id="view-page-pacific">
                <header class="header">
                    <h1 class="header-title">
                        <span style="display: inline-block; width: 12px; height: 12px; background: var(--page-pacific); border-radius: 50%; margin-right: 8px;"></span>
                        Station Pacific Hitiaa
                    </h1>
                </header>
                <div class="content">
                    <div class="empty-state" style="background: rgba(234, 179, 8, 0.1); border: 1px dashed var(--yellow); border-radius: 12px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="var(--yellow)" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                        <h3>Page en preparation</h3>
                        <p>Cette page sera connectee lors du lancement de la station</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Demo Modal - Wizard Multi-Etapes -->
    <div class="demo-modal" id="demo-modal">
        <div class="demo-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
            <button class="demo-close" onclick="closeDemo()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>

            <!-- Wizard Steps Indicator (2 etapes) -->
            <div class="demo-wizard-steps">
                <div class="wizard-step active" data-step="1">
                    <div class="wizard-step-number">1</div>
                    <div class="wizard-step-label">Ligne Editoriale</div>
                </div>
                <div class="wizard-step-line"></div>
                <div class="wizard-step" data-step="2">
                    <div class="wizard-step-number">2</div>
                    <div class="wizard-step-label">Generation Idees</div>
                </div>
            </div>

            <!-- Step 1: Ligne Editoriale -->
            <div class="demo-step-content active" id="demo-step-1">
                <h2 class="demo-title">Ligne Editoriale - 2 Semaines</h2>
                <p class="demo-subtitle">L'IA propose une strategie de contenu pour chaque page</p>

                <div id="editorial-lines-container">
                    <!-- Will be populated by JS -->
                    <div class="editorial-loading">
                        <div class="spinner"></div>
                        <p>Generation des lignes editoriales en cours...</p>
                    </div>
                </div>

                <div class="demo-actions" id="step1-actions" style="display: none;">
                    <button class="btn btn-secondary" onclick="regenerateEditorialLines()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                        Regenerer
                    </button>
                    <button class="btn btn-primary" onclick="acceptEditorialLines()">
                        Accepter et continuer
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><polyline points="9 18 15 12 9 6"/></svg>
                    </button>
                </div>
            </div>

            <!-- Step 2: Acces Dashboard -->
            <div class="demo-step-content" id="demo-step-2">
                <h2 class="demo-title">Votre Dashboard est Pret!</h2>
                <p class="demo-subtitle">10 idees de posts ont ete planifiees pour vos 4 pages Facebook</p>

                <div id="ideas-generation-container" style="text-align: center; padding: 2rem;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;"></div>
                    <div style="background: var(--surface); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto;">
                        <p style="margin-bottom: 0.75rem;"><strong> Calendrier</strong> - Voir les posts planifies par jour</p>
                        <p style="margin-bottom: 0.75rem;"><strong> Idees</strong> - Modifier chaque post (cliquez dessus!)</p>
                        <p style="margin-bottom: 0.75rem;"><strong> Produits</strong> - Votre catalogue avec drag & drop</p>
                        <p><strong> Visuels</strong> - Bibliotheque d'images IA</p>
                    </div>
                    <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1.5rem;">
                        <strong>En Mode Live</strong>, les visuels IA et la publication Facebook seront automatises.
                    </p>
                    <button class="btn btn-primary btn-lg" onclick="accessDashboard()">
                        Acceder au Dashboard
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><polyline points="9 18 15 12 9 6"/></svg>
                    </button>
                </div>

            </div>
        </div>
    </div>
        </div>
    </div>

    <script>
        // Navigation
        function showView(viewId) {
            // Hide all views
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));

            // Show selected view
            const view = document.getElementById('view-' + viewId);
            if (view) view.classList.add('active');

            // Update nav
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.view === viewId) {
                    item.classList.add('active');
                }
            });
        }

        // Nav click handlers
        document.querySelectorAll('.nav-item[data-view]').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                showView(item.dataset.view);
            });
        });

        // Upload zone drag & drop
        const uploadZone = document.getElementById('upload-zone');
        if (uploadZone) {
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                handleUpload(files);
            });

            uploadZone.addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.multiple = true;
                input.accept = 'image/*';
                input.onchange = (e) => handleUpload(e.target.files);
                input.click();
            });
        }

        // API Config
        const N8N_WEBHOOK_URL = 'https://n8n.srv1140766.hstgr.cloud/webhook/cowan-upload-product';
        const AIRTABLE_API_KEY = 'pat46LSKbLbvTLFCm.3431b75c27ab9fc638cb8e784f6559347ede36c1d9801a9df511f2aaed941faf';
        const AIRTABLE_BASE_ID = 'appF7pltUaQkOlKM5';
        const AIRTABLE_TABLE = 'COWAN_Products';

        // State
        let products = [];

        async function handleUpload(files) {
            for (const file of files) {
                if (!file.type.startsWith('image/')) {
                    alert('Seules les images sont acceptees');
                    continue;
                }

                // Prompt for product info
                const name = prompt('Nom du produit:', file.name.replace(/\.[^/.]+$/, ''));
                if (!name) continue;

                const category = prompt('Categorie (Pneus, Vehicules, Services, Accessoires):', 'Pneus');
                if (!category) continue;

                const price = prompt('Prix (XPF):', '0');

                // Convert to base64
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const base64 = e.target.result.split(',')[1];
                    const filename = Date.now() + '_' + file.name.replace(/[^a-zA-Z0-9.]/g, '_');

                    uploadZone.innerHTML = '<p>Upload en cours...</p>';

                    try {
                        const response = await fetch(N8N_WEBHOOK_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                filename: filename,
                                imageData: base64,
                                contentType: file.type,
                                name: name,
                                category: category,
                                price: parseInt(price) || 0,
                                description: '',
                                stock_status: 'En stock',
                                page_target: ['Cowan Motor']
                            })
                        });

                        const result = await response.json();
                        console.log('Upload result:', result);

                        if (result.success) {
                            alert('Produit ajoute avec succes!');
                            loadProducts();
                        } else {
                            alert('Erreur: ' + JSON.stringify(result));
                        }
                    } catch (error) {
                        console.error('Upload error:', error);
                        alert('Erreur upload: ' + error.message);
                    }

                    // Reset upload zone
                    uploadZone.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        <h4>Glissez vos images ici</h4>
                        <p>ou cliquez pour parcourir (PNG, JPG jusqu'a 10MB)</p>
                    `;
                };
                reader.readAsDataURL(file);
            }
        }

        async function loadProducts() {
            try {
                const response = await fetch(
                    `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE}?sort%5B0%5D%5Bfield%5D=Created_At&sort%5B0%5D%5Bdirection%5D=desc`,
                    { headers: { 'Authorization': `Bearer ${AIRTABLE_API_KEY}` } }
                );
                const data = await response.json();
                products = data.records || [];
                renderProducts();
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        function renderProducts() {
            const container = document.querySelector('#view-products .section:last-child');
            const header = container.querySelector('.section-header h2');
            header.textContent = `Produits (${products.length})`;

            if (products.length === 0) {
                return; // Keep empty state
            }

            // Remove empty state and add products grid
            const emptyState = container.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            let grid = container.querySelector('.products-grid');
            if (!grid) {
                grid = document.createElement('div');
                grid.className = 'products-grid';
                container.appendChild(grid);
            }

            grid.innerHTML = products.map(p => {
                const f = p.fields;
                return `
                    <div class="product-card" onclick="selectProduct('${p.id}')">
                        <div class="product-image">
                            ${f.Image_URL ? `<img src="${f.Image_URL}" alt="${f.Name}">` : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>'}
                        </div>
                        <div class="product-info">
                            <div class="product-name">${f.Name || 'Sans nom'}</div>
                            <div class="product-category">${f.Category || '-'} ${f.Price ? '- ' + f.Price.toLocaleString() + ' XPF' : ''}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (product) {
                const action = confirm(`Produit: ${product.fields.Name}\n\nGenerer un post Facebook pour ce produit?`);
                if (action) {
                    const pageName = prompt('Page Facebook cible:', 'Cowan Motor');
                    if (pageName) {
                        generateContent('product', pageName, {
                            product_id: product.id,
                            product_name: product.fields.Name,
                            product_category: product.fields.Category,
                            product_price: product.fields.Price,
                            product_image: product.fields.Image_URL
                        });
                    }
                }
            }
        }

        // Generator functions
        const N8N_GENERATE_URL = 'https://n8n.srv1140766.hstgr.cloud/webhook/cowan-generate-content';

        async function generateContent(type, pageName, extraData = {}) {
            // MODE DEMO: Afficher message
            const modal = document.createElement('div');
            modal.className = 'generation-modal';
            modal.innerHTML = `
                <div class="generation-modal-content" style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                    <h3 style="margin-bottom: 1rem;">Mode Demo</h3>
                    <p style="margin-bottom: 0.5rem;"><strong>Type:</strong> ${type}</p>
                    <p style="margin-bottom: 1.5rem;"><strong>Page:</strong> ${pageName}</p>
                    <p style="margin-bottom: 1.5rem; color: var(--text-muted);">
                        En mode live, l'IA genererait:<br>
                         Texte optimise pour Facebook<br>
                         Image IA haute qualite (2K)
                    </p>
                    <p style="background: var(--surface); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <strong>Formule Pro:</strong> 280 000 XPF/mois<br>
                        <span style="font-size: 0.85rem; color: var(--text-muted);">32 posts + visuels IA inclus</span>
                    </p>
                    <button onclick="this.closest('.generation-modal').remove()" class="btn btn-primary">Compris!</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showGenerationModal(type) {
            const modal = document.createElement('div');
            modal.className = 'generation-modal';
            modal.innerHTML = `
                <div class="generation-modal-content">
                    <h3>Generation en cours...</h3>
                    <p>Type: <strong>${type}</strong></p>
                    <div class="generation-steps">
                        <div class="step active">1. Claude genere le texte...</div>
                        <div class="step">2. FAL.ai genere l'image...</div>
                        <div class="step">3. Sauvegarde Airtable...</div>
                    </div>
                    <div class="generation-timer">0s</div>
                    <button onclick="this.parentElement.parentElement.remove()">Annuler</button>
                </div>
            `;
            document.body.appendChild(modal);

            // Start timer
            let seconds = 0;
            modal.timerInterval = setInterval(() => {
                seconds++;
                modal.querySelector('.generation-timer').textContent = seconds + 's';

                // Update steps based on time
                if (seconds > 5) {
                    modal.querySelectorAll('.step')[1].classList.add('active');
                }
                if (seconds > 15) {
                    modal.querySelectorAll('.step')[2].classList.add('active');
                }
            }, 1000);

            return modal;
        }

        function showGenerationResult(modal, content) {
            clearInterval(modal.timerInterval);
            modal.querySelector('.generation-modal-content').innerHTML = `
                <h3>Contenu genere!</h3>
                <div class="generation-result">
                    <img src="${content.image_url}" alt="Generated" style="max-width: 300px; border-radius: 8px; margin-bottom: 1rem;">
                    <div class="post-text" style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; white-space: pre-wrap;">${content.post_text}</div>
                </div>
                <p style="color: var(--success); margin-top: 1rem;">Sauvegarde dans le calendrier (ID: ${content.airtable_id})</p>
                <button onclick="this.parentElement.parentElement.remove()" style="margin-top: 1rem;">Fermer</button>
            `;
        }

        function showGenerationError(modal, message) {
            clearInterval(modal.timerInterval);
            modal.querySelector('.generation-modal-content').innerHTML = `
                <h3 style="color: var(--danger);">Erreur</h3>
                <p>${message}</p>
                <button onclick="this.parentElement.parentElement.remove()">Fermer</button>
            `;
        }

        function generateQuiz() {
            const pageName = prompt('Page Facebook cible:', 'Cowan Motor');
            if (pageName) {
                generateContent('quiz', pageName);
            }
        }

        function generateProductPost() {
            if (products.length === 0) {
                alert('Aucun produit dans le catalogue. Ajoutez des produits d\'abord.');
                showView('products');
                return;
            }

            const productNames = products.map((p, i) => `${i + 1}. ${p.fields.Name}`).join('\n');
            const choice = prompt('Choisissez un produit (numero):\n' + productNames, '1');

            if (choice) {
                const index = parseInt(choice) - 1;
                if (index >= 0 && index < products.length) {
                    const product = products[index];
                    const pageName = prompt('Page Facebook cible:', 'Cowan Motor');
                    if (pageName) {
                        generateContent('product', pageName, {
                            product_id: product.id,
                            product_name: product.fields.Name,
                            product_category: product.fields.Category,
                            product_price: product.fields.Price
                        });
                    }
                }
            }
        }

        function generatePromo() {
            const pageName = prompt('Page Facebook cible:', 'Cowan Motor');
            if (pageName) {
                const promoText = prompt('Description de la promo:', 'Promotion speciale du mois');
                if (promoText) {
                    generateContent('promo', pageName, { promo_description: promoText });
                }
            }
        }

        function generateCustom() {
            const pageName = prompt('Page Facebook cible:', 'Cowan Motor');
            if (pageName) {
                const customPrompt = prompt('Decrivez le visuel souhaite:', '');
                if (customPrompt) {
                    generateContent('custom', pageName, { custom_prompt: customPrompt });
                }
            }
        }

        async function refreshStats() {
            // Charger les stats depuis Airtable (idees planifiees)
            try {
                const response = await fetch(
                    `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${IDEAS_TABLE}`,
                    { headers: { 'Authorization': `Bearer ${AIRTABLE_API_KEY}` } }
                );
                const data = await response.json();
                const ideas = data.records || [];

                // Calculer les stats
                const plannedPosts = ideas.filter(i => i.fields.Status === 'Planifie').length;
                const thisMonthPosts = ideas.filter(i => {
                    const date = i.fields.Scheduled_Date;
                    if (!date) return false;
                    const postMonth = new Date(date).getMonth();
                    const currentMonth = new Date().getMonth();
                    return postMonth === currentMonth;
                }).length;

                // Mettre a jour l'UI
                document.getElementById('stat-scheduled').textContent = plannedPosts;
                document.getElementById('stat-posts').textContent = thisMonthPosts;
                document.getElementById('stat-followers').textContent = '12,332'; // Demo value
                document.getElementById('stat-engagement').textContent = '4.2%'; // Demo value

                // Charger le preview de la semaine
                loadWeekPreview(ideas);

            } catch (error) {
                console.error('Error refreshing stats:', error);
            }
        }

        function loadWeekPreview(ideas) {
            const container = document.getElementById('week-preview-container');
            if (!container) return;

            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay() + 1); // Lundi

            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6); // Dimanche

            // Filtrer les posts de cette semaine
            const weekPosts = ideas.filter(i => {
                const date = i.fields.Scheduled_Date;
                if (!date) return false;
                const postDate = new Date(date);
                return postDate >= startOfWeek && postDate <= endOfWeek;
            });

            // Generer le HTML pour chaque jour de la semaine
            const daysOfWeek = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
            let html = `
                <div class="calendar-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <span style="font-weight: 600;">${MONTHS_FR[today.getMonth()]} ${today.getFullYear()}</span>
                    <span style="font-size: 0.875rem; color: var(--text-muted);">${weekPosts.length} posts cette semaine</span>
                </div>
                <div class="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem;">
            `;

            // Headers
            daysOfWeek.forEach(day => {
                html += `<div class="calendar-day-header" style="text-align: center; font-size: 0.75rem; color: var(--text-muted); padding: 0.5rem;">${day}</div>`;
            });

            // Days
            for (let i = 0; i < 7; i++) {
                const currentDay = new Date(startOfWeek);
                currentDay.setDate(startOfWeek.getDate() + i);
                const dateStr = currentDay.toISOString().split('T')[0];
                const isToday = dateStr === today.toISOString().split('T')[0];
                const dayPosts = weekPosts.filter(p => p.fields.Scheduled_Date === dateStr);

                html += `<div class="calendar-day" style="background: var(--bg-subtle); border-radius: 8px; padding: 0.5rem; min-height: 80px;">`;
                html += `<div class="calendar-date${isToday ? ' today' : ''}" style="font-weight: ${isToday ? '700' : '500'}; color: ${isToday ? 'var(--accent)' : 'var(--text)'}; margin-bottom: 0.5rem;">${currentDay.getDate()}</div>`;

                dayPosts.forEach(post => {
                    const pageName = post.fields.Page_Name || 'Cowan Motor';
                    const pageClass = pageName.toLowerCase().replace(/\s+/g, '-').replace("'", '');
                    const color = PAGE_COLORS[pageName] || '#3b82f6';
                    html += `<div class="calendar-event" onclick="showIdeaDetail('${post.id}')" style="background: ${color}20; color: ${color}; border-left: 3px solid ${color}; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; margin-bottom: 0.25rem; cursor: pointer; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${post.fields.Title || 'Sans titre'}</div>`;
                });

                html += `</div>`;
            }

            html += `</div>`;
            container.innerHTML = html;
        }

        // ========================================
        // CALENDAR FUNCTIONS
        // ========================================

        const CONTENT_CALENDAR_TABLE = 'COWAN_Content_Calendar';
        let calendarContent = [];
        // Fix: Utilise une date locale explicite pour eviter les problemes de timezone
        let currentCalendarDate = new Date();
        currentCalendarDate.setDate(1); // Force au 1er du mois pour eviter les decalages
        let isCalendarRendering = false;

        const PAGE_COLORS = {
            'Cowan Motor': '#0ea5e9',
            'Tahiti Echappement': '#6366f1',
            'Punaauia Pneus': '#10b981',
            'Station Pacific Hitiaa': '#8b5cf6'
        };

        const MONTHS_FR = ['Janvier', 'Fevrier', 'Mars', 'Avril', 'Mai', 'Juin',
                          'Juillet', 'Aout', 'Septembre', 'Octobre', 'Novembre', 'Decembre'];

        async function loadCalendarContent() {
            try {
                // Charger TOUTES les idees depuis COWAN_Editorial_Ideas (pas de filtre Status)
                const response = await fetch(
                    `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${IDEAS_TABLE}?sort%5B0%5D%5Bfield%5D=Scheduled_Date&sort%5B0%5D%5Bdirection%5D=asc`,
                    { headers: { 'Authorization': `Bearer ${AIRTABLE_API_KEY}` } }
                );
                const data = await response.json();
                calendarContent = data.records || [];
                console.log('Loaded', calendarContent.length, 'ideas for calendar');
                renderCalendar();
            } catch (error) {
                console.error('Error loading calendar:', error);
            }
        }

        function changeMonth(delta) {
            if (isCalendarRendering) return; // Evite les doubles clics
            // Fix: setDate(1) avant setMonth pour eviter le saut de mois (ex: 31 jan -> 3 mars)
            currentCalendarDate.setDate(1);
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            renderCalendar();
        }

        function goToToday() {
            currentCalendarDate = new Date();
            currentCalendarDate.setDate(1); // Fix: Force au 1er du mois
            renderCalendar();
        }

        function getActivePages() {
            const checkboxes = document.querySelectorAll('.page-filter input:checked');
            return Array.from(checkboxes).map(cb => cb.dataset.page);
        }

        function filterCalendar() {
            renderCalendar();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const titleEl = document.getElementById('calendar-month-title');

            if (!grid || !titleEl) return;
            if (isCalendarRendering) return; // Evite les rendus multiples
            isCalendarRendering = true;
            setTimeout(() => { isCalendarRendering = false; }, 100); // Debounce

            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();

            titleEl.textContent = `${MONTHS_FR[month]} ${year}`;

            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const numDays = lastDay.getDate();

            // Monday = 0, Sunday = 6 (ISO week)
            let startDay = firstDay.getDay() - 1;
            if (startDay < 0) startDay = 6;

            // Get active page filters
            const activePages = getActivePages();

            // Build calendar days
            let html = '';
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];

            // Previous month days
            const prevMonth = new Date(year, month, 0);
            const prevMonthDays = prevMonth.getDate();
            for (let i = startDay - 1; i >= 0; i--) {
                const day = prevMonthDays - i;
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }

            // Current month days
            for (let day = 1; day <= numDays; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = dateStr === todayStr;

                // Filter posts for this day
                const dayPosts = calendarContent.filter(p => {
                    const postDate = p.fields.Scheduled_Date?.split('T')[0];
                    const pageName = p.fields.Page_Name || 'Cowan Motor';
                    return postDate === dateStr && activePages.includes(pageName);
                });

                html += `<div class="calendar-day${isToday ? ' today' : ''}">`;
                html += `<div class="calendar-day-number">${day}</div>`;

                dayPosts.forEach(post => {
                    const title = post.fields.Title || post.fields.Content_Type || 'Post';
                    const status = (post.fields.Status || 'Brouillon').toLowerCase().replace(' ', '-');
                    const pageName = post.fields.Page_Name || 'Cowan Motor';
                    const color = PAGE_COLORS[pageName] || '#3b82f6';

                    html += `<div class="calendar-post status-${status}"
                                 style="--post-color: ${color}"
                                 onclick="showPostDetail('${post.id}')"
                                 title="${pageName}">${title}</div>`;
                });

                html += '</div>';
            }

            // Next month days to complete the grid
            const totalCells = startDay + numDays;
            const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            for (let i = 1; i <= remainingCells; i++) {
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${i}</div></div>`;
            }

            grid.innerHTML = html;
        }

        function showPostDetail(postId) {
            // Rediriger vers showIdeaDetail avec le meme ID
            // Les donnees sont dans calendarContent ET editorialIdeas (meme source Airtable)
            showIdeaDetail(postId);
        }

        async function schedulePost(postId) {
            const dateStr = prompt('Date de publication (YYYY-MM-DD):', new Date().toISOString().split('T')[0]);
            if (!dateStr) return;

            try {
                const response = await fetch(
                    `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${CONTENT_CALENDAR_TABLE}/${postId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            fields: {
                                Scheduled_Date: dateStr,
                                Status: 'Planifie'
                            }
                        })
                    }
                );

                if (response.ok) {
                    alert('Post planifie pour le ' + dateStr);
                    document.querySelector('.post-modal')?.remove();
                    loadCalendarContent();
                } else {
                    alert('Erreur lors de la planification');
                }
            } catch (error) {
                alert('Erreur: ' + error.message);
            }
        }

        function publishNow(postId) {
            alert('Publication Facebook - Phase 5 (en cours de developpement)\n\nCette fonctionnalite publiera automatiquement le post sur la page Facebook selectionnee.');
        }

        // ========================================
        // IDEAS FUNCTIONS
        // ========================================

        const IDEAS_TABLE = 'COWAN_Editorial_Ideas';
        let editorialIdeas = [];
        let currentIdeasView = 'list';

        // Genere les idees demo avec dates dynamiques
        async function loadIdeas() {
            try {
                const response = await fetch(
                    `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${IDEAS_TABLE}?sort%5B0%5D%5Bfield%5D=Scheduled_Date&sort%5B0%5D%5Bdirection%5D=asc`,
                    { headers: { 'Authorization': `Bearer ${AIRTABLE_API_KEY}` } }
                );
                const data = await response.json();
                editorialIdeas = data.records || [];
                console.log('Loaded', editorialIdeas.length, 'ideas from Airtable');
                updateIdeasCount();
                renderIdeas();
            } catch (error) {
                console.error('Error loading ideas:', error);
                editorialIdeas = [];
                updateIdeasCount();
                renderIdeas();
            }
        }

        function updateIdeasCount() {
            const pending = editorialIdeas.filter(i => i.fields.Status === 'Idee').length;
            document.getElementById('ideas-count').textContent = pending;
        }

        function setIdeasView(view) {
            currentIdeasView = view;
            document.querySelectorAll('.btn-toggle').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.ideasView === view);
            });
            document.getElementById('ideas-list-view').style.display = view === 'list' ? 'block' : 'none';
            document.getElementById('ideas-kanban-view').style.display = view === 'kanban' ? 'block' : 'none';
            document.getElementById('ideas-calendar-view').style.display = view === 'calendar' ? 'block' : 'none';
            renderIdeas();
        }

        function filterIdeas() {
            renderIdeas();
        }

        function getFilteredIdeas() {
            const pageFilter = document.getElementById('ideas-page-filter')?.value || '';
            const statusFilter = document.getElementById('ideas-status-filter')?.value || '';
            const typeFilter = document.getElementById('ideas-type-filter')?.value || '';

            console.log('getFilteredIdeas called, editorialIdeas count:', editorialIdeas.length);

            return editorialIdeas.filter(idea => {
                const f = idea.fields;
                if (pageFilter && f.Page_Name !== pageFilter) return false;
                if (statusFilter && f.Status !== statusFilter) return false;
                if (typeFilter && f.Content_Type !== typeFilter) return false;
                return true;
            });
        }

        function renderIdeas() {
            const filtered = getFilteredIdeas();

            if (currentIdeasView === 'list') {
                renderIdeasList(filtered);
            } else if (currentIdeasView === 'kanban') {
                renderIdeasKanban(filtered);
            } else if (currentIdeasView === 'calendar') {
                renderIdeasCalendar(filtered);
            }
        }

        function renderIdeasList(ideas) {
            const container = document.getElementById('ideas-list');
            if (ideas.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Aucune idee</h3>
                        <p>Generez des idees editoriales pour les 2 prochaines semaines</p>
                        <button class="btn btn-primary" onclick="generateEditorialIdeas()">Generer des idees</button>
                    </div>
                `;
                return;
            }

            container.innerHTML = ideas.map(idea => {
                const f = idea.fields;
                const color = PAGE_COLORS[f.Page_Name] || '#3b82f6';
                const statusClass = (f.Status || 'Idee').toLowerCase().replace(' ', '-');

                return `
                    <div class="idea-card" data-id="${idea.id}">
                        <input type="checkbox" class="idea-checkbox" data-id="${idea.id}">
                        <div class="idea-page-dot" style="background: ${color};" title="${f.Page_Name}"></div>
                        <div class="idea-content">
                            <div class="idea-title">${f.Title || 'Sans titre'}</div>
                            <div class="idea-meta">
                                <span>${f.Content_Type || '-'}</span>
                                <span>${f.Scheduled_Date ? new Date(f.Scheduled_Date).toLocaleDateString('fr-FR') : 'Non planifie'}</span>
                            </div>
                        </div>
                        <span class="idea-status status-${statusClass}">${f.Status || 'Idee'}</span>
                        <div class="idea-actions">
                            <button class="btn btn-ghost" onclick="showIdeaDetail('${idea.id}')" title="Details">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                            </button>
                            ${f.Status === 'Idee' ? `
                                <button class="btn btn-ghost" onclick="regenerateIdea('${idea.id}')" title="Regenerer">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                                </button>
                                <button class="btn btn-primary" onclick="acceptIdea('${idea.id}')" title="Accepter">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="20 6 9 17 4 12"/></svg>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderIdeasKanban(ideas) {
            const statuses = {
                'Idee': document.getElementById('kanban-idee'),
                'Acceptee': document.getElementById('kanban-acceptee'),
                'En Generation': document.getElementById('kanban-generation'),
                'Generee': document.getElementById('kanban-generee')
            };

            // Clear all columns
            Object.values(statuses).forEach(col => col.innerHTML = '');

            // Count per status
            const counts = { 'Idee': 0, 'Acceptee': 0, 'En Generation': 0, 'Generee': 0 };

            ideas.forEach(idea => {
                const f = idea.fields;
                const status = f.Status || 'Idee';
                const container = statuses[status];
                if (!container) return;

                counts[status]++;
                const color = PAGE_COLORS[f.Page_Name] || '#3b82f6';

                container.innerHTML += `
                    <div class="kanban-card" onclick="showIdeaDetail('${idea.id}')" style="border-left: 3px solid ${color};">
                        <div class="kanban-card-title">${f.Title || 'Sans titre'}</div>
                        <div class="kanban-card-meta">${f.Content_Type || '-'} - ${f.Scheduled_Date ? new Date(f.Scheduled_Date).toLocaleDateString('fr-FR') : '-'}</div>
                    </div>
                `;
            });

            // Update counts
            document.querySelectorAll('.kanban-column').forEach(col => {
                const status = col.dataset.status;
                col.querySelector('.kanban-count').textContent = counts[status] || 0;
            });
        }

        function renderIdeasCalendar(ideas) {
            const container = document.getElementById('ideas-calendar-view');
            const today = new Date();
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const startDayOfWeek = startOfMonth.getDay();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();

            const days = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];

            let html = `
                <div class="ideas-calendar-grid" style="background: var(--bg-subtle); border: 1px solid var(--border); border-radius: 12px; overflow: hidden;">
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); background: var(--bg-muted);">
                        ${days.map(d => `<div style="padding: 0.75rem; text-align: center; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); border-right: 1px solid var(--border);">${d}</div>`).join('')}
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr);">
            `;

            // Empty cells before month starts
            for (let i = 0; i < startDayOfWeek; i++) {
                html += `<div style="min-height: 100px; padding: 0.5rem; border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); opacity: 0.3;"></div>`;
            }

            // Days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(today.getFullYear(), today.getMonth(), day);
                const dateStr = date.toISOString().split('T')[0];
                const isToday = day === today.getDate();
                const dayIdeas = ideas.filter(i => i.fields.Scheduled_Date === dateStr);

                html += `
                    <div class="calendar-day-cell" data-date="${dateStr}" style="min-height: 100px; padding: 0.5rem; border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); ${isToday ? 'background: rgba(249, 115, 22, 0.05);' : ''}"
                         ondragover="event.preventDefault(); this.style.background='rgba(139, 92, 246, 0.1)'"
                         ondragleave="this.style.background='${isToday ? 'rgba(249, 115, 22, 0.05)' : ''}'"
                         ondrop="handleCalendarDrop(event, '${dateStr}')">
                        <div style="font-size: 0.75rem; font-weight: 500; color: ${isToday ? 'var(--accent)' : 'var(--text-muted)'}; margin-bottom: 0.5rem;">${day}</div>
                        ${dayIdeas.map(idea => {
                            const f = idea.fields;
                            const color = PAGE_COLORS[f.Page_Name] || '#3b82f6';
                            return `
                                <div class="calendar-idea-chip" draggable="true" data-id="${idea.id}"
                                     style="font-size: 0.6875rem; padding: 0.25rem 0.5rem; border-radius: 4px; margin-bottom: 0.25rem; cursor: grab; background: ${color}20; color: ${color}; border-left: 2px solid ${color};"
                                     ondragstart="startIdeaDrag(event, '${idea.id}')"
                                     onclick="showIdeaDetail('${idea.id}')">
                                    ${f.Content_Type || f.Title?.substring(0, 15) || 'Idee'}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            // Fill remaining cells
            const totalCells = startDayOfWeek + daysInMonth;
            const remainingCells = 7 - (totalCells % 7);
            if (remainingCells < 7) {
                for (let i = 0; i < remainingCells; i++) {
                    html += `<div style="min-height: 100px; padding: 0.5rem; border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); opacity: 0.3;"></div>`;
                }
            }

            html += '</div></div>';
            container.innerHTML = html;
        }

        // Drag & drop for ideas calendar
        let draggedIdeaId = null;

        function startIdeaDrag(event, ideaId) {
            draggedIdeaId = ideaId;
            event.target.style.opacity = '0.5';
        }

        function handleCalendarDrop(event, newDate) {
            event.preventDefault();
            if (!draggedIdeaId) return;

            // Find and update the idea
            const idea = editorialIdeas.find(i => i.id === draggedIdeaId);
            if (idea) {
                idea.fields.Scheduled_Date = newDate;
                renderIdeas();
                showNotification('Date mise a jour: ' + new Date(newDate).toLocaleDateString('fr-FR'));
            }
            draggedIdeaId = null;
        }

        async function generateEditorialIdeas() {
            // MODE DEMO: Afficher message
            const modal = document.createElement('div');
            modal.className = 'generation-modal';
            modal.innerHTML = `
                <div class="generation-modal-content" style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                    <h3 style="margin-bottom: 1rem;">Mode Demo</h3>
                    <p style="margin-bottom: 1.5rem; color: var(--text-muted);">
                        En mode live, l'IA genererait:<br>
                         Analyse de vos produits<br>
                         Idees pour 2 semaines<br>
                         Planning optimal par page
                    </p>
                    <p style="margin-bottom: 1rem;">Les idees demo sont deja chargees sur le dashboard.</p>
                    <p style="background: var(--surface); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <strong>Formule Pro:</strong> 280 000 XPF/mois<br>
                        <span style="font-size: 0.85rem; color: var(--text-muted);">Generation auto chaque dimanche</span>
                    </p>
                    <button onclick="this.closest('.generation-modal').remove()" class="btn btn-primary">Compris!</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function acceptIdea(ideaId) {
            const idea = editorialIdeas.find(i => i.id === ideaId);
            if (!idea) return;

            showIdeaDetail(ideaId, true);
        }

        async function regenerateIdea(ideaId) {
            const prompt = prompt('Instructions pour ameliorer cette idee:', '');
            if (!prompt) return;

            alert('Regeneration en cours... Cette fonctionnalite sera connectee au workflow n8n.');
        }

        // Historique des versions par idee (stocke en memoire pour la session)
        const ideaVersionHistory = {};

        function showIdeaDetail(ideaId, acceptMode = false) {
            // Chercher dans editorialIdeas OU calendarContent (meme source Airtable)
            let idea = editorialIdeas.find(i => i.id === ideaId);
            if (!idea) {
                idea = calendarContent.find(i => i.id === ideaId);
            }
            if (!idea) {
                console.error('Idea not found:', ideaId);
                return;
            }

            const f = idea.fields;
            const color = PAGE_COLORS[f.Page_Name] || '#3b82f6';

            // Initialiser l'historique pour cette idee si pas existe
            if (!ideaVersionHistory[ideaId]) {
                ideaVersionHistory[ideaId] = [];
            }

            const modal = document.createElement('div');
            modal.className = 'idea-modal active';
            modal.id = 'idea-detail-modal';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

            modal.innerHTML = `
                <div class="idea-modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                    <!-- Header -->
                    <div class="idea-modal-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border);">
                        <div>
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                <div style="width: 12px; height: 12px; border-radius: 50%; background: ${color};"></div>
                                <span style="font-size: 0.875rem; color: var(--text-muted);">${f.Page_Name}</span>
                                <span class="idea-status status-${(f.Status || 'idee').toLowerCase().replace(' ', '-')}">${f.Status || 'Idee'}</span>
                            </div>
                            <h3 style="font-size: 1.25rem; font-weight: 600;">${f.Title || 'Sans titre'}</h3>
                        </div>
                        <button class="idea-modal-close" onclick="this.closest('.idea-modal').remove()" style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.5rem;">&times;</button>
                    </div>

                    <!-- Prompt IA Intelligent -->
                    <div style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="color: var(--purple);"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                            <span style="font-weight: 600; color: var(--purple);">Prompt IA</span>
                            <span style="font-size: 0.75rem; color: var(--text-muted);">Modifie ce post avec une instruction</span>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" id="modal-ai-prompt" placeholder="Ex: Change le theme pour parler de securite routiere..." style="flex: 1; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 0.75rem; color: var(--text); font-size: 0.875rem;">
                            <button class="btn btn-primary" onclick="applyAIPrompt('${ideaId}')" style="white-space: nowrap;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                                Appliquer
                            </button>
                        </div>
                    </div>

                    <!-- Champs editables -->
                    <div style="display: grid; gap: 1rem; margin-bottom: 1.5rem;">
                        <div>
                            <label style="display: block; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.5rem; text-transform: uppercase;">Titre</label>
                            <input type="text" id="modal-title" value="${f.Title || ''}" style="width: 100%; background: var(--bg-subtle); border: 1px solid var(--border); border-radius: 8px; padding: 0.75rem; color: var(--text); font-size: 0.875rem;">
                        </div>

                        <div>
                            <label style="display: block; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.5rem; text-transform: uppercase;">Description du post</label>
                            <textarea id="modal-description" rows="3" style="width: 100%; background: var(--bg-subtle); border: 1px solid var(--border); border-radius: 8px; padding: 0.75rem; color: var(--text); font-size: 0.875rem; resize: vertical;">${f.Idea_Description || ''}</textarea>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="display: block; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.5rem; text-transform: uppercase;">Type de contenu</label>
                                <select id="modal-content-type" style="width: 100%; background: var(--bg-subtle); border: 1px solid var(--border); border-radius: 8px; padding: 0.75rem; color: var(--text); font-size: 0.875rem;">
                                    <option value="Maquette Pub" ${f.Content_Type === 'Maquette Pub' ? 'selected' : ''}>Maquette Pub</option>
                                    <option value="Visuel Mannequin" ${f.Content_Type === 'Visuel Mannequin' ? 'selected' : ''}>Visuel Mannequin</option>
                                    <option value="Quiz" ${f.Content_Type === 'Quiz' ? 'selected' : ''}>Quiz</option>
                                    <option value="Story" ${f.Content_Type === 'Story' ? 'selected' : ''}>Story</option>
                                    <option value="Video" ${f.Content_Type === 'Video' ? 'selected' : ''}>Video</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.5rem; text-transform: uppercase;">Date de publication</label>
                                <input type="date" id="modal-date" value="${f.Scheduled_Date || ''}" style="width: 100%; background: var(--bg-subtle); border: 1px solid var(--border); border-radius: 8px; padding: 0.75rem; color: var(--text); font-size: 0.875rem;">
                            </div>
                        </div>
                    </div>

                    <!-- Selecteurs Avatar & Produit -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="background: var(--bg-subtle); border: 1px solid var(--border); border-radius: 12px; padding: 1rem;">
                            <label style="display: block; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.75rem; text-transform: uppercase;">Avatar</label>
                            <select id="modal-avatar-mode" style="width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 0.5rem; color: var(--text); font-size: 0.875rem; margin-bottom: 0.5rem;">
                                <option value="Auto" ${(f.Avatar_Mode || 'Auto') === 'Auto' ? 'selected' : ''}>Automatique (IA choisit)</option>
                                <option value="Manual" ${f.Avatar_Mode === 'Manual' ? 'selected' : ''}>Manuel</option>
                            </select>
                            <div id="avatar-select-container" style="display: ${f.Avatar_Mode === 'Manual' ? 'block' : 'none'};">
                                <select id="modal-avatar-id" style="width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 0.5rem; color: var(--text); font-size: 0.875rem;">
                                    <option value="">Choisir un avatar...</option>
                                </select>
                            </div>
                        </div>

                        <div style="background: var(--bg-subtle); border: 1px solid var(--border); border-radius: 12px; padding: 1rem;">
                            <label style="display: block; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.75rem; text-transform: uppercase;">Produit</label>
                            <select id="modal-product-mode" style="width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 0.5rem; color: var(--text); font-size: 0.875rem; margin-bottom: 0.5rem;">
                                <option value="Auto" ${(f.Product_Mode || 'Auto') === 'Auto' ? 'selected' : ''}>Automatique (priorite featured)</option>
                                <option value="Manual" ${f.Product_Mode === 'Manual' ? 'selected' : ''}>Manuel</option>
                                <option value="None" ${f.Product_Mode === 'None' ? 'selected' : ''}>Aucun produit</option>
                            </select>
                            <div id="product-select-container" style="display: ${f.Product_Mode === 'Manual' ? 'block' : 'none'};">
                                <select id="modal-product-id" style="width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 0.5rem; color: var(--text); font-size: 0.875rem;">
                                    <option value="">Choisir un produit...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Prompt Visuel masque -->
                    <input type="hidden" id="modal-image-prompt" value="${f.Image_Prompt || f.Generation_Prompt || ''}">

                    <!-- Historique des versions -->
                    <div id="version-history-section" style="margin-bottom: 1.5rem; display: ${ideaVersionHistory[ideaId]?.length > 0 ? 'block' : 'none'};">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16" style="color: var(--text-muted);"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                            <span style="font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase;">Historique des versions</span>
                        </div>
                        <div id="version-history-list" style="max-height: 150px; overflow-y: auto; background: var(--bg-subtle); border: 1px solid var(--border); border-radius: 8px;">
                            ${(ideaVersionHistory[ideaId] || []).map((v, idx) => `
                                <div style="padding: 0.75rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-size: 0.875rem; font-weight: 500;">${v.title}</div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted);">${v.timestamp}</div>
                                    </div>
                                    <button class="btn btn-ghost" onclick="restoreVersion('${ideaId}', ${idx})" style="font-size: 0.75rem;">Restaurer</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Actions -->
                    <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid var(--border);">
                        <button class="btn btn-ghost" onclick="this.closest('.idea-modal').remove()">Annuler</button>
                        <div style="display: flex; gap: 0.75rem;">
                            <button class="btn btn-secondary" onclick="saveIdeaChanges('${ideaId}')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                                Sauvegarder
                            </button>
                            <button class="btn btn-primary" onclick="generateFromIdea('${ideaId}')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                                Generer le visuel
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Toggle avatar/product select visibility
            document.getElementById('modal-avatar-mode').onchange = function() {
                document.getElementById('avatar-select-container').style.display = this.value === 'Manual' ? 'block' : 'none';
            };
            document.getElementById('modal-product-mode').onchange = function() {
                document.getElementById('product-select-container').style.display = this.value === 'Manual' ? 'block' : 'none';
            };

            // Load avatars and products for dropdowns
            loadAvatarsForSelect();
            loadProductsForSelect(f.Page_Name);
        }

        // Appliquer un prompt IA pour modifier le post
        async function applyAIPrompt(ideaId) {
            const prompt = document.getElementById('modal-ai-prompt').value.trim();
            if (!prompt) return;

            const idea = editorialIdeas.find(i => i.id === ideaId);
            if (!idea) return;

            // Sauvegarder la version actuelle dans l'historique
            const currentData = {
                title: document.getElementById('modal-title').value,
                description: document.getElementById('modal-description').value,
                contentType: document.getElementById('modal-content-type').value,
                timestamp: new Date().toLocaleString('fr-FR')
            };

            if (!ideaVersionHistory[ideaId]) ideaVersionHistory[ideaId] = [];
            ideaVersionHistory[ideaId].unshift(currentData);
            if (ideaVersionHistory[ideaId].length > 10) ideaVersionHistory[ideaId].pop(); // Max 10 versions

            // Afficher le loading
            const applyBtn = document.querySelector('#idea-detail-modal .btn-primary');
            const originalBtnContent = applyBtn.innerHTML;
            applyBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> Generation...';
            applyBtn.disabled = true;

            // MODE DEMO: Simuler la generation IA
            await new Promise(r => setTimeout(r, 1500));

            // Simuler une modification basee sur le prompt
            const titleEl = document.getElementById('modal-title');
            const descEl = document.getElementById('modal-description');

            // Simulation simple basee sur des mots-cles
            if (prompt.toLowerCase().includes('securite')) {
                titleEl.value = titleEl.value.replace(/Promo|Nouveautes|Performance/gi, 'Securite');
                descEl.value = 'Maquette axee sur la securite routiere et la fiabilite du vehicule pour les familles polynesiennes.';
            } else if (prompt.toLowerCase().includes('promo') || prompt.toLowerCase().includes('reduction')) {
                titleEl.value = 'Offre Speciale - ' + titleEl.value;
                descEl.value = 'Promotion exceptionnelle avec reduction de 15% cette semaine seulement!';
            } else {
                descEl.value = prompt + ' - ' + descEl.value;
            }

            // Mettre a jour l'affichage de l'historique
            const historySection = document.getElementById('version-history-section');
            historySection.style.display = 'block';
            const historyList = document.getElementById('version-history-list');
            historyList.innerHTML = ideaVersionHistory[ideaId].map((v, idx) => `
                <div style="padding: 0.75rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-size: 0.875rem; font-weight: 500;">${v.title}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">${v.timestamp}</div>
                    </div>
                    <button class="btn btn-ghost" onclick="restoreVersion('${ideaId}', ${idx})" style="font-size: 0.75rem;">Restaurer</button>
                </div>
            `).join('');

            // Restaurer le bouton
            applyBtn.innerHTML = originalBtnContent;
            applyBtn.disabled = false;
            document.getElementById('modal-ai-prompt').value = '';

            // Notification
            showNotification('Modifications appliquees! Version precedente sauvegardee.', 'success');
        }

        // Restaurer une version precedente
        function restoreVersion(ideaId, versionIndex) {
            const version = ideaVersionHistory[ideaId]?.[versionIndex];
            if (!version) return;

            document.getElementById('modal-title').value = version.title;
            document.getElementById('modal-description').value = version.description;
            document.getElementById('modal-content-type').value = version.contentType;

            showNotification('Version restauree!', 'success');
        }

        // Sauvegarder les modifications dans Airtable
        async function saveIdeaChanges(ideaId) {
            let idea = editorialIdeas.find(i => i.id === ideaId);
            if (!idea) {
                idea = calendarContent.find(i => i.id === ideaId);
            }
            if (!idea) return;

            const updatedFields = {
                Title: document.getElementById('modal-title').value,
                Idea_Description: document.getElementById('modal-description').value,
                Content_Type: document.getElementById('modal-content-type').value,
                Scheduled_Date: document.getElementById('modal-date').value,
                Avatar_Mode: document.getElementById('modal-avatar-mode').value,
                Product_Mode: document.getElementById('modal-product-mode').value,
                Image_Prompt: document.getElementById('modal-image-prompt').value
            };

            // Ajouter avatar/produit si en mode manuel
            if (updatedFields.Avatar_Mode === 'Manual') {
                updatedFields.Avatar_ID = document.getElementById('modal-avatar-id').value;
            }
            if (updatedFields.Product_Mode === 'Manual') {
                updatedFields.Product_ID = document.getElementById('modal-product-id').value;
            }

            // MODE DEMO: Afficher message
            showNotification('Mode Demo: Les modifications seraient sauvegardees dans Airtable en mode live.', 'info');

            // Mettre a jour localement pour l'affichage
            idea.fields = { ...idea.fields, ...updatedFields };

            // Mettre a jour aussi dans calendarContent si present
            const calendarIdea = calendarContent.find(i => i.id === ideaId);
            if (calendarIdea) {
                calendarIdea.fields = { ...calendarIdea.fields, ...updatedFields };
            }

            // Fermer le modal et rafraichir
            document.getElementById('idea-detail-modal')?.remove();
            renderIdeas();
            renderCalendar();
        }

        // Generer le visuel (lance le workflow n8n)
        let generateAbortController = null;

        async function generateFromIdea(ideaId) {
            // Capturer les valeurs AVANT de fermer le modal
            const title = document.getElementById('modal-title')?.value || '';
            const description = document.getElementById('modal-description')?.value || '';
            const contentType = document.getElementById('modal-content-type')?.value || '';
            const scheduledDate = document.getElementById('modal-date')?.value || '';
            const avatarMode = document.getElementById('modal-avatar-mode')?.value || 'Auto';
            const avatarId = document.getElementById('modal-avatar-id')?.value || '';
            const productMode = document.getElementById('modal-product-mode')?.value || 'Auto';
            const productId = document.getElementById('modal-product-id')?.value || '';
            const imagePrompt = document.getElementById('modal-image-prompt')?.value || '';

            // Trouver la page
            const idea = editorialIdeas.find(i => i.id === ideaId) || calendarContent.find(i => i.id === ideaId);
            const pageName = idea?.fields?.Page_Name || 'Cowan Motor';

            document.getElementById('idea-detail-modal')?.remove();

            // Afficher le modal de progression
            showGenerationProgressModal(ideaId, title, pageName);

            try {
                // Etape 1: Sauvegarder les modifications dans Airtable
                updateGenerationStep(1);
                const updateFields = {
                    Title: title,
                    Idea_Description: description,
                    Content_Type: contentType,
                    Scheduled_Date: scheduledDate,
                    Avatar_Mode: avatarMode,
                    Product_Mode: productMode,
                    Generation_Prompt: imagePrompt
                };
                if (avatarMode === 'Manual' && avatarId) updateFields.Avatar_ID = avatarId;
                if (productMode === 'Manual' && productId) updateFields.Product_ID = productId;

                await fetch(
                    `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${IDEAS_TABLE}/${ideaId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ fields: updateFields })
                    }
                );

                // Etape 2: Appeler le workflow n8n
                updateGenerationStep(2);
                generateAbortController = new AbortController();
                const timeoutId = setTimeout(() => generateAbortController.abort(), 120000); // 2 min timeout

                const response = await fetch(
                    'https://n8n.srv1140766.hstgr.cloud/webhook/cowan-accept-idea',
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ idea_id: ideaId }),
                        signal: generateAbortController.signal
                    }
                );

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`Erreur workflow: ${response.status}`);
                }

                const result = await response.json();

                // Etape 3: Succes
                updateGenerationStep(3);

                if (result.success) {
                    showGenerationSuccess(result.image_url, result.content_id);
                } else {
                    throw new Error(result.error || 'Erreur inconnue');
                }

            } catch (error) {
                if (error.name === 'AbortError') {
                    showGenerationError('Generation annulee ou timeout depasse (2 min)');
                } else {
                    showGenerationError(error.message);
                }
            }
        }

        function showGenerationProgressModal(ideaId, title, pageName) {
            const modal = document.createElement('div');
            modal.className = 'generation-modal active';
            modal.id = 'generation-progress-modal';
            modal.innerHTML = `
                <div class="generation-modal-content" style="text-align: center; max-width: 500px;">
                    <div id="gen-spinner" style="margin-bottom: 1.5rem;">
                        <svg width="60" height="60" viewBox="0 0 50 50" style="animation: spin 1s linear infinite;">
                            <circle cx="25" cy="25" r="20" fill="none" stroke="var(--purple)" stroke-width="4" stroke-dasharray="80 40" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <h3 style="margin-bottom: 0.5rem;">Generation en cours...</h3>
                    <p style="color: var(--text-muted); margin-bottom: 1.5rem; font-size: 0.875rem;">
                        <strong>${title}</strong> pour <strong>${pageName}</strong>
                    </p>

                    <div id="gen-steps" style="text-align: left; background: var(--bg); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <div class="gen-step" data-step="1" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0; border-bottom: 1px solid var(--border);">
                            <div class="step-icon" style="width: 24px; height: 24px; border-radius: 50%; background: var(--bg-subtle); display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">1</div>
                            <span>Sauvegarde des modifications</span>
                        </div>
                        <div class="gen-step" data-step="2" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0; border-bottom: 1px solid var(--border);">
                            <div class="step-icon" style="width: 24px; height: 24px; border-radius: 50%; background: var(--bg-subtle); display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">2</div>
                            <span>Generation IA (Claude + FAL.ai)</span>
                        </div>
                        <div class="gen-step" data-step="3" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0;">
                            <div class="step-icon" style="width: 24px; height: 24px; border-radius: 50%; background: var(--bg-subtle); display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">3</div>
                            <span>Creation du contenu</span>
                        </div>
                    </div>

                    <div id="gen-timer" style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 1rem;">
                        Temps ecoule: <span id="gen-seconds">0</span>s
                    </div>

                    <button onclick="cancelGeneration()" class="btn btn-ghost" style="color: var(--red);">Annuler</button>
                </div>
            `;
            document.body.appendChild(modal);

            // Timer
            let seconds = 0;
            window.genTimerInterval = setInterval(() => {
                seconds++;
                const el = document.getElementById('gen-seconds');
                if (el) el.textContent = seconds;
            }, 1000);
        }

        function updateGenerationStep(stepNum) {
            const steps = document.querySelectorAll('.gen-step');
            steps.forEach(step => {
                const num = parseInt(step.dataset.step);
                const icon = step.querySelector('.step-icon');
                if (num < stepNum) {
                    icon.style.background = 'var(--green)';
                    icon.style.color = 'white';
                    icon.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>';
                } else if (num === stepNum) {
                    icon.style.background = 'var(--purple)';
                    icon.style.color = 'white';
                    icon.innerHTML = '<svg width="12" height="12" viewBox="0 0 50 50" style="animation: spin 1s linear infinite;"><circle cx="25" cy="25" r="15" fill="none" stroke="currentColor" stroke-width="5" stroke-dasharray="50 30"/></svg>';
                }
            });
        }

        function showGenerationSuccess(imageUrl, contentId) {
            clearInterval(window.genTimerInterval);
            const modal = document.getElementById('generation-progress-modal');
            if (!modal) return;

            modal.querySelector('.generation-modal-content').innerHTML = `
                <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                <h3 style="margin-bottom: 1rem; color: var(--green);">Contenu genere avec succes!</h3>
                ${imageUrl ? `
                    <div style="margin-bottom: 1.5rem;">
                        <img src="${imageUrl}" alt="Visuel genere" style="max-width: 100%; max-height: 250px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                    </div>
                ` : ''}
                <p style="color: var(--text-muted); margin-bottom: 1.5rem; font-size: 0.875rem;">
                    Le contenu a ete cree et ajoute au calendrier.<br>
                    Vous pouvez le retrouver dans la vue Calendrier.
                </p>
                <div style="display: flex; gap: 0.75rem; justify-content: center;">
                    <button onclick="this.closest('.generation-modal').remove(); loadCalendarContent(); loadIdeas();" class="btn btn-primary">Fermer</button>
                    <button onclick="this.closest('.generation-modal').remove(); showView('calendar');" class="btn btn-secondary">Voir le calendrier</button>
                </div>
            `;
        }

        function showGenerationError(message) {
            clearInterval(window.genTimerInterval);
            const modal = document.getElementById('generation-progress-modal');
            if (!modal) return;

            modal.querySelector('.generation-modal-content').innerHTML = `
                <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                <h3 style="margin-bottom: 1rem; color: var(--red);">Erreur de generation</h3>
                <p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.875rem;">
                    ${message}
                </p>
                <div style="background: var(--bg); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; font-size: 0.75rem; text-align: left;">
                    <strong>A verifier:</strong><br>
                    - Workflow n8n actif<br>
                    - API Claude / FAL.ai fonctionnelles<br>
                    - Connexion internet stable
                </div>
                <button onclick="this.closest('.generation-modal').remove()" class="btn btn-primary">Fermer</button>
            `;
        }

        function cancelGeneration() {
            if (generateAbortController) {
                generateAbortController.abort();
            }
            clearInterval(window.genTimerInterval);
            document.getElementById('generation-progress-modal')?.remove();
        }

        // Charger les produits pour le dropdown
        async function loadProductsForSelect(pageName) {
            try {
                const response = await fetch(
                    `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/COWAN_Products`,
                    { headers: { 'Authorization': `Bearer ${AIRTABLE_API_KEY}` } }
                );
                const data = await response.json();
                const select = document.getElementById('modal-product-id');
                if (select) {
                    // Filtrer par page si possible, sinon afficher tous
                    const filteredProducts = (data.records || []).filter(p =>
                        !pageName || p.fields.Page_Name === pageName || p.fields.Page_Name === 'Cowan Motor'
                    );
                    select.innerHTML = '<option value="">Choisir un produit...</option>' +
                        filteredProducts.map(p => `<option value="${p.id}">${p.fields.Name || p.fields.Product_Name}</option>`).join('');
                }
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        async function loadAvatarsForSelect() {
            try {
                const response = await fetch(
                    `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/COWAN_Avatars`,
                    { headers: { 'Authorization': `Bearer ${AIRTABLE_API_KEY}` } }
                );
                const data = await response.json();
                const select = document.getElementById('modal-avatar-id');
                if (select) {
                    select.innerHTML = '<option value="">Choisir un avatar...</option>' +
                        (data.records || []).map(a => `<option value="${a.id}">${a.fields.Avatar_Name || a.fields.Avatar_Key}</option>`).join('');
                }
            } catch (error) {
                console.error('Error loading avatars:', error);
            }
        }

        async function confirmAcceptIdea(ideaId) {
            // Close idea modal
            document.querySelector('.idea-modal')?.remove();

            // MODE DEMO: Afficher message
            const modal = document.createElement('div');
            modal.className = 'generation-modal';
            modal.innerHTML = `
                <div class="generation-modal-content" style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                    <h3 style="margin-bottom: 1rem;">Mode Demo</h3>
                    <p style="margin-bottom: 1.5rem; color: var(--text-muted);">
                        En mode live, l'IA genererait ici:<br>
                         Le texte du post (Claude)<br>
                         L'image IA (FAL.ai 2K)<br>
                         Publication automatique Facebook
                    </p>
                    <p style="background: var(--surface); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <strong>Pour activer:</strong> Souscrivez a la formule Pro<br>
                        <span style="color: var(--accent);">280 000 XPF/mois</span>
                    </p>
                    <button onclick="this.closest('.generation-modal').remove()" class="btn btn-primary">Compris!</button>
                </div>
            `;
            document.body.appendChild(modal);

            // Update local status to "Planifie" for demo
            const idea = editorialIdeas.find(i => i.id === ideaId);
            if (idea) {
                idea.fields.Status = 'Planifie';
                renderIdeas();
            }
        }

        async function bulkAcceptIdeas() {
            const checkboxes = document.querySelectorAll('.idea-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('Selectionnez des idees a accepter (case a cocher)');
                return;
            }

            if (!confirm(`Accepter et generer ${checkboxes.length} idees? Cela peut prendre plusieurs minutes.`)) {
                return;
            }

            for (const checkbox of checkboxes) {
                const ideaId = checkbox.dataset.id;
                await confirmAcceptIdea(ideaId);
                await new Promise(r => setTimeout(r, 2000)); // Wait between generations
            }
        }

        // ========================================
        // AVATARS FUNCTIONS
        // ========================================

        const AVATARS_TABLE = 'COWAN_Avatars';
        let avatars = [];

        async function loadAvatars() {
            try {
                const response = await fetch(
                    `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AVATARS_TABLE}`,
                    { headers: { 'Authorization': `Bearer ${AIRTABLE_API_KEY}` } }
                );
                const data = await response.json();
                avatars = data.records || [];
                renderAvatars();
            } catch (error) {
                console.error('Error loading avatars:', error);
            }
        }

        function filterAvatars() {
            renderAvatars();
        }

        function renderAvatars() {
            const styleFilter = document.getElementById('avatar-style-filter')?.value || '';
            const genderFilter = document.getElementById('avatar-gender-filter')?.value || '';

            const filtered = avatars.filter(a => {
                const f = a.fields;
                if (styleFilter && f.Style !== styleFilter) return false;
                if (genderFilter && f.Gender !== genderFilter) return false;
                return true;
            });

            const container = document.getElementById('avatars-grid');

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="48" height="48"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        <h3>Aucun avatar</h3>
                        <p>Creez des avatars pour les utiliser dans vos publications</p>
                        <button class="btn btn-primary" onclick="showCreateAvatarModal()">Creer un avatar</button>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(avatar => {
                const f = avatar.fields;
                const images = [f.Image_URL_1, f.Image_URL_2, f.Image_URL_3, f.Image_URL_4].filter(Boolean);

                return `
                    <div class="avatar-card" onclick="showAvatarDetail('${avatar.id}')">
                        <div class="avatar-images">
                            ${images.slice(0, 4).map(url => `<img src="${url}" alt="">`).join('')}
                            ${images.length < 4 ? `<div style="background: var(--bg-muted);"></div>`.repeat(4 - images.length) : ''}
                        </div>
                        <div class="avatar-info">
                            <div class="avatar-name">${f.Avatar_Name || f.Avatar_Key || 'Avatar'}</div>
                            <div class="avatar-desc">${(f.Description || '').substring(0, 60)}...</div>
                            <div class="avatar-tags">
                                <span class="avatar-tag">${f.Style || '-'}</span>
                                <span class="avatar-tag">${f.Gender || '-'}</span>
                                <span class="avatar-tag">Utilise ${f.Use_Count || 0}x</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showCreateAvatarModal() {
            const modal = document.createElement('div');
            modal.className = 'avatar-modal';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

            modal.innerHTML = `
                <div class="avatar-modal-content">
                    <div class="avatar-modal-header">
                        <h3>Creer un avatar</h3>
                        <button class="idea-modal-close" onclick="this.closest('.avatar-modal').remove()">&times;</button>
                    </div>

                    <div class="avatar-form-group">
                        <label>Description du personnage</label>
                        <textarea id="avatar-description" placeholder="Ex: Homme polynesien d'environ 35 ans, mecanicien automobile, souriant et professionnel..."></textarea>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="avatar-form-group">
                            <label>Style</label>
                            <select id="avatar-style">
                                <option value="Professionnel">Professionnel</option>
                                <option value="Decontracte">Decontracte</option>
                                <option value="Sportif">Sportif</option>
                                <option value="Elegant">Elegant</option>
                            </select>
                        </div>
                        <div class="avatar-form-group">
                            <label>Genre</label>
                            <select id="avatar-gender">
                                <option value="Homme">Homme</option>
                                <option value="Femme">Femme</option>
                                <option value="Neutre">Neutre</option>
                            </select>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                        <button class="btn btn-secondary" onclick="this.closest('.avatar-modal').remove()">Annuler</button>
                        <button class="btn btn-primary" onclick="createAvatar()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                            Generer (4 images)
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        async function createAvatar() {
            const description = document.getElementById('avatar-description').value;
            const style = document.getElementById('avatar-style').value;
            const gender = document.getElementById('avatar-gender').value;

            if (!description) {
                alert('Veuillez decrire le personnage');
                return;
            }

            document.querySelector('.avatar-modal')?.remove();

            const modal = document.createElement('div');
            modal.className = 'generation-modal';
            modal.innerHTML = `
                <div class="generation-modal-content">
                    <h3>Creation de l'avatar...</h3>
                    <p>Claude cree le personnage, puis FAL.ai genere 4 images.</p>
                    <div class="generation-timer">0s</div>
                </div>
            `;
            document.body.appendChild(modal);

            let seconds = 0;
            const timer = setInterval(() => {
                seconds++;
                modal.querySelector('.generation-timer').textContent = seconds + 's';
            }, 1000);

            try {
                const response = await fetch('https://n8n.srv1140766.hstgr.cloud/webhook/cowan-create-avatar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ description, style, gender })
                });

                const result = await response.json();
                clearInterval(timer);

                if (result.success) {
                    modal.querySelector('.generation-modal-content').innerHTML = `
                        <h3 style="color: var(--green);">Avatar cree!</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; margin: 1rem 0;">
                            ${(result.images || []).slice(0, 4).map(img => `<img src="${img.url}" style="width: 100%; border-radius: 4px;">`).join('')}
                        </div>
                        <button onclick="loadAvatars(); this.parentElement.parentElement.remove();" class="btn btn-primary">OK</button>
                    `;
                } else {
                    throw new Error(result.error || 'Unknown error');
                }
            } catch (error) {
                clearInterval(timer);
                modal.querySelector('.generation-modal-content').innerHTML = `
                    <h3 style="color: var(--red);">Erreur</h3>
                    <p>${error.message}</p>
                    <button onclick="this.parentElement.parentElement.remove()" class="btn btn-secondary">Fermer</button>
                `;
            }
        }

        function showAvatarDetail(avatarId) {
            const avatar = avatars.find(a => a.id === avatarId);
            if (!avatar) return;

            const f = avatar.fields;
            const images = [f.Image_URL_1, f.Image_URL_2, f.Image_URL_3, f.Image_URL_4].filter(Boolean);

            const modal = document.createElement('div');
            modal.className = 'avatar-modal';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

            modal.innerHTML = `
                <div class="avatar-modal-content" style="max-width: 700px;">
                    <div class="avatar-modal-header">
                        <h3>${f.Avatar_Name || f.Avatar_Key}</h3>
                        <button class="idea-modal-close" onclick="this.closest('.avatar-modal').remove()">&times;</button>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 1.5rem;">
                        ${images.map(url => `<img src="${url}" style="width: 100%; border-radius: 8px; cursor: pointer;" onclick="window.open('${url}', '_blank')">`).join('')}
                    </div>

                    <div class="idea-detail-section">
                        <div class="idea-detail-label">Description</div>
                        <div class="idea-detail-value">${f.Description || '-'}</div>
                    </div>

                    <div style="display: flex; gap: 1rem;">
                        <div class="avatar-tag">${f.Style || '-'}</div>
                        <div class="avatar-tag">${f.Gender || '-'}</div>
                        <div class="avatar-tag">Utilise ${f.Use_Count || 0} fois</div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // ========================================
        // SETTINGS FUNCTIONS
        // ========================================

        const SETTINGS_TABLE = 'COWAN_Settings';
        const FEATURED_TABLE = 'COWAN_Featured_Products';
        let pageSettings = [];
        let featuredProducts = [];

        async function loadSettings() {
            try {
                const [settingsRes, featuredRes] = await Promise.all([
                    fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${SETTINGS_TABLE}`, { headers: { 'Authorization': `Bearer ${AIRTABLE_API_KEY}` } }),
                    fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${FEATURED_TABLE}`, { headers: { 'Authorization': `Bearer ${AIRTABLE_API_KEY}` } })
                ]);

                pageSettings = (await settingsRes.json()).records || [];
                featuredProducts = (await featuredRes.json()).records || [];
                renderSettings();
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        function renderSettings() {
            const container = document.getElementById('settings-pages');

            container.innerHTML = pageSettings.map(setting => {
                const f = setting.fields;
                const color = PAGE_COLORS[f.Page_Name] || '#3b82f6';

                return `
                    <div class="settings-card" data-id="${setting.id}">
                        <div class="settings-card-header">
                            <div class="settings-page-dot" style="background: ${color};"></div>
                            <div class="settings-card-title">${f.Page_Name}</div>
                        </div>

                        <div class="settings-row">
                            <span class="settings-label">Posts par semaine</span>
                            <div class="settings-value">
                                <input type="number" class="number-input" value="${f.Posts_Per_Week || 2}" min="0" max="14" data-field="Posts_Per_Week">
                            </div>
                        </div>

                        <div class="settings-row">
                            <span class="settings-label">Mode automatique</span>
                            <div class="settings-value">
                                <label class="toggle-switch">
                                    <input type="checkbox" ${f.Auto_Mode ? 'checked' : ''} data-field="Auto_Mode">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="settings-row">
                            <span class="settings-label">Avatar par defaut</span>
                            <div class="settings-value">
                                <select class="filter-select" data-field="Default_Avatar_Mode">
                                    <option value="Auto" ${f.Default_Avatar_Mode === 'Auto' ? 'selected' : ''}>Auto</option>
                                    <option value="Manual" ${f.Default_Avatar_Mode === 'Manual' ? 'selected' : ''}>Manuel</option>
                                </select>
                            </div>
                        </div>

                        <div class="settings-row">
                            <span class="settings-label">Produit par defaut</span>
                            <div class="settings-value">
                                <select class="filter-select" data-field="Default_Product_Mode">
                                    <option value="Auto" ${f.Default_Product_Mode === 'Auto' ? 'selected' : ''}>Auto</option>
                                    <option value="Manual" ${f.Default_Product_Mode === 'Manual' ? 'selected' : ''}>Manuel</option>
                                    <option value="None" ${f.Default_Product_Mode === 'None' ? 'selected' : ''}>Aucun</option>
                                </select>
                            </div>
                        </div>

                        <div class="settings-row">
                            <span class="settings-label">Heure de publication</span>
                            <div class="settings-value">
                                <input type="text" class="number-input" style="width: 80px;" value="${f.Publish_Time || '10:00'}" data-field="Publish_Time">
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Render featured products
            const featuredContainer = document.getElementById('featured-products-list');
            if (featuredProducts.length === 0) {
                featuredContainer.innerHTML = '<p style="color: var(--text-muted);">Aucun produit mis en avant. Les produits vedettes seront priorises dans les suggestions d\'idees.</p>';
            } else {
                featuredContainer.innerHTML = featuredProducts.map(fp => {
                    const f = fp.fields;
                    const product = products.find(p => p.id === f.Product_ID);
                    return `
                        <div class="featured-product-item">
                            ${product?.fields.Image_URL ? `<img src="${product.fields.Image_URL}" alt="">` : '<div style="width:50px;height:50px;background:var(--bg-muted);border-radius:6px;"></div>'}
                            <div class="featured-product-info">
                                <div class="featured-product-name">${f.Product_Name || product?.fields.Name || 'Produit'}</div>
                                <div class="featured-product-period">${f.Page_Name || 'Toutes'} - ${f.Period_Type || 'Semaine'} (${f.Start_Date || '-'} - ${f.End_Date || '-'})</div>
                            </div>
                            <button class="btn btn-ghost" onclick="removeFeaturedProduct('${fp.id}')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                            </button>
                        </div>
                    `;
                }).join('');
            }
        }

        async function saveAllSettings() {
            const cards = document.querySelectorAll('.settings-card');

            for (const card of cards) {
                const recordId = card.dataset.id;
                const fields = {};

                card.querySelectorAll('[data-field]').forEach(input => {
                    const field = input.dataset.field;
                    if (input.type === 'checkbox') {
                        fields[field] = input.checked;
                    } else if (input.type === 'number') {
                        fields[field] = parseInt(input.value) || 0;
                    } else {
                        fields[field] = input.value;
                    }
                });

                try {
                    await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${SETTINGS_TABLE}/${recordId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ fields })
                    });
                } catch (error) {
                    console.error('Error saving settings:', error);
                }
            }

            alert('Parametres sauvegardes!');
        }

        async function addFeaturedProduct() {
            if (products.length === 0) {
                alert('Ajoutez des produits au catalogue d\'abord');
                return;
            }

            const productNames = products.map((p, i) => `${i + 1}. ${p.fields.Name}`).join('\n');
            const choice = prompt('Choisissez un produit (numero):\n' + productNames);
            if (!choice) return;

            const index = parseInt(choice) - 1;
            if (index < 0 || index >= products.length) return;

            const product = products[index];
            const pageName = prompt('Page cible (ou "Toutes"):', 'Toutes');
            const periodType = prompt('Periode (Semaine ou Mois):', 'Semaine');

            try {
                await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${FEATURED_TABLE}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fields: {
                            Product_ID: product.id,
                            Product_Name: product.fields.Name,
                            Page_Name: pageName,
                            Period_Type: periodType,
                            Start_Date: new Date().toISOString().split('T')[0],
                            Active: true,
                            Priority: 1
                        }
                    })
                });

                loadSettings();
            } catch (error) {
                alert('Erreur: ' + error.message);
            }
        }

        async function removeFeaturedProduct(recordId) {
            if (!confirm('Retirer ce produit des produits vedettes?')) return;

            try {
                await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${FEATURED_TABLE}/${recordId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${AIRTABLE_API_KEY}` }
                });
                loadSettings();
            } catch (error) {
                alert('Erreur: ' + error.message);
            }
        }

        // ========================================
        // DEMO - DEMYSTIFIER (WIZARD MULTI-ETAPES)
        // ========================================

        // Demo State
        let demoCurrentStep = 1;
        let demoEditorialLines = [
            {
                page: 'Cowan Motor',
                color: 'var(--page-cowan)',
                themes: ['Nouveautes 2024', 'Fiabilite japonaise', 'Financement avantageux'],
                products: ['Toyota RAV4 2024', 'Nissan Navara'],
                contentPlan: { maquettes: 3, visuels: 2, quiz: 1 }
            },
            {
                page: 'Tahiti Echappement',
                color: 'var(--page-echappement)',
                themes: ['Performance moteur', 'Son sport', 'Expertise locale'],
                products: ['Echappement Sport Inox'],
                contentPlan: { maquettes: 2, visuels: 1, quiz: 1 }
            },
            {
                page: 'Punaauia Pneus',
                color: 'var(--page-pneus)',
                themes: ['Securite routiere', 'Economie carburant', 'Durabilite'],
                products: ['Pneu Michelin Primacy 4', 'Pneu Bridgestone Turanza'],
                contentPlan: { maquettes: 3, visuels: 1, quiz: 1 }
            },
            {
                page: 'Station Pacific Hitiaa',
                color: 'var(--page-pacific)',
                themes: ['Service rapide', 'Prix competitifs', 'Ouverture cote Est'],
                products: ['Carburant Sans Plomb 95'],
                contentPlan: { maquettes: 2, visuels: 1, quiz: 0 }
            }
        ];

        // Hardcoded demo ideas - dates calculees dynamiquement
        function getHardcodedDemoIdeas() {
            const today = new Date();
            const formatDate = (daysFromNow) => {
                const d = new Date(today);
                d.setDate(d.getDate() + daysFromNow);
                return d.toISOString().split('T')[0];
            };
            return [
                // Cowan Motor
                { id: 'idea_1', page: 'Cowan Motor', type: 'Maquette Pub', description: 'Maquette promotionnelle Nouveautes 2024 - Toyota RAV4', date: formatDate(1), avatar: 'auto', product: 'prod_3' },
                { id: 'idea_2', page: 'Cowan Motor', type: 'Maquette Pub', description: 'Maquette promotionnelle Fiabilite japonaise - Nissan Navara', date: formatDate(3), avatar: 'auto', product: 'prod_4' },
                { id: 'idea_3', page: 'Cowan Motor', type: 'Visuel Mannequin', description: 'Visuel lifestyle avec Hina devant le RAV4', date: formatDate(5), avatar: 'avatar_2', product: 'prod_3' },
                { id: 'idea_4', page: 'Cowan Motor', type: 'Quiz', description: 'Quiz "Le saviez-vous?" - Entretien vehicule', date: formatDate(7), avatar: 'none', product: 'none' },
                { id: 'idea_5', page: 'Cowan Motor', type: 'Maquette Pub', description: 'Maquette Financement avantageux - Offre speciale', date: formatDate(9), avatar: 'auto', product: 'prod_3' },
                { id: 'idea_6', page: 'Cowan Motor', type: 'Visuel Mannequin', description: 'Visuel lifestyle avec Maui et Navara', date: formatDate(11), avatar: 'avatar_3', product: 'prod_4' },
                // Tahiti Echappement
                { id: 'idea_7', page: 'Tahiti Echappement', type: 'Maquette Pub', description: 'Maquette Performance moteur - Echappement Sport', date: formatDate(2), avatar: 'auto', product: 'prod_5' },
                { id: 'idea_8', page: 'Tahiti Echappement', type: 'Visuel Mannequin', description: 'Visuel avec Teva en atelier', date: formatDate(4), avatar: 'avatar_1', product: 'prod_5' },
                { id: 'idea_9', page: 'Tahiti Echappement', type: 'Quiz', description: 'Quiz "Le saviez-vous?" - Echappement et performance', date: formatDate(6), avatar: 'none', product: 'none' },
                { id: 'idea_10', page: 'Tahiti Echappement', type: 'Maquette Pub', description: 'Maquette Son sport - Expertise locale', date: formatDate(10), avatar: 'auto', product: 'prod_5' },
                // Punaauia Pneus
                { id: 'idea_11', page: 'Punaauia Pneus', type: 'Maquette Pub', description: 'Maquette Securite routiere - Michelin Primacy 4', date: formatDate(1), avatar: 'auto', product: 'prod_1' },
                { id: 'idea_12', page: 'Punaauia Pneus', type: 'Maquette Pub', description: 'Maquette Economie carburant - Bridgestone Turanza', date: formatDate(3), avatar: 'auto', product: 'prod_2' },
                { id: 'idea_13', page: 'Punaauia Pneus', type: 'Visuel Mannequin', description: 'Visuel avec Hina presentant les pneus', date: formatDate(5), avatar: 'avatar_2', product: 'prod_1' },
                { id: 'idea_14', page: 'Punaauia Pneus', type: 'Quiz', description: 'Quiz "Le saviez-vous?" - Duree de vie des pneus', date: formatDate(8), avatar: 'none', product: 'none' },
                { id: 'idea_15', page: 'Punaauia Pneus', type: 'Maquette Pub', description: 'Maquette Durabilite - Offre 4 pneus', date: formatDate(12), avatar: 'auto', product: 'prod_2' },
                // Station Pacific Hitiaa
                { id: 'idea_16', page: 'Station Pacific Hitiaa', type: 'Maquette Pub', description: 'Maquette Service rapide - Ouverture cote Est', date: formatDate(2), avatar: 'auto', product: 'prod_6' },
                { id: 'idea_17', page: 'Station Pacific Hitiaa', type: 'Visuel Mannequin', description: 'Visuel avec Maui a la station', date: formatDate(6), avatar: 'avatar_3', product: 'prod_6' },
                { id: 'idea_18', page: 'Station Pacific Hitiaa', type: 'Maquette Pub', description: 'Maquette Prix competitifs - Carburant SP95', date: formatDate(10), avatar: 'auto', product: 'prod_6' }
            ];
        }

        let demoIdeas = [];
        let demoSelectedIdeas = new Set();
        let currentEditingIdea = null;
        let draggedIdea = null;

        // Demo Products (fake catalog)
        const demoProducts = [
            { id: 'prod_1', name: 'Pneu Michelin Primacy 4', category: 'Pneus', price: '28 500 XPF', page: 'Punaauia Pneus', image: 'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=200' },
            { id: 'prod_2', name: 'Pneu Bridgestone Turanza', category: 'Pneus', price: '32 000 XPF', page: 'Punaauia Pneus', image: 'https://images.unsplash.com/photo-1578844251758-2f71da64c96f?w=200' },
            { id: 'prod_3', name: 'Toyota RAV4 2024', category: 'Vehicules', price: '4 500 000 XPF', page: 'Cowan Motor', image: 'https://images.unsplash.com/photo-1568844293986-8c8a5d8eb6b4?w=200' },
            { id: 'prod_4', name: 'Nissan Navara', category: 'Vehicules', price: '3 800 000 XPF', page: 'Cowan Motor', image: 'https://images.unsplash.com/photo-1533473359331-0135ef1b58bf?w=200' },
            { id: 'prod_5', name: 'Echappement Sport Inox', category: 'Services', price: '85 000 XPF', page: 'Tahiti Echappement', image: 'https://images.unsplash.com/photo-1486262715619-67b85e0b08d3?w=200' },
            { id: 'prod_6', name: 'Carburant Sans Plomb 95', category: 'Carburant', price: '175 XPF/L', page: 'Station Pacific Hitiaa', image: 'https://images.unsplash.com/photo-1611348524140-53c9a25263d6?w=200' }
        ];

        // Demo Avatars
        const demoAvatars = [
            { id: 'avatar_1', name: 'Teva - Mecanicien', style: 'Professionnel', gender: 'Homme', description: 'Homme polynesien 35 ans, mecanicien souriant', image: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=200' },
            { id: 'avatar_2', name: 'Hina - Conseillere', style: 'Elegant', gender: 'Femme', description: 'Femme polynesienne 30 ans, elegante professionnelle', image: 'https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=200' },
            { id: 'avatar_3', name: 'Maui - Sportif', style: 'Decontracte', gender: 'Homme', description: 'Homme polynesien 28 ans, sportif decontracte', image: 'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=200' }
        ];

        // Settings
        let demoImageQuality = '2K';

        function launchDemo() {
            // Ouvrir le wizard DEMYSTIFIER
            resetDemoState();
            document.getElementById('demo-modal').classList.add('active');
            goToStep(1);
            // Generer automatiquement la ligne editoriale
            generateEditorialLines();
        }

        function closeDemo() {
            document.getElementById('demo-modal').classList.remove('active');
            resetDemoState();
        }

        function resetDemoState() {
            demoCurrentStep = 1;
            // Ne pas vider demoEditorialLines - les donnees sont statiques
            demoIdeas = [];
            demoSelectedIdeas.clear();
            currentEditingIdea = null;
        }

        function goToStep(step) {
            demoCurrentStep = step;

            // Update step indicators
            document.querySelectorAll('.wizard-step').forEach((el, idx) => {
                el.classList.remove('active', 'completed');
                if (idx + 1 < step) el.classList.add('completed');
                if (idx + 1 === step) el.classList.add('active');
            });

            document.querySelectorAll('.wizard-step-line').forEach((el, idx) => {
                el.classList.toggle('completed', idx + 1 < step);
            });

            // Show correct step content
            document.querySelectorAll('.demo-step-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`demo-step-${step}`).classList.add('active');
        }

        // ========================================
        // STEP 1: LIGNE EDITORIALE
        // ========================================

        async function generateEditorialLines() {
            console.log('generateEditorialLines START');
            const container = document.getElementById('editorial-lines-container');
            const actionsEl = document.getElementById('step1-actions');

            try {
                container.innerHTML = `
                    <div class="editorial-loading">
                        <div class="spinner"></div>
                        <p>L'IA analyse vos produits et genere une ligne editoriale pour chaque page...</p>
                    </div>
                `;
                if (actionsEl) actionsEl.style.display = 'none';

                // Simulate AI generation (in production, call n8n webhook)
                await new Promise(r => setTimeout(r, 2000));

                demoEditorialLines = [
                {
                    page: 'Cowan Motor',
                    color: 'var(--page-cowan)',
                    themes: ['Nouveautes 2024', 'Fiabilite japonaise', 'Financement avantageux'],
                    products: ['Toyota RAV4 2024', 'Nissan Navara'],
                    contentPlan: { maquettes: 3, visuels: 2, quiz: 1 }
                },
                {
                    page: 'Tahiti Echappement',
                    color: 'var(--page-echappement)',
                    themes: ['Performance moteur', 'Son sport', 'Expertise locale'],
                    products: ['Echappement Sport Inox'],
                    contentPlan: { maquettes: 2, visuels: 1, quiz: 1 }
                },
                {
                    page: 'Punaauia Pneus',
                    color: 'var(--page-pneus)',
                    themes: ['Securite routiere', 'Economie carburant', 'Durabilite'],
                    products: ['Pneu Michelin Primacy 4', 'Pneu Bridgestone Turanza'],
                    contentPlan: { maquettes: 3, visuels: 1, quiz: 1 }
                },
                {
                    page: 'Station Pacific Hitiaa',
                    color: 'var(--page-pacific)',
                    themes: ['Service rapide', 'Prix competitifs', 'Ouverture cote Est'],
                    products: ['Carburant Sans Plomb 95'],
                    contentPlan: { maquettes: 2, visuels: 1, quiz: 0 }
                }
            ];

                console.log('generateEditorialLines: demoEditorialLines filled with', demoEditorialLines.length, 'items');
                renderEditorialLines();
                if (actionsEl) actionsEl.style.display = 'flex';
            } catch (error) {
                console.error('generateEditorialLines ERROR:', error);
            }
        }

        function renderEditorialLines() {
            const container = document.getElementById('editorial-lines-container');
            container.innerHTML = `
                <div class="editorial-cards">
                    ${demoEditorialLines.map(line => `
                        <div class="editorial-card">
                            <div class="editorial-card-header">
                                <div class="editorial-page-dot" style="background: ${line.color};"></div>
                                <div class="editorial-page-name">${line.page}</div>
                            </div>
                            <div class="editorial-themes">
                                <div class="editorial-themes-title">Themes de la quinzaine</div>
                                <div class="editorial-themes-list">
                                    ${line.themes.map(t => `<span class="editorial-theme-tag">${t}</span>`).join('')}
                                </div>
                            </div>
                            <div class="editorial-products">
                                <div class="editorial-products-title">Produits a mettre en avant</div>
                                ${line.products.map(p => `<div class="editorial-product-item">- ${p}</div>`).join('')}
                            </div>
                            <div class="editorial-content-plan">
                                <div class="editorial-content-row">
                                    <span class="editorial-content-type">Maquettes pub</span>
                                    <span class="editorial-content-count">${line.contentPlan.maquettes}/semaine</span>
                                </div>
                                <div class="editorial-content-row">
                                    <span class="editorial-content-type">Visuels mannequin</span>
                                    <span class="editorial-content-count">${line.contentPlan.visuels}/semaine</span>
                                </div>
                                ${line.contentPlan.quiz ? `
                                <div class="editorial-content-row">
                                    <span class="editorial-content-type">Quiz interactif</span>
                                    <span class="editorial-content-count">${line.contentPlan.quiz}/semaine</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function regenerateEditorialLines() {
            generateEditorialLines();
        }

        function acceptEditorialLines() {
            console.log('acceptEditorialLines: demoEditorialLines has', demoEditorialLines.length, 'items');
            if (demoEditorialLines.length === 0) {
                console.error('acceptEditorialLines: No editorial lines! Cannot proceed.');
                alert('La ligne editoriale n\'est pas encore generee. Veuillez patienter.');
                return;
            }
            // Passer directement au step 2 (les idees sont deja dans Airtable)
            goToStep(2);
        }

        function accessDashboard() {
            // Fermer le modal et recharger les donnees
            closeDemo();
            loadIdeas();
            showView('calendar');
        }

        // ========================================
        // STEP 2: GENERATION IDEES
        // ========================================

        async function generateDemoIdeas() {
            const container = document.getElementById('ideas-generation-container');

            // Afficher le spinner
            container.innerHTML = `
                <div class="editorial-loading">
                    <div class="spinner"></div>
                    <p>Generation des idees en cours...</p>
                </div>
            `;

            // Attendre 1.5 secondes pour l'effet visuel
            await new Promise(r => setTimeout(r, 1500));

            // Charger les idees hardcodees
            demoIdeas = getHardcodedDemoIdeas();

            // Afficher le succes
            container.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2" width="48" height="48" style="margin-bottom: 1rem;"><polyline points="20 6 9 17 4 12"/></svg>
                    <h3 style="margin-bottom: 0.5rem;">${demoIdeas.length} idees generees!</h3>
                    <p style="color: var(--text-muted);">Le dashboard va s'ouvrir...</p>
                </div>
            `;

            // Attendre puis fermer et injecter
            await new Promise(r => setTimeout(r, 1000));
            closeDemo();
            injectDemoIdeasIntoDashboard();
        }

        // Inject demo ideas into the main dashboard
        function injectDemoIdeasIntoDashboard() {
            console.log('injectDemoIdeasIntoDashboard called, demoIdeas count:', demoIdeas.length);

            // Convert demo ideas to the format used by editorialIdeas
            editorialIdeas = demoIdeas.map(idea => ({
                id: idea.id,
                fields: {
                    Title: idea.description.substring(0, 50),
                    Idea_Description: idea.description,
                    Page_Name: idea.page,
                    Content_Type: idea.type,
                    Scheduled_Date: idea.date,
                    Status: 'Idee',
                    Avatar_Mode: idea.avatar === 'auto' ? 'Auto' : (idea.avatar === 'none' ? 'None' : 'Manual'),
                    Avatar_ID: idea.avatar !== 'auto' && idea.avatar !== 'none' ? idea.avatar : null,
                    Product_Mode: idea.product === 'auto' ? 'Auto' : (idea.product === 'none' ? 'None' : 'Manual'),
                    Product_IDs: idea.product !== 'auto' && idea.product !== 'none' ? idea.product : null,
                    Generation_Prompt: idea.prompt
                }
            }));

            console.log('editorialIdeas after mapping:', editorialIdeas.length, editorialIdeas[0]);

            // Update ideas count badge
            document.getElementById('ideas-count').textContent = editorialIdeas.length;

            // Render ideas in the Ideas view
            console.log('Calling renderIdeas...');
            renderIdeas();

            // Also update calendar with these ideas
            renderDemoCalendarInMain();

            // Switch to Ideas view to show results
            showView('ideas');

            // Show success notification
            showNotification(`${demoIdeas.length} idees generees et planifiees! Explorez le calendrier et la vue Idees.`);
        }

        function showNotification(message, type = 'info') {
            const colors = {
                success: 'linear-gradient(135deg, #22c55e, #10b981)',
                error: 'linear-gradient(135deg, #ef4444, #dc2626)',
                info: 'linear-gradient(135deg, #8b5cf6, #ec4899)',
                warning: 'linear-gradient(135deg, #f59e0b, #d97706)'
            };
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                bottom: 2rem;
                right: 2rem;
                background: ${colors[type] || colors.info};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 10px;
                font-size: 0.875rem;
                font-weight: 500;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                z-index: 2000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        // Render demo ideas in the main calendar view
        function renderDemoCalendarInMain() {
            // This will be called when user views the calendar
            // The regular calendar render will now check for editorialIdeas
        }

        // ========================================
        // STEP 3: PLANIFICATION / INTERACTION
        // ========================================

        function switchDemoView(viewName) {
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === viewName);
            });
            document.querySelectorAll('.demo-view').forEach(view => view.classList.remove('active'));
            document.getElementById(`demo-${viewName}-view`).classList.add('active');

            if (viewName === 'calendar') renderDemoCalendar();
            else if (viewName === 'kanban') renderDemoKanban();
            else if (viewName === 'list') renderDemoList();
        }

        function renderDemoCalendar() {
            const container = document.getElementById('demo-calendar');
            const today = new Date();
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const startDayOfWeek = startOfMonth.getDay();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();

            const days = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];

            let html = `
                <div class="demo-calendar-header">
                    ${days.map(d => `<div class="demo-calendar-header-cell">${d}</div>`).join('')}
                </div>
                <div class="demo-calendar-body">
            `;

            // Empty cells for days before month starts
            for (let i = 0; i < startDayOfWeek; i++) {
                html += `<div class="demo-calendar-day other-month"></div>`;
            }

            // Days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(today.getFullYear(), today.getMonth(), day);
                const dateStr = date.toISOString().split('T')[0];
                const isToday = day === today.getDate();
                const dayIdeas = demoIdeas.filter(i => i.date === dateStr);

                html += `
                    <div class="demo-calendar-day ${isToday ? 'today' : ''}" data-date="${dateStr}"
                         ondragover="event.preventDefault(); this.classList.add('drop-target')"
                         ondragleave="this.classList.remove('drop-target')"
                         ondrop="handleIdeaDrop(event, '${dateStr}')">
                        <div class="demo-calendar-date">${day}</div>
                        ${dayIdeas.map(idea => `
                            <div class="demo-idea-chip ${demoSelectedIdeas.has(idea.id) ? 'selected' : ''}"
                                 data-page="${idea.page}" data-id="${idea.id}"
                                 draggable="true"
                                 ondragstart="startDragIdea(event, '${idea.id}')"
                                 ondragend="endDragIdea(event)"
                                 onclick="openIdeaModal('${idea.id}')">
                                <input type="checkbox" class="idea-chip-checkbox"
                                       ${demoSelectedIdeas.has(idea.id) ? 'checked' : ''}
                                       onclick="event.stopPropagation(); toggleIdeaSelection('${idea.id}')">
                                ${idea.type.substring(0, 10)}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Fill remaining cells
            const totalCells = startDayOfWeek + daysInMonth;
            const remainingCells = 7 - (totalCells % 7);
            if (remainingCells < 7) {
                for (let i = 0; i < remainingCells; i++) {
                    html += `<div class="demo-calendar-day other-month"></div>`;
                }
            }

            html += '</div>';
            container.innerHTML = html;
            updateSelectedCount();
        }

        function renderDemoKanban() {
            const container = document.getElementById('demo-kanban');
            const pages = ['Cowan Motor', 'Tahiti Echappement', 'Punaauia Pneus', 'Station Pacific Hitiaa'];
            const colors = { 'Cowan Motor': 'var(--page-cowan)', 'Tahiti Echappement': 'var(--page-echappement)', 'Punaauia Pneus': 'var(--page-pneus)', 'Station Pacific Hitiaa': 'var(--page-pacific)' };

            container.innerHTML = pages.map(page => {
                const pageIdeas = getFilteredDemoIdeas().filter(i => i.page === page);
                return `
                    <div class="kanban-column">
                        <div class="kanban-column-header">
                            <div class="kanban-column-dot" style="background: ${colors[page]};"></div>
                            ${page.split(' ')[0]}
                            <span class="kanban-column-count">${pageIdeas.length}</span>
                        </div>
                        <div class="kanban-column-body">
                            ${pageIdeas.map(idea => `
                                <div class="kanban-card" onclick="openIdeaModal('${idea.id}')">
                                    <input type="checkbox" class="kanban-card-checkbox idea-chip-checkbox"
                                           ${demoSelectedIdeas.has(idea.id) ? 'checked' : ''}
                                           onclick="event.stopPropagation(); toggleIdeaSelection('${idea.id}')">
                                    <div class="kanban-card-content">
                                        <div class="kanban-card-type">${idea.type}</div>
                                        <div class="kanban-card-title">${idea.description.substring(0, 50)}...</div>
                                        <div class="kanban-card-date">${formatDate(idea.date)}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            updateSelectedCount();
        }

        function renderDemoList() {
            const container = document.getElementById('demo-list');
            const filtered = getFilteredDemoIdeas();
            const colors = { 'Cowan Motor': 'var(--page-cowan)', 'Tahiti Echappement': 'var(--page-echappement)', 'Punaauia Pneus': 'var(--page-pneus)', 'Station Pacific Hitiaa': 'var(--page-pacific)' };

            container.innerHTML = `
                <div class="list-header">
                    <div></div>
                    <div>Description</div>
                    <div>Page</div>
                    <div>Type</div>
                    <div>Date</div>
                    <div>Action</div>
                </div>
                ${filtered.map(idea => `
                    <div class="list-row" onclick="openIdeaModal('${idea.id}')">
                        <div>
                            <input type="checkbox" class="idea-chip-checkbox"
                                   ${demoSelectedIdeas.has(idea.id) ? 'checked' : ''}
                                   onclick="event.stopPropagation(); toggleIdeaSelection('${idea.id}')">
                        </div>
                        <div>${idea.description.substring(0, 40)}...</div>
                        <div><span class="list-page-badge" style="background: ${colors[idea.page]}; color: white;">${idea.page.split(' ')[0]}</span></div>
                        <div>${idea.type}</div>
                        <div>${formatDate(idea.date)}</div>
                        <div><button class="list-action-btn" onclick="event.stopPropagation(); openIdeaModal('${idea.id}')">Modifier</button></div>
                    </div>
                `).join('')}
            `;
            updateSelectedCount();
        }

        function getFilteredDemoIdeas() {
            const pageFilter = document.getElementById('demo-filter-page')?.value || '';
            const typeFilter = document.getElementById('demo-filter-type')?.value || '';

            return demoIdeas.filter(idea => {
                if (pageFilter && idea.page !== pageFilter) return false;
                if (typeFilter && idea.type !== typeFilter) return false;
                return true;
            });
        }

        function filterDemoIdeas() {
            const currentView = document.querySelector('.view-btn.active')?.dataset.view || 'calendar';
            switchDemoView(currentView);
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
        }

        // Drag & Drop pour changer les dates
        function startDragIdea(event, ideaId) {
            draggedIdea = ideaId;
            event.target.classList.add('dragging');
        }

        function endDragIdea(event) {
            event.target.classList.remove('dragging');
            document.querySelectorAll('.demo-calendar-day').forEach(d => d.classList.remove('drop-target'));
        }

        function handleIdeaDrop(event, newDate) {
            event.preventDefault();
            if (!draggedIdea) return;

            const idea = demoIdeas.find(i => i.id === draggedIdea);
            if (idea) {
                idea.date = newDate;
                renderDemoCalendar();
            }
            draggedIdea = null;
        }

        // Selection
        function toggleIdeaSelection(ideaId) {
            if (demoSelectedIdeas.has(ideaId)) {
                demoSelectedIdeas.delete(ideaId);
            } else {
                demoSelectedIdeas.add(ideaId);
            }
            updateSelectedCount();
            updateAllCheckboxes();
        }

        function toggleSelectAllIdeas() {
            const selectAll = document.getElementById('select-all-ideas').checked;
            const filtered = getFilteredDemoIdeas();

            if (selectAll) {
                filtered.forEach(i => demoSelectedIdeas.add(i.id));
            } else {
                filtered.forEach(i => demoSelectedIdeas.delete(i.id));
            }

            updateSelectedCount();
            const currentView = document.querySelector('.view-btn.active')?.dataset.view || 'calendar';
            switchDemoView(currentView);
        }

        function selectWeekIdeas() {
            const today = new Date();
            const weekFromNow = new Date(today);
            weekFromNow.setDate(weekFromNow.getDate() + 7);

            demoIdeas.forEach(idea => {
                const ideaDate = new Date(idea.date);
                if (ideaDate >= today && ideaDate <= weekFromNow) {
                    demoSelectedIdeas.add(idea.id);
                }
            });

            updateSelectedCount();
            const currentView = document.querySelector('.view-btn.active')?.dataset.view || 'calendar';
            switchDemoView(currentView);
        }

        function updateSelectedCount() {
            document.getElementById('selected-ideas-count').textContent = demoSelectedIdeas.size;
            document.getElementById('generate-selected-btn').disabled = demoSelectedIdeas.size === 0;
        }

        function updateAllCheckboxes() {
            document.querySelectorAll('.idea-chip-checkbox').forEach(cb => {
                const ideaId = cb.closest('[data-id]')?.dataset.id || cb.closest('.kanban-card')?.onclick?.toString().match(/'([^']+)'/)?.[1];
            });
        }

        // ========================================
        // IDEA MODAL
        // ========================================

        function openIdeaModal(ideaId) {
            currentEditingIdea = demoIdeas.find(i => i.id === ideaId);
            if (!currentEditingIdea) return;

            const colors = { 'Cowan Motor': 'var(--page-cowan)', 'Tahiti Echappement': 'var(--page-echappement)', 'Punaauia Pneus': 'var(--page-pneus)', 'Station Pacific Hitiaa': 'var(--page-pacific)' };

            document.getElementById('idea-modal-id').value = ideaId;
            document.getElementById('idea-modal-page').textContent = currentEditingIdea.page;
            document.getElementById('idea-modal-page').style.background = colors[currentEditingIdea.page];
            document.getElementById('idea-modal-page').style.color = 'white';
            document.getElementById('idea-modal-type').value = currentEditingIdea.type;
            document.getElementById('idea-modal-description').value = currentEditingIdea.description;
            document.getElementById('idea-modal-prompt').value = currentEditingIdea.prompt;
            document.getElementById('idea-modal-date').value = currentEditingIdea.date;

            // Populate avatar select
            const avatarSelect = document.getElementById('idea-modal-avatar');
            avatarSelect.innerHTML = `
                <option value="auto">Auto (IA choisit)</option>
                <option value="none">Aucun</option>
                ${demoAvatars.map(a => `<option value="${a.id}">${a.name}</option>`).join('')}
            `;
            avatarSelect.value = currentEditingIdea.avatar;

            // Populate product select
            const productSelect = document.getElementById('idea-modal-product');
            const relevantProducts = demoProducts.filter(p => p.page === currentEditingIdea.page || currentEditingIdea.page === 'Cowan Motor');
            productSelect.innerHTML = `
                <option value="auto">Auto (recommande)</option>
                <option value="none">Aucun</option>
                ${relevantProducts.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
            `;
            productSelect.value = currentEditingIdea.product;

            // Show recommendation
            if (currentEditingIdea.product === 'auto') {
                const recommended = demoProducts.find(p => p.page === currentEditingIdea.page);
                if (recommended) {
                    document.getElementById('product-recommendation').style.display = 'block';
                    document.getElementById('recommended-product').textContent = recommended.name;
                }
            } else {
                document.getElementById('product-recommendation').style.display = 'none';
            }

            document.getElementById('idea-modal').classList.add('active');
        }

        function closeIdeaModal() {
            document.getElementById('idea-modal').classList.remove('active');
            currentEditingIdea = null;
        }

        function saveIdeaChanges() {
            if (!currentEditingIdea) return;

            currentEditingIdea.type = document.getElementById('idea-modal-type').value;
            currentEditingIdea.description = document.getElementById('idea-modal-description').value;
            currentEditingIdea.prompt = document.getElementById('idea-modal-prompt').value;
            currentEditingIdea.date = document.getElementById('idea-modal-date').value;
            currentEditingIdea.avatar = document.getElementById('idea-modal-avatar').value;
            currentEditingIdea.product = document.getElementById('idea-modal-product').value;

            closeIdeaModal();
            const currentView = document.querySelector('.view-btn.active')?.dataset.view || 'calendar';
            switchDemoView(currentView);
        }

        function saveAndGenerateIdea() {
            saveIdeaChanges();
            demoSelectedIdeas.clear();
            demoSelectedIdeas.add(currentEditingIdea.id);
            generateSelectedIdeas();
        }

        async function improvePromptWithAI() {
            const promptTextarea = document.getElementById('idea-modal-prompt');
            const originalPrompt = promptTextarea.value;
            promptTextarea.disabled = true;
            promptTextarea.value = 'Amelioration en cours...';

            await new Promise(r => setTimeout(r, 1500));

            promptTextarea.value = originalPrompt + ', style cinematographique, lumiere douce naturelle, composition professionnelle, qualite premium 4K';
            promptTextarea.disabled = false;
        }

        // ========================================
        // STEP 4: GENERATION VISUELS
        // ========================================

        async function generateSelectedIdeas() {
            goToStep(4);

            const container = document.getElementById('visuals-grid');
            const selectedIdeasList = Array.from(demoSelectedIdeas).map(id => demoIdeas.find(i => i.id === id)).filter(Boolean);

            // Show generating cards
            container.innerHTML = selectedIdeasList.map(idea => `
                <div class="visual-card" data-id="${idea.id}">
                    <div class="visual-card-image">
                        <div class="visual-card-generating">
                            <div class="spinner"></div>
                            <div>Generation...</div>
                        </div>
                    </div>
                    <div class="visual-card-info">
                        <span class="visual-card-page" style="background: ${getPageColor(idea.page)}; color: white;">${idea.page}</span>
                        <div class="visual-card-title">${idea.type}</div>
                    </div>
                </div>
            `).join('');

            // Simulate generation one by one
            for (const idea of selectedIdeasList) {
                await new Promise(r => setTimeout(r, 1000 + Math.random() * 1500));

                const card = container.querySelector(`[data-id="${idea.id}"]`);
                const imageContainer = card.querySelector('.visual-card-image');

                // Use placeholder images based on type
                const placeholderImages = {
                    'Maquette Pub': 'https://images.unsplash.com/photo-1549317661-bd32c8ce0db2?w=400',
                    'Visuel Mannequin': 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400',
                    'Quiz': 'https://images.unsplash.com/photo-1606326608606-aa0b62935f2b?w=400'
                };

                imageContainer.innerHTML = `<img src="${placeholderImages[idea.type] || placeholderImages['Maquette Pub']}" alt="Visuel genere">`;
            }
        }

        function getPageColor(page) {
            const colors = {
                'Cowan Motor': 'var(--page-cowan)',
                'Tahiti Echappement': 'var(--page-echappement)',
                'Punaauia Pneus': 'var(--page-pneus)',
                'Station Pacific Hitiaa': 'var(--page-pacific)'
            };
            return colors[page] || 'var(--accent)';
        }

        // Initialize calendar view when step 3 is shown
        document.addEventListener('DOMContentLoaded', () => {
            // Pre-render calendar for step 3
        });

        // ========================================
        // GLOBAL SETTINGS
        // ========================================

        let globalImageQuality = localStorage.getItem('imageQuality') || '2K';
        let globalPublishMode = localStorage.getItem('publishMode') || 'manual';

        function setImageQuality(quality) {
            globalImageQuality = quality;
            localStorage.setItem('imageQuality', quality);

            // Update UI
            document.querySelectorAll('.image-quality-btn').forEach(btn => {
                const isActive = btn.dataset.quality === quality;
                btn.classList.toggle('active', isActive);
                btn.style.background = isActive ? 'var(--accent)' : '';
                btn.style.color = isActive ? 'white' : '';
            });

            // Update info text
            const infoTexts = {
                '1K': '1K - Rapide, adapte aux stories et miniatures',
                '2K': '2K recommande - bon equilibre qualite/vitesse',
                '4K': '4K - Haute qualite, ideal pour impression'
            };
            document.getElementById('quality-info').textContent = infoTexts[quality];
        }

        function setPublishMode(mode) {
            globalPublishMode = mode;
            localStorage.setItem('publishMode', mode);
        }

        function initGlobalSettings() {
            // Restore saved settings
            setImageQuality(globalImageQuality);
            const publishSelect = document.getElementById('global-publish-mode');
            if (publishSelect) {
                publishSelect.value = globalPublishMode;
            }
        }

        // ========================================
        // INITIALIZE
        // ========================================

        console.log('COWAN MOTOR Dashboard loaded');
        loadProducts();
        loadCalendarContent();
        loadIdeas();
        loadAvatars();
        loadSettings();
        initGlobalSettings();
        refreshStats(); // Charger les stats et le preview de la semaine
    </script>
</body>
</html>
